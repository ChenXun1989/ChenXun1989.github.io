{"meta":{"version":1,"warehouse":"4.0.2"},"models":{"Asset":[{"_id":"node_modules/hexo-theme-next/source/css/main.styl","path":"css/main.styl","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/css/noscript.styl","path":"css/noscript.styl","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/comments-buttons.js","path":"js/comments-buttons.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/comments.js","path":"js/comments.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/config.js","path":"js/config.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/next-boot.js","path":"js/next-boot.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/pjax.js","path":"js/pjax.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/schedule.js","path":"js/schedule.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/bookmark.js","path":"js/bookmark.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/motion.js","path":"js/motion.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/utils.js","path":"js/utils.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/images/avatar.gif","path":"images/avatar.gif","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/images/logo-algolia-nebula-blue-full.svg","path":"images/logo-algolia-nebula-blue-full.svg","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/images/logo.svg","path":"images/logo.svg","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/addtoany.js","path":"js/third-party/addtoany.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/schemes/muse.js","path":"js/schemes/muse.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/fancybox.js","path":"js/third-party/fancybox.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/pace.js","path":"js/third-party/pace.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/quicklink.js","path":"js/third-party/quicklink.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/chat/gitter.js","path":"js/third-party/chat/gitter.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/chat/chatra.js","path":"js/third-party/chat/chatra.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/chat/tidio.js","path":"js/third-party/chat/tidio.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/changyan.js","path":"js/third-party/comments/changyan.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/disqus.js","path":"js/third-party/comments/disqus.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/disqusjs.js","path":"js/third-party/comments/disqusjs.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/gitalk.js","path":"js/third-party/comments/gitalk.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/isso.js","path":"js/third-party/comments/isso.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/livere.js","path":"js/third-party/comments/livere.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/utterances.js","path":"js/third-party/comments/utterances.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/math/mathjax.js","path":"js/third-party/math/mathjax.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/math/katex.js","path":"js/third-party/math/katex.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/search/local-search.js","path":"js/third-party/search/local-search.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/search/algolia-search.js","path":"js/third-party/search/algolia-search.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/baidu-analytics.js","path":"js/third-party/analytics/baidu-analytics.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/google-analytics.js","path":"js/third-party/analytics/google-analytics.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/growingio.js","path":"js/third-party/analytics/growingio.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/matomo.js","path":"js/third-party/analytics/matomo.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/statistics/firestore.js","path":"js/third-party/statistics/firestore.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/statistics/lean-analytics.js","path":"js/third-party/statistics/lean-analytics.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/tags/mermaid.js","path":"js/third-party/tags/mermaid.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/tags/wavedrom.js","path":"js/third-party/tags/wavedrom.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/tags/pdf.js","path":"js/third-party/tags/pdf.js","modified":1,"renderable":1},{"_id":"source/CNAME","path":"CNAME","modified":1,"renderable":0},{"_id":"source/images/background.png","path":"images/background.png","modified":1,"renderable":0}],"Cache":[{"_id":"source/CNAME","hash":"6e8232e2bc4eb6c05388523bd2ee4448dcbce4c7","modified":1701745544810},{"_id":"source/404/index.md","hash":"27b95a440652b862224575c875e49bfafc6b9ab6","modified":1701743854603},{"_id":"source/_data/styles.styl","hash":"de4e1341cf2a0fd39bbfe9ca2eea8f4c4fb88c3c","modified":1701745544810},{"_id":"source/schedule/index.md","hash":"e34f9160edfd7c9000fe9b4d8a090cd9d771329a","modified":1701743854702},{"_id":"source/tags/index.md","hash":"11549342397455010458838f3525bc4c947c66e6","modified":1701743854703},{"_id":"source/_posts/Buffer详解.md","hash":"0abf7fd7b8385bd0a597e9e64640c23028495505","modified":1701744492722},{"_id":"source/_posts/IOC容器设计.md","hash":"c6de51e6825b7a55c2ec5d026fa8c61c41e6551f","modified":1701744492724},{"_id":"source/_posts/JSR-133规范详解.md","hash":"01193b5881ad6765b6f725df0279686aba40428f","modified":1701744492725},{"_id":"source/_posts/RPC框架设计.md","hash":"52b88bcdc33ed1ed4b9322a29acd3ebf87627575","modified":1701744492725},{"_id":"source/_posts/class装载.md","hash":"0f0ff6759ab5720160dc49a5b37db82e32bf9f2c","modified":1701744492726},{"_id":"source/_posts/dubbo源码研究之config-spring模块.md","hash":"0978f6adae63c1d1ece662af4576b71dd66c8bb2","modified":1701744492726},{"_id":"source/_posts/dubbo源码研究之dubbo-registry模块.md","hash":"f18461568a1d693608fc626110c70ce943493bb3","modified":1701744492731},{"_id":"source/_posts/dubbo源码研究之config模块.md","hash":"030e5f28b7e9f18e1d70cfd5dda82be063f0e408","modified":1701744492727},{"_id":"source/_posts/dubbo源码研究之container模块.md","hash":"990d963bb650392b4356746baa95cfa0ef367770","modified":1701744492730},{"_id":"source/_posts/jQuery基于json对象自动给表单元素赋值.md","hash":"ea134da14515a71b73612ec4065779e9c1ad9e74","modified":1701744492733},{"_id":"source/_posts/dubbo源码研究之rpc模块.md","hash":"2e06e23836c8c906f9878e8e8e7cb25a14cfc927","modified":1701744492733},{"_id":"source/_posts/dubbo源码研究之extension模块.md","hash":"e1cc1d11527d616b095c0ec7537548a570f7f245","modified":1701744492732},{"_id":"source/_posts/java线程状态.md","hash":"4c0613b7c3e3a187e4005a2131799f852133a2c6","modified":1701744492735},{"_id":"source/_posts/java多线程基础.md","hash":"003871d5dc62416c3f94f6a1bb8207b91181a54f","modified":1701744492734},{"_id":"source/_posts/java内存结构和内存模型.md","hash":"43e1d6c97627bbd1a1cd2b7ec179545b58adeb7a","modified":1701744492734},{"_id":"source/_posts/jvm里面的access-flag.md","hash":"8dc3b38cbfd5b977d582c19cfa5a8a767cf97867","modified":1701744492735},{"_id":"source/_posts/jenkins进阶.md","hash":"3fba31128ed915dcccf3a3e09be0bf80924b7cea","modified":1704035823945},{"_id":"source/_posts/ringBuffer深入浅出.md","hash":"4bcca63585003a8c256ca0a1fb7498a0f5365d31","modified":1701744492736},{"_id":"source/_posts/mybatis源码分析（一）.md","hash":"0f54ee384fca83e6e41b10f8cc1bde3fd68e8958","modified":1701744492736},{"_id":"source/_posts/solr中文分词.md","hash":"61fc440d0bf523f9a5a96f9a2cef90fc70aa7986","modified":1701744492737},{"_id":"source/_posts/solrcloud搭建.md","hash":"dfa2425ef0c68d4136457612aec7fc7ec8e881b6","modified":1701744492737},{"_id":"source/_posts/并发容器和同步容器.md","hash":"3ef8ba44fa39241fd69d4296c4da019ff23ecf7f","modified":1701744492740},{"_id":"source/_posts/volatile原理解析.md","hash":"a161d4d2453ca3e3306df0511aba1260974f7e27","modified":1701744492739},{"_id":"source/_posts/synchronized原理解析.md","hash":"9469003826bad086dbd56fab7bf3e5f1f21f331a","modified":1701744492738},{"_id":"source/_posts/基于jquery把表单转成成json对象.md","hash":"0a22e6604edda9194efe1520d5759d8113bf4910","modified":1701744492739},{"_id":"source/_posts/聊聊营销-营销主体.md","hash":"648ec6c93def438831b06b45e76442ebefb7eed2","modified":1701746168758},{"_id":"source/_posts/详解CopyOnWriter.md","hash":"0d14139c90d6a6ce75f6d692870898b230160653","modified":1701744492742},{"_id":"source/_posts/领域驱动与微服务落地实战-工程结构.md","hash":"bc3f2a322f76d25028898d834a7dbb3abaa7f227","modified":1701744492743},{"_id":"source/_posts/评论模块数据结构设计.md","hash":"ffb5dddfc1b8357527390accdf081082ed9306f9","modified":1701744492741},{"_id":"source/_posts/领域驱动与微服务落地实战-领域划分和建模.md","hash":"0ca8d74686d9d26f0389b102d3a10506eab47b50","modified":1701744492743},{"_id":"source/_posts/聊聊营销-名词定义.md","hash":"808b091f1e29c404dc459f4fba298b3f4c8a76b0","modified":1701746168756},{"_id":"source/_posts/浅谈分布式项目日志监控.md","hash":"a67c18713cd14461354e05d5066c089eb0ea41b0","modified":1701744492741},{"_id":"source/about/index.md","hash":"6d1e41c63d0c6c57848845bce4477063d6fa73cf","modified":1701743854653},{"_id":"source/_posts/dubbo源码研究之config-spring模块/2.png","hash":"176943867120fb1cd325536b8f420eedb6f751ca","modified":1701743854615},{"_id":"source/_posts/RPC框架设计/1.png","hash":"0f9943c6a0b9041ddcd1dd1a2ea53145901a1e7f","modified":1701743854611},{"_id":"source/_posts/dubbo源码研究之config模块/1.png","hash":"aad3886f915dcc9a5be611a6141015a4e507f63d","modified":1701743854616},{"_id":"source/_posts/dubbo源码研究之rpc模块/2.png","hash":"72ceea4bc2d7069ff8212059b6b5138d000a6ebb","modified":1701743854628},{"_id":"source/_posts/dubbo源码研究之container模块/1.png","hash":"359bc3e9d2988e40ac6f64296c6a5b2e418373d9","modified":1701743854617},{"_id":"source/_posts/dubbo源码研究之rpc模块/3.png","hash":"566384baa660f9ee57dc6597c0e726baa3c287de","modified":1701743854629},{"_id":"source/_posts/dubbo源码研究之rpc模块/1.png","hash":"9ff2928821cc09b78cd99cb915bfafab894f1483","modified":1701743854627},{"_id":"source/_posts/java内存结构和内存模型/1.png","hash":"b358bfa228136e7ae26cba246a2d443beeddcbbe","modified":1701743854634},{"_id":"source/_posts/mybatis源码分析（一）/1.png","hash":"9477cae01c7031d72ed0bf3e7f6cfb9a0cbed71d","modified":1701743854637},{"_id":"source/_posts/评论模块数据结构设计/3.png","hash":"86cb9eea700337b239bfbf4bcfc9bc8b4f61e69b","modified":1701743854652},{"_id":"source/_posts/评论模块数据结构设计/1.png","hash":"fa64786979382f2f8f37b40638efa28fcefca9c7","modified":1701743854650},{"_id":"source/_posts/评论模块数据结构设计/2.png","hash":"8471c9c308f1f88aadff3383f2a2b5d5410c8b44","modified":1701743854651},{"_id":"source/_posts/dubbo源码研究之config-spring模块/1.png","hash":"567187a569a43b83589e240f4c7eb2adf0624bd0","modified":1701743854615},{"_id":"source/_posts/dubbo源码研究之dubbo-registry模块/1.png","hash":"4ba0de4ff1e1313f08416d4dd5d068e3387c3200","modified":1701743854619},{"_id":"source/_posts/jenkins进阶/img.png","hash":"3e47cab026af3d72622b9f87065d4d2aa9e923ae","modified":1704030336661},{"_id":"source/_posts/浅谈分布式项目日志监控/1.png","hash":"c7669ce144d17c01d2473078e1c233b87526dda4","modified":1701743854649},{"_id":"source/_posts/JSR-133规范详解/3.png","hash":"4fed736a56cc95e8bfb5aa8243832e7d8d76345d","modified":1701743854611},{"_id":"source/_posts/class装载/1.png","hash":"60056e65e8c2b8d4b4f5ea2eff8902d9dd0c4b4c","modified":1701743854613},{"_id":"source/_posts/dubbo源码研究之rpc模块/4.png","hash":"8f966565103adeb595277b74e777d4979abf2ea5","modified":1701743854630},{"_id":"source/_posts/jenkins进阶/img-1.png","hash":"6d5e55d5fb96d824220f29c44e288c722cfd973c","modified":1704034560339},{"_id":"source/_posts/聊聊营销-名词定义/1.png","hash":"5575bdd35c84886457c6d3ee4cb966e5b385b660","modified":1701745544811},{"_id":"source/_posts/JSR-133规范详解/1.png","hash":"f74ff9878c56b40d900d70269a01bb8cb12e0455","modified":1701743854606},{"_id":"source/_posts/dubbo源码研究之rpc模块/5.png","hash":"f64cf95d6ceaae1c88871db36c242d068976e770","modified":1701743854633},{"_id":"source/_posts/JSR-133规范详解/2.png","hash":"c6bc6c77076f490b3549651a7d43b431fe94275c","modified":1701743854609},{"_id":"source/_posts/dubbo源码研究之extension模块/2.png","hash":"6ccb1c5396bd8360299fbf3a84260ba8ee5425d6","modified":1701743854626},{"_id":"source/_posts/dubbo源码研究之extension模块/1.png","hash":"6ccb1c5396bd8360299fbf3a84260ba8ee5425d6","modified":1701743854623},{"_id":"node_modules/hexo-theme-next/package.json","hash":"81f58b70b6601e5273c7b21f0751d923c1124180","modified":1701744213888},{"_id":"node_modules/hexo-theme-next/languages/README.md","hash":"b2567e32805dda79601157351a07e5ca9fe01315","modified":1701744213914},{"_id":"node_modules/hexo-theme-next/README.md","hash":"36c4b25587ca494102323dab5a38de5490451a64","modified":1701744213915},{"_id":"node_modules/hexo-theme-next/languages/bn.yml","hash":"9f791494afa263c3e31f14b8a5fa2996dfc834c0","modified":1701744214264},{"_id":"node_modules/hexo-theme-next/_config.yml","hash":"3ae18cb9c867f5675603e4e6defe0e3708537612","modified":1701744214260},{"_id":"node_modules/hexo-theme-next/_vendors.yml","hash":"5aa3b0573d47f85b1be7d21ced21c7810b37ecef","modified":1701744214262},{"_id":"node_modules/hexo-theme-next/languages/de.yml","hash":"79b37df731c29665dee6cd7c90d278e1edfb6e24","modified":1701744214267},{"_id":"node_modules/hexo-theme-next/languages/ar.yml","hash":"7d0f39e8684284a04bb9808521c87fecda8bd131","modified":1701744214263},{"_id":"node_modules/hexo-theme-next/languages/fa.yml","hash":"f3ffc444599f4ac92d62e9ed00a1490ebc277d70","modified":1701744214269},{"_id":"node_modules/hexo-theme-next/languages/id.yml","hash":"929df147f4f17d638b07de5fe52ca13e2549ab1c","modified":1701744214273},{"_id":"node_modules/hexo-theme-next/languages/fr.yml","hash":"44cd26479f503751329f6da2ed80cce1bbf18117","modified":1701744214273},{"_id":"node_modules/hexo-theme-next/languages/es.yml","hash":"dffc63ef42e1266b88e0acf08994fd17a9908d53","modified":1701744214269},{"_id":"node_modules/hexo-theme-next/languages/it.yml","hash":"16d716ecfd748def2f6486ef5a82d0ab7ceb4890","modified":1701744214275},{"_id":"node_modules/hexo-theme-next/languages/ko.yml","hash":"d345a303310c8a5f4836c3683f3580f861ebd1b4","modified":1701744214281},{"_id":"node_modules/hexo-theme-next/languages/en.yml","hash":"ba0fd79a2b1d8db01a034180556061745965ff05","modified":1701744214267},{"_id":"node_modules/hexo-theme-next/languages/nl.yml","hash":"3cb3687696635ec71b4ca40c5fc43b56acc8843e","modified":1701744214282},{"_id":"node_modules/hexo-theme-next/languages/ja.yml","hash":"543222bfc516aab6c33e8534f807972ecb8943a9","modified":1701744214281},{"_id":"node_modules/hexo-theme-next/LICENSE.md","hash":"68fc9a03d50fd4b5ea97092b05967d1819dea2c4","modified":1701744213903},{"_id":"node_modules/hexo-theme-next/languages/pt.yml","hash":"70de366e10ea584ba039d40d6b35ac97f93454ad","modified":1701744214283},{"_id":"node_modules/hexo-theme-next/languages/pt-BR.yml","hash":"76b8576ce228d540a16b1f0af5af2cce20923194","modified":1701744214282},{"_id":"node_modules/hexo-theme-next/languages/ru.yml","hash":"c6d8de0ff7d8148d09993257cfd3b7aca755696c","modified":1701744214284},{"_id":"node_modules/hexo-theme-next/languages/th.yml","hash":"6829e998b39f8f143e20b276bb1f62d95a29de58","modified":1701744214285},{"_id":"node_modules/hexo-theme-next/languages/tk.yml","hash":"511726054873f6f8d7ce0d2e803f6731de0ddbe7","modified":1701744214289},{"_id":"node_modules/hexo-theme-next/languages/si.yml","hash":"2d712eedf3f60d04d36c3108cf5a12e2a52e875c","modified":1701744214285},{"_id":"node_modules/hexo-theme-next/languages/uk.yml","hash":"ff537047b4b4c3ca9a7b64fa7f428a9942751eeb","modified":1701744214291},{"_id":"node_modules/hexo-theme-next/languages/tr.yml","hash":"a57e4ed089b893a95f5e1ecff17ce625165f4d46","modified":1701744214290},{"_id":"node_modules/hexo-theme-next/languages/vi.yml","hash":"7ebcba5e1128784195e4681dffc9d34c4e873fec","modified":1701744214291},{"_id":"node_modules/hexo-theme-next/languages/zh-CN.yml","hash":"741d7efe0262c9cdc2c648014b55599665d90f6b","modified":1701744214291},{"_id":"node_modules/hexo-theme-next/languages/zh-HK.yml","hash":"88ea50eeb9097ab4a87a44981a102d8594feb064","modified":1701744214292},{"_id":"node_modules/hexo-theme-next/layout/_layout.njk","hash":"fc0a45112f2dcfc2642404e8934ea32a793c3bd7","modified":1701744213917},{"_id":"node_modules/hexo-theme-next/layout/index.njk","hash":"dd63e488ae8cc144335a5958acedf6a16edd7a92","modified":1701744213981},{"_id":"node_modules/hexo-theme-next/layout/category.njk","hash":"c68b7343d0f8145010f93351908cc36ef6212ec1","modified":1701744213942},{"_id":"node_modules/hexo-theme-next/languages/zh-TW.yml","hash":"4695c87d6b81b3a23d16ad6513d9eaa925f8d8ad","modified":1701744214294},{"_id":"node_modules/hexo-theme-next/layout/post.njk","hash":"0bfce9f133f501a9a4837257e3b862b3bbca15be","modified":1701744214078},{"_id":"node_modules/hexo-theme-next/layout/page.njk","hash":"b0660b2af0ac7d3fda14ca4d9f2c9e79ef06c6f9","modified":1701744214020},{"_id":"node_modules/hexo-theme-next/layout/tag.njk","hash":"9e16ba20c28a7f2c6bc75aa427f48122301a30aa","modified":1701744214096},{"_id":"node_modules/hexo-theme-next/docs/LICENSE.txt","hash":"f5b14f791b7cfa1d16da981d929152e088a5d1b8","modified":1701744214257},{"_id":"node_modules/hexo-theme-next/docs/AUTHORS.md","hash":"a648823121563c34a177ae91f5a774b5e29f01a0","modified":1701744213894},{"_id":"node_modules/hexo-theme-next/layout/_macro/sidebar.njk","hash":"547c62ab14d9e05d2d9116db9048a677fbe1fb6d","modified":1701744214090},{"_id":"node_modules/hexo-theme-next/layout/_scripts/vendors.njk","hash":"be80b9fe415a9a09d74c28e230995fd292dfc123","modified":1701744214106},{"_id":"node_modules/hexo-theme-next/layout/_macro/post.njk","hash":"95822069cce2c4702e035c770b3089bc12a3404c","modified":1701744214074},{"_id":"node_modules/hexo-theme-next/docs/AGPL3.md","hash":"0d2b8c5fa8a614723be0767cc3bca39c49578036","modified":1701744213894},{"_id":"node_modules/hexo-theme-next/layout/_scripts/index.njk","hash":"6668878a0f9a1166c6a879755f54a08d942da870","modified":1701744213973},{"_id":"node_modules/hexo-theme-next/layout/_third-party/fancybox.njk","hash":"844559f46e2ff1c8be234d5763703106e2072a7b","modified":1701744213953},{"_id":"node_modules/hexo-theme-next/layout/_third-party/addtoany.njk","hash":"ef64c6bfb8540cd874701236b9be47db2496e98e","modified":1701744213919},{"_id":"node_modules/hexo-theme-next/layout/_third-party/index.njk","hash":"bda05391c72f7a25731e762077636c4a97fc4910","modified":1701744213975},{"_id":"node_modules/hexo-theme-next/layout/_partials/comments.njk","hash":"d0c470b0f6690aa217e9ada848c5e2e73fb27c6f","modified":1701744213951},{"_id":"node_modules/hexo-theme-next/layout/_third-party/quicklink.njk","hash":"0efed71ed530447718c4ea5bbd5fc8695b0b0d5f","modified":1701744214078},{"_id":"node_modules/hexo-theme-next/layout/_third-party/pace.njk","hash":"d7ad5714079f7f65446f880baf14722435ca9061","modified":1701744214014},{"_id":"node_modules/hexo-theme-next/layout/_partials/footer.njk","hash":"c40760b559c516677c8b11a00ba50c011f2079fd","modified":1701744213958},{"_id":"node_modules/hexo-theme-next/layout/_partials/languages.njk","hash":"e43f22198cccb5f6e306b1ce0d28d12a4fb891f8","modified":1701744213985},{"_id":"node_modules/hexo-theme-next/layout/_partials/pagination.njk","hash":"bc719473ed5948ab6859449d60b8d36cfc1542b4","modified":1701744214021},{"_id":"node_modules/hexo-theme-next/layout/_partials/widgets.njk","hash":"e7f988ecddb2159313699a00827a45eca5622bd4","modified":1701744214109},{"_id":"node_modules/hexo-theme-next/docs/ru/README.md","hash":"ac3c4a7616ea80f0d32d68d6e53233952ba756dc","modified":1701744213911},{"_id":"node_modules/hexo-theme-next/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"7a06d443f374bd1e84294067a0ac796afd9fbe60","modified":1701744213897},{"_id":"node_modules/hexo-theme-next/scripts/helpers/engine.js","hash":"d292b78485e8e8055712b0ed6de7cf559c5fbdcd","modified":1701744213756},{"_id":"node_modules/hexo-theme-next/scripts/events/index.js","hash":"bd9ea82376cd87df611ea3ae077875c7c595a3df","modified":1701744213795},{"_id":"node_modules/hexo-theme-next/layout/_macro/post-collapse.njk","hash":"1a30d751871dabfa80940042ddb1f77d07d830b9","modified":1701744214035},{"_id":"node_modules/hexo-theme-next/layout/archive.njk","hash":"d759f4d2cf5ddc6875ea250113a00662c1caf6d1","modified":1701744213925},{"_id":"node_modules/hexo-theme-next/scripts/helpers/font.js","hash":"3394185a7f0393c16ce52c8028f90da3e9239c55","modified":1701744213771},{"_id":"node_modules/hexo-theme-next/scripts/helpers/navigation.js","hash":"78107021101553c3d23e89290f7530b60cf4aa86","modified":1701744213844},{"_id":"node_modules/hexo-theme-next/docs/zh-CN/CONTRIBUTING.md","hash":"a089f7a8368ab0b7d7b9b7ec0ac3767a453435df","modified":1701744213901},{"_id":"node_modules/hexo-theme-next/scripts/helpers/next-config.js","hash":"226fccbe9c93265e65a300e3cb4bf6f9065cfdd7","modified":1701744213852},{"_id":"node_modules/hexo-theme-next/scripts/helpers/next-url.js","hash":"fd24abfaba4d91923ddb6aecf0268b216678c8bd","modified":1701744213855},{"_id":"node_modules/hexo-theme-next/scripts/helpers/next-vendors.js","hash":"afdd6a188a74c188f0dd154fac70efd4080ca262","modified":1701744213856},{"_id":"node_modules/hexo-theme-next/scripts/filters/default-injects.js","hash":"872f01cb10e422a648ea505436532e776e92926b","modified":1701744213726},{"_id":"node_modules/hexo-theme-next/scripts/filters/locals.js","hash":"9eb5310664759931287dd28ea39165dfb67f12ed","modified":1701744213826},{"_id":"node_modules/hexo-theme-next/scripts/filters/minify.js","hash":"964a01bec35a95da974882295cababcb93219b40","modified":1701744213837},{"_id":"node_modules/hexo-theme-next/scripts/tags/button.js","hash":"c6ad2ed544fbb25ecb5d820c36e76302504271b7","modified":1701744213551},{"_id":"node_modules/hexo-theme-next/scripts/filters/post.js","hash":"fdc8a0af90035e89c3fcb754a0eb189b8951a2bc","modified":1701744213866},{"_id":"node_modules/hexo-theme-next/scripts/tags/caniuse.js","hash":"935a311142a409c1896b3ae3f01fe7a9e2db1134","modified":1701744213555},{"_id":"node_modules/hexo-theme-next/scripts/tags/center-quote.js","hash":"92c19d796bdb3320df9caea59bf52df7a95d9da9","modified":1701744213559},{"_id":"node_modules/hexo-theme-next/scripts/helpers/next-paginator.js","hash":"e86c764b546e4fbb87970cabc4135a56f9ef9fe1","modified":1701744213854},{"_id":"node_modules/hexo-theme-next/scripts/tags/group-pictures.js","hash":"9ed799c329abf830f623689d7e136991256a24ca","modified":1701744213783},{"_id":"node_modules/hexo-theme-next/scripts/tags/index.js","hash":"1f6aba7820f1fb58b61969485148db21846e1aa9","modified":1701744213798},{"_id":"node_modules/hexo-theme-next/scripts/tags/label.js","hash":"8a73348186113bae0a51ea2f891c1bb882fab05a","modified":1701744213818},{"_id":"node_modules/hexo-theme-next/scripts/tags/link-grid.js","hash":"18a483c2d5afd701f6080ffdddf2d1321370336c","modified":1701744213821},{"_id":"node_modules/hexo-theme-next/scripts/tags/mermaid.js","hash":"4fb01ca650fa8b256b8d48f50dc1b18350bd3d6d","modified":1701744213830},{"_id":"node_modules/hexo-theme-next/scripts/tags/note.js","hash":"7b94ddb46b7d4b0fe815f2fbe4bd375f07f55363","modified":1701744213856},{"_id":"node_modules/hexo-theme-next/scripts/tags/pdf.js","hash":"344636b6fd7e27e8831c1e194039afc0d61931cd","modified":1701744213860},{"_id":"node_modules/hexo-theme-next/scripts/tags/tabs.js","hash":"0eabe51da40b4b13e16419c8fe02452d9a4fef73","modified":1701744213871},{"_id":"node_modules/hexo-theme-next/scripts/tags/wavedrom.js","hash":"b44dfeeb58b41945d469141787f3dbce4b117d08","modified":1701744213885},{"_id":"node_modules/hexo-theme-next/scripts/tags/video.js","hash":"2ee926448583be8f95af1f2884ae2c9c4830151d","modified":1701744213883},{"_id":"node_modules/hexo-theme-next/source/css/_colors.styl","hash":"3c6798c10cc220d83481cb3f3782e78558cee789","modified":1701744214116},{"_id":"node_modules/hexo-theme-next/docs/zh-CN/README.md","hash":"9bbdbb0656505acceef9b9895a576164175fe888","modified":1701744213912},{"_id":"node_modules/hexo-theme-next/source/css/_mixins.styl","hash":"83647a6207333b9609ba90b0946b3fa9548e6381","modified":1701744214141},{"_id":"node_modules/hexo-theme-next/source/css/main.styl","hash":"921a58577f411cf4eb5cfd66db0a241f8f88578c","modified":1701744214220},{"_id":"node_modules/hexo-theme-next/source/css/noscript.styl","hash":"dadc81256afb127b77eac6763d5ee0ec9c77f0a3","modified":1701744214227},{"_id":"node_modules/hexo-theme-next/source/js/comments.js","hash":"66ae2e26ea36a41b72c638ea8b220296638ae952","modified":1701744213674},{"_id":"node_modules/hexo-theme-next/source/js/comments-buttons.js","hash":"1a7344440321713426a0b2ab17e276b5bdf85ade","modified":1701744213671},{"_id":"node_modules/hexo-theme-next/source/js/next-boot.js","hash":"da0f07f9eaaa83de70128b0feaea3fdadb90457a","modified":1701744213848},{"_id":"node_modules/hexo-theme-next/source/js/config.js","hash":"4c4ebbe3b3f3841a26f9d5af6d0ba8bc6da01c54","modified":1701744213706},{"_id":"node_modules/hexo-theme-next/source/js/pjax.js","hash":"b03ba78c6916ad2f390d55bc1bc18fafb64b0ebf","modified":1701744213863},{"_id":"node_modules/hexo-theme-next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1701744214110},{"_id":"node_modules/hexo-theme-next/source/js/schedule.js","hash":"a1333258726caf84f368a8f8454639c7dc1626bb","modified":1701744213870},{"_id":"node_modules/hexo-theme-next/source/images/avatar.gif","hash":"2dbc3e2f2d624b2ca1afe6edc2ca17307f1950c8","modified":1701744213376},{"_id":"node_modules/hexo-theme-next/source/js/motion.js","hash":"770d63c26f22705311028a36b52e999cc8a2da82","modified":1701744213837},{"_id":"node_modules/hexo-theme-next/source/js/bookmark.js","hash":"0f563ffbf05fad30e854e413ab17ff7164ab5a53","modified":1701744213536},{"_id":"node_modules/hexo-theme-next/source/js/utils.js","hash":"5e1cf39de050964e97fb3ba0825aeec7f4bc36dd","modified":1701744213878},{"_id":"node_modules/hexo-theme-next/source/images/logo-algolia-nebula-blue-full.svg","hash":"b85e274207b1392782476a0430feac98db1e7da0","modified":1701744214253},{"_id":"node_modules/hexo-theme-next/source/images/logo.svg","hash":"099e11ab995a2c8981427a85476d082609848c77","modified":1701744214255},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/baidu-analytics.njk","hash":"6215309aee028dcb734452beec448c5afb6c63fc","modified":1701744213928},{"_id":"node_modules/hexo-theme-next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1701744214112},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/google-analytics.njk","hash":"d89066ff53879693f023e540d59c86137172c529","modified":1701744213960},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/cloudflare.njk","hash":"a5b8297c2c383124dd6a56e256ecc0c0dcf489be","modified":1701744213947},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/growingio.njk","hash":"8afaa772c390bd9d53a5cff9645ac3168334eb98","modified":1701744213961},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/index.njk","hash":"f900306497b133e8b098bd9f4b96b93d1d96c185","modified":1701744213974},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/matomo.njk","hash":"4e89648a8ec8194c5823064cbca39c938a799006","modified":1701744214004},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/umami.njk","hash":"3343750682fbd8535e50f8129be3003ad26015b4","modified":1701744214103},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/microsoft-clarity.njk","hash":"9dc00fcb0a05899f048eace9f9160b78956655d5","modified":1701744214013},{"_id":"node_modules/hexo-theme-next/layout/_third-party/chat/chatra.njk","hash":"d7263fca16d0278ccf1f6aa1c6df6902a6344a09","modified":1701744213945},{"_id":"node_modules/hexo-theme-next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1701744214110},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/plausible.njk","hash":"ef9f2bb7110507f1c4336800af9157d5fa9765bd","modified":1701744214029},{"_id":"node_modules/hexo-theme-next/layout/_third-party/chat/tidio.njk","hash":"02aab857c27fc103216029be991688b12a73a525","modified":1701744214102},{"_id":"node_modules/hexo-theme-next/layout/_third-party/chat/gitter.njk","hash":"f8cc14b7aa949999a1faaeb7855e2f20b59a386d","modified":1701744213959},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/disqus.njk","hash":"9375b19a89b7fa9474e558d085af5448d4c5c50c","modified":1701744213952},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/changyan.njk","hash":"d1c950f8fbdf85e7a3eae5463767a89e858e8220","modified":1701744213943},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/disqusjs.njk","hash":"0749cb6902baecdfd01f779a2a2513f6d2f6a823","modified":1701744213953},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/livere.njk","hash":"3b13b09fba84ec6000886890a6710736a2b8fafe","modified":1701744213989},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/isso.njk","hash":"64cc3bdaf644fd32c0d0a247f29f5b6904da9af3","modified":1701744213982},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/gitalk.njk","hash":"b63b7e2ede0d3e66e732fa1a06bda9b19e1e85d4","modified":1701744213959},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/utterances.njk","hash":"5a94032bc3512a10ad4328fc19ec07b819a1d687","modified":1701744214104},{"_id":"node_modules/hexo-theme-next/layout/_third-party/math/index.njk","hash":"abf37fc55aa86702118e8fdf5bf2d389dd589aa0","modified":1701744213977},{"_id":"node_modules/hexo-theme-next/layout/_third-party/math/katex.njk","hash":"1ebf658690468ea197bdd0416eb7cfa4bd0b083a","modified":1701744213984},{"_id":"node_modules/hexo-theme-next/layout/_third-party/math/mathjax.njk","hash":"3677017fd4572b158311f5f5d870590ab25184e0","modified":1701744213997},{"_id":"node_modules/hexo-theme-next/layout/_third-party/search/algolia-search.njk","hash":"24ed76e0c72a25ac152820c750a05826a706b6f4","modified":1701744213922},{"_id":"node_modules/hexo-theme-next/layout/_third-party/tags/mermaid.njk","hash":"099e031f52fb8e47b3af5b2684737efc9e643ee7","modified":1701744214011},{"_id":"node_modules/hexo-theme-next/layout/_third-party/statistics/busuanzi-counter.njk","hash":"a4bc501da0f22f7e420f0ca47e83988ce90b1368","modified":1701744213940},{"_id":"node_modules/hexo-theme-next/layout/_third-party/tags/wavedrom.njk","hash":"02202bf563fb5eedde2ccad4d6c5b9109d30a703","modified":1701744214108},{"_id":"node_modules/hexo-theme-next/layout/_third-party/tags/pdf.njk","hash":"2c81984cc4f5123103460442f6e046f5b6c97127","modified":1701744214025},{"_id":"node_modules/hexo-theme-next/layout/_third-party/statistics/firestore.njk","hash":"d32ebe94560fa95824478ebbff531bffc47b194d","modified":1701744213957},{"_id":"node_modules/hexo-theme-next/layout/_third-party/statistics/index.njk","hash":"568ddf7955d11d93fb5e842b403a7ac8b1b7fdb1","modified":1701744213980},{"_id":"node_modules/hexo-theme-next/layout/_third-party/statistics/lean-analytics.njk","hash":"2446e748cdc102c78492216319ac02148db7daf6","modified":1701744213987},{"_id":"node_modules/hexo-theme-next/layout/_partials/page/breadcrumb.njk","hash":"89825e75cc45e9709fa6ba89883669eedaff6f46","modified":1701744213938},{"_id":"node_modules/hexo-theme-next/layout/_partials/page/categories.njk","hash":"17156d99941f28a225951ffdcfa9a115e20dc2d2","modified":1701744213941},{"_id":"node_modules/hexo-theme-next/layout/_partials/page/schedule.njk","hash":"0f4bc8e257da60f77c0c1738607b2bde55810684","modified":1701744214087},{"_id":"node_modules/hexo-theme-next/layout/_partials/page/tags.njk","hash":"a18d1598e36cc72f2b0b24c3cc3c5990dfaa3254","modified":1701744214097},{"_id":"node_modules/hexo-theme-next/layout/_partials/page/page-header.njk","hash":"7ed4f102a1825195cff8d7995bf9219f323a9034","modified":1701744214016},{"_id":"node_modules/hexo-theme-next/layout/_partials/head/head.njk","hash":"5388b157bba4a40b9312f4a45c6678974ccf0837","modified":1701744213967},{"_id":"node_modules/hexo-theme-next/layout/_partials/head/head-unique.njk","hash":"8da52a144060db1a0a088ccb2e6cc8376d1fce70","modified":1701744213965},{"_id":"node_modules/hexo-theme-next/layout/_partials/post/post-copyright.njk","hash":"79667fd0be85ee0e0c69e542e4f870b114c96c33","modified":1701744214043},{"_id":"node_modules/hexo-theme-next/layout/_partials/post/post-followme.njk","hash":"c1e33b4889f75acc490af3c8bde0ec56c518ff41","modified":1701744214045},{"_id":"node_modules/hexo-theme-next/layout/_partials/post/post-related.njk","hash":"e0986db00a0201dd3c60570f964829c84ba5bc68","modified":1701744214064},{"_id":"node_modules/hexo-theme-next/layout/_partials/post/post-reward.njk","hash":"e8b8a7c41e9ec612d0c0c73419529d55d1c16256","modified":1701744214068},{"_id":"node_modules/hexo-theme-next/layout/_partials/post/post-meta.njk","hash":"9fa47e4fb342811da590ee4adc91cf81118c0a39","modified":1701744214050},{"_id":"node_modules/hexo-theme-next/layout/_partials/post/post-share.njk","hash":"ce90c97f222d9c751a08392e9b14d2bdf0f3df1a","modified":1701744214071},{"_id":"node_modules/hexo-theme-next/layout/_partials/header/index.njk","hash":"650de421a8ce4cf685428ffbe0087ff84cbd1356","modified":1701744213968},{"_id":"node_modules/hexo-theme-next/layout/_partials/header/menu.njk","hash":"ee6fc2f111572d3eeab0a2fecbb2d6b3e37ab26b","modified":1701744214006},{"_id":"node_modules/hexo-theme-next/layout/_partials/header/brand.njk","hash":"dd9c4c03e99dfde0dfb8edefcb2c933f2f560efc","modified":1701744213935},{"_id":"node_modules/hexo-theme-next/layout/_partials/search/algolia-search.njk","hash":"efb2b6f19df02ba5ae623a1f274fff52aed21e6f","modified":1701744213921},{"_id":"node_modules/hexo-theme-next/layout/_partials/sidebar/site-overview.njk","hash":"70342218473a6e6aa9148de06bfffe121afb8548","modified":1701744214092},{"_id":"node_modules/hexo-theme-next/layout/_partials/search/localsearch.njk","hash":"661f7acae43f0be694266323320f977d84119abe","modified":1701744213992},{"_id":"node_modules/hexo-theme-next/scripts/events/lib/highlight.js","hash":"6aec7b2c38c50989a23bfaa0d560e75c7f553e12","modified":1701744213787},{"_id":"node_modules/hexo-theme-next/scripts/events/lib/injects.js","hash":"d987709267a1bc6e5014411e9983d7c49c102c16","modified":1701744213800},{"_id":"node_modules/hexo-theme-next/scripts/events/lib/navigation.js","hash":"dd3562686d95a50375e6fd32e717ccb0d99c1e3d","modified":1701744213843},{"_id":"node_modules/hexo-theme-next/layout/_partials/header/menu-item.njk","hash":"41a8b0cc16f60fa085cb719d07216d86b6bc4bf8","modified":1701744214005},{"_id":"node_modules/hexo-theme-next/layout/_third-party/search/localsearch.njk","hash":"e45ea3542cdc9ed7ec8447b5e6f35df4c5e82758","modified":1701744213993},{"_id":"node_modules/hexo-theme-next/scripts/events/lib/utils.js","hash":"6853e5433e3eaa19ea43fa20b08d956ba4cec4ac","modified":1701744213874},{"_id":"node_modules/hexo-theme-next/scripts/events/lib/config.js","hash":"9ec51eb61f7fee612ffc5252f489003a0fa301fc","modified":1701744213700},{"_id":"node_modules/hexo-theme-next/layout/_partials/header/sub-menu.njk","hash":"06480d8ec5f0b87eafd47f082f07968d7282dd5c","modified":1701744214095},{"_id":"node_modules/hexo-theme-next/scripts/events/lib/vendors.js","hash":"64e4024376b51fe81be7ad80235abdf0a83853bd","modified":1701744213882},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/changyan.js","hash":"5798cfc8f63665031dd3e01debed051628cec319","modified":1701744213606},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/default-config.js","hash":"93ee5f9109dad885dc38c49bcee630c10f9dce6e","modified":1701744213709},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/common.js","hash":"19a402a225c31edffc50f202a14e0d582d3db23e","modified":1701744213680},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/disqus.js","hash":"7f71d6b271ba65ff333d5682e7575711d368c0d2","modified":1701744213731},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/gitalk.js","hash":"7bb7dafdd7f6bca8464b54e17e552ce7f1714195","modified":1701744213773},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/livere.js","hash":"5a07d8bb52bc1d51a624ca8db54be144566c306b","modified":1701744213822},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/isso.js","hash":"ff8b5b5145220a17d0ecd9508ba9bd2d3b2da47d","modified":1701744213804},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/disqusjs.js","hash":"a600a98e7436edeb31e291abca359885567df3c9","modified":1701744213740},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/utterances.js","hash":"d3bded697bc32dace689d2a6dfb6eb7514169d15","modified":1701744213880},{"_id":"node_modules/hexo-theme-next/source/js/third-party/addtoany.js","hash":"5276c8f78ee562a8965216dc67d762e59cb4a9f2","modified":1701744213439},{"_id":"node_modules/hexo-theme-next/source/css/_variables/Mist.styl","hash":"a1418c9dc8c0f1a0ad4ded0f4627c45bf0db1a10","modified":1701744214222},{"_id":"node_modules/hexo-theme-next/source/css/_variables/Pisces.styl","hash":"48f4f277946a168d0db1ea02804e85c22ca2c7db","modified":1701744214229},{"_id":"node_modules/hexo-theme-next/source/css/_variables/Muse.styl","hash":"e3be898f5ebcf435a26542653a9297ff2c71aeb0","modified":1701744214226},{"_id":"node_modules/hexo-theme-next/source/js/schemes/muse.js","hash":"ba7ba2c129d1f240c6a22cec3e53f3f22af64b6b","modified":1701744213842},{"_id":"node_modules/hexo-theme-next/source/css/_variables/base.styl","hash":"c4fc4e862d09221265ab1466085f057be2ad2e4d","modified":1701744214158},{"_id":"node_modules/hexo-theme-next/source/css/_variables/Gemini.styl","hash":"96e0a7c2a65ce68215e17e369085b2ea2f1334f2","modified":1701744214179},{"_id":"node_modules/hexo-theme-next/source/js/third-party/quicklink.js","hash":"eed02e6fced8e5a653077205d4d4d7834ca71472","modified":1701744213868},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/base.styl","hash":"d0a7c99095f490b0d2ed6b1be43d435960798cec","modified":1701744214156},{"_id":"node_modules/hexo-theme-next/source/js/third-party/pace.js","hash":"0ef04218b93561ba4d0ff420d556c3d90a756d32","modified":1701744213859},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/buttons.styl","hash":"a042571d85ff7265f799004239a45f36b716b8a6","modified":1701744214170},{"_id":"node_modules/hexo-theme-next/source/js/third-party/fancybox.js","hash":"c098d14e65dd170537134358d4b8359ad0539c2c","modified":1701744213760},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/comments.styl","hash":"e4fecc889ba3317a64e9abba5842c79dff9b7827","modified":1701744214171},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/index.styl","hash":"523fb7b653b87ae37fc91fc8813e4ffad87b0d7e","modified":1701744214209},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/pagination.styl","hash":"f4228c759db4a650c8d38745c2edd1dc83c45687","modified":1701744214228},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/toggles.styl","hash":"782ee1fc5e669d3ddbfeb82b73ad7fe561f1a4fb","modified":1701744214252},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/index.styl","hash":"2298e521253b3bf376a2412271bc2a7d305051f3","modified":1701744214183},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/back-to-top.styl","hash":"7664491542046df9a3887cf40a06e00c0b4086a9","modified":1701744214151},{"_id":"node_modules/hexo-theme-next/layout/_partials/search/index.njk","hash":"8f6f256ab3b351ffc80f1f3f1d9834e9a7cfac31","modified":1701744213971},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/normalize.styl","hash":"b56367ea676ea8e8783ea89cd4ab150c7da7a060","modified":1701744214226},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tables.styl","hash":"e840b23d33023e6d45e018f6e84b683dd56efd8d","modified":1701744214250},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Gemini/index.styl","hash":"9dfe853c901bdc52fc950bacdf15484dbb9bf140","modified":1701744214215},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/index.styl","hash":"8e34df131830d4fa3725e4590a672ba1cf1903e5","modified":1701744214203},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/reading-progress.styl","hash":"90a86045a33c1bae49fc2f6fa1e1b53170c7f77b","modified":1701744214237},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/mobile.styl","hash":"580aa86ed2ec05a7382338a6eea02e9c740b02a5","modified":1701744214223},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Mist/_header.styl","hash":"dafc6d23c80d6fe3e55a7711e94210d2479b629a","modified":1701744214121},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Mist/_layout.styl","hash":"fa4fd8f76464e214fb7318f325b13c2b62f4b478","modified":1701744214131},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Pisces/_header.styl","hash":"ac2dc0ce9c775a83ef7132ae957b54539366ac9c","modified":1701744214130},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Mist/_menu.styl","hash":"fb550935d374e0bdf1097fce187337dc05cad3e1","modified":1701744214136},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Mist/index.styl","hash":"ab16a3dcdc0393b9b582ef59dcc13db9320e917c","modified":1701744214215},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Mist/_posts-expand.styl","hash":"485d23ccb42c0d0c8ead7ea8930dd3e06d79a285","modified":1701744214141},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Pisces/_layout.styl","hash":"26a0cba1eee5de45a45a5e14e17707f905390512","modified":1701744214135},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Pisces/_menu.styl","hash":"72dc825c50357402c342d62ab60fc0c478ab6bc1","modified":1701744214140},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Pisces/_sidebar.styl","hash":"91dbf3ca5c3a613d4e30618c120da535bf2d0336","modified":1701744214143},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Pisces/_sub-menu.styl","hash":"778ed2ad5643b93970c95626b325defeb586733f","modified":1701744214148},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Pisces/index.styl","hash":"8000075b227749a7495eaf417cac6ccfbe441580","modified":1701744214217},{"_id":"node_modules/hexo-theme-next/source/js/third-party/chat/gitter.js","hash":"cc38c94125f90dadde11b5ebac7d8bf99a1a08a2","modified":1701744213779},{"_id":"node_modules/hexo-theme-next/source/js/third-party/chat/tidio.js","hash":"b0079f6a4601e06ca6fe46e83a2f5af553e9bc3c","modified":1701744213873},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/disqus.js","hash":"da361917d65e5dca8362f8cdeb6c8cc0e8316cec","modified":1701744213737},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/changyan.js","hash":"260d1a77d6a3bb33a579d3e4cca1997003e799b5","modified":1701744213645},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/disqusjs.js","hash":"1e826dea3f684c0515f362dc1352447a1f0eae71","modified":1701744213744},{"_id":"node_modules/hexo-theme-next/source/js/third-party/chat/chatra.js","hash":"c32180522788c10e51df1803aa6842ef0432ddc9","modified":1701744213665},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/gitalk.js","hash":"0ec038cf83e8ec067534f16a54041e47a3c1e59a","modified":1701744213775},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/isso.js","hash":"753a873b6f566aff5ba77ca23f91b78eb880ca64","modified":1701744213806},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/utterances.js","hash":"f67f90eb03e284c82da2b8cf2f1e31801813c16d","modified":1701744213882},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Muse/_header.styl","hash":"3fbfab591f280e2e7f3b0265901c93bc4bd137ed","modified":1701744214128},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Muse/_menu.styl","hash":"b7f48be3c43bfa393d62142544a5487a67871713","modified":1701744214137},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/livere.js","hash":"2247d88c934c765c43013337860774aaa99f0b31","modified":1701744213824},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Muse/_layout.styl","hash":"6569a6640f79d247a8235b3914772c0e2f99ead2","modified":1701744214134},{"_id":"node_modules/hexo-theme-next/source/js/third-party/math/katex.js","hash":"83c54ee536e487a1031783443fe0cb63b1b4767e","modified":1701744213817},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Muse/_sidebar.styl","hash":"547c0b5cd5e7ea10d21863d13a6b16579a49396c","modified":1701744214142},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Muse/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1701744214217},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Muse/_sub-menu.styl","hash":"c48ccd8d6651fe1a01faff8f01179456d39ba9b1","modified":1701744214147},{"_id":"node_modules/hexo-theme-next/source/js/third-party/math/mathjax.js","hash":"5c749b9c1c3bb738122d0516211ecff6496d4907","modified":1701744213827},{"_id":"node_modules/hexo-theme-next/source/js/third-party/search/local-search.js","hash":"4536cb6d0a9bbaaa86fab3fa0101f6a3a3ec5a76","modified":1701744213825},{"_id":"node_modules/hexo-theme-next/source/js/third-party/search/algolia-search.js","hash":"fdb7b7cef1a147d897e7f7cd8903b58368ec2062","modified":1701744213478},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/growingio.js","hash":"78dd3cf04082b7dbe6246e404b2aa8e726922402","modified":1701744213785},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/baidu-analytics.js","hash":"f629acc46ff40c071ffd31b77d5c7616f0fdd778","modified":1701744213510},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/matomo.js","hash":"c6a25b26a1443caa70b47fd3dfa282271574deb5","modified":1701744213828},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/google-analytics.js","hash":"59684383385059dc4f8a1ff85dbbeb703bcdbcb5","modified":1701744213781},{"_id":"node_modules/hexo-theme-next/source/js/third-party/statistics/firestore.js","hash":"6e0682bb42170d61b13b786295f45f9c785f8b73","modified":1701744213769},{"_id":"node_modules/hexo-theme-next/source/js/third-party/statistics/lean-analytics.js","hash":"835cbf54c49ef1327f47df70ff2636ad36b6f57d","modified":1701744213819},{"_id":"node_modules/hexo-theme-next/source/js/third-party/tags/mermaid.js","hash":"f27d817b0c2138dd3215b1f46af0753f60a008f3","modified":1701744213836},{"_id":"node_modules/hexo-theme-next/source/js/third-party/tags/pdf.js","hash":"af78c22f0e61c8c8aa8794e585e0d632c6d4fcb8","modified":1701744213862},{"_id":"node_modules/hexo-theme-next/source/js/third-party/tags/wavedrom.js","hash":"40dcd10df6edf124088c329346e0cc0bdac74ef1","modified":1701744213887},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/blockquote-center.styl","hash":"d6418fd2bbfba7b73ddf11ec62db9637fdf5d8af","modified":1701744214162},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/highlight/copy-code.styl","hash":"670fc109b56a010b166b86b616823a1aae97a738","modified":1701744214174},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/highlight/index.styl","hash":"9056be572ec1cfa429abb22be4b45a662d5b0fb1","modified":1701744214209},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/index.styl","hash":"22cd37bd5df9972d5074710896aba4424ad5161c","modified":1701744214210},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/group-pictures.styl","hash":"393ff96234e4196b569d4b11496774eb78e147de","modified":1701744214182},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/mermaid.styl","hash":"48d35dba575a7c9e8845b16652e76b7d4a4646de","modified":1701744214221},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/note.styl","hash":"98d4c20aff0f0fcfe1824017fb06ab21ef0d218e","modified":1701744214227},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/link-grid.styl","hash":"7f8a7345e6537a62cd9e9a94c8f7065b541d9b04","modified":1701744214219},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/pdf.styl","hash":"b6654a1d7cf82577d8263faffee8af3ad4a5c0e8","modified":1701744214229},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/wavedrom.styl","hash":"af113411ad9cca7674177be36af8dd399680834d","modified":1701744214253},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/tabs.styl","hash":"7a39bcce7274284e87388743db62afc847fe6897","modified":1701744214250},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/label.styl","hash":"debee14539272fbe3835a7d3853af2230baa3501","modified":1701744214218},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-body.styl","hash":"d757768a58743601d0d84158ba955eb15d4c3c01","modified":1701744214232},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-footer.styl","hash":"11497388f124bfbb4001495a67d3629a9f618405","modified":1701744214235},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-collapse.styl","hash":"ec37a36e94ba791663607a5022f763915778578f","modified":1701744214233},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-followme.styl","hash":"1ecfd64507954810b07a9d21fb5305b5378feda0","modified":1701744214233},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/index.styl","hash":"098d4bd034e986fcf7e443eac4fc2193935461b7","modified":1701744214189},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-header.styl","hash":"010c901e4ef49a606f8a350efbf09044e76d2ff3","modified":1701744214236},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-reward.styl","hash":"04cf4a69537fc14d3b8904f965d283356853847f","modified":1701744214237},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-gallery.styl","hash":"aa366d37389760c8595529b850f461569577a1c5","modified":1701744214235},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-widgets.styl","hash":"ebfba158a0a4af3d1dabcacbc58986664de52140","modified":1701744214237},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-nav.styl","hash":"9ac6f477177264c26a46e8333b8456720a0444dc","modified":1701744214236},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/pages/categories.styl","hash":"b6e2eb1550a7845cb2adf86081a4ab6c7bde1e68","modified":1701744214171},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/pages/breadcrumb.styl","hash":"8afdc311c6b8db121758371f95cf1c5e77354f42","modified":1701744214170},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/pages/schedule.styl","hash":"6b816c2511242ee503fb5f34cd3e4dcdafc06b85","modified":1701744214238},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/pages/index.styl","hash":"7504dbc5c70262b048143b2c37d2b5aa2809afa2","modified":1701744214185},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/footer/index.styl","hash":"4e967702cf4c637132346bc74ec8854426f1a68c","modified":1701744214195},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/third-party/disqusjs.styl","hash":"877a537d5b95beb048142e4fdee6f17e6ef9c7bb","modified":1701744214179},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/third-party/index.styl","hash":"77550e0d3e029b7458e35d8c5ae1fbd612c9673b","modified":1701744214189},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/third-party/gitter.styl","hash":"35104dc6883a61c31e0e368dac8ac2f697be62fe","modified":1701744214181},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/pages/tag-cloud.styl","hash":"1a81d1a71fcf0699629ce6e72dfd0a15f3a2dd0a","modified":1701744214251},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/third-party/gitalk.styl","hash":"8f094c4ac17e2ab45569b12d157747f9c7333c12","modified":1701744214180},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/third-party/utterances.styl","hash":"56d90ae0559caa55b75f3c300ff2711f9ed65fc4","modified":1701744214252},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/third-party/search.styl","hash":"e72799ce3f9b79753e365b2f8c8ef6c310668d4a","modified":1701744214239},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/header/github-banner.styl","hash":"38c64c2d04e46848382bfa246a0e9c508294767b","modified":1701744214181},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/header/bookmark.styl","hash":"e74f4bb47a101b014ee2a1783c87f3b87323f9a0","modified":1701744214166},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/third-party/math.styl","hash":"9d995eb4871a6c273d9d51558676a1fdabf69e72","modified":1701744214220},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/header/menu.styl","hash":"b750af2fb833c10c4313b5a4258237161a7833d7","modified":1701744214221},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/header/index.styl","hash":"6e0d0796ef7fbbb62ffdfb448753a850de82c74f","modified":1701744214196},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/header/site-nav.styl","hash":"bf3ad8b4268f763a1e26377681644887694bc009","modified":1701744214249},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/index.styl","hash":"da5e88f8debd5ac8d7af5c6ba6240df66104955f","modified":1701744214207},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/related-posts.styl","hash":"b05908f04ef95f2d91e6eba89b12411c378d050f","modified":1701744214238},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/header/site-meta.styl","hash":"a851e9d5aefcd027c95eeb323860b6da70f202d1","modified":1701744214248},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-author.styl","hash":"5b38ac4a0f1ade0e681aff0e3366c481d9cf3dcd","modified":1701744214241},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-blogroll.styl","hash":"c6a27beb3f741211a14576026f3b4cfc44cc6407","modified":1701744214242},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-author-links.styl","hash":"52fc98b1435129eb3edb9293ced9e507741f1350","modified":1701744214241},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-nav.styl","hash":"24752d145c6fb8f5344dca9c7b9640839c02e009","modified":1701744214242},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-button.styl","hash":"b926e368f702f8686aaa2eb98d3d2e533418958c","modified":1701744214242},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-toc.styl","hash":"c2e354a565c8c1b32bd0ceacc972b17982758b67","modified":1701744214245},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/site-state.styl","hash":"26dd0adfcb1db6df29c6090c8d7e9b5a43583fb0","modified":1701744214250},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-toggle.styl","hash":"9a7c71560fbdc936ad4e736fe15063ea3e8a644b","modified":1701744214247},{"_id":"source/_posts/ringBuffer深入浅出/1.png","hash":"92240193bb3d45ac4e090ee3b462f5e5c544ddeb","modified":1701743854646},{"_id":"source/images/background.png","hash":"5ea6717984352e9334712b4e72e745ae6c02b807","modified":1701743854701},{"_id":"public/search/cb-search.json","hash":"d78b111786cf8f1df94b16787803687a1819333d","modified":1704035906589},{"_id":"public/baidu_urls.txt","hash":"3732ed98da1860f6fbc07a46743d91c087c2133b","modified":1704035906589},{"_id":"public/baidusitemap.xml","hash":"59905391bee700f567c446cc082a828c65855fa1","modified":1704035906589},{"_id":"public/search.xml","hash":"42fdef735a515c9b482ae8f5c7e7a6b672067886","modified":1704035906589},{"_id":"public/submit_urls.txt","hash":"3806af9df2c243583cd4288049aa4f59b9ef9942","modified":1704035906589},{"_id":"public/404/index.html","hash":"376af029365c549ea3fd487c0edb1bb3050cb6eb","modified":1704035906589},{"_id":"public/tags/index.html","hash":"889a901f71c44a20a7952af756e19da91714ca0e","modified":1704035906589},{"_id":"public/schedule/index.html","hash":"458934751f334ad3e217a0d39cab2a0b1890e2f0","modified":1704035906589},{"_id":"public/about/index.html","hash":"0d71bb87151d8d651f038950a019e865d9470fca","modified":1704035906589},{"_id":"public/2023123177c57190/index.html","hash":"95803f905a5267c9d17ff6212e2a316040848162","modified":1704035906589},{"_id":"public/20230622a713a826/index.html","hash":"316cbbec4756cd7effc19e917a5e819f5ffc0a68","modified":1704035906589},{"_id":"public/202306201125/index.html","hash":"8be58c6768ae5ef6a7811d13ac938842c862e721","modified":1704035906589},{"_id":"public/202306216e4195e6/index.html","hash":"1411563643bd98739f70b4a5c59fbd85140c985a","modified":1704035906589},{"_id":"public/2023062055742/index.html","hash":"cbf6105098187539d3e7e332442f0dbd51c076ad","modified":1704035906589},{"_id":"public/2023062062550/index.html","hash":"0fba7599ec644e9115fe4567a5437a0f3c9383b9","modified":1704035906589},{"_id":"public/2023062022759/index.html","hash":"865c3220b4dcc9aa0b974ee1a55fc87a0f5c57bf","modified":1704035906589},{"_id":"public/2023062015835/index.html","hash":"7611595295fda7c535f06d221d04114384a786a5","modified":1704035906589},{"_id":"public/2023062034905/index.html","hash":"d4a383fd623c79d8f659462daa3a59bc28a8a4a0","modified":1704035906589},{"_id":"public/202306207816/index.html","hash":"8cca35523cd33dd4b26fd95850dfabe98fd6bca1","modified":1704035906589},{"_id":"public/2023062059976/index.html","hash":"b8022f7fb9595c2246cd28fa1f6a7a52bdf2b004","modified":1704035906589},{"_id":"public/2023062059910/index.html","hash":"3fbe3fbbb6cb03dca1ce7bf3928ed839a4bbfc12","modified":1704035906589},{"_id":"public/2023062063138/index.html","hash":"1c1e90b8cd064460d4cbd619e7f8dc2077bbf292","modified":1704035906589},{"_id":"public/2023062026971/index.html","hash":"30a6d6377ed84e3f562be0aedfc6733a0d021bd6","modified":1704035906589},{"_id":"public/202306203579/index.html","hash":"deb9b1a88f18f5627a4b3338f6bf212ec9509a8c","modified":1704035906589},{"_id":"public/202306209196/index.html","hash":"fb601a06ddcedaa347dff9f8a35073190bc96d5d","modified":1704035906589},{"_id":"public/20230620302/index.html","hash":"35021f7474dd66db16c93b42e66a4fcf6ca3981a","modified":1704035906589},{"_id":"public/2023062035937/index.html","hash":"561da7b537b8b3fd383148b9a886e62fdbe10ee4","modified":1704035906589},{"_id":"public/2023062051308/index.html","hash":"bd205e26d64180f2de76fa54822d189de557a837","modified":1704035906589},{"_id":"public/2023062012456/index.html","hash":"471bd12c22b2ed866561fedf96cc33fd7c131b38","modified":1704035906589},{"_id":"public/2023062010082/index.html","hash":"1c4d9955b83d126182b207d3eb66bb7c16b07a84","modified":1704035906589},{"_id":"public/2023062036986/index.html","hash":"15eb500060dd73d46c2061bfc1ecf23604dd72e3","modified":1704035906589},{"_id":"public/202306204306/index.html","hash":"cbfb1ed25b681b4940dc36fb94eafdf47f07a3d6","modified":1704035906589},{"_id":"public/2023062011819/index.html","hash":"14fd294308c38edbc1575bb7811773fcae5b015c","modified":1704035906589},{"_id":"public/20230620172/index.html","hash":"dcf50dc2d2669b2d1eb22aced9da4a24dd7c67e0","modified":1704035906589},{"_id":"public/2023062047627/index.html","hash":"b0a3bcab7c518957ec39817b9b3dd122be9be8ad","modified":1704035906589},{"_id":"public/2023061932149/index.html","hash":"11cad06de3a4f1b74bc39014c0a3d3101481e51b","modified":1704035906589},{"_id":"public/2023062058164/index.html","hash":"b4c48deaf9b585f6eca309ffa7ca83f8866ba79c","modified":1704035906589},{"_id":"public/2023061939355/index.html","hash":"f159d7476813c46c040ed8f55cda55b8018c7d63","modified":1704035906589},{"_id":"public/2023061940013/index.html","hash":"6ab31caf8740399caf6d8714eadd429fc8b7d996","modified":1704035906589},{"_id":"public/2023061930297/index.html","hash":"16c2c14183de1b61752b843398c9cc69345d8a67","modified":1704035906589},{"_id":"public/202306199592/index.html","hash":"de73462afc12c11846da16474bb16cb83a9ba590","modified":1704035906589},{"_id":"public/archives/index.html","hash":"981081f28b5fddac3074bf82c6ec6f9b90f5e994","modified":1704035906589},{"_id":"public/archives/page/2/index.html","hash":"ecfc35a55fae3c22b3bb420021f96aa3f6daddaf","modified":1704035906589},{"_id":"public/archives/page/3/index.html","hash":"4e9895366a71a5305c5dd76d0e65260381935007","modified":1704035906589},{"_id":"public/archives/2023/page/2/index.html","hash":"2ffdebfedfece9313e10d1849f8a553acb34c18e","modified":1704035906589},{"_id":"public/archives/page/4/index.html","hash":"caf4a6e5bd4048821f43a94e86ae94dfd092c52a","modified":1704035906589},{"_id":"public/archives/2023/index.html","hash":"4b99ac210c7e90a62f6259037e7794c81aed3b79","modified":1704035906589},{"_id":"public/archives/2023/page/3/index.html","hash":"e9c2bcd584793620e5b89a1a7bc87b6587a45617","modified":1704035906589},{"_id":"public/archives/2023/page/4/index.html","hash":"8530f13fb786b0452aaefd422150f2621431f5aa","modified":1704035906589},{"_id":"public/archives/2023/06/index.html","hash":"5cca4686e3310a2e4321f98b47f3532ce4c00bc2","modified":1704035906589},{"_id":"public/archives/2023/06/page/2/index.html","hash":"283706e2a16636d442edb6845466027f56ef6149","modified":1704035906589},{"_id":"public/archives/2023/06/page/3/index.html","hash":"c821507e6b6537f65b68eec19f5efa2cb47d6b8a","modified":1704035906589},{"_id":"public/archives/2023/06/page/4/index.html","hash":"70aa801ad1cc778a10001156439b74df185eec23","modified":1704035906589},{"_id":"public/archives/2023/12/index.html","hash":"6fbfef0bfcc7221b1cf670265046103d8e0b26d0","modified":1704035906589},{"_id":"public/index.html","hash":"312b7c9469794a1e26bb214dc10f3eaefa5e2cee","modified":1704035906589},{"_id":"public/page/2/index.html","hash":"1e3e1c4d65cf23f2016c0ba915cc2e5b01307822","modified":1704035906589},{"_id":"public/page/3/index.html","hash":"ec4ebc17bea73bef860f5f51ef59907a72fad489","modified":1704035906589},{"_id":"public/page/4/index.html","hash":"54d31b6d236096ade61f6815429924736b2d2c3e","modified":1704035906589},{"_id":"public/tags/java源码/index.html","hash":"441db122c4438ff431d92e7064da687005e95559","modified":1704035906589},{"_id":"public/tags/架构设计/index.html","hash":"78d9229b68d3200ad44694a2010158bf8758922f","modified":1704035906589},{"_id":"public/tags/java/index.html","hash":"f31c9bd0f26d48ac8da0abaefe0023eed30f0900","modified":1704035906589},{"_id":"public/tags/dubbo/index.html","hash":"911f6a884adf949270aa030aa6dc64679fe7d79f","modified":1704035906589},{"_id":"public/tags/前端/index.html","hash":"ec2683a6a1284017035d596fe3d0e4f62729001b","modified":1704035906589},{"_id":"public/tags/jvm/index.html","hash":"1be49d28a0e37c7dd45e725ceba8b03b21d075bb","modified":1704035906589},{"_id":"public/tags/jenkins/index.html","hash":"3add951af83c093e5a8436c9ab56dd89f9a8d1b8","modified":1704035906589},{"_id":"public/tags/架构师进阶之路/index.html","hash":"48e200495cc0a95c72037707296ec2bff5c37836","modified":1704035906589},{"_id":"public/tags/mybatis/index.html","hash":"26265e26c62ae65ab9adfdbcec2bfa27f55fecd1","modified":1704035906589},{"_id":"public/tags/solr/index.html","hash":"82e5f636cfbf8b5eed3a037cfc71fce079dec02b","modified":1704035906589},{"_id":"public/tags/营销/index.html","hash":"11946dc67166eb3e021c6e02d8193c2cbe3d7c4c","modified":1704035906589},{"_id":"public/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1704035906589},{"_id":"public/images/avatar.gif","hash":"2dbc3e2f2d624b2ca1afe6edc2ca17307f1950c8","modified":1704035906589},{"_id":"public/images/logo-algolia-nebula-blue-full.svg","hash":"b85e274207b1392782476a0430feac98db1e7da0","modified":1704035906589},{"_id":"public/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1704035906589},{"_id":"public/images/logo.svg","hash":"099e11ab995a2c8981427a85476d082609848c77","modified":1704035906589},{"_id":"public/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1704035906589},{"_id":"public/CNAME","hash":"6e8232e2bc4eb6c05388523bd2ee4448dcbce4c7","modified":1704035906589},{"_id":"public/2023062036986/1.png","hash":"aad3886f915dcc9a5be611a6141015a4e507f63d","modified":1704035906589},{"_id":"public/20230620172/1.png","hash":"359bc3e9d2988e40ac6f64296c6a5b2e418373d9","modified":1704035906589},{"_id":"public/2023062059976/1.png","hash":"0f9943c6a0b9041ddcd1dd1a2ea53145901a1e7f","modified":1704035906589},{"_id":"public/2023062010082/2.png","hash":"176943867120fb1cd325536b8f420eedb6f751ca","modified":1704035906589},{"_id":"public/2023062047627/1.png","hash":"9ff2928821cc09b78cd99cb915bfafab894f1483","modified":1704035906589},{"_id":"public/2023062047627/2.png","hash":"72ceea4bc2d7069ff8212059b6b5138d000a6ebb","modified":1704035906589},{"_id":"public/2023062047627/3.png","hash":"566384baa660f9ee57dc6597c0e726baa3c287de","modified":1704035906589},{"_id":"public/2023062026971/1.png","hash":"9477cae01c7031d72ed0bf3e7f6cfb9a0cbed71d","modified":1704035906589},{"_id":"public/2023062012456/1.png","hash":"b358bfa228136e7ae26cba246a2d443beeddcbbe","modified":1704035906589},{"_id":"public/202306201125/1.png","hash":"fa64786979382f2f8f37b40638efa28fcefca9c7","modified":1704035906589},{"_id":"public/202306201125/2.png","hash":"8471c9c308f1f88aadff3383f2a2b5d5410c8b44","modified":1704035906589},{"_id":"public/202306201125/3.png","hash":"86cb9eea700337b239bfbf4bcfc9bc8b4f61e69b","modified":1704035906589},{"_id":"public/live2dw/assets/moc/z16.512/texture_00.png","hash":"251b9f944fb1575c01a62b8a9d7522fe76954b3b","modified":1704035906589},{"_id":"public/live2dw/assets/moc/z16.256/texture_00.png","hash":"19f22619c246067d519aa1e6e477497cc4342414","modified":1704035906589},{"_id":"public/live2dw/assets/exp/f00.exp.json","hash":"84073a497ddb6e56c6cfc244a0fb217ba473abf9","modified":1704035906589},{"_id":"public/live2dw/assets/mtn/idle.mtn","hash":"f6b879d9f1d096509a7edbc971b8fdd9697932e9","modified":1704035906589},{"_id":"public/live2dw/lib/L2Dwidget.min.js","hash":"5f1a807437cc723bcadc3791d37add5ceed566a2","modified":1704035906589},{"_id":"public/live2dw/assets/z16.model.json","hash":"e69f3d2ecc9bf51b3972ad9df8f6aaa31956910c","modified":1704035906589},{"_id":"public/live2dw/assets/z16.physics.json","hash":"67f13f60030d7e4c7f824c001ab5254ce4b9bafd","modified":1704035906589},{"_id":"public/2023062010082/1.png","hash":"567187a569a43b83589e240f4c7eb2adf0624bd0","modified":1704035906589},{"_id":"public/2023061932149/1.png","hash":"4ba0de4ff1e1313f08416d4dd5d068e3387c3200","modified":1704035906589},{"_id":"public/2023123177c57190/img.png","hash":"3e47cab026af3d72622b9f87065d4d2aa9e923ae","modified":1704035906589},{"_id":"public/202306204306/1.png","hash":"c7669ce144d17c01d2473078e1c233b87526dda4","modified":1704035906589},{"_id":"public/live2dw/assets/moc/z16.moc","hash":"6b0241e80e94664d694b43ad05333960de2550c1","modified":1704035906589},{"_id":"public/live2dw/lib/L2Dwidget.min.js.map","hash":"3290fe2df45f065b51a1cd7b24ec325cbf9bb5ce","modified":1704035906589},{"_id":"public/js/comments-buttons.js","hash":"1a7344440321713426a0b2ab17e276b5bdf85ade","modified":1704035906589},{"_id":"public/js/comments.js","hash":"66ae2e26ea36a41b72c638ea8b220296638ae952","modified":1704035906589},{"_id":"public/js/next-boot.js","hash":"da0f07f9eaaa83de70128b0feaea3fdadb90457a","modified":1704035906589},{"_id":"public/js/pjax.js","hash":"b03ba78c6916ad2f390d55bc1bc18fafb64b0ebf","modified":1704035906589},{"_id":"public/js/schedule.js","hash":"a1333258726caf84f368a8f8454639c7dc1626bb","modified":1704035906589},{"_id":"public/js/bookmark.js","hash":"0f563ffbf05fad30e854e413ab17ff7164ab5a53","modified":1704035906589},{"_id":"public/js/utils.js","hash":"5e1cf39de050964e97fb3ba0825aeec7f4bc36dd","modified":1704035906589},{"_id":"public/js/third-party/addtoany.js","hash":"5276c8f78ee562a8965216dc67d762e59cb4a9f2","modified":1704035906589},{"_id":"public/js/config.js","hash":"4c4ebbe3b3f3841a26f9d5af6d0ba8bc6da01c54","modified":1704035906589},{"_id":"public/js/schemes/muse.js","hash":"ba7ba2c129d1f240c6a22cec3e53f3f22af64b6b","modified":1704035906589},{"_id":"public/js/motion.js","hash":"770d63c26f22705311028a36b52e999cc8a2da82","modified":1704035906589},{"_id":"public/js/third-party/pace.js","hash":"0ef04218b93561ba4d0ff420d556c3d90a756d32","modified":1704035906589},{"_id":"public/js/third-party/quicklink.js","hash":"eed02e6fced8e5a653077205d4d4d7834ca71472","modified":1704035906589},{"_id":"public/js/third-party/chat/gitter.js","hash":"cc38c94125f90dadde11b5ebac7d8bf99a1a08a2","modified":1704035906589},{"_id":"public/js/third-party/chat/chatra.js","hash":"c32180522788c10e51df1803aa6842ef0432ddc9","modified":1704035906589},{"_id":"public/js/third-party/chat/tidio.js","hash":"b0079f6a4601e06ca6fe46e83a2f5af553e9bc3c","modified":1704035906589},{"_id":"public/js/third-party/comments/disqus.js","hash":"da361917d65e5dca8362f8cdeb6c8cc0e8316cec","modified":1704035906589},{"_id":"public/js/third-party/comments/disqusjs.js","hash":"1e826dea3f684c0515f362dc1352447a1f0eae71","modified":1704035906589},{"_id":"public/js/third-party/fancybox.js","hash":"c098d14e65dd170537134358d4b8359ad0539c2c","modified":1704035906589},{"_id":"public/js/third-party/comments/gitalk.js","hash":"0ec038cf83e8ec067534f16a54041e47a3c1e59a","modified":1704035906589},{"_id":"public/js/third-party/comments/isso.js","hash":"753a873b6f566aff5ba77ca23f91b78eb880ca64","modified":1704035906589},{"_id":"public/js/third-party/comments/utterances.js","hash":"f67f90eb03e284c82da2b8cf2f1e31801813c16d","modified":1704035906589},{"_id":"public/js/third-party/search/local-search.js","hash":"4536cb6d0a9bbaaa86fab3fa0101f6a3a3ec5a76","modified":1704035906589},{"_id":"public/js/third-party/search/algolia-search.js","hash":"fdb7b7cef1a147d897e7f7cd8903b58368ec2062","modified":1704035906589},{"_id":"public/js/third-party/comments/changyan.js","hash":"260d1a77d6a3bb33a579d3e4cca1997003e799b5","modified":1704035906589},{"_id":"public/js/third-party/math/mathjax.js","hash":"5c749b9c1c3bb738122d0516211ecff6496d4907","modified":1704035906589},{"_id":"public/js/third-party/math/katex.js","hash":"83c54ee536e487a1031783443fe0cb63b1b4767e","modified":1704035906589},{"_id":"public/js/third-party/comments/livere.js","hash":"2247d88c934c765c43013337860774aaa99f0b31","modified":1704035906589},{"_id":"public/js/third-party/analytics/matomo.js","hash":"c6a25b26a1443caa70b47fd3dfa282271574deb5","modified":1704035906589},{"_id":"public/js/third-party/analytics/google-analytics.js","hash":"59684383385059dc4f8a1ff85dbbeb703bcdbcb5","modified":1704035906589},{"_id":"public/js/third-party/statistics/firestore.js","hash":"6e0682bb42170d61b13b786295f45f9c785f8b73","modified":1704035906589},{"_id":"public/js/third-party/analytics/baidu-analytics.js","hash":"f629acc46ff40c071ffd31b77d5c7616f0fdd778","modified":1704035906589},{"_id":"public/js/third-party/analytics/growingio.js","hash":"78dd3cf04082b7dbe6246e404b2aa8e726922402","modified":1704035906589},{"_id":"public/js/third-party/statistics/lean-analytics.js","hash":"835cbf54c49ef1327f47df70ff2636ad36b6f57d","modified":1704035906589},{"_id":"public/js/third-party/tags/mermaid.js","hash":"f27d817b0c2138dd3215b1f46af0753f60a008f3","modified":1704035906589},{"_id":"public/js/third-party/tags/wavedrom.js","hash":"40dcd10df6edf124088c329346e0cc0bdac74ef1","modified":1704035906589},{"_id":"public/js/third-party/tags/pdf.js","hash":"af78c22f0e61c8c8aa8794e585e0d632c6d4fcb8","modified":1704035906589},{"_id":"public/2023062015835/3.png","hash":"4fed736a56cc95e8bfb5aa8243832e7d8d76345d","modified":1704035906589},{"_id":"public/2023062034905/1.png","hash":"60056e65e8c2b8d4b4f5ea2eff8902d9dd0c4b4c","modified":1704035906589},{"_id":"public/2023062047627/4.png","hash":"8f966565103adeb595277b74e777d4979abf2ea5","modified":1704035906589},{"_id":"public/2023123177c57190/img-1.png","hash":"6d5e55d5fb96d824220f29c44e288c722cfd973c","modified":1704035906589},{"_id":"public/live2dw/assets/moc/z16.1024/texture_00.png","hash":"c4f7c067d7d37601490554438ab801fce1feb92d","modified":1704035906589},{"_id":"public/202306216e4195e6/1.png","hash":"5575bdd35c84886457c6d3ee4cb966e5b385b660","modified":1704035906589},{"_id":"public/live2dw/lib/L2Dwidget.0.min.js","hash":"35bb5b588b6de25c9be2dd51d3fd331feafac02d","modified":1704035906589},{"_id":"public/css/noscript.css","hash":"f855a1c9d5e302aeab8000088901a577bf291558","modified":1704035906589},{"_id":"public/css/main.css","hash":"8071ea4213d799ea825b5573ada2e979d433de2e","modified":1704035906589},{"_id":"public/2023062015835/1.png","hash":"f74ff9878c56b40d900d70269a01bb8cb12e0455","modified":1704035906589},{"_id":"public/2023062047627/5.png","hash":"f64cf95d6ceaae1c88871db36c242d068976e770","modified":1704035906589},{"_id":"public/2023062015835/2.png","hash":"c6bc6c77076f490b3549651a7d43b431fe94275c","modified":1704035906589},{"_id":"public/2023061940013/2.png","hash":"6ccb1c5396bd8360299fbf3a84260ba8ee5425d6","modified":1704035906589},{"_id":"public/2023061940013/1.png","hash":"6ccb1c5396bd8360299fbf3a84260ba8ee5425d6","modified":1704035906589},{"_id":"public/live2dw/lib/L2Dwidget.0.min.js.map","hash":"35e71cc2a130199efb167b9a06939576602f0d75","modified":1704035906589},{"_id":"public/2023062022759/1.png","hash":"92240193bb3d45ac4e090ee3b462f5e5c544ddeb","modified":1704035906589},{"_id":"public/images/background.png","hash":"5ea6717984352e9334712b4e72e745ae6c02b807","modified":1704035906589}],"Category":[],"Data":[{"_id":"styles","data":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}],"Page":[{"title":"404","date":"2023-06-20T09:03:32.000Z","_content":"\n\n<!DOCTYPE HTML>\n<html>\n<head>\n<meta charset=\"UTF-8\" />\n<meta name=\"description\" content=\"你访问的页面找不回来了，但是我们可以一起寻找失踪宝贝\" />\n<meta name=\"description\" content=\"公益404页面是由腾讯公司员工志愿者自主发起的互联网公益活动。\" />\n<meta name=\"description\" content=\"腾讯志愿者是腾讯公司内部员工为响应公司做“最受人尊敬的互联网企业”的号召，自发组织成立的腾讯志愿者协会。\" />\n<title>404</title>\n</head>\n<body>\n<script type=\"text/javascript\" src=\"//qzonestyle.gtimg.cn/qzone/hybrid/app/404/search_children.js\"></script>\n</body>\n</html>","source":"404/index.md","raw":"---\ntitle: 404\ndate: 2023-06-20 17:03:32\n---\n\n\n<!DOCTYPE HTML>\n<html>\n<head>\n<meta charset=\"UTF-8\" />\n<meta name=\"description\" content=\"你访问的页面找不回来了，但是我们可以一起寻找失踪宝贝\" />\n<meta name=\"description\" content=\"公益404页面是由腾讯公司员工志愿者自主发起的互联网公益活动。\" />\n<meta name=\"description\" content=\"腾讯志愿者是腾讯公司内部员工为响应公司做“最受人尊敬的互联网企业”的号召，自发组织成立的腾讯志愿者协会。\" />\n<title>404</title>\n</head>\n<body>\n<script type=\"text/javascript\" src=\"//qzonestyle.gtimg.cn/qzone/hybrid/app/404/search_children.js\"></script>\n</body>\n</html>","updated":"2023-12-05T02:37:34.603Z","path":"404/index.html","comments":1,"layout":"page","_id":"clqtmzdij0000orgo1drfc26k","content":"<!DOCTYPE HTML>\n<html>\n<head>\n<meta charset=\"UTF-8\" />\n<meta name=\"description\" content=\"你访问的页面找不回来了，但是我们可以一起寻找失踪宝贝\" />\n<meta name=\"description\" content=\"公益404页面是由腾讯公司员工志愿者自主发起的互联网公益活动。\" />\n<meta name=\"description\" content=\"腾讯志愿者是腾讯公司内部员工为响应公司做“最受人尊敬的互联网企业”的号召，自发组织成立的腾讯志愿者协会。\" />\n<title>404</title>\n</head>\n<body>\n<script type=\"text/javascript\" src=\"//qzonestyle.gtimg.cn/qzone/hybrid/app/404/search_children.js\"></script>\n</body>\n</html>","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<!DOCTYPE HTML>\n<html>\n<head>\n<meta charset=\"UTF-8\" />\n<meta name=\"description\" content=\"你访问的页面找不回来了，但是我们可以一起寻找失踪宝贝\" />\n<meta name=\"description\" content=\"公益404页面是由腾讯公司员工志愿者自主发起的互联网公益活动。\" />\n<meta name=\"description\" content=\"腾讯志愿者是腾讯公司内部员工为响应公司做“最受人尊敬的互联网企业”的号召，自发组织成立的腾讯志愿者协会。\" />\n<title>404</title>\n</head>\n<body>\n<script type=\"text/javascript\" src=\"//qzonestyle.gtimg.cn/qzone/hybrid/app/404/search_children.js\"></script>\n</body>\n</html>"},{"title":"tags","date":"2023-06-20T08:52:50.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2023-06-20 16:52:50\ntype: \"tags\"\n---\n","updated":"2023-12-05T02:37:34.703Z","path":"tags/index.html","comments":1,"layout":"page","_id":"clqtmzdip0002orgo11x9byvl","content":"","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":""},{"title":"schedule","date":"2023-06-20T09:01:44.000Z","_content":"","source":"schedule/index.md","raw":"---\ntitle: schedule\ndate: 2023-06-20 17:01:44\n---\n","updated":"2023-12-05T02:37:34.702Z","path":"schedule/index.html","comments":1,"layout":"page","_id":"clqtmzdis0005orgo07ighycb","content":"","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":""},{"title":"about","date":"2023-06-20T08:59:38.000Z","_content":"\nxxx\n","source":"about/index.md","raw":"---\ntitle: about\ndate: 2023-06-20 16:59:38\n\n---\n\nxxx\n","updated":"2023-12-05T02:37:34.653Z","path":"about/index.html","comments":1,"layout":"page","_id":"clqtmzdit0007orgodkqjaq46","content":"<p>xxx</p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<p>xxx</p>\n"}],"Post":[{"title":"Buffer详解","abbrlink":9196,"date":"2023-06-20T06:38:07.000Z","_content":"# Buffer详解\n\njava中的nio由channel,buffer,Selector组成核心API。\nBuffer是一个继承于object的抽象类,主要有下面几种。\n\n- ByteBuffer\n- CharBuffer\n- DoubleBuffer\n- FloatBuffer\n- IntBuffer\n- LongBuffer\n- ShortBuffer\n\n基本覆盖了基本类型的支持，看下byteBuffer的实现\n\n{% codeblock  lang:java   %}\n\n    // 间接缓冲区\n    ByteBuffer bf1=ByteBuffer.allocate(16);\n    // 直接缓冲区\n    ByteBuffer bf2=ByteBuffer.allocateDirect(16);\n\n{% endcodeblock %}\nByteBuffer提供两种方式来获取缓存区内存，间接或者直接。\n字节缓冲区要么是直接的，要么是非直接的。\n如果为直接字节缓冲区，则 Java 虚拟机会尽最大努力直接在此缓冲区上执行本机 I/O 操作。\n也就是说，在每次调用基础操作系统的一个本机 I/O 操作之前（或之后），\n虚拟机都会尽量避免将缓冲区的内容复制到中间缓冲区中（或从中间缓冲区中复制内容）。\n**直接缓冲区的内容可以驻留在常规的垃圾回收堆之外，不会被GC回收。**\n间接缓冲区与本地操作系统低层次的i/o交互需要一个中间缓冲区来实现，因此性能比直接缓存区要低。\n直接缓冲区通过sun.misc.Unsafe类调用jni本地方法来分配内存。\n因为绕过jvm,因此分配内存的开销较大，并且需要用户自己当成普通资源来主动释放。\n堆外内存的分配\n\n{% codeblock  lang:java   %}\n\n    DirectByteBuffer(int cap) {                   // package-private\n    super(-1, 0, cap, cap);\n    boolean pa = VM.isDirectMemoryPageAligned();\n    int ps = Bits.pageSize();\n    long size = Math.max(1L, (long)cap + (pa ? ps : 0));\n    Bits.reserveMemory(size, cap);\n    long base = 0;\n    try {\n    base = unsafe.allocateMemory(size);\n    } catch (OutOfMemoryError x) {\n    Bits.unreserveMemory(size, cap);\n    throw x;\n    }\n    unsafe.setMemory(base, size, (byte) 0);\n    if (pa && (base % ps != 0)) {\n    // Round up to page boundary\n    address = base + ps - (base & (ps - 1));\n    } else {\n    address = base;\n    }\n    cleaner = Cleaner.create(this, new Deallocator(base, size, cap));\n    att = null;\n    }\n\n{% endcodeblock %}\n\n可以看出通过unsafe.allocateMemory方法来分配堆外内存，同时创建一个对应的Cleaner\nsun.misc.Cleaner.create方法两个参数。\n- 需要监控的堆内存对象，就是堆外内存关联的对象。\n- 程序释放资源的回调。\n\n当JVM进行GC的时候，如果发现我们监控的对象，不存在强引用了，(Cleaner本身是幽灵引用)，\n就会调用预先绑定的回调方法，我们一般在回调方法里面释放堆外内存\n\n{% codeblock  lang:java   %}\n\n    private static class Deallocator\n    implements Runnable\n    {\n    private static Unsafe unsafe = Unsafe.getUnsafe();\n    private long address;\n    private long size;\n    private int capacity;\n    private Deallocator(long address, long size, int capacity) {\n    assert (address != 0);\n    this.address = address;\n    this.size = size;\n    this.capacity = capacity;\n    }\n    public void run() {\n    if (address == 0) {\n    // Paranoia\n    return;\n    }\n    unsafe.freeMemory(address);\n    address = 0;\n    Bits.unreserveMemory(size, capacity);\n    }\n    }\n\n\n{% endcodeblock %}\n\n最终通过unsafe类提供freeMemory来释放之前分配的对外内存。\n**堆外内存大小可以通过jvm启动参数限制： -XX:MaxDirectMemorySize**","source":"_posts/Buffer详解.md","raw":"---\ntitle: Buffer详解\ntags:\n  - java源码\nabbrlink: 9196\ndate: 2023-06-20 14:38:07\n---\n# Buffer详解\n\njava中的nio由channel,buffer,Selector组成核心API。\nBuffer是一个继承于object的抽象类,主要有下面几种。\n\n- ByteBuffer\n- CharBuffer\n- DoubleBuffer\n- FloatBuffer\n- IntBuffer\n- LongBuffer\n- ShortBuffer\n\n基本覆盖了基本类型的支持，看下byteBuffer的实现\n\n{% codeblock  lang:java   %}\n\n    // 间接缓冲区\n    ByteBuffer bf1=ByteBuffer.allocate(16);\n    // 直接缓冲区\n    ByteBuffer bf2=ByteBuffer.allocateDirect(16);\n\n{% endcodeblock %}\nByteBuffer提供两种方式来获取缓存区内存，间接或者直接。\n字节缓冲区要么是直接的，要么是非直接的。\n如果为直接字节缓冲区，则 Java 虚拟机会尽最大努力直接在此缓冲区上执行本机 I/O 操作。\n也就是说，在每次调用基础操作系统的一个本机 I/O 操作之前（或之后），\n虚拟机都会尽量避免将缓冲区的内容复制到中间缓冲区中（或从中间缓冲区中复制内容）。\n**直接缓冲区的内容可以驻留在常规的垃圾回收堆之外，不会被GC回收。**\n间接缓冲区与本地操作系统低层次的i/o交互需要一个中间缓冲区来实现，因此性能比直接缓存区要低。\n直接缓冲区通过sun.misc.Unsafe类调用jni本地方法来分配内存。\n因为绕过jvm,因此分配内存的开销较大，并且需要用户自己当成普通资源来主动释放。\n堆外内存的分配\n\n{% codeblock  lang:java   %}\n\n    DirectByteBuffer(int cap) {                   // package-private\n    super(-1, 0, cap, cap);\n    boolean pa = VM.isDirectMemoryPageAligned();\n    int ps = Bits.pageSize();\n    long size = Math.max(1L, (long)cap + (pa ? ps : 0));\n    Bits.reserveMemory(size, cap);\n    long base = 0;\n    try {\n    base = unsafe.allocateMemory(size);\n    } catch (OutOfMemoryError x) {\n    Bits.unreserveMemory(size, cap);\n    throw x;\n    }\n    unsafe.setMemory(base, size, (byte) 0);\n    if (pa && (base % ps != 0)) {\n    // Round up to page boundary\n    address = base + ps - (base & (ps - 1));\n    } else {\n    address = base;\n    }\n    cleaner = Cleaner.create(this, new Deallocator(base, size, cap));\n    att = null;\n    }\n\n{% endcodeblock %}\n\n可以看出通过unsafe.allocateMemory方法来分配堆外内存，同时创建一个对应的Cleaner\nsun.misc.Cleaner.create方法两个参数。\n- 需要监控的堆内存对象，就是堆外内存关联的对象。\n- 程序释放资源的回调。\n\n当JVM进行GC的时候，如果发现我们监控的对象，不存在强引用了，(Cleaner本身是幽灵引用)，\n就会调用预先绑定的回调方法，我们一般在回调方法里面释放堆外内存\n\n{% codeblock  lang:java   %}\n\n    private static class Deallocator\n    implements Runnable\n    {\n    private static Unsafe unsafe = Unsafe.getUnsafe();\n    private long address;\n    private long size;\n    private int capacity;\n    private Deallocator(long address, long size, int capacity) {\n    assert (address != 0);\n    this.address = address;\n    this.size = size;\n    this.capacity = capacity;\n    }\n    public void run() {\n    if (address == 0) {\n    // Paranoia\n    return;\n    }\n    unsafe.freeMemory(address);\n    address = 0;\n    Bits.unreserveMemory(size, capacity);\n    }\n    }\n\n\n{% endcodeblock %}\n\n最终通过unsafe类提供freeMemory来释放之前分配的对外内存。\n**堆外内存大小可以通过jvm启动参数限制： -XX:MaxDirectMemorySize**","slug":"Buffer详解","published":1,"updated":"2023-12-05T02:48:12.722Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdik0001orgo4mt6azim","content":"<h1 id=\"Buffer详解\"><a href=\"#Buffer详解\" class=\"headerlink\" title=\"Buffer详解\"></a>Buffer详解</h1><p>java中的nio由channel,buffer,Selector组成核心API。<br>Buffer是一个继承于object的抽象类,主要有下面几种。</p>\n<ul>\n<li>ByteBuffer</li>\n<li>CharBuffer</li>\n<li>DoubleBuffer</li>\n<li>FloatBuffer</li>\n<li>IntBuffer</li>\n<li>LongBuffer</li>\n<li>ShortBuffer</li>\n</ul>\n<p>基本覆盖了基本类型的支持，看下byteBuffer的实现</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 间接缓冲区</span></span><br><span class=\"line\">ByteBuffer bf1=ByteBuffer.allocate(<span class=\"number\">16</span>);</span><br><span class=\"line\"><span class=\"comment\">// 直接缓冲区</span></span><br><span class=\"line\">ByteBuffer bf2=ByteBuffer.allocateDirect(<span class=\"number\">16</span>);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>ByteBuffer提供两种方式来获取缓存区内存，间接或者直接。<br>字节缓冲区要么是直接的，要么是非直接的。<br>如果为直接字节缓冲区，则 Java 虚拟机会尽最大努力直接在此缓冲区上执行本机 I&#x2F;O 操作。<br>也就是说，在每次调用基础操作系统的一个本机 I&#x2F;O 操作之前（或之后），<br>虚拟机都会尽量避免将缓冲区的内容复制到中间缓冲区中（或从中间缓冲区中复制内容）。<br><strong>直接缓冲区的内容可以驻留在常规的垃圾回收堆之外，不会被GC回收。</strong><br>间接缓冲区与本地操作系统低层次的i&#x2F;o交互需要一个中间缓冲区来实现，因此性能比直接缓存区要低。<br>直接缓冲区通过sun.misc.Unsafe类调用jni本地方法来分配内存。<br>因为绕过jvm,因此分配内存的开销较大，并且需要用户自己当成普通资源来主动释放。<br>堆外内存的分配</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">DirectByteBuffer(<span class=\"type\">int</span> cap) &#123;                   <span class=\"comment\">// package-private</span></span><br><span class=\"line\"><span class=\"built_in\">super</span>(-<span class=\"number\">1</span>, <span class=\"number\">0</span>, cap, cap);</span><br><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"variable\">pa</span> <span class=\"operator\">=</span> VM.isDirectMemoryPageAligned();</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">ps</span> <span class=\"operator\">=</span> Bits.pageSize();</span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"variable\">size</span> <span class=\"operator\">=</span> Math.max(<span class=\"number\">1L</span>, (<span class=\"type\">long</span>)cap + (pa ? ps : <span class=\"number\">0</span>));</span><br><span class=\"line\">Bits.reserveMemory(size, cap);</span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"variable\">base</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">base = unsafe.allocateMemory(size);</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (OutOfMemoryError x) &#123;</span><br><span class=\"line\">Bits.unreserveMemory(size, cap);</span><br><span class=\"line\"><span class=\"keyword\">throw</span> x;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">unsafe.setMemory(base, size, (<span class=\"type\">byte</span>) <span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (pa &amp;&amp; (base % ps != <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\"><span class=\"comment\">// Round up to page boundary</span></span><br><span class=\"line\">address = base + ps - (base &amp; (ps - <span class=\"number\">1</span>));</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">address = base;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">cleaner = Cleaner.create(<span class=\"built_in\">this</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">Deallocator</span>(base, size, cap));</span><br><span class=\"line\">att = <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>可以看出通过unsafe.allocateMemory方法来分配堆外内存，同时创建一个对应的Cleaner<br>sun.misc.Cleaner.create方法两个参数。</p>\n<ul>\n<li>需要监控的堆内存对象，就是堆外内存关联的对象。</li>\n<li>程序释放资源的回调。</li>\n</ul>\n<p>当JVM进行GC的时候，如果发现我们监控的对象，不存在强引用了，(Cleaner本身是幽灵引用)，<br>就会调用预先绑定的回调方法，我们一般在回调方法里面释放堆外内存</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Deallocator</span></span><br><span class=\"line\"><span class=\"keyword\">implements</span> <span class=\"title class_\">Runnable</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">Unsafe</span> <span class=\"variable\">unsafe</span> <span class=\"operator\">=</span> Unsafe.getUnsafe();</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">long</span> address;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">long</span> size;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> capacity;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"title function_\">Deallocator</span><span class=\"params\">(<span class=\"type\">long</span> address, <span class=\"type\">long</span> size, <span class=\"type\">int</span> capacity)</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">assert</span> (address != <span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"built_in\">this</span>.address = address;</span><br><span class=\"line\"><span class=\"built_in\">this</span>.size = size;</span><br><span class=\"line\"><span class=\"built_in\">this</span>.capacity = capacity;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (address == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\"><span class=\"comment\">// Paranoia</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">unsafe.freeMemory(address);</span><br><span class=\"line\">address = <span class=\"number\">0</span>;</span><br><span class=\"line\">Bits.unreserveMemory(size, capacity);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>最终通过unsafe类提供freeMemory来释放之前分配的对外内存。<br><strong>堆外内存大小可以通过jvm启动参数限制： -XX:MaxDirectMemorySize</strong></p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"Buffer详解\"><a href=\"#Buffer详解\" class=\"headerlink\" title=\"Buffer详解\"></a>Buffer详解</h1><p>java中的nio由channel,buffer,Selector组成核心API。<br>Buffer是一个继承于object的抽象类,主要有下面几种。</p>\n<ul>\n<li>ByteBuffer</li>\n<li>CharBuffer</li>\n<li>DoubleBuffer</li>\n<li>FloatBuffer</li>\n<li>IntBuffer</li>\n<li>LongBuffer</li>\n<li>ShortBuffer</li>\n</ul>\n<p>基本覆盖了基本类型的支持，看下byteBuffer的实现</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 间接缓冲区</span></span><br><span class=\"line\">ByteBuffer bf1=ByteBuffer.allocate(<span class=\"number\">16</span>);</span><br><span class=\"line\"><span class=\"comment\">// 直接缓冲区</span></span><br><span class=\"line\">ByteBuffer bf2=ByteBuffer.allocateDirect(<span class=\"number\">16</span>);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>ByteBuffer提供两种方式来获取缓存区内存，间接或者直接。<br>字节缓冲区要么是直接的，要么是非直接的。<br>如果为直接字节缓冲区，则 Java 虚拟机会尽最大努力直接在此缓冲区上执行本机 I&#x2F;O 操作。<br>也就是说，在每次调用基础操作系统的一个本机 I&#x2F;O 操作之前（或之后），<br>虚拟机都会尽量避免将缓冲区的内容复制到中间缓冲区中（或从中间缓冲区中复制内容）。<br><strong>直接缓冲区的内容可以驻留在常规的垃圾回收堆之外，不会被GC回收。</strong><br>间接缓冲区与本地操作系统低层次的i&#x2F;o交互需要一个中间缓冲区来实现，因此性能比直接缓存区要低。<br>直接缓冲区通过sun.misc.Unsafe类调用jni本地方法来分配内存。<br>因为绕过jvm,因此分配内存的开销较大，并且需要用户自己当成普通资源来主动释放。<br>堆外内存的分配</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">DirectByteBuffer(<span class=\"type\">int</span> cap) &#123;                   <span class=\"comment\">// package-private</span></span><br><span class=\"line\"><span class=\"built_in\">super</span>(-<span class=\"number\">1</span>, <span class=\"number\">0</span>, cap, cap);</span><br><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"variable\">pa</span> <span class=\"operator\">=</span> VM.isDirectMemoryPageAligned();</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">ps</span> <span class=\"operator\">=</span> Bits.pageSize();</span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"variable\">size</span> <span class=\"operator\">=</span> Math.max(<span class=\"number\">1L</span>, (<span class=\"type\">long</span>)cap + (pa ? ps : <span class=\"number\">0</span>));</span><br><span class=\"line\">Bits.reserveMemory(size, cap);</span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"variable\">base</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">base = unsafe.allocateMemory(size);</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (OutOfMemoryError x) &#123;</span><br><span class=\"line\">Bits.unreserveMemory(size, cap);</span><br><span class=\"line\"><span class=\"keyword\">throw</span> x;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">unsafe.setMemory(base, size, (<span class=\"type\">byte</span>) <span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (pa &amp;&amp; (base % ps != <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\"><span class=\"comment\">// Round up to page boundary</span></span><br><span class=\"line\">address = base + ps - (base &amp; (ps - <span class=\"number\">1</span>));</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">address = base;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">cleaner = Cleaner.create(<span class=\"built_in\">this</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">Deallocator</span>(base, size, cap));</span><br><span class=\"line\">att = <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>可以看出通过unsafe.allocateMemory方法来分配堆外内存，同时创建一个对应的Cleaner<br>sun.misc.Cleaner.create方法两个参数。</p>\n<ul>\n<li>需要监控的堆内存对象，就是堆外内存关联的对象。</li>\n<li>程序释放资源的回调。</li>\n</ul>\n<p>当JVM进行GC的时候，如果发现我们监控的对象，不存在强引用了，(Cleaner本身是幽灵引用)，<br>就会调用预先绑定的回调方法，我们一般在回调方法里面释放堆外内存</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Deallocator</span></span><br><span class=\"line\"><span class=\"keyword\">implements</span> <span class=\"title class_\">Runnable</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">Unsafe</span> <span class=\"variable\">unsafe</span> <span class=\"operator\">=</span> Unsafe.getUnsafe();</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">long</span> address;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">long</span> size;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"type\">int</span> capacity;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"title function_\">Deallocator</span><span class=\"params\">(<span class=\"type\">long</span> address, <span class=\"type\">long</span> size, <span class=\"type\">int</span> capacity)</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">assert</span> (address != <span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"built_in\">this</span>.address = address;</span><br><span class=\"line\"><span class=\"built_in\">this</span>.size = size;</span><br><span class=\"line\"><span class=\"built_in\">this</span>.capacity = capacity;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (address == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\"><span class=\"comment\">// Paranoia</span></span><br><span class=\"line\"><span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">unsafe.freeMemory(address);</span><br><span class=\"line\">address = <span class=\"number\">0</span>;</span><br><span class=\"line\">Bits.unreserveMemory(size, capacity);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>最终通过unsafe类提供freeMemory来释放之前分配的对外内存。<br><strong>堆外内存大小可以通过jvm启动参数限制： -XX:MaxDirectMemorySize</strong></p>\n"},{"title":"IOC容器设计","abbrlink":63138,"date":"2023-06-20T07:04:16.000Z","_content":"# IOC容器设计\n提供getBean接口，支持依赖注入\n**示例代码地址： https://github.com/ChenXun1989/ioc-framework**\n## IOC容器主要模块\n- ApplicationContext，IOC容器上下文，持有对象Map\n- BeanFactory 每一个类型（class） 对应一BeanFactory，提供获取类实现的接口，属性注入接口\n- CompentScan 收集相关配置信息，主要分xml和注解扫描两种\n\n## IOC容器启动过程\nApplicationContext 创建\n{% codeblock  lang:java   %}\n\n    ApplicationContext context=new ApplicationContext(\"com.chenxun.framework.example.entity\");\n    Student s=(Student) context.getBean(\"student\");\n    s.test();\n\n{% endcodeblock %}\nCompentScan 收集相关配置信息，解析出被ioc容器托管的class集合\n\n{% codeblock  lang:java   %}\n\n    private final List<String > list=new ArrayList<>();\t \n    public void scan(String packageName){\n    String parent=\tSystem.getProperty(\"user.dir\");\n    parent=parent+\"/src/main/java\";\n    System.out.println(parent);\n    String child=packageName.replaceAll(\"\\\\.\", \"/\");\n    File f=new File(parent ,child);\n    for(File c:f.listFiles()){\n    if(c.getName().endsWith(\".java\")){\n    list.add(packageName+\".\"+c.getName().substring(0,c.getName().lastIndexOf(\".\")));\n    }\n    }\n    };\n    public List<String > getList(){\n    return list;\n    }\n\n{% endcodeblock %}\n\n- 创建对应类的BeanFactory\n- BeanFactory通过反射创建默认class默认实例对象\n- 把创建完的对象放入ApplicationContext持有的对象Map\n- 遍历beanFactory的Map，调用setProperties接口来完成依赖注入\n\n{% codeblock  lang:java   %}\n\n    private void init() throws ClassNotFoundException{\n    compentScan.scan(backPackage);\n    for(String clasName:compentScan.getList()){\n    Class cls=Class.forName(clasName);\n    Compent c=(Compent) cls.getAnnotation(Compent.class);\n    if(c!=null){\n    String key=c.value();\t\t\t\n    BeanFactory bf=new SimpleBeanFactory(cls);\n    beanFactorys.put(cls, bf);\n    map.put(key, bf.getBean());\n    }\n    }\n    for(Entry<Class, BeanFactory> entry :beanFactorys.entrySet()){\n    entry.getValue().setProperties(map);\n    }\n    \n    }\n\n{% endcodeblock %}\n\n- 先创建对象，再做依赖注入 \n- 容器里面是原生对象还是代理对象，取决于beanfatory返回的对象实例\n\n","source":"_posts/IOC容器设计.md","raw":"---\ntitle: IOC容器设计\ntags:\n  - 架构设计\nabbrlink: 63138\ndate: 2023-06-20 15:04:16\n---\n# IOC容器设计\n提供getBean接口，支持依赖注入\n**示例代码地址： https://github.com/ChenXun1989/ioc-framework**\n## IOC容器主要模块\n- ApplicationContext，IOC容器上下文，持有对象Map\n- BeanFactory 每一个类型（class） 对应一BeanFactory，提供获取类实现的接口，属性注入接口\n- CompentScan 收集相关配置信息，主要分xml和注解扫描两种\n\n## IOC容器启动过程\nApplicationContext 创建\n{% codeblock  lang:java   %}\n\n    ApplicationContext context=new ApplicationContext(\"com.chenxun.framework.example.entity\");\n    Student s=(Student) context.getBean(\"student\");\n    s.test();\n\n{% endcodeblock %}\nCompentScan 收集相关配置信息，解析出被ioc容器托管的class集合\n\n{% codeblock  lang:java   %}\n\n    private final List<String > list=new ArrayList<>();\t \n    public void scan(String packageName){\n    String parent=\tSystem.getProperty(\"user.dir\");\n    parent=parent+\"/src/main/java\";\n    System.out.println(parent);\n    String child=packageName.replaceAll(\"\\\\.\", \"/\");\n    File f=new File(parent ,child);\n    for(File c:f.listFiles()){\n    if(c.getName().endsWith(\".java\")){\n    list.add(packageName+\".\"+c.getName().substring(0,c.getName().lastIndexOf(\".\")));\n    }\n    }\n    };\n    public List<String > getList(){\n    return list;\n    }\n\n{% endcodeblock %}\n\n- 创建对应类的BeanFactory\n- BeanFactory通过反射创建默认class默认实例对象\n- 把创建完的对象放入ApplicationContext持有的对象Map\n- 遍历beanFactory的Map，调用setProperties接口来完成依赖注入\n\n{% codeblock  lang:java   %}\n\n    private void init() throws ClassNotFoundException{\n    compentScan.scan(backPackage);\n    for(String clasName:compentScan.getList()){\n    Class cls=Class.forName(clasName);\n    Compent c=(Compent) cls.getAnnotation(Compent.class);\n    if(c!=null){\n    String key=c.value();\t\t\t\n    BeanFactory bf=new SimpleBeanFactory(cls);\n    beanFactorys.put(cls, bf);\n    map.put(key, bf.getBean());\n    }\n    }\n    for(Entry<Class, BeanFactory> entry :beanFactorys.entrySet()){\n    entry.getValue().setProperties(map);\n    }\n    \n    }\n\n{% endcodeblock %}\n\n- 先创建对象，再做依赖注入 \n- 容器里面是原生对象还是代理对象，取决于beanfatory返回的对象实例\n\n","slug":"IOC容器设计","published":1,"updated":"2023-12-05T02:48:12.724Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdiq0003orgo7jt2dbs3","content":"<h1 id=\"IOC容器设计\"><a href=\"#IOC容器设计\" class=\"headerlink\" title=\"IOC容器设计\"></a>IOC容器设计</h1><p>提供getBean接口，支持依赖注入<br><strong>示例代码地址： <a href=\"https://github.com/ChenXun1989/ioc-framework\">https://github.com/ChenXun1989/ioc-framework</a></strong></p>\n<h2 id=\"IOC容器主要模块\"><a href=\"#IOC容器主要模块\" class=\"headerlink\" title=\"IOC容器主要模块\"></a>IOC容器主要模块</h2><ul>\n<li>ApplicationContext，IOC容器上下文，持有对象Map</li>\n<li>BeanFactory 每一个类型（class） 对应一BeanFactory，提供获取类实现的接口，属性注入接口</li>\n<li>CompentScan 收集相关配置信息，主要分xml和注解扫描两种</li>\n</ul>\n<h2 id=\"IOC容器启动过程\"><a href=\"#IOC容器启动过程\" class=\"headerlink\" title=\"IOC容器启动过程\"></a>IOC容器启动过程</h2><p>ApplicationContext 创建</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">ApplicationContext context=<span class=\"keyword\">new</span> <span class=\"title class_\">ApplicationContext</span>(<span class=\"string\">&quot;com.chenxun.framework.example.entity&quot;</span>);</span><br><span class=\"line\">Student s=(Student) context.getBean(<span class=\"string\">&quot;student&quot;</span>);</span><br><span class=\"line\">s.test();</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>CompentScan 收集相关配置信息，解析出被ioc容器托管的class集合</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> List&lt;String &gt; list=<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();\t </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">scan</span><span class=\"params\">(String packageName)</span>&#123;</span><br><span class=\"line\">String parent=\tSystem.getProperty(<span class=\"string\">&quot;user.dir&quot;</span>);</span><br><span class=\"line\">parent=parent+<span class=\"string\">&quot;/src/main/java&quot;</span>;</span><br><span class=\"line\">System.out.println(parent);</span><br><span class=\"line\">String child=packageName.replaceAll(<span class=\"string\">&quot;\\\\.&quot;</span>, <span class=\"string\">&quot;/&quot;</span>);</span><br><span class=\"line\">File f=<span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(parent ,child);</span><br><span class=\"line\"><span class=\"keyword\">for</span>(File c:f.listFiles())&#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(c.getName().endsWith(<span class=\"string\">&quot;.java&quot;</span>))&#123;</span><br><span class=\"line\">list.add(packageName+<span class=\"string\">&quot;.&quot;</span>+c.getName().substring(<span class=\"number\">0</span>,c.getName().lastIndexOf(<span class=\"string\">&quot;.&quot;</span>)));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">public</span> List&lt;String &gt; getList()&#123;</span><br><span class=\"line\"><span class=\"keyword\">return</span> list;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>创建对应类的BeanFactory</li>\n<li>BeanFactory通过反射创建默认class默认实例对象</li>\n<li>把创建完的对象放入ApplicationContext持有的对象Map</li>\n<li>遍历beanFactory的Map，调用setProperties接口来完成依赖注入</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">init</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> ClassNotFoundException&#123;</span><br><span class=\"line\">compentScan.scan(backPackage);</span><br><span class=\"line\"><span class=\"keyword\">for</span>(String clasName:compentScan.getList())&#123;</span><br><span class=\"line\">Class cls=Class.forName(clasName);</span><br><span class=\"line\">Compent c=(Compent) cls.getAnnotation(Compent.class);</span><br><span class=\"line\"><span class=\"keyword\">if</span>(c!=<span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">String key=c.value();\t\t\t</span><br><span class=\"line\">BeanFactory bf=<span class=\"keyword\">new</span> <span class=\"title class_\">SimpleBeanFactory</span>(cls);</span><br><span class=\"line\">beanFactorys.put(cls, bf);</span><br><span class=\"line\">map.put(key, bf.getBean());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(Entry&lt;Class, BeanFactory&gt; entry :beanFactorys.entrySet())&#123;</span><br><span class=\"line\">entry.getValue().setProperties(map);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>先创建对象，再做依赖注入 </li>\n<li>容器里面是原生对象还是代理对象，取决于beanfatory返回的对象实例</li>\n</ul>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"IOC容器设计\"><a href=\"#IOC容器设计\" class=\"headerlink\" title=\"IOC容器设计\"></a>IOC容器设计</h1><p>提供getBean接口，支持依赖注入<br><strong>示例代码地址： <a href=\"https://github.com/ChenXun1989/ioc-framework\">https://github.com/ChenXun1989/ioc-framework</a></strong></p>\n<h2 id=\"IOC容器主要模块\"><a href=\"#IOC容器主要模块\" class=\"headerlink\" title=\"IOC容器主要模块\"></a>IOC容器主要模块</h2><ul>\n<li>ApplicationContext，IOC容器上下文，持有对象Map</li>\n<li>BeanFactory 每一个类型（class） 对应一BeanFactory，提供获取类实现的接口，属性注入接口</li>\n<li>CompentScan 收集相关配置信息，主要分xml和注解扫描两种</li>\n</ul>\n<h2 id=\"IOC容器启动过程\"><a href=\"#IOC容器启动过程\" class=\"headerlink\" title=\"IOC容器启动过程\"></a>IOC容器启动过程</h2><p>ApplicationContext 创建</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">ApplicationContext context=<span class=\"keyword\">new</span> <span class=\"title class_\">ApplicationContext</span>(<span class=\"string\">&quot;com.chenxun.framework.example.entity&quot;</span>);</span><br><span class=\"line\">Student s=(Student) context.getBean(<span class=\"string\">&quot;student&quot;</span>);</span><br><span class=\"line\">s.test();</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>CompentScan 收集相关配置信息，解析出被ioc容器托管的class集合</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> List&lt;String &gt; list=<span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();\t </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">scan</span><span class=\"params\">(String packageName)</span>&#123;</span><br><span class=\"line\">String parent=\tSystem.getProperty(<span class=\"string\">&quot;user.dir&quot;</span>);</span><br><span class=\"line\">parent=parent+<span class=\"string\">&quot;/src/main/java&quot;</span>;</span><br><span class=\"line\">System.out.println(parent);</span><br><span class=\"line\">String child=packageName.replaceAll(<span class=\"string\">&quot;\\\\.&quot;</span>, <span class=\"string\">&quot;/&quot;</span>);</span><br><span class=\"line\">File f=<span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(parent ,child);</span><br><span class=\"line\"><span class=\"keyword\">for</span>(File c:f.listFiles())&#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(c.getName().endsWith(<span class=\"string\">&quot;.java&quot;</span>))&#123;</span><br><span class=\"line\">list.add(packageName+<span class=\"string\">&quot;.&quot;</span>+c.getName().substring(<span class=\"number\">0</span>,c.getName().lastIndexOf(<span class=\"string\">&quot;.&quot;</span>)));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">public</span> List&lt;String &gt; getList()&#123;</span><br><span class=\"line\"><span class=\"keyword\">return</span> list;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>创建对应类的BeanFactory</li>\n<li>BeanFactory通过反射创建默认class默认实例对象</li>\n<li>把创建完的对象放入ApplicationContext持有的对象Map</li>\n<li>遍历beanFactory的Map，调用setProperties接口来完成依赖注入</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">init</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> ClassNotFoundException&#123;</span><br><span class=\"line\">compentScan.scan(backPackage);</span><br><span class=\"line\"><span class=\"keyword\">for</span>(String clasName:compentScan.getList())&#123;</span><br><span class=\"line\">Class cls=Class.forName(clasName);</span><br><span class=\"line\">Compent c=(Compent) cls.getAnnotation(Compent.class);</span><br><span class=\"line\"><span class=\"keyword\">if</span>(c!=<span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">String key=c.value();\t\t\t</span><br><span class=\"line\">BeanFactory bf=<span class=\"keyword\">new</span> <span class=\"title class_\">SimpleBeanFactory</span>(cls);</span><br><span class=\"line\">beanFactorys.put(cls, bf);</span><br><span class=\"line\">map.put(key, bf.getBean());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(Entry&lt;Class, BeanFactory&gt; entry :beanFactorys.entrySet())&#123;</span><br><span class=\"line\">entry.getValue().setProperties(map);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>先创建对象，再做依赖注入 </li>\n<li>容器里面是原生对象还是代理对象，取决于beanfatory返回的对象实例</li>\n</ul>\n"},{"title":"JSR-133规范详解","abbrlink":15835,"date":"2023-06-20T07:47:44.000Z","_content":"# JSR-133规范详解\nJSR-133规范,JavaTM内存模型与线程规范.该规范语义不会去描述多线程程序该如何执行。\n而是描述多线程程序允许表现出的行为。\n\n## JVM内存模型和Java内存模型\nJMM来源于JSR-133,主要解决多线程对共享数据的读写一致性问题，\nJVM内存模型则是指JVM的内存分区。两者本身没有关系。\n\n## 共享变量/堆内存（Shared variables/Heap memory）\n能够在线程间共享的内存称作共享内存或堆内存。所有的实例字段，静态字段以及数组元素都存储在堆内存\n中。我们使用变量这个词来表示字段和数组元素。方法中的局部变量永远不会在线程间共享且不会被内存模型影响\n\n\n## 线程间的动作（Inter-thread Actions）\n线程间的动作是由某一线程执行，能被另一线程探测或直接影响的动作（action）。线程间的动作包括共享变量的读写以及同\n步动作（synchronization action），如 lock 或 unlock 某个管程，读写某个 volatile 变量或启动一个线程。\n也包括与外部世界交互的动作。\n\n## 线程内语义（Intra-thread semantics）\n线程内语义是单线程程序的标准语义，基于某个线程内读动作能看到的值，可以完整的预测这个线程的行为。线程内语义决定着某个线程孤立的执行过程；当从堆中读取值时，值是\n由内存模型决定的。\n\n\n## 同步动作（Synchronization Actions）\n\n同步动作包括锁、解锁、读写 volatile 变量，用于启动线程的动作以及用于探测线程是否结束的动作。\n\n## volatile详细解释\njsr133强化了volatile语义，需要有acquire和release语义，对某个volatile字段的写操作happens-before每个后续对该volatile字段的读操作\n\n## jvm具体实现\n\njvm通过内存屏障来保障volatile语义，硬件层面的内存屏障分两种store Barrier和load Barrier,jvm通过两种组合成四种即loadload,\nloadstore,storestore,storeload.\n\n- 对于Load Barrier来说，在指令前插入Load Barrier，可以让高速缓存中的数据失效，强制从新从主内存加载数据\n- 对于Store Barrier来说，在指令后插入Store Barrier，能让写入缓存中的最新数据更新写入主内存，让其他线程可见。\n\n## cpu3级缓存介绍\nCPU缓存的出现主要是为了解决CPU运算速度与内存读写速度不匹配的矛盾，因为CPU运算速度要比内存读写速度快得多。\n导致CPU可能会花费很长时间等待数据到来或把数据写入内存。\n\n{% asset_img 1.png  image %}\n每一级缓存中所存储的数据全部都是下一级缓存中的一部分，这三种缓存的技术难度和制造成本是相对递减的，所以其容量也相对递增。\n当CPU要读取一个数据时，首先从一级缓存中查找，如果没有再从二级缓存中查找，如果还是没有再从三级缓存中或内存中查找。\n\n## lock前缀详细解释\n演示java代码\n\n{% asset_img 2.png  image %}\n\n在新增jvm参数之后可以打印对应的汇编指令\n\n{% codeblock  lang:javascript   %}\n   \n    -server -Xcomp -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly -XX:+LogCompilation -XX:+TraceClassLoading\n\n{% endcodeblock %}\n\n{% asset_img 3.png  image %}\n\njvm并没有采用Barrier指令而是采用了lock addl $0x0,(%rsp)来实际上保障volatile语义。\nlock是一个前缀指令，是和其他指令配合使用 addl $0x0,(%rsp)实际上就是+0，是一个无效指令，配合lock前缀锁定cpu总线（实际上是锁缓存），\nlock后的写操作会回写已修改的数据，同时让其它CPU相关缓存行失效，从而重新从主存中加载最新的数据\n相关资料\nhttps://software.intel.com/sites/default/files/managed/a4/60/325384-sdm-vol-3abcd.pdf 2.85\n\n## MESI协议介绍\n缓存是分段（cache line），每次加载的缓存是定长的，通常是64位。lock其实不是锁总线是是锁定缓存段.\ncpu缓存一致性协议，把cpu缓存行的数据分成4个状态,用2个bit表示\n- Modified 这行数据有效，这行数据修改了，和内存中数据不一致，数据只存在本cache中\n- Exclusive 这行数据有效，数据和内存中一致，数据只存在本cache中\n- Shared 这行数据有效，数据和内存中一致，数据存在很多cache中\n- Invaid 这行数据无效\n\n其中M和E解决独占问题（也就是锁的语义），lock前缀配合一个写操作，整个缓存行的状态会从s->e->m->i->s\n\n## 缓存伪共享和java8优化\n>cpu每次load数据是基于缓存行加载的，如果两个变量公用一个缓存行（一般是相同低bit位地址），就会产生缓存伪共享的问题，只打算更新a变量的只，结果导致b变量也一起更新。\n解决的思路是把a变量独占一行，例如独占64位。Java8中已经提供了官方的解决方案，\nJava8中新增了一个注解@sun.misc.Contended。加上这个注解的类会自动补齐缓存行，需要注意的是此注解默认是无效的，需要在jvm启动时设置-XX:-RestrictContended才会生效。\n\n","source":"_posts/JSR-133规范详解.md","raw":"---\ntitle: JSR-133规范详解\ntags:\n  - java\nabbrlink: 15835\ndate: 2023-06-20 15:47:44\n---\n# JSR-133规范详解\nJSR-133规范,JavaTM内存模型与线程规范.该规范语义不会去描述多线程程序该如何执行。\n而是描述多线程程序允许表现出的行为。\n\n## JVM内存模型和Java内存模型\nJMM来源于JSR-133,主要解决多线程对共享数据的读写一致性问题，\nJVM内存模型则是指JVM的内存分区。两者本身没有关系。\n\n## 共享变量/堆内存（Shared variables/Heap memory）\n能够在线程间共享的内存称作共享内存或堆内存。所有的实例字段，静态字段以及数组元素都存储在堆内存\n中。我们使用变量这个词来表示字段和数组元素。方法中的局部变量永远不会在线程间共享且不会被内存模型影响\n\n\n## 线程间的动作（Inter-thread Actions）\n线程间的动作是由某一线程执行，能被另一线程探测或直接影响的动作（action）。线程间的动作包括共享变量的读写以及同\n步动作（synchronization action），如 lock 或 unlock 某个管程，读写某个 volatile 变量或启动一个线程。\n也包括与外部世界交互的动作。\n\n## 线程内语义（Intra-thread semantics）\n线程内语义是单线程程序的标准语义，基于某个线程内读动作能看到的值，可以完整的预测这个线程的行为。线程内语义决定着某个线程孤立的执行过程；当从堆中读取值时，值是\n由内存模型决定的。\n\n\n## 同步动作（Synchronization Actions）\n\n同步动作包括锁、解锁、读写 volatile 变量，用于启动线程的动作以及用于探测线程是否结束的动作。\n\n## volatile详细解释\njsr133强化了volatile语义，需要有acquire和release语义，对某个volatile字段的写操作happens-before每个后续对该volatile字段的读操作\n\n## jvm具体实现\n\njvm通过内存屏障来保障volatile语义，硬件层面的内存屏障分两种store Barrier和load Barrier,jvm通过两种组合成四种即loadload,\nloadstore,storestore,storeload.\n\n- 对于Load Barrier来说，在指令前插入Load Barrier，可以让高速缓存中的数据失效，强制从新从主内存加载数据\n- 对于Store Barrier来说，在指令后插入Store Barrier，能让写入缓存中的最新数据更新写入主内存，让其他线程可见。\n\n## cpu3级缓存介绍\nCPU缓存的出现主要是为了解决CPU运算速度与内存读写速度不匹配的矛盾，因为CPU运算速度要比内存读写速度快得多。\n导致CPU可能会花费很长时间等待数据到来或把数据写入内存。\n\n{% asset_img 1.png  image %}\n每一级缓存中所存储的数据全部都是下一级缓存中的一部分，这三种缓存的技术难度和制造成本是相对递减的，所以其容量也相对递增。\n当CPU要读取一个数据时，首先从一级缓存中查找，如果没有再从二级缓存中查找，如果还是没有再从三级缓存中或内存中查找。\n\n## lock前缀详细解释\n演示java代码\n\n{% asset_img 2.png  image %}\n\n在新增jvm参数之后可以打印对应的汇编指令\n\n{% codeblock  lang:javascript   %}\n   \n    -server -Xcomp -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly -XX:+LogCompilation -XX:+TraceClassLoading\n\n{% endcodeblock %}\n\n{% asset_img 3.png  image %}\n\njvm并没有采用Barrier指令而是采用了lock addl $0x0,(%rsp)来实际上保障volatile语义。\nlock是一个前缀指令，是和其他指令配合使用 addl $0x0,(%rsp)实际上就是+0，是一个无效指令，配合lock前缀锁定cpu总线（实际上是锁缓存），\nlock后的写操作会回写已修改的数据，同时让其它CPU相关缓存行失效，从而重新从主存中加载最新的数据\n相关资料\nhttps://software.intel.com/sites/default/files/managed/a4/60/325384-sdm-vol-3abcd.pdf 2.85\n\n## MESI协议介绍\n缓存是分段（cache line），每次加载的缓存是定长的，通常是64位。lock其实不是锁总线是是锁定缓存段.\ncpu缓存一致性协议，把cpu缓存行的数据分成4个状态,用2个bit表示\n- Modified 这行数据有效，这行数据修改了，和内存中数据不一致，数据只存在本cache中\n- Exclusive 这行数据有效，数据和内存中一致，数据只存在本cache中\n- Shared 这行数据有效，数据和内存中一致，数据存在很多cache中\n- Invaid 这行数据无效\n\n其中M和E解决独占问题（也就是锁的语义），lock前缀配合一个写操作，整个缓存行的状态会从s->e->m->i->s\n\n## 缓存伪共享和java8优化\n>cpu每次load数据是基于缓存行加载的，如果两个变量公用一个缓存行（一般是相同低bit位地址），就会产生缓存伪共享的问题，只打算更新a变量的只，结果导致b变量也一起更新。\n解决的思路是把a变量独占一行，例如独占64位。Java8中已经提供了官方的解决方案，\nJava8中新增了一个注解@sun.misc.Contended。加上这个注解的类会自动补齐缓存行，需要注意的是此注解默认是无效的，需要在jvm启动时设置-XX:-RestrictContended才会生效。\n\n","slug":"JSR-133规范详解","published":1,"updated":"2023-12-05T02:48:12.725Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdit0006orgocebtd5gl","content":"<h1 id=\"JSR-133规范详解\"><a href=\"#JSR-133规范详解\" class=\"headerlink\" title=\"JSR-133规范详解\"></a>JSR-133规范详解</h1><p>JSR-133规范,JavaTM内存模型与线程规范.该规范语义不会去描述多线程程序该如何执行。<br>而是描述多线程程序允许表现出的行为。</p>\n<h2 id=\"JVM内存模型和Java内存模型\"><a href=\"#JVM内存模型和Java内存模型\" class=\"headerlink\" title=\"JVM内存模型和Java内存模型\"></a>JVM内存模型和Java内存模型</h2><p>JMM来源于JSR-133,主要解决多线程对共享数据的读写一致性问题，<br>JVM内存模型则是指JVM的内存分区。两者本身没有关系。</p>\n<h2 id=\"共享变量-x2F-堆内存（Shared-variables-x2F-Heap-memory）\"><a href=\"#共享变量-x2F-堆内存（Shared-variables-x2F-Heap-memory）\" class=\"headerlink\" title=\"共享变量&#x2F;堆内存（Shared variables&#x2F;Heap memory）\"></a>共享变量&#x2F;堆内存（Shared variables&#x2F;Heap memory）</h2><p>能够在线程间共享的内存称作共享内存或堆内存。所有的实例字段，静态字段以及数组元素都存储在堆内存<br>中。我们使用变量这个词来表示字段和数组元素。方法中的局部变量永远不会在线程间共享且不会被内存模型影响</p>\n<h2 id=\"线程间的动作（Inter-thread-Actions）\"><a href=\"#线程间的动作（Inter-thread-Actions）\" class=\"headerlink\" title=\"线程间的动作（Inter-thread Actions）\"></a>线程间的动作（Inter-thread Actions）</h2><p>线程间的动作是由某一线程执行，能被另一线程探测或直接影响的动作（action）。线程间的动作包括共享变量的读写以及同<br>步动作（synchronization action），如 lock 或 unlock 某个管程，读写某个 volatile 变量或启动一个线程。<br>也包括与外部世界交互的动作。</p>\n<h2 id=\"线程内语义（Intra-thread-semantics）\"><a href=\"#线程内语义（Intra-thread-semantics）\" class=\"headerlink\" title=\"线程内语义（Intra-thread semantics）\"></a>线程内语义（Intra-thread semantics）</h2><p>线程内语义是单线程程序的标准语义，基于某个线程内读动作能看到的值，可以完整的预测这个线程的行为。线程内语义决定着某个线程孤立的执行过程；当从堆中读取值时，值是<br>由内存模型决定的。</p>\n<h2 id=\"同步动作（Synchronization-Actions）\"><a href=\"#同步动作（Synchronization-Actions）\" class=\"headerlink\" title=\"同步动作（Synchronization Actions）\"></a>同步动作（Synchronization Actions）</h2><p>同步动作包括锁、解锁、读写 volatile 变量，用于启动线程的动作以及用于探测线程是否结束的动作。</p>\n<h2 id=\"volatile详细解释\"><a href=\"#volatile详细解释\" class=\"headerlink\" title=\"volatile详细解释\"></a>volatile详细解释</h2><p>jsr133强化了volatile语义，需要有acquire和release语义，对某个volatile字段的写操作happens-before每个后续对该volatile字段的读操作</p>\n<h2 id=\"jvm具体实现\"><a href=\"#jvm具体实现\" class=\"headerlink\" title=\"jvm具体实现\"></a>jvm具体实现</h2><p>jvm通过内存屏障来保障volatile语义，硬件层面的内存屏障分两种store Barrier和load Barrier,jvm通过两种组合成四种即loadload,<br>loadstore,storestore,storeload.</p>\n<ul>\n<li>对于Load Barrier来说，在指令前插入Load Barrier，可以让高速缓存中的数据失效，强制从新从主内存加载数据</li>\n<li>对于Store Barrier来说，在指令后插入Store Barrier，能让写入缓存中的最新数据更新写入主内存，让其他线程可见。</li>\n</ul>\n<h2 id=\"cpu3级缓存介绍\"><a href=\"#cpu3级缓存介绍\" class=\"headerlink\" title=\"cpu3级缓存介绍\"></a>cpu3级缓存介绍</h2><p>CPU缓存的出现主要是为了解决CPU运算速度与内存读写速度不匹配的矛盾，因为CPU运算速度要比内存读写速度快得多。<br>导致CPU可能会花费很长时间等待数据到来或把数据写入内存。</p>\n<img src=\"/2023062015835/1.png\" class=\"\" title=\"image\">\n<p>每一级缓存中所存储的数据全部都是下一级缓存中的一部分，这三种缓存的技术难度和制造成本是相对递减的，所以其容量也相对递增。<br>当CPU要读取一个数据时，首先从一级缓存中查找，如果没有再从二级缓存中查找，如果还是没有再从三级缓存中或内存中查找。</p>\n<h2 id=\"lock前缀详细解释\"><a href=\"#lock前缀详细解释\" class=\"headerlink\" title=\"lock前缀详细解释\"></a>lock前缀详细解释</h2><p>演示java代码</p>\n<img src=\"/2023062015835/2.png\" class=\"\" title=\"image\">\n\n<p>在新增jvm参数之后可以打印对应的汇编指令</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   </span><br><span class=\"line\">-server -<span class=\"title class_\">Xcomp</span> -<span class=\"attr\">XX</span>:+<span class=\"title class_\">UnlockDiagnosticVMOptions</span> -<span class=\"attr\">XX</span>:+<span class=\"title class_\">PrintAssembly</span> -<span class=\"attr\">XX</span>:+<span class=\"title class_\">LogCompilation</span> -<span class=\"attr\">XX</span>:+<span class=\"title class_\">TraceClassLoading</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<img src=\"/2023062015835/3.png\" class=\"\" title=\"image\">\n\n<p>jvm并没有采用Barrier指令而是采用了lock addl $0x0,(%rsp)来实际上保障volatile语义。<br>lock是一个前缀指令，是和其他指令配合使用 addl $0x0,(%rsp)实际上就是+0，是一个无效指令，配合lock前缀锁定cpu总线（实际上是锁缓存），<br>lock后的写操作会回写已修改的数据，同时让其它CPU相关缓存行失效，从而重新从主存中加载最新的数据<br>相关资料<br><a href=\"https://software.intel.com/sites/default/files/managed/a4/60/325384-sdm-vol-3abcd.pdf\">https://software.intel.com/sites/default/files/managed/a4/60/325384-sdm-vol-3abcd.pdf</a> 2.85</p>\n<h2 id=\"MESI协议介绍\"><a href=\"#MESI协议介绍\" class=\"headerlink\" title=\"MESI协议介绍\"></a>MESI协议介绍</h2><p>缓存是分段（cache line），每次加载的缓存是定长的，通常是64位。lock其实不是锁总线是是锁定缓存段.<br>cpu缓存一致性协议，把cpu缓存行的数据分成4个状态,用2个bit表示</p>\n<ul>\n<li>Modified 这行数据有效，这行数据修改了，和内存中数据不一致，数据只存在本cache中</li>\n<li>Exclusive 这行数据有效，数据和内存中一致，数据只存在本cache中</li>\n<li>Shared 这行数据有效，数据和内存中一致，数据存在很多cache中</li>\n<li>Invaid 这行数据无效</li>\n</ul>\n<p>其中M和E解决独占问题（也就是锁的语义），lock前缀配合一个写操作，整个缓存行的状态会从s-&gt;e-&gt;m-&gt;i-&gt;s</p>\n<h2 id=\"缓存伪共享和java8优化\"><a href=\"#缓存伪共享和java8优化\" class=\"headerlink\" title=\"缓存伪共享和java8优化\"></a>缓存伪共享和java8优化</h2><blockquote>\n<p>cpu每次load数据是基于缓存行加载的，如果两个变量公用一个缓存行（一般是相同低bit位地址），就会产生缓存伪共享的问题，只打算更新a变量的只，结果导致b变量也一起更新。<br>解决的思路是把a变量独占一行，例如独占64位。Java8中已经提供了官方的解决方案，<br>Java8中新增了一个注解@sun.misc.Contended。加上这个注解的类会自动补齐缓存行，需要注意的是此注解默认是无效的，需要在jvm启动时设置-XX:-RestrictContended才会生效。</p>\n</blockquote>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"JSR-133规范详解\"><a href=\"#JSR-133规范详解\" class=\"headerlink\" title=\"JSR-133规范详解\"></a>JSR-133规范详解</h1><p>JSR-133规范,JavaTM内存模型与线程规范.该规范语义不会去描述多线程程序该如何执行。<br>而是描述多线程程序允许表现出的行为。</p>\n<h2 id=\"JVM内存模型和Java内存模型\"><a href=\"#JVM内存模型和Java内存模型\" class=\"headerlink\" title=\"JVM内存模型和Java内存模型\"></a>JVM内存模型和Java内存模型</h2><p>JMM来源于JSR-133,主要解决多线程对共享数据的读写一致性问题，<br>JVM内存模型则是指JVM的内存分区。两者本身没有关系。</p>\n<h2 id=\"共享变量-x2F-堆内存（Shared-variables-x2F-Heap-memory）\"><a href=\"#共享变量-x2F-堆内存（Shared-variables-x2F-Heap-memory）\" class=\"headerlink\" title=\"共享变量&#x2F;堆内存（Shared variables&#x2F;Heap memory）\"></a>共享变量&#x2F;堆内存（Shared variables&#x2F;Heap memory）</h2><p>能够在线程间共享的内存称作共享内存或堆内存。所有的实例字段，静态字段以及数组元素都存储在堆内存<br>中。我们使用变量这个词来表示字段和数组元素。方法中的局部变量永远不会在线程间共享且不会被内存模型影响</p>\n<h2 id=\"线程间的动作（Inter-thread-Actions）\"><a href=\"#线程间的动作（Inter-thread-Actions）\" class=\"headerlink\" title=\"线程间的动作（Inter-thread Actions）\"></a>线程间的动作（Inter-thread Actions）</h2><p>线程间的动作是由某一线程执行，能被另一线程探测或直接影响的动作（action）。线程间的动作包括共享变量的读写以及同<br>步动作（synchronization action），如 lock 或 unlock 某个管程，读写某个 volatile 变量或启动一个线程。<br>也包括与外部世界交互的动作。</p>\n<h2 id=\"线程内语义（Intra-thread-semantics）\"><a href=\"#线程内语义（Intra-thread-semantics）\" class=\"headerlink\" title=\"线程内语义（Intra-thread semantics）\"></a>线程内语义（Intra-thread semantics）</h2><p>线程内语义是单线程程序的标准语义，基于某个线程内读动作能看到的值，可以完整的预测这个线程的行为。线程内语义决定着某个线程孤立的执行过程；当从堆中读取值时，值是<br>由内存模型决定的。</p>\n<h2 id=\"同步动作（Synchronization-Actions）\"><a href=\"#同步动作（Synchronization-Actions）\" class=\"headerlink\" title=\"同步动作（Synchronization Actions）\"></a>同步动作（Synchronization Actions）</h2><p>同步动作包括锁、解锁、读写 volatile 变量，用于启动线程的动作以及用于探测线程是否结束的动作。</p>\n<h2 id=\"volatile详细解释\"><a href=\"#volatile详细解释\" class=\"headerlink\" title=\"volatile详细解释\"></a>volatile详细解释</h2><p>jsr133强化了volatile语义，需要有acquire和release语义，对某个volatile字段的写操作happens-before每个后续对该volatile字段的读操作</p>\n<h2 id=\"jvm具体实现\"><a href=\"#jvm具体实现\" class=\"headerlink\" title=\"jvm具体实现\"></a>jvm具体实现</h2><p>jvm通过内存屏障来保障volatile语义，硬件层面的内存屏障分两种store Barrier和load Barrier,jvm通过两种组合成四种即loadload,<br>loadstore,storestore,storeload.</p>\n<ul>\n<li>对于Load Barrier来说，在指令前插入Load Barrier，可以让高速缓存中的数据失效，强制从新从主内存加载数据</li>\n<li>对于Store Barrier来说，在指令后插入Store Barrier，能让写入缓存中的最新数据更新写入主内存，让其他线程可见。</li>\n</ul>\n<h2 id=\"cpu3级缓存介绍\"><a href=\"#cpu3级缓存介绍\" class=\"headerlink\" title=\"cpu3级缓存介绍\"></a>cpu3级缓存介绍</h2><p>CPU缓存的出现主要是为了解决CPU运算速度与内存读写速度不匹配的矛盾，因为CPU运算速度要比内存读写速度快得多。<br>导致CPU可能会花费很长时间等待数据到来或把数据写入内存。</p>\n<img src=\"/2023062015835/1.png\" class=\"\" title=\"image\">\n<p>每一级缓存中所存储的数据全部都是下一级缓存中的一部分，这三种缓存的技术难度和制造成本是相对递减的，所以其容量也相对递增。<br>当CPU要读取一个数据时，首先从一级缓存中查找，如果没有再从二级缓存中查找，如果还是没有再从三级缓存中或内存中查找。</p>\n<h2 id=\"lock前缀详细解释\"><a href=\"#lock前缀详细解释\" class=\"headerlink\" title=\"lock前缀详细解释\"></a>lock前缀详细解释</h2><p>演示java代码</p>\n<img src=\"/2023062015835/2.png\" class=\"\" title=\"image\">\n\n<p>在新增jvm参数之后可以打印对应的汇编指令</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   </span><br><span class=\"line\">-server -<span class=\"title class_\">Xcomp</span> -<span class=\"attr\">XX</span>:+<span class=\"title class_\">UnlockDiagnosticVMOptions</span> -<span class=\"attr\">XX</span>:+<span class=\"title class_\">PrintAssembly</span> -<span class=\"attr\">XX</span>:+<span class=\"title class_\">LogCompilation</span> -<span class=\"attr\">XX</span>:+<span class=\"title class_\">TraceClassLoading</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<img src=\"/2023062015835/3.png\" class=\"\" title=\"image\">\n\n<p>jvm并没有采用Barrier指令而是采用了lock addl $0x0,(%rsp)来实际上保障volatile语义。<br>lock是一个前缀指令，是和其他指令配合使用 addl $0x0,(%rsp)实际上就是+0，是一个无效指令，配合lock前缀锁定cpu总线（实际上是锁缓存），<br>lock后的写操作会回写已修改的数据，同时让其它CPU相关缓存行失效，从而重新从主存中加载最新的数据<br>相关资料<br><a href=\"https://software.intel.com/sites/default/files/managed/a4/60/325384-sdm-vol-3abcd.pdf\">https://software.intel.com/sites/default/files/managed/a4/60/325384-sdm-vol-3abcd.pdf</a> 2.85</p>\n<h2 id=\"MESI协议介绍\"><a href=\"#MESI协议介绍\" class=\"headerlink\" title=\"MESI协议介绍\"></a>MESI协议介绍</h2><p>缓存是分段（cache line），每次加载的缓存是定长的，通常是64位。lock其实不是锁总线是是锁定缓存段.<br>cpu缓存一致性协议，把cpu缓存行的数据分成4个状态,用2个bit表示</p>\n<ul>\n<li>Modified 这行数据有效，这行数据修改了，和内存中数据不一致，数据只存在本cache中</li>\n<li>Exclusive 这行数据有效，数据和内存中一致，数据只存在本cache中</li>\n<li>Shared 这行数据有效，数据和内存中一致，数据存在很多cache中</li>\n<li>Invaid 这行数据无效</li>\n</ul>\n<p>其中M和E解决独占问题（也就是锁的语义），lock前缀配合一个写操作，整个缓存行的状态会从s-&gt;e-&gt;m-&gt;i-&gt;s</p>\n<h2 id=\"缓存伪共享和java8优化\"><a href=\"#缓存伪共享和java8优化\" class=\"headerlink\" title=\"缓存伪共享和java8优化\"></a>缓存伪共享和java8优化</h2><blockquote>\n<p>cpu每次load数据是基于缓存行加载的，如果两个变量公用一个缓存行（一般是相同低bit位地址），就会产生缓存伪共享的问题，只打算更新a变量的只，结果导致b变量也一起更新。<br>解决的思路是把a变量独占一行，例如独占64位。Java8中已经提供了官方的解决方案，<br>Java8中新增了一个注解@sun.misc.Contended。加上这个注解的类会自动补齐缓存行，需要注意的是此注解默认是无效的，需要在jvm启动时设置-XX:-RestrictContended才会生效。</p>\n</blockquote>\n"},{"title":"RPC框架设计","abbrlink":59976,"date":"2023-06-20T07:08:31.000Z","_content":"# RPC框架设计\nRPC（Remote Procedure Call Protocol）——远程过程调用协议，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议。\nRPC协议假定某些传输协议的存在，如TCP或UDP，为通信程序之间携带信息数据。在OSI网络通信模型中，RPC跨越了传输层和应用层。RPC使得开发包括网络分布式多程序在内的应用程序更加容易。\n**代码地址：https://github.com/ChenXun1989/netty-rpc**\n\n## 透明化RPC\n一个RPC服务调用有以下几个步骤\n1. 服务消费方（client）调用以本地调用方式调用服务\n2. client stub接收到调用后负责将方法、参数等组装成能够进行网络传输的消息体\n3. client stub找到服务地址，并将消息发送到服务端\n4. server stub收到消息后进行解码\n5. server stub根据解码结果调用本地的服务\n6. 本地服务执行并将结果返回给server stub\n7. server stub将返回结果打包成消息并发送至消费方\n8. client stub接收到消息，并进行解码\n9. 服务消费方得到最终结果\n\n**透明的RPC测试把2-8步骤全部封装起来，消费方只需要执行第一个步骤，并等待返回结果就行。**\n\n透明化RPC具体调用过程\n{% asset_img 1.png  image %}\n## 注意要点\n- 动态代理（客户端） 主要实现有两种JDK动态代理和cglib\n- reqeust对象 主要包含 服务方法签名和参数\n- repsone对象 主要包含服务方法处理结果和异常\n- 序列化和反序列化 主要在 reqeust和respone对象，该demo采用protobuf实现\n- socket通讯 该demo采用netty4实现。\n\n","source":"_posts/RPC框架设计.md","raw":"---\ntitle: RPC框架设计\ntags:\n  - 架构设计\nabbrlink: 59976\ndate: 2023-06-20 15:08:31\n---\n# RPC框架设计\nRPC（Remote Procedure Call Protocol）——远程过程调用协议，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议。\nRPC协议假定某些传输协议的存在，如TCP或UDP，为通信程序之间携带信息数据。在OSI网络通信模型中，RPC跨越了传输层和应用层。RPC使得开发包括网络分布式多程序在内的应用程序更加容易。\n**代码地址：https://github.com/ChenXun1989/netty-rpc**\n\n## 透明化RPC\n一个RPC服务调用有以下几个步骤\n1. 服务消费方（client）调用以本地调用方式调用服务\n2. client stub接收到调用后负责将方法、参数等组装成能够进行网络传输的消息体\n3. client stub找到服务地址，并将消息发送到服务端\n4. server stub收到消息后进行解码\n5. server stub根据解码结果调用本地的服务\n6. 本地服务执行并将结果返回给server stub\n7. server stub将返回结果打包成消息并发送至消费方\n8. client stub接收到消息，并进行解码\n9. 服务消费方得到最终结果\n\n**透明的RPC测试把2-8步骤全部封装起来，消费方只需要执行第一个步骤，并等待返回结果就行。**\n\n透明化RPC具体调用过程\n{% asset_img 1.png  image %}\n## 注意要点\n- 动态代理（客户端） 主要实现有两种JDK动态代理和cglib\n- reqeust对象 主要包含 服务方法签名和参数\n- repsone对象 主要包含服务方法处理结果和异常\n- 序列化和反序列化 主要在 reqeust和respone对象，该demo采用protobuf实现\n- socket通讯 该demo采用netty4实现。\n\n","slug":"RPC框架设计","published":1,"updated":"2023-12-05T02:48:12.725Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdiu0008orgo9jz6grrm","content":"<h1 id=\"RPC框架设计\"><a href=\"#RPC框架设计\" class=\"headerlink\" title=\"RPC框架设计\"></a>RPC框架设计</h1><p>RPC（Remote Procedure Call Protocol）——远程过程调用协议，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议。<br>RPC协议假定某些传输协议的存在，如TCP或UDP，为通信程序之间携带信息数据。在OSI网络通信模型中，RPC跨越了传输层和应用层。RPC使得开发包括网络分布式多程序在内的应用程序更加容易。<br><strong>代码地址：<a href=\"https://github.com/ChenXun1989/netty-rpc\">https://github.com/ChenXun1989/netty-rpc</a></strong></p>\n<h2 id=\"透明化RPC\"><a href=\"#透明化RPC\" class=\"headerlink\" title=\"透明化RPC\"></a>透明化RPC</h2><p>一个RPC服务调用有以下几个步骤</p>\n<ol>\n<li>服务消费方（client）调用以本地调用方式调用服务</li>\n<li>client stub接收到调用后负责将方法、参数等组装成能够进行网络传输的消息体</li>\n<li>client stub找到服务地址，并将消息发送到服务端</li>\n<li>server stub收到消息后进行解码</li>\n<li>server stub根据解码结果调用本地的服务</li>\n<li>本地服务执行并将结果返回给server stub</li>\n<li>server stub将返回结果打包成消息并发送至消费方</li>\n<li>client stub接收到消息，并进行解码</li>\n<li>服务消费方得到最终结果</li>\n</ol>\n<p><strong>透明的RPC测试把2-8步骤全部封装起来，消费方只需要执行第一个步骤，并等待返回结果就行。</strong></p>\n<p>透明化RPC具体调用过程</p>\n<img src=\"/2023062059976/1.png\" class=\"\" title=\"image\">\n<h2 id=\"注意要点\"><a href=\"#注意要点\" class=\"headerlink\" title=\"注意要点\"></a>注意要点</h2><ul>\n<li>动态代理（客户端） 主要实现有两种JDK动态代理和cglib</li>\n<li>reqeust对象 主要包含 服务方法签名和参数</li>\n<li>repsone对象 主要包含服务方法处理结果和异常</li>\n<li>序列化和反序列化 主要在 reqeust和respone对象，该demo采用protobuf实现</li>\n<li>socket通讯 该demo采用netty4实现。</li>\n</ul>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"RPC框架设计\"><a href=\"#RPC框架设计\" class=\"headerlink\" title=\"RPC框架设计\"></a>RPC框架设计</h1><p>RPC（Remote Procedure Call Protocol）——远程过程调用协议，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议。<br>RPC协议假定某些传输协议的存在，如TCP或UDP，为通信程序之间携带信息数据。在OSI网络通信模型中，RPC跨越了传输层和应用层。RPC使得开发包括网络分布式多程序在内的应用程序更加容易。<br><strong>代码地址：<a href=\"https://github.com/ChenXun1989/netty-rpc\">https://github.com/ChenXun1989/netty-rpc</a></strong></p>\n<h2 id=\"透明化RPC\"><a href=\"#透明化RPC\" class=\"headerlink\" title=\"透明化RPC\"></a>透明化RPC</h2><p>一个RPC服务调用有以下几个步骤</p>\n<ol>\n<li>服务消费方（client）调用以本地调用方式调用服务</li>\n<li>client stub接收到调用后负责将方法、参数等组装成能够进行网络传输的消息体</li>\n<li>client stub找到服务地址，并将消息发送到服务端</li>\n<li>server stub收到消息后进行解码</li>\n<li>server stub根据解码结果调用本地的服务</li>\n<li>本地服务执行并将结果返回给server stub</li>\n<li>server stub将返回结果打包成消息并发送至消费方</li>\n<li>client stub接收到消息，并进行解码</li>\n<li>服务消费方得到最终结果</li>\n</ol>\n<p><strong>透明的RPC测试把2-8步骤全部封装起来，消费方只需要执行第一个步骤，并等待返回结果就行。</strong></p>\n<p>透明化RPC具体调用过程</p>\n<img src=\"/2023062059976/1.png\" class=\"\" title=\"image\">\n<h2 id=\"注意要点\"><a href=\"#注意要点\" class=\"headerlink\" title=\"注意要点\"></a>注意要点</h2><ul>\n<li>动态代理（客户端） 主要实现有两种JDK动态代理和cglib</li>\n<li>reqeust对象 主要包含 服务方法签名和参数</li>\n<li>repsone对象 主要包含服务方法处理结果和异常</li>\n<li>序列化和反序列化 主要在 reqeust和respone对象，该demo采用protobuf实现</li>\n<li>socket通讯 该demo采用netty4实现。</li>\n</ul>\n"},{"title":"class装载","abbrlink":34905,"date":"2023-06-20T07:18:35.000Z","_content":"# class装载\n\n**示例代码链接 https://github.com/ChenXun1989/study-example**\n\n演示demo\n\n{% codeblock  lang:java   %}\n\n    public class TestClassLoader {\n    public static void main(String[] args) {\n    ClassLoader myClassLoader = new ClassLoader() {};\n    try {\n    Class cls = myClassLoader.loadClass(TestClassLoader.class.getName());\n    System.out.println(myClassLoader.getParent());\n    System.out.println(cls.getClassLoader());\n    } catch (ClassNotFoundException e) {\n    e.printStackTrace();\n    }\n    }\n    }\n\n\n{% endcodeblock %}\n\n输出结果：\n\n{% codeblock  lang:java   %}\n\n    sun.misc.Launcher$AppClassLoader@18b4aac2\n    sun.misc.Launcher$AppClassLoader@18b4aac2\n{% endcodeblock %}\n\n从结果上我们可以得出以下两个结论\n1. 自定义的classloader的parent默认为AppClassLoader\n2. 当classloader加载某个class的时候会委托给parent（父加载器）加载\n\n## 双亲委托细节\n双亲委派模型的工作过程是：如果一个类加载器收到了类加载的请求，他首先不会自己去尝试加载这个类，\n而是把这个请求委派父类加载器去完成。每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，\n只有当父加载器反馈自己无法完成这个请求（他的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去加载。\n\n双亲委托是如何实现的呢？秘密就在loadClass 这个方法\n\n双亲委派模型的工作过程是：如果一个类加载器收到了类加载的请求，他首先不会自己去尝试加载这个类，\n而是把这个请求委派父类加载器去完成。每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，\n只有当父加载器反馈自己无法完成这个请求（他的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去加载。\n\n双亲委托是如何实现的呢？秘密就在loadClass 这个方法\n\n{% codeblock  lang:java   %}\n\n    protected Class<?> loadClass(String name, boolean resolve)\n        throws ClassNotFoundException\n    {\n        synchronized (getClassLoadingLock(name)) {\n            // First, check if the class has already been loaded\n            Class<?> c = findLoadedClass(name);\n    if (c == null) {\n    long t0 = System.nanoTime();\n    try {\n    if (parent != null) {\n    c = parent.loadClass(name, false);\n    } else {\n    c = findBootstrapClassOrNull(name);\n    }\n    } catch (ClassNotFoundException e) {\n    // ClassNotFoundException thrown if class not found\n    // from the non-null parent class loader\n    }\n\n            if (c == null) {\n                // If still not found, then invoke findClass in order\n                // to find the class.\n                long t1 = System.nanoTime();\n                c = findClass(name);\n      \n                // this is the defining class loader; record the stats\n                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);\n                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);\n                sun.misc.PerfCounter.getFindClasses().increment();\n            }\n        }\n        if (resolve) {\n            resolveClass(c);\n        }\n        return c;\n    }\n    }\n\n\n{% endcodeblock %}\n\n从code上得出结论如果没有知道class,会先通过父加载起去加载，一直递归上去，如果没有父加载器直接通过bootstrap加载器加载\n大致流程如下： 用户自定义的classlaoder – AppClassLoader —ExtClassLoader – bootStrapClassLoader\n\n{% asset_img 1.png  image %}\n\n这么做有什么好处？\n\n>如果没有使用双亲委派模型，由各个类加载器自行加载的话，如果用户自己编写了一个称为java.lang.Object的类，\n并放在程序的ClassPath中，那系统将会出现多个不同的Object类， Java类型体系中最基础的行为就无法保证。应用程序也将会变得一片混乱\n\n## 如何破坏双亲委托\n双亲委托并不是一个强制约束，只是一种大家都遵守规范，但有些场景会破坏双亲委托（例如SPI）\n\n{% codeblock  lang:java   %}\n\n    public static void  test2(){  \n    ServiceLoader<SPITest> loaders= ServiceLoader.load(SPITest.class);\n    loaders.forEach(i->{\n    i.test();\n    });\n    }\n{% endcodeblock %}\n\n准确的说spi没有破坏双亲委托，只是绕过了双亲委托获取class，委托机制上层（例如bootstrapClassloader）通过Thread.currentThread().getContextClassLoader()来获取\n委托机制里面下层（例如AppClassLoader）加载的类。具体code如下：\n\n{% codeblock  lang:java   %}\n\n    public static <S> ServiceLoader<S> load(Class<S> service) {\n    ClassLoader cl = Thread.currentThread().getContextClassLoader();\n    return ServiceLoader.load(service, cl);\n    }\n\n{% endcodeblock %}\n\n这样做是为了解决一些 上层类依赖下层类的情况，比如jdbc，jdbc相关的类文件在rt.jar中，但是driver对应的实现类是放在我们应用的jar的lib里面，\n这样 extClassLoader 就加载不到，但是通过spi机制，rt.jar包中的jdbc相关类就能获取由AppClassLoader 加载的jdbc具体的driver了。\n上面讲到 双亲委托机制是通过loaderclass这个方法来实现的，如果我们自定义的classloader覆盖改方法（或者覆盖findClass），就能强行破坏，例如osgi.\n在jvm里面每个class的唯一标识符由 classloader全名+class全名构成，因此假设两个独立的classloader，加载一样的class，jvm也会认为是两个独立的class，\ntomcat就是此机制来实现webapp目录下不同的web应用的隔离\n\n","source":"_posts/class装载.md","raw":"---\ntitle: class装载\ntags:\n  - java源码\nabbrlink: 34905\ndate: 2023-06-20 15:18:35\n---\n# class装载\n\n**示例代码链接 https://github.com/ChenXun1989/study-example**\n\n演示demo\n\n{% codeblock  lang:java   %}\n\n    public class TestClassLoader {\n    public static void main(String[] args) {\n    ClassLoader myClassLoader = new ClassLoader() {};\n    try {\n    Class cls = myClassLoader.loadClass(TestClassLoader.class.getName());\n    System.out.println(myClassLoader.getParent());\n    System.out.println(cls.getClassLoader());\n    } catch (ClassNotFoundException e) {\n    e.printStackTrace();\n    }\n    }\n    }\n\n\n{% endcodeblock %}\n\n输出结果：\n\n{% codeblock  lang:java   %}\n\n    sun.misc.Launcher$AppClassLoader@18b4aac2\n    sun.misc.Launcher$AppClassLoader@18b4aac2\n{% endcodeblock %}\n\n从结果上我们可以得出以下两个结论\n1. 自定义的classloader的parent默认为AppClassLoader\n2. 当classloader加载某个class的时候会委托给parent（父加载器）加载\n\n## 双亲委托细节\n双亲委派模型的工作过程是：如果一个类加载器收到了类加载的请求，他首先不会自己去尝试加载这个类，\n而是把这个请求委派父类加载器去完成。每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，\n只有当父加载器反馈自己无法完成这个请求（他的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去加载。\n\n双亲委托是如何实现的呢？秘密就在loadClass 这个方法\n\n双亲委派模型的工作过程是：如果一个类加载器收到了类加载的请求，他首先不会自己去尝试加载这个类，\n而是把这个请求委派父类加载器去完成。每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，\n只有当父加载器反馈自己无法完成这个请求（他的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去加载。\n\n双亲委托是如何实现的呢？秘密就在loadClass 这个方法\n\n{% codeblock  lang:java   %}\n\n    protected Class<?> loadClass(String name, boolean resolve)\n        throws ClassNotFoundException\n    {\n        synchronized (getClassLoadingLock(name)) {\n            // First, check if the class has already been loaded\n            Class<?> c = findLoadedClass(name);\n    if (c == null) {\n    long t0 = System.nanoTime();\n    try {\n    if (parent != null) {\n    c = parent.loadClass(name, false);\n    } else {\n    c = findBootstrapClassOrNull(name);\n    }\n    } catch (ClassNotFoundException e) {\n    // ClassNotFoundException thrown if class not found\n    // from the non-null parent class loader\n    }\n\n            if (c == null) {\n                // If still not found, then invoke findClass in order\n                // to find the class.\n                long t1 = System.nanoTime();\n                c = findClass(name);\n      \n                // this is the defining class loader; record the stats\n                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);\n                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);\n                sun.misc.PerfCounter.getFindClasses().increment();\n            }\n        }\n        if (resolve) {\n            resolveClass(c);\n        }\n        return c;\n    }\n    }\n\n\n{% endcodeblock %}\n\n从code上得出结论如果没有知道class,会先通过父加载起去加载，一直递归上去，如果没有父加载器直接通过bootstrap加载器加载\n大致流程如下： 用户自定义的classlaoder – AppClassLoader —ExtClassLoader – bootStrapClassLoader\n\n{% asset_img 1.png  image %}\n\n这么做有什么好处？\n\n>如果没有使用双亲委派模型，由各个类加载器自行加载的话，如果用户自己编写了一个称为java.lang.Object的类，\n并放在程序的ClassPath中，那系统将会出现多个不同的Object类， Java类型体系中最基础的行为就无法保证。应用程序也将会变得一片混乱\n\n## 如何破坏双亲委托\n双亲委托并不是一个强制约束，只是一种大家都遵守规范，但有些场景会破坏双亲委托（例如SPI）\n\n{% codeblock  lang:java   %}\n\n    public static void  test2(){  \n    ServiceLoader<SPITest> loaders= ServiceLoader.load(SPITest.class);\n    loaders.forEach(i->{\n    i.test();\n    });\n    }\n{% endcodeblock %}\n\n准确的说spi没有破坏双亲委托，只是绕过了双亲委托获取class，委托机制上层（例如bootstrapClassloader）通过Thread.currentThread().getContextClassLoader()来获取\n委托机制里面下层（例如AppClassLoader）加载的类。具体code如下：\n\n{% codeblock  lang:java   %}\n\n    public static <S> ServiceLoader<S> load(Class<S> service) {\n    ClassLoader cl = Thread.currentThread().getContextClassLoader();\n    return ServiceLoader.load(service, cl);\n    }\n\n{% endcodeblock %}\n\n这样做是为了解决一些 上层类依赖下层类的情况，比如jdbc，jdbc相关的类文件在rt.jar中，但是driver对应的实现类是放在我们应用的jar的lib里面，\n这样 extClassLoader 就加载不到，但是通过spi机制，rt.jar包中的jdbc相关类就能获取由AppClassLoader 加载的jdbc具体的driver了。\n上面讲到 双亲委托机制是通过loaderclass这个方法来实现的，如果我们自定义的classloader覆盖改方法（或者覆盖findClass），就能强行破坏，例如osgi.\n在jvm里面每个class的唯一标识符由 classloader全名+class全名构成，因此假设两个独立的classloader，加载一样的class，jvm也会认为是两个独立的class，\ntomcat就是此机制来实现webapp目录下不同的web应用的隔离\n\n","slug":"class装载","published":1,"updated":"2023-12-05T02:48:12.726Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdiu0009orgo5zs8ekgb","content":"<h1 id=\"class装载\"><a href=\"#class装载\" class=\"headerlink\" title=\"class装载\"></a>class装载</h1><p><strong>示例代码链接 <a href=\"https://github.com/ChenXun1989/study-example\">https://github.com/ChenXun1989/study-example</a></strong></p>\n<p>演示demo</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TestClassLoader</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\"><span class=\"type\">ClassLoader</span> <span class=\"variable\">myClassLoader</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ClassLoader</span>() &#123;&#125;;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"><span class=\"type\">Class</span> <span class=\"variable\">cls</span> <span class=\"operator\">=</span> myClassLoader.loadClass(TestClassLoader.class.getName());</span><br><span class=\"line\">System.out.println(myClassLoader.getParent());</span><br><span class=\"line\">System.out.println(cls.getClassLoader());</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</span><br><span class=\"line\">e.printStackTrace();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>输出结果：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">sun.misc.Launcher$AppClassLoader@18b4aac2</span><br><span class=\"line\">sun.misc.Launcher$AppClassLoader@18b4aac2</span><br></pre></td></tr></table></figure>\n\n<p>从结果上我们可以得出以下两个结论</p>\n<ol>\n<li>自定义的classloader的parent默认为AppClassLoader</li>\n<li>当classloader加载某个class的时候会委托给parent（父加载器）加载</li>\n</ol>\n<h2 id=\"双亲委托细节\"><a href=\"#双亲委托细节\" class=\"headerlink\" title=\"双亲委托细节\"></a>双亲委托细节</h2><p>双亲委派模型的工作过程是：如果一个类加载器收到了类加载的请求，他首先不会自己去尝试加载这个类，<br>而是把这个请求委派父类加载器去完成。每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，<br>只有当父加载器反馈自己无法完成这个请求（他的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去加载。</p>\n<p>双亲委托是如何实现的呢？秘密就在loadClass 这个方法</p>\n<p>双亲委派模型的工作过程是：如果一个类加载器收到了类加载的请求，他首先不会自己去尝试加载这个类，<br>而是把这个请求委派父类加载器去完成。每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，<br>只有当父加载器反馈自己无法完成这个请求（他的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去加载。</p>\n<p>双亲委托是如何实现的呢？秘密就在loadClass 这个方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">protected</span> Class&lt;?&gt; loadClass(String name, <span class=\"type\">boolean</span> resolve)</span><br><span class=\"line\">    <span class=\"keyword\">throws</span> ClassNotFoundException</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// First, check if the class has already been loaded</span></span><br><span class=\"line\">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (c == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"variable\">t0</span> <span class=\"operator\">=</span> System.nanoTime();</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (parent != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">c = parent.loadClass(name, <span class=\"literal\">false</span>);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">c = findBootstrapClassOrNull(name);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</span><br><span class=\"line\"><span class=\"comment\">// ClassNotFoundException thrown if class not found</span></span><br><span class=\"line\"><span class=\"comment\">// from the non-null parent class loader</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (c == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// If still not found, then invoke findClass in order</span></span><br><span class=\"line\">            <span class=\"comment\">// to find the class.</span></span><br><span class=\"line\">            <span class=\"type\">long</span> <span class=\"variable\">t1</span> <span class=\"operator\">=</span> System.nanoTime();</span><br><span class=\"line\">            c = findClass(name);</span><br><span class=\"line\">  </span><br><span class=\"line\">            <span class=\"comment\">// this is the defining class loader; record the stats</span></span><br><span class=\"line\">            sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class=\"line\">            sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class=\"line\">            sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (resolve) &#123;</span><br><span class=\"line\">        resolveClass(c);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> c;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>从code上得出结论如果没有知道class,会先通过父加载起去加载，一直递归上去，如果没有父加载器直接通过bootstrap加载器加载<br>大致流程如下： 用户自定义的classlaoder – AppClassLoader —ExtClassLoader – bootStrapClassLoader</p>\n<img src=\"/2023062034905/1.png\" class=\"\" title=\"image\">\n\n<p>这么做有什么好处？</p>\n<blockquote>\n<p>如果没有使用双亲委派模型，由各个类加载器自行加载的话，如果用户自己编写了一个称为java.lang.Object的类，<br>并放在程序的ClassPath中，那系统将会出现多个不同的Object类， Java类型体系中最基础的行为就无法保证。应用程序也将会变得一片混乱</p>\n</blockquote>\n<h2 id=\"如何破坏双亲委托\"><a href=\"#如何破坏双亲委托\" class=\"headerlink\" title=\"如何破坏双亲委托\"></a>如何破坏双亲委托</h2><p>双亲委托并不是一个强制约束，只是一种大家都遵守规范，但有些场景会破坏双亲委托（例如SPI）</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span>  <span class=\"title function_\">test2</span><span class=\"params\">()</span>&#123;  </span><br><span class=\"line\">ServiceLoader&lt;SPITest&gt; loaders= ServiceLoader.load(SPITest.class);</span><br><span class=\"line\">loaders.forEach(i-&gt;&#123;</span><br><span class=\"line\">i.test();</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>准确的说spi没有破坏双亲委托，只是绕过了双亲委托获取class，委托机制上层（例如bootstrapClassloader）通过Thread.currentThread().getContextClassLoader()来获取<br>委托机制里面下层（例如AppClassLoader）加载的类。具体code如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;S&gt; ServiceLoader&lt;S&gt; <span class=\"title function_\">load</span><span class=\"params\">(Class&lt;S&gt; service)</span> &#123;</span><br><span class=\"line\"><span class=\"type\">ClassLoader</span> <span class=\"variable\">cl</span> <span class=\"operator\">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class=\"line\"><span class=\"keyword\">return</span> ServiceLoader.load(service, cl);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>这样做是为了解决一些 上层类依赖下层类的情况，比如jdbc，jdbc相关的类文件在rt.jar中，但是driver对应的实现类是放在我们应用的jar的lib里面，<br>这样 extClassLoader 就加载不到，但是通过spi机制，rt.jar包中的jdbc相关类就能获取由AppClassLoader 加载的jdbc具体的driver了。<br>上面讲到 双亲委托机制是通过loaderclass这个方法来实现的，如果我们自定义的classloader覆盖改方法（或者覆盖findClass），就能强行破坏，例如osgi.<br>在jvm里面每个class的唯一标识符由 classloader全名+class全名构成，因此假设两个独立的classloader，加载一样的class，jvm也会认为是两个独立的class，<br>tomcat就是此机制来实现webapp目录下不同的web应用的隔离</p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"class装载\"><a href=\"#class装载\" class=\"headerlink\" title=\"class装载\"></a>class装载</h1><p><strong>示例代码链接 <a href=\"https://github.com/ChenXun1989/study-example\">https://github.com/ChenXun1989/study-example</a></strong></p>\n<p>演示demo</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TestClassLoader</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\"><span class=\"type\">ClassLoader</span> <span class=\"variable\">myClassLoader</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ClassLoader</span>() &#123;&#125;;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"><span class=\"type\">Class</span> <span class=\"variable\">cls</span> <span class=\"operator\">=</span> myClassLoader.loadClass(TestClassLoader.class.getName());</span><br><span class=\"line\">System.out.println(myClassLoader.getParent());</span><br><span class=\"line\">System.out.println(cls.getClassLoader());</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</span><br><span class=\"line\">e.printStackTrace();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>输出结果：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">sun.misc.Launcher$AppClassLoader@18b4aac2</span><br><span class=\"line\">sun.misc.Launcher$AppClassLoader@18b4aac2</span><br></pre></td></tr></table></figure>\n\n<p>从结果上我们可以得出以下两个结论</p>\n<ol>\n<li>自定义的classloader的parent默认为AppClassLoader</li>\n<li>当classloader加载某个class的时候会委托给parent（父加载器）加载</li>\n</ol>\n<h2 id=\"双亲委托细节\"><a href=\"#双亲委托细节\" class=\"headerlink\" title=\"双亲委托细节\"></a>双亲委托细节</h2><p>双亲委派模型的工作过程是：如果一个类加载器收到了类加载的请求，他首先不会自己去尝试加载这个类，<br>而是把这个请求委派父类加载器去完成。每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，<br>只有当父加载器反馈自己无法完成这个请求（他的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去加载。</p>\n<p>双亲委托是如何实现的呢？秘密就在loadClass 这个方法</p>\n<p>双亲委派模型的工作过程是：如果一个类加载器收到了类加载的请求，他首先不会自己去尝试加载这个类，<br>而是把这个请求委派父类加载器去完成。每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，<br>只有当父加载器反馈自己无法完成这个请求（他的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去加载。</p>\n<p>双亲委托是如何实现的呢？秘密就在loadClass 这个方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">protected</span> Class&lt;?&gt; loadClass(String name, <span class=\"type\">boolean</span> resolve)</span><br><span class=\"line\">    <span class=\"keyword\">throws</span> ClassNotFoundException</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// First, check if the class has already been loaded</span></span><br><span class=\"line\">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (c == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"variable\">t0</span> <span class=\"operator\">=</span> System.nanoTime();</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (parent != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">c = parent.loadClass(name, <span class=\"literal\">false</span>);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">c = findBootstrapClassOrNull(name);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</span><br><span class=\"line\"><span class=\"comment\">// ClassNotFoundException thrown if class not found</span></span><br><span class=\"line\"><span class=\"comment\">// from the non-null parent class loader</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (c == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// If still not found, then invoke findClass in order</span></span><br><span class=\"line\">            <span class=\"comment\">// to find the class.</span></span><br><span class=\"line\">            <span class=\"type\">long</span> <span class=\"variable\">t1</span> <span class=\"operator\">=</span> System.nanoTime();</span><br><span class=\"line\">            c = findClass(name);</span><br><span class=\"line\">  </span><br><span class=\"line\">            <span class=\"comment\">// this is the defining class loader; record the stats</span></span><br><span class=\"line\">            sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class=\"line\">            sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class=\"line\">            sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (resolve) &#123;</span><br><span class=\"line\">        resolveClass(c);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> c;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>从code上得出结论如果没有知道class,会先通过父加载起去加载，一直递归上去，如果没有父加载器直接通过bootstrap加载器加载<br>大致流程如下： 用户自定义的classlaoder – AppClassLoader —ExtClassLoader – bootStrapClassLoader</p>\n<img src=\"/2023062034905/1.png\" class=\"\" title=\"image\">\n\n<p>这么做有什么好处？</p>\n<blockquote>\n<p>如果没有使用双亲委派模型，由各个类加载器自行加载的话，如果用户自己编写了一个称为java.lang.Object的类，<br>并放在程序的ClassPath中，那系统将会出现多个不同的Object类， Java类型体系中最基础的行为就无法保证。应用程序也将会变得一片混乱</p>\n</blockquote>\n<h2 id=\"如何破坏双亲委托\"><a href=\"#如何破坏双亲委托\" class=\"headerlink\" title=\"如何破坏双亲委托\"></a>如何破坏双亲委托</h2><p>双亲委托并不是一个强制约束，只是一种大家都遵守规范，但有些场景会破坏双亲委托（例如SPI）</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span>  <span class=\"title function_\">test2</span><span class=\"params\">()</span>&#123;  </span><br><span class=\"line\">ServiceLoader&lt;SPITest&gt; loaders= ServiceLoader.load(SPITest.class);</span><br><span class=\"line\">loaders.forEach(i-&gt;&#123;</span><br><span class=\"line\">i.test();</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>准确的说spi没有破坏双亲委托，只是绕过了双亲委托获取class，委托机制上层（例如bootstrapClassloader）通过Thread.currentThread().getContextClassLoader()来获取<br>委托机制里面下层（例如AppClassLoader）加载的类。具体code如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;S&gt; ServiceLoader&lt;S&gt; <span class=\"title function_\">load</span><span class=\"params\">(Class&lt;S&gt; service)</span> &#123;</span><br><span class=\"line\"><span class=\"type\">ClassLoader</span> <span class=\"variable\">cl</span> <span class=\"operator\">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class=\"line\"><span class=\"keyword\">return</span> ServiceLoader.load(service, cl);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>这样做是为了解决一些 上层类依赖下层类的情况，比如jdbc，jdbc相关的类文件在rt.jar中，但是driver对应的实现类是放在我们应用的jar的lib里面，<br>这样 extClassLoader 就加载不到，但是通过spi机制，rt.jar包中的jdbc相关类就能获取由AppClassLoader 加载的jdbc具体的driver了。<br>上面讲到 双亲委托机制是通过loaderclass这个方法来实现的，如果我们自定义的classloader覆盖改方法（或者覆盖findClass），就能强行破坏，例如osgi.<br>在jvm里面每个class的唯一标识符由 classloader全名+class全名构成，因此假设两个独立的classloader，加载一样的class，jvm也会认为是两个独立的class，<br>tomcat就是此机制来实现webapp目录下不同的web应用的隔离</p>\n"},{"title":"dubbo源码研究之config-spring模块","abbrlink":10082,"date":"2023-06-20T05:58:06.000Z","_content":"# dubbo源码研究之config-spring模块\n\ndubbo-config-spring模块是dubbo-config的Extension。\n\n{% asset_img 1.png  image %}\n\nDubbo的扩展点加载从JDK标准的SPI(Service Provider Interface)扩展点发现机制加强而来。\nDubbo改进了JDK标准的SPI的以下问题：\nJDK标准的SPI会一次性实例化扩展点所有实现，如果有扩展实现初始化很耗时，但如果没用上也加载，会很浪费资源。\n如果扩展点加载失败，连扩展点的名称都拿不到了。比如：JDK标准的ScriptEngine，通过getName();获取脚本类型的名称，\n但如果RubyScriptEngine因为所依赖的jruby.jar不存在，导致RubyScriptEngine类加载失败，这个失败原因被吃掉了，和ruby对应不起来，\n当用户执行ruby脚本时，会报不支持ruby，而不是真正失败的原因。\n增加了对扩展点IoC和AOP的支持，一个扩展点可以直接setter注入其它扩展点。\ndubbo的spi约定：在扩展类的jar包内，放置扩展点配置文件：META-INF/dubbo/接口全限定名，内容为：配置名=扩展实现类全限定名，多个实现类用换行符分隔。\n\n{% codeblock schema.xml lang:java   %}\n    \n    @SPI\n    public interface ExtensionFactory {\n\n    /** \n     * Get extension. \n     *  \n     * @param type object type. \n     * @param name object name. \n     * @return object instance. \n     */  \n    <T> T getExtension(Class<T> type, String name);  \n\n    }\n{% endcodeblock %}\ndubbo的扩展点接口ExtensionFactory ，该接口有三个实现\n\n{% asset_img 2.png  image %}\n\ndubbo的扩展实现的具体类是ExtensionLoader。\nExtensionLoader加载扩展点时，会检查扩展点的属性（通过set方法判断），如该属性是扩展点类型，则会注入扩展点对象。\n因为注入时不能确定使用哪个扩展点（在使用时确定），所以注入的是一个自适应扩展（一个代理）。自适应扩展点调用时，选取一个真正的扩展点，并代理到其上完成调用。\nDubbo是根据调用方法参数（上面有调用哪个扩展点的信息）来选取一个真正的扩展点。\n\n\n{% codeblock  lang:java   %}\n\n    @SuppressWarnings(\"unchecked\")  \n    private T createExtension(String name) {  \n    Class<?> clazz = getExtensionClasses().get(name);  \n        if (clazz == null) {  \n            throw findException(name);  \n        }  \n        try {  \n            T instance = (T) EXTENSION_INSTANCES.get(clazz);  \n            if (instance == null) {  \n                EXTENSION_INSTANCES.putIfAbsent(clazz, (T) clazz.newInstance());  \n                instance = (T) EXTENSION_INSTANCES.get(clazz);  \n            }  \n            injectExtension(instance);  \n            Set<Class<?>> wrapperClasses = cachedWrapperClasses;  \n    if (wrapperClasses != null && wrapperClasses.size() > 0) {  \n    for (Class<?> wrapperClass : wrapperClasses) {  \n    instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));  \n    }  \n    }  \n    return instance;  \n    } catch (Throwable t) {  \n    throw new IllegalStateException(\"Extension instance(name: \" + name + \", class: \" +  \n    type + \")  could not be instantiated: \" + t.getMessage(), t);  \n    }  \n    }\n\n    private T injectExtension(T instance) {  \n    try {  \n    if (objectFactory != null) {  \n    for (Method method : instance.getClass().getMethods()) {  \n    if (method.getName().startsWith(\"set\")  \n    && method.getParameterTypes().length == 1  \n    && Modifier.isPublic(method.getModifiers())) {  \n    Class<?> pt = method.getParameterTypes()[0];  \n    try {  \n    String property = method.getName().length() > 3 ? method.getName().substring(3, 4).toLowerCase() + method.getName().substring(4) : \"\";  \n    Object object = objectFactory.getExtension(pt, property);  \n    if (object != null) {  \n    method.invoke(instance, object);  \n    }  \n    } catch (Exception e) {  \n    logger.error(\"fail to inject via method \" + method.getName()  \n    + \" of interface \" + type.getName() + \": \" + e.getMessage(), e);  \n    }  \n    }  \n    }  \n    }  \n    } catch (Exception e) {  \n    logger.error(e.getMessage(), e);  \n    }  \n    return instance;  \n    }\n{% endcodeblock %}\n\n可以看出ExtensionLoader持有某一类扩展点的所有扩展，并且扩展以class为key，一个扩展类只有一个实例。\n如果扩展点使用了Adaptive则会通过字节码生成一个自适应的扩展类。\n通过createAdaptiveExtensionClassCode方法返回class的code，然后通过Compiler接口返回class对象\n\n{% codeblock  lang:java   %}\n    \n    /**\n    * Compiler. (SPI, Singleton, ThreadSafe)\n    * \n    * @author william.liangf\n    */  \n    @SPI(\"javassist\")  \n    public interface Compiler {\n\n    /**\n      * Compile java source code.\n      *\n      * @param code Java source code\n      * @param classLoader TODO\n      * @return Compiled class\n        */  \n        Class<?> compile(String code, ClassLoader classLoader);\n\n      }\n\n{% endcodeblock %}\n\nCompiler dubbo支持jdk和Javassist两种实现，特别注意一点，JdkCompiler的java版本通过硬编码指定版本为1.6。\nJdkCompiler首先通过JavaFileObject接口生成java文件，然后通过JavaCompiler接口编译成class文件，最后通过ClassLoader加载生成的class文件。\nspring名称空间扩展\ndubbo通过扩展spring的名称空间来读取xml配置。\ndubbo.xsd是spring schma的扩展文件。作用是定义相关xml元素和名称空间。\nspring.handlers,spring.schemas是spring在解析xml的时候根据spi机制读取对象的NamespaceHandler和xsd文件位置。\n很多程序猿使用dubbo开发的时候，会发现ide工具报错，因为xml上面dubbo名称空间的链接打不开，其实这个报错可以无视的，\n因为spring解析的xml的时候这个网络地址其实是指向spi配置文件里面的一个java类。\nspring.handlers\n\n{% codeblock  lang:xml   %}\n\n    http\\://code.alibabatech.com/schema/dubbo=com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler\n{% endcodeblock %}\n\nDubboNamespaceHandler则注册了相关自定义元素的解析器\n\n{% codeblock  lang:xml   %}\n\n    /**\n     * DubboNamespaceHandler\n     * \n     * @author william.liangf\n     * @export\n    */  \n    public class DubboNamespaceHandler extends NamespaceHandlerSupport {\n\n    static {  \n    Version.checkDuplicate(DubboNamespaceHandler.class);  \n    }\n\n    public void init() {  \n    registerBeanDefinitionParser(\"application\", new DubboBeanDefinitionParser(ApplicationConfig.class, true));  \n    registerBeanDefinitionParser(\"module\", new DubboBeanDefinitionParser(ModuleConfig.class, true));  \n    registerBeanDefinitionParser(\"registry\", new DubboBeanDefinitionParser(RegistryConfig.class, true));  \n    registerBeanDefinitionParser(\"monitor\", new DubboBeanDefinitionParser(MonitorConfig.class, true));  \n    registerBeanDefinitionParser(\"provider\", new DubboBeanDefinitionParser(ProviderConfig.class, true));  \n    registerBeanDefinitionParser(\"consumer\", new DubboBeanDefinitionParser(ConsumerConfig.class, true));  \n    registerBeanDefinitionParser(\"protocol\", new DubboBeanDefinitionParser(ProtocolConfig.class, true));  \n    registerBeanDefinitionParser(\"service\", new DubboBeanDefinitionParser(ServiceBean.class, true));  \n    registerBeanDefinitionParser(\"reference\", new DubboBeanDefinitionParser(ReferenceBean.class, false));  \n    registerBeanDefinitionParser(\"annotation\", new DubboBeanDefinitionParser(AnnotationBean.class, true));  \n    }\n\n    }\n{% endcodeblock %}\n\n\n","source":"_posts/dubbo源码研究之config-spring模块.md","raw":"---\ntitle: dubbo源码研究之config-spring模块\ntags:\n  - dubbo\nabbrlink: 10082\ndate: 2023-06-20 13:58:06\n---\n# dubbo源码研究之config-spring模块\n\ndubbo-config-spring模块是dubbo-config的Extension。\n\n{% asset_img 1.png  image %}\n\nDubbo的扩展点加载从JDK标准的SPI(Service Provider Interface)扩展点发现机制加强而来。\nDubbo改进了JDK标准的SPI的以下问题：\nJDK标准的SPI会一次性实例化扩展点所有实现，如果有扩展实现初始化很耗时，但如果没用上也加载，会很浪费资源。\n如果扩展点加载失败，连扩展点的名称都拿不到了。比如：JDK标准的ScriptEngine，通过getName();获取脚本类型的名称，\n但如果RubyScriptEngine因为所依赖的jruby.jar不存在，导致RubyScriptEngine类加载失败，这个失败原因被吃掉了，和ruby对应不起来，\n当用户执行ruby脚本时，会报不支持ruby，而不是真正失败的原因。\n增加了对扩展点IoC和AOP的支持，一个扩展点可以直接setter注入其它扩展点。\ndubbo的spi约定：在扩展类的jar包内，放置扩展点配置文件：META-INF/dubbo/接口全限定名，内容为：配置名=扩展实现类全限定名，多个实现类用换行符分隔。\n\n{% codeblock schema.xml lang:java   %}\n    \n    @SPI\n    public interface ExtensionFactory {\n\n    /** \n     * Get extension. \n     *  \n     * @param type object type. \n     * @param name object name. \n     * @return object instance. \n     */  \n    <T> T getExtension(Class<T> type, String name);  \n\n    }\n{% endcodeblock %}\ndubbo的扩展点接口ExtensionFactory ，该接口有三个实现\n\n{% asset_img 2.png  image %}\n\ndubbo的扩展实现的具体类是ExtensionLoader。\nExtensionLoader加载扩展点时，会检查扩展点的属性（通过set方法判断），如该属性是扩展点类型，则会注入扩展点对象。\n因为注入时不能确定使用哪个扩展点（在使用时确定），所以注入的是一个自适应扩展（一个代理）。自适应扩展点调用时，选取一个真正的扩展点，并代理到其上完成调用。\nDubbo是根据调用方法参数（上面有调用哪个扩展点的信息）来选取一个真正的扩展点。\n\n\n{% codeblock  lang:java   %}\n\n    @SuppressWarnings(\"unchecked\")  \n    private T createExtension(String name) {  \n    Class<?> clazz = getExtensionClasses().get(name);  \n        if (clazz == null) {  \n            throw findException(name);  \n        }  \n        try {  \n            T instance = (T) EXTENSION_INSTANCES.get(clazz);  \n            if (instance == null) {  \n                EXTENSION_INSTANCES.putIfAbsent(clazz, (T) clazz.newInstance());  \n                instance = (T) EXTENSION_INSTANCES.get(clazz);  \n            }  \n            injectExtension(instance);  \n            Set<Class<?>> wrapperClasses = cachedWrapperClasses;  \n    if (wrapperClasses != null && wrapperClasses.size() > 0) {  \n    for (Class<?> wrapperClass : wrapperClasses) {  \n    instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));  \n    }  \n    }  \n    return instance;  \n    } catch (Throwable t) {  \n    throw new IllegalStateException(\"Extension instance(name: \" + name + \", class: \" +  \n    type + \")  could not be instantiated: \" + t.getMessage(), t);  \n    }  \n    }\n\n    private T injectExtension(T instance) {  \n    try {  \n    if (objectFactory != null) {  \n    for (Method method : instance.getClass().getMethods()) {  \n    if (method.getName().startsWith(\"set\")  \n    && method.getParameterTypes().length == 1  \n    && Modifier.isPublic(method.getModifiers())) {  \n    Class<?> pt = method.getParameterTypes()[0];  \n    try {  \n    String property = method.getName().length() > 3 ? method.getName().substring(3, 4).toLowerCase() + method.getName().substring(4) : \"\";  \n    Object object = objectFactory.getExtension(pt, property);  \n    if (object != null) {  \n    method.invoke(instance, object);  \n    }  \n    } catch (Exception e) {  \n    logger.error(\"fail to inject via method \" + method.getName()  \n    + \" of interface \" + type.getName() + \": \" + e.getMessage(), e);  \n    }  \n    }  \n    }  \n    }  \n    } catch (Exception e) {  \n    logger.error(e.getMessage(), e);  \n    }  \n    return instance;  \n    }\n{% endcodeblock %}\n\n可以看出ExtensionLoader持有某一类扩展点的所有扩展，并且扩展以class为key，一个扩展类只有一个实例。\n如果扩展点使用了Adaptive则会通过字节码生成一个自适应的扩展类。\n通过createAdaptiveExtensionClassCode方法返回class的code，然后通过Compiler接口返回class对象\n\n{% codeblock  lang:java   %}\n    \n    /**\n    * Compiler. (SPI, Singleton, ThreadSafe)\n    * \n    * @author william.liangf\n    */  \n    @SPI(\"javassist\")  \n    public interface Compiler {\n\n    /**\n      * Compile java source code.\n      *\n      * @param code Java source code\n      * @param classLoader TODO\n      * @return Compiled class\n        */  \n        Class<?> compile(String code, ClassLoader classLoader);\n\n      }\n\n{% endcodeblock %}\n\nCompiler dubbo支持jdk和Javassist两种实现，特别注意一点，JdkCompiler的java版本通过硬编码指定版本为1.6。\nJdkCompiler首先通过JavaFileObject接口生成java文件，然后通过JavaCompiler接口编译成class文件，最后通过ClassLoader加载生成的class文件。\nspring名称空间扩展\ndubbo通过扩展spring的名称空间来读取xml配置。\ndubbo.xsd是spring schma的扩展文件。作用是定义相关xml元素和名称空间。\nspring.handlers,spring.schemas是spring在解析xml的时候根据spi机制读取对象的NamespaceHandler和xsd文件位置。\n很多程序猿使用dubbo开发的时候，会发现ide工具报错，因为xml上面dubbo名称空间的链接打不开，其实这个报错可以无视的，\n因为spring解析的xml的时候这个网络地址其实是指向spi配置文件里面的一个java类。\nspring.handlers\n\n{% codeblock  lang:xml   %}\n\n    http\\://code.alibabatech.com/schema/dubbo=com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler\n{% endcodeblock %}\n\nDubboNamespaceHandler则注册了相关自定义元素的解析器\n\n{% codeblock  lang:xml   %}\n\n    /**\n     * DubboNamespaceHandler\n     * \n     * @author william.liangf\n     * @export\n    */  \n    public class DubboNamespaceHandler extends NamespaceHandlerSupport {\n\n    static {  \n    Version.checkDuplicate(DubboNamespaceHandler.class);  \n    }\n\n    public void init() {  \n    registerBeanDefinitionParser(\"application\", new DubboBeanDefinitionParser(ApplicationConfig.class, true));  \n    registerBeanDefinitionParser(\"module\", new DubboBeanDefinitionParser(ModuleConfig.class, true));  \n    registerBeanDefinitionParser(\"registry\", new DubboBeanDefinitionParser(RegistryConfig.class, true));  \n    registerBeanDefinitionParser(\"monitor\", new DubboBeanDefinitionParser(MonitorConfig.class, true));  \n    registerBeanDefinitionParser(\"provider\", new DubboBeanDefinitionParser(ProviderConfig.class, true));  \n    registerBeanDefinitionParser(\"consumer\", new DubboBeanDefinitionParser(ConsumerConfig.class, true));  \n    registerBeanDefinitionParser(\"protocol\", new DubboBeanDefinitionParser(ProtocolConfig.class, true));  \n    registerBeanDefinitionParser(\"service\", new DubboBeanDefinitionParser(ServiceBean.class, true));  \n    registerBeanDefinitionParser(\"reference\", new DubboBeanDefinitionParser(ReferenceBean.class, false));  \n    registerBeanDefinitionParser(\"annotation\", new DubboBeanDefinitionParser(AnnotationBean.class, true));  \n    }\n\n    }\n{% endcodeblock %}\n\n\n","slug":"dubbo源码研究之config-spring模块","published":1,"updated":"2023-12-05T02:48:12.726Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdiw000corgo2yzm94p4","content":"<h1 id=\"dubbo源码研究之config-spring模块\"><a href=\"#dubbo源码研究之config-spring模块\" class=\"headerlink\" title=\"dubbo源码研究之config-spring模块\"></a>dubbo源码研究之config-spring模块</h1><p>dubbo-config-spring模块是dubbo-config的Extension。</p>\n<img src=\"/2023062010082/1.png\" class=\"\" title=\"image\">\n\n<p>Dubbo的扩展点加载从JDK标准的SPI(Service Provider Interface)扩展点发现机制加强而来。<br>Dubbo改进了JDK标准的SPI的以下问题：<br>JDK标准的SPI会一次性实例化扩展点所有实现，如果有扩展实现初始化很耗时，但如果没用上也加载，会很浪费资源。<br>如果扩展点加载失败，连扩展点的名称都拿不到了。比如：JDK标准的ScriptEngine，通过getName();获取脚本类型的名称，<br>但如果RubyScriptEngine因为所依赖的jruby.jar不存在，导致RubyScriptEngine类加载失败，这个失败原因被吃掉了，和ruby对应不起来，<br>当用户执行ruby脚本时，会报不支持ruby，而不是真正失败的原因。<br>增加了对扩展点IoC和AOP的支持，一个扩展点可以直接setter注入其它扩展点。<br>dubbo的spi约定：在扩展类的jar包内，放置扩展点配置文件：META-INF&#x2F;dubbo&#x2F;接口全限定名，内容为：配置名&#x3D;扩展实现类全限定名，多个实现类用换行符分隔。</p>\n<figure class=\"highlight java\"><figcaption><span>schema.xml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SPI</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">ExtensionFactory</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\"> * Get extension. </span></span><br><span class=\"line\"><span class=\"comment\"> *  </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> type object type. </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> name object name. </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> object instance. </span></span><br><span class=\"line\"><span class=\"comment\"> */</span>  </span><br><span class=\"line\">&lt;T&gt; T <span class=\"title function_\">getExtension</span><span class=\"params\">(Class&lt;T&gt; type, String name)</span>;  </span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>dubbo的扩展点接口ExtensionFactory ，该接口有三个实现</p>\n<img src=\"/2023062010082/2.png\" class=\"\" title=\"image\">\n\n<p>dubbo的扩展实现的具体类是ExtensionLoader。<br>ExtensionLoader加载扩展点时，会检查扩展点的属性（通过set方法判断），如该属性是扩展点类型，则会注入扩展点对象。<br>因为注入时不能确定使用哪个扩展点（在使用时确定），所以注入的是一个自适应扩展（一个代理）。自适应扩展点调用时，选取一个真正的扩展点，并代理到其上完成调用。<br>Dubbo是根据调用方法参数（上面有调用哪个扩展点的信息）来选取一个真正的扩展点。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class=\"line\"><span class=\"keyword\">private</span> T <span class=\"title function_\">createExtension</span><span class=\"params\">(String name)</span> &#123;  </span><br><span class=\"line\">Class&lt;?&gt; clazz = getExtensionClasses().get(name);  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (clazz == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> findException(name);  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">        <span class=\"type\">T</span> <span class=\"variable\">instance</span> <span class=\"operator\">=</span> (T) EXTENSION_INSTANCES.get(clazz);  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (instance == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">            EXTENSION_INSTANCES.putIfAbsent(clazz, (T) clazz.newInstance());  </span><br><span class=\"line\">            instance = (T) EXTENSION_INSTANCES.get(clazz);  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">        injectExtension(instance);  </span><br><span class=\"line\">        Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (wrapperClasses != <span class=\"literal\">null</span> &amp;&amp; wrapperClasses.size() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">for</span> (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123;  </span><br><span class=\"line\">instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> instance;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(<span class=\"string\">&quot;Extension instance(name: &quot;</span> + name + <span class=\"string\">&quot;, class: &quot;</span> +  </span><br><span class=\"line\">type + <span class=\"string\">&quot;)  could not be instantiated: &quot;</span> + t.getMessage(), t);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> T <span class=\"title function_\">injectExtension</span><span class=\"params\">(T instance)</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (objectFactory != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">for</span> (Method method : instance.getClass().getMethods()) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (method.getName().startsWith(<span class=\"string\">&quot;set&quot;</span>)  </span><br><span class=\"line\">&amp;&amp; method.getParameterTypes().length == <span class=\"number\">1</span>  </span><br><span class=\"line\">&amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;  </span><br><span class=\"line\">Class&lt;?&gt; pt = method.getParameterTypes()[<span class=\"number\">0</span>];  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">property</span> <span class=\"operator\">=</span> method.getName().length() &gt; <span class=\"number\">3</span> ? method.getName().substring(<span class=\"number\">3</span>, <span class=\"number\">4</span>).toLowerCase() + method.getName().substring(<span class=\"number\">4</span>) : <span class=\"string\">&quot;&quot;</span>;  </span><br><span class=\"line\"><span class=\"type\">Object</span> <span class=\"variable\">object</span> <span class=\"operator\">=</span> objectFactory.getExtension(pt, property);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (object != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">method.invoke(instance, object);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;  </span><br><span class=\"line\">logger.error(<span class=\"string\">&quot;fail to inject via method &quot;</span> + method.getName()  </span><br><span class=\"line\">+ <span class=\"string\">&quot; of interface &quot;</span> + type.getName() + <span class=\"string\">&quot;: &quot;</span> + e.getMessage(), e);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;  </span><br><span class=\"line\">logger.error(e.getMessage(), e);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> instance;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可以看出ExtensionLoader持有某一类扩展点的所有扩展，并且扩展以class为key，一个扩展类只有一个实例。<br>如果扩展点使用了Adaptive则会通过字节码生成一个自适应的扩展类。<br>通过createAdaptiveExtensionClassCode方法返回class的code，然后通过Compiler接口返回class对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* Compiler. (SPI, Singleton, ThreadSafe)</span></span><br><span class=\"line\"><span class=\"comment\">* </span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@author</span> william.liangf</span></span><br><span class=\"line\"><span class=\"comment\">*/</span>  </span><br><span class=\"line\"><span class=\"meta\">@SPI(&quot;javassist&quot;)</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">Compiler</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * Compile java source code.</span></span><br><span class=\"line\"><span class=\"comment\">  *</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@param</span> code Java source code</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@param</span> classLoader TODO</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@return</span> Compiled class</span></span><br><span class=\"line\"><span class=\"comment\">    */</span>  </span><br><span class=\"line\">    Class&lt;?&gt; compile(String code, ClassLoader classLoader);</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>Compiler dubbo支持jdk和Javassist两种实现，特别注意一点，JdkCompiler的java版本通过硬编码指定版本为1.6。<br>JdkCompiler首先通过JavaFileObject接口生成java文件，然后通过JavaCompiler接口编译成class文件，最后通过ClassLoader加载生成的class文件。<br>spring名称空间扩展<br>dubbo通过扩展spring的名称空间来读取xml配置。<br>dubbo.xsd是spring schma的扩展文件。作用是定义相关xml元素和名称空间。<br>spring.handlers,spring.schemas是spring在解析xml的时候根据spi机制读取对象的NamespaceHandler和xsd文件位置。<br>很多程序猿使用dubbo开发的时候，会发现ide工具报错，因为xml上面dubbo名称空间的链接打不开，其实这个报错可以无视的，<br>因为spring解析的xml的时候这个网络地址其实是指向spi配置文件里面的一个java类。<br>spring.handlers</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">http\\://code.alibabatech.com/schema/dubbo=com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler</span><br></pre></td></tr></table></figure>\n\n<p>DubboNamespaceHandler则注册了相关自定义元素的解析器</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">/**</span><br><span class=\"line\"> * DubboNamespaceHandler</span><br><span class=\"line\"> * </span><br><span class=\"line\"> * @author william.liangf</span><br><span class=\"line\"> * @export</span><br><span class=\"line\">*/  </span><br><span class=\"line\">public class DubboNamespaceHandler extends NamespaceHandlerSupport &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">static &#123;  </span><br><span class=\"line\">Version.checkDuplicate(DubboNamespaceHandler.class);  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">public void init() &#123;  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;application&quot;, new DubboBeanDefinitionParser(ApplicationConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;module&quot;, new DubboBeanDefinitionParser(ModuleConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;registry&quot;, new DubboBeanDefinitionParser(RegistryConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;monitor&quot;, new DubboBeanDefinitionParser(MonitorConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;provider&quot;, new DubboBeanDefinitionParser(ProviderConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;consumer&quot;, new DubboBeanDefinitionParser(ConsumerConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;protocol&quot;, new DubboBeanDefinitionParser(ProtocolConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;service&quot;, new DubboBeanDefinitionParser(ServiceBean.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;reference&quot;, new DubboBeanDefinitionParser(ReferenceBean.class, false));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;annotation&quot;, new DubboBeanDefinitionParser(AnnotationBean.class, true));  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"dubbo源码研究之config-spring模块\"><a href=\"#dubbo源码研究之config-spring模块\" class=\"headerlink\" title=\"dubbo源码研究之config-spring模块\"></a>dubbo源码研究之config-spring模块</h1><p>dubbo-config-spring模块是dubbo-config的Extension。</p>\n<img src=\"/2023062010082/1.png\" class=\"\" title=\"image\">\n\n<p>Dubbo的扩展点加载从JDK标准的SPI(Service Provider Interface)扩展点发现机制加强而来。<br>Dubbo改进了JDK标准的SPI的以下问题：<br>JDK标准的SPI会一次性实例化扩展点所有实现，如果有扩展实现初始化很耗时，但如果没用上也加载，会很浪费资源。<br>如果扩展点加载失败，连扩展点的名称都拿不到了。比如：JDK标准的ScriptEngine，通过getName();获取脚本类型的名称，<br>但如果RubyScriptEngine因为所依赖的jruby.jar不存在，导致RubyScriptEngine类加载失败，这个失败原因被吃掉了，和ruby对应不起来，<br>当用户执行ruby脚本时，会报不支持ruby，而不是真正失败的原因。<br>增加了对扩展点IoC和AOP的支持，一个扩展点可以直接setter注入其它扩展点。<br>dubbo的spi约定：在扩展类的jar包内，放置扩展点配置文件：META-INF&#x2F;dubbo&#x2F;接口全限定名，内容为：配置名&#x3D;扩展实现类全限定名，多个实现类用换行符分隔。</p>\n<figure class=\"highlight java\"><figcaption><span>schema.xml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SPI</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">ExtensionFactory</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\"> * Get extension. </span></span><br><span class=\"line\"><span class=\"comment\"> *  </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> type object type. </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> name object name. </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> object instance. </span></span><br><span class=\"line\"><span class=\"comment\"> */</span>  </span><br><span class=\"line\">&lt;T&gt; T <span class=\"title function_\">getExtension</span><span class=\"params\">(Class&lt;T&gt; type, String name)</span>;  </span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>dubbo的扩展点接口ExtensionFactory ，该接口有三个实现</p>\n<img src=\"/2023062010082/2.png\" class=\"\" title=\"image\">\n\n<p>dubbo的扩展实现的具体类是ExtensionLoader。<br>ExtensionLoader加载扩展点时，会检查扩展点的属性（通过set方法判断），如该属性是扩展点类型，则会注入扩展点对象。<br>因为注入时不能确定使用哪个扩展点（在使用时确定），所以注入的是一个自适应扩展（一个代理）。自适应扩展点调用时，选取一个真正的扩展点，并代理到其上完成调用。<br>Dubbo是根据调用方法参数（上面有调用哪个扩展点的信息）来选取一个真正的扩展点。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class=\"line\"><span class=\"keyword\">private</span> T <span class=\"title function_\">createExtension</span><span class=\"params\">(String name)</span> &#123;  </span><br><span class=\"line\">Class&lt;?&gt; clazz = getExtensionClasses().get(name);  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (clazz == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> findException(name);  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">        <span class=\"type\">T</span> <span class=\"variable\">instance</span> <span class=\"operator\">=</span> (T) EXTENSION_INSTANCES.get(clazz);  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (instance == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">            EXTENSION_INSTANCES.putIfAbsent(clazz, (T) clazz.newInstance());  </span><br><span class=\"line\">            instance = (T) EXTENSION_INSTANCES.get(clazz);  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">        injectExtension(instance);  </span><br><span class=\"line\">        Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (wrapperClasses != <span class=\"literal\">null</span> &amp;&amp; wrapperClasses.size() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">for</span> (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123;  </span><br><span class=\"line\">instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> instance;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(<span class=\"string\">&quot;Extension instance(name: &quot;</span> + name + <span class=\"string\">&quot;, class: &quot;</span> +  </span><br><span class=\"line\">type + <span class=\"string\">&quot;)  could not be instantiated: &quot;</span> + t.getMessage(), t);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> T <span class=\"title function_\">injectExtension</span><span class=\"params\">(T instance)</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (objectFactory != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">for</span> (Method method : instance.getClass().getMethods()) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (method.getName().startsWith(<span class=\"string\">&quot;set&quot;</span>)  </span><br><span class=\"line\">&amp;&amp; method.getParameterTypes().length == <span class=\"number\">1</span>  </span><br><span class=\"line\">&amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;  </span><br><span class=\"line\">Class&lt;?&gt; pt = method.getParameterTypes()[<span class=\"number\">0</span>];  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">property</span> <span class=\"operator\">=</span> method.getName().length() &gt; <span class=\"number\">3</span> ? method.getName().substring(<span class=\"number\">3</span>, <span class=\"number\">4</span>).toLowerCase() + method.getName().substring(<span class=\"number\">4</span>) : <span class=\"string\">&quot;&quot;</span>;  </span><br><span class=\"line\"><span class=\"type\">Object</span> <span class=\"variable\">object</span> <span class=\"operator\">=</span> objectFactory.getExtension(pt, property);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (object != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">method.invoke(instance, object);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;  </span><br><span class=\"line\">logger.error(<span class=\"string\">&quot;fail to inject via method &quot;</span> + method.getName()  </span><br><span class=\"line\">+ <span class=\"string\">&quot; of interface &quot;</span> + type.getName() + <span class=\"string\">&quot;: &quot;</span> + e.getMessage(), e);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;  </span><br><span class=\"line\">logger.error(e.getMessage(), e);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> instance;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可以看出ExtensionLoader持有某一类扩展点的所有扩展，并且扩展以class为key，一个扩展类只有一个实例。<br>如果扩展点使用了Adaptive则会通过字节码生成一个自适应的扩展类。<br>通过createAdaptiveExtensionClassCode方法返回class的code，然后通过Compiler接口返回class对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* Compiler. (SPI, Singleton, ThreadSafe)</span></span><br><span class=\"line\"><span class=\"comment\">* </span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@author</span> william.liangf</span></span><br><span class=\"line\"><span class=\"comment\">*/</span>  </span><br><span class=\"line\"><span class=\"meta\">@SPI(&quot;javassist&quot;)</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">Compiler</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * Compile java source code.</span></span><br><span class=\"line\"><span class=\"comment\">  *</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@param</span> code Java source code</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@param</span> classLoader TODO</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@return</span> Compiled class</span></span><br><span class=\"line\"><span class=\"comment\">    */</span>  </span><br><span class=\"line\">    Class&lt;?&gt; compile(String code, ClassLoader classLoader);</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>Compiler dubbo支持jdk和Javassist两种实现，特别注意一点，JdkCompiler的java版本通过硬编码指定版本为1.6。<br>JdkCompiler首先通过JavaFileObject接口生成java文件，然后通过JavaCompiler接口编译成class文件，最后通过ClassLoader加载生成的class文件。<br>spring名称空间扩展<br>dubbo通过扩展spring的名称空间来读取xml配置。<br>dubbo.xsd是spring schma的扩展文件。作用是定义相关xml元素和名称空间。<br>spring.handlers,spring.schemas是spring在解析xml的时候根据spi机制读取对象的NamespaceHandler和xsd文件位置。<br>很多程序猿使用dubbo开发的时候，会发现ide工具报错，因为xml上面dubbo名称空间的链接打不开，其实这个报错可以无视的，<br>因为spring解析的xml的时候这个网络地址其实是指向spi配置文件里面的一个java类。<br>spring.handlers</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">http\\://code.alibabatech.com/schema/dubbo=com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler</span><br></pre></td></tr></table></figure>\n\n<p>DubboNamespaceHandler则注册了相关自定义元素的解析器</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">/**</span><br><span class=\"line\"> * DubboNamespaceHandler</span><br><span class=\"line\"> * </span><br><span class=\"line\"> * @author william.liangf</span><br><span class=\"line\"> * @export</span><br><span class=\"line\">*/  </span><br><span class=\"line\">public class DubboNamespaceHandler extends NamespaceHandlerSupport &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">static &#123;  </span><br><span class=\"line\">Version.checkDuplicate(DubboNamespaceHandler.class);  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">public void init() &#123;  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;application&quot;, new DubboBeanDefinitionParser(ApplicationConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;module&quot;, new DubboBeanDefinitionParser(ModuleConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;registry&quot;, new DubboBeanDefinitionParser(RegistryConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;monitor&quot;, new DubboBeanDefinitionParser(MonitorConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;provider&quot;, new DubboBeanDefinitionParser(ProviderConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;consumer&quot;, new DubboBeanDefinitionParser(ConsumerConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;protocol&quot;, new DubboBeanDefinitionParser(ProtocolConfig.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;service&quot;, new DubboBeanDefinitionParser(ServiceBean.class, true));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;reference&quot;, new DubboBeanDefinitionParser(ReferenceBean.class, false));  </span><br><span class=\"line\">registerBeanDefinitionParser(&quot;annotation&quot;, new DubboBeanDefinitionParser(AnnotationBean.class, true));  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n"},{"title":"dubbo源码研究之config模块","abbrlink":36986,"date":"2023-06-20T05:51:48.000Z","_content":"# dubbo源码研究之config模块\n\ndubbo模块说明\n- dubbo-common 公共逻辑模块，包括Util类和通用模型\n- dubbo-remoting 远程通讯模块，相当于Dubbo协议的实现，如果RPC用RMI协议则不需要使用此包。\n- dubbo-rpc 远程调用模块，抽象各种协议，以及动态代理，只包含一对一的调用，不关心集群的管理\n- dubbo-cluster 集群模块，将多个服务提供方伪装为一个提供方，包括：负载均衡, 容错，路由等，集群的地址列表可以是静态配置的，也可以是由注册中心下发。\n- dubbo-registry 注册中心模块，基于注册中心下发地址的集群方式，以及对各种注册中心的抽象。\n- dubbo-monitor 监控模块，统计服务调用次数，调用时间的，调用链跟踪的服务。\n- dubbo-config 配置模块，是Dubbo对外的API，用户通过Config使用Dubbo，隐藏Dubbo所有细节。\n- dubbo-container 容器模块，是一个Standlone的容器，以简单的Main加载Spring启动，因为服务通常不需要Tomcat/JBoss等Web容器的特性，没必要用Web容器去加载服务。\n\n今天开始从dubbo入口，config模块开始研究。\nconfig模块和Service模块是API，其他为SPI实现。\nconfig模块uml类图\n\n{% asset_img 1.png  image %}\n\nAbstractConfig类提供几个主要的方法 appendAnnotation，appendProperties，appendParameters，appendAttributes\n其他子类提供相关自身的属性。\nAbstractConfig类里面大量通过 反射和javabean约定获取相关值，特别注意的是toString方法注释提到的防御性容错\n\n{% codeblock  lang:java   %}\n\n    catch (Throwable t) { // 防御性容错  \n    logger.warn(t.getMessage(), t);  \n    return super.toString();  \n    }\n\n{% endcodeblock %}\n\n防御性容错在此处使用，提升代码健壮性。\nAnnotationBean是子类里面一个比较特殊的类。因为该类是处于com.alibaba.dubbo.config.spring包下面。\n该类属于config模块的spring 扩展，支持通过注解来配置dubbo。\nAnnotationBean实现了DisposableBean, BeanFactoryPostProcessor, BeanPostProcessor, ApplicationContextAware这四个接口。\nDisposableBean：资源清理接口\nBeanFactoryPostProcessor，BeanPostProcessor：作用类似，都是在bean创建之后的扩展接口。\nApplicationContextAware：获取spring上下文接口。\n通过该类可以看出，dubbo注解实际上是spring注解的扩展，也就是说使用dubbo注解的前提是使用spring作为dubbo的容器。\n@servcie暴露dubbo服务配置的代码\n\n{% codeblock  lang:java   %}\n\n    public Object postProcessAfterInitialization(Object bean, String beanName)  \n    throws BeansException {  \n    if (! isMatchPackage(bean)) {  \n    return bean;  \n    }  \n    Class<?> clazz = bean.getClass();  \n    if(isProxyBean(bean)){  \n    clazz = AopUtils.getTargetClass(bean);  \n    }  \n    Service service = clazz.getAnnotation(Service.class);  \n    if (service != null) {  \n    ServiceBean<Object> serviceConfig = new ServiceBean<Object>(service);  \n    if (void.class.equals(service.interfaceClass())  \n    && \"\".equals(service.interfaceName())) {  \n    if (clazz.getInterfaces().length > 0) {  \n    serviceConfig.setInterface(clazz.getInterfaces()[0]);  \n    } else {  \n    throw new IllegalStateException(\"Failed to export remote service class \" + clazz.getName() + \", cause: The @Service undefined interfaceClass or interfaceName, and the service class unimplemented any interfaces.\");  \n    }  \n    }  \n    if (applicationContext != null) {  \n    serviceConfig.setApplicationContext(applicationContext);  \n    if (service.registry() != null && service.registry().length > 0) {  \n    List<RegistryConfig> registryConfigs = new ArrayList<RegistryConfig>();  \n    for (String registryId : service.registry()) {  \n    if (registryId != null && registryId.length() > 0) {  \n    registryConfigs.add((RegistryConfig)applicationContext.getBean(registryId, RegistryConfig.class));  \n    }  \n    }  \n    serviceConfig.setRegistries(registryConfigs);  \n    }  \n    if (service.provider() != null && service.provider().length() > 0) {  \n    serviceConfig.setProvider((ProviderConfig)applicationContext.getBean(service.provider(),ProviderConfig.class));  \n    }  \n    if (service.monitor() != null && service.monitor().length() > 0) {  \n    serviceConfig.setMonitor((MonitorConfig)applicationContext.getBean(service.monitor(), MonitorConfig.class));  \n    }  \n    if (service.application() != null && service.application().length() > 0) {  \n    serviceConfig.setApplication((ApplicationConfig)applicationContext.getBean(service.application(), ApplicationConfig.class));  \n    }  \n    if (service.module() != null && service.module().length() > 0) {  \n    serviceConfig.setModule((ModuleConfig)applicationContext.getBean(service.module(), ModuleConfig.class));  \n    }  \n    if (service.provider() != null && service.provider().length() > 0) {  \n    serviceConfig.setProvider((ProviderConfig)applicationContext.getBean(service.provider(), ProviderConfig.class));  \n    } else {\n\n            }  \n            if (service.protocol() != null && service.protocol().length > 0) {  \n                List<ProtocolConfig> protocolConfigs = new ArrayList<ProtocolConfig>();  \n                // modified by lishen; fix dubbo's bug  \n                for (String protocolId : service.protocol()) {  \n                    if (protocolId != null && protocolId.length() > 0) {  \n                        protocolConfigs.add((ProtocolConfig)applicationContext.getBean(protocolId, ProtocolConfig.class));  \n                    }  \n                }  \n                serviceConfig.setProtocols(protocolConfigs);  \n            }  \n            try {  \n                serviceConfig.afterPropertiesSet();  \n            } catch (RuntimeException e) {  \n                throw (RuntimeException) e;  \n            } catch (Exception e) {  \n                throw new IllegalStateException(e.getMessage(), e);  \n            }  \n        }  \n        serviceConfig.setRef(bean);  \n        serviceConfigs.add(serviceConfig);  \n        serviceConfig.export();  \n    }  \n    return bean;  \n    }\n\n{% endcodeblock %}\n\n主要是先获取类上面的@servcie注解，然后new 一个对应的ServiceBean，ServiceBean继承于ServiceConfig，同时实现了spring bean的相关接口 InitializingBean, DisposableBean, ApplicationContextAware, ApplicationListener, BeanNameAware。\n最后该serviceBean保存到线程安全的容器里面去。\n@service解析是在 postProcessAfterInitialization里面\n@Reference解析是在postProcessBeforeInitialization里面，两者的时机是不一样的。\n\n{% codeblock  lang:java   %}\n\n    String key = reference.group() + \"/\" + interfaceName + \":\" + reference.version();  \n    ReferenceBean<?> referenceConfig = referenceConfigs.get(key);\n\n{% endcodeblock %}\n\n从该代码可以看出，服务接口的唯一性，由group，interfaceName 和version一起决定。\n\n","source":"_posts/dubbo源码研究之config模块.md","raw":"---\ntitle: dubbo源码研究之config模块\ntags:\n  - dubbo\nabbrlink: 36986\ndate: 2023-06-20 13:51:48\n---\n# dubbo源码研究之config模块\n\ndubbo模块说明\n- dubbo-common 公共逻辑模块，包括Util类和通用模型\n- dubbo-remoting 远程通讯模块，相当于Dubbo协议的实现，如果RPC用RMI协议则不需要使用此包。\n- dubbo-rpc 远程调用模块，抽象各种协议，以及动态代理，只包含一对一的调用，不关心集群的管理\n- dubbo-cluster 集群模块，将多个服务提供方伪装为一个提供方，包括：负载均衡, 容错，路由等，集群的地址列表可以是静态配置的，也可以是由注册中心下发。\n- dubbo-registry 注册中心模块，基于注册中心下发地址的集群方式，以及对各种注册中心的抽象。\n- dubbo-monitor 监控模块，统计服务调用次数，调用时间的，调用链跟踪的服务。\n- dubbo-config 配置模块，是Dubbo对外的API，用户通过Config使用Dubbo，隐藏Dubbo所有细节。\n- dubbo-container 容器模块，是一个Standlone的容器，以简单的Main加载Spring启动，因为服务通常不需要Tomcat/JBoss等Web容器的特性，没必要用Web容器去加载服务。\n\n今天开始从dubbo入口，config模块开始研究。\nconfig模块和Service模块是API，其他为SPI实现。\nconfig模块uml类图\n\n{% asset_img 1.png  image %}\n\nAbstractConfig类提供几个主要的方法 appendAnnotation，appendProperties，appendParameters，appendAttributes\n其他子类提供相关自身的属性。\nAbstractConfig类里面大量通过 反射和javabean约定获取相关值，特别注意的是toString方法注释提到的防御性容错\n\n{% codeblock  lang:java   %}\n\n    catch (Throwable t) { // 防御性容错  \n    logger.warn(t.getMessage(), t);  \n    return super.toString();  \n    }\n\n{% endcodeblock %}\n\n防御性容错在此处使用，提升代码健壮性。\nAnnotationBean是子类里面一个比较特殊的类。因为该类是处于com.alibaba.dubbo.config.spring包下面。\n该类属于config模块的spring 扩展，支持通过注解来配置dubbo。\nAnnotationBean实现了DisposableBean, BeanFactoryPostProcessor, BeanPostProcessor, ApplicationContextAware这四个接口。\nDisposableBean：资源清理接口\nBeanFactoryPostProcessor，BeanPostProcessor：作用类似，都是在bean创建之后的扩展接口。\nApplicationContextAware：获取spring上下文接口。\n通过该类可以看出，dubbo注解实际上是spring注解的扩展，也就是说使用dubbo注解的前提是使用spring作为dubbo的容器。\n@servcie暴露dubbo服务配置的代码\n\n{% codeblock  lang:java   %}\n\n    public Object postProcessAfterInitialization(Object bean, String beanName)  \n    throws BeansException {  \n    if (! isMatchPackage(bean)) {  \n    return bean;  \n    }  \n    Class<?> clazz = bean.getClass();  \n    if(isProxyBean(bean)){  \n    clazz = AopUtils.getTargetClass(bean);  \n    }  \n    Service service = clazz.getAnnotation(Service.class);  \n    if (service != null) {  \n    ServiceBean<Object> serviceConfig = new ServiceBean<Object>(service);  \n    if (void.class.equals(service.interfaceClass())  \n    && \"\".equals(service.interfaceName())) {  \n    if (clazz.getInterfaces().length > 0) {  \n    serviceConfig.setInterface(clazz.getInterfaces()[0]);  \n    } else {  \n    throw new IllegalStateException(\"Failed to export remote service class \" + clazz.getName() + \", cause: The @Service undefined interfaceClass or interfaceName, and the service class unimplemented any interfaces.\");  \n    }  \n    }  \n    if (applicationContext != null) {  \n    serviceConfig.setApplicationContext(applicationContext);  \n    if (service.registry() != null && service.registry().length > 0) {  \n    List<RegistryConfig> registryConfigs = new ArrayList<RegistryConfig>();  \n    for (String registryId : service.registry()) {  \n    if (registryId != null && registryId.length() > 0) {  \n    registryConfigs.add((RegistryConfig)applicationContext.getBean(registryId, RegistryConfig.class));  \n    }  \n    }  \n    serviceConfig.setRegistries(registryConfigs);  \n    }  \n    if (service.provider() != null && service.provider().length() > 0) {  \n    serviceConfig.setProvider((ProviderConfig)applicationContext.getBean(service.provider(),ProviderConfig.class));  \n    }  \n    if (service.monitor() != null && service.monitor().length() > 0) {  \n    serviceConfig.setMonitor((MonitorConfig)applicationContext.getBean(service.monitor(), MonitorConfig.class));  \n    }  \n    if (service.application() != null && service.application().length() > 0) {  \n    serviceConfig.setApplication((ApplicationConfig)applicationContext.getBean(service.application(), ApplicationConfig.class));  \n    }  \n    if (service.module() != null && service.module().length() > 0) {  \n    serviceConfig.setModule((ModuleConfig)applicationContext.getBean(service.module(), ModuleConfig.class));  \n    }  \n    if (service.provider() != null && service.provider().length() > 0) {  \n    serviceConfig.setProvider((ProviderConfig)applicationContext.getBean(service.provider(), ProviderConfig.class));  \n    } else {\n\n            }  \n            if (service.protocol() != null && service.protocol().length > 0) {  \n                List<ProtocolConfig> protocolConfigs = new ArrayList<ProtocolConfig>();  \n                // modified by lishen; fix dubbo's bug  \n                for (String protocolId : service.protocol()) {  \n                    if (protocolId != null && protocolId.length() > 0) {  \n                        protocolConfigs.add((ProtocolConfig)applicationContext.getBean(protocolId, ProtocolConfig.class));  \n                    }  \n                }  \n                serviceConfig.setProtocols(protocolConfigs);  \n            }  \n            try {  \n                serviceConfig.afterPropertiesSet();  \n            } catch (RuntimeException e) {  \n                throw (RuntimeException) e;  \n            } catch (Exception e) {  \n                throw new IllegalStateException(e.getMessage(), e);  \n            }  \n        }  \n        serviceConfig.setRef(bean);  \n        serviceConfigs.add(serviceConfig);  \n        serviceConfig.export();  \n    }  \n    return bean;  \n    }\n\n{% endcodeblock %}\n\n主要是先获取类上面的@servcie注解，然后new 一个对应的ServiceBean，ServiceBean继承于ServiceConfig，同时实现了spring bean的相关接口 InitializingBean, DisposableBean, ApplicationContextAware, ApplicationListener, BeanNameAware。\n最后该serviceBean保存到线程安全的容器里面去。\n@service解析是在 postProcessAfterInitialization里面\n@Reference解析是在postProcessBeforeInitialization里面，两者的时机是不一样的。\n\n{% codeblock  lang:java   %}\n\n    String key = reference.group() + \"/\" + interfaceName + \":\" + reference.version();  \n    ReferenceBean<?> referenceConfig = referenceConfigs.get(key);\n\n{% endcodeblock %}\n\n从该代码可以看出，服务接口的唯一性，由group，interfaceName 和version一起决定。\n\n","slug":"dubbo源码研究之config模块","published":1,"updated":"2023-12-05T02:48:12.727Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdiw000eorgo4bcfcn68","content":"<h1 id=\"dubbo源码研究之config模块\"><a href=\"#dubbo源码研究之config模块\" class=\"headerlink\" title=\"dubbo源码研究之config模块\"></a>dubbo源码研究之config模块</h1><p>dubbo模块说明</p>\n<ul>\n<li>dubbo-common 公共逻辑模块，包括Util类和通用模型</li>\n<li>dubbo-remoting 远程通讯模块，相当于Dubbo协议的实现，如果RPC用RMI协议则不需要使用此包。</li>\n<li>dubbo-rpc 远程调用模块，抽象各种协议，以及动态代理，只包含一对一的调用，不关心集群的管理</li>\n<li>dubbo-cluster 集群模块，将多个服务提供方伪装为一个提供方，包括：负载均衡, 容错，路由等，集群的地址列表可以是静态配置的，也可以是由注册中心下发。</li>\n<li>dubbo-registry 注册中心模块，基于注册中心下发地址的集群方式，以及对各种注册中心的抽象。</li>\n<li>dubbo-monitor 监控模块，统计服务调用次数，调用时间的，调用链跟踪的服务。</li>\n<li>dubbo-config 配置模块，是Dubbo对外的API，用户通过Config使用Dubbo，隐藏Dubbo所有细节。</li>\n<li>dubbo-container 容器模块，是一个Standlone的容器，以简单的Main加载Spring启动，因为服务通常不需要Tomcat&#x2F;JBoss等Web容器的特性，没必要用Web容器去加载服务。</li>\n</ul>\n<p>今天开始从dubbo入口，config模块开始研究。<br>config模块和Service模块是API，其他为SPI实现。<br>config模块uml类图</p>\n<img src=\"/2023062036986/1.png\" class=\"\" title=\"image\">\n\n<p>AbstractConfig类提供几个主要的方法 appendAnnotation，appendProperties，appendParameters，appendAttributes<br>其他子类提供相关自身的属性。<br>AbstractConfig类里面大量通过 反射和javabean约定获取相关值，特别注意的是toString方法注释提到的防御性容错</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">catch</span> (Throwable t) &#123; <span class=\"comment\">// 防御性容错  </span></span><br><span class=\"line\">logger.warn(t.getMessage(), t);  </span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"built_in\">super</span>.toString();  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>防御性容错在此处使用，提升代码健壮性。<br>AnnotationBean是子类里面一个比较特殊的类。因为该类是处于com.alibaba.dubbo.config.spring包下面。<br>该类属于config模块的spring 扩展，支持通过注解来配置dubbo。<br>AnnotationBean实现了DisposableBean, BeanFactoryPostProcessor, BeanPostProcessor, ApplicationContextAware这四个接口。<br>DisposableBean：资源清理接口<br>BeanFactoryPostProcessor，BeanPostProcessor：作用类似，都是在bean创建之后的扩展接口。<br>ApplicationContextAware：获取spring上下文接口。<br>通过该类可以看出，dubbo注解实际上是spring注解的扩展，也就是说使用dubbo注解的前提是使用spring作为dubbo的容器。<br>@servcie暴露dubbo服务配置的代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> Object <span class=\"title function_\">postProcessAfterInitialization</span><span class=\"params\">(Object bean, String beanName)</span>  </span><br><span class=\"line\"><span class=\"keyword\">throws</span> BeansException &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (! isMatchPackage(bean)) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> bean;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">Class&lt;?&gt; clazz = bean.getClass();  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(isProxyBean(bean))&#123;  </span><br><span class=\"line\">clazz = AopUtils.getTargetClass(bean);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"type\">Service</span> <span class=\"variable\">service</span> <span class=\"operator\">=</span> clazz.getAnnotation(Service.class);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">ServiceBean&lt;Object&gt; serviceConfig = <span class=\"keyword\">new</span> <span class=\"title class_\">ServiceBean</span>&lt;Object&gt;(service);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">void</span>.class.equals(service.interfaceClass())  </span><br><span class=\"line\">&amp;&amp; <span class=\"string\">&quot;&quot;</span>.equals(service.interfaceName())) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (clazz.getInterfaces().length &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setInterface(clazz.getInterfaces()[<span class=\"number\">0</span>]);  </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(<span class=\"string\">&quot;Failed to export remote service class &quot;</span> + clazz.getName() + <span class=\"string\">&quot;, cause: The @Service undefined interfaceClass or interfaceName, and the service class unimplemented any interfaces.&quot;</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (applicationContext != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setApplicationContext(applicationContext);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service.registry() != <span class=\"literal\">null</span> &amp;&amp; service.registry().length &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">List&lt;RegistryConfig&gt; registryConfigs = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;RegistryConfig&gt;();  </span><br><span class=\"line\"><span class=\"keyword\">for</span> (String registryId : service.registry()) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (registryId != <span class=\"literal\">null</span> &amp;&amp; registryId.length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">registryConfigs.add((RegistryConfig)applicationContext.getBean(registryId, RegistryConfig.class));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">serviceConfig.setRegistries(registryConfigs);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service.provider() != <span class=\"literal\">null</span> &amp;&amp; service.provider().length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setProvider((ProviderConfig)applicationContext.getBean(service.provider(),ProviderConfig.class));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service.monitor() != <span class=\"literal\">null</span> &amp;&amp; service.monitor().length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setMonitor((MonitorConfig)applicationContext.getBean(service.monitor(), MonitorConfig.class));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service.application() != <span class=\"literal\">null</span> &amp;&amp; service.application().length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setApplication((ApplicationConfig)applicationContext.getBean(service.application(), ApplicationConfig.class));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service.<span class=\"keyword\">module</span>() != <span class=\"literal\">null</span> &amp;&amp; service.<span class=\"keyword\">module</span>().length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setModule((ModuleConfig)applicationContext.getBean(service.<span class=\"keyword\">module</span>(), ModuleConfig.class));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service.provider() != <span class=\"literal\">null</span> &amp;&amp; service.provider().length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setProvider((ProviderConfig)applicationContext.getBean(service.provider(), ProviderConfig.class));  </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (service.protocol() != <span class=\"literal\">null</span> &amp;&amp; service.protocol().length &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">            List&lt;ProtocolConfig&gt; protocolConfigs = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;ProtocolConfig&gt;();  </span><br><span class=\"line\">            <span class=\"comment\">// modified by lishen; fix dubbo&#x27;s bug  </span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String protocolId : service.protocol()) &#123;  </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (protocolId != <span class=\"literal\">null</span> &amp;&amp; protocolId.length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">                    protocolConfigs.add((ProtocolConfig)applicationContext.getBean(protocolId, ProtocolConfig.class));  </span><br><span class=\"line\">                &#125;  </span><br><span class=\"line\">            &#125;  </span><br><span class=\"line\">            serviceConfig.setProtocols(protocolConfigs);  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">            serviceConfig.afterPropertiesSet();  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (RuntimeException e) &#123;  </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> (RuntimeException) e;  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;  </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(e.getMessage(), e);  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    serviceConfig.setRef(bean);  </span><br><span class=\"line\">    serviceConfigs.add(serviceConfig);  </span><br><span class=\"line\">    serviceConfig.export();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> bean;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>主要是先获取类上面的@servcie注解，然后new 一个对应的ServiceBean，ServiceBean继承于ServiceConfig，同时实现了spring bean的相关接口 InitializingBean, DisposableBean, ApplicationContextAware, ApplicationListener, BeanNameAware。<br>最后该serviceBean保存到线程安全的容器里面去。<br>@service解析是在 postProcessAfterInitialization里面<br>@Reference解析是在postProcessBeforeInitialization里面，两者的时机是不一样的。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">key</span> <span class=\"operator\">=</span> reference.group() + <span class=\"string\">&quot;/&quot;</span> + interfaceName + <span class=\"string\">&quot;:&quot;</span> + reference.version();  </span><br><span class=\"line\">ReferenceBean&lt;?&gt; referenceConfig = referenceConfigs.get(key);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>从该代码可以看出，服务接口的唯一性，由group，interfaceName 和version一起决定。</p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"dubbo源码研究之config模块\"><a href=\"#dubbo源码研究之config模块\" class=\"headerlink\" title=\"dubbo源码研究之config模块\"></a>dubbo源码研究之config模块</h1><p>dubbo模块说明</p>\n<ul>\n<li>dubbo-common 公共逻辑模块，包括Util类和通用模型</li>\n<li>dubbo-remoting 远程通讯模块，相当于Dubbo协议的实现，如果RPC用RMI协议则不需要使用此包。</li>\n<li>dubbo-rpc 远程调用模块，抽象各种协议，以及动态代理，只包含一对一的调用，不关心集群的管理</li>\n<li>dubbo-cluster 集群模块，将多个服务提供方伪装为一个提供方，包括：负载均衡, 容错，路由等，集群的地址列表可以是静态配置的，也可以是由注册中心下发。</li>\n<li>dubbo-registry 注册中心模块，基于注册中心下发地址的集群方式，以及对各种注册中心的抽象。</li>\n<li>dubbo-monitor 监控模块，统计服务调用次数，调用时间的，调用链跟踪的服务。</li>\n<li>dubbo-config 配置模块，是Dubbo对外的API，用户通过Config使用Dubbo，隐藏Dubbo所有细节。</li>\n<li>dubbo-container 容器模块，是一个Standlone的容器，以简单的Main加载Spring启动，因为服务通常不需要Tomcat&#x2F;JBoss等Web容器的特性，没必要用Web容器去加载服务。</li>\n</ul>\n<p>今天开始从dubbo入口，config模块开始研究。<br>config模块和Service模块是API，其他为SPI实现。<br>config模块uml类图</p>\n<img src=\"/2023062036986/1.png\" class=\"\" title=\"image\">\n\n<p>AbstractConfig类提供几个主要的方法 appendAnnotation，appendProperties，appendParameters，appendAttributes<br>其他子类提供相关自身的属性。<br>AbstractConfig类里面大量通过 反射和javabean约定获取相关值，特别注意的是toString方法注释提到的防御性容错</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">catch</span> (Throwable t) &#123; <span class=\"comment\">// 防御性容错  </span></span><br><span class=\"line\">logger.warn(t.getMessage(), t);  </span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"built_in\">super</span>.toString();  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>防御性容错在此处使用，提升代码健壮性。<br>AnnotationBean是子类里面一个比较特殊的类。因为该类是处于com.alibaba.dubbo.config.spring包下面。<br>该类属于config模块的spring 扩展，支持通过注解来配置dubbo。<br>AnnotationBean实现了DisposableBean, BeanFactoryPostProcessor, BeanPostProcessor, ApplicationContextAware这四个接口。<br>DisposableBean：资源清理接口<br>BeanFactoryPostProcessor，BeanPostProcessor：作用类似，都是在bean创建之后的扩展接口。<br>ApplicationContextAware：获取spring上下文接口。<br>通过该类可以看出，dubbo注解实际上是spring注解的扩展，也就是说使用dubbo注解的前提是使用spring作为dubbo的容器。<br>@servcie暴露dubbo服务配置的代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> Object <span class=\"title function_\">postProcessAfterInitialization</span><span class=\"params\">(Object bean, String beanName)</span>  </span><br><span class=\"line\"><span class=\"keyword\">throws</span> BeansException &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (! isMatchPackage(bean)) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> bean;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">Class&lt;?&gt; clazz = bean.getClass();  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(isProxyBean(bean))&#123;  </span><br><span class=\"line\">clazz = AopUtils.getTargetClass(bean);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"type\">Service</span> <span class=\"variable\">service</span> <span class=\"operator\">=</span> clazz.getAnnotation(Service.class);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">ServiceBean&lt;Object&gt; serviceConfig = <span class=\"keyword\">new</span> <span class=\"title class_\">ServiceBean</span>&lt;Object&gt;(service);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">void</span>.class.equals(service.interfaceClass())  </span><br><span class=\"line\">&amp;&amp; <span class=\"string\">&quot;&quot;</span>.equals(service.interfaceName())) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (clazz.getInterfaces().length &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setInterface(clazz.getInterfaces()[<span class=\"number\">0</span>]);  </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(<span class=\"string\">&quot;Failed to export remote service class &quot;</span> + clazz.getName() + <span class=\"string\">&quot;, cause: The @Service undefined interfaceClass or interfaceName, and the service class unimplemented any interfaces.&quot;</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (applicationContext != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setApplicationContext(applicationContext);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service.registry() != <span class=\"literal\">null</span> &amp;&amp; service.registry().length &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">List&lt;RegistryConfig&gt; registryConfigs = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;RegistryConfig&gt;();  </span><br><span class=\"line\"><span class=\"keyword\">for</span> (String registryId : service.registry()) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (registryId != <span class=\"literal\">null</span> &amp;&amp; registryId.length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">registryConfigs.add((RegistryConfig)applicationContext.getBean(registryId, RegistryConfig.class));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">serviceConfig.setRegistries(registryConfigs);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service.provider() != <span class=\"literal\">null</span> &amp;&amp; service.provider().length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setProvider((ProviderConfig)applicationContext.getBean(service.provider(),ProviderConfig.class));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service.monitor() != <span class=\"literal\">null</span> &amp;&amp; service.monitor().length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setMonitor((MonitorConfig)applicationContext.getBean(service.monitor(), MonitorConfig.class));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service.application() != <span class=\"literal\">null</span> &amp;&amp; service.application().length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setApplication((ApplicationConfig)applicationContext.getBean(service.application(), ApplicationConfig.class));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service.<span class=\"keyword\">module</span>() != <span class=\"literal\">null</span> &amp;&amp; service.<span class=\"keyword\">module</span>().length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setModule((ModuleConfig)applicationContext.getBean(service.<span class=\"keyword\">module</span>(), ModuleConfig.class));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (service.provider() != <span class=\"literal\">null</span> &amp;&amp; service.provider().length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">serviceConfig.setProvider((ProviderConfig)applicationContext.getBean(service.provider(), ProviderConfig.class));  </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (service.protocol() != <span class=\"literal\">null</span> &amp;&amp; service.protocol().length &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">            List&lt;ProtocolConfig&gt; protocolConfigs = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;ProtocolConfig&gt;();  </span><br><span class=\"line\">            <span class=\"comment\">// modified by lishen; fix dubbo&#x27;s bug  </span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String protocolId : service.protocol()) &#123;  </span><br><span class=\"line\">                <span class=\"keyword\">if</span> (protocolId != <span class=\"literal\">null</span> &amp;&amp; protocolId.length() &gt; <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">                    protocolConfigs.add((ProtocolConfig)applicationContext.getBean(protocolId, ProtocolConfig.class));  </span><br><span class=\"line\">                &#125;  </span><br><span class=\"line\">            &#125;  </span><br><span class=\"line\">            serviceConfig.setProtocols(protocolConfigs);  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">            serviceConfig.afterPropertiesSet();  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (RuntimeException e) &#123;  </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> (RuntimeException) e;  </span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;  </span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(e.getMessage(), e);  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    serviceConfig.setRef(bean);  </span><br><span class=\"line\">    serviceConfigs.add(serviceConfig);  </span><br><span class=\"line\">    serviceConfig.export();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> bean;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>主要是先获取类上面的@servcie注解，然后new 一个对应的ServiceBean，ServiceBean继承于ServiceConfig，同时实现了spring bean的相关接口 InitializingBean, DisposableBean, ApplicationContextAware, ApplicationListener, BeanNameAware。<br>最后该serviceBean保存到线程安全的容器里面去。<br>@service解析是在 postProcessAfterInitialization里面<br>@Reference解析是在postProcessBeforeInitialization里面，两者的时机是不一样的。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">key</span> <span class=\"operator\">=</span> reference.group() + <span class=\"string\">&quot;/&quot;</span> + interfaceName + <span class=\"string\">&quot;:&quot;</span> + reference.version();  </span><br><span class=\"line\">ReferenceBean&lt;?&gt; referenceConfig = referenceConfigs.get(key);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>从该代码可以看出，服务接口的唯一性，由group，interfaceName 和version一起决定。</p>\n"},{"title":"dubbo源码研究之container模块","abbrlink":172,"date":"2023-06-20T04:25:41.000Z","_content":"# dubbo源码研究之container模块\ndubbo-container模块是dubbo启动顺序中的第一个模块，\ndubbo-container模块是容器模块，通过dubbo-container模块读取dobbo-config模块的相关配置。\n\n{% codeblock lang:java   %}\n\n    /**\n    * Container. (SPI, Singleton, ThreadSafe)\n    * \n    * @author william.liangf\n    */  \n    @SPI(\"spring\")  \n    public interface Container {\n\n    /**\n      * start.\n        */  \n        void start();\n\n    /**\n      * stop.\n        */  \n        void stop();\n    }\n\n{% endcodeblock %}\n\ncontainer接口非常简洁，只有两个方法，start，stop。注意两个方法都是void并且不抛出受检查异常。\n细心的童鞋也可能发现上面的注释，spi，Singleton，ThreadSafe。 说明该接口是基于spi机制，单例，并且线程安全的。\n\nContainer 接口的主要实现\n\n{% asset_img 1.png  image %}\n\n其中JavaConfigContainer是基于spring的javaconfig，其中javaconfig是spring4之后主推的配置模式，\n使用spring boot的童鞋如果和dubbo整合使用零配置的方式可以考虑这个类。\nSpringContainer主要指定了默认的配置文件路径，通过ClassPathXmlApplicationContext来启动spring容器。\n\n{% codeblock lang:java   %}\n    \n    /**\n    * SpringContainer. (SPI, Singleton, ThreadSafe)\n    * \n    * @author william.liangf  \n    */  \n    public class SpringContainer implements Container {\n\n    private static final Logger logger = LoggerFactory.getLogger(SpringContainer.class);\n\n    public static final String SPRING_CONFIG = \"dubbo.spring.config\";\n\n    public static final String DEFAULT_SPRING_CONFIG = \"classpath*:META-INF/spring/*.xml\";\n\n    static ClassPathXmlApplicationContext context;\n\n    public static ClassPathXmlApplicationContext getContext() {  \n    return context;  \n    }\n\n    public void start() {  \n    String configPath = ConfigUtils.getProperty(SPRING_CONFIG);  \n    if (configPath == null || configPath.length() == 0) {  \n    configPath = DEFAULT_SPRING_CONFIG;  \n    }  \n    context = new ClassPathXmlApplicationContext(configPath.split(\"[,\\\\s]+\"));  \n    context.start();  \n    }\n\n    public void stop() {  \n    try {  \n    if (context != null) {  \n    context.stop();  \n    context.close();  \n    context = null;  \n    }  \n    } catch (Throwable e) {  \n    logger.error(e.getMessage(), e);  \n    }  \n    }\n\n}\n\n{% endcodeblock %}\n\n其他几个实现类似，重点讲下com.alibaba.dubbo.container.Main。这个是dubbo自带的main函数入口。\n\n{% codeblock lang:java   %}\n\n        public static void main(String[] args) {  \n        try {  \n        if (args == null || args.length == 0) {  \n        String config = ConfigUtils.getProperty(CONTAINER_KEY, loader.getDefaultExtensionName());  \n        args = Constants.COMMA_SPLIT_PATTERN.split(config);  \n        }\n\n         final List<Container> containers = new ArrayList<Container>();  \n         for (int i = 0; i < args.length; i ++) {  \n             containers.add(loader.getExtension(args[i]));  \n         }  \n         logger.info(\"Use container type(\" + Arrays.toString(args) + \") to run dubbo serivce.\");  \n           \n         if (\"true\".equals(System.getProperty(SHUTDOWN_HOOK_KEY))) {  \n          Runtime.getRuntime().addShutdownHook(new Thread() {  \n              public void run() {  \n                  for (Container container : containers) {  \n                      try {  \n                          container.stop();  \n                          logger.info(\"Dubbo \" + container.getClass().getSimpleName() + \" stopped!\");  \n                      } catch (Throwable t) {  \n                          logger.error(t.getMessage(), t);  \n                      }  \n                      synchronized (Main.class) {  \n                          running = false;  \n                          Main.class.notify();  \n                      }  \n                  }  \n              }  \n          });  \n         }  \n           \n         for (Container container : containers) {  \n             container.start();  \n             logger.info(\"Dubbo \" + container.getClass().getSimpleName() + \" started!\");  \n         }  \n         System.out.println(new SimpleDateFormat(\"[yyyy-MM-dd HH:mm:ss]\").format(new Date()) + \" Dubbo service server started!\");  \n     } catch (RuntimeException e) {  \n         e.printStackTrace();  \n         logger.error(e.getMessage(), e);  \n         System.exit(1);  \n     }  \n     synchronized (Main.class) {  \n         while (running) {  \n             try {  \n                 Main.class.wait();  \n             } catch (Throwable e) {  \n             }  \n         }  \n     }  \n    }\n\n{% endcodeblock %}\n\n该方法通过钩子 Runtime.getRuntime().addShutdownHook来实现优雅停机，同时还支持通过启动参数来加载扩展点，\ncontainers.add(loader.getExtension(args[i]))。但是没有类似spring boot 的CommandLineRunner 接口，\n在容器启动完毕之后执行一些初始化动作。建议使用dubbo的童鞋如没有特殊需求，可以使用该类作为程序启动类。\n\n","source":"_posts/dubbo源码研究之container模块.md","raw":"---\ntitle: dubbo源码研究之container模块\ntags:\n  - dubbo\nabbrlink: 172\ndate: 2023-06-20 12:25:41\n---\n# dubbo源码研究之container模块\ndubbo-container模块是dubbo启动顺序中的第一个模块，\ndubbo-container模块是容器模块，通过dubbo-container模块读取dobbo-config模块的相关配置。\n\n{% codeblock lang:java   %}\n\n    /**\n    * Container. (SPI, Singleton, ThreadSafe)\n    * \n    * @author william.liangf\n    */  \n    @SPI(\"spring\")  \n    public interface Container {\n\n    /**\n      * start.\n        */  \n        void start();\n\n    /**\n      * stop.\n        */  \n        void stop();\n    }\n\n{% endcodeblock %}\n\ncontainer接口非常简洁，只有两个方法，start，stop。注意两个方法都是void并且不抛出受检查异常。\n细心的童鞋也可能发现上面的注释，spi，Singleton，ThreadSafe。 说明该接口是基于spi机制，单例，并且线程安全的。\n\nContainer 接口的主要实现\n\n{% asset_img 1.png  image %}\n\n其中JavaConfigContainer是基于spring的javaconfig，其中javaconfig是spring4之后主推的配置模式，\n使用spring boot的童鞋如果和dubbo整合使用零配置的方式可以考虑这个类。\nSpringContainer主要指定了默认的配置文件路径，通过ClassPathXmlApplicationContext来启动spring容器。\n\n{% codeblock lang:java   %}\n    \n    /**\n    * SpringContainer. (SPI, Singleton, ThreadSafe)\n    * \n    * @author william.liangf  \n    */  \n    public class SpringContainer implements Container {\n\n    private static final Logger logger = LoggerFactory.getLogger(SpringContainer.class);\n\n    public static final String SPRING_CONFIG = \"dubbo.spring.config\";\n\n    public static final String DEFAULT_SPRING_CONFIG = \"classpath*:META-INF/spring/*.xml\";\n\n    static ClassPathXmlApplicationContext context;\n\n    public static ClassPathXmlApplicationContext getContext() {  \n    return context;  \n    }\n\n    public void start() {  \n    String configPath = ConfigUtils.getProperty(SPRING_CONFIG);  \n    if (configPath == null || configPath.length() == 0) {  \n    configPath = DEFAULT_SPRING_CONFIG;  \n    }  \n    context = new ClassPathXmlApplicationContext(configPath.split(\"[,\\\\s]+\"));  \n    context.start();  \n    }\n\n    public void stop() {  \n    try {  \n    if (context != null) {  \n    context.stop();  \n    context.close();  \n    context = null;  \n    }  \n    } catch (Throwable e) {  \n    logger.error(e.getMessage(), e);  \n    }  \n    }\n\n}\n\n{% endcodeblock %}\n\n其他几个实现类似，重点讲下com.alibaba.dubbo.container.Main。这个是dubbo自带的main函数入口。\n\n{% codeblock lang:java   %}\n\n        public static void main(String[] args) {  \n        try {  \n        if (args == null || args.length == 0) {  \n        String config = ConfigUtils.getProperty(CONTAINER_KEY, loader.getDefaultExtensionName());  \n        args = Constants.COMMA_SPLIT_PATTERN.split(config);  \n        }\n\n         final List<Container> containers = new ArrayList<Container>();  \n         for (int i = 0; i < args.length; i ++) {  \n             containers.add(loader.getExtension(args[i]));  \n         }  \n         logger.info(\"Use container type(\" + Arrays.toString(args) + \") to run dubbo serivce.\");  \n           \n         if (\"true\".equals(System.getProperty(SHUTDOWN_HOOK_KEY))) {  \n          Runtime.getRuntime().addShutdownHook(new Thread() {  \n              public void run() {  \n                  for (Container container : containers) {  \n                      try {  \n                          container.stop();  \n                          logger.info(\"Dubbo \" + container.getClass().getSimpleName() + \" stopped!\");  \n                      } catch (Throwable t) {  \n                          logger.error(t.getMessage(), t);  \n                      }  \n                      synchronized (Main.class) {  \n                          running = false;  \n                          Main.class.notify();  \n                      }  \n                  }  \n              }  \n          });  \n         }  \n           \n         for (Container container : containers) {  \n             container.start();  \n             logger.info(\"Dubbo \" + container.getClass().getSimpleName() + \" started!\");  \n         }  \n         System.out.println(new SimpleDateFormat(\"[yyyy-MM-dd HH:mm:ss]\").format(new Date()) + \" Dubbo service server started!\");  \n     } catch (RuntimeException e) {  \n         e.printStackTrace();  \n         logger.error(e.getMessage(), e);  \n         System.exit(1);  \n     }  \n     synchronized (Main.class) {  \n         while (running) {  \n             try {  \n                 Main.class.wait();  \n             } catch (Throwable e) {  \n             }  \n         }  \n     }  \n    }\n\n{% endcodeblock %}\n\n该方法通过钩子 Runtime.getRuntime().addShutdownHook来实现优雅停机，同时还支持通过启动参数来加载扩展点，\ncontainers.add(loader.getExtension(args[i]))。但是没有类似spring boot 的CommandLineRunner 接口，\n在容器启动完毕之后执行一些初始化动作。建议使用dubbo的童鞋如没有特殊需求，可以使用该类作为程序启动类。\n\n","slug":"dubbo源码研究之container模块","published":1,"updated":"2023-12-05T02:48:12.730Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdix000gorgod5b9fmi2","content":"<h1 id=\"dubbo源码研究之container模块\"><a href=\"#dubbo源码研究之container模块\" class=\"headerlink\" title=\"dubbo源码研究之container模块\"></a>dubbo源码研究之container模块</h1><p>dubbo-container模块是dubbo启动顺序中的第一个模块，<br>dubbo-container模块是容器模块，通过dubbo-container模块读取dobbo-config模块的相关配置。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* Container. (SPI, Singleton, ThreadSafe)</span></span><br><span class=\"line\"><span class=\"comment\">* </span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@author</span> william.liangf</span></span><br><span class=\"line\"><span class=\"comment\">*/</span>  </span><br><span class=\"line\"><span class=\"meta\">@SPI(&quot;spring&quot;)</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">Container</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * start.</span></span><br><span class=\"line\"><span class=\"comment\">    */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">start</span><span class=\"params\">()</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * stop.</span></span><br><span class=\"line\"><span class=\"comment\">    */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">stop</span><span class=\"params\">()</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>container接口非常简洁，只有两个方法，start，stop。注意两个方法都是void并且不抛出受检查异常。<br>细心的童鞋也可能发现上面的注释，spi，Singleton，ThreadSafe。 说明该接口是基于spi机制，单例，并且线程安全的。</p>\n<p>Container 接口的主要实现</p>\n<img src=\"/20230620172/1.png\" class=\"\" title=\"image\">\n\n<p>其中JavaConfigContainer是基于spring的javaconfig，其中javaconfig是spring4之后主推的配置模式，<br>使用spring boot的童鞋如果和dubbo整合使用零配置的方式可以考虑这个类。<br>SpringContainer主要指定了默认的配置文件路径，通过ClassPathXmlApplicationContext来启动spring容器。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * SpringContainer. (SPI, Singleton, ThreadSafe)</span></span><br><span class=\"line\"><span class=\"comment\">    * </span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@author</span> william.liangf  </span></span><br><span class=\"line\"><span class=\"comment\">    */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SpringContainer</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Container</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">Logger</span> <span class=\"variable\">logger</span> <span class=\"operator\">=</span> LoggerFactory.getLogger(SpringContainer.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">SPRING_CONFIG</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;dubbo.spring.config&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">DEFAULT_SPRING_CONFIG</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;classpath*:META-INF/spring/*.xml&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> ClassPathXmlApplicationContext context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ClassPathXmlApplicationContext <span class=\"title function_\">getContext</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\">    <span class=\"keyword\">return</span> context;  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">start</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">configPath</span> <span class=\"operator\">=</span> ConfigUtils.getProperty(SPRING_CONFIG);  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (configPath == <span class=\"literal\">null</span> || configPath.length() == <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">    configPath = DEFAULT_SPRING_CONFIG;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    context = <span class=\"keyword\">new</span> <span class=\"title class_\">ClassPathXmlApplicationContext</span>(configPath.split(<span class=\"string\">&quot;[,\\\\s]+&quot;</span>));  </span><br><span class=\"line\">    context.start();  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">stop</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (context != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">    context.stop();  </span><br><span class=\"line\">    context.close();  </span><br><span class=\"line\">    context = <span class=\"literal\">null</span>;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;  </span><br><span class=\"line\">    logger.error(e.getMessage(), e);  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>其他几个实现类似，重点讲下com.alibaba.dubbo.container.Main。这个是dubbo自带的main函数入口。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;  </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (args == <span class=\"literal\">null</span> || args.length == <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">config</span> <span class=\"operator\">=</span> ConfigUtils.getProperty(CONTAINER_KEY, loader.getDefaultExtensionName());  </span><br><span class=\"line\">    args = Constants.COMMA_SPLIT_PATTERN.split(config);  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">final</span> List&lt;Container&gt; containers = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Container&gt;();  </span><br><span class=\"line\">     <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; args.length; i ++) &#123;  </span><br><span class=\"line\">         containers.add(loader.getExtension(args[i]));  </span><br><span class=\"line\">     &#125;  </span><br><span class=\"line\">     logger.info(<span class=\"string\">&quot;Use container type(&quot;</span> + Arrays.toString(args) + <span class=\"string\">&quot;) to run dubbo serivce.&quot;</span>);  </span><br><span class=\"line\">       </span><br><span class=\"line\">     <span class=\"keyword\">if</span> (<span class=\"string\">&quot;true&quot;</span>.equals(System.getProperty(SHUTDOWN_HOOK_KEY))) &#123;  </span><br><span class=\"line\">      Runtime.getRuntime().addShutdownHook(<span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>() &#123;  </span><br><span class=\"line\">          <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\">              <span class=\"keyword\">for</span> (Container container : containers) &#123;  </span><br><span class=\"line\">                  <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">                      container.stop();  </span><br><span class=\"line\">                      logger.info(<span class=\"string\">&quot;Dubbo &quot;</span> + container.getClass().getSimpleName() + <span class=\"string\">&quot; stopped!&quot;</span>);  </span><br><span class=\"line\">                  &#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;  </span><br><span class=\"line\">                      logger.error(t.getMessage(), t);  </span><br><span class=\"line\">                  &#125;  </span><br><span class=\"line\">                  <span class=\"keyword\">synchronized</span> (Main.class) &#123;  </span><br><span class=\"line\">                      running = <span class=\"literal\">false</span>;  </span><br><span class=\"line\">                      Main.class.notify();  </span><br><span class=\"line\">                  &#125;  </span><br><span class=\"line\">              &#125;  </span><br><span class=\"line\">          &#125;  </span><br><span class=\"line\">      &#125;);  </span><br><span class=\"line\">     &#125;  </span><br><span class=\"line\">       </span><br><span class=\"line\">     <span class=\"keyword\">for</span> (Container container : containers) &#123;  </span><br><span class=\"line\">         container.start();  </span><br><span class=\"line\">         logger.info(<span class=\"string\">&quot;Dubbo &quot;</span> + container.getClass().getSimpleName() + <span class=\"string\">&quot; started!&quot;</span>);  </span><br><span class=\"line\">     &#125;  </span><br><span class=\"line\">     System.out.println(<span class=\"keyword\">new</span> <span class=\"title class_\">SimpleDateFormat</span>(<span class=\"string\">&quot;[yyyy-MM-dd HH:mm:ss]&quot;</span>).format(<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>()) + <span class=\"string\">&quot; Dubbo service server started!&quot;</span>);  </span><br><span class=\"line\"> &#125; <span class=\"keyword\">catch</span> (RuntimeException e) &#123;  </span><br><span class=\"line\">     e.printStackTrace();  </span><br><span class=\"line\">     logger.error(e.getMessage(), e);  </span><br><span class=\"line\">     System.exit(<span class=\"number\">1</span>);  </span><br><span class=\"line\"> &#125;  </span><br><span class=\"line\"> <span class=\"keyword\">synchronized</span> (Main.class) &#123;  </span><br><span class=\"line\">     <span class=\"keyword\">while</span> (running) &#123;  </span><br><span class=\"line\">         <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">             Main.class.wait();  </span><br><span class=\"line\">         &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;  </span><br><span class=\"line\">         &#125;  </span><br><span class=\"line\">     &#125;  </span><br><span class=\"line\"> &#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>该方法通过钩子 Runtime.getRuntime().addShutdownHook来实现优雅停机，同时还支持通过启动参数来加载扩展点，<br>containers.add(loader.getExtension(args[i]))。但是没有类似spring boot 的CommandLineRunner 接口，<br>在容器启动完毕之后执行一些初始化动作。建议使用dubbo的童鞋如没有特殊需求，可以使用该类作为程序启动类。</p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"dubbo源码研究之container模块\"><a href=\"#dubbo源码研究之container模块\" class=\"headerlink\" title=\"dubbo源码研究之container模块\"></a>dubbo源码研究之container模块</h1><p>dubbo-container模块是dubbo启动顺序中的第一个模块，<br>dubbo-container模块是容器模块，通过dubbo-container模块读取dobbo-config模块的相关配置。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* Container. (SPI, Singleton, ThreadSafe)</span></span><br><span class=\"line\"><span class=\"comment\">* </span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@author</span> william.liangf</span></span><br><span class=\"line\"><span class=\"comment\">*/</span>  </span><br><span class=\"line\"><span class=\"meta\">@SPI(&quot;spring&quot;)</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">Container</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * start.</span></span><br><span class=\"line\"><span class=\"comment\">    */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">start</span><span class=\"params\">()</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * stop.</span></span><br><span class=\"line\"><span class=\"comment\">    */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">void</span> <span class=\"title function_\">stop</span><span class=\"params\">()</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>container接口非常简洁，只有两个方法，start，stop。注意两个方法都是void并且不抛出受检查异常。<br>细心的童鞋也可能发现上面的注释，spi，Singleton，ThreadSafe。 说明该接口是基于spi机制，单例，并且线程安全的。</p>\n<p>Container 接口的主要实现</p>\n<img src=\"/20230620172/1.png\" class=\"\" title=\"image\">\n\n<p>其中JavaConfigContainer是基于spring的javaconfig，其中javaconfig是spring4之后主推的配置模式，<br>使用spring boot的童鞋如果和dubbo整合使用零配置的方式可以考虑这个类。<br>SpringContainer主要指定了默认的配置文件路径，通过ClassPathXmlApplicationContext来启动spring容器。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * SpringContainer. (SPI, Singleton, ThreadSafe)</span></span><br><span class=\"line\"><span class=\"comment\">    * </span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@author</span> william.liangf  </span></span><br><span class=\"line\"><span class=\"comment\">    */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SpringContainer</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Container</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">Logger</span> <span class=\"variable\">logger</span> <span class=\"operator\">=</span> LoggerFactory.getLogger(SpringContainer.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">SPRING_CONFIG</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;dubbo.spring.config&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">String</span> <span class=\"variable\">DEFAULT_SPRING_CONFIG</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;classpath*:META-INF/spring/*.xml&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> ClassPathXmlApplicationContext context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ClassPathXmlApplicationContext <span class=\"title function_\">getContext</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\">    <span class=\"keyword\">return</span> context;  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">start</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">configPath</span> <span class=\"operator\">=</span> ConfigUtils.getProperty(SPRING_CONFIG);  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (configPath == <span class=\"literal\">null</span> || configPath.length() == <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">    configPath = DEFAULT_SPRING_CONFIG;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    context = <span class=\"keyword\">new</span> <span class=\"title class_\">ClassPathXmlApplicationContext</span>(configPath.split(<span class=\"string\">&quot;[,\\\\s]+&quot;</span>));  </span><br><span class=\"line\">    context.start();  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">stop</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (context != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">    context.stop();  </span><br><span class=\"line\">    context.close();  </span><br><span class=\"line\">    context = <span class=\"literal\">null</span>;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;  </span><br><span class=\"line\">    logger.error(e.getMessage(), e);  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>其他几个实现类似，重点讲下com.alibaba.dubbo.container.Main。这个是dubbo自带的main函数入口。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;  </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (args == <span class=\"literal\">null</span> || args.length == <span class=\"number\">0</span>) &#123;  </span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">config</span> <span class=\"operator\">=</span> ConfigUtils.getProperty(CONTAINER_KEY, loader.getDefaultExtensionName());  </span><br><span class=\"line\">    args = Constants.COMMA_SPLIT_PATTERN.split(config);  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">final</span> List&lt;Container&gt; containers = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;Container&gt;();  </span><br><span class=\"line\">     <span class=\"keyword\">for</span> (<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; args.length; i ++) &#123;  </span><br><span class=\"line\">         containers.add(loader.getExtension(args[i]));  </span><br><span class=\"line\">     &#125;  </span><br><span class=\"line\">     logger.info(<span class=\"string\">&quot;Use container type(&quot;</span> + Arrays.toString(args) + <span class=\"string\">&quot;) to run dubbo serivce.&quot;</span>);  </span><br><span class=\"line\">       </span><br><span class=\"line\">     <span class=\"keyword\">if</span> (<span class=\"string\">&quot;true&quot;</span>.equals(System.getProperty(SHUTDOWN_HOOK_KEY))) &#123;  </span><br><span class=\"line\">      Runtime.getRuntime().addShutdownHook(<span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>() &#123;  </span><br><span class=\"line\">          <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\">              <span class=\"keyword\">for</span> (Container container : containers) &#123;  </span><br><span class=\"line\">                  <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">                      container.stop();  </span><br><span class=\"line\">                      logger.info(<span class=\"string\">&quot;Dubbo &quot;</span> + container.getClass().getSimpleName() + <span class=\"string\">&quot; stopped!&quot;</span>);  </span><br><span class=\"line\">                  &#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;  </span><br><span class=\"line\">                      logger.error(t.getMessage(), t);  </span><br><span class=\"line\">                  &#125;  </span><br><span class=\"line\">                  <span class=\"keyword\">synchronized</span> (Main.class) &#123;  </span><br><span class=\"line\">                      running = <span class=\"literal\">false</span>;  </span><br><span class=\"line\">                      Main.class.notify();  </span><br><span class=\"line\">                  &#125;  </span><br><span class=\"line\">              &#125;  </span><br><span class=\"line\">          &#125;  </span><br><span class=\"line\">      &#125;);  </span><br><span class=\"line\">     &#125;  </span><br><span class=\"line\">       </span><br><span class=\"line\">     <span class=\"keyword\">for</span> (Container container : containers) &#123;  </span><br><span class=\"line\">         container.start();  </span><br><span class=\"line\">         logger.info(<span class=\"string\">&quot;Dubbo &quot;</span> + container.getClass().getSimpleName() + <span class=\"string\">&quot; started!&quot;</span>);  </span><br><span class=\"line\">     &#125;  </span><br><span class=\"line\">     System.out.println(<span class=\"keyword\">new</span> <span class=\"title class_\">SimpleDateFormat</span>(<span class=\"string\">&quot;[yyyy-MM-dd HH:mm:ss]&quot;</span>).format(<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>()) + <span class=\"string\">&quot; Dubbo service server started!&quot;</span>);  </span><br><span class=\"line\"> &#125; <span class=\"keyword\">catch</span> (RuntimeException e) &#123;  </span><br><span class=\"line\">     e.printStackTrace();  </span><br><span class=\"line\">     logger.error(e.getMessage(), e);  </span><br><span class=\"line\">     System.exit(<span class=\"number\">1</span>);  </span><br><span class=\"line\"> &#125;  </span><br><span class=\"line\"> <span class=\"keyword\">synchronized</span> (Main.class) &#123;  </span><br><span class=\"line\">     <span class=\"keyword\">while</span> (running) &#123;  </span><br><span class=\"line\">         <span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">             Main.class.wait();  </span><br><span class=\"line\">         &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;  </span><br><span class=\"line\">         &#125;  </span><br><span class=\"line\">     &#125;  </span><br><span class=\"line\"> &#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>该方法通过钩子 Runtime.getRuntime().addShutdownHook来实现优雅停机，同时还支持通过启动参数来加载扩展点，<br>containers.add(loader.getExtension(args[i]))。但是没有类似spring boot 的CommandLineRunner 接口，<br>在容器启动完毕之后执行一些初始化动作。建议使用dubbo的童鞋如没有特殊需求，可以使用该类作为程序启动类。</p>\n"},{"title":"dubbo源码研究之dubbo-registry模块","abbrlink":32149,"date":"2023-06-19T09:46:19.000Z","_content":"# dubbo源码研究之dubbo-registry模块\ndubbo-registry注册中心模块，基于注册中心下发地址的集群方式，以及对各种注册中心的抽象。\nregistry模块顶层接口为RegistryService和NotifyListener以及一个工厂接口RegistryFactory。\nRegistryService接口包含4个方法。\n- void register(URL url); 注册服务\n- void unregister(URL url); 取消注册\n- void subscribe(URL url, NotifyListener listener); 订阅服务（推）\n- void unsubscribe(URL url, NotifyListener listener);取消订阅\n- List lookup(URL url); 订阅服务（拉）\n\nRegistry模块使用经典的消费者生成者模式，dubbo消费者订阅服务，dubbo服务者注册服务。\nAbstractRegistry为RegistryService接口实现的一个抽象类，提供一些默认实现。\n\n{% codeblock schema.xml lang:java   %}\n\n    public AbstractRegistry(URL url) {  \n    setUrl(url);  \n    // 启动文件保存定时器  \n    syncSaveFile = url.getParameter(Constants.REGISTRY_FILESAVE_SYNC_KEY, false);  \n    String filename = url.getParameter(Constants.FILE_KEY, System.getProperty(\"user.home\") + \"/.dubbo/dubbo-registry-\" + url.getHost() + \".cache\");  \n    File file = null;  \n    if (ConfigUtils.isNotEmpty(filename)) {  \n    file = new File(filename);  \n    if(! file.exists() && file.getParentFile() != null && ! file.getParentFile().exists()){  \n    if(! file.getParentFile().mkdirs()){  \n    throw new IllegalArgumentException(\"Invalid registry store file \" + file + \", cause: Failed to create directory \" + file.getParentFile() + \"!\");  \n    }  \n    }  \n    }  \n    this.file = file;  \n    loadProperties();  \n    notify(url.getBackupUrls());  \n    }\n\n{% endcodeblock %}\n\n可以看出AbstractRegistry类在构建的时候，会去本地磁盘文件读取文件，转成properties对象。\n文件默认路径是user.home/.dubbo/dubbo-registry-host.cache\n读取完之后会把这个url存到本地缓存文件里面去，但是该方法并非递增修改，而且是全部重写文件。\n\n{% codeblock schema.xml lang:java   %}\n\n    public void doSaveProperties(long version) {  \n    if(version < lastCacheChanged.get()){  \n    return;  \n    }  \n    if (file == null) {  \n    return;  \n    }  \n    Properties newProperties = new Properties();  \n    // 保存之前先读取一遍，防止多个注册中心之间冲突  \n    InputStream in = null;  \n    try {  \n    if (file.exists()) {  \n    in = new FileInputStream(file);  \n    newProperties.load(in);  \n    }  \n    } catch (Throwable e) {  \n    logger.warn(\"Failed to load registry store file, cause: \" + e.getMessage(), e);  \n    } finally {  \n    if (in != null) {  \n    try {  \n    in.close();  \n    } catch (IOException e) {  \n    logger.warn(e.getMessage(), e);  \n    }  \n    }  \n    }       \n    // 保存  \n    try {  \n    newProperties.putAll(properties);  \n    File lockfile = new File(file.getAbsolutePath() + \".lock\");  \n    if (!lockfile.exists()) {  \n    lockfile.createNewFile();  \n    }  \n    RandomAccessFile raf = new RandomAccessFile(lockfile, \"rw\");  \n    try {  \n    FileChannel channel = raf.getChannel();  \n    try {  \n    FileLock lock = channel.tryLock();  \n    if (lock == null) {  \n    throw new IOException(\"Can not lock the registry cache file \" + file.getAbsolutePath() + \", ignore and retry later, maybe multi java process use the file, please config: dubbo.registry.file=xxx.properties\");  \n    }  \n    // 保存  \n    try {  \n    if (! file.exists()) {  \n    file.createNewFile();  \n    }  \n    FileOutputStream outputFile = new FileOutputStream(file);    \n    try {  \n    newProperties.store(outputFile, \"Dubbo Registry Cache\");  \n    } finally {  \n    outputFile.close();  \n    }  \n    } finally {  \n    lock.release();  \n    }  \n    } finally {  \n    channel.close();  \n    }  \n    } finally {  \n    raf.close();  \n    }  \n    } catch (Throwable e) {  \n    if (version < lastCacheChanged.get()) {  \n    return;  \n    } else {  \n    registryCacheExecutor.execute(new SaveProperties(lastCacheChanged.incrementAndGet()));  \n    }  \n    logger.warn(\"Failed to save registry store file, cause: \" + e.getMessage(), e);  \n    }  \n    }\n{% endcodeblock %}\n\n如果是两个不同的注册中心，不能使用一个缓存文件。\n值得注意一点的是，多个dubbo服务公用一个cache文件的时候，如果一起启动，可能会出现Failed to load registry store File 这类异常信息，\n这是因为当时该文件其他服务占用了。这种情况开发环境比较多，可以无视掉。因为会重复去注册的，下面会说明，\n但是尽量还是手动指定注册缓存文件比较好。尽量不使用同一个缓存文件。\n\n{% codeblock  lang:xml   %}\n<dubbo:registry address=\"${zookeeper.address}\" file=\".cache/dubbo-registry-car.cache\" />\n{% endcodeblock %}\n\n这样指定的话，缓存文件会在当前工程目录下。\nRegistryService接口的所有方法参数都有URL对象，说明dubbo服务最终是转成URL来注册的。通过URL来表示服务的全部信息。\nFailbackRegistry是AbstractRegistry类的子类，通过模式设计模式扩展，重写了AbstractRegistry类一些实现，并新增模板方法，交个子类去实现。\n\n{% codeblock  lang:java   %}\n\n    public FailbackRegistry(URL url) {  \n    super(url);  \n    int retryPeriod = url.getParameter(Constants.REGISTRY_RETRY_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RETRY_PERIOD);  \n    this.retryFuture = retryExecutor.scheduleWithFixedDelay(new Runnable() {  \n    public void run() {  \n    // 检测并连接注册中心  \n    try {  \n    retry();  \n    } catch (Throwable t) { // 防御性容错  \n    logger.error(\"Unexpected error occur at failed retry, cause: \" + t.getMessage(), t);  \n    }  \n    }  \n    }, retryPeriod, retryPeriod, TimeUnit.MILLISECONDS);  \n    }  \n{% endcodeblock %}\n\nFailbackRegistry构建的时候通过ScheduledExecutorService来延迟执行连接注册中心，默认延迟周期为5秒。\n其中retry()方法从set集合里面取出注册失败的url，然后不断去重新注册。如果注册中心当机了，但是只要注册中心重新启动之后，dubbo还是会去重新注册的。\n\n\n{% codeblock  lang:java   %}\n\n    @Override  \n    public void register(URL url) {  \n    super.register(url);  \n    failedRegistered.remove(url);  \n    failedUnregistered.remove(url);  \n    try {  \n    // 向服务器端发送注册请求  \n    doRegister(url);  \n    } catch (Exception e) {  \n    Throwable t = e;\n\n        // 如果开启了启动时检测，则直接抛出异常  \n        boolean check = getUrl().getParameter(Constants.CHECK_KEY, true)  \n                && url.getParameter(Constants.CHECK_KEY, true)  \n                && ! Constants.CONSUMER_PROTOCOL.equals(url.getProtocol());  \n        boolean skipFailback = t instanceof SkipFailbackWrapperException;  \n        if (check || skipFailback) {  \n            if(skipFailback) {  \n                t = t.getCause();  \n            }  \n            throw new IllegalStateException(\"Failed to register \" + url + \" to registry \" + getUrl().getAddress() + \", cause: \" + t.getMessage(), t);  \n        } else {  \n            logger.error(\"Failed to register \" + url + \", waiting for retry, cause: \" + t.getMessage(), t);  \n        }  \n \n        // 将失败的注册请求记录到失败列表，定时重试  \n        failedRegistered.add(url);  \n    }  \n    }\n\n{% endcodeblock %}\n\nregister方法把具体的注册实现交给子类的doRegister实现。注册失败的都会记录到失败的set集合里面去，值得注意一个check 配置，当设置时，记录失败注册和订阅请求，后台定时重试。\nzookeeper注册中心是dubbo推荐使用的注册中心，本身zookeeper的基于是Paxos，一个分布式一致性算法。\n\n{% asset_img 1.png  image %}\n\n流程：\n1. 服务提供者启动时向/dubbo/com.foo.BarService/providers目录下写入URL\n2. 服务消费者启动时订阅/dubbo/com.foo.BarService/providers目录下的URL向/dubbo/com.foo.BarService/consumers目录下写入自己的URL\n3. 监控中心启动时订阅/dubbo/com.foo.BarService目录下的所有提供者和消费者URL\n\n","source":"_posts/dubbo源码研究之dubbo-registry模块.md","raw":"---\ntitle: dubbo源码研究之dubbo-registry模块\ntags:\n  - dubbo\nabbrlink: 32149\ndate: 2023-06-19 17:46:19\n---\n# dubbo源码研究之dubbo-registry模块\ndubbo-registry注册中心模块，基于注册中心下发地址的集群方式，以及对各种注册中心的抽象。\nregistry模块顶层接口为RegistryService和NotifyListener以及一个工厂接口RegistryFactory。\nRegistryService接口包含4个方法。\n- void register(URL url); 注册服务\n- void unregister(URL url); 取消注册\n- void subscribe(URL url, NotifyListener listener); 订阅服务（推）\n- void unsubscribe(URL url, NotifyListener listener);取消订阅\n- List lookup(URL url); 订阅服务（拉）\n\nRegistry模块使用经典的消费者生成者模式，dubbo消费者订阅服务，dubbo服务者注册服务。\nAbstractRegistry为RegistryService接口实现的一个抽象类，提供一些默认实现。\n\n{% codeblock schema.xml lang:java   %}\n\n    public AbstractRegistry(URL url) {  \n    setUrl(url);  \n    // 启动文件保存定时器  \n    syncSaveFile = url.getParameter(Constants.REGISTRY_FILESAVE_SYNC_KEY, false);  \n    String filename = url.getParameter(Constants.FILE_KEY, System.getProperty(\"user.home\") + \"/.dubbo/dubbo-registry-\" + url.getHost() + \".cache\");  \n    File file = null;  \n    if (ConfigUtils.isNotEmpty(filename)) {  \n    file = new File(filename);  \n    if(! file.exists() && file.getParentFile() != null && ! file.getParentFile().exists()){  \n    if(! file.getParentFile().mkdirs()){  \n    throw new IllegalArgumentException(\"Invalid registry store file \" + file + \", cause: Failed to create directory \" + file.getParentFile() + \"!\");  \n    }  \n    }  \n    }  \n    this.file = file;  \n    loadProperties();  \n    notify(url.getBackupUrls());  \n    }\n\n{% endcodeblock %}\n\n可以看出AbstractRegistry类在构建的时候，会去本地磁盘文件读取文件，转成properties对象。\n文件默认路径是user.home/.dubbo/dubbo-registry-host.cache\n读取完之后会把这个url存到本地缓存文件里面去，但是该方法并非递增修改，而且是全部重写文件。\n\n{% codeblock schema.xml lang:java   %}\n\n    public void doSaveProperties(long version) {  \n    if(version < lastCacheChanged.get()){  \n    return;  \n    }  \n    if (file == null) {  \n    return;  \n    }  \n    Properties newProperties = new Properties();  \n    // 保存之前先读取一遍，防止多个注册中心之间冲突  \n    InputStream in = null;  \n    try {  \n    if (file.exists()) {  \n    in = new FileInputStream(file);  \n    newProperties.load(in);  \n    }  \n    } catch (Throwable e) {  \n    logger.warn(\"Failed to load registry store file, cause: \" + e.getMessage(), e);  \n    } finally {  \n    if (in != null) {  \n    try {  \n    in.close();  \n    } catch (IOException e) {  \n    logger.warn(e.getMessage(), e);  \n    }  \n    }  \n    }       \n    // 保存  \n    try {  \n    newProperties.putAll(properties);  \n    File lockfile = new File(file.getAbsolutePath() + \".lock\");  \n    if (!lockfile.exists()) {  \n    lockfile.createNewFile();  \n    }  \n    RandomAccessFile raf = new RandomAccessFile(lockfile, \"rw\");  \n    try {  \n    FileChannel channel = raf.getChannel();  \n    try {  \n    FileLock lock = channel.tryLock();  \n    if (lock == null) {  \n    throw new IOException(\"Can not lock the registry cache file \" + file.getAbsolutePath() + \", ignore and retry later, maybe multi java process use the file, please config: dubbo.registry.file=xxx.properties\");  \n    }  \n    // 保存  \n    try {  \n    if (! file.exists()) {  \n    file.createNewFile();  \n    }  \n    FileOutputStream outputFile = new FileOutputStream(file);    \n    try {  \n    newProperties.store(outputFile, \"Dubbo Registry Cache\");  \n    } finally {  \n    outputFile.close();  \n    }  \n    } finally {  \n    lock.release();  \n    }  \n    } finally {  \n    channel.close();  \n    }  \n    } finally {  \n    raf.close();  \n    }  \n    } catch (Throwable e) {  \n    if (version < lastCacheChanged.get()) {  \n    return;  \n    } else {  \n    registryCacheExecutor.execute(new SaveProperties(lastCacheChanged.incrementAndGet()));  \n    }  \n    logger.warn(\"Failed to save registry store file, cause: \" + e.getMessage(), e);  \n    }  \n    }\n{% endcodeblock %}\n\n如果是两个不同的注册中心，不能使用一个缓存文件。\n值得注意一点的是，多个dubbo服务公用一个cache文件的时候，如果一起启动，可能会出现Failed to load registry store File 这类异常信息，\n这是因为当时该文件其他服务占用了。这种情况开发环境比较多，可以无视掉。因为会重复去注册的，下面会说明，\n但是尽量还是手动指定注册缓存文件比较好。尽量不使用同一个缓存文件。\n\n{% codeblock  lang:xml   %}\n<dubbo:registry address=\"${zookeeper.address}\" file=\".cache/dubbo-registry-car.cache\" />\n{% endcodeblock %}\n\n这样指定的话，缓存文件会在当前工程目录下。\nRegistryService接口的所有方法参数都有URL对象，说明dubbo服务最终是转成URL来注册的。通过URL来表示服务的全部信息。\nFailbackRegistry是AbstractRegistry类的子类，通过模式设计模式扩展，重写了AbstractRegistry类一些实现，并新增模板方法，交个子类去实现。\n\n{% codeblock  lang:java   %}\n\n    public FailbackRegistry(URL url) {  \n    super(url);  \n    int retryPeriod = url.getParameter(Constants.REGISTRY_RETRY_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RETRY_PERIOD);  \n    this.retryFuture = retryExecutor.scheduleWithFixedDelay(new Runnable() {  \n    public void run() {  \n    // 检测并连接注册中心  \n    try {  \n    retry();  \n    } catch (Throwable t) { // 防御性容错  \n    logger.error(\"Unexpected error occur at failed retry, cause: \" + t.getMessage(), t);  \n    }  \n    }  \n    }, retryPeriod, retryPeriod, TimeUnit.MILLISECONDS);  \n    }  \n{% endcodeblock %}\n\nFailbackRegistry构建的时候通过ScheduledExecutorService来延迟执行连接注册中心，默认延迟周期为5秒。\n其中retry()方法从set集合里面取出注册失败的url，然后不断去重新注册。如果注册中心当机了，但是只要注册中心重新启动之后，dubbo还是会去重新注册的。\n\n\n{% codeblock  lang:java   %}\n\n    @Override  \n    public void register(URL url) {  \n    super.register(url);  \n    failedRegistered.remove(url);  \n    failedUnregistered.remove(url);  \n    try {  \n    // 向服务器端发送注册请求  \n    doRegister(url);  \n    } catch (Exception e) {  \n    Throwable t = e;\n\n        // 如果开启了启动时检测，则直接抛出异常  \n        boolean check = getUrl().getParameter(Constants.CHECK_KEY, true)  \n                && url.getParameter(Constants.CHECK_KEY, true)  \n                && ! Constants.CONSUMER_PROTOCOL.equals(url.getProtocol());  \n        boolean skipFailback = t instanceof SkipFailbackWrapperException;  \n        if (check || skipFailback) {  \n            if(skipFailback) {  \n                t = t.getCause();  \n            }  \n            throw new IllegalStateException(\"Failed to register \" + url + \" to registry \" + getUrl().getAddress() + \", cause: \" + t.getMessage(), t);  \n        } else {  \n            logger.error(\"Failed to register \" + url + \", waiting for retry, cause: \" + t.getMessage(), t);  \n        }  \n \n        // 将失败的注册请求记录到失败列表，定时重试  \n        failedRegistered.add(url);  \n    }  \n    }\n\n{% endcodeblock %}\n\nregister方法把具体的注册实现交给子类的doRegister实现。注册失败的都会记录到失败的set集合里面去，值得注意一个check 配置，当设置时，记录失败注册和订阅请求，后台定时重试。\nzookeeper注册中心是dubbo推荐使用的注册中心，本身zookeeper的基于是Paxos，一个分布式一致性算法。\n\n{% asset_img 1.png  image %}\n\n流程：\n1. 服务提供者启动时向/dubbo/com.foo.BarService/providers目录下写入URL\n2. 服务消费者启动时订阅/dubbo/com.foo.BarService/providers目录下的URL向/dubbo/com.foo.BarService/consumers目录下写入自己的URL\n3. 监控中心启动时订阅/dubbo/com.foo.BarService目录下的所有提供者和消费者URL\n\n","slug":"dubbo源码研究之dubbo-registry模块","published":1,"updated":"2023-12-05T02:48:12.731Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdiy000iorgohohyfuk3","content":"<h1 id=\"dubbo源码研究之dubbo-registry模块\"><a href=\"#dubbo源码研究之dubbo-registry模块\" class=\"headerlink\" title=\"dubbo源码研究之dubbo-registry模块\"></a>dubbo源码研究之dubbo-registry模块</h1><p>dubbo-registry注册中心模块，基于注册中心下发地址的集群方式，以及对各种注册中心的抽象。<br>registry模块顶层接口为RegistryService和NotifyListener以及一个工厂接口RegistryFactory。<br>RegistryService接口包含4个方法。</p>\n<ul>\n<li>void register(URL url); 注册服务</li>\n<li>void unregister(URL url); 取消注册</li>\n<li>void subscribe(URL url, NotifyListener listener); 订阅服务（推）</li>\n<li>void unsubscribe(URL url, NotifyListener listener);取消订阅</li>\n<li>List lookup(URL url); 订阅服务（拉）</li>\n</ul>\n<p>Registry模块使用经典的消费者生成者模式，dubbo消费者订阅服务，dubbo服务者注册服务。<br>AbstractRegistry为RegistryService接口实现的一个抽象类，提供一些默认实现。</p>\n<figure class=\"highlight java\"><figcaption><span>schema.xml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">AbstractRegistry</span><span class=\"params\">(URL url)</span> &#123;  </span><br><span class=\"line\">setUrl(url);  </span><br><span class=\"line\"><span class=\"comment\">// 启动文件保存定时器  </span></span><br><span class=\"line\">syncSaveFile = url.getParameter(Constants.REGISTRY_FILESAVE_SYNC_KEY, <span class=\"literal\">false</span>);  </span><br><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">filename</span> <span class=\"operator\">=</span> url.getParameter(Constants.FILE_KEY, System.getProperty(<span class=\"string\">&quot;user.home&quot;</span>) + <span class=\"string\">&quot;/.dubbo/dubbo-registry-&quot;</span> + url.getHost() + <span class=\"string\">&quot;.cache&quot;</span>);  </span><br><span class=\"line\"><span class=\"type\">File</span> <span class=\"variable\">file</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (ConfigUtils.isNotEmpty(filename)) &#123;  </span><br><span class=\"line\">file = <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(filename);  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(! file.exists() &amp;&amp; file.getParentFile() != <span class=\"literal\">null</span> &amp;&amp; ! file.getParentFile().exists())&#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(! file.getParentFile().mkdirs())&#123;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Invalid registry store file &quot;</span> + file + <span class=\"string\">&quot;, cause: Failed to create directory &quot;</span> + file.getParentFile() + <span class=\"string\">&quot;!&quot;</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"built_in\">this</span>.file = file;  </span><br><span class=\"line\">loadProperties();  </span><br><span class=\"line\">notify(url.getBackupUrls());  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>可以看出AbstractRegistry类在构建的时候，会去本地磁盘文件读取文件，转成properties对象。<br>文件默认路径是user.home&#x2F;.dubbo&#x2F;dubbo-registry-host.cache<br>读取完之后会把这个url存到本地缓存文件里面去，但是该方法并非递增修改，而且是全部重写文件。</p>\n<figure class=\"highlight java\"><figcaption><span>schema.xml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">doSaveProperties</span><span class=\"params\">(<span class=\"type\">long</span> version)</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(version &lt; lastCacheChanged.get())&#123;  </span><br><span class=\"line\"><span class=\"keyword\">return</span>;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (file == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">return</span>;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"type\">Properties</span> <span class=\"variable\">newProperties</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Properties</span>();  </span><br><span class=\"line\"><span class=\"comment\">// 保存之前先读取一遍，防止多个注册中心之间冲突  </span></span><br><span class=\"line\"><span class=\"type\">InputStream</span> <span class=\"variable\">in</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (file.exists()) &#123;  </span><br><span class=\"line\">in = <span class=\"keyword\">new</span> <span class=\"title class_\">FileInputStream</span>(file);  </span><br><span class=\"line\">newProperties.load(in);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;  </span><br><span class=\"line\">logger.warn(<span class=\"string\">&quot;Failed to load registry store file, cause: &quot;</span> + e.getMessage(), e);  </span><br><span class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (in != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">in.close();  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (IOException e) &#123;  </span><br><span class=\"line\">logger.warn(e.getMessage(), e);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;       </span><br><span class=\"line\"><span class=\"comment\">// 保存  </span></span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">newProperties.putAll(properties);  </span><br><span class=\"line\"><span class=\"type\">File</span> <span class=\"variable\">lockfile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(file.getAbsolutePath() + <span class=\"string\">&quot;.lock&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (!lockfile.exists()) &#123;  </span><br><span class=\"line\">lockfile.createNewFile();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"type\">RandomAccessFile</span> <span class=\"variable\">raf</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RandomAccessFile</span>(lockfile, <span class=\"string\">&quot;rw&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"type\">FileChannel</span> <span class=\"variable\">channel</span> <span class=\"operator\">=</span> raf.getChannel();  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"type\">FileLock</span> <span class=\"variable\">lock</span> <span class=\"operator\">=</span> channel.tryLock();  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (lock == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IOException</span>(<span class=\"string\">&quot;Can not lock the registry cache file &quot;</span> + file.getAbsolutePath() + <span class=\"string\">&quot;, ignore and retry later, maybe multi java process use the file, please config: dubbo.registry.file=xxx.properties&quot;</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"comment\">// 保存  </span></span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (! file.exists()) &#123;  </span><br><span class=\"line\">file.createNewFile();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"type\">FileOutputStream</span> <span class=\"variable\">outputFile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FileOutputStream</span>(file);    </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">newProperties.store(outputFile, <span class=\"string\">&quot;Dubbo Registry Cache&quot;</span>);  </span><br><span class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;  </span><br><span class=\"line\">outputFile.close();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;  </span><br><span class=\"line\">lock.release();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;  </span><br><span class=\"line\">channel.close();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;  </span><br><span class=\"line\">raf.close();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (version &lt; lastCacheChanged.get()) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">return</span>;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\">registryCacheExecutor.execute(<span class=\"keyword\">new</span> <span class=\"title class_\">SaveProperties</span>(lastCacheChanged.incrementAndGet()));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">logger.warn(<span class=\"string\">&quot;Failed to save registry store file, cause: &quot;</span> + e.getMessage(), e);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果是两个不同的注册中心，不能使用一个缓存文件。<br>值得注意一点的是，多个dubbo服务公用一个cache文件的时候，如果一起启动，可能会出现Failed to load registry store File 这类异常信息，<br>这是因为当时该文件其他服务占用了。这种情况开发环境比较多，可以无视掉。因为会重复去注册的，下面会说明，<br>但是尽量还是手动指定注册缓存文件比较好。尽量不使用同一个缓存文件。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dubbo:registry</span> <span class=\"attr\">address</span>=<span class=\"string\">&quot;$&#123;zookeeper.address&#125;&quot;</span> <span class=\"attr\">file</span>=<span class=\"string\">&quot;.cache/dubbo-registry-car.cache&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>这样指定的话，缓存文件会在当前工程目录下。<br>RegistryService接口的所有方法参数都有URL对象，说明dubbo服务最终是转成URL来注册的。通过URL来表示服务的全部信息。<br>FailbackRegistry是AbstractRegistry类的子类，通过模式设计模式扩展，重写了AbstractRegistry类一些实现，并新增模板方法，交个子类去实现。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">FailbackRegistry</span><span class=\"params\">(URL url)</span> &#123;  </span><br><span class=\"line\"><span class=\"built_in\">super</span>(url);  </span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">retryPeriod</span> <span class=\"operator\">=</span> url.getParameter(Constants.REGISTRY_RETRY_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RETRY_PERIOD);  </span><br><span class=\"line\"><span class=\"built_in\">this</span>.retryFuture = retryExecutor.scheduleWithFixedDelay(<span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123;  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\"><span class=\"comment\">// 检测并连接注册中心  </span></span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">retry();  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Throwable t) &#123; <span class=\"comment\">// 防御性容错  </span></span><br><span class=\"line\">logger.error(<span class=\"string\">&quot;Unexpected error occur at failed retry, cause: &quot;</span> + t.getMessage(), t);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;, retryPeriod, retryPeriod, TimeUnit.MILLISECONDS);  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<p>FailbackRegistry构建的时候通过ScheduledExecutorService来延迟执行连接注册中心，默认延迟周期为5秒。<br>其中retry()方法从set集合里面取出注册失败的url，然后不断去重新注册。如果注册中心当机了，但是只要注册中心重新启动之后，dubbo还是会去重新注册的。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">register</span><span class=\"params\">(URL url)</span> &#123;  </span><br><span class=\"line\"><span class=\"built_in\">super</span>.register(url);  </span><br><span class=\"line\">failedRegistered.remove(url);  </span><br><span class=\"line\">failedUnregistered.remove(url);  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"comment\">// 向服务器端发送注册请求  </span></span><br><span class=\"line\">doRegister(url);  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;  </span><br><span class=\"line\"><span class=\"type\">Throwable</span> <span class=\"variable\">t</span> <span class=\"operator\">=</span> e;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 如果开启了启动时检测，则直接抛出异常  </span></span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">check</span> <span class=\"operator\">=</span> getUrl().getParameter(Constants.CHECK_KEY, <span class=\"literal\">true</span>)  </span><br><span class=\"line\">            &amp;&amp; url.getParameter(Constants.CHECK_KEY, <span class=\"literal\">true</span>)  </span><br><span class=\"line\">            &amp;&amp; ! Constants.CONSUMER_PROTOCOL.equals(url.getProtocol());  </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">skipFailback</span> <span class=\"operator\">=</span> t <span class=\"keyword\">instanceof</span> SkipFailbackWrapperException;  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (check || skipFailback) &#123;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span>(skipFailback) &#123;  </span><br><span class=\"line\">            t = t.getCause();  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(<span class=\"string\">&quot;Failed to register &quot;</span> + url + <span class=\"string\">&quot; to registry &quot;</span> + getUrl().getAddress() + <span class=\"string\">&quot;, cause: &quot;</span> + t.getMessage(), t);  </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\">        logger.error(<span class=\"string\">&quot;Failed to register &quot;</span> + url + <span class=\"string\">&quot;, waiting for retry, cause: &quot;</span> + t.getMessage(), t);  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">// 将失败的注册请求记录到失败列表，定时重试  </span></span><br><span class=\"line\">    failedRegistered.add(url);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>register方法把具体的注册实现交给子类的doRegister实现。注册失败的都会记录到失败的set集合里面去，值得注意一个check 配置，当设置时，记录失败注册和订阅请求，后台定时重试。<br>zookeeper注册中心是dubbo推荐使用的注册中心，本身zookeeper的基于是Paxos，一个分布式一致性算法。</p>\n<img src=\"/2023061932149/1.png\" class=\"\" title=\"image\">\n\n<p>流程：</p>\n<ol>\n<li>服务提供者启动时向&#x2F;dubbo&#x2F;com.foo.BarService&#x2F;providers目录下写入URL</li>\n<li>服务消费者启动时订阅&#x2F;dubbo&#x2F;com.foo.BarService&#x2F;providers目录下的URL向&#x2F;dubbo&#x2F;com.foo.BarService&#x2F;consumers目录下写入自己的URL</li>\n<li>监控中心启动时订阅&#x2F;dubbo&#x2F;com.foo.BarService目录下的所有提供者和消费者URL</li>\n</ol>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"dubbo源码研究之dubbo-registry模块\"><a href=\"#dubbo源码研究之dubbo-registry模块\" class=\"headerlink\" title=\"dubbo源码研究之dubbo-registry模块\"></a>dubbo源码研究之dubbo-registry模块</h1><p>dubbo-registry注册中心模块，基于注册中心下发地址的集群方式，以及对各种注册中心的抽象。<br>registry模块顶层接口为RegistryService和NotifyListener以及一个工厂接口RegistryFactory。<br>RegistryService接口包含4个方法。</p>\n<ul>\n<li>void register(URL url); 注册服务</li>\n<li>void unregister(URL url); 取消注册</li>\n<li>void subscribe(URL url, NotifyListener listener); 订阅服务（推）</li>\n<li>void unsubscribe(URL url, NotifyListener listener);取消订阅</li>\n<li>List lookup(URL url); 订阅服务（拉）</li>\n</ul>\n<p>Registry模块使用经典的消费者生成者模式，dubbo消费者订阅服务，dubbo服务者注册服务。<br>AbstractRegistry为RegistryService接口实现的一个抽象类，提供一些默认实现。</p>\n<figure class=\"highlight java\"><figcaption><span>schema.xml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">AbstractRegistry</span><span class=\"params\">(URL url)</span> &#123;  </span><br><span class=\"line\">setUrl(url);  </span><br><span class=\"line\"><span class=\"comment\">// 启动文件保存定时器  </span></span><br><span class=\"line\">syncSaveFile = url.getParameter(Constants.REGISTRY_FILESAVE_SYNC_KEY, <span class=\"literal\">false</span>);  </span><br><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">filename</span> <span class=\"operator\">=</span> url.getParameter(Constants.FILE_KEY, System.getProperty(<span class=\"string\">&quot;user.home&quot;</span>) + <span class=\"string\">&quot;/.dubbo/dubbo-registry-&quot;</span> + url.getHost() + <span class=\"string\">&quot;.cache&quot;</span>);  </span><br><span class=\"line\"><span class=\"type\">File</span> <span class=\"variable\">file</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (ConfigUtils.isNotEmpty(filename)) &#123;  </span><br><span class=\"line\">file = <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(filename);  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(! file.exists() &amp;&amp; file.getParentFile() != <span class=\"literal\">null</span> &amp;&amp; ! file.getParentFile().exists())&#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(! file.getParentFile().mkdirs())&#123;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Invalid registry store file &quot;</span> + file + <span class=\"string\">&quot;, cause: Failed to create directory &quot;</span> + file.getParentFile() + <span class=\"string\">&quot;!&quot;</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"built_in\">this</span>.file = file;  </span><br><span class=\"line\">loadProperties();  </span><br><span class=\"line\">notify(url.getBackupUrls());  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>可以看出AbstractRegistry类在构建的时候，会去本地磁盘文件读取文件，转成properties对象。<br>文件默认路径是user.home&#x2F;.dubbo&#x2F;dubbo-registry-host.cache<br>读取完之后会把这个url存到本地缓存文件里面去，但是该方法并非递增修改，而且是全部重写文件。</p>\n<figure class=\"highlight java\"><figcaption><span>schema.xml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">doSaveProperties</span><span class=\"params\">(<span class=\"type\">long</span> version)</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(version &lt; lastCacheChanged.get())&#123;  </span><br><span class=\"line\"><span class=\"keyword\">return</span>;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (file == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">return</span>;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"type\">Properties</span> <span class=\"variable\">newProperties</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Properties</span>();  </span><br><span class=\"line\"><span class=\"comment\">// 保存之前先读取一遍，防止多个注册中心之间冲突  </span></span><br><span class=\"line\"><span class=\"type\">InputStream</span> <span class=\"variable\">in</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (file.exists()) &#123;  </span><br><span class=\"line\">in = <span class=\"keyword\">new</span> <span class=\"title class_\">FileInputStream</span>(file);  </span><br><span class=\"line\">newProperties.load(in);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;  </span><br><span class=\"line\">logger.warn(<span class=\"string\">&quot;Failed to load registry store file, cause: &quot;</span> + e.getMessage(), e);  </span><br><span class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (in != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">in.close();  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (IOException e) &#123;  </span><br><span class=\"line\">logger.warn(e.getMessage(), e);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;       </span><br><span class=\"line\"><span class=\"comment\">// 保存  </span></span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">newProperties.putAll(properties);  </span><br><span class=\"line\"><span class=\"type\">File</span> <span class=\"variable\">lockfile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(file.getAbsolutePath() + <span class=\"string\">&quot;.lock&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (!lockfile.exists()) &#123;  </span><br><span class=\"line\">lockfile.createNewFile();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"type\">RandomAccessFile</span> <span class=\"variable\">raf</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">RandomAccessFile</span>(lockfile, <span class=\"string\">&quot;rw&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"type\">FileChannel</span> <span class=\"variable\">channel</span> <span class=\"operator\">=</span> raf.getChannel();  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"type\">FileLock</span> <span class=\"variable\">lock</span> <span class=\"operator\">=</span> channel.tryLock();  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (lock == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IOException</span>(<span class=\"string\">&quot;Can not lock the registry cache file &quot;</span> + file.getAbsolutePath() + <span class=\"string\">&quot;, ignore and retry later, maybe multi java process use the file, please config: dubbo.registry.file=xxx.properties&quot;</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"comment\">// 保存  </span></span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (! file.exists()) &#123;  </span><br><span class=\"line\">file.createNewFile();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"type\">FileOutputStream</span> <span class=\"variable\">outputFile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FileOutputStream</span>(file);    </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">newProperties.store(outputFile, <span class=\"string\">&quot;Dubbo Registry Cache&quot;</span>);  </span><br><span class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;  </span><br><span class=\"line\">outputFile.close();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;  </span><br><span class=\"line\">lock.release();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;  </span><br><span class=\"line\">channel.close();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;  </span><br><span class=\"line\">raf.close();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (version &lt; lastCacheChanged.get()) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">return</span>;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\">registryCacheExecutor.execute(<span class=\"keyword\">new</span> <span class=\"title class_\">SaveProperties</span>(lastCacheChanged.incrementAndGet()));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">logger.warn(<span class=\"string\">&quot;Failed to save registry store file, cause: &quot;</span> + e.getMessage(), e);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果是两个不同的注册中心，不能使用一个缓存文件。<br>值得注意一点的是，多个dubbo服务公用一个cache文件的时候，如果一起启动，可能会出现Failed to load registry store File 这类异常信息，<br>这是因为当时该文件其他服务占用了。这种情况开发环境比较多，可以无视掉。因为会重复去注册的，下面会说明，<br>但是尽量还是手动指定注册缓存文件比较好。尽量不使用同一个缓存文件。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dubbo:registry</span> <span class=\"attr\">address</span>=<span class=\"string\">&quot;$&#123;zookeeper.address&#125;&quot;</span> <span class=\"attr\">file</span>=<span class=\"string\">&quot;.cache/dubbo-registry-car.cache&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>这样指定的话，缓存文件会在当前工程目录下。<br>RegistryService接口的所有方法参数都有URL对象，说明dubbo服务最终是转成URL来注册的。通过URL来表示服务的全部信息。<br>FailbackRegistry是AbstractRegistry类的子类，通过模式设计模式扩展，重写了AbstractRegistry类一些实现，并新增模板方法，交个子类去实现。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">FailbackRegistry</span><span class=\"params\">(URL url)</span> &#123;  </span><br><span class=\"line\"><span class=\"built_in\">super</span>(url);  </span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">retryPeriod</span> <span class=\"operator\">=</span> url.getParameter(Constants.REGISTRY_RETRY_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RETRY_PERIOD);  </span><br><span class=\"line\"><span class=\"built_in\">this</span>.retryFuture = retryExecutor.scheduleWithFixedDelay(<span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123;  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\"><span class=\"comment\">// 检测并连接注册中心  </span></span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">retry();  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Throwable t) &#123; <span class=\"comment\">// 防御性容错  </span></span><br><span class=\"line\">logger.error(<span class=\"string\">&quot;Unexpected error occur at failed retry, cause: &quot;</span> + t.getMessage(), t);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;, retryPeriod, retryPeriod, TimeUnit.MILLISECONDS);  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<p>FailbackRegistry构建的时候通过ScheduledExecutorService来延迟执行连接注册中心，默认延迟周期为5秒。<br>其中retry()方法从set集合里面取出注册失败的url，然后不断去重新注册。如果注册中心当机了，但是只要注册中心重新启动之后，dubbo还是会去重新注册的。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Override</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">register</span><span class=\"params\">(URL url)</span> &#123;  </span><br><span class=\"line\"><span class=\"built_in\">super</span>.register(url);  </span><br><span class=\"line\">failedRegistered.remove(url);  </span><br><span class=\"line\">failedUnregistered.remove(url);  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\"><span class=\"comment\">// 向服务器端发送注册请求  </span></span><br><span class=\"line\">doRegister(url);  </span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;  </span><br><span class=\"line\"><span class=\"type\">Throwable</span> <span class=\"variable\">t</span> <span class=\"operator\">=</span> e;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 如果开启了启动时检测，则直接抛出异常  </span></span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">check</span> <span class=\"operator\">=</span> getUrl().getParameter(Constants.CHECK_KEY, <span class=\"literal\">true</span>)  </span><br><span class=\"line\">            &amp;&amp; url.getParameter(Constants.CHECK_KEY, <span class=\"literal\">true</span>)  </span><br><span class=\"line\">            &amp;&amp; ! Constants.CONSUMER_PROTOCOL.equals(url.getProtocol());  </span><br><span class=\"line\">    <span class=\"type\">boolean</span> <span class=\"variable\">skipFailback</span> <span class=\"operator\">=</span> t <span class=\"keyword\">instanceof</span> SkipFailbackWrapperException;  </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (check || skipFailback) &#123;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span>(skipFailback) &#123;  </span><br><span class=\"line\">            t = t.getCause();  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalStateException</span>(<span class=\"string\">&quot;Failed to register &quot;</span> + url + <span class=\"string\">&quot; to registry &quot;</span> + getUrl().getAddress() + <span class=\"string\">&quot;, cause: &quot;</span> + t.getMessage(), t);  </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\">        logger.error(<span class=\"string\">&quot;Failed to register &quot;</span> + url + <span class=\"string\">&quot;, waiting for retry, cause: &quot;</span> + t.getMessage(), t);  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">// 将失败的注册请求记录到失败列表，定时重试  </span></span><br><span class=\"line\">    failedRegistered.add(url);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>register方法把具体的注册实现交给子类的doRegister实现。注册失败的都会记录到失败的set集合里面去，值得注意一个check 配置，当设置时，记录失败注册和订阅请求，后台定时重试。<br>zookeeper注册中心是dubbo推荐使用的注册中心，本身zookeeper的基于是Paxos，一个分布式一致性算法。</p>\n<img src=\"/2023061932149/1.png\" class=\"\" title=\"image\">\n\n<p>流程：</p>\n<ol>\n<li>服务提供者启动时向&#x2F;dubbo&#x2F;com.foo.BarService&#x2F;providers目录下写入URL</li>\n<li>服务消费者启动时订阅&#x2F;dubbo&#x2F;com.foo.BarService&#x2F;providers目录下的URL向&#x2F;dubbo&#x2F;com.foo.BarService&#x2F;consumers目录下写入自己的URL</li>\n<li>监控中心启动时订阅&#x2F;dubbo&#x2F;com.foo.BarService目录下的所有提供者和消费者URL</li>\n</ol>\n"},{"title":"dubbo源码研究之extension模块","abbrlink":40013,"date":"2023-06-19T09:20:53.000Z","_content":"# dubbo源码研究之extension模块\n\ndubbo的扩展采用spi机制实现，\nspi（Service Provider Interface）是指一些提供给你继承、扩展，完成自定义功能的类、接口或者方法。\nspi把控制权利交个调用方，调用方来决定使用该spi的哪个实现。\ndubbo扩展机制的核心类是ExtensionLoader，该类通过静态方法getExtensionLoader获取一个指定接口的ExtensionLoader实例。\n\n{% codeblock ExtensionLoader.java  lang:java  %}\n\n    @SuppressWarnings(\"unchecked\")  \n    public static <T> ExtensionLoader<T> getExtensionLoader(Class<T> type) {  \n    if (type == null)  \n    throw new IllegalArgumentException(\"Extension type == null\");  \n    if(!type.isInterface()) {  \n    throw new IllegalArgumentException(\"Extension type(\" + type + \") is not interface!\");  \n    }  \n    if(!withExtensionAnnotation(type)) {  \n    throw new IllegalArgumentException(\"Extension type(\" + type +   \n    \") is not extension, because WITHOUT @\" + SPI.class.getSimpleName() + \" Annotation!\");  \n    }\n    \n    ExtensionLoader<T> loader = (ExtensionLoader<T>) EXTENSION_LOADERS.get(type);  \n    if (loader == null) {  \n    EXTENSION_LOADERS.putIfAbsent(type, new ExtensionLoader<T>(type));  \n    loader = (ExtensionLoader<T>) EXTENSION_LOADERS.get(type);  \n    }  \n    return loader;  \n    }\n{% endcodeblock %}\n\n该方法要求通过spi实现的接口上必须包含@spi注解，并且一个接口的ExtensionLoader是唯一的，保存在静态容器EXTENSION_LOADERS（ConcurrentHashMap）中。\nExtensionLoader提供实例方法getExtension获取该接口的具体实现。\n\n{% codeblock ExtensionLoader.java  lang:java  %}\n\n    public T getExtension(String name) {  \n    if (name == null || name.length() == 0)  \n    throw new IllegalArgumentException(\"Extension name == null\");  \n    if (\"true\".equals(name)) {  \n    return getDefaultExtension();  \n    }  \n    Holder<Object> holder = cachedInstances.get(name);  \n    if (holder == null) {  \n    cachedInstances.putIfAbsent(name, new Holder<Object>());  \n    holder = cachedInstances.get(name);  \n    }  \n    Object instance = holder.get();  \n    if (instance == null) {  \n    synchronized (holder) {  \n    instance = holder.get();  \n    if (instance == null) {  \n    instance = createExtension(name);  \n    holder.set(instance);  \n    }  \n    }  \n    }  \n    return (T) instance;  \n    }\n{% endcodeblock %}\n\n具体流程如下\n\n{% asset_img 1.png  image %}\n\n该方法通过大量缓存容器来优化性能，并且每个扩展点都是单例存在，所以扩展dubbo框架的时候要注意该扩展点的线程安全性。\nExtensionFactory为spi接口实现实例在注入属性（injectExtension）时提供注入的属性.\n\n{% asset_img 2.png  image %}\n\n该工厂有三个实现，分别支持从spring ，spi，Adaptive里面获取对象，注入Extension对象中。\n\n","source":"_posts/dubbo源码研究之extension模块.md","raw":"---\ntitle: dubbo源码研究之extension模块\ntags:\n  - dubbo\nabbrlink: 40013\ndate: 2023-06-19 17:20:53\n---\n# dubbo源码研究之extension模块\n\ndubbo的扩展采用spi机制实现，\nspi（Service Provider Interface）是指一些提供给你继承、扩展，完成自定义功能的类、接口或者方法。\nspi把控制权利交个调用方，调用方来决定使用该spi的哪个实现。\ndubbo扩展机制的核心类是ExtensionLoader，该类通过静态方法getExtensionLoader获取一个指定接口的ExtensionLoader实例。\n\n{% codeblock ExtensionLoader.java  lang:java  %}\n\n    @SuppressWarnings(\"unchecked\")  \n    public static <T> ExtensionLoader<T> getExtensionLoader(Class<T> type) {  \n    if (type == null)  \n    throw new IllegalArgumentException(\"Extension type == null\");  \n    if(!type.isInterface()) {  \n    throw new IllegalArgumentException(\"Extension type(\" + type + \") is not interface!\");  \n    }  \n    if(!withExtensionAnnotation(type)) {  \n    throw new IllegalArgumentException(\"Extension type(\" + type +   \n    \") is not extension, because WITHOUT @\" + SPI.class.getSimpleName() + \" Annotation!\");  \n    }\n    \n    ExtensionLoader<T> loader = (ExtensionLoader<T>) EXTENSION_LOADERS.get(type);  \n    if (loader == null) {  \n    EXTENSION_LOADERS.putIfAbsent(type, new ExtensionLoader<T>(type));  \n    loader = (ExtensionLoader<T>) EXTENSION_LOADERS.get(type);  \n    }  \n    return loader;  \n    }\n{% endcodeblock %}\n\n该方法要求通过spi实现的接口上必须包含@spi注解，并且一个接口的ExtensionLoader是唯一的，保存在静态容器EXTENSION_LOADERS（ConcurrentHashMap）中。\nExtensionLoader提供实例方法getExtension获取该接口的具体实现。\n\n{% codeblock ExtensionLoader.java  lang:java  %}\n\n    public T getExtension(String name) {  \n    if (name == null || name.length() == 0)  \n    throw new IllegalArgumentException(\"Extension name == null\");  \n    if (\"true\".equals(name)) {  \n    return getDefaultExtension();  \n    }  \n    Holder<Object> holder = cachedInstances.get(name);  \n    if (holder == null) {  \n    cachedInstances.putIfAbsent(name, new Holder<Object>());  \n    holder = cachedInstances.get(name);  \n    }  \n    Object instance = holder.get();  \n    if (instance == null) {  \n    synchronized (holder) {  \n    instance = holder.get();  \n    if (instance == null) {  \n    instance = createExtension(name);  \n    holder.set(instance);  \n    }  \n    }  \n    }  \n    return (T) instance;  \n    }\n{% endcodeblock %}\n\n具体流程如下\n\n{% asset_img 1.png  image %}\n\n该方法通过大量缓存容器来优化性能，并且每个扩展点都是单例存在，所以扩展dubbo框架的时候要注意该扩展点的线程安全性。\nExtensionFactory为spi接口实现实例在注入属性（injectExtension）时提供注入的属性.\n\n{% asset_img 2.png  image %}\n\n该工厂有三个实现，分别支持从spring ，spi，Adaptive里面获取对象，注入Extension对象中。\n\n","slug":"dubbo源码研究之extension模块","published":1,"updated":"2023-12-05T02:48:12.732Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdiz000korgo6yaw8ujk","content":"<h1 id=\"dubbo源码研究之extension模块\"><a href=\"#dubbo源码研究之extension模块\" class=\"headerlink\" title=\"dubbo源码研究之extension模块\"></a>dubbo源码研究之extension模块</h1><p>dubbo的扩展采用spi机制实现，<br>spi（Service Provider Interface）是指一些提供给你继承、扩展，完成自定义功能的类、接口或者方法。<br>spi把控制权利交个调用方，调用方来决定使用该spi的哪个实现。<br>dubbo扩展机制的核心类是ExtensionLoader，该类通过静态方法getExtensionLoader获取一个指定接口的ExtensionLoader实例。</p>\n<figure class=\"highlight java\"><figcaption><span>ExtensionLoader.java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;T&gt; ExtensionLoader&lt;T&gt; <span class=\"title function_\">getExtensionLoader</span><span class=\"params\">(Class&lt;T&gt; type)</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (type == <span class=\"literal\">null</span>)  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Extension type == null&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(!type.isInterface()) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Extension type(&quot;</span> + type + <span class=\"string\">&quot;) is not interface!&quot;</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(!withExtensionAnnotation(type)) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Extension type(&quot;</span> + type +   </span><br><span class=\"line\"><span class=\"string\">&quot;) is not extension, because WITHOUT @&quot;</span> + SPI.class.getSimpleName() + <span class=\"string\">&quot; Annotation!&quot;</span>);  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">ExtensionLoader&lt;T&gt; loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (loader == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">EXTENSION_LOADERS.putIfAbsent(type, <span class=\"keyword\">new</span> <span class=\"title class_\">ExtensionLoader</span>&lt;T&gt;(type));  </span><br><span class=\"line\">loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> loader;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>该方法要求通过spi实现的接口上必须包含@spi注解，并且一个接口的ExtensionLoader是唯一的，保存在静态容器EXTENSION_LOADERS（ConcurrentHashMap）中。<br>ExtensionLoader提供实例方法getExtension获取该接口的具体实现。</p>\n<figure class=\"highlight java\"><figcaption><span>ExtensionLoader.java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> T <span class=\"title function_\">getExtension</span><span class=\"params\">(String name)</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (name == <span class=\"literal\">null</span> || name.length() == <span class=\"number\">0</span>)  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Extension name == null&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"string\">&quot;true&quot;</span>.equals(name)) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> getDefaultExtension();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">Holder&lt;Object&gt; holder = cachedInstances.get(name);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (holder == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">cachedInstances.putIfAbsent(name, <span class=\"keyword\">new</span> <span class=\"title class_\">Holder</span>&lt;Object&gt;());  </span><br><span class=\"line\">holder = cachedInstances.get(name);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"type\">Object</span> <span class=\"variable\">instance</span> <span class=\"operator\">=</span> holder.get();  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (instance == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">synchronized</span> (holder) &#123;  </span><br><span class=\"line\">instance = holder.get();  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (instance == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">instance = createExtension(name);  </span><br><span class=\"line\">holder.set(instance);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> (T) instance;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>具体流程如下</p>\n<img src=\"/2023061940013/1.png\" class=\"\" title=\"image\">\n\n<p>该方法通过大量缓存容器来优化性能，并且每个扩展点都是单例存在，所以扩展dubbo框架的时候要注意该扩展点的线程安全性。<br>ExtensionFactory为spi接口实现实例在注入属性（injectExtension）时提供注入的属性.</p>\n<img src=\"/2023061940013/2.png\" class=\"\" title=\"image\">\n\n<p>该工厂有三个实现，分别支持从spring ，spi，Adaptive里面获取对象，注入Extension对象中。</p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"dubbo源码研究之extension模块\"><a href=\"#dubbo源码研究之extension模块\" class=\"headerlink\" title=\"dubbo源码研究之extension模块\"></a>dubbo源码研究之extension模块</h1><p>dubbo的扩展采用spi机制实现，<br>spi（Service Provider Interface）是指一些提供给你继承、扩展，完成自定义功能的类、接口或者方法。<br>spi把控制权利交个调用方，调用方来决定使用该spi的哪个实现。<br>dubbo扩展机制的核心类是ExtensionLoader，该类通过静态方法getExtensionLoader获取一个指定接口的ExtensionLoader实例。</p>\n<figure class=\"highlight java\"><figcaption><span>ExtensionLoader.java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;T&gt; ExtensionLoader&lt;T&gt; <span class=\"title function_\">getExtensionLoader</span><span class=\"params\">(Class&lt;T&gt; type)</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (type == <span class=\"literal\">null</span>)  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Extension type == null&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(!type.isInterface()) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Extension type(&quot;</span> + type + <span class=\"string\">&quot;) is not interface!&quot;</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(!withExtensionAnnotation(type)) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Extension type(&quot;</span> + type +   </span><br><span class=\"line\"><span class=\"string\">&quot;) is not extension, because WITHOUT @&quot;</span> + SPI.class.getSimpleName() + <span class=\"string\">&quot; Annotation!&quot;</span>);  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">ExtensionLoader&lt;T&gt; loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (loader == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">EXTENSION_LOADERS.putIfAbsent(type, <span class=\"keyword\">new</span> <span class=\"title class_\">ExtensionLoader</span>&lt;T&gt;(type));  </span><br><span class=\"line\">loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> loader;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>该方法要求通过spi实现的接口上必须包含@spi注解，并且一个接口的ExtensionLoader是唯一的，保存在静态容器EXTENSION_LOADERS（ConcurrentHashMap）中。<br>ExtensionLoader提供实例方法getExtension获取该接口的具体实现。</p>\n<figure class=\"highlight java\"><figcaption><span>ExtensionLoader.java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> T <span class=\"title function_\">getExtension</span><span class=\"params\">(String name)</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (name == <span class=\"literal\">null</span> || name.length() == <span class=\"number\">0</span>)  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;Extension name == null&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"string\">&quot;true&quot;</span>.equals(name)) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> getDefaultExtension();  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">Holder&lt;Object&gt; holder = cachedInstances.get(name);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (holder == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">cachedInstances.putIfAbsent(name, <span class=\"keyword\">new</span> <span class=\"title class_\">Holder</span>&lt;Object&gt;());  </span><br><span class=\"line\">holder = cachedInstances.get(name);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"type\">Object</span> <span class=\"variable\">instance</span> <span class=\"operator\">=</span> holder.get();  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (instance == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">synchronized</span> (holder) &#123;  </span><br><span class=\"line\">instance = holder.get();  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (instance == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">instance = createExtension(name);  </span><br><span class=\"line\">holder.set(instance);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> (T) instance;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>具体流程如下</p>\n<img src=\"/2023061940013/1.png\" class=\"\" title=\"image\">\n\n<p>该方法通过大量缓存容器来优化性能，并且每个扩展点都是单例存在，所以扩展dubbo框架的时候要注意该扩展点的线程安全性。<br>ExtensionFactory为spi接口实现实例在注入属性（injectExtension）时提供注入的属性.</p>\n<img src=\"/2023061940013/2.png\" class=\"\" title=\"image\">\n\n<p>该工厂有三个实现，分别支持从spring ，spi，Adaptive里面获取对象，注入Extension对象中。</p>\n"},{"title":"dubbo源码研究之rpc模块","abbrlink":47627,"date":"2023-06-20T04:21:47.000Z","_content":"# dubbo源码研究之rpc模块\ndubbo作为一个服务化框架，rpc模块是dubbo整个框架的核心部分。我们来通过dubbo来了解rpc调用的本质。\n\n{% asset_img 1.png  image %}\n\ndubbo的rpc模块以Invocation和Result为中心，扩展接口为Protocol、Invoker和Exporter。\nProtocol是服务域，它是Invoker暴露和引用的主功能入口，它负责Invoker的生命周期管理。\nInvoker是实体域，它是Dubbo的核心模型，其它模型都向它靠扰，或转换成它，它代表一个可执行体，可向它发起invoke调用，\n它有可能是一个本地的实现，也可能是一个远程的实现，也可能一个集群实现。\ninvoker接口提供两个方法。\nClass getInterface(); 获取调用的接口\nResult invoke(Invocation invocation) throws RpcException; 执行调用\n说明rpc就两件事，第一，定位要调用的是哪个接口，第二发起调用返回结果。值得注意的是invoker需要Invocation提供的信息，Invocation 支持有本地invoker。invoker不参与Invocation的序列化。Invocation转成request对象通过网络传递并序列化和反序列化。\n\n{% asset_img 2.png  image %}\n\nrpccontext是一个静态工具类，通过threadlocal来保存单次调用的上下文。\nProtocol负载invoker的暴露与引用。\n\n{% asset_img 3.png  image %}\n\n一个refer的invoker就会存在一个export的invoker，如果引用的服务不存在，则需要设置\n暴露服务顺序\n\n{% asset_img 4.png  image %}\n\n引用服务时序\n\n{% asset_img 5.png  image %}\n\ndubbo的rpc模块也遵守dubbo的整体设计原则采用Microkernel + Plugin模式，Microkernel只负责组装Plugin。\ninvoker是核心模型，服务方把invoker对象暴露成Exporter对象，并把url描述写入注册中心，注册中心推送到消费方。消费方通过url转成invoker对象。\n\n\n\n\n\n","source":"_posts/dubbo源码研究之rpc模块.md","raw":"---\ntitle: dubbo源码研究之rpc模块\ntags:\n  - dubbo\nabbrlink: 47627\ndate: 2023-06-20 12:21:47\n---\n# dubbo源码研究之rpc模块\ndubbo作为一个服务化框架，rpc模块是dubbo整个框架的核心部分。我们来通过dubbo来了解rpc调用的本质。\n\n{% asset_img 1.png  image %}\n\ndubbo的rpc模块以Invocation和Result为中心，扩展接口为Protocol、Invoker和Exporter。\nProtocol是服务域，它是Invoker暴露和引用的主功能入口，它负责Invoker的生命周期管理。\nInvoker是实体域，它是Dubbo的核心模型，其它模型都向它靠扰，或转换成它，它代表一个可执行体，可向它发起invoke调用，\n它有可能是一个本地的实现，也可能是一个远程的实现，也可能一个集群实现。\ninvoker接口提供两个方法。\nClass getInterface(); 获取调用的接口\nResult invoke(Invocation invocation) throws RpcException; 执行调用\n说明rpc就两件事，第一，定位要调用的是哪个接口，第二发起调用返回结果。值得注意的是invoker需要Invocation提供的信息，Invocation 支持有本地invoker。invoker不参与Invocation的序列化。Invocation转成request对象通过网络传递并序列化和反序列化。\n\n{% asset_img 2.png  image %}\n\nrpccontext是一个静态工具类，通过threadlocal来保存单次调用的上下文。\nProtocol负载invoker的暴露与引用。\n\n{% asset_img 3.png  image %}\n\n一个refer的invoker就会存在一个export的invoker，如果引用的服务不存在，则需要设置\n暴露服务顺序\n\n{% asset_img 4.png  image %}\n\n引用服务时序\n\n{% asset_img 5.png  image %}\n\ndubbo的rpc模块也遵守dubbo的整体设计原则采用Microkernel + Plugin模式，Microkernel只负责组装Plugin。\ninvoker是核心模型，服务方把invoker对象暴露成Exporter对象，并把url描述写入注册中心，注册中心推送到消费方。消费方通过url转成invoker对象。\n\n\n\n\n\n","slug":"dubbo源码研究之rpc模块","published":1,"updated":"2023-12-05T02:48:12.733Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdj0000morgocdjd4aui","content":"<h1 id=\"dubbo源码研究之rpc模块\"><a href=\"#dubbo源码研究之rpc模块\" class=\"headerlink\" title=\"dubbo源码研究之rpc模块\"></a>dubbo源码研究之rpc模块</h1><p>dubbo作为一个服务化框架，rpc模块是dubbo整个框架的核心部分。我们来通过dubbo来了解rpc调用的本质。</p>\n<img src=\"/2023062047627/1.png\" class=\"\" title=\"image\">\n\n<p>dubbo的rpc模块以Invocation和Result为中心，扩展接口为Protocol、Invoker和Exporter。<br>Protocol是服务域，它是Invoker暴露和引用的主功能入口，它负责Invoker的生命周期管理。<br>Invoker是实体域，它是Dubbo的核心模型，其它模型都向它靠扰，或转换成它，它代表一个可执行体，可向它发起invoke调用，<br>它有可能是一个本地的实现，也可能是一个远程的实现，也可能一个集群实现。<br>invoker接口提供两个方法。<br>Class getInterface(); 获取调用的接口<br>Result invoke(Invocation invocation) throws RpcException; 执行调用<br>说明rpc就两件事，第一，定位要调用的是哪个接口，第二发起调用返回结果。值得注意的是invoker需要Invocation提供的信息，Invocation 支持有本地invoker。invoker不参与Invocation的序列化。Invocation转成request对象通过网络传递并序列化和反序列化。</p>\n<img src=\"/2023062047627/2.png\" class=\"\" title=\"image\">\n\n<p>rpccontext是一个静态工具类，通过threadlocal来保存单次调用的上下文。<br>Protocol负载invoker的暴露与引用。</p>\n<img src=\"/2023062047627/3.png\" class=\"\" title=\"image\">\n\n<p>一个refer的invoker就会存在一个export的invoker，如果引用的服务不存在，则需要设置<br>暴露服务顺序</p>\n<img src=\"/2023062047627/4.png\" class=\"\" title=\"image\">\n\n<p>引用服务时序</p>\n<img src=\"/2023062047627/5.png\" class=\"\" title=\"image\">\n\n<p>dubbo的rpc模块也遵守dubbo的整体设计原则采用Microkernel + Plugin模式，Microkernel只负责组装Plugin。<br>invoker是核心模型，服务方把invoker对象暴露成Exporter对象，并把url描述写入注册中心，注册中心推送到消费方。消费方通过url转成invoker对象。</p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"dubbo源码研究之rpc模块\"><a href=\"#dubbo源码研究之rpc模块\" class=\"headerlink\" title=\"dubbo源码研究之rpc模块\"></a>dubbo源码研究之rpc模块</h1><p>dubbo作为一个服务化框架，rpc模块是dubbo整个框架的核心部分。我们来通过dubbo来了解rpc调用的本质。</p>\n<img src=\"/2023062047627/1.png\" class=\"\" title=\"image\">\n\n<p>dubbo的rpc模块以Invocation和Result为中心，扩展接口为Protocol、Invoker和Exporter。<br>Protocol是服务域，它是Invoker暴露和引用的主功能入口，它负责Invoker的生命周期管理。<br>Invoker是实体域，它是Dubbo的核心模型，其它模型都向它靠扰，或转换成它，它代表一个可执行体，可向它发起invoke调用，<br>它有可能是一个本地的实现，也可能是一个远程的实现，也可能一个集群实现。<br>invoker接口提供两个方法。<br>Class getInterface(); 获取调用的接口<br>Result invoke(Invocation invocation) throws RpcException; 执行调用<br>说明rpc就两件事，第一，定位要调用的是哪个接口，第二发起调用返回结果。值得注意的是invoker需要Invocation提供的信息，Invocation 支持有本地invoker。invoker不参与Invocation的序列化。Invocation转成request对象通过网络传递并序列化和反序列化。</p>\n<img src=\"/2023062047627/2.png\" class=\"\" title=\"image\">\n\n<p>rpccontext是一个静态工具类，通过threadlocal来保存单次调用的上下文。<br>Protocol负载invoker的暴露与引用。</p>\n<img src=\"/2023062047627/3.png\" class=\"\" title=\"image\">\n\n<p>一个refer的invoker就会存在一个export的invoker，如果引用的服务不存在，则需要设置<br>暴露服务顺序</p>\n<img src=\"/2023062047627/4.png\" class=\"\" title=\"image\">\n\n<p>引用服务时序</p>\n<img src=\"/2023062047627/5.png\" class=\"\" title=\"image\">\n\n<p>dubbo的rpc模块也遵守dubbo的整体设计原则采用Microkernel + Plugin模式，Microkernel只负责组装Plugin。<br>invoker是核心模型，服务方把invoker对象暴露成Exporter对象，并把url描述写入注册中心，注册中心推送到消费方。消费方通过url转成invoker对象。</p>\n"},{"title":"jQuery基于json对象自动给表单元素赋值","abbrlink":58164,"date":"2023-06-20T04:30:39.000Z","_content":"# jQuery基于json对象自动给表单元素赋值\n\n为了提高前端小伙伴的开发效率，造了个基于json对象根据表单元素的name属性自动赋值的轮子\n\n{% codeblock  lang:javascript   %}\n\n    json2form:function(obj){  \n    var nodeParent = null;  \n    var value = undefined;  \n    var $el = null;  \n    var nodeName = \"\";  \n    for(var i in obj){  \n    value= obj[i] ;  \n    if(value === undefined || value===null){  \n    continue;  \n    }  \n    if(typeof value == 'object'){  \n    nodeParent=obj.nodeParent;  \n    value.nodeParent=nodeParent?nodeParent+\".\"+i : i;  \n    if(value instanceof Array){  \n    for(var mm=0;mm<value.length;mm++){  \n    var ms=value[mm];  \n    if(typeof ms == 'object'){  \n    nodeParent=ms.nodeParent;  \n    ms.nodeParent=ms.nodeParent?ms.nodeParent+\".\"+i+\"[\"+mm+\"]\":i+\"[\"+mm+\"]\";  \n    arguments.callee(ms);  \n    }  \n    }  \n    $el=$(\"[name='\"+i+\"']\");  \n    if($el.is(\":checkbox\")){  \n    $el.each(function(){  \n    if($(this).val() == value){  \n    $(this).prop(\"checked\",true);  \n    }  \n    })  \n    }  \n    else if($el.is(\":radio\")){  \n    $el.each(function(){  \n    if($(this).val() == value){  \n    $(this).prop(\"checked\",true);  \n    }  \n    })  \n    }  \n    }else{  //递归  \n    arguments.callee(value);  \n    }  \n    }  \n    else{  \n    nodeName=obj.nodeParent?obj.nodeParent+\".\"+i : i ;  \n    $el=$(\"[name='\"+nodeName+\"']\");  \n    if($el.length > 0){  \n    // console.log(\"匹配数据名称：\"+nodeName+\"值：\"+value);  \n    if($el.is(\":text\")||$el.attr(\"type\")==\"hidden\"){  \n    if($el.data(\"money\") && $el.data(\"money\") == \"money\"){  \n    value = outputdollars(value);  \n    }  \n    $el.val(value);\n\n                 }else if($el.is(\":radio\")){  \n                     $el.each(function(){  \n                        if($(this).val()==value){  \n                            $(this).prop(\"checked\",true);  \n                        }  \n                     })  \n                 }  \n                 else if($el.is(\"select\")){  \n                    $el.find(\"option\").filter(function(){return $(this).val() == obj[i];}).prop(\"selected\",true);  \n                 }else if($el.is(\"textarea\")){  \n                    $el.val(value)  \n                 }  \n              }  \n          }  \n      }      \n\n    }\n\n{% endcodeblock %}\n\n注意： 表单的name属于与json对象的属性名为一致，保持继承链。\n例如 input name=’a.b.c’ 表示json对象里面的a属性里面的b属性的c属性。\n\n","source":"_posts/jQuery基于json对象自动给表单元素赋值.md","raw":"---\ntitle: jQuery基于json对象自动给表单元素赋值\ntags:\n  - 前端\nabbrlink: 58164\ndate: 2023-06-20 12:30:39\n---\n# jQuery基于json对象自动给表单元素赋值\n\n为了提高前端小伙伴的开发效率，造了个基于json对象根据表单元素的name属性自动赋值的轮子\n\n{% codeblock  lang:javascript   %}\n\n    json2form:function(obj){  \n    var nodeParent = null;  \n    var value = undefined;  \n    var $el = null;  \n    var nodeName = \"\";  \n    for(var i in obj){  \n    value= obj[i] ;  \n    if(value === undefined || value===null){  \n    continue;  \n    }  \n    if(typeof value == 'object'){  \n    nodeParent=obj.nodeParent;  \n    value.nodeParent=nodeParent?nodeParent+\".\"+i : i;  \n    if(value instanceof Array){  \n    for(var mm=0;mm<value.length;mm++){  \n    var ms=value[mm];  \n    if(typeof ms == 'object'){  \n    nodeParent=ms.nodeParent;  \n    ms.nodeParent=ms.nodeParent?ms.nodeParent+\".\"+i+\"[\"+mm+\"]\":i+\"[\"+mm+\"]\";  \n    arguments.callee(ms);  \n    }  \n    }  \n    $el=$(\"[name='\"+i+\"']\");  \n    if($el.is(\":checkbox\")){  \n    $el.each(function(){  \n    if($(this).val() == value){  \n    $(this).prop(\"checked\",true);  \n    }  \n    })  \n    }  \n    else if($el.is(\":radio\")){  \n    $el.each(function(){  \n    if($(this).val() == value){  \n    $(this).prop(\"checked\",true);  \n    }  \n    })  \n    }  \n    }else{  //递归  \n    arguments.callee(value);  \n    }  \n    }  \n    else{  \n    nodeName=obj.nodeParent?obj.nodeParent+\".\"+i : i ;  \n    $el=$(\"[name='\"+nodeName+\"']\");  \n    if($el.length > 0){  \n    // console.log(\"匹配数据名称：\"+nodeName+\"值：\"+value);  \n    if($el.is(\":text\")||$el.attr(\"type\")==\"hidden\"){  \n    if($el.data(\"money\") && $el.data(\"money\") == \"money\"){  \n    value = outputdollars(value);  \n    }  \n    $el.val(value);\n\n                 }else if($el.is(\":radio\")){  \n                     $el.each(function(){  \n                        if($(this).val()==value){  \n                            $(this).prop(\"checked\",true);  \n                        }  \n                     })  \n                 }  \n                 else if($el.is(\"select\")){  \n                    $el.find(\"option\").filter(function(){return $(this).val() == obj[i];}).prop(\"selected\",true);  \n                 }else if($el.is(\"textarea\")){  \n                    $el.val(value)  \n                 }  \n              }  \n          }  \n      }      \n\n    }\n\n{% endcodeblock %}\n\n注意： 表单的name属于与json对象的属性名为一致，保持继承链。\n例如 input name=’a.b.c’ 表示json对象里面的a属性里面的b属性的c属性。\n\n","slug":"jQuery基于json对象自动给表单元素赋值","published":1,"updated":"2023-12-05T02:48:12.733Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdj1000oorgoaivhepyc","content":"<h1 id=\"jQuery基于json对象自动给表单元素赋值\"><a href=\"#jQuery基于json对象自动给表单元素赋值\" class=\"headerlink\" title=\"jQuery基于json对象自动给表单元素赋值\"></a>jQuery基于json对象自动给表单元素赋值</h1><p>为了提高前端小伙伴的开发效率，造了个基于json对象根据表单元素的name属性自动赋值的轮子</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">json2form</span>:<span class=\"keyword\">function</span>(<span class=\"params\">obj</span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> nodeParent = <span class=\"literal\">null</span>;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> value = <span class=\"literal\">undefined</span>;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> $el = <span class=\"literal\">null</span>;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> nodeName = <span class=\"string\">&quot;&quot;</span>;  </span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i <span class=\"keyword\">in</span> obj)&#123;  </span><br><span class=\"line\">value= obj[i] ;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(value === <span class=\"literal\">undefined</span> || value===<span class=\"literal\">null</span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">continue</span>;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">typeof</span> value == <span class=\"string\">&#x27;object&#x27;</span>)&#123;  </span><br><span class=\"line\">nodeParent=obj.<span class=\"property\">nodeParent</span>;  </span><br><span class=\"line\">value.<span class=\"property\">nodeParent</span>=nodeParent?nodeParent+<span class=\"string\">&quot;.&quot;</span>+i : i;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(value <span class=\"keyword\">instanceof</span> <span class=\"title class_\">Array</span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> mm=<span class=\"number\">0</span>;mm&lt;value.<span class=\"property\">length</span>;mm++)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> ms=value[mm];  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">typeof</span> ms == <span class=\"string\">&#x27;object&#x27;</span>)&#123;  </span><br><span class=\"line\">nodeParent=ms.<span class=\"property\">nodeParent</span>;  </span><br><span class=\"line\">ms.<span class=\"property\">nodeParent</span>=ms.<span class=\"property\">nodeParent</span>?ms.<span class=\"property\">nodeParent</span>+<span class=\"string\">&quot;.&quot;</span>+i+<span class=\"string\">&quot;[&quot;</span>+mm+<span class=\"string\">&quot;]&quot;</span>:i+<span class=\"string\">&quot;[&quot;</span>+mm+<span class=\"string\">&quot;]&quot;</span>;  </span><br><span class=\"line\"><span class=\"variable language_\">arguments</span>.<span class=\"title function_\">callee</span>(ms);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">$el=$(<span class=\"string\">&quot;[name=&#x27;&quot;</span>+i+<span class=\"string\">&quot;&#x27;]&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">if</span>($el.<span class=\"title function_\">is</span>(<span class=\"string\">&quot;:checkbox&quot;</span>))&#123;  </span><br><span class=\"line\">$el.<span class=\"title function_\">each</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>($(<span class=\"variable language_\">this</span>).<span class=\"title function_\">val</span>() == value)&#123;  </span><br><span class=\"line\">$(<span class=\"variable language_\">this</span>).<span class=\"title function_\">prop</span>(<span class=\"string\">&quot;checked&quot;</span>,<span class=\"literal\">true</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;)  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span>($el.<span class=\"title function_\">is</span>(<span class=\"string\">&quot;:radio&quot;</span>))&#123;  </span><br><span class=\"line\">$el.<span class=\"title function_\">each</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>($(<span class=\"variable language_\">this</span>).<span class=\"title function_\">val</span>() == value)&#123;  </span><br><span class=\"line\">$(<span class=\"variable language_\">this</span>).<span class=\"title function_\">prop</span>(<span class=\"string\">&quot;checked&quot;</span>,<span class=\"literal\">true</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;)  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;  <span class=\"comment\">//递归  </span></span><br><span class=\"line\"><span class=\"variable language_\">arguments</span>.<span class=\"title function_\">callee</span>(value);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;  </span><br><span class=\"line\">nodeName=obj.<span class=\"property\">nodeParent</span>?obj.<span class=\"property\">nodeParent</span>+<span class=\"string\">&quot;.&quot;</span>+i : i ;  </span><br><span class=\"line\">$el=$(<span class=\"string\">&quot;[name=&#x27;&quot;</span>+nodeName+<span class=\"string\">&quot;&#x27;]&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">if</span>($el.<span class=\"property\">length</span> &gt; <span class=\"number\">0</span>)&#123;  </span><br><span class=\"line\"><span class=\"comment\">// console.log(&quot;匹配数据名称：&quot;+nodeName+&quot;值：&quot;+value);  </span></span><br><span class=\"line\"><span class=\"keyword\">if</span>($el.<span class=\"title function_\">is</span>(<span class=\"string\">&quot;:text&quot;</span>)||$el.<span class=\"title function_\">attr</span>(<span class=\"string\">&quot;type&quot;</span>)==<span class=\"string\">&quot;hidden&quot;</span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>($el.<span class=\"title function_\">data</span>(<span class=\"string\">&quot;money&quot;</span>) &amp;&amp; $el.<span class=\"title function_\">data</span>(<span class=\"string\">&quot;money&quot;</span>) == <span class=\"string\">&quot;money&quot;</span>)&#123;  </span><br><span class=\"line\">value = <span class=\"title function_\">outputdollars</span>(value);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">$el.<span class=\"title function_\">val</span>(value);</span><br><span class=\"line\"></span><br><span class=\"line\">             &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>($el.<span class=\"title function_\">is</span>(<span class=\"string\">&quot;:radio&quot;</span>))&#123;  </span><br><span class=\"line\">                 $el.<span class=\"title function_\">each</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;  </span><br><span class=\"line\">                    <span class=\"keyword\">if</span>($(<span class=\"variable language_\">this</span>).<span class=\"title function_\">val</span>()==value)&#123;  </span><br><span class=\"line\">                        $(<span class=\"variable language_\">this</span>).<span class=\"title function_\">prop</span>(<span class=\"string\">&quot;checked&quot;</span>,<span class=\"literal\">true</span>);  </span><br><span class=\"line\">                    &#125;  </span><br><span class=\"line\">                 &#125;)  </span><br><span class=\"line\">             &#125;  </span><br><span class=\"line\">             <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>($el.<span class=\"title function_\">is</span>(<span class=\"string\">&quot;select&quot;</span>))&#123;  </span><br><span class=\"line\">                $el.<span class=\"title function_\">find</span>(<span class=\"string\">&quot;option&quot;</span>).<span class=\"title function_\">filter</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;<span class=\"keyword\">return</span> $(<span class=\"variable language_\">this</span>).<span class=\"title function_\">val</span>() == obj[i];&#125;).<span class=\"title function_\">prop</span>(<span class=\"string\">&quot;selected&quot;</span>,<span class=\"literal\">true</span>);  </span><br><span class=\"line\">             &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>($el.<span class=\"title function_\">is</span>(<span class=\"string\">&quot;textarea&quot;</span>))&#123;  </span><br><span class=\"line\">                $el.<span class=\"title function_\">val</span>(value)  </span><br><span class=\"line\">             &#125;  </span><br><span class=\"line\">          &#125;  </span><br><span class=\"line\">      &#125;  </span><br><span class=\"line\">  &#125;      </span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>注意： 表单的name属于与json对象的属性名为一致，保持继承链。<br>例如 input name&#x3D;’a.b.c’ 表示json对象里面的a属性里面的b属性的c属性。</p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"jQuery基于json对象自动给表单元素赋值\"><a href=\"#jQuery基于json对象自动给表单元素赋值\" class=\"headerlink\" title=\"jQuery基于json对象自动给表单元素赋值\"></a>jQuery基于json对象自动给表单元素赋值</h1><p>为了提高前端小伙伴的开发效率，造了个基于json对象根据表单元素的name属性自动赋值的轮子</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">json2form</span>:<span class=\"keyword\">function</span>(<span class=\"params\">obj</span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> nodeParent = <span class=\"literal\">null</span>;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> value = <span class=\"literal\">undefined</span>;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> $el = <span class=\"literal\">null</span>;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> nodeName = <span class=\"string\">&quot;&quot;</span>;  </span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i <span class=\"keyword\">in</span> obj)&#123;  </span><br><span class=\"line\">value= obj[i] ;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(value === <span class=\"literal\">undefined</span> || value===<span class=\"literal\">null</span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">continue</span>;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">typeof</span> value == <span class=\"string\">&#x27;object&#x27;</span>)&#123;  </span><br><span class=\"line\">nodeParent=obj.<span class=\"property\">nodeParent</span>;  </span><br><span class=\"line\">value.<span class=\"property\">nodeParent</span>=nodeParent?nodeParent+<span class=\"string\">&quot;.&quot;</span>+i : i;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(value <span class=\"keyword\">instanceof</span> <span class=\"title class_\">Array</span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> mm=<span class=\"number\">0</span>;mm&lt;value.<span class=\"property\">length</span>;mm++)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> ms=value[mm];  </span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">typeof</span> ms == <span class=\"string\">&#x27;object&#x27;</span>)&#123;  </span><br><span class=\"line\">nodeParent=ms.<span class=\"property\">nodeParent</span>;  </span><br><span class=\"line\">ms.<span class=\"property\">nodeParent</span>=ms.<span class=\"property\">nodeParent</span>?ms.<span class=\"property\">nodeParent</span>+<span class=\"string\">&quot;.&quot;</span>+i+<span class=\"string\">&quot;[&quot;</span>+mm+<span class=\"string\">&quot;]&quot;</span>:i+<span class=\"string\">&quot;[&quot;</span>+mm+<span class=\"string\">&quot;]&quot;</span>;  </span><br><span class=\"line\"><span class=\"variable language_\">arguments</span>.<span class=\"title function_\">callee</span>(ms);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">$el=$(<span class=\"string\">&quot;[name=&#x27;&quot;</span>+i+<span class=\"string\">&quot;&#x27;]&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">if</span>($el.<span class=\"title function_\">is</span>(<span class=\"string\">&quot;:checkbox&quot;</span>))&#123;  </span><br><span class=\"line\">$el.<span class=\"title function_\">each</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>($(<span class=\"variable language_\">this</span>).<span class=\"title function_\">val</span>() == value)&#123;  </span><br><span class=\"line\">$(<span class=\"variable language_\">this</span>).<span class=\"title function_\">prop</span>(<span class=\"string\">&quot;checked&quot;</span>,<span class=\"literal\">true</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;)  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span>($el.<span class=\"title function_\">is</span>(<span class=\"string\">&quot;:radio&quot;</span>))&#123;  </span><br><span class=\"line\">$el.<span class=\"title function_\">each</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>($(<span class=\"variable language_\">this</span>).<span class=\"title function_\">val</span>() == value)&#123;  </span><br><span class=\"line\">$(<span class=\"variable language_\">this</span>).<span class=\"title function_\">prop</span>(<span class=\"string\">&quot;checked&quot;</span>,<span class=\"literal\">true</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;)  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;  <span class=\"comment\">//递归  </span></span><br><span class=\"line\"><span class=\"variable language_\">arguments</span>.<span class=\"title function_\">callee</span>(value);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;  </span><br><span class=\"line\">nodeName=obj.<span class=\"property\">nodeParent</span>?obj.<span class=\"property\">nodeParent</span>+<span class=\"string\">&quot;.&quot;</span>+i : i ;  </span><br><span class=\"line\">$el=$(<span class=\"string\">&quot;[name=&#x27;&quot;</span>+nodeName+<span class=\"string\">&quot;&#x27;]&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">if</span>($el.<span class=\"property\">length</span> &gt; <span class=\"number\">0</span>)&#123;  </span><br><span class=\"line\"><span class=\"comment\">// console.log(&quot;匹配数据名称：&quot;+nodeName+&quot;值：&quot;+value);  </span></span><br><span class=\"line\"><span class=\"keyword\">if</span>($el.<span class=\"title function_\">is</span>(<span class=\"string\">&quot;:text&quot;</span>)||$el.<span class=\"title function_\">attr</span>(<span class=\"string\">&quot;type&quot;</span>)==<span class=\"string\">&quot;hidden&quot;</span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>($el.<span class=\"title function_\">data</span>(<span class=\"string\">&quot;money&quot;</span>) &amp;&amp; $el.<span class=\"title function_\">data</span>(<span class=\"string\">&quot;money&quot;</span>) == <span class=\"string\">&quot;money&quot;</span>)&#123;  </span><br><span class=\"line\">value = <span class=\"title function_\">outputdollars</span>(value);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">$el.<span class=\"title function_\">val</span>(value);</span><br><span class=\"line\"></span><br><span class=\"line\">             &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>($el.<span class=\"title function_\">is</span>(<span class=\"string\">&quot;:radio&quot;</span>))&#123;  </span><br><span class=\"line\">                 $el.<span class=\"title function_\">each</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;  </span><br><span class=\"line\">                    <span class=\"keyword\">if</span>($(<span class=\"variable language_\">this</span>).<span class=\"title function_\">val</span>()==value)&#123;  </span><br><span class=\"line\">                        $(<span class=\"variable language_\">this</span>).<span class=\"title function_\">prop</span>(<span class=\"string\">&quot;checked&quot;</span>,<span class=\"literal\">true</span>);  </span><br><span class=\"line\">                    &#125;  </span><br><span class=\"line\">                 &#125;)  </span><br><span class=\"line\">             &#125;  </span><br><span class=\"line\">             <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>($el.<span class=\"title function_\">is</span>(<span class=\"string\">&quot;select&quot;</span>))&#123;  </span><br><span class=\"line\">                $el.<span class=\"title function_\">find</span>(<span class=\"string\">&quot;option&quot;</span>).<span class=\"title function_\">filter</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;<span class=\"keyword\">return</span> $(<span class=\"variable language_\">this</span>).<span class=\"title function_\">val</span>() == obj[i];&#125;).<span class=\"title function_\">prop</span>(<span class=\"string\">&quot;selected&quot;</span>,<span class=\"literal\">true</span>);  </span><br><span class=\"line\">             &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>($el.<span class=\"title function_\">is</span>(<span class=\"string\">&quot;textarea&quot;</span>))&#123;  </span><br><span class=\"line\">                $el.<span class=\"title function_\">val</span>(value)  </span><br><span class=\"line\">             &#125;  </span><br><span class=\"line\">          &#125;  </span><br><span class=\"line\">      &#125;  </span><br><span class=\"line\">  &#125;      </span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>注意： 表单的name属于与json对象的属性名为一致，保持继承链。<br>例如 input name&#x3D;’a.b.c’ 表示json对象里面的a属性里面的b属性的c属性。</p>\n"},{"title":"java多线程基础","abbrlink":39355,"date":"2023-06-19T09:35:36.000Z","_content":"# java多线程基础\n\n## 线程安全性\n当多个线程访问莫个类时，这个类始终都能表现出正确的行为，那么这个类就是线程安全的。\n在线程安全的类中封装了必要的同步机制，因此客户端无须进一步采取同步措施。\n**无状态对象一定是线程安全的。**\n\n## 保证线程安全性的三种方式\n1. 不在线程之间共享状态变量\n2. 将状态变量修改为不可变\n3. 访问状态变量时使用同步\n\n## 原子性\n在单核CPU中, 能够在一个指令中完成的操作都可以看作为原子操作, 因为中断只发生在指令间。\njava中对于非long和double基本数据类型的”简单操作”都可以看作是原子的。\n**long和double都是64位，jmm不保证操作的原子性。**\n\n## 可见性\n变量读取到的值，总是任何线程对该变量最后写入的值。\n**加锁不只局限于互斥行为，还包括了内存可见性。为了确保所有线程都能共享到变量最新的值，因此读或者写都必须在一个锁上同步。**\n\n## 顺序性\n在Java内存模型中，允许编译器和处理器对指令进行重排序，但是重排序过程不会影响到单线程程序的执行，却会影响到多线程并发执行的正确性。\nJava内存模型具备一些先天的“有序性”，即不需要通过任何手段就能够得到保证的有序性，这个通常也称为 happens-before 原则。\n如果两个操作的执行次序无法从happens-before原则推导出来，那么它们就不能保证它们的有序性，虚拟机可以随意地对它们进行重排序\n\n## 线程封闭和栈封闭\n线程封闭：变量只属于某个线程，例如通过 ThreadLocal来保持的线程变量。\n栈封闭是线程封闭的一种特例，在栈封闭中，只有通过局部对象才能访问对象。\n\n## 不变性\n不可变的对象一定是线程安全的。不可变不等于final，即使对象所有的域都是final的，对象也依然可能是可以变得。\nfinal 修饰引用类型只代表该引用不可变，不代表引用的对象不可变。final修饰简单值类型能保证是不可变的。\n满足一下条件对象才是不可变的。\n\n- 对象创建以后不可以修改\n- 对象创建以后不可以修改\n- 对象是正确创建的（this没有溢出）\n\n\n","source":"_posts/java多线程基础.md","raw":"---\ntitle: java多线程基础\ntags:\n  - java\nabbrlink: 39355\ndate: 2023-06-19 17:35:36\n---\n# java多线程基础\n\n## 线程安全性\n当多个线程访问莫个类时，这个类始终都能表现出正确的行为，那么这个类就是线程安全的。\n在线程安全的类中封装了必要的同步机制，因此客户端无须进一步采取同步措施。\n**无状态对象一定是线程安全的。**\n\n## 保证线程安全性的三种方式\n1. 不在线程之间共享状态变量\n2. 将状态变量修改为不可变\n3. 访问状态变量时使用同步\n\n## 原子性\n在单核CPU中, 能够在一个指令中完成的操作都可以看作为原子操作, 因为中断只发生在指令间。\njava中对于非long和double基本数据类型的”简单操作”都可以看作是原子的。\n**long和double都是64位，jmm不保证操作的原子性。**\n\n## 可见性\n变量读取到的值，总是任何线程对该变量最后写入的值。\n**加锁不只局限于互斥行为，还包括了内存可见性。为了确保所有线程都能共享到变量最新的值，因此读或者写都必须在一个锁上同步。**\n\n## 顺序性\n在Java内存模型中，允许编译器和处理器对指令进行重排序，但是重排序过程不会影响到单线程程序的执行，却会影响到多线程并发执行的正确性。\nJava内存模型具备一些先天的“有序性”，即不需要通过任何手段就能够得到保证的有序性，这个通常也称为 happens-before 原则。\n如果两个操作的执行次序无法从happens-before原则推导出来，那么它们就不能保证它们的有序性，虚拟机可以随意地对它们进行重排序\n\n## 线程封闭和栈封闭\n线程封闭：变量只属于某个线程，例如通过 ThreadLocal来保持的线程变量。\n栈封闭是线程封闭的一种特例，在栈封闭中，只有通过局部对象才能访问对象。\n\n## 不变性\n不可变的对象一定是线程安全的。不可变不等于final，即使对象所有的域都是final的，对象也依然可能是可以变得。\nfinal 修饰引用类型只代表该引用不可变，不代表引用的对象不可变。final修饰简单值类型能保证是不可变的。\n满足一下条件对象才是不可变的。\n\n- 对象创建以后不可以修改\n- 对象创建以后不可以修改\n- 对象是正确创建的（this没有溢出）\n\n\n","slug":"java多线程基础","published":1,"updated":"2023-12-05T02:48:12.734Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdj2000qorgo13uf93h4","content":"<h1 id=\"java多线程基础\"><a href=\"#java多线程基础\" class=\"headerlink\" title=\"java多线程基础\"></a>java多线程基础</h1><h2 id=\"线程安全性\"><a href=\"#线程安全性\" class=\"headerlink\" title=\"线程安全性\"></a>线程安全性</h2><p>当多个线程访问莫个类时，这个类始终都能表现出正确的行为，那么这个类就是线程安全的。<br>在线程安全的类中封装了必要的同步机制，因此客户端无须进一步采取同步措施。<br><strong>无状态对象一定是线程安全的。</strong></p>\n<h2 id=\"保证线程安全性的三种方式\"><a href=\"#保证线程安全性的三种方式\" class=\"headerlink\" title=\"保证线程安全性的三种方式\"></a>保证线程安全性的三种方式</h2><ol>\n<li>不在线程之间共享状态变量</li>\n<li>将状态变量修改为不可变</li>\n<li>访问状态变量时使用同步</li>\n</ol>\n<h2 id=\"原子性\"><a href=\"#原子性\" class=\"headerlink\" title=\"原子性\"></a>原子性</h2><p>在单核CPU中, 能够在一个指令中完成的操作都可以看作为原子操作, 因为中断只发生在指令间。<br>java中对于非long和double基本数据类型的”简单操作”都可以看作是原子的。<br><strong>long和double都是64位，jmm不保证操作的原子性。</strong></p>\n<h2 id=\"可见性\"><a href=\"#可见性\" class=\"headerlink\" title=\"可见性\"></a>可见性</h2><p>变量读取到的值，总是任何线程对该变量最后写入的值。<br><strong>加锁不只局限于互斥行为，还包括了内存可见性。为了确保所有线程都能共享到变量最新的值，因此读或者写都必须在一个锁上同步。</strong></p>\n<h2 id=\"顺序性\"><a href=\"#顺序性\" class=\"headerlink\" title=\"顺序性\"></a>顺序性</h2><p>在Java内存模型中，允许编译器和处理器对指令进行重排序，但是重排序过程不会影响到单线程程序的执行，却会影响到多线程并发执行的正确性。<br>Java内存模型具备一些先天的“有序性”，即不需要通过任何手段就能够得到保证的有序性，这个通常也称为 happens-before 原则。<br>如果两个操作的执行次序无法从happens-before原则推导出来，那么它们就不能保证它们的有序性，虚拟机可以随意地对它们进行重排序</p>\n<h2 id=\"线程封闭和栈封闭\"><a href=\"#线程封闭和栈封闭\" class=\"headerlink\" title=\"线程封闭和栈封闭\"></a>线程封闭和栈封闭</h2><p>线程封闭：变量只属于某个线程，例如通过 ThreadLocal来保持的线程变量。<br>栈封闭是线程封闭的一种特例，在栈封闭中，只有通过局部对象才能访问对象。</p>\n<h2 id=\"不变性\"><a href=\"#不变性\" class=\"headerlink\" title=\"不变性\"></a>不变性</h2><p>不可变的对象一定是线程安全的。不可变不等于final，即使对象所有的域都是final的，对象也依然可能是可以变得。<br>final 修饰引用类型只代表该引用不可变，不代表引用的对象不可变。final修饰简单值类型能保证是不可变的。<br>满足一下条件对象才是不可变的。</p>\n<ul>\n<li>对象创建以后不可以修改</li>\n<li>对象创建以后不可以修改</li>\n<li>对象是正确创建的（this没有溢出）</li>\n</ul>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"java多线程基础\"><a href=\"#java多线程基础\" class=\"headerlink\" title=\"java多线程基础\"></a>java多线程基础</h1><h2 id=\"线程安全性\"><a href=\"#线程安全性\" class=\"headerlink\" title=\"线程安全性\"></a>线程安全性</h2><p>当多个线程访问莫个类时，这个类始终都能表现出正确的行为，那么这个类就是线程安全的。<br>在线程安全的类中封装了必要的同步机制，因此客户端无须进一步采取同步措施。<br><strong>无状态对象一定是线程安全的。</strong></p>\n<h2 id=\"保证线程安全性的三种方式\"><a href=\"#保证线程安全性的三种方式\" class=\"headerlink\" title=\"保证线程安全性的三种方式\"></a>保证线程安全性的三种方式</h2><ol>\n<li>不在线程之间共享状态变量</li>\n<li>将状态变量修改为不可变</li>\n<li>访问状态变量时使用同步</li>\n</ol>\n<h2 id=\"原子性\"><a href=\"#原子性\" class=\"headerlink\" title=\"原子性\"></a>原子性</h2><p>在单核CPU中, 能够在一个指令中完成的操作都可以看作为原子操作, 因为中断只发生在指令间。<br>java中对于非long和double基本数据类型的”简单操作”都可以看作是原子的。<br><strong>long和double都是64位，jmm不保证操作的原子性。</strong></p>\n<h2 id=\"可见性\"><a href=\"#可见性\" class=\"headerlink\" title=\"可见性\"></a>可见性</h2><p>变量读取到的值，总是任何线程对该变量最后写入的值。<br><strong>加锁不只局限于互斥行为，还包括了内存可见性。为了确保所有线程都能共享到变量最新的值，因此读或者写都必须在一个锁上同步。</strong></p>\n<h2 id=\"顺序性\"><a href=\"#顺序性\" class=\"headerlink\" title=\"顺序性\"></a>顺序性</h2><p>在Java内存模型中，允许编译器和处理器对指令进行重排序，但是重排序过程不会影响到单线程程序的执行，却会影响到多线程并发执行的正确性。<br>Java内存模型具备一些先天的“有序性”，即不需要通过任何手段就能够得到保证的有序性，这个通常也称为 happens-before 原则。<br>如果两个操作的执行次序无法从happens-before原则推导出来，那么它们就不能保证它们的有序性，虚拟机可以随意地对它们进行重排序</p>\n<h2 id=\"线程封闭和栈封闭\"><a href=\"#线程封闭和栈封闭\" class=\"headerlink\" title=\"线程封闭和栈封闭\"></a>线程封闭和栈封闭</h2><p>线程封闭：变量只属于某个线程，例如通过 ThreadLocal来保持的线程变量。<br>栈封闭是线程封闭的一种特例，在栈封闭中，只有通过局部对象才能访问对象。</p>\n<h2 id=\"不变性\"><a href=\"#不变性\" class=\"headerlink\" title=\"不变性\"></a>不变性</h2><p>不可变的对象一定是线程安全的。不可变不等于final，即使对象所有的域都是final的，对象也依然可能是可以变得。<br>final 修饰引用类型只代表该引用不可变，不代表引用的对象不可变。final修饰简单值类型能保证是不可变的。<br>满足一下条件对象才是不可变的。</p>\n<ul>\n<li>对象创建以后不可以修改</li>\n<li>对象创建以后不可以修改</li>\n<li>对象是正确创建的（this没有溢出）</li>\n</ul>\n"},{"title":"java内存结构和内存模型","abbrlink":12456,"date":"2023-06-20T06:13:32.000Z","_content":"# java内存结构和内存模型\n\n## java内存结构\njava内存结构大致分为以下几个区域\n{% asset_img 1.png  image %}\n\n## PC寄存器/程序计数器\n\n严格来说是一个数据结构，用于保存当前正在执行的程序的内存地址，由于Java是支持多线程执行的，所以程序执行的轨迹不可能一直都是线性执行。当有多个线程交叉执行时，被中断的线程的程序当前执行到哪条内存地址必然要保存下来，以便用于被中断的线程恢复执行时再按照被中断时的指令地址继续执行下去。 为了线程切换后能恢复到正确的执行位置，每个线程都需要有一个独立的程序计数器，各个线程之间计数器互不影响，独立存储，我们称这类内存区域为“线程私有”的内存,这在某种程度上有点类似于“ThreadLocal”，是线程安全的。\n\n## Java栈 Java Stack\njava栈总是与线程关联在一起的，每当创建一个线程，JVM就会为该线程创建对应的Java栈，在这个Java栈中又会包含多个栈帧(Stack Frame)，这些栈帧是与每个方法关联起来的，每运行一个方法就创建一个栈帧，每个栈帧会含有一些局部变量、操作栈和方法返回值等信息。每当一个方法执行完成时，该栈帧就会弹出栈帧的元素作为这个方法的返回值，并且清除这个栈帧，Java栈的栈顶的栈帧就是当前正在执行的活动栈，也就是当前正在执行的方法，PC寄存器也会指向该地址。只有这个活动的栈帧的本地变量可以被操作栈使用，当在这个栈帧中调用另外一个方法时，与之对应的一个新的栈帧被创建，这个新创建的栈帧被放到Java栈的栈顶，变为当前的活动栈。同样现在只有这个栈的本地变量才能被使用，当这个栈帧中所有指令都完成时，这个栈帧被移除Java栈，刚才的那个栈帧变为活动栈帧，前面栈帧的返回值变为这个栈帧的操作栈的一个操作数。\n\n由于Java栈是与线程对应起来的，Java栈数据不是线程共有的，所以不需要关心其数据一致性，也不会存在同步锁的问题。\n\n在Java虚拟机规范中，对这个区域规定了两种异常状况：如果线程请求的栈深度大于虚拟机所允许的深度，将抛出StackOverflowError异常；如果虚拟机可以动态扩展，如果扩展时无法申请到足够的内存，就会抛出OutOfMemoryError异常。\n\n## 堆Heap\n堆是JVM所管理的内存中最大的一块，是被所有Java线程锁共享的，不是线程安全的，在JVM启动时创建。 堆是存储Java对象的地方，这一点Java虚拟机规范中描述是：所有的对象实例以及数组都要在堆上分配。Java堆是GC管理的主要区域，从内存回收的角度来看，由于现在GC基本都采用分代收集算法，所以Java堆还可以细分为：新生代和老年代；新生代再细致一点有Eden空间、From Survivor空间、To Survivor空间等。\n\n## 方法区Method Area\n方法区存放了要加载的类的信息（名称、修饰符等）、类中的静态常量、类中定义为final类型的常量、类中的Field信息、类中的方法信息，当在程序中通过Class对象的getName.isInterface等方法来获取信息时，这些数据都来源于方法区。方法区是被Java线程锁共享的，不像Java堆中其他部分一样会频繁被GC回收，它存储的信息相对比较稳定，在一定条件下会被GC，当方法区要使用的内存超过其允许的大小时，会抛出OutOfMemory的错误信息。方法区也是堆中的一部分，就是我们通常所说的Java堆中的永久区 Permanet Generation，大小可以通过参数来设置,可以通过-XX:PermSize指定初始值，-XX:MaxPermSize指定最大值。\n\n## 常量池Constant Pool\n常量池本身是方法区中的一个数据结构。常量池中存储了如字符串、final变量值、类名和方法名常量。常量池在编译期间就被确定，并保存在已编译的.class文件中。一般分为两类：字面量和应用量。字面量就是字符串、final变量等。类名和方法名属于引用量。引用量最常见的是在调用方法的时候，根据方法名找到方法的引用，并以此定为到函数体进行函数代码的执行。引用量包含：类和接口的权限定名、字段的名称和描述符，方法的名称和描述符\n\n## 本地方法栈Native Method Stack\n本地方法栈和Java栈所发挥的作用非常相似，区别不过是Java栈为JVM执行Java方法服务，而本地方法栈为JVM执行Native方法服务。\n\n## java内存模型 jmm\n\nJMM规定了所有的变量都存储在主内存（Main Memory）中。每个线程还有自己的工作内存（Working Memory）,线程的工作内存中保存了该线程使用到的变量的主内存的副本拷贝，线程对变量的所有操作（读取、赋值等）都必须在工作内存中进行，而不能直接读写主内存中的变量（volatile变量仍然有工作内存的拷贝，但是由于它特殊的操作顺序性规定，所以看起来如同直接在主内存中读写访问一般）。不同的线程之间也无法直接访问对方工作内存中的变量，线程之间值的传递都需要通过主内存来完成。\n**工作内存线程独享，主内存线程共享**\n","source":"_posts/java内存结构和内存模型.md","raw":"---\ntitle: java内存结构和内存模型\ntags:\n  - java\nabbrlink: 12456\ndate: 2023-06-20 14:13:32\n---\n# java内存结构和内存模型\n\n## java内存结构\njava内存结构大致分为以下几个区域\n{% asset_img 1.png  image %}\n\n## PC寄存器/程序计数器\n\n严格来说是一个数据结构，用于保存当前正在执行的程序的内存地址，由于Java是支持多线程执行的，所以程序执行的轨迹不可能一直都是线性执行。当有多个线程交叉执行时，被中断的线程的程序当前执行到哪条内存地址必然要保存下来，以便用于被中断的线程恢复执行时再按照被中断时的指令地址继续执行下去。 为了线程切换后能恢复到正确的执行位置，每个线程都需要有一个独立的程序计数器，各个线程之间计数器互不影响，独立存储，我们称这类内存区域为“线程私有”的内存,这在某种程度上有点类似于“ThreadLocal”，是线程安全的。\n\n## Java栈 Java Stack\njava栈总是与线程关联在一起的，每当创建一个线程，JVM就会为该线程创建对应的Java栈，在这个Java栈中又会包含多个栈帧(Stack Frame)，这些栈帧是与每个方法关联起来的，每运行一个方法就创建一个栈帧，每个栈帧会含有一些局部变量、操作栈和方法返回值等信息。每当一个方法执行完成时，该栈帧就会弹出栈帧的元素作为这个方法的返回值，并且清除这个栈帧，Java栈的栈顶的栈帧就是当前正在执行的活动栈，也就是当前正在执行的方法，PC寄存器也会指向该地址。只有这个活动的栈帧的本地变量可以被操作栈使用，当在这个栈帧中调用另外一个方法时，与之对应的一个新的栈帧被创建，这个新创建的栈帧被放到Java栈的栈顶，变为当前的活动栈。同样现在只有这个栈的本地变量才能被使用，当这个栈帧中所有指令都完成时，这个栈帧被移除Java栈，刚才的那个栈帧变为活动栈帧，前面栈帧的返回值变为这个栈帧的操作栈的一个操作数。\n\n由于Java栈是与线程对应起来的，Java栈数据不是线程共有的，所以不需要关心其数据一致性，也不会存在同步锁的问题。\n\n在Java虚拟机规范中，对这个区域规定了两种异常状况：如果线程请求的栈深度大于虚拟机所允许的深度，将抛出StackOverflowError异常；如果虚拟机可以动态扩展，如果扩展时无法申请到足够的内存，就会抛出OutOfMemoryError异常。\n\n## 堆Heap\n堆是JVM所管理的内存中最大的一块，是被所有Java线程锁共享的，不是线程安全的，在JVM启动时创建。 堆是存储Java对象的地方，这一点Java虚拟机规范中描述是：所有的对象实例以及数组都要在堆上分配。Java堆是GC管理的主要区域，从内存回收的角度来看，由于现在GC基本都采用分代收集算法，所以Java堆还可以细分为：新生代和老年代；新生代再细致一点有Eden空间、From Survivor空间、To Survivor空间等。\n\n## 方法区Method Area\n方法区存放了要加载的类的信息（名称、修饰符等）、类中的静态常量、类中定义为final类型的常量、类中的Field信息、类中的方法信息，当在程序中通过Class对象的getName.isInterface等方法来获取信息时，这些数据都来源于方法区。方法区是被Java线程锁共享的，不像Java堆中其他部分一样会频繁被GC回收，它存储的信息相对比较稳定，在一定条件下会被GC，当方法区要使用的内存超过其允许的大小时，会抛出OutOfMemory的错误信息。方法区也是堆中的一部分，就是我们通常所说的Java堆中的永久区 Permanet Generation，大小可以通过参数来设置,可以通过-XX:PermSize指定初始值，-XX:MaxPermSize指定最大值。\n\n## 常量池Constant Pool\n常量池本身是方法区中的一个数据结构。常量池中存储了如字符串、final变量值、类名和方法名常量。常量池在编译期间就被确定，并保存在已编译的.class文件中。一般分为两类：字面量和应用量。字面量就是字符串、final变量等。类名和方法名属于引用量。引用量最常见的是在调用方法的时候，根据方法名找到方法的引用，并以此定为到函数体进行函数代码的执行。引用量包含：类和接口的权限定名、字段的名称和描述符，方法的名称和描述符\n\n## 本地方法栈Native Method Stack\n本地方法栈和Java栈所发挥的作用非常相似，区别不过是Java栈为JVM执行Java方法服务，而本地方法栈为JVM执行Native方法服务。\n\n## java内存模型 jmm\n\nJMM规定了所有的变量都存储在主内存（Main Memory）中。每个线程还有自己的工作内存（Working Memory）,线程的工作内存中保存了该线程使用到的变量的主内存的副本拷贝，线程对变量的所有操作（读取、赋值等）都必须在工作内存中进行，而不能直接读写主内存中的变量（volatile变量仍然有工作内存的拷贝，但是由于它特殊的操作顺序性规定，所以看起来如同直接在主内存中读写访问一般）。不同的线程之间也无法直接访问对方工作内存中的变量，线程之间值的传递都需要通过主内存来完成。\n**工作内存线程独享，主内存线程共享**\n","slug":"java内存结构和内存模型","published":1,"updated":"2023-12-05T02:48:12.734Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdj3000sorgo17014ik3","content":"<h1 id=\"java内存结构和内存模型\"><a href=\"#java内存结构和内存模型\" class=\"headerlink\" title=\"java内存结构和内存模型\"></a>java内存结构和内存模型</h1><h2 id=\"java内存结构\"><a href=\"#java内存结构\" class=\"headerlink\" title=\"java内存结构\"></a>java内存结构</h2><p>java内存结构大致分为以下几个区域</p>\n<img src=\"/2023062012456/1.png\" class=\"\" title=\"image\">\n\n<h2 id=\"PC寄存器-x2F-程序计数器\"><a href=\"#PC寄存器-x2F-程序计数器\" class=\"headerlink\" title=\"PC寄存器&#x2F;程序计数器\"></a>PC寄存器&#x2F;程序计数器</h2><p>严格来说是一个数据结构，用于保存当前正在执行的程序的内存地址，由于Java是支持多线程执行的，所以程序执行的轨迹不可能一直都是线性执行。当有多个线程交叉执行时，被中断的线程的程序当前执行到哪条内存地址必然要保存下来，以便用于被中断的线程恢复执行时再按照被中断时的指令地址继续执行下去。 为了线程切换后能恢复到正确的执行位置，每个线程都需要有一个独立的程序计数器，各个线程之间计数器互不影响，独立存储，我们称这类内存区域为“线程私有”的内存,这在某种程度上有点类似于“ThreadLocal”，是线程安全的。</p>\n<h2 id=\"Java栈-Java-Stack\"><a href=\"#Java栈-Java-Stack\" class=\"headerlink\" title=\"Java栈 Java Stack\"></a>Java栈 Java Stack</h2><p>java栈总是与线程关联在一起的，每当创建一个线程，JVM就会为该线程创建对应的Java栈，在这个Java栈中又会包含多个栈帧(Stack Frame)，这些栈帧是与每个方法关联起来的，每运行一个方法就创建一个栈帧，每个栈帧会含有一些局部变量、操作栈和方法返回值等信息。每当一个方法执行完成时，该栈帧就会弹出栈帧的元素作为这个方法的返回值，并且清除这个栈帧，Java栈的栈顶的栈帧就是当前正在执行的活动栈，也就是当前正在执行的方法，PC寄存器也会指向该地址。只有这个活动的栈帧的本地变量可以被操作栈使用，当在这个栈帧中调用另外一个方法时，与之对应的一个新的栈帧被创建，这个新创建的栈帧被放到Java栈的栈顶，变为当前的活动栈。同样现在只有这个栈的本地变量才能被使用，当这个栈帧中所有指令都完成时，这个栈帧被移除Java栈，刚才的那个栈帧变为活动栈帧，前面栈帧的返回值变为这个栈帧的操作栈的一个操作数。</p>\n<p>由于Java栈是与线程对应起来的，Java栈数据不是线程共有的，所以不需要关心其数据一致性，也不会存在同步锁的问题。</p>\n<p>在Java虚拟机规范中，对这个区域规定了两种异常状况：如果线程请求的栈深度大于虚拟机所允许的深度，将抛出StackOverflowError异常；如果虚拟机可以动态扩展，如果扩展时无法申请到足够的内存，就会抛出OutOfMemoryError异常。</p>\n<h2 id=\"堆Heap\"><a href=\"#堆Heap\" class=\"headerlink\" title=\"堆Heap\"></a>堆Heap</h2><p>堆是JVM所管理的内存中最大的一块，是被所有Java线程锁共享的，不是线程安全的，在JVM启动时创建。 堆是存储Java对象的地方，这一点Java虚拟机规范中描述是：所有的对象实例以及数组都要在堆上分配。Java堆是GC管理的主要区域，从内存回收的角度来看，由于现在GC基本都采用分代收集算法，所以Java堆还可以细分为：新生代和老年代；新生代再细致一点有Eden空间、From Survivor空间、To Survivor空间等。</p>\n<h2 id=\"方法区Method-Area\"><a href=\"#方法区Method-Area\" class=\"headerlink\" title=\"方法区Method Area\"></a>方法区Method Area</h2><p>方法区存放了要加载的类的信息（名称、修饰符等）、类中的静态常量、类中定义为final类型的常量、类中的Field信息、类中的方法信息，当在程序中通过Class对象的getName.isInterface等方法来获取信息时，这些数据都来源于方法区。方法区是被Java线程锁共享的，不像Java堆中其他部分一样会频繁被GC回收，它存储的信息相对比较稳定，在一定条件下会被GC，当方法区要使用的内存超过其允许的大小时，会抛出OutOfMemory的错误信息。方法区也是堆中的一部分，就是我们通常所说的Java堆中的永久区 Permanet Generation，大小可以通过参数来设置,可以通过-XX:PermSize指定初始值，-XX:MaxPermSize指定最大值。</p>\n<h2 id=\"常量池Constant-Pool\"><a href=\"#常量池Constant-Pool\" class=\"headerlink\" title=\"常量池Constant Pool\"></a>常量池Constant Pool</h2><p>常量池本身是方法区中的一个数据结构。常量池中存储了如字符串、final变量值、类名和方法名常量。常量池在编译期间就被确定，并保存在已编译的.class文件中。一般分为两类：字面量和应用量。字面量就是字符串、final变量等。类名和方法名属于引用量。引用量最常见的是在调用方法的时候，根据方法名找到方法的引用，并以此定为到函数体进行函数代码的执行。引用量包含：类和接口的权限定名、字段的名称和描述符，方法的名称和描述符</p>\n<h2 id=\"本地方法栈Native-Method-Stack\"><a href=\"#本地方法栈Native-Method-Stack\" class=\"headerlink\" title=\"本地方法栈Native Method Stack\"></a>本地方法栈Native Method Stack</h2><p>本地方法栈和Java栈所发挥的作用非常相似，区别不过是Java栈为JVM执行Java方法服务，而本地方法栈为JVM执行Native方法服务。</p>\n<h2 id=\"java内存模型-jmm\"><a href=\"#java内存模型-jmm\" class=\"headerlink\" title=\"java内存模型 jmm\"></a>java内存模型 jmm</h2><p>JMM规定了所有的变量都存储在主内存（Main Memory）中。每个线程还有自己的工作内存（Working Memory）,线程的工作内存中保存了该线程使用到的变量的主内存的副本拷贝，线程对变量的所有操作（读取、赋值等）都必须在工作内存中进行，而不能直接读写主内存中的变量（volatile变量仍然有工作内存的拷贝，但是由于它特殊的操作顺序性规定，所以看起来如同直接在主内存中读写访问一般）。不同的线程之间也无法直接访问对方工作内存中的变量，线程之间值的传递都需要通过主内存来完成。<br><strong>工作内存线程独享，主内存线程共享</strong></p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"java内存结构和内存模型\"><a href=\"#java内存结构和内存模型\" class=\"headerlink\" title=\"java内存结构和内存模型\"></a>java内存结构和内存模型</h1><h2 id=\"java内存结构\"><a href=\"#java内存结构\" class=\"headerlink\" title=\"java内存结构\"></a>java内存结构</h2><p>java内存结构大致分为以下几个区域</p>\n<img src=\"/2023062012456/1.png\" class=\"\" title=\"image\">\n\n<h2 id=\"PC寄存器-x2F-程序计数器\"><a href=\"#PC寄存器-x2F-程序计数器\" class=\"headerlink\" title=\"PC寄存器&#x2F;程序计数器\"></a>PC寄存器&#x2F;程序计数器</h2><p>严格来说是一个数据结构，用于保存当前正在执行的程序的内存地址，由于Java是支持多线程执行的，所以程序执行的轨迹不可能一直都是线性执行。当有多个线程交叉执行时，被中断的线程的程序当前执行到哪条内存地址必然要保存下来，以便用于被中断的线程恢复执行时再按照被中断时的指令地址继续执行下去。 为了线程切换后能恢复到正确的执行位置，每个线程都需要有一个独立的程序计数器，各个线程之间计数器互不影响，独立存储，我们称这类内存区域为“线程私有”的内存,这在某种程度上有点类似于“ThreadLocal”，是线程安全的。</p>\n<h2 id=\"Java栈-Java-Stack\"><a href=\"#Java栈-Java-Stack\" class=\"headerlink\" title=\"Java栈 Java Stack\"></a>Java栈 Java Stack</h2><p>java栈总是与线程关联在一起的，每当创建一个线程，JVM就会为该线程创建对应的Java栈，在这个Java栈中又会包含多个栈帧(Stack Frame)，这些栈帧是与每个方法关联起来的，每运行一个方法就创建一个栈帧，每个栈帧会含有一些局部变量、操作栈和方法返回值等信息。每当一个方法执行完成时，该栈帧就会弹出栈帧的元素作为这个方法的返回值，并且清除这个栈帧，Java栈的栈顶的栈帧就是当前正在执行的活动栈，也就是当前正在执行的方法，PC寄存器也会指向该地址。只有这个活动的栈帧的本地变量可以被操作栈使用，当在这个栈帧中调用另外一个方法时，与之对应的一个新的栈帧被创建，这个新创建的栈帧被放到Java栈的栈顶，变为当前的活动栈。同样现在只有这个栈的本地变量才能被使用，当这个栈帧中所有指令都完成时，这个栈帧被移除Java栈，刚才的那个栈帧变为活动栈帧，前面栈帧的返回值变为这个栈帧的操作栈的一个操作数。</p>\n<p>由于Java栈是与线程对应起来的，Java栈数据不是线程共有的，所以不需要关心其数据一致性，也不会存在同步锁的问题。</p>\n<p>在Java虚拟机规范中，对这个区域规定了两种异常状况：如果线程请求的栈深度大于虚拟机所允许的深度，将抛出StackOverflowError异常；如果虚拟机可以动态扩展，如果扩展时无法申请到足够的内存，就会抛出OutOfMemoryError异常。</p>\n<h2 id=\"堆Heap\"><a href=\"#堆Heap\" class=\"headerlink\" title=\"堆Heap\"></a>堆Heap</h2><p>堆是JVM所管理的内存中最大的一块，是被所有Java线程锁共享的，不是线程安全的，在JVM启动时创建。 堆是存储Java对象的地方，这一点Java虚拟机规范中描述是：所有的对象实例以及数组都要在堆上分配。Java堆是GC管理的主要区域，从内存回收的角度来看，由于现在GC基本都采用分代收集算法，所以Java堆还可以细分为：新生代和老年代；新生代再细致一点有Eden空间、From Survivor空间、To Survivor空间等。</p>\n<h2 id=\"方法区Method-Area\"><a href=\"#方法区Method-Area\" class=\"headerlink\" title=\"方法区Method Area\"></a>方法区Method Area</h2><p>方法区存放了要加载的类的信息（名称、修饰符等）、类中的静态常量、类中定义为final类型的常量、类中的Field信息、类中的方法信息，当在程序中通过Class对象的getName.isInterface等方法来获取信息时，这些数据都来源于方法区。方法区是被Java线程锁共享的，不像Java堆中其他部分一样会频繁被GC回收，它存储的信息相对比较稳定，在一定条件下会被GC，当方法区要使用的内存超过其允许的大小时，会抛出OutOfMemory的错误信息。方法区也是堆中的一部分，就是我们通常所说的Java堆中的永久区 Permanet Generation，大小可以通过参数来设置,可以通过-XX:PermSize指定初始值，-XX:MaxPermSize指定最大值。</p>\n<h2 id=\"常量池Constant-Pool\"><a href=\"#常量池Constant-Pool\" class=\"headerlink\" title=\"常量池Constant Pool\"></a>常量池Constant Pool</h2><p>常量池本身是方法区中的一个数据结构。常量池中存储了如字符串、final变量值、类名和方法名常量。常量池在编译期间就被确定，并保存在已编译的.class文件中。一般分为两类：字面量和应用量。字面量就是字符串、final变量等。类名和方法名属于引用量。引用量最常见的是在调用方法的时候，根据方法名找到方法的引用，并以此定为到函数体进行函数代码的执行。引用量包含：类和接口的权限定名、字段的名称和描述符，方法的名称和描述符</p>\n<h2 id=\"本地方法栈Native-Method-Stack\"><a href=\"#本地方法栈Native-Method-Stack\" class=\"headerlink\" title=\"本地方法栈Native Method Stack\"></a>本地方法栈Native Method Stack</h2><p>本地方法栈和Java栈所发挥的作用非常相似，区别不过是Java栈为JVM执行Java方法服务，而本地方法栈为JVM执行Native方法服务。</p>\n<h2 id=\"java内存模型-jmm\"><a href=\"#java内存模型-jmm\" class=\"headerlink\" title=\"java内存模型 jmm\"></a>java内存模型 jmm</h2><p>JMM规定了所有的变量都存储在主内存（Main Memory）中。每个线程还有自己的工作内存（Working Memory）,线程的工作内存中保存了该线程使用到的变量的主内存的副本拷贝，线程对变量的所有操作（读取、赋值等）都必须在工作内存中进行，而不能直接读写主内存中的变量（volatile变量仍然有工作内存的拷贝，但是由于它特殊的操作顺序性规定，所以看起来如同直接在主内存中读写访问一般）。不同的线程之间也无法直接访问对方工作内存中的变量，线程之间值的传递都需要通过主内存来完成。<br><strong>工作内存线程独享，主内存线程共享</strong></p>\n"},{"title":"java线程状态","abbrlink":3579,"date":"2023-06-20T06:46:26.000Z","_content":"# java线程状态\njava线程有以下几个状态\n\n- new 初始状态\n- runnable 运行状态（包括就绪和运行）\n- blocked 阻塞状态\n- waiting 等待状态,需要其他线程特定动作唤醒（通知或者中断）\n- time-waiting 超时等待状态，可以在指定时间内返回。\n- terminated 终止状态\n\n## 创建\njava构造线程有两种办法,Thread类和Runnable接口,Thread的类本身实现了Runnable接口。\n常见的作法,是通过thread类的public Thread(Runnable target)构造函数来创建线程。\n\n{% codeblock  lang:java   %}\n\n    new Thread(new Runnable() {\n\t@Override\n\tpublic void run() {\n\t\t// TODO Auto-generated method stub\n\t\t\n\t}\n    });\n\n{% endcodeblock %}\n\nthread类的初始话代码\n{% codeblock  lang:java   %}\n\n    private void init(ThreadGroup g, Runnable target, String name,\n    long stackSize, AccessControlContext acc) {\n    if (name == null) {\n    throw new NullPointerException(\"name cannot be null\");\n    }\n    this.name = name;\n    Thread parent = currentThread();\n    SecurityManager security = System.getSecurityManager();\n    if (g == null) {\n    if (security != null) {\n    g = security.getThreadGroup();\n    }\n\n        if (g == null) {\n            g = parent.getThreadGroup();\n        }\n    }\n   \n    g.checkAccess();\n \n    if (security != null) {\n        if (isCCLOverridden(getClass())) {\n            security.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION);\n        }\n    }\n    g.addUnstarted();\n    this.group = g;\n    this.daemon = parent.isDaemon();\n    this.priority = parent.getPriority();\n    if (security == null || isCCLOverridden(parent.getClass()))\n        this.contextClassLoader = parent.getContextClassLoader();\n    else\n        this.contextClassLoader = parent.contextClassLoader;\n    this.inheritedAccessControlContext =\n            acc != null ? acc : AccessController.getContext();\n    this.target = target;\n    setPriority(priority);\n    if (parent.inheritableThreadLocals != null)\n        this.inheritableThreadLocals =\n            ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);\n    this.stackSize = stackSize;\n   \n    tid = nextThreadID();\n    }\n\n\n{% endcodeblock %}\n\n从这段代码可以看出以下几点\n当前线程为创建线程的父线程\nchild线程继承parent的Daemon、优先级、和加载资源的contextClassLoader和一个可以继承的ThreadLocal。\n**Daemon线程（后台线程）的finally块代码不会执行**\n\n## 运行\nThread类的start方法起来运行线程。底层通过调用navate方法来运行线程。\n**start（）方法来启动线程，真正实现了多线程运行，这时无需等待run方法体代码执行完毕而直接继续执行下面的代码**\n**run（）方法当作普通方法的方式调用，程序还是要顺序执行，还是要等待run方法体执行完毕后才可继续执行下面的代码**\n\n## 阻塞\n线程执行到monitorenter保护的代码快时，会去获取monitorenter对应的对象锁，如未获取，则该线程进入同步队列，状态为阻塞。\n**任意对象都拥有自己的monitor，包括class对象。**\n\n## 等待/唤醒\n线程等待的方法主要有下面几种\n- object.wait() / object.wait(long)\n- object.join() / object.join(long)\n- lockSupport.park() / lockSupport.park(long)\n\n当线程调用某个对象的wati方法，进入等待。当另一个线程调用该对象的notify()/notifyall()方法，之前等待的线程唤醒。\n线程唤醒的方法注意下面几种\n- object.notify()/notifyAll()\n- lockSupport.unpark(Thread)\n\n\n**调用对象wait或者notify方法的前题是获取当前对象的内置锁。**\n\n通过wait/notify设计的经典作法\n等待方：\n- 获取对象锁\n- 条件检查\n- 为假则等待\n- 为真则执行后面的逻辑\n唤醒方：\n- 获取对象锁\n- 改变条件\n- 通知所有等待在对象的线程\n\n**条件变量用volatile修饰来保证可见性**\n\n## 终止\n线程对应的run方法运行完毕，则线程终止。不推荐使用stop来终止线程。可以通过状态变量来终止线程。\n\n\n","source":"_posts/java线程状态.md","raw":"---\ntitle: java线程状态\ntags:\n  - java\nabbrlink: 3579\ndate: 2023-06-20 14:46:26\n---\n# java线程状态\njava线程有以下几个状态\n\n- new 初始状态\n- runnable 运行状态（包括就绪和运行）\n- blocked 阻塞状态\n- waiting 等待状态,需要其他线程特定动作唤醒（通知或者中断）\n- time-waiting 超时等待状态，可以在指定时间内返回。\n- terminated 终止状态\n\n## 创建\njava构造线程有两种办法,Thread类和Runnable接口,Thread的类本身实现了Runnable接口。\n常见的作法,是通过thread类的public Thread(Runnable target)构造函数来创建线程。\n\n{% codeblock  lang:java   %}\n\n    new Thread(new Runnable() {\n\t@Override\n\tpublic void run() {\n\t\t// TODO Auto-generated method stub\n\t\t\n\t}\n    });\n\n{% endcodeblock %}\n\nthread类的初始话代码\n{% codeblock  lang:java   %}\n\n    private void init(ThreadGroup g, Runnable target, String name,\n    long stackSize, AccessControlContext acc) {\n    if (name == null) {\n    throw new NullPointerException(\"name cannot be null\");\n    }\n    this.name = name;\n    Thread parent = currentThread();\n    SecurityManager security = System.getSecurityManager();\n    if (g == null) {\n    if (security != null) {\n    g = security.getThreadGroup();\n    }\n\n        if (g == null) {\n            g = parent.getThreadGroup();\n        }\n    }\n   \n    g.checkAccess();\n \n    if (security != null) {\n        if (isCCLOverridden(getClass())) {\n            security.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION);\n        }\n    }\n    g.addUnstarted();\n    this.group = g;\n    this.daemon = parent.isDaemon();\n    this.priority = parent.getPriority();\n    if (security == null || isCCLOverridden(parent.getClass()))\n        this.contextClassLoader = parent.getContextClassLoader();\n    else\n        this.contextClassLoader = parent.contextClassLoader;\n    this.inheritedAccessControlContext =\n            acc != null ? acc : AccessController.getContext();\n    this.target = target;\n    setPriority(priority);\n    if (parent.inheritableThreadLocals != null)\n        this.inheritableThreadLocals =\n            ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);\n    this.stackSize = stackSize;\n   \n    tid = nextThreadID();\n    }\n\n\n{% endcodeblock %}\n\n从这段代码可以看出以下几点\n当前线程为创建线程的父线程\nchild线程继承parent的Daemon、优先级、和加载资源的contextClassLoader和一个可以继承的ThreadLocal。\n**Daemon线程（后台线程）的finally块代码不会执行**\n\n## 运行\nThread类的start方法起来运行线程。底层通过调用navate方法来运行线程。\n**start（）方法来启动线程，真正实现了多线程运行，这时无需等待run方法体代码执行完毕而直接继续执行下面的代码**\n**run（）方法当作普通方法的方式调用，程序还是要顺序执行，还是要等待run方法体执行完毕后才可继续执行下面的代码**\n\n## 阻塞\n线程执行到monitorenter保护的代码快时，会去获取monitorenter对应的对象锁，如未获取，则该线程进入同步队列，状态为阻塞。\n**任意对象都拥有自己的monitor，包括class对象。**\n\n## 等待/唤醒\n线程等待的方法主要有下面几种\n- object.wait() / object.wait(long)\n- object.join() / object.join(long)\n- lockSupport.park() / lockSupport.park(long)\n\n当线程调用某个对象的wati方法，进入等待。当另一个线程调用该对象的notify()/notifyall()方法，之前等待的线程唤醒。\n线程唤醒的方法注意下面几种\n- object.notify()/notifyAll()\n- lockSupport.unpark(Thread)\n\n\n**调用对象wait或者notify方法的前题是获取当前对象的内置锁。**\n\n通过wait/notify设计的经典作法\n等待方：\n- 获取对象锁\n- 条件检查\n- 为假则等待\n- 为真则执行后面的逻辑\n唤醒方：\n- 获取对象锁\n- 改变条件\n- 通知所有等待在对象的线程\n\n**条件变量用volatile修饰来保证可见性**\n\n## 终止\n线程对应的run方法运行完毕，则线程终止。不推荐使用stop来终止线程。可以通过状态变量来终止线程。\n\n\n","slug":"java线程状态","published":1,"updated":"2023-12-05T02:48:12.735Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdj4000uorgo1xieeed5","content":"<h1 id=\"java线程状态\"><a href=\"#java线程状态\" class=\"headerlink\" title=\"java线程状态\"></a>java线程状态</h1><p>java线程有以下几个状态</p>\n<ul>\n<li>new 初始状态</li>\n<li>runnable 运行状态（包括就绪和运行）</li>\n<li>blocked 阻塞状态</li>\n<li>waiting 等待状态,需要其他线程特定动作唤醒（通知或者中断）</li>\n<li>time-waiting 超时等待状态，可以在指定时间内返回。</li>\n<li>terminated 终止状态</li>\n</ul>\n<h2 id=\"创建\"><a href=\"#创建\" class=\"headerlink\" title=\"创建\"></a>创建</h2><p>java构造线程有两种办法,Thread类和Runnable接口,Thread的类本身实现了Runnable接口。<br>常见的作法,是通过thread类的public Thread(Runnable target)构造函数来创建线程。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123;</span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// TODO Auto-generated method stub</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">   &#125;);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>thread类的初始话代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">init</span><span class=\"params\">(ThreadGroup g, Runnable target, String name,</span></span><br><span class=\"line\"><span class=\"params\"><span class=\"type\">long</span> stackSize, AccessControlContext acc)</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (name == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NullPointerException</span>(<span class=\"string\">&quot;name cannot be null&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"built_in\">this</span>.name = name;</span><br><span class=\"line\"><span class=\"type\">Thread</span> <span class=\"variable\">parent</span> <span class=\"operator\">=</span> currentThread();</span><br><span class=\"line\"><span class=\"type\">SecurityManager</span> <span class=\"variable\">security</span> <span class=\"operator\">=</span> System.getSecurityManager();</span><br><span class=\"line\"><span class=\"keyword\">if</span> (g == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (security != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">g = security.getThreadGroup();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (g == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        g = parent.getThreadGroup();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">g.checkAccess();</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">if</span> (security != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isCCLOverridden(getClass())) &#123;</span><br><span class=\"line\">        security.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">g.addUnstarted();</span><br><span class=\"line\"><span class=\"built_in\">this</span>.group = g;</span><br><span class=\"line\"><span class=\"built_in\">this</span>.daemon = parent.isDaemon();</span><br><span class=\"line\"><span class=\"built_in\">this</span>.priority = parent.getPriority();</span><br><span class=\"line\"><span class=\"keyword\">if</span> (security == <span class=\"literal\">null</span> || isCCLOverridden(parent.getClass()))</span><br><span class=\"line\">    <span class=\"built_in\">this</span>.contextClassLoader = parent.getContextClassLoader();</span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">this</span>.contextClassLoader = parent.contextClassLoader;</span><br><span class=\"line\"><span class=\"built_in\">this</span>.inheritedAccessControlContext =</span><br><span class=\"line\">        acc != <span class=\"literal\">null</span> ? acc : AccessController.getContext();</span><br><span class=\"line\"><span class=\"built_in\">this</span>.target = target;</span><br><span class=\"line\">setPriority(priority);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (parent.inheritableThreadLocals != <span class=\"literal\">null</span>)</span><br><span class=\"line\">    <span class=\"built_in\">this</span>.inheritableThreadLocals =</span><br><span class=\"line\">        ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span><br><span class=\"line\"><span class=\"built_in\">this</span>.stackSize = stackSize;</span><br><span class=\"line\">   </span><br><span class=\"line\">tid = nextThreadID();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>从这段代码可以看出以下几点<br>当前线程为创建线程的父线程<br>child线程继承parent的Daemon、优先级、和加载资源的contextClassLoader和一个可以继承的ThreadLocal。<br><strong>Daemon线程（后台线程）的finally块代码不会执行</strong></p>\n<h2 id=\"运行\"><a href=\"#运行\" class=\"headerlink\" title=\"运行\"></a>运行</h2><p>Thread类的start方法起来运行线程。底层通过调用navate方法来运行线程。<br><strong>start（）方法来启动线程，真正实现了多线程运行，这时无需等待run方法体代码执行完毕而直接继续执行下面的代码</strong><br><strong>run（）方法当作普通方法的方式调用，程序还是要顺序执行，还是要等待run方法体执行完毕后才可继续执行下面的代码</strong></p>\n<h2 id=\"阻塞\"><a href=\"#阻塞\" class=\"headerlink\" title=\"阻塞\"></a>阻塞</h2><p>线程执行到monitorenter保护的代码快时，会去获取monitorenter对应的对象锁，如未获取，则该线程进入同步队列，状态为阻塞。<br><strong>任意对象都拥有自己的monitor，包括class对象。</strong></p>\n<h2 id=\"等待-x2F-唤醒\"><a href=\"#等待-x2F-唤醒\" class=\"headerlink\" title=\"等待&#x2F;唤醒\"></a>等待&#x2F;唤醒</h2><p>线程等待的方法主要有下面几种</p>\n<ul>\n<li>object.wait() &#x2F; object.wait(long)</li>\n<li>object.join() &#x2F; object.join(long)</li>\n<li>lockSupport.park() &#x2F; lockSupport.park(long)</li>\n</ul>\n<p>当线程调用某个对象的wati方法，进入等待。当另一个线程调用该对象的notify()&#x2F;notifyall()方法，之前等待的线程唤醒。<br>线程唤醒的方法注意下面几种</p>\n<ul>\n<li>object.notify()&#x2F;notifyAll()</li>\n<li>lockSupport.unpark(Thread)</li>\n</ul>\n<p><strong>调用对象wait或者notify方法的前题是获取当前对象的内置锁。</strong></p>\n<p>通过wait&#x2F;notify设计的经典作法<br>等待方：</p>\n<ul>\n<li>获取对象锁</li>\n<li>条件检查</li>\n<li>为假则等待</li>\n<li>为真则执行后面的逻辑<br>唤醒方：</li>\n<li>获取对象锁</li>\n<li>改变条件</li>\n<li>通知所有等待在对象的线程</li>\n</ul>\n<p><strong>条件变量用volatile修饰来保证可见性</strong></p>\n<h2 id=\"终止\"><a href=\"#终止\" class=\"headerlink\" title=\"终止\"></a>终止</h2><p>线程对应的run方法运行完毕，则线程终止。不推荐使用stop来终止线程。可以通过状态变量来终止线程。</p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"java线程状态\"><a href=\"#java线程状态\" class=\"headerlink\" title=\"java线程状态\"></a>java线程状态</h1><p>java线程有以下几个状态</p>\n<ul>\n<li>new 初始状态</li>\n<li>runnable 运行状态（包括就绪和运行）</li>\n<li>blocked 阻塞状态</li>\n<li>waiting 等待状态,需要其他线程特定动作唤醒（通知或者中断）</li>\n<li>time-waiting 超时等待状态，可以在指定时间内返回。</li>\n<li>terminated 终止状态</li>\n</ul>\n<h2 id=\"创建\"><a href=\"#创建\" class=\"headerlink\" title=\"创建\"></a>创建</h2><p>java构造线程有两种办法,Thread类和Runnable接口,Thread的类本身实现了Runnable接口。<br>常见的作法,是通过thread类的public Thread(Runnable target)构造函数来创建线程。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Runnable</span>() &#123;</span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">run</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// TODO Auto-generated method stub</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">   &#125;);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>thread类的初始话代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">init</span><span class=\"params\">(ThreadGroup g, Runnable target, String name,</span></span><br><span class=\"line\"><span class=\"params\"><span class=\"type\">long</span> stackSize, AccessControlContext acc)</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (name == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">NullPointerException</span>(<span class=\"string\">&quot;name cannot be null&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"built_in\">this</span>.name = name;</span><br><span class=\"line\"><span class=\"type\">Thread</span> <span class=\"variable\">parent</span> <span class=\"operator\">=</span> currentThread();</span><br><span class=\"line\"><span class=\"type\">SecurityManager</span> <span class=\"variable\">security</span> <span class=\"operator\">=</span> System.getSecurityManager();</span><br><span class=\"line\"><span class=\"keyword\">if</span> (g == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (security != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">g = security.getThreadGroup();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (g == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        g = parent.getThreadGroup();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">   </span><br><span class=\"line\">g.checkAccess();</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"keyword\">if</span> (security != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isCCLOverridden(getClass())) &#123;</span><br><span class=\"line\">        security.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">g.addUnstarted();</span><br><span class=\"line\"><span class=\"built_in\">this</span>.group = g;</span><br><span class=\"line\"><span class=\"built_in\">this</span>.daemon = parent.isDaemon();</span><br><span class=\"line\"><span class=\"built_in\">this</span>.priority = parent.getPriority();</span><br><span class=\"line\"><span class=\"keyword\">if</span> (security == <span class=\"literal\">null</span> || isCCLOverridden(parent.getClass()))</span><br><span class=\"line\">    <span class=\"built_in\">this</span>.contextClassLoader = parent.getContextClassLoader();</span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">this</span>.contextClassLoader = parent.contextClassLoader;</span><br><span class=\"line\"><span class=\"built_in\">this</span>.inheritedAccessControlContext =</span><br><span class=\"line\">        acc != <span class=\"literal\">null</span> ? acc : AccessController.getContext();</span><br><span class=\"line\"><span class=\"built_in\">this</span>.target = target;</span><br><span class=\"line\">setPriority(priority);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (parent.inheritableThreadLocals != <span class=\"literal\">null</span>)</span><br><span class=\"line\">    <span class=\"built_in\">this</span>.inheritableThreadLocals =</span><br><span class=\"line\">        ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span><br><span class=\"line\"><span class=\"built_in\">this</span>.stackSize = stackSize;</span><br><span class=\"line\">   </span><br><span class=\"line\">tid = nextThreadID();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>从这段代码可以看出以下几点<br>当前线程为创建线程的父线程<br>child线程继承parent的Daemon、优先级、和加载资源的contextClassLoader和一个可以继承的ThreadLocal。<br><strong>Daemon线程（后台线程）的finally块代码不会执行</strong></p>\n<h2 id=\"运行\"><a href=\"#运行\" class=\"headerlink\" title=\"运行\"></a>运行</h2><p>Thread类的start方法起来运行线程。底层通过调用navate方法来运行线程。<br><strong>start（）方法来启动线程，真正实现了多线程运行，这时无需等待run方法体代码执行完毕而直接继续执行下面的代码</strong><br><strong>run（）方法当作普通方法的方式调用，程序还是要顺序执行，还是要等待run方法体执行完毕后才可继续执行下面的代码</strong></p>\n<h2 id=\"阻塞\"><a href=\"#阻塞\" class=\"headerlink\" title=\"阻塞\"></a>阻塞</h2><p>线程执行到monitorenter保护的代码快时，会去获取monitorenter对应的对象锁，如未获取，则该线程进入同步队列，状态为阻塞。<br><strong>任意对象都拥有自己的monitor，包括class对象。</strong></p>\n<h2 id=\"等待-x2F-唤醒\"><a href=\"#等待-x2F-唤醒\" class=\"headerlink\" title=\"等待&#x2F;唤醒\"></a>等待&#x2F;唤醒</h2><p>线程等待的方法主要有下面几种</p>\n<ul>\n<li>object.wait() &#x2F; object.wait(long)</li>\n<li>object.join() &#x2F; object.join(long)</li>\n<li>lockSupport.park() &#x2F; lockSupport.park(long)</li>\n</ul>\n<p>当线程调用某个对象的wati方法，进入等待。当另一个线程调用该对象的notify()&#x2F;notifyall()方法，之前等待的线程唤醒。<br>线程唤醒的方法注意下面几种</p>\n<ul>\n<li>object.notify()&#x2F;notifyAll()</li>\n<li>lockSupport.unpark(Thread)</li>\n</ul>\n<p><strong>调用对象wait或者notify方法的前题是获取当前对象的内置锁。</strong></p>\n<p>通过wait&#x2F;notify设计的经典作法<br>等待方：</p>\n<ul>\n<li>获取对象锁</li>\n<li>条件检查</li>\n<li>为假则等待</li>\n<li>为真则执行后面的逻辑<br>唤醒方：</li>\n<li>获取对象锁</li>\n<li>改变条件</li>\n<li>通知所有等待在对象的线程</li>\n</ul>\n<p><strong>条件变量用volatile修饰来保证可见性</strong></p>\n<h2 id=\"终止\"><a href=\"#终止\" class=\"headerlink\" title=\"终止\"></a>终止</h2><p>线程对应的run方法运行完毕，则线程终止。不推荐使用stop来终止线程。可以通过状态变量来终止线程。</p>\n"},{"title":"jvm里面的access_flag","abbrlink":7816,"date":"2023-06-20T07:30:09.000Z","_content":"\n# jvm里面的access_flag\n\n## access_flag\n最近在看jvm相关知识，发现class字节码文件里面大量使用access_flag做标志位，其中做法非常nice。\n例如class字段描述，java里面字段修饰符有以下几个\n\n- public\n- private\n- protected\n- static\n- final\n- volatile\n- transient\n\n{% codeblock lang:java   %}\n\n    private static final  String a=\"abc\";\n{% endcodeblock %}\n\n这段代码在class文件里面字段a的访问修饰符怎么描述的呢，答案是 1A（实际是2进制值，方便阅读转成16进制）\n\n# fields的access_flag规范\n| 标志名称 | 标志值（16进制） | 含义|\n| ---    | ---    | --- |\n|ACC_PUBLIC\t|0x0001\t|字段是否为public|\n|ACC_PRIVATE\t|0x0002\t|字段是否为private|\n|ACC_PROTECTED\t|0x0004\t|字段是否为protected|\n|ACC_STATIC\t|0x0008\t|字段是否为static|\n|ACC_FINAL\t|0x0010 |字段是否为final|\n|ACC_VOLATILE\t|0x0040\t|字段是否为volatile|\n|ACC_TRANSIENT\t|0x0080\t|字段是否为transient|\n|ACC_SYNTHETIC\t|0x1000\t|字段是否为编译器自动产生|\n|ACC_ENUM\t|0x4000\t|字段是否为enum|\n\n看完规范发现，1A这个值完全不在规范里面，那jvm怎么知道1A就是private static final 呢？\n\n## access_flag的秘密\n我们把相关标志16进制转成二进制看下\n\n|16进制\t|二进制 |\n| --- | --- |\n|0x0001\t|000001|\n|0x0002\t|000010|\n|0x0004\t|000100|\n|0x0008\t|001000|\n|0x0010\t|010000|\n\n童鞋们发现规律了吗？为什么二进制值是000001，000010 ，每一个标志独占一位。这样标志值就满足以下规律\na(标志值)|b（标志值）=c （class文件上的值）\njvm怎么处理的呢？\nc & a != 0,则表示该字段有a修饰符\n\n## 业务应用\naccess_flag的秘密其实非常简单，了解之后怎么应用到业务场景呢\n- 有限的值\n- 不同值组合关系是要么全是并且，要么全是或者\n  例如 有一个优惠券，有N种使用条件，切每个条件必须同时满足才能使用\n  此类场景就非常适合。\n\n\n\n","source":"_posts/jvm里面的access-flag.md","raw":"---\ntitle: jvm里面的access_flag\ntags:\n  - java\n  - jvm\nabbrlink: 7816\ndate: 2023-06-20 15:30:09\n---\n\n# jvm里面的access_flag\n\n## access_flag\n最近在看jvm相关知识，发现class字节码文件里面大量使用access_flag做标志位，其中做法非常nice。\n例如class字段描述，java里面字段修饰符有以下几个\n\n- public\n- private\n- protected\n- static\n- final\n- volatile\n- transient\n\n{% codeblock lang:java   %}\n\n    private static final  String a=\"abc\";\n{% endcodeblock %}\n\n这段代码在class文件里面字段a的访问修饰符怎么描述的呢，答案是 1A（实际是2进制值，方便阅读转成16进制）\n\n# fields的access_flag规范\n| 标志名称 | 标志值（16进制） | 含义|\n| ---    | ---    | --- |\n|ACC_PUBLIC\t|0x0001\t|字段是否为public|\n|ACC_PRIVATE\t|0x0002\t|字段是否为private|\n|ACC_PROTECTED\t|0x0004\t|字段是否为protected|\n|ACC_STATIC\t|0x0008\t|字段是否为static|\n|ACC_FINAL\t|0x0010 |字段是否为final|\n|ACC_VOLATILE\t|0x0040\t|字段是否为volatile|\n|ACC_TRANSIENT\t|0x0080\t|字段是否为transient|\n|ACC_SYNTHETIC\t|0x1000\t|字段是否为编译器自动产生|\n|ACC_ENUM\t|0x4000\t|字段是否为enum|\n\n看完规范发现，1A这个值完全不在规范里面，那jvm怎么知道1A就是private static final 呢？\n\n## access_flag的秘密\n我们把相关标志16进制转成二进制看下\n\n|16进制\t|二进制 |\n| --- | --- |\n|0x0001\t|000001|\n|0x0002\t|000010|\n|0x0004\t|000100|\n|0x0008\t|001000|\n|0x0010\t|010000|\n\n童鞋们发现规律了吗？为什么二进制值是000001，000010 ，每一个标志独占一位。这样标志值就满足以下规律\na(标志值)|b（标志值）=c （class文件上的值）\njvm怎么处理的呢？\nc & a != 0,则表示该字段有a修饰符\n\n## 业务应用\naccess_flag的秘密其实非常简单，了解之后怎么应用到业务场景呢\n- 有限的值\n- 不同值组合关系是要么全是并且，要么全是或者\n  例如 有一个优惠券，有N种使用条件，切每个条件必须同时满足才能使用\n  此类场景就非常适合。\n\n\n\n","slug":"jvm里面的access-flag","published":1,"updated":"2023-12-05T02:48:12.735Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdj5000xorgobpxo43u6","content":"<h1 id=\"jvm里面的access-flag\"><a href=\"#jvm里面的access-flag\" class=\"headerlink\" title=\"jvm里面的access_flag\"></a>jvm里面的access_flag</h1><h2 id=\"access-flag\"><a href=\"#access-flag\" class=\"headerlink\" title=\"access_flag\"></a>access_flag</h2><p>最近在看jvm相关知识，发现class字节码文件里面大量使用access_flag做标志位，其中做法非常nice。<br>例如class字段描述，java里面字段修饰符有以下几个</p>\n<ul>\n<li>public</li>\n<li>private</li>\n<li>protected</li>\n<li>static</li>\n<li>final</li>\n<li>volatile</li>\n<li>transient</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span>  String a=<span class=\"string\">&quot;abc&quot;</span>;</span><br></pre></td></tr></table></figure>\n\n<p>这段代码在class文件里面字段a的访问修饰符怎么描述的呢，答案是 1A（实际是2进制值，方便阅读转成16进制）</p>\n<h1 id=\"fields的access-flag规范\"><a href=\"#fields的access-flag规范\" class=\"headerlink\" title=\"fields的access_flag规范\"></a>fields的access_flag规范</h1><table>\n<thead>\n<tr>\n<th>标志名称</th>\n<th>标志值（16进制）</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ACC_PUBLIC</td>\n<td>0x0001</td>\n<td>字段是否为public</td>\n</tr>\n<tr>\n<td>ACC_PRIVATE</td>\n<td>0x0002</td>\n<td>字段是否为private</td>\n</tr>\n<tr>\n<td>ACC_PROTECTED</td>\n<td>0x0004</td>\n<td>字段是否为protected</td>\n</tr>\n<tr>\n<td>ACC_STATIC</td>\n<td>0x0008</td>\n<td>字段是否为static</td>\n</tr>\n<tr>\n<td>ACC_FINAL</td>\n<td>0x0010</td>\n<td>字段是否为final</td>\n</tr>\n<tr>\n<td>ACC_VOLATILE</td>\n<td>0x0040</td>\n<td>字段是否为volatile</td>\n</tr>\n<tr>\n<td>ACC_TRANSIENT</td>\n<td>0x0080</td>\n<td>字段是否为transient</td>\n</tr>\n<tr>\n<td>ACC_SYNTHETIC</td>\n<td>0x1000</td>\n<td>字段是否为编译器自动产生</td>\n</tr>\n<tr>\n<td>ACC_ENUM</td>\n<td>0x4000</td>\n<td>字段是否为enum</td>\n</tr>\n</tbody></table>\n<p>看完规范发现，1A这个值完全不在规范里面，那jvm怎么知道1A就是private static final 呢？</p>\n<h2 id=\"access-flag的秘密\"><a href=\"#access-flag的秘密\" class=\"headerlink\" title=\"access_flag的秘密\"></a>access_flag的秘密</h2><p>我们把相关标志16进制转成二进制看下</p>\n<table>\n<thead>\n<tr>\n<th>16进制</th>\n<th>二进制</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0x0001</td>\n<td>000001</td>\n</tr>\n<tr>\n<td>0x0002</td>\n<td>000010</td>\n</tr>\n<tr>\n<td>0x0004</td>\n<td>000100</td>\n</tr>\n<tr>\n<td>0x0008</td>\n<td>001000</td>\n</tr>\n<tr>\n<td>0x0010</td>\n<td>010000</td>\n</tr>\n</tbody></table>\n<p>童鞋们发现规律了吗？为什么二进制值是000001，000010 ，每一个标志独占一位。这样标志值就满足以下规律<br>a(标志值)|b（标志值）&#x3D;c （class文件上的值）<br>jvm怎么处理的呢？<br>c &amp; a !&#x3D; 0,则表示该字段有a修饰符</p>\n<h2 id=\"业务应用\"><a href=\"#业务应用\" class=\"headerlink\" title=\"业务应用\"></a>业务应用</h2><p>access_flag的秘密其实非常简单，了解之后怎么应用到业务场景呢</p>\n<ul>\n<li>有限的值</li>\n<li>不同值组合关系是要么全是并且，要么全是或者<br>例如 有一个优惠券，有N种使用条件，切每个条件必须同时满足才能使用<br>此类场景就非常适合。</li>\n</ul>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"jvm里面的access-flag\"><a href=\"#jvm里面的access-flag\" class=\"headerlink\" title=\"jvm里面的access_flag\"></a>jvm里面的access_flag</h1><h2 id=\"access-flag\"><a href=\"#access-flag\" class=\"headerlink\" title=\"access_flag\"></a>access_flag</h2><p>最近在看jvm相关知识，发现class字节码文件里面大量使用access_flag做标志位，其中做法非常nice。<br>例如class字段描述，java里面字段修饰符有以下几个</p>\n<ul>\n<li>public</li>\n<li>private</li>\n<li>protected</li>\n<li>static</li>\n<li>final</li>\n<li>volatile</li>\n<li>transient</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span>  String a=<span class=\"string\">&quot;abc&quot;</span>;</span><br></pre></td></tr></table></figure>\n\n<p>这段代码在class文件里面字段a的访问修饰符怎么描述的呢，答案是 1A（实际是2进制值，方便阅读转成16进制）</p>\n<h1 id=\"fields的access-flag规范\"><a href=\"#fields的access-flag规范\" class=\"headerlink\" title=\"fields的access_flag规范\"></a>fields的access_flag规范</h1><table>\n<thead>\n<tr>\n<th>标志名称</th>\n<th>标志值（16进制）</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ACC_PUBLIC</td>\n<td>0x0001</td>\n<td>字段是否为public</td>\n</tr>\n<tr>\n<td>ACC_PRIVATE</td>\n<td>0x0002</td>\n<td>字段是否为private</td>\n</tr>\n<tr>\n<td>ACC_PROTECTED</td>\n<td>0x0004</td>\n<td>字段是否为protected</td>\n</tr>\n<tr>\n<td>ACC_STATIC</td>\n<td>0x0008</td>\n<td>字段是否为static</td>\n</tr>\n<tr>\n<td>ACC_FINAL</td>\n<td>0x0010</td>\n<td>字段是否为final</td>\n</tr>\n<tr>\n<td>ACC_VOLATILE</td>\n<td>0x0040</td>\n<td>字段是否为volatile</td>\n</tr>\n<tr>\n<td>ACC_TRANSIENT</td>\n<td>0x0080</td>\n<td>字段是否为transient</td>\n</tr>\n<tr>\n<td>ACC_SYNTHETIC</td>\n<td>0x1000</td>\n<td>字段是否为编译器自动产生</td>\n</tr>\n<tr>\n<td>ACC_ENUM</td>\n<td>0x4000</td>\n<td>字段是否为enum</td>\n</tr>\n</tbody></table>\n<p>看完规范发现，1A这个值完全不在规范里面，那jvm怎么知道1A就是private static final 呢？</p>\n<h2 id=\"access-flag的秘密\"><a href=\"#access-flag的秘密\" class=\"headerlink\" title=\"access_flag的秘密\"></a>access_flag的秘密</h2><p>我们把相关标志16进制转成二进制看下</p>\n<table>\n<thead>\n<tr>\n<th>16进制</th>\n<th>二进制</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0x0001</td>\n<td>000001</td>\n</tr>\n<tr>\n<td>0x0002</td>\n<td>000010</td>\n</tr>\n<tr>\n<td>0x0004</td>\n<td>000100</td>\n</tr>\n<tr>\n<td>0x0008</td>\n<td>001000</td>\n</tr>\n<tr>\n<td>0x0010</td>\n<td>010000</td>\n</tr>\n</tbody></table>\n<p>童鞋们发现规律了吗？为什么二进制值是000001，000010 ，每一个标志独占一位。这样标志值就满足以下规律<br>a(标志值)|b（标志值）&#x3D;c （class文件上的值）<br>jvm怎么处理的呢？<br>c &amp; a !&#x3D; 0,则表示该字段有a修饰符</p>\n<h2 id=\"业务应用\"><a href=\"#业务应用\" class=\"headerlink\" title=\"业务应用\"></a>业务应用</h2><p>access_flag的秘密其实非常简单，了解之后怎么应用到业务场景呢</p>\n<ul>\n<li>有限的值</li>\n<li>不同值组合关系是要么全是并且，要么全是或者<br>例如 有一个优惠券，有N种使用条件，切每个条件必须同时满足才能使用<br>此类场景就非常适合。</li>\n</ul>\n"},{"title":"jenkins进阶","abbrlink":"77c57190","date":"2023-12-31T12:51:55.000Z","_content":"\n# jenkins进阶\n记录最近踩的jenkins大坑，知识点比较零散\n## 悲剧的起因\n最近计划通过测试覆盖率工具来量化测试工作，避免漏测，少测试，因此选型jenkins+jacoco来实现\n\n## 悲剧时间线\n- jenkins插件市场,找到jacoco插件\n- 下载jacoco插件，提示当前jenkins版本过低\n- 升级jenkins版本\n- 重启jenkins失败\n- 登陆jenkins机器看日志，提示jdk版本过低\n- 安装jdk11,并设置java环境变量\n- jenkins 重启成功\n- jenkins tool 新增jdk8 和jdk11\n- 配置jenkins job，使用 jdk8 \n- 运行job，提示编译失败，找不到jdk8的 rt.jar （jdk11没有改jar） \n- job新增打印环境变量，输出结果是 jdk8，但是maven 插件依然使用jdk 11 \n- 修改jenkins所在机器的java环境变量为8，重启 jenkins 使用jdk11绝对路径启动 \n- 运行job，依然提示失败，使用当前jenkins进程对应的jdk11 \n- 回滚jenkins 版本到之前版本（jdk8） \n- 重启jenkins失败，提示config.xml解析异常\n\n## config.xml解析异常\n百度和谷歌了一把，都没找到有效的,这里吐槽一下百度，大量重复的内容  \n参考了一番搜索结果，查了下jenkins官网资料，最终有效的办法是注释掉报错的xml节点\n> xml文件路径在 配置的{jenkins_home}目录下\n> 根本原因是 新旧版本xml格式不兼容\n> jenkins 所有配置都使用xml方式存储的，遇到坏掉的插件，可以直接注释，或者修改成对应版本的格式\n> job配置的xml在{jenkins_home}/jobs/{job_name}/config.xml \n> 只要xml没被删除，可以通过xml还原之前的配置\n\n## maven插件不使用设置的jdk\n这个问题如果使用maven项目则比较麻烦(jenkins哪些版本没这个bug,具体不详)，改成使用pipeline构建job\n> 理论上来说，编译使用的jdk版本和jenkins进程使用的jdk版本完全是隔离，例如 jenkins 使用11，项目使用8，反之亦然\n> 推断原因应该是jenkins的maven项目 使用 scriptEngine 执行shell的时候,写法有问题。\n\n## pipeline 进阶知识点\n基础的 jenkins pipeline我不介绍了，搜索一下，或者自己看官网文档。下面列下进阶技巧\n### 账户密码托管\njenkins job 有时候会涉及访问远程资源就需要使用对应的账户，例如git账户，oss账户，或者服务器账户  \n安全上来讲要统一使用凭证管理\n#### 新增凭证\n{% asset_img img.png  image %}\n\n#### pipeline 新增凭证参数，并且使用\n```groovy\npipeline{\n    agent any\n    parameters{\n        credentials(\n                credentialType: 'com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl',\n                defaultValue: 'admin-user',\n                description: ''' 服务器登陆账户 ''',\n                name: 'server_user',\n                required: true\n        )\n    }\n    stages {\n        stage('打印变量') {\n            steps {\n                withCredentials([usernamePassword(credentialsId:\n                        params.server_user, passwordVariable: 'upwd', usernameVariable: 'uname')]) {\n                    // 在字符串里面使用${xx}\n                    // 在函数里面直接使用变量\n                    println(\" uname : ${uname} \" )\n                    println(\" upwd : ${upwd} \")\n                }\n                \n            }\n        }\n       \n    }\n    \n}\n\n\n```\n**打印出来的用户名/密码是星号**\n\n### Publish Over SSH 替代方案\n大部分时候jenkins所在的服务器和java服务运行的服务器不是同一个，这个时候就需要上传jar到远程服务，且运行启动脚本  \n网上查了下资料，大部分使用publish over ssh,但这个插件已经不维护了，最新版本jenkins插件市场都找不到  \n推荐的替代方案是使用 SSH Pipeline Steps 替代\n```groovy\n\npipeline{\n    agent any\n    parameters{\n        credentials(\n                credentialType: 'com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl',\n                defaultValue: 'admin-user',\n                description: ''' 服务器登陆账户 ''',\n                name: 'server_user',\n                required: true\n        )\n    }\n    stages {\n        stage('执行远程shell') {\n            steps {\n                withCredentials([usernamePassword(credentialsId:\n                        params.server_user, passwordVariable: 'upwd', usernameVariable: 'uname')]) {\n                    def remote = [:]\n                    remote.password = upwd\n                    remote.user = uname\n                    remote.host = \"127.0.0.2\"\n                    remote.name = \"127.0.0.2\"\n                    remote.allowAnyHosts = true\n                    writeFile file: 'abc.sh', text: 'ls'\n                    // 执行远程命令\n                    sshCommand remote: remote, command: 'for i in {1..5}; do echo -n \\\"Loop \\$i \\\"; date ; sleep 1; done'\n                    // 复制当前workspace下文件到 远程机器\n                    sshPut remote: remote, from: 'abc.sh', into: '.'\n                    // 复制当前 远程机器文件，到当前workspace\n                    sshGet remote: remote, from: 'abc.sh', into: 'bac.sh', override: true\n                    //  执行远程脚本\n                    sshScript remote: remote, script: 'abc.sh'\n                    // 删除远程文件\n                    sshRemove remote: remote, path: 'abc.sh'\n                    \n                }\n                \n            }\n        }\n       \n    }\n    \n}\n\n\n```\n**当前workspace 在{jenkins_home}/workspace/{job_name}**\n\n### 动态插件方案\n有时候有些疑难杂症，难以解决,需要在脚本运行期间使用 jenkins进程相关信息\n注意，不要勾选沙箱运行，因为要获取jenkins实例，要突破沙箱限制\n```groovy\n\nimport  jenkins.model.*\n// 有使用的插件也可以import其他的\n\n\npipeline{\n    agent any\n    parameters{\n        credentials(\n                credentialType: 'com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl',\n                defaultValue: 'admin-user',\n                description: ''' 服务器登陆账户 ''',\n                name: 'server_user',\n                required: true\n        )\n    }\n    stages {\n        stage('使用') {\n            steps {\n\n                script{\n                    // 获取当前jenkins实例\n                    def jks= Jenkins.getInstanceOrNull()\n                    println(jks)\n                    // 获取指定插件的配置,其他api，查看 https://javadoc.jenkins.io/jenkins/model/Jenkins.html\n                    // 理论上所有插件和参数都能查看，也可以动态修改插件\n                    def desc=jks.getDescriptor(com.cloudbees.plugins.credentials.Credentials.class)\n                    println(desc)\n                    def plugin=jks.getPlugin(com.cloudbees.plugins.credentials.Credentials.class)\n                    println(plugin)\n                }\n               \n                \n            }\n        }\n       \n    }\n    \n}\n\n\n```\n**高版本的jenkins除了关闭沙箱之外，还需要授权同意**\n{% asset_img img-1.png  image %}\n\n## jenkins发布流水线参考demo\n```groovy\n\nimport jenkins.model.*\n\n/**\n *  see https://javadoc.jenkins.io/\n *  see https://github.com/jenkinsci/ssh-steps-plugin?tab=readme-ov-file#sshput\n */\n\npipeline {\n    agent any\n\n    tools {\n        // 多jdk情况下手动指定 jdk，也可以在steps拿到jenkins实例后里面动态切换jdk\n        jdk 'jdk8'\n    }\n\n    options {\n        timestamps()    //设置在项目打印日志时带上对应时间\n        disableConcurrentBuilds()   //不允许同时执行流水线，被用来防止同时访问共享资源等\n        buildDiscarder(logRotator(numToKeepStr: \"5\"))   // 表示保留n次构建历史\n    }\n    parameters {\n        // maven home--字符串参数 -- 去掉空白字符串\n        string(\n                defaultValue: '/usr/local/maven/apache-maven-3.8.1',\n                description: ''' maven 目录 ''',\n                name: 'maven_home',\n                trim: true\n        )\n        // 发布的机器ip列表 逗号分割\n        string(\n                defaultValue: '',\n                description: ''' 发布的机器ip列表 ''',\n                name: 'remote_ip_list_str',\n                trim: true\n        )\n        // git_branches git 分支\n        string(\n                defaultValue: '*/test',\n                description: ''' git 分支 ''',\n                name: 'git_branches',\n                trim: true\n        )\n        // git_time_out 单位分钟\n        string(\n                defaultValue: '20',\n                description: ''' git_time_out ''',\n                name: 'git_time_out',\n                trim: true\n        )\n        // git_url\n        string(\n                defaultValue: '',\n                description: ''' git 仓库地址 ''',\n                name: 'git_url',\n                trim: true\n        )\n        // ssh 凭证，访问git使用\n        credentials(\n                credentialType: 'com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey',\n                defaultValue: 'gitlab_jenkins',\n                description: ''' ssh 凭证 ''',\n                name: 'credentials_id',\n                required: true\n        )\n        booleanParam(\n                defaultValue: false,\n                description: '是否启用测试覆盖率',\n                name: 'is_enable_jacoco'\n        )\n        credentials(\n                credentialType: 'com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl',\n                defaultValue: 'server-user-admin',\n                description: ''' 服务器登陆账户 ''',\n                name: 'server_user',\n                required: true\n        )\n\n\n    }\n\n    stages {\n        stage('打印环境变量') {\n            steps {\n                println(\"=========开始打印环境变量=========\")\n                sh \"printenv\"\n            }\n        }\n\n        stage('拉取git代码') {\n            steps {\n                script {\n                    def branches = params.git_branches\n                    def gitTimeOut = params.git_time_out\n                    def credentialsId = params.credentials_id\n                    def gitUrl = params.git_url\n                    println(\"========开始拉取git代码=======\")\n                    println(gitUrl)\n                    checkout scmGit(branches: [[name: branches]],\n                            extensions: [cloneOption(noTags: false, reference: '', shallow: true, timeout: gitTimeOut)], userRemoteConfigs: [[credentialsId: credentialsId, url: gitUrl]])\n\n                }\n\n            }\n        }\n        stage('maven编译') {\n            steps {\n\n                script {\n                    // /usr/local/maven/apache-maven-3.8.1\n                    println(\"========开始maven编译=======\")\n                    sh \"\"\"\n                    pwd\n                    ${params.maven_home}/bin/mvn clean install -T 1C -Dmaven.test.skip=true -Dmaven.compile.fork=true -U -B -f ${env.WORKSPACE}/pom.xml\n                    \"\"\"\n                }\n\n            }\n        }\n\n\n        stage('部署代码') {\n            steps {\n                script {\n                    // 获取当前Jekins 实例，理论上非空\n//                    def inst = Jenkins.getInstanceOrNull()\n\n                    withCredentials([usernamePassword(credentialsId: params.server_user, passwordVariable: 'upwd', usernameVariable: 'uname')]) {\n                        def remote = [:]\n                        def serveripList = params.remote_ip_list_str.split(\",\")\n                        for (ip in serveripList) {\n                            remote.password = upwd\n                            remote.user = uname\n                            remote.host = ip\n                            remote.name = ip\n                            remote.allowAnyHosts = true\n\n                            println(remote)\n                            sshPut remote: remote, from: 'test.jar', into: '/home/target/jenkins'\n                            sshScript remote: remote, script: '/home/back/java_start.sh'\n\n                            while (true) {\n                                println(\"=== 开始健康检查===\")\n                                try {\n                                    def response = sh(\n                                            script: \"\"\"  curl -X GET \"http://${ip}:8191/test/health/check\" \"\"\",\n                                            returnStdout: true\n                                    ).trim()\n                                    if (response.contains(\"SUCCESS\")) {\n                                        break\n                                    }\n                                    println(\" 健康检查失败 sleep 10 s\")\n                                    sleep(10)\n                                } catch (exec) {\n                                    println(\" 健康检查失败  ${exec}  sleep 10 s \")\n                                    sleep(10)\n                                }\n                            }\n                            println(\"====== 健康检查通过 =====\")\n\n                        }\n                    }\n\n                }\n\n            }\n\n        }\n\n    }\n}\n\n\n```\n\n\n\n\n\n\n\n","source":"_posts/jenkins进阶.md","raw":"---\ntitle: jenkins进阶\ntags:\n  - jenkins\n  - 架构师进阶之路\nabbrlink: 77c57190\ndate: 2023-12-31 20:51:55\n---\n\n# jenkins进阶\n记录最近踩的jenkins大坑，知识点比较零散\n## 悲剧的起因\n最近计划通过测试覆盖率工具来量化测试工作，避免漏测，少测试，因此选型jenkins+jacoco来实现\n\n## 悲剧时间线\n- jenkins插件市场,找到jacoco插件\n- 下载jacoco插件，提示当前jenkins版本过低\n- 升级jenkins版本\n- 重启jenkins失败\n- 登陆jenkins机器看日志，提示jdk版本过低\n- 安装jdk11,并设置java环境变量\n- jenkins 重启成功\n- jenkins tool 新增jdk8 和jdk11\n- 配置jenkins job，使用 jdk8 \n- 运行job，提示编译失败，找不到jdk8的 rt.jar （jdk11没有改jar） \n- job新增打印环境变量，输出结果是 jdk8，但是maven 插件依然使用jdk 11 \n- 修改jenkins所在机器的java环境变量为8，重启 jenkins 使用jdk11绝对路径启动 \n- 运行job，依然提示失败，使用当前jenkins进程对应的jdk11 \n- 回滚jenkins 版本到之前版本（jdk8） \n- 重启jenkins失败，提示config.xml解析异常\n\n## config.xml解析异常\n百度和谷歌了一把，都没找到有效的,这里吐槽一下百度，大量重复的内容  \n参考了一番搜索结果，查了下jenkins官网资料，最终有效的办法是注释掉报错的xml节点\n> xml文件路径在 配置的{jenkins_home}目录下\n> 根本原因是 新旧版本xml格式不兼容\n> jenkins 所有配置都使用xml方式存储的，遇到坏掉的插件，可以直接注释，或者修改成对应版本的格式\n> job配置的xml在{jenkins_home}/jobs/{job_name}/config.xml \n> 只要xml没被删除，可以通过xml还原之前的配置\n\n## maven插件不使用设置的jdk\n这个问题如果使用maven项目则比较麻烦(jenkins哪些版本没这个bug,具体不详)，改成使用pipeline构建job\n> 理论上来说，编译使用的jdk版本和jenkins进程使用的jdk版本完全是隔离，例如 jenkins 使用11，项目使用8，反之亦然\n> 推断原因应该是jenkins的maven项目 使用 scriptEngine 执行shell的时候,写法有问题。\n\n## pipeline 进阶知识点\n基础的 jenkins pipeline我不介绍了，搜索一下，或者自己看官网文档。下面列下进阶技巧\n### 账户密码托管\njenkins job 有时候会涉及访问远程资源就需要使用对应的账户，例如git账户，oss账户，或者服务器账户  \n安全上来讲要统一使用凭证管理\n#### 新增凭证\n{% asset_img img.png  image %}\n\n#### pipeline 新增凭证参数，并且使用\n```groovy\npipeline{\n    agent any\n    parameters{\n        credentials(\n                credentialType: 'com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl',\n                defaultValue: 'admin-user',\n                description: ''' 服务器登陆账户 ''',\n                name: 'server_user',\n                required: true\n        )\n    }\n    stages {\n        stage('打印变量') {\n            steps {\n                withCredentials([usernamePassword(credentialsId:\n                        params.server_user, passwordVariable: 'upwd', usernameVariable: 'uname')]) {\n                    // 在字符串里面使用${xx}\n                    // 在函数里面直接使用变量\n                    println(\" uname : ${uname} \" )\n                    println(\" upwd : ${upwd} \")\n                }\n                \n            }\n        }\n       \n    }\n    \n}\n\n\n```\n**打印出来的用户名/密码是星号**\n\n### Publish Over SSH 替代方案\n大部分时候jenkins所在的服务器和java服务运行的服务器不是同一个，这个时候就需要上传jar到远程服务，且运行启动脚本  \n网上查了下资料，大部分使用publish over ssh,但这个插件已经不维护了，最新版本jenkins插件市场都找不到  \n推荐的替代方案是使用 SSH Pipeline Steps 替代\n```groovy\n\npipeline{\n    agent any\n    parameters{\n        credentials(\n                credentialType: 'com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl',\n                defaultValue: 'admin-user',\n                description: ''' 服务器登陆账户 ''',\n                name: 'server_user',\n                required: true\n        )\n    }\n    stages {\n        stage('执行远程shell') {\n            steps {\n                withCredentials([usernamePassword(credentialsId:\n                        params.server_user, passwordVariable: 'upwd', usernameVariable: 'uname')]) {\n                    def remote = [:]\n                    remote.password = upwd\n                    remote.user = uname\n                    remote.host = \"127.0.0.2\"\n                    remote.name = \"127.0.0.2\"\n                    remote.allowAnyHosts = true\n                    writeFile file: 'abc.sh', text: 'ls'\n                    // 执行远程命令\n                    sshCommand remote: remote, command: 'for i in {1..5}; do echo -n \\\"Loop \\$i \\\"; date ; sleep 1; done'\n                    // 复制当前workspace下文件到 远程机器\n                    sshPut remote: remote, from: 'abc.sh', into: '.'\n                    // 复制当前 远程机器文件，到当前workspace\n                    sshGet remote: remote, from: 'abc.sh', into: 'bac.sh', override: true\n                    //  执行远程脚本\n                    sshScript remote: remote, script: 'abc.sh'\n                    // 删除远程文件\n                    sshRemove remote: remote, path: 'abc.sh'\n                    \n                }\n                \n            }\n        }\n       \n    }\n    \n}\n\n\n```\n**当前workspace 在{jenkins_home}/workspace/{job_name}**\n\n### 动态插件方案\n有时候有些疑难杂症，难以解决,需要在脚本运行期间使用 jenkins进程相关信息\n注意，不要勾选沙箱运行，因为要获取jenkins实例，要突破沙箱限制\n```groovy\n\nimport  jenkins.model.*\n// 有使用的插件也可以import其他的\n\n\npipeline{\n    agent any\n    parameters{\n        credentials(\n                credentialType: 'com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl',\n                defaultValue: 'admin-user',\n                description: ''' 服务器登陆账户 ''',\n                name: 'server_user',\n                required: true\n        )\n    }\n    stages {\n        stage('使用') {\n            steps {\n\n                script{\n                    // 获取当前jenkins实例\n                    def jks= Jenkins.getInstanceOrNull()\n                    println(jks)\n                    // 获取指定插件的配置,其他api，查看 https://javadoc.jenkins.io/jenkins/model/Jenkins.html\n                    // 理论上所有插件和参数都能查看，也可以动态修改插件\n                    def desc=jks.getDescriptor(com.cloudbees.plugins.credentials.Credentials.class)\n                    println(desc)\n                    def plugin=jks.getPlugin(com.cloudbees.plugins.credentials.Credentials.class)\n                    println(plugin)\n                }\n               \n                \n            }\n        }\n       \n    }\n    \n}\n\n\n```\n**高版本的jenkins除了关闭沙箱之外，还需要授权同意**\n{% asset_img img-1.png  image %}\n\n## jenkins发布流水线参考demo\n```groovy\n\nimport jenkins.model.*\n\n/**\n *  see https://javadoc.jenkins.io/\n *  see https://github.com/jenkinsci/ssh-steps-plugin?tab=readme-ov-file#sshput\n */\n\npipeline {\n    agent any\n\n    tools {\n        // 多jdk情况下手动指定 jdk，也可以在steps拿到jenkins实例后里面动态切换jdk\n        jdk 'jdk8'\n    }\n\n    options {\n        timestamps()    //设置在项目打印日志时带上对应时间\n        disableConcurrentBuilds()   //不允许同时执行流水线，被用来防止同时访问共享资源等\n        buildDiscarder(logRotator(numToKeepStr: \"5\"))   // 表示保留n次构建历史\n    }\n    parameters {\n        // maven home--字符串参数 -- 去掉空白字符串\n        string(\n                defaultValue: '/usr/local/maven/apache-maven-3.8.1',\n                description: ''' maven 目录 ''',\n                name: 'maven_home',\n                trim: true\n        )\n        // 发布的机器ip列表 逗号分割\n        string(\n                defaultValue: '',\n                description: ''' 发布的机器ip列表 ''',\n                name: 'remote_ip_list_str',\n                trim: true\n        )\n        // git_branches git 分支\n        string(\n                defaultValue: '*/test',\n                description: ''' git 分支 ''',\n                name: 'git_branches',\n                trim: true\n        )\n        // git_time_out 单位分钟\n        string(\n                defaultValue: '20',\n                description: ''' git_time_out ''',\n                name: 'git_time_out',\n                trim: true\n        )\n        // git_url\n        string(\n                defaultValue: '',\n                description: ''' git 仓库地址 ''',\n                name: 'git_url',\n                trim: true\n        )\n        // ssh 凭证，访问git使用\n        credentials(\n                credentialType: 'com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey',\n                defaultValue: 'gitlab_jenkins',\n                description: ''' ssh 凭证 ''',\n                name: 'credentials_id',\n                required: true\n        )\n        booleanParam(\n                defaultValue: false,\n                description: '是否启用测试覆盖率',\n                name: 'is_enable_jacoco'\n        )\n        credentials(\n                credentialType: 'com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl',\n                defaultValue: 'server-user-admin',\n                description: ''' 服务器登陆账户 ''',\n                name: 'server_user',\n                required: true\n        )\n\n\n    }\n\n    stages {\n        stage('打印环境变量') {\n            steps {\n                println(\"=========开始打印环境变量=========\")\n                sh \"printenv\"\n            }\n        }\n\n        stage('拉取git代码') {\n            steps {\n                script {\n                    def branches = params.git_branches\n                    def gitTimeOut = params.git_time_out\n                    def credentialsId = params.credentials_id\n                    def gitUrl = params.git_url\n                    println(\"========开始拉取git代码=======\")\n                    println(gitUrl)\n                    checkout scmGit(branches: [[name: branches]],\n                            extensions: [cloneOption(noTags: false, reference: '', shallow: true, timeout: gitTimeOut)], userRemoteConfigs: [[credentialsId: credentialsId, url: gitUrl]])\n\n                }\n\n            }\n        }\n        stage('maven编译') {\n            steps {\n\n                script {\n                    // /usr/local/maven/apache-maven-3.8.1\n                    println(\"========开始maven编译=======\")\n                    sh \"\"\"\n                    pwd\n                    ${params.maven_home}/bin/mvn clean install -T 1C -Dmaven.test.skip=true -Dmaven.compile.fork=true -U -B -f ${env.WORKSPACE}/pom.xml\n                    \"\"\"\n                }\n\n            }\n        }\n\n\n        stage('部署代码') {\n            steps {\n                script {\n                    // 获取当前Jekins 实例，理论上非空\n//                    def inst = Jenkins.getInstanceOrNull()\n\n                    withCredentials([usernamePassword(credentialsId: params.server_user, passwordVariable: 'upwd', usernameVariable: 'uname')]) {\n                        def remote = [:]\n                        def serveripList = params.remote_ip_list_str.split(\",\")\n                        for (ip in serveripList) {\n                            remote.password = upwd\n                            remote.user = uname\n                            remote.host = ip\n                            remote.name = ip\n                            remote.allowAnyHosts = true\n\n                            println(remote)\n                            sshPut remote: remote, from: 'test.jar', into: '/home/target/jenkins'\n                            sshScript remote: remote, script: '/home/back/java_start.sh'\n\n                            while (true) {\n                                println(\"=== 开始健康检查===\")\n                                try {\n                                    def response = sh(\n                                            script: \"\"\"  curl -X GET \"http://${ip}:8191/test/health/check\" \"\"\",\n                                            returnStdout: true\n                                    ).trim()\n                                    if (response.contains(\"SUCCESS\")) {\n                                        break\n                                    }\n                                    println(\" 健康检查失败 sleep 10 s\")\n                                    sleep(10)\n                                } catch (exec) {\n                                    println(\" 健康检查失败  ${exec}  sleep 10 s \")\n                                    sleep(10)\n                                }\n                            }\n                            println(\"====== 健康检查通过 =====\")\n\n                        }\n                    }\n\n                }\n\n            }\n\n        }\n\n    }\n}\n\n\n```\n\n\n\n\n\n\n\n","slug":"jenkins进阶","published":1,"updated":"2023-12-31T15:17:03.945Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdj6000zorgohafb5jfr","content":"<h1 id=\"jenkins进阶\"><a href=\"#jenkins进阶\" class=\"headerlink\" title=\"jenkins进阶\"></a>jenkins进阶</h1><p>记录最近踩的jenkins大坑，知识点比较零散</p>\n<h2 id=\"悲剧的起因\"><a href=\"#悲剧的起因\" class=\"headerlink\" title=\"悲剧的起因\"></a>悲剧的起因</h2><p>最近计划通过测试覆盖率工具来量化测试工作，避免漏测，少测试，因此选型jenkins+jacoco来实现</p>\n<h2 id=\"悲剧时间线\"><a href=\"#悲剧时间线\" class=\"headerlink\" title=\"悲剧时间线\"></a>悲剧时间线</h2><ul>\n<li>jenkins插件市场,找到jacoco插件</li>\n<li>下载jacoco插件，提示当前jenkins版本过低</li>\n<li>升级jenkins版本</li>\n<li>重启jenkins失败</li>\n<li>登陆jenkins机器看日志，提示jdk版本过低</li>\n<li>安装jdk11,并设置java环境变量</li>\n<li>jenkins 重启成功</li>\n<li>jenkins tool 新增jdk8 和jdk11</li>\n<li>配置jenkins job，使用 jdk8 </li>\n<li>运行job，提示编译失败，找不到jdk8的 rt.jar （jdk11没有改jar） </li>\n<li>job新增打印环境变量，输出结果是 jdk8，但是maven 插件依然使用jdk 11 </li>\n<li>修改jenkins所在机器的java环境变量为8，重启 jenkins 使用jdk11绝对路径启动 </li>\n<li>运行job，依然提示失败，使用当前jenkins进程对应的jdk11 </li>\n<li>回滚jenkins 版本到之前版本（jdk8） </li>\n<li>重启jenkins失败，提示config.xml解析异常</li>\n</ul>\n<h2 id=\"config-xml解析异常\"><a href=\"#config-xml解析异常\" class=\"headerlink\" title=\"config.xml解析异常\"></a>config.xml解析异常</h2><p>百度和谷歌了一把，都没找到有效的,这里吐槽一下百度，大量重复的内容<br>参考了一番搜索结果，查了下jenkins官网资料，最终有效的办法是注释掉报错的xml节点</p>\n<blockquote>\n<p>xml文件路径在 配置的{jenkins_home}目录下<br>根本原因是 新旧版本xml格式不兼容<br>jenkins 所有配置都使用xml方式存储的，遇到坏掉的插件，可以直接注释，或者修改成对应版本的格式<br>job配置的xml在{jenkins_home}&#x2F;jobs&#x2F;{job_name}&#x2F;config.xml<br>只要xml没被删除，可以通过xml还原之前的配置</p>\n</blockquote>\n<h2 id=\"maven插件不使用设置的jdk\"><a href=\"#maven插件不使用设置的jdk\" class=\"headerlink\" title=\"maven插件不使用设置的jdk\"></a>maven插件不使用设置的jdk</h2><p>这个问题如果使用maven项目则比较麻烦(jenkins哪些版本没这个bug,具体不详)，改成使用pipeline构建job</p>\n<blockquote>\n<p>理论上来说，编译使用的jdk版本和jenkins进程使用的jdk版本完全是隔离，例如 jenkins 使用11，项目使用8，反之亦然<br>推断原因应该是jenkins的maven项目 使用 scriptEngine 执行shell的时候,写法有问题。</p>\n</blockquote>\n<h2 id=\"pipeline-进阶知识点\"><a href=\"#pipeline-进阶知识点\" class=\"headerlink\" title=\"pipeline 进阶知识点\"></a>pipeline 进阶知识点</h2><p>基础的 jenkins pipeline我不介绍了，搜索一下，或者自己看官网文档。下面列下进阶技巧</p>\n<h3 id=\"账户密码托管\"><a href=\"#账户密码托管\" class=\"headerlink\" title=\"账户密码托管\"></a>账户密码托管</h3><p>jenkins job 有时候会涉及访问远程资源就需要使用对应的账户，例如git账户，oss账户，或者服务器账户<br>安全上来讲要统一使用凭证管理</p>\n<h4 id=\"新增凭证\"><a href=\"#新增凭证\" class=\"headerlink\" title=\"新增凭证\"></a>新增凭证</h4><img src=\"/2023123177c57190/img.png\" class=\"\" title=\"image\">\n\n<h4 id=\"pipeline-新增凭证参数，并且使用\"><a href=\"#pipeline-新增凭证参数，并且使用\" class=\"headerlink\" title=\"pipeline 新增凭证参数，并且使用\"></a>pipeline 新增凭证参数，并且使用</h4><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline&#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    parameters&#123;</span><br><span class=\"line\">        credentials(</span><br><span class=\"line\">                <span class=\"symbol\">credentialType:</span> <span class=\"string\">&#x27;com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;admin-user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; 服务器登陆账户 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;server_user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">required:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;打印变量&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                withCredentials([usernamePassword(<span class=\"attr\">credentialsId:</span></span><br><span class=\"line\">                        params.server_user, <span class=\"attr\">passwordVariable:</span> <span class=\"string\">&#x27;upwd&#x27;</span>, <span class=\"attr\">usernameVariable:</span> <span class=\"string\">&#x27;uname&#x27;</span>)]) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 在字符串里面使用$&#123;xx&#125;</span></span><br><span class=\"line\">                    <span class=\"comment\">// 在函数里面直接使用变量</span></span><br><span class=\"line\">                    println(<span class=\"string\">&quot; uname : $&#123;uname&#125; &quot;</span> )</span><br><span class=\"line\">                    println(<span class=\"string\">&quot; upwd : $&#123;upwd&#125; &quot;</span>)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">       </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>打印出来的用户名&#x2F;密码是星号</strong></p>\n<h3 id=\"Publish-Over-SSH-替代方案\"><a href=\"#Publish-Over-SSH-替代方案\" class=\"headerlink\" title=\"Publish Over SSH 替代方案\"></a>Publish Over SSH 替代方案</h3><p>大部分时候jenkins所在的服务器和java服务运行的服务器不是同一个，这个时候就需要上传jar到远程服务，且运行启动脚本<br>网上查了下资料，大部分使用publish over ssh,但这个插件已经不维护了，最新版本jenkins插件市场都找不到<br>推荐的替代方案是使用 SSH Pipeline Steps 替代</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">pipeline&#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    parameters&#123;</span><br><span class=\"line\">        credentials(</span><br><span class=\"line\">                <span class=\"symbol\">credentialType:</span> <span class=\"string\">&#x27;com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;admin-user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; 服务器登陆账户 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;server_user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">required:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;执行远程shell&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                withCredentials([usernamePassword(<span class=\"attr\">credentialsId:</span></span><br><span class=\"line\">                        params.server_user, <span class=\"attr\">passwordVariable:</span> <span class=\"string\">&#x27;upwd&#x27;</span>, <span class=\"attr\">usernameVariable:</span> <span class=\"string\">&#x27;uname&#x27;</span>)]) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">def</span> remote = [:]</span><br><span class=\"line\">                    remote.password = upwd</span><br><span class=\"line\">                    remote.user = uname</span><br><span class=\"line\">                    remote.host = <span class=\"string\">&quot;127.0.0.2&quot;</span></span><br><span class=\"line\">                    remote.name = <span class=\"string\">&quot;127.0.0.2&quot;</span></span><br><span class=\"line\">                    remote.allowAnyHosts = <span class=\"literal\">true</span></span><br><span class=\"line\">                    writeFile <span class=\"attr\">file:</span> <span class=\"string\">&#x27;abc.sh&#x27;</span>, <span class=\"attr\">text:</span> <span class=\"string\">&#x27;ls&#x27;</span></span><br><span class=\"line\">                    <span class=\"comment\">// 执行远程命令</span></span><br><span class=\"line\">                    sshCommand <span class=\"attr\">remote:</span> remote, <span class=\"attr\">command:</span> <span class=\"string\">&#x27;for i in &#123;1..5&#125;; do echo -n \\&quot;Loop \\$i \\&quot;; date ; sleep 1; done&#x27;</span></span><br><span class=\"line\">                    <span class=\"comment\">// 复制当前workspace下文件到 远程机器</span></span><br><span class=\"line\">                    sshPut <span class=\"attr\">remote:</span> remote, <span class=\"attr\">from:</span> <span class=\"string\">&#x27;abc.sh&#x27;</span>, <span class=\"attr\">into:</span> <span class=\"string\">&#x27;.&#x27;</span></span><br><span class=\"line\">                    <span class=\"comment\">// 复制当前 远程机器文件，到当前workspace</span></span><br><span class=\"line\">                    sshGet <span class=\"attr\">remote:</span> remote, <span class=\"attr\">from:</span> <span class=\"string\">&#x27;abc.sh&#x27;</span>, <span class=\"attr\">into:</span> <span class=\"string\">&#x27;bac.sh&#x27;</span>, <span class=\"attr\">override:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">                    <span class=\"comment\">//  执行远程脚本</span></span><br><span class=\"line\">                    sshScript <span class=\"attr\">remote:</span> remote, <span class=\"attr\">script:</span> <span class=\"string\">&#x27;abc.sh&#x27;</span></span><br><span class=\"line\">                    <span class=\"comment\">// 删除远程文件</span></span><br><span class=\"line\">                    sshRemove <span class=\"attr\">remote:</span> remote, <span class=\"attr\">path:</span> <span class=\"string\">&#x27;abc.sh&#x27;</span></span><br><span class=\"line\">                    </span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">       </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>当前workspace 在{jenkins_home}&#x2F;workspace&#x2F;{job_name}</strong></p>\n<h3 id=\"动态插件方案\"><a href=\"#动态插件方案\" class=\"headerlink\" title=\"动态插件方案\"></a>动态插件方案</h3><p>有时候有些疑难杂症，难以解决,需要在脚本运行期间使用 jenkins进程相关信息<br>注意，不要勾选沙箱运行，因为要获取jenkins实例，要突破沙箱限制</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span>  jenkins.model.*</span><br><span class=\"line\"><span class=\"comment\">// 有使用的插件也可以import其他的</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pipeline&#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    parameters&#123;</span><br><span class=\"line\">        credentials(</span><br><span class=\"line\">                <span class=\"symbol\">credentialType:</span> <span class=\"string\">&#x27;com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;admin-user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; 服务器登陆账户 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;server_user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">required:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;使用&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                script&#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 获取当前jenkins实例</span></span><br><span class=\"line\">                    <span class=\"keyword\">def</span> jks= Jenkins.getInstanceOrNull()</span><br><span class=\"line\">                    println(jks)</span><br><span class=\"line\">                    <span class=\"comment\">// 获取指定插件的配置,其他api，查看 https://javadoc.jenkins.io/jenkins/model/Jenkins.html</span></span><br><span class=\"line\">                    <span class=\"comment\">// 理论上所有插件和参数都能查看，也可以动态修改插件</span></span><br><span class=\"line\">                    <span class=\"keyword\">def</span> desc=jks.getDescriptor(com.cloudbees.plugins.credentials.Credentials.<span class=\"keyword\">class</span>)</span><br><span class=\"line\">                    println(desc)</span><br><span class=\"line\">                    <span class=\"keyword\">def</span> plugin=jks.getPlugin(com.cloudbees.plugins.credentials.Credentials.<span class=\"keyword\">class</span>)</span><br><span class=\"line\">                    println(plugin)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">               </span><br><span class=\"line\">                </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">       </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>高版本的jenkins除了关闭沙箱之外，还需要授权同意</strong></p>\n<img src=\"/2023123177c57190/img-1.png\" class=\"\" title=\"image\">\n\n<h2 id=\"jenkins发布流水线参考demo\"><a href=\"#jenkins发布流水线参考demo\" class=\"headerlink\" title=\"jenkins发布流水线参考demo\"></a>jenkins发布流水线参考demo</h2><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> jenkins.model.*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> *  see https://javadoc.jenkins.io/</span></span><br><span class=\"line\"><span class=\"comment\"> *  see https://github.com/jenkinsci/ssh-steps-plugin?tab=readme-ov-file#sshput</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\"></span><br><span class=\"line\">    tools &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 多jdk情况下手动指定 jdk，也可以在steps拿到jenkins实例后里面动态切换jdk</span></span><br><span class=\"line\">        jdk <span class=\"string\">&#x27;jdk8&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    options &#123;</span><br><span class=\"line\">        timestamps()    <span class=\"comment\">//设置在项目打印日志时带上对应时间</span></span><br><span class=\"line\">        disableConcurrentBuilds()   <span class=\"comment\">//不允许同时执行流水线，被用来防止同时访问共享资源等</span></span><br><span class=\"line\">        buildDiscarder(logRotator(<span class=\"attr\">numToKeepStr:</span> <span class=\"string\">&quot;5&quot;</span>))   <span class=\"comment\">// 表示保留n次构建历史</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    parameters &#123;</span><br><span class=\"line\">        <span class=\"comment\">// maven home--字符串参数 -- 去掉空白字符串</span></span><br><span class=\"line\">        string(</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;/usr/local/maven/apache-maven-3.8.1&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; maven 目录 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;maven_home&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">trim:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"comment\">// 发布的机器ip列表 逗号分割</span></span><br><span class=\"line\">        string(</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; 发布的机器ip列表 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;remote_ip_list_str&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">trim:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"comment\">// git_branches git 分支</span></span><br><span class=\"line\">        string(</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;*/test&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; git 分支 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;git_branches&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">trim:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"comment\">// git_time_out 单位分钟</span></span><br><span class=\"line\">        string(</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;20&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; git_time_out &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;git_time_out&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">trim:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"comment\">// git_url</span></span><br><span class=\"line\">        string(</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; git 仓库地址 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;git_url&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">trim:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"comment\">// ssh 凭证，访问git使用</span></span><br><span class=\"line\">        credentials(</span><br><span class=\"line\">                <span class=\"symbol\">credentialType:</span> <span class=\"string\">&#x27;com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;gitlab_jenkins&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; ssh 凭证 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;credentials_id&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">required:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        booleanParam(</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"literal\">false</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;是否启用测试覆盖率&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;is_enable_jacoco&#x27;</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        credentials(</span><br><span class=\"line\">                <span class=\"symbol\">credentialType:</span> <span class=\"string\">&#x27;com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;server-user-admin&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; 服务器登陆账户 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;server_user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">required:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;打印环境变量&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                println(<span class=\"string\">&quot;=========开始打印环境变量=========&quot;</span>)</span><br><span class=\"line\">                sh <span class=\"string\">&quot;printenv&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;拉取git代码&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                script &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">def</span> branches = params.git_branches</span><br><span class=\"line\">                    <span class=\"keyword\">def</span> gitTimeOut = params.git_time_out</span><br><span class=\"line\">                    <span class=\"keyword\">def</span> credentialsId = params.credentials_id</span><br><span class=\"line\">                    <span class=\"keyword\">def</span> gitUrl = params.git_url</span><br><span class=\"line\">                    println(<span class=\"string\">&quot;========开始拉取git代码=======&quot;</span>)</span><br><span class=\"line\">                    println(gitUrl)</span><br><span class=\"line\">                    checkout scmGit(<span class=\"attr\">branches:</span> [[<span class=\"attr\">name:</span> branches]],</span><br><span class=\"line\">                            <span class=\"symbol\">extensions:</span> [cloneOption(<span class=\"attr\">noTags:</span> <span class=\"literal\">false</span>, <span class=\"attr\">reference:</span> <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">shallow:</span> <span class=\"literal\">true</span>, <span class=\"attr\">timeout:</span> gitTimeOut)], <span class=\"attr\">userRemoteConfigs:</span> [[<span class=\"attr\">credentialsId:</span> credentialsId, <span class=\"attr\">url:</span> gitUrl]])</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;maven编译&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                script &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// /usr/local/maven/apache-maven-3.8.1</span></span><br><span class=\"line\">                    println(<span class=\"string\">&quot;========开始maven编译=======&quot;</span>)</span><br><span class=\"line\">                    sh <span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">                    pwd</span></span><br><span class=\"line\"><span class=\"string\">                    $&#123;params.maven_home&#125;/bin/mvn clean install -T 1C -Dmaven.test.skip=true -Dmaven.compile.fork=true -U -B -f $&#123;env.WORKSPACE&#125;/pom.xml</span></span><br><span class=\"line\"><span class=\"string\">                    &quot;&quot;&quot;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;部署代码&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                script &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 获取当前Jekins 实例，理论上非空</span></span><br><span class=\"line\"><span class=\"comment\">//                    def inst = Jenkins.getInstanceOrNull()</span></span><br><span class=\"line\"></span><br><span class=\"line\">                    withCredentials([usernamePassword(<span class=\"attr\">credentialsId:</span> params.server_user, <span class=\"attr\">passwordVariable:</span> <span class=\"string\">&#x27;upwd&#x27;</span>, <span class=\"attr\">usernameVariable:</span> <span class=\"string\">&#x27;uname&#x27;</span>)]) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">def</span> remote = [:]</span><br><span class=\"line\">                        <span class=\"keyword\">def</span> serveripList = params.remote_ip_list_str.split(<span class=\"string\">&quot;,&quot;</span>)</span><br><span class=\"line\">                        <span class=\"keyword\">for</span> (ip <span class=\"keyword\">in</span> serveripList) &#123;</span><br><span class=\"line\">                            remote.password = upwd</span><br><span class=\"line\">                            remote.user = uname</span><br><span class=\"line\">                            remote.host = ip</span><br><span class=\"line\">                            remote.name = ip</span><br><span class=\"line\">                            remote.allowAnyHosts = <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">                            println(remote)</span><br><span class=\"line\">                            sshPut <span class=\"attr\">remote:</span> remote, <span class=\"attr\">from:</span> <span class=\"string\">&#x27;test.jar&#x27;</span>, <span class=\"attr\">into:</span> <span class=\"string\">&#x27;/home/target/jenkins&#x27;</span></span><br><span class=\"line\">                            sshScript <span class=\"attr\">remote:</span> remote, <span class=\"attr\">script:</span> <span class=\"string\">&#x27;/home/back/java_start.sh&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                            <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">                                println(<span class=\"string\">&quot;=== 开始健康检查===&quot;</span>)</span><br><span class=\"line\">                                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                                    <span class=\"keyword\">def</span> response = sh(</span><br><span class=\"line\">                                            <span class=\"symbol\">script:</span> <span class=\"string\">&quot;&quot;&quot;  curl -X GET &quot;http://$&#123;ip&#125;:8191/test/health/check&quot; &quot;&quot;&quot;</span>,</span><br><span class=\"line\">                                            <span class=\"symbol\">returnStdout:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">                                    ).trim()</span><br><span class=\"line\">                                    <span class=\"keyword\">if</span> (response.contains(<span class=\"string\">&quot;SUCCESS&quot;</span>)) &#123;</span><br><span class=\"line\">                                        <span class=\"keyword\">break</span></span><br><span class=\"line\">                                    &#125;</span><br><span class=\"line\">                                    println(<span class=\"string\">&quot; 健康检查失败 sleep 10 s&quot;</span>)</span><br><span class=\"line\">                                    sleep(<span class=\"number\">10</span>)</span><br><span class=\"line\">                                &#125; <span class=\"keyword\">catch</span> (exec) &#123;</span><br><span class=\"line\">                                    println(<span class=\"string\">&quot; 健康检查失败  $&#123;exec&#125;  sleep 10 s &quot;</span>)</span><br><span class=\"line\">                                    sleep(<span class=\"number\">10</span>)</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            println(<span class=\"string\">&quot;====== 健康检查通过 =====&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"jenkins进阶\"><a href=\"#jenkins进阶\" class=\"headerlink\" title=\"jenkins进阶\"></a>jenkins进阶</h1><p>记录最近踩的jenkins大坑，知识点比较零散</p>\n<h2 id=\"悲剧的起因\"><a href=\"#悲剧的起因\" class=\"headerlink\" title=\"悲剧的起因\"></a>悲剧的起因</h2><p>最近计划通过测试覆盖率工具来量化测试工作，避免漏测，少测试，因此选型jenkins+jacoco来实现</p>\n<h2 id=\"悲剧时间线\"><a href=\"#悲剧时间线\" class=\"headerlink\" title=\"悲剧时间线\"></a>悲剧时间线</h2><ul>\n<li>jenkins插件市场,找到jacoco插件</li>\n<li>下载jacoco插件，提示当前jenkins版本过低</li>\n<li>升级jenkins版本</li>\n<li>重启jenkins失败</li>\n<li>登陆jenkins机器看日志，提示jdk版本过低</li>\n<li>安装jdk11,并设置java环境变量</li>\n<li>jenkins 重启成功</li>\n<li>jenkins tool 新增jdk8 和jdk11</li>\n<li>配置jenkins job，使用 jdk8 </li>\n<li>运行job，提示编译失败，找不到jdk8的 rt.jar （jdk11没有改jar） </li>\n<li>job新增打印环境变量，输出结果是 jdk8，但是maven 插件依然使用jdk 11 </li>\n<li>修改jenkins所在机器的java环境变量为8，重启 jenkins 使用jdk11绝对路径启动 </li>\n<li>运行job，依然提示失败，使用当前jenkins进程对应的jdk11 </li>\n<li>回滚jenkins 版本到之前版本（jdk8） </li>\n<li>重启jenkins失败，提示config.xml解析异常</li>\n</ul>\n<h2 id=\"config-xml解析异常\"><a href=\"#config-xml解析异常\" class=\"headerlink\" title=\"config.xml解析异常\"></a>config.xml解析异常</h2><p>百度和谷歌了一把，都没找到有效的,这里吐槽一下百度，大量重复的内容<br>参考了一番搜索结果，查了下jenkins官网资料，最终有效的办法是注释掉报错的xml节点</p>\n<blockquote>\n<p>xml文件路径在 配置的{jenkins_home}目录下<br>根本原因是 新旧版本xml格式不兼容<br>jenkins 所有配置都使用xml方式存储的，遇到坏掉的插件，可以直接注释，或者修改成对应版本的格式<br>job配置的xml在{jenkins_home}&#x2F;jobs&#x2F;{job_name}&#x2F;config.xml<br>只要xml没被删除，可以通过xml还原之前的配置</p>\n</blockquote>\n<h2 id=\"maven插件不使用设置的jdk\"><a href=\"#maven插件不使用设置的jdk\" class=\"headerlink\" title=\"maven插件不使用设置的jdk\"></a>maven插件不使用设置的jdk</h2><p>这个问题如果使用maven项目则比较麻烦(jenkins哪些版本没这个bug,具体不详)，改成使用pipeline构建job</p>\n<blockquote>\n<p>理论上来说，编译使用的jdk版本和jenkins进程使用的jdk版本完全是隔离，例如 jenkins 使用11，项目使用8，反之亦然<br>推断原因应该是jenkins的maven项目 使用 scriptEngine 执行shell的时候,写法有问题。</p>\n</blockquote>\n<h2 id=\"pipeline-进阶知识点\"><a href=\"#pipeline-进阶知识点\" class=\"headerlink\" title=\"pipeline 进阶知识点\"></a>pipeline 进阶知识点</h2><p>基础的 jenkins pipeline我不介绍了，搜索一下，或者自己看官网文档。下面列下进阶技巧</p>\n<h3 id=\"账户密码托管\"><a href=\"#账户密码托管\" class=\"headerlink\" title=\"账户密码托管\"></a>账户密码托管</h3><p>jenkins job 有时候会涉及访问远程资源就需要使用对应的账户，例如git账户，oss账户，或者服务器账户<br>安全上来讲要统一使用凭证管理</p>\n<h4 id=\"新增凭证\"><a href=\"#新增凭证\" class=\"headerlink\" title=\"新增凭证\"></a>新增凭证</h4><img src=\"/2023123177c57190/img.png\" class=\"\" title=\"image\">\n\n<h4 id=\"pipeline-新增凭证参数，并且使用\"><a href=\"#pipeline-新增凭证参数，并且使用\" class=\"headerlink\" title=\"pipeline 新增凭证参数，并且使用\"></a>pipeline 新增凭证参数，并且使用</h4><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline&#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    parameters&#123;</span><br><span class=\"line\">        credentials(</span><br><span class=\"line\">                <span class=\"symbol\">credentialType:</span> <span class=\"string\">&#x27;com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;admin-user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; 服务器登陆账户 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;server_user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">required:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;打印变量&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                withCredentials([usernamePassword(<span class=\"attr\">credentialsId:</span></span><br><span class=\"line\">                        params.server_user, <span class=\"attr\">passwordVariable:</span> <span class=\"string\">&#x27;upwd&#x27;</span>, <span class=\"attr\">usernameVariable:</span> <span class=\"string\">&#x27;uname&#x27;</span>)]) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 在字符串里面使用$&#123;xx&#125;</span></span><br><span class=\"line\">                    <span class=\"comment\">// 在函数里面直接使用变量</span></span><br><span class=\"line\">                    println(<span class=\"string\">&quot; uname : $&#123;uname&#125; &quot;</span> )</span><br><span class=\"line\">                    println(<span class=\"string\">&quot; upwd : $&#123;upwd&#125; &quot;</span>)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">       </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>打印出来的用户名&#x2F;密码是星号</strong></p>\n<h3 id=\"Publish-Over-SSH-替代方案\"><a href=\"#Publish-Over-SSH-替代方案\" class=\"headerlink\" title=\"Publish Over SSH 替代方案\"></a>Publish Over SSH 替代方案</h3><p>大部分时候jenkins所在的服务器和java服务运行的服务器不是同一个，这个时候就需要上传jar到远程服务，且运行启动脚本<br>网上查了下资料，大部分使用publish over ssh,但这个插件已经不维护了，最新版本jenkins插件市场都找不到<br>推荐的替代方案是使用 SSH Pipeline Steps 替代</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">pipeline&#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    parameters&#123;</span><br><span class=\"line\">        credentials(</span><br><span class=\"line\">                <span class=\"symbol\">credentialType:</span> <span class=\"string\">&#x27;com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;admin-user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; 服务器登陆账户 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;server_user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">required:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;执行远程shell&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                withCredentials([usernamePassword(<span class=\"attr\">credentialsId:</span></span><br><span class=\"line\">                        params.server_user, <span class=\"attr\">passwordVariable:</span> <span class=\"string\">&#x27;upwd&#x27;</span>, <span class=\"attr\">usernameVariable:</span> <span class=\"string\">&#x27;uname&#x27;</span>)]) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">def</span> remote = [:]</span><br><span class=\"line\">                    remote.password = upwd</span><br><span class=\"line\">                    remote.user = uname</span><br><span class=\"line\">                    remote.host = <span class=\"string\">&quot;127.0.0.2&quot;</span></span><br><span class=\"line\">                    remote.name = <span class=\"string\">&quot;127.0.0.2&quot;</span></span><br><span class=\"line\">                    remote.allowAnyHosts = <span class=\"literal\">true</span></span><br><span class=\"line\">                    writeFile <span class=\"attr\">file:</span> <span class=\"string\">&#x27;abc.sh&#x27;</span>, <span class=\"attr\">text:</span> <span class=\"string\">&#x27;ls&#x27;</span></span><br><span class=\"line\">                    <span class=\"comment\">// 执行远程命令</span></span><br><span class=\"line\">                    sshCommand <span class=\"attr\">remote:</span> remote, <span class=\"attr\">command:</span> <span class=\"string\">&#x27;for i in &#123;1..5&#125;; do echo -n \\&quot;Loop \\$i \\&quot;; date ; sleep 1; done&#x27;</span></span><br><span class=\"line\">                    <span class=\"comment\">// 复制当前workspace下文件到 远程机器</span></span><br><span class=\"line\">                    sshPut <span class=\"attr\">remote:</span> remote, <span class=\"attr\">from:</span> <span class=\"string\">&#x27;abc.sh&#x27;</span>, <span class=\"attr\">into:</span> <span class=\"string\">&#x27;.&#x27;</span></span><br><span class=\"line\">                    <span class=\"comment\">// 复制当前 远程机器文件，到当前workspace</span></span><br><span class=\"line\">                    sshGet <span class=\"attr\">remote:</span> remote, <span class=\"attr\">from:</span> <span class=\"string\">&#x27;abc.sh&#x27;</span>, <span class=\"attr\">into:</span> <span class=\"string\">&#x27;bac.sh&#x27;</span>, <span class=\"attr\">override:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">                    <span class=\"comment\">//  执行远程脚本</span></span><br><span class=\"line\">                    sshScript <span class=\"attr\">remote:</span> remote, <span class=\"attr\">script:</span> <span class=\"string\">&#x27;abc.sh&#x27;</span></span><br><span class=\"line\">                    <span class=\"comment\">// 删除远程文件</span></span><br><span class=\"line\">                    sshRemove <span class=\"attr\">remote:</span> remote, <span class=\"attr\">path:</span> <span class=\"string\">&#x27;abc.sh&#x27;</span></span><br><span class=\"line\">                    </span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">       </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>当前workspace 在{jenkins_home}&#x2F;workspace&#x2F;{job_name}</strong></p>\n<h3 id=\"动态插件方案\"><a href=\"#动态插件方案\" class=\"headerlink\" title=\"动态插件方案\"></a>动态插件方案</h3><p>有时候有些疑难杂症，难以解决,需要在脚本运行期间使用 jenkins进程相关信息<br>注意，不要勾选沙箱运行，因为要获取jenkins实例，要突破沙箱限制</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span>  jenkins.model.*</span><br><span class=\"line\"><span class=\"comment\">// 有使用的插件也可以import其他的</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pipeline&#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    parameters&#123;</span><br><span class=\"line\">        credentials(</span><br><span class=\"line\">                <span class=\"symbol\">credentialType:</span> <span class=\"string\">&#x27;com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;admin-user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; 服务器登陆账户 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;server_user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">required:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;使用&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                script&#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 获取当前jenkins实例</span></span><br><span class=\"line\">                    <span class=\"keyword\">def</span> jks= Jenkins.getInstanceOrNull()</span><br><span class=\"line\">                    println(jks)</span><br><span class=\"line\">                    <span class=\"comment\">// 获取指定插件的配置,其他api，查看 https://javadoc.jenkins.io/jenkins/model/Jenkins.html</span></span><br><span class=\"line\">                    <span class=\"comment\">// 理论上所有插件和参数都能查看，也可以动态修改插件</span></span><br><span class=\"line\">                    <span class=\"keyword\">def</span> desc=jks.getDescriptor(com.cloudbees.plugins.credentials.Credentials.<span class=\"keyword\">class</span>)</span><br><span class=\"line\">                    println(desc)</span><br><span class=\"line\">                    <span class=\"keyword\">def</span> plugin=jks.getPlugin(com.cloudbees.plugins.credentials.Credentials.<span class=\"keyword\">class</span>)</span><br><span class=\"line\">                    println(plugin)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">               </span><br><span class=\"line\">                </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">       </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>高版本的jenkins除了关闭沙箱之外，还需要授权同意</strong></p>\n<img src=\"/2023123177c57190/img-1.png\" class=\"\" title=\"image\">\n\n<h2 id=\"jenkins发布流水线参考demo\"><a href=\"#jenkins发布流水线参考demo\" class=\"headerlink\" title=\"jenkins发布流水线参考demo\"></a>jenkins发布流水线参考demo</h2><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> jenkins.model.*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> *  see https://javadoc.jenkins.io/</span></span><br><span class=\"line\"><span class=\"comment\"> *  see https://github.com/jenkinsci/ssh-steps-plugin?tab=readme-ov-file#sshput</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\"></span><br><span class=\"line\">    tools &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 多jdk情况下手动指定 jdk，也可以在steps拿到jenkins实例后里面动态切换jdk</span></span><br><span class=\"line\">        jdk <span class=\"string\">&#x27;jdk8&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    options &#123;</span><br><span class=\"line\">        timestamps()    <span class=\"comment\">//设置在项目打印日志时带上对应时间</span></span><br><span class=\"line\">        disableConcurrentBuilds()   <span class=\"comment\">//不允许同时执行流水线，被用来防止同时访问共享资源等</span></span><br><span class=\"line\">        buildDiscarder(logRotator(<span class=\"attr\">numToKeepStr:</span> <span class=\"string\">&quot;5&quot;</span>))   <span class=\"comment\">// 表示保留n次构建历史</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    parameters &#123;</span><br><span class=\"line\">        <span class=\"comment\">// maven home--字符串参数 -- 去掉空白字符串</span></span><br><span class=\"line\">        string(</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;/usr/local/maven/apache-maven-3.8.1&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; maven 目录 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;maven_home&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">trim:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"comment\">// 发布的机器ip列表 逗号分割</span></span><br><span class=\"line\">        string(</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; 发布的机器ip列表 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;remote_ip_list_str&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">trim:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"comment\">// git_branches git 分支</span></span><br><span class=\"line\">        string(</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;*/test&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; git 分支 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;git_branches&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">trim:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"comment\">// git_time_out 单位分钟</span></span><br><span class=\"line\">        string(</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;20&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; git_time_out &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;git_time_out&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">trim:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"comment\">// git_url</span></span><br><span class=\"line\">        string(</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; git 仓库地址 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;git_url&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">trim:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"comment\">// ssh 凭证，访问git使用</span></span><br><span class=\"line\">        credentials(</span><br><span class=\"line\">                <span class=\"symbol\">credentialType:</span> <span class=\"string\">&#x27;com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;gitlab_jenkins&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; ssh 凭证 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;credentials_id&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">required:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        booleanParam(</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"literal\">false</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;是否启用测试覆盖率&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;is_enable_jacoco&#x27;</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">        credentials(</span><br><span class=\"line\">                <span class=\"symbol\">credentialType:</span> <span class=\"string\">&#x27;com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">defaultValue:</span> <span class=\"string\">&#x27;server-user-admin&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">description:</span> <span class=\"string\">&#x27;&#x27;&#x27; 服务器登陆账户 &#x27;&#x27;&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">name:</span> <span class=\"string\">&#x27;server_user&#x27;</span>,</span><br><span class=\"line\">                <span class=\"symbol\">required:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;打印环境变量&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                println(<span class=\"string\">&quot;=========开始打印环境变量=========&quot;</span>)</span><br><span class=\"line\">                sh <span class=\"string\">&quot;printenv&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;拉取git代码&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                script &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">def</span> branches = params.git_branches</span><br><span class=\"line\">                    <span class=\"keyword\">def</span> gitTimeOut = params.git_time_out</span><br><span class=\"line\">                    <span class=\"keyword\">def</span> credentialsId = params.credentials_id</span><br><span class=\"line\">                    <span class=\"keyword\">def</span> gitUrl = params.git_url</span><br><span class=\"line\">                    println(<span class=\"string\">&quot;========开始拉取git代码=======&quot;</span>)</span><br><span class=\"line\">                    println(gitUrl)</span><br><span class=\"line\">                    checkout scmGit(<span class=\"attr\">branches:</span> [[<span class=\"attr\">name:</span> branches]],</span><br><span class=\"line\">                            <span class=\"symbol\">extensions:</span> [cloneOption(<span class=\"attr\">noTags:</span> <span class=\"literal\">false</span>, <span class=\"attr\">reference:</span> <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">shallow:</span> <span class=\"literal\">true</span>, <span class=\"attr\">timeout:</span> gitTimeOut)], <span class=\"attr\">userRemoteConfigs:</span> [[<span class=\"attr\">credentialsId:</span> credentialsId, <span class=\"attr\">url:</span> gitUrl]])</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;maven编译&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                script &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// /usr/local/maven/apache-maven-3.8.1</span></span><br><span class=\"line\">                    println(<span class=\"string\">&quot;========开始maven编译=======&quot;</span>)</span><br><span class=\"line\">                    sh <span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">                    pwd</span></span><br><span class=\"line\"><span class=\"string\">                    $&#123;params.maven_home&#125;/bin/mvn clean install -T 1C -Dmaven.test.skip=true -Dmaven.compile.fork=true -U -B -f $&#123;env.WORKSPACE&#125;/pom.xml</span></span><br><span class=\"line\"><span class=\"string\">                    &quot;&quot;&quot;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;部署代码&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                script &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// 获取当前Jekins 实例，理论上非空</span></span><br><span class=\"line\"><span class=\"comment\">//                    def inst = Jenkins.getInstanceOrNull()</span></span><br><span class=\"line\"></span><br><span class=\"line\">                    withCredentials([usernamePassword(<span class=\"attr\">credentialsId:</span> params.server_user, <span class=\"attr\">passwordVariable:</span> <span class=\"string\">&#x27;upwd&#x27;</span>, <span class=\"attr\">usernameVariable:</span> <span class=\"string\">&#x27;uname&#x27;</span>)]) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">def</span> remote = [:]</span><br><span class=\"line\">                        <span class=\"keyword\">def</span> serveripList = params.remote_ip_list_str.split(<span class=\"string\">&quot;,&quot;</span>)</span><br><span class=\"line\">                        <span class=\"keyword\">for</span> (ip <span class=\"keyword\">in</span> serveripList) &#123;</span><br><span class=\"line\">                            remote.password = upwd</span><br><span class=\"line\">                            remote.user = uname</span><br><span class=\"line\">                            remote.host = ip</span><br><span class=\"line\">                            remote.name = ip</span><br><span class=\"line\">                            remote.allowAnyHosts = <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">                            println(remote)</span><br><span class=\"line\">                            sshPut <span class=\"attr\">remote:</span> remote, <span class=\"attr\">from:</span> <span class=\"string\">&#x27;test.jar&#x27;</span>, <span class=\"attr\">into:</span> <span class=\"string\">&#x27;/home/target/jenkins&#x27;</span></span><br><span class=\"line\">                            sshScript <span class=\"attr\">remote:</span> remote, <span class=\"attr\">script:</span> <span class=\"string\">&#x27;/home/back/java_start.sh&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                            <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">                                println(<span class=\"string\">&quot;=== 开始健康检查===&quot;</span>)</span><br><span class=\"line\">                                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                                    <span class=\"keyword\">def</span> response = sh(</span><br><span class=\"line\">                                            <span class=\"symbol\">script:</span> <span class=\"string\">&quot;&quot;&quot;  curl -X GET &quot;http://$&#123;ip&#125;:8191/test/health/check&quot; &quot;&quot;&quot;</span>,</span><br><span class=\"line\">                                            <span class=\"symbol\">returnStdout:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">                                    ).trim()</span><br><span class=\"line\">                                    <span class=\"keyword\">if</span> (response.contains(<span class=\"string\">&quot;SUCCESS&quot;</span>)) &#123;</span><br><span class=\"line\">                                        <span class=\"keyword\">break</span></span><br><span class=\"line\">                                    &#125;</span><br><span class=\"line\">                                    println(<span class=\"string\">&quot; 健康检查失败 sleep 10 s&quot;</span>)</span><br><span class=\"line\">                                    sleep(<span class=\"number\">10</span>)</span><br><span class=\"line\">                                &#125; <span class=\"keyword\">catch</span> (exec) &#123;</span><br><span class=\"line\">                                    println(<span class=\"string\">&quot; 健康检查失败  $&#123;exec&#125;  sleep 10 s &quot;</span>)</span><br><span class=\"line\">                                    sleep(<span class=\"number\">10</span>)</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            println(<span class=\"string\">&quot;====== 健康检查通过 =====&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n"},{"title":"mybatis源码分析（一）","abbrlink":26971,"date":"2023-06-20T06:59:40.000Z","_content":"# mybatis源码分析（一）\n\n## sqlSessionFactory对象\nsqlSessionFactory 是mybatis 核心配置类，管理mybatis全局配置。\n\n## sqlSession接口\n一个或者多个sql操作的执行单元。实现一个完整的sql操作。依赖sqlSessionFactory创建\n\n## Executor接口\n对应jdbc底层一个完整的sql操作。sqlSession 实际通过Executor执行sql操作\n\n## MapperProxy类\n代理实现mybatis的客户端mapper接口\n\n## MapperMethod类\n对应客户端代码的mapper接口里面的一个方法。该实例缓存了。\n\n## StatementHandler接口\njdbc Statement的装饰器\n\n## ResultSetHandler接口\njdbc resultSet的装饰器\n\n## mybaits执行orm操作细节\n{% asset_img 1.png  image %}\n**sqlsession的close 方法会关闭底层jdbc connection**\n\n## mybatis插件机制\nmybatis插件是基于代理实现的，具体支持一下四个接口\n\n- Executor\n- ParameterHandler\n- ResultSetHandler\n- StatemetHandler\n\n\n\n","source":"_posts/mybatis源码分析（一）.md","raw":"---\ntitle: mybatis源码分析（一）\ntags:\n  - mybatis\nabbrlink: 26971\ndate: 2023-06-20 14:59:40\n---\n# mybatis源码分析（一）\n\n## sqlSessionFactory对象\nsqlSessionFactory 是mybatis 核心配置类，管理mybatis全局配置。\n\n## sqlSession接口\n一个或者多个sql操作的执行单元。实现一个完整的sql操作。依赖sqlSessionFactory创建\n\n## Executor接口\n对应jdbc底层一个完整的sql操作。sqlSession 实际通过Executor执行sql操作\n\n## MapperProxy类\n代理实现mybatis的客户端mapper接口\n\n## MapperMethod类\n对应客户端代码的mapper接口里面的一个方法。该实例缓存了。\n\n## StatementHandler接口\njdbc Statement的装饰器\n\n## ResultSetHandler接口\njdbc resultSet的装饰器\n\n## mybaits执行orm操作细节\n{% asset_img 1.png  image %}\n**sqlsession的close 方法会关闭底层jdbc connection**\n\n## mybatis插件机制\nmybatis插件是基于代理实现的，具体支持一下四个接口\n\n- Executor\n- ParameterHandler\n- ResultSetHandler\n- StatemetHandler\n\n\n\n","slug":"mybatis源码分析（一）","published":1,"updated":"2023-12-05T02:48:12.736Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdj60012orgo45szaxb5","content":"<h1 id=\"mybatis源码分析（一）\"><a href=\"#mybatis源码分析（一）\" class=\"headerlink\" title=\"mybatis源码分析（一）\"></a>mybatis源码分析（一）</h1><h2 id=\"sqlSessionFactory对象\"><a href=\"#sqlSessionFactory对象\" class=\"headerlink\" title=\"sqlSessionFactory对象\"></a>sqlSessionFactory对象</h2><p>sqlSessionFactory 是mybatis 核心配置类，管理mybatis全局配置。</p>\n<h2 id=\"sqlSession接口\"><a href=\"#sqlSession接口\" class=\"headerlink\" title=\"sqlSession接口\"></a>sqlSession接口</h2><p>一个或者多个sql操作的执行单元。实现一个完整的sql操作。依赖sqlSessionFactory创建</p>\n<h2 id=\"Executor接口\"><a href=\"#Executor接口\" class=\"headerlink\" title=\"Executor接口\"></a>Executor接口</h2><p>对应jdbc底层一个完整的sql操作。sqlSession 实际通过Executor执行sql操作</p>\n<h2 id=\"MapperProxy类\"><a href=\"#MapperProxy类\" class=\"headerlink\" title=\"MapperProxy类\"></a>MapperProxy类</h2><p>代理实现mybatis的客户端mapper接口</p>\n<h2 id=\"MapperMethod类\"><a href=\"#MapperMethod类\" class=\"headerlink\" title=\"MapperMethod类\"></a>MapperMethod类</h2><p>对应客户端代码的mapper接口里面的一个方法。该实例缓存了。</p>\n<h2 id=\"StatementHandler接口\"><a href=\"#StatementHandler接口\" class=\"headerlink\" title=\"StatementHandler接口\"></a>StatementHandler接口</h2><p>jdbc Statement的装饰器</p>\n<h2 id=\"ResultSetHandler接口\"><a href=\"#ResultSetHandler接口\" class=\"headerlink\" title=\"ResultSetHandler接口\"></a>ResultSetHandler接口</h2><p>jdbc resultSet的装饰器</p>\n<h2 id=\"mybaits执行orm操作细节\"><a href=\"#mybaits执行orm操作细节\" class=\"headerlink\" title=\"mybaits执行orm操作细节\"></a>mybaits执行orm操作细节</h2><img src=\"/2023062026971/1.png\" class=\"\" title=\"image\">\n<p><strong>sqlsession的close 方法会关闭底层jdbc connection</strong></p>\n<h2 id=\"mybatis插件机制\"><a href=\"#mybatis插件机制\" class=\"headerlink\" title=\"mybatis插件机制\"></a>mybatis插件机制</h2><p>mybatis插件是基于代理实现的，具体支持一下四个接口</p>\n<ul>\n<li>Executor</li>\n<li>ParameterHandler</li>\n<li>ResultSetHandler</li>\n<li>StatemetHandler</li>\n</ul>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"mybatis源码分析（一）\"><a href=\"#mybatis源码分析（一）\" class=\"headerlink\" title=\"mybatis源码分析（一）\"></a>mybatis源码分析（一）</h1><h2 id=\"sqlSessionFactory对象\"><a href=\"#sqlSessionFactory对象\" class=\"headerlink\" title=\"sqlSessionFactory对象\"></a>sqlSessionFactory对象</h2><p>sqlSessionFactory 是mybatis 核心配置类，管理mybatis全局配置。</p>\n<h2 id=\"sqlSession接口\"><a href=\"#sqlSession接口\" class=\"headerlink\" title=\"sqlSession接口\"></a>sqlSession接口</h2><p>一个或者多个sql操作的执行单元。实现一个完整的sql操作。依赖sqlSessionFactory创建</p>\n<h2 id=\"Executor接口\"><a href=\"#Executor接口\" class=\"headerlink\" title=\"Executor接口\"></a>Executor接口</h2><p>对应jdbc底层一个完整的sql操作。sqlSession 实际通过Executor执行sql操作</p>\n<h2 id=\"MapperProxy类\"><a href=\"#MapperProxy类\" class=\"headerlink\" title=\"MapperProxy类\"></a>MapperProxy类</h2><p>代理实现mybatis的客户端mapper接口</p>\n<h2 id=\"MapperMethod类\"><a href=\"#MapperMethod类\" class=\"headerlink\" title=\"MapperMethod类\"></a>MapperMethod类</h2><p>对应客户端代码的mapper接口里面的一个方法。该实例缓存了。</p>\n<h2 id=\"StatementHandler接口\"><a href=\"#StatementHandler接口\" class=\"headerlink\" title=\"StatementHandler接口\"></a>StatementHandler接口</h2><p>jdbc Statement的装饰器</p>\n<h2 id=\"ResultSetHandler接口\"><a href=\"#ResultSetHandler接口\" class=\"headerlink\" title=\"ResultSetHandler接口\"></a>ResultSetHandler接口</h2><p>jdbc resultSet的装饰器</p>\n<h2 id=\"mybaits执行orm操作细节\"><a href=\"#mybaits执行orm操作细节\" class=\"headerlink\" title=\"mybaits执行orm操作细节\"></a>mybaits执行orm操作细节</h2><img src=\"/2023062026971/1.png\" class=\"\" title=\"image\">\n<p><strong>sqlsession的close 方法会关闭底层jdbc connection</strong></p>\n<h2 id=\"mybatis插件机制\"><a href=\"#mybatis插件机制\" class=\"headerlink\" title=\"mybatis插件机制\"></a>mybatis插件机制</h2><p>mybatis插件是基于代理实现的，具体支持一下四个接口</p>\n<ul>\n<li>Executor</li>\n<li>ParameterHandler</li>\n<li>ResultSetHandler</li>\n<li>StatemetHandler</li>\n</ul>\n"},{"title":"ringBuffer深入浅出","abbrlink":22759,"date":"2023-06-20T07:55:40.000Z","_content":"# ringBuffer深入浅出\n\nringBuffer顾名思义就是环形缓冲区，常用来做高速缓冲队列，采用环形复用(缓存区写满之后，从首地址重新写入)，使用较小的实际物理内存实现了线性缓存。例如著名的Disruptor高性能的主要原因就是使用了ringBuffer。\n\n## ringBuffer特性\n- 存在读写2个序号\n- 读/写序号一直累加\n- 读/写序号取模buffer长度等于当前当前读写指针位置\n- buffer里面的数据不需要删除，覆盖即可\n- ringBuffer采用数组实现，对cpu高速缓存友好（cache line会加载相邻元素，数组元素天生相邻），访问速度比链表快。\n\n## RingBuffer代码\n\n{% codeblock  lang:java   %}\n\n\n    package wiki.chenxun.study.buffer;\n    import sun.misc.Unsafe;\n    import java.lang.reflect.Field;\n    import java.security.AccessController;\n    import java.security.PrivilegedExceptionAction;\n    import java.util.concurrent.TimeUnit;\n    /**\n     * @author chenxun\n     * @date 2019-11-19\n     * @since\n    */\n    public class RingBuffer<T> {\n    private static Unsafe unsafe;\n    private final T[] buffer;\n    private volatile int readIndex =-1;\n    private volatile int writerIndex =-1;\n    private static long readIndexOffset;\n    private static long writerIndexOffset;\n    static {\n    try {\n    unsafe = AccessController.doPrivileged((PrivilegedExceptionAction<Unsafe>) () -> {\n    Field theUnsafe = Unsafe.class.getDeclaredField(\"theUnsafe\");\n    theUnsafe.setAccessible(true);\n    return (Unsafe) theUnsafe.get(null);\n    });\n    readIndexOffset = unsafe.objectFieldOffset\n    (RingBuffer.class.getDeclaredField(\"readIndex\"));\n    writerIndexOffset = unsafe.objectFieldOffset\n    (RingBuffer.class.getDeclaredField(\"writerIndex\"));\n    } catch (Exception e) {\n    e.printStackTrace();\n    }\n    }\n    @SuppressWarnings(\"all\")\n    public RingBuffer(int bufferSize) {\n    buffer = (T[])new Object[bufferSize];\n    }\n    /**\n      * 队列添加元素，如果队列满了，则等待到队列空余\n      * @param t\n      * @throws InterruptedException\n        */\n        public void push(T t) throws InterruptedException {\n        while (true){\n        //判断是否可写 总长度-（写位置-读位置）\n        if(buffer.length-(writerIndex-readIndex)>0){\n        int nextWriterIndex=writerIndex+1;\n        boolean result=unsafe.compareAndSwapInt(this,writerIndexOffset,writerIndex,nextWriterIndex);\n        if(result){\n        //计算实际位置\n        int bufferIndex=writerIndex%buffer.length;\n        buffer[bufferIndex]=t;\n        break;\n        }\n        }\n        // 休眠1ms\n        TimeUnit.MILLISECONDS.sleep(1L);\n        }\n        }\n        /**\n      * 队列取出元素，如果没有可读元素，则等待到有可读元素\n      * @return\n      * @throws InterruptedException\n        */\n        public T pop() throws InterruptedException {\n        while (true){\n        // 判断是否可读\n        if(writerIndex-readIndex>0){\n        int nextReadIndex=readIndex+1;\n        boolean result=unsafe.compareAndSwapInt(this,readIndexOffset,readIndex,nextReadIndex);\n        if(result){\n        //计算实际位置\n        int bufferIndex=readIndex%buffer.length;\n        return buffer[bufferIndex];\n        }\n        }\n        // 休眠1ms\n        TimeUnit.MILLISECONDS.sleep(1L);\n        }\n        }\n        }\n\n{% endcodeblock %}\n\n## 测试代码\n{% codeblock  lang:java   %}\n\n    package wiki.chenxun.study.buffer;\n    import java.io.IOException;\n    import java.util.Random;\n    import java.util.concurrent.TimeUnit;\n    /**\n    * @author chenxun\n    * @date 2019-11-19\n     * @since\n    */\n    public class RingBufferTest {\n    public static void main(String[] args) {\n    RingBuffer<String> ringBuffer=new RingBuffer<>(20);\n    for(int a=1;a<4;a++){\n    final int b=a;\n    new Thread(()->{\n    for(int i=0;i<10;i++){\n    try {\n    ringBuffer.push(String.valueOf(b*10+i));\n    } catch (InterruptedException e) {\n    e.printStackTrace();\n    }\n    try {\n    Random r=new Random();\n    TimeUnit.MILLISECONDS.sleep(r.nextInt(5));\n    } catch (InterruptedException e) {\n    e.printStackTrace();\n    }\n    }\n    }).start();\n    }\n    for(int a=0;a<2;a++){\n    new Thread(()->{\n    while (true){\n    String s= null;\n    try {\n    s = ringBuffer.pop();\n    System.out.println(s);\n    } catch (InterruptedException e) {\n    e.printStackTrace();\n    }\n    }\n    }).start();\n    }\n    try {\n    System.in.read();\n    } catch (IOException e) {\n    e.printStackTrace();\n    }\n    }\n    }\n\n{% endcodeblock %}\n\n## buffer下标计算优化\n如果buffer的size是2的n次方，那么取模运算可以替换成位运算.代码参考如下\n{% codeblock  lang:java   %}\n\n\n    package wiki.chenxun.study.buffer;\n\n    /**\n    * @author chenxun\n    * @date 2019-11-19\n    * @since\n    */\n    public class NumberUtils {\n\n    public static int moduloOperationOn2(int a, int b) {\n    return a & b - 1;\n    }\n\n    public static void main(String[] args) {\n    int a=100%8;\n    int b=moduloOperationOn2(100,8);\n    System.out.println(a==b);\n\n    }\n    }\n\n\n{% endcodeblock %}\n\n## 缓存伪共享优化\ncpu加载数据是基于缓存行（具体原理不展开了），java8支持通过@sun.misc.Contended来解决这个问题，\n非java8版本可以参考Disruptor的做法 https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/RingBuffer.java\n\n## 读写序号java溢出问题\n暂时没有想到好方案，目前大致思路是，设置一个阀值算法，满足阀值则重置大小，类似java集合扩容一样，但这个会导致读写锁住。\n\n## RingBuffer应用场景\n\n- 依赖一个优惠券的查询接口，假设该接口提供分页查询能力。单次最多返回100张优惠优惠券，单次rt是20ms\n- 优惠券的扩展信息是另一个接口，该接口性能提供批量查询能力，单次做多支持30张优惠券，单词rt是30ms\n- 假设某个用户有500张优惠券\n\n如果是串行调用，则整体时间是 (500/100)20+(500/30)30.采用ringBuffer解耦两个接口依赖，则优化后的rt时间，\n理论上可以缩减至30ms左右（排除cpu切换上下文损耗等）\n","source":"_posts/ringBuffer深入浅出.md","raw":"---\ntitle: ringBuffer深入浅出\ntags:\n  - java\nabbrlink: 22759\ndate: 2023-06-20 15:55:40\n---\n# ringBuffer深入浅出\n\nringBuffer顾名思义就是环形缓冲区，常用来做高速缓冲队列，采用环形复用(缓存区写满之后，从首地址重新写入)，使用较小的实际物理内存实现了线性缓存。例如著名的Disruptor高性能的主要原因就是使用了ringBuffer。\n\n## ringBuffer特性\n- 存在读写2个序号\n- 读/写序号一直累加\n- 读/写序号取模buffer长度等于当前当前读写指针位置\n- buffer里面的数据不需要删除，覆盖即可\n- ringBuffer采用数组实现，对cpu高速缓存友好（cache line会加载相邻元素，数组元素天生相邻），访问速度比链表快。\n\n## RingBuffer代码\n\n{% codeblock  lang:java   %}\n\n\n    package wiki.chenxun.study.buffer;\n    import sun.misc.Unsafe;\n    import java.lang.reflect.Field;\n    import java.security.AccessController;\n    import java.security.PrivilegedExceptionAction;\n    import java.util.concurrent.TimeUnit;\n    /**\n     * @author chenxun\n     * @date 2019-11-19\n     * @since\n    */\n    public class RingBuffer<T> {\n    private static Unsafe unsafe;\n    private final T[] buffer;\n    private volatile int readIndex =-1;\n    private volatile int writerIndex =-1;\n    private static long readIndexOffset;\n    private static long writerIndexOffset;\n    static {\n    try {\n    unsafe = AccessController.doPrivileged((PrivilegedExceptionAction<Unsafe>) () -> {\n    Field theUnsafe = Unsafe.class.getDeclaredField(\"theUnsafe\");\n    theUnsafe.setAccessible(true);\n    return (Unsafe) theUnsafe.get(null);\n    });\n    readIndexOffset = unsafe.objectFieldOffset\n    (RingBuffer.class.getDeclaredField(\"readIndex\"));\n    writerIndexOffset = unsafe.objectFieldOffset\n    (RingBuffer.class.getDeclaredField(\"writerIndex\"));\n    } catch (Exception e) {\n    e.printStackTrace();\n    }\n    }\n    @SuppressWarnings(\"all\")\n    public RingBuffer(int bufferSize) {\n    buffer = (T[])new Object[bufferSize];\n    }\n    /**\n      * 队列添加元素，如果队列满了，则等待到队列空余\n      * @param t\n      * @throws InterruptedException\n        */\n        public void push(T t) throws InterruptedException {\n        while (true){\n        //判断是否可写 总长度-（写位置-读位置）\n        if(buffer.length-(writerIndex-readIndex)>0){\n        int nextWriterIndex=writerIndex+1;\n        boolean result=unsafe.compareAndSwapInt(this,writerIndexOffset,writerIndex,nextWriterIndex);\n        if(result){\n        //计算实际位置\n        int bufferIndex=writerIndex%buffer.length;\n        buffer[bufferIndex]=t;\n        break;\n        }\n        }\n        // 休眠1ms\n        TimeUnit.MILLISECONDS.sleep(1L);\n        }\n        }\n        /**\n      * 队列取出元素，如果没有可读元素，则等待到有可读元素\n      * @return\n      * @throws InterruptedException\n        */\n        public T pop() throws InterruptedException {\n        while (true){\n        // 判断是否可读\n        if(writerIndex-readIndex>0){\n        int nextReadIndex=readIndex+1;\n        boolean result=unsafe.compareAndSwapInt(this,readIndexOffset,readIndex,nextReadIndex);\n        if(result){\n        //计算实际位置\n        int bufferIndex=readIndex%buffer.length;\n        return buffer[bufferIndex];\n        }\n        }\n        // 休眠1ms\n        TimeUnit.MILLISECONDS.sleep(1L);\n        }\n        }\n        }\n\n{% endcodeblock %}\n\n## 测试代码\n{% codeblock  lang:java   %}\n\n    package wiki.chenxun.study.buffer;\n    import java.io.IOException;\n    import java.util.Random;\n    import java.util.concurrent.TimeUnit;\n    /**\n    * @author chenxun\n    * @date 2019-11-19\n     * @since\n    */\n    public class RingBufferTest {\n    public static void main(String[] args) {\n    RingBuffer<String> ringBuffer=new RingBuffer<>(20);\n    for(int a=1;a<4;a++){\n    final int b=a;\n    new Thread(()->{\n    for(int i=0;i<10;i++){\n    try {\n    ringBuffer.push(String.valueOf(b*10+i));\n    } catch (InterruptedException e) {\n    e.printStackTrace();\n    }\n    try {\n    Random r=new Random();\n    TimeUnit.MILLISECONDS.sleep(r.nextInt(5));\n    } catch (InterruptedException e) {\n    e.printStackTrace();\n    }\n    }\n    }).start();\n    }\n    for(int a=0;a<2;a++){\n    new Thread(()->{\n    while (true){\n    String s= null;\n    try {\n    s = ringBuffer.pop();\n    System.out.println(s);\n    } catch (InterruptedException e) {\n    e.printStackTrace();\n    }\n    }\n    }).start();\n    }\n    try {\n    System.in.read();\n    } catch (IOException e) {\n    e.printStackTrace();\n    }\n    }\n    }\n\n{% endcodeblock %}\n\n## buffer下标计算优化\n如果buffer的size是2的n次方，那么取模运算可以替换成位运算.代码参考如下\n{% codeblock  lang:java   %}\n\n\n    package wiki.chenxun.study.buffer;\n\n    /**\n    * @author chenxun\n    * @date 2019-11-19\n    * @since\n    */\n    public class NumberUtils {\n\n    public static int moduloOperationOn2(int a, int b) {\n    return a & b - 1;\n    }\n\n    public static void main(String[] args) {\n    int a=100%8;\n    int b=moduloOperationOn2(100,8);\n    System.out.println(a==b);\n\n    }\n    }\n\n\n{% endcodeblock %}\n\n## 缓存伪共享优化\ncpu加载数据是基于缓存行（具体原理不展开了），java8支持通过@sun.misc.Contended来解决这个问题，\n非java8版本可以参考Disruptor的做法 https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/RingBuffer.java\n\n## 读写序号java溢出问题\n暂时没有想到好方案，目前大致思路是，设置一个阀值算法，满足阀值则重置大小，类似java集合扩容一样，但这个会导致读写锁住。\n\n## RingBuffer应用场景\n\n- 依赖一个优惠券的查询接口，假设该接口提供分页查询能力。单次最多返回100张优惠优惠券，单次rt是20ms\n- 优惠券的扩展信息是另一个接口，该接口性能提供批量查询能力，单次做多支持30张优惠券，单词rt是30ms\n- 假设某个用户有500张优惠券\n\n如果是串行调用，则整体时间是 (500/100)20+(500/30)30.采用ringBuffer解耦两个接口依赖，则优化后的rt时间，\n理论上可以缩减至30ms左右（排除cpu切换上下文损耗等）\n","slug":"ringBuffer深入浅出","published":1,"updated":"2023-12-05T02:48:12.736Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdj70014orgo1oar0f2m","content":"<h1 id=\"ringBuffer深入浅出\"><a href=\"#ringBuffer深入浅出\" class=\"headerlink\" title=\"ringBuffer深入浅出\"></a>ringBuffer深入浅出</h1><p>ringBuffer顾名思义就是环形缓冲区，常用来做高速缓冲队列，采用环形复用(缓存区写满之后，从首地址重新写入)，使用较小的实际物理内存实现了线性缓存。例如著名的Disruptor高性能的主要原因就是使用了ringBuffer。</p>\n<h2 id=\"ringBuffer特性\"><a href=\"#ringBuffer特性\" class=\"headerlink\" title=\"ringBuffer特性\"></a>ringBuffer特性</h2><ul>\n<li>存在读写2个序号</li>\n<li>读&#x2F;写序号一直累加</li>\n<li>读&#x2F;写序号取模buffer长度等于当前当前读写指针位置</li>\n<li>buffer里面的数据不需要删除，覆盖即可</li>\n<li>ringBuffer采用数组实现，对cpu高速缓存友好（cache line会加载相邻元素，数组元素天生相邻），访问速度比链表快。</li>\n</ul>\n<h2 id=\"RingBuffer代码\"><a href=\"#RingBuffer代码\" class=\"headerlink\" title=\"RingBuffer代码\"></a>RingBuffer代码</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> wiki.chenxun.study.buffer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> sun.misc.Unsafe;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Field;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.AccessController;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.PrivilegedExceptionAction;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> chenxun</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2019-11-19</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span></span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RingBuffer</span>&lt;T&gt; &#123;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Unsafe unsafe;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> T[] buffer;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"type\">int</span> <span class=\"variable\">readIndex</span> <span class=\"operator\">=</span>-<span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"type\">int</span> <span class=\"variable\">writerIndex</span> <span class=\"operator\">=</span>-<span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">long</span> readIndexOffset;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">long</span> writerIndexOffset;</span><br><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">unsafe = AccessController.doPrivileged((PrivilegedExceptionAction&lt;Unsafe&gt;) () -&gt; &#123;</span><br><span class=\"line\"><span class=\"type\">Field</span> <span class=\"variable\">theUnsafe</span> <span class=\"operator\">=</span> Unsafe.class.getDeclaredField(<span class=\"string\">&quot;theUnsafe&quot;</span>);</span><br><span class=\"line\">theUnsafe.setAccessible(<span class=\"literal\">true</span>);</span><br><span class=\"line\"><span class=\"keyword\">return</span> (Unsafe) theUnsafe.get(<span class=\"literal\">null</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">readIndexOffset = unsafe.objectFieldOffset</span><br><span class=\"line\">(RingBuffer.class.getDeclaredField(<span class=\"string\">&quot;readIndex&quot;</span>));</span><br><span class=\"line\">writerIndexOffset = unsafe.objectFieldOffset</span><br><span class=\"line\">(RingBuffer.class.getDeclaredField(<span class=\"string\">&quot;writerIndex&quot;</span>));</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">e.printStackTrace();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">RingBuffer</span><span class=\"params\">(<span class=\"type\">int</span> bufferSize)</span> &#123;</span><br><span class=\"line\">buffer = (T[])<span class=\"keyword\">new</span> <span class=\"title class_\">Object</span>[bufferSize];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * 队列添加元素，如果队列满了，则等待到队列空余</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@param</span> t</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@throws</span> InterruptedException</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">push</span><span class=\"params\">(T t)</span> <span class=\"keyword\">throws</span> InterruptedException &#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>)&#123;</span><br><span class=\"line\">    <span class=\"comment\">//判断是否可写 总长度-（写位置-读位置）</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(buffer.length-(writerIndex-readIndex)&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> nextWriterIndex=writerIndex+<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"type\">boolean</span> result=unsafe.compareAndSwapInt(<span class=\"built_in\">this</span>,writerIndexOffset,writerIndex,nextWriterIndex);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(result)&#123;</span><br><span class=\"line\">    <span class=\"comment\">//计算实际位置</span></span><br><span class=\"line\">    <span class=\"type\">int</span> bufferIndex=writerIndex%buffer.length;</span><br><span class=\"line\">    buffer[bufferIndex]=t;</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 休眠1ms</span></span><br><span class=\"line\">    TimeUnit.MILLISECONDS.sleep(<span class=\"number\">1L</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * 队列取出元素，如果没有可读元素，则等待到有可读元素</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@throws</span> InterruptedException</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> T <span class=\"title function_\">pop</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException &#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>)&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 判断是否可读</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(writerIndex-readIndex&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> nextReadIndex=readIndex+<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"type\">boolean</span> result=unsafe.compareAndSwapInt(<span class=\"built_in\">this</span>,readIndexOffset,readIndex,nextReadIndex);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(result)&#123;</span><br><span class=\"line\">    <span class=\"comment\">//计算实际位置</span></span><br><span class=\"line\">    <span class=\"type\">int</span> bufferIndex=readIndex%buffer.length;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> buffer[bufferIndex];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 休眠1ms</span></span><br><span class=\"line\">    TimeUnit.MILLISECONDS.sleep(<span class=\"number\">1L</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试代码\"><a href=\"#测试代码\" class=\"headerlink\" title=\"测试代码\"></a>测试代码</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> wiki.chenxun.study.buffer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Random;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@author</span> chenxun</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@date</span> 2019-11-19</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span></span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RingBufferTest</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">RingBuffer&lt;String&gt; ringBuffer=<span class=\"keyword\">new</span> <span class=\"title class_\">RingBuffer</span>&lt;&gt;(<span class=\"number\">20</span>);</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"type\">int</span> a=<span class=\"number\">1</span>;a&lt;<span class=\"number\">4</span>;a++)&#123;</span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> b=a;</span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(()-&gt;&#123;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">10</span>;i++)&#123;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">ringBuffer.push(String.valueOf(b*<span class=\"number\">10</span>+i));</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">e.printStackTrace();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">Random r=<span class=\"keyword\">new</span> <span class=\"title class_\">Random</span>();</span><br><span class=\"line\">TimeUnit.MILLISECONDS.sleep(r.nextInt(<span class=\"number\">5</span>));</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">e.printStackTrace();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;).start();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"type\">int</span> a=<span class=\"number\">0</span>;a&lt;<span class=\"number\">2</span>;a++)&#123;</span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(()-&gt;&#123;</span><br><span class=\"line\"><span class=\"keyword\">while</span> (<span class=\"literal\">true</span>)&#123;</span><br><span class=\"line\">String s= <span class=\"literal\">null</span>;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">s = ringBuffer.pop();</span><br><span class=\"line\">System.out.println(s);</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">e.printStackTrace();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;).start();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">System.in.read();</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">e.printStackTrace();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"buffer下标计算优化\"><a href=\"#buffer下标计算优化\" class=\"headerlink\" title=\"buffer下标计算优化\"></a>buffer下标计算优化</h2><p>如果buffer的size是2的n次方，那么取模运算可以替换成位运算.代码参考如下</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> wiki.chenxun.study.buffer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@author</span> chenxun</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@date</span> 2019-11-19</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@since</span></span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NumberUtils</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">moduloOperationOn2</span><span class=\"params\">(<span class=\"type\">int</span> a, <span class=\"type\">int</span> b)</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">return</span> a &amp; b - <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\"><span class=\"type\">int</span> a=<span class=\"number\">100</span>%<span class=\"number\">8</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> b=moduloOperationOn2(<span class=\"number\">100</span>,<span class=\"number\">8</span>);</span><br><span class=\"line\">System.out.println(a==b);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"缓存伪共享优化\"><a href=\"#缓存伪共享优化\" class=\"headerlink\" title=\"缓存伪共享优化\"></a>缓存伪共享优化</h2><p>cpu加载数据是基于缓存行（具体原理不展开了），java8支持通过@sun.misc.Contended来解决这个问题，<br>非java8版本可以参考Disruptor的做法 <a href=\"https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/RingBuffer.java\">https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/RingBuffer.java</a></p>\n<h2 id=\"读写序号java溢出问题\"><a href=\"#读写序号java溢出问题\" class=\"headerlink\" title=\"读写序号java溢出问题\"></a>读写序号java溢出问题</h2><p>暂时没有想到好方案，目前大致思路是，设置一个阀值算法，满足阀值则重置大小，类似java集合扩容一样，但这个会导致读写锁住。</p>\n<h2 id=\"RingBuffer应用场景\"><a href=\"#RingBuffer应用场景\" class=\"headerlink\" title=\"RingBuffer应用场景\"></a>RingBuffer应用场景</h2><ul>\n<li>依赖一个优惠券的查询接口，假设该接口提供分页查询能力。单次最多返回100张优惠优惠券，单次rt是20ms</li>\n<li>优惠券的扩展信息是另一个接口，该接口性能提供批量查询能力，单次做多支持30张优惠券，单词rt是30ms</li>\n<li>假设某个用户有500张优惠券</li>\n</ul>\n<p>如果是串行调用，则整体时间是 (500&#x2F;100)20+(500&#x2F;30)30.采用ringBuffer解耦两个接口依赖，则优化后的rt时间，<br>理论上可以缩减至30ms左右（排除cpu切换上下文损耗等）</p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"ringBuffer深入浅出\"><a href=\"#ringBuffer深入浅出\" class=\"headerlink\" title=\"ringBuffer深入浅出\"></a>ringBuffer深入浅出</h1><p>ringBuffer顾名思义就是环形缓冲区，常用来做高速缓冲队列，采用环形复用(缓存区写满之后，从首地址重新写入)，使用较小的实际物理内存实现了线性缓存。例如著名的Disruptor高性能的主要原因就是使用了ringBuffer。</p>\n<h2 id=\"ringBuffer特性\"><a href=\"#ringBuffer特性\" class=\"headerlink\" title=\"ringBuffer特性\"></a>ringBuffer特性</h2><ul>\n<li>存在读写2个序号</li>\n<li>读&#x2F;写序号一直累加</li>\n<li>读&#x2F;写序号取模buffer长度等于当前当前读写指针位置</li>\n<li>buffer里面的数据不需要删除，覆盖即可</li>\n<li>ringBuffer采用数组实现，对cpu高速缓存友好（cache line会加载相邻元素，数组元素天生相邻），访问速度比链表快。</li>\n</ul>\n<h2 id=\"RingBuffer代码\"><a href=\"#RingBuffer代码\" class=\"headerlink\" title=\"RingBuffer代码\"></a>RingBuffer代码</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> wiki.chenxun.study.buffer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> sun.misc.Unsafe;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Field;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.AccessController;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.PrivilegedExceptionAction;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> chenxun</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2019-11-19</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span></span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RingBuffer</span>&lt;T&gt; &#123;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Unsafe unsafe;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> T[] buffer;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"type\">int</span> <span class=\"variable\">readIndex</span> <span class=\"operator\">=</span>-<span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"type\">int</span> <span class=\"variable\">writerIndex</span> <span class=\"operator\">=</span>-<span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">long</span> readIndexOffset;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"type\">long</span> writerIndexOffset;</span><br><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">unsafe = AccessController.doPrivileged((PrivilegedExceptionAction&lt;Unsafe&gt;) () -&gt; &#123;</span><br><span class=\"line\"><span class=\"type\">Field</span> <span class=\"variable\">theUnsafe</span> <span class=\"operator\">=</span> Unsafe.class.getDeclaredField(<span class=\"string\">&quot;theUnsafe&quot;</span>);</span><br><span class=\"line\">theUnsafe.setAccessible(<span class=\"literal\">true</span>);</span><br><span class=\"line\"><span class=\"keyword\">return</span> (Unsafe) theUnsafe.get(<span class=\"literal\">null</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">readIndexOffset = unsafe.objectFieldOffset</span><br><span class=\"line\">(RingBuffer.class.getDeclaredField(<span class=\"string\">&quot;readIndex&quot;</span>));</span><br><span class=\"line\">writerIndexOffset = unsafe.objectFieldOffset</span><br><span class=\"line\">(RingBuffer.class.getDeclaredField(<span class=\"string\">&quot;writerIndex&quot;</span>));</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">e.printStackTrace();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"title function_\">RingBuffer</span><span class=\"params\">(<span class=\"type\">int</span> bufferSize)</span> &#123;</span><br><span class=\"line\">buffer = (T[])<span class=\"keyword\">new</span> <span class=\"title class_\">Object</span>[bufferSize];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * 队列添加元素，如果队列满了，则等待到队列空余</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@param</span> t</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@throws</span> InterruptedException</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">push</span><span class=\"params\">(T t)</span> <span class=\"keyword\">throws</span> InterruptedException &#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>)&#123;</span><br><span class=\"line\">    <span class=\"comment\">//判断是否可写 总长度-（写位置-读位置）</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(buffer.length-(writerIndex-readIndex)&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> nextWriterIndex=writerIndex+<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"type\">boolean</span> result=unsafe.compareAndSwapInt(<span class=\"built_in\">this</span>,writerIndexOffset,writerIndex,nextWriterIndex);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(result)&#123;</span><br><span class=\"line\">    <span class=\"comment\">//计算实际位置</span></span><br><span class=\"line\">    <span class=\"type\">int</span> bufferIndex=writerIndex%buffer.length;</span><br><span class=\"line\">    buffer[bufferIndex]=t;</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 休眠1ms</span></span><br><span class=\"line\">    TimeUnit.MILLISECONDS.sleep(<span class=\"number\">1L</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * 队列取出元素，如果没有可读元素，则等待到有可读元素</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@throws</span> InterruptedException</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> T <span class=\"title function_\">pop</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException &#123;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>)&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 判断是否可读</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(writerIndex-readIndex&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> nextReadIndex=readIndex+<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"type\">boolean</span> result=unsafe.compareAndSwapInt(<span class=\"built_in\">this</span>,readIndexOffset,readIndex,nextReadIndex);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(result)&#123;</span><br><span class=\"line\">    <span class=\"comment\">//计算实际位置</span></span><br><span class=\"line\">    <span class=\"type\">int</span> bufferIndex=readIndex%buffer.length;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> buffer[bufferIndex];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 休眠1ms</span></span><br><span class=\"line\">    TimeUnit.MILLISECONDS.sleep(<span class=\"number\">1L</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试代码\"><a href=\"#测试代码\" class=\"headerlink\" title=\"测试代码\"></a>测试代码</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> wiki.chenxun.study.buffer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Random;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@author</span> chenxun</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@date</span> 2019-11-19</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span></span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">RingBufferTest</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">RingBuffer&lt;String&gt; ringBuffer=<span class=\"keyword\">new</span> <span class=\"title class_\">RingBuffer</span>&lt;&gt;(<span class=\"number\">20</span>);</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"type\">int</span> a=<span class=\"number\">1</span>;a&lt;<span class=\"number\">4</span>;a++)&#123;</span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">int</span> b=a;</span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(()-&gt;&#123;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"type\">int</span> i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">10</span>;i++)&#123;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">ringBuffer.push(String.valueOf(b*<span class=\"number\">10</span>+i));</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">e.printStackTrace();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">Random r=<span class=\"keyword\">new</span> <span class=\"title class_\">Random</span>();</span><br><span class=\"line\">TimeUnit.MILLISECONDS.sleep(r.nextInt(<span class=\"number\">5</span>));</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">e.printStackTrace();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;).start();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"type\">int</span> a=<span class=\"number\">0</span>;a&lt;<span class=\"number\">2</span>;a++)&#123;</span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Thread</span>(()-&gt;&#123;</span><br><span class=\"line\"><span class=\"keyword\">while</span> (<span class=\"literal\">true</span>)&#123;</span><br><span class=\"line\">String s= <span class=\"literal\">null</span>;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">s = ringBuffer.pop();</span><br><span class=\"line\">System.out.println(s);</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">e.printStackTrace();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;).start();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">System.in.read();</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">e.printStackTrace();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"buffer下标计算优化\"><a href=\"#buffer下标计算优化\" class=\"headerlink\" title=\"buffer下标计算优化\"></a>buffer下标计算优化</h2><p>如果buffer的size是2的n次方，那么取模运算可以替换成位运算.代码参考如下</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> wiki.chenxun.study.buffer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@author</span> chenxun</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@date</span> 2019-11-19</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@since</span></span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">NumberUtils</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">moduloOperationOn2</span><span class=\"params\">(<span class=\"type\">int</span> a, <span class=\"type\">int</span> b)</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">return</span> a &amp; b - <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\"><span class=\"type\">int</span> a=<span class=\"number\">100</span>%<span class=\"number\">8</span>;</span><br><span class=\"line\"><span class=\"type\">int</span> b=moduloOperationOn2(<span class=\"number\">100</span>,<span class=\"number\">8</span>);</span><br><span class=\"line\">System.out.println(a==b);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"缓存伪共享优化\"><a href=\"#缓存伪共享优化\" class=\"headerlink\" title=\"缓存伪共享优化\"></a>缓存伪共享优化</h2><p>cpu加载数据是基于缓存行（具体原理不展开了），java8支持通过@sun.misc.Contended来解决这个问题，<br>非java8版本可以参考Disruptor的做法 <a href=\"https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/RingBuffer.java\">https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/RingBuffer.java</a></p>\n<h2 id=\"读写序号java溢出问题\"><a href=\"#读写序号java溢出问题\" class=\"headerlink\" title=\"读写序号java溢出问题\"></a>读写序号java溢出问题</h2><p>暂时没有想到好方案，目前大致思路是，设置一个阀值算法，满足阀值则重置大小，类似java集合扩容一样，但这个会导致读写锁住。</p>\n<h2 id=\"RingBuffer应用场景\"><a href=\"#RingBuffer应用场景\" class=\"headerlink\" title=\"RingBuffer应用场景\"></a>RingBuffer应用场景</h2><ul>\n<li>依赖一个优惠券的查询接口，假设该接口提供分页查询能力。单次最多返回100张优惠优惠券，单次rt是20ms</li>\n<li>优惠券的扩展信息是另一个接口，该接口性能提供批量查询能力，单次做多支持30张优惠券，单词rt是30ms</li>\n<li>假设某个用户有500张优惠券</li>\n</ul>\n<p>如果是串行调用，则整体时间是 (500&#x2F;100)20+(500&#x2F;30)30.采用ringBuffer解耦两个接口依赖，则优化后的rt时间，<br>理论上可以缩减至30ms左右（排除cpu切换上下文损耗等）</p>\n"},{"title":"solrcloud搭建","abbrlink":30297,"date":"2023-06-19T07:38:32.000Z","_content":"# solrcloud搭建\n群里小伙伴需要一个solrcloud的解决案例。正好好久没碰过solr了。决定写个demo，顺便重新熟悉下solr。\n\n1. solr版本：5.0\n2. solr链接：http://archive.apache.org/dist/lucene/solr/5.0.0/\n3. jdk版本：1.70+\n4. windows环境安装：\n> cd D:\\app\\solr-5.0.0\\bin  \nsolr.cmd -c -z localhost:2181 -p 8983  \ncd D:\\app\\solr-5.0.0-01\\bin  \nsolr.cmd -c -z localhost:2181 -p 8984  \ncd D:\\app\\solr-5.0.0-02\\bin  \nsolr.cmd -c -z localhost:2181 -p 8985  \n  \n5. 注意端口号不要冲突-z 表示zookeeper连接配置 ，zookeeper服务要先启动。\n   服务全部启动好，之后校验下是否成功。\n> http://localhost:8983/solr/#/~cloud?view=tree\n\n6. 创建conlection\n> cd D:\\app\\solr-5.0.0\\bin  \nsolr.cmd create_collection -c example -d ../example/example-DIH/solr/solr/conf/ -shards 3 -replicationFactor 2  \n\n7. 参数说明：\n  - -c : collection名称\n  - -d : 配置文件的路径，可以使用上面提供的实例配置\n  - -n : 配置名称可以和collection名称不同，默认这个参数不填的话，会使用collection名称作为config名称\n  - -shards : 创建的shard个数，建议和集群节点数量一致。\n  - -replicationFactor : 每个shard的副本数，综合考虑为了保证集群的稳定性，建议配置为 最少2个，最多集群节点数量/shard数量 * 2\n校验结果：http://localhost:8983/solr/#/~cloud\n服务端配置暂时告一段落，之后补上中文分词。\n8. 客户端配置：\n使用spring-boot-starter-solr来简化集成。核心是spring-data-solr\n\n{% codeblock pom.xml lang:xml   %}\n\n    <parent>  \n    <groupId>org.springframework.boot</groupId>  \n    <artifactId>spring-boot-starter-parent</artifactId>  \n    <version>1.4.0.RELEASE</version>  \n    <relativePath/> <!-- lookup parent from repository -->  \n    </parent>\n\n    <properties>  \n    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>  \n    <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>  \n    <java.version>1.7</java.version>  \n    </properties>  \n\n    <dependencies>  \n    <dependency>  \n        <groupId>org.springframework.boot</groupId>  \n        <artifactId>spring-boot-starter-data-solr</artifactId>  \n    </dependency>  \n    <dependency>  \n        <groupId>org.projectlombok</groupId>  \n        <artifactId>lombok</artifactId>  \n    </dependency>  \n    <dependency>  \n        <groupId>org.springframework.boot</groupId>  \n        <artifactId>spring-boot-starter-web</artifactId>  \n    </dependency>  \n\n    <dependency>  \n        <groupId>org.springframework.boot</groupId>  \n        <artifactId>spring-boot-starter-test</artifactId>  \n        <scope>test</scope>  \n    </dependency>  \n    </dependencies>  \n\n    <build>  \n    <plugins>  \n        <plugin>  \n            <groupId>org.springframework.boot</groupId>  \n            <artifactId>spring-boot-maven-plugin</artifactId>  \n        </plugin>  \n    </plugins>  \n    </build>\n\n{% endcodeblock %}\n\n9. 剩下就是javaconfig了\n\n\n{% codeblock  lang:java   %}\n\n    /**\n    * Project Name:chenxun-solr\n    * File Name:SolrConfig.java\n    * Package Name:com.chenxun.solr.config\n    * Date:2016年8月20日下午3:11:32\n    * Copyright (c) 2016, www midaigroup com Technology Co., Ltd. All Rights Reserved.\n    * \n    */\n\n    package com.chenxun.solr.config;\n    \n    import org.apache.solr.client.solrj.SolrClient;  \n    import org.apache.solr.client.solrj.impl.CloudSolrClient;  \n    import org.springframework.beans.factory.annotation.Value;  \n    import org.springframework.context.annotation.Bean;  \n    import org.springframework.context.annotation.Configuration;  \n    import org.springframework.data.solr.core.SolrTemplate;  \n    import org.springframework.data.solr.core.convert.CustomConversions;  \n    import org.springframework.data.solr.core.convert.MappingSolrConverter;  \n    import org.springframework.data.solr.core.convert.SolrConverter;  \n    import org.springframework.data.solr.core.mapping.SimpleSolrMappingContext;  \n    import org.springframework.data.solr.repository.config.EnableSolrRepositories;\n\n    /**\n      * ClassName:SolrConfig <br/>\n      * Function: TODO ADD FUNCTION. <br/>\n      * Reason: TODO ADD REASON. <br/>\n      * Date: 2016年8月20日 下午3:11:32 <br/>\n      * \n      * @author 陈勋\n      * @version\n      * @since JDK 1.7\n      * @see\n     */  \n    @Configuration  \n    @EnableSolrRepositories(basePackages = { \"com.chenxun.solr\" }, multicoreSupport = true)  \n    public class SolrConfig {\n\n    @Value(\"${spring.data.solr.zk-host}\")  \n    private String zkHost;\n\n    @Bean  \n    public SolrClient solrClient() {  \n    return new CloudSolrClient(zkHost);  \n    }\n\n    @Bean  \n    public SolrTemplate solrTemplate(SolrClient solrClient,SolrConverter solrConverter) throws Exception {  \n    SolrTemplate solrTemplate =  new SolrTemplate(solrClient);  \n    solrTemplate.setSolrConverter(solrConverter);  \n    return solrTemplate;  \n    }\n\n    @Bean  \n    public SolrConverter solrConverter(SimpleSolrMappingContext simpleSolrMappingContext,CustomConversions customConversions){  \n    MappingSolrConverter solrConverter=new MappingSolrConverter(simpleSolrMappingContext);  \n    solrConverter.setCustomConversions(customConversions);        \n    return solrConverter;\n\n    }\n\n    @Bean  \n    public SimpleSolrMappingContext simpleSolrMappingContext(){  \n    SimpleSolrMappingContext simpleSolrMappingContext=new SimpleSolrMappingContext();  \n    return simpleSolrMappingContext;  \n    }\n\n    @Bean  \n    public CustomConversions customConversions(){  \n    CustomConversions customConversions=new CustomConversions();  \n    //  customConversions.registerConvertersIn(new GenericConversionService(){});  \n    return customConversions;  \n    }  \n    }\n\n{% endcodeblock %}\n10. 实体\n\n\n {% codeblock  lang:java   %}\n\n    /**\n     * Project Name:chenxun-solr\n      * File Name:Product.java\n     * Package Name:com.chenxun.solr.model\n     * Date:2016年8月20日下午4:48:36\n     * Copyright (c) 2016, www midaigroup com Technology Co., Ltd. All Rights Reserved.\n     * \n    */\n    package com.chenxun.solr.model;\n\n    import java.util.HashMap;  \n    import java.util.List;  \n    import java.util.Map;\n\n    import lombok.Data;\n\n    import org.apache.solr.client.solrj.beans.Field;  \n    import org.springframework.data.annotation.Id;  \n    import org.springframework.data.solr.core.mapping.Dynamic;  \n    import org.springframework.data.solr.core.mapping.Indexed;  \n    import org.springframework.data.solr.core.mapping.SolrDocument;  \n    import org.springframework.stereotype.Component;\n\n    /**\n     * ClassName:Product <br/>\n    * Function: TODO ADD FUNCTION. <br/>\n    * Reason:   TODO ADD REASON. <br/>\n    * Date:     2016年8月20日 下午4:48:36 <br/>\n    * @author   陈勋\n    * @version\n    * @since    JDK 1.7\n    * @see       \n      */  \n      @SolrDocument(solrCoreName=\"example\") // Solr collection name  \n      @Data  \n      public class Product {\n\n      @Field(\"id\")                  // Specify field name in solr  \n      @Id    \n      private String id;\n\n      @Field  \n      private float price;\n\n      @Field  \n      private String name;\n\n      @Field(\"*_s\")  \n      @Dynamic  \n      private Map<String,String> map =new HashMap<String, String>();       \n      }\n\n{% endcodeblock %}\n\n\n{% codeblock    lang:java   %}\n    \n    /** \n    Project Name:chenxun-solr\n    * File Name:ProductRepository.java\n    * Package Name:com.chenxun.solr.repository\n    * Date:2016年8月20日下午4:54:24\n    * Copyright (c) 2016, www midaigroup com Technology Co., Ltd. All Rights Reserved.\n    * \n    */\n\n    package com.chenxun.solr.repository;\n\n    import org.springframework.data.solr.repository.SolrCrudRepository;\n\n    import com.chenxun.solr.model.Product;\n\n    /**\n     * ClassName:ProductRepository <br/>\n    * Function: TODO ADD FUNCTION. <br/>\n    * Reason:   TODO ADD REASON. <br/>\n    * Date:     2016年8月20日 下午4:54:24 <br/>\n    * @author   陈勋\n    * @version\n    * @since    JDK 1.7\n    * @see       \n    */  \n    public interface ProductRepository  extends SolrCrudRepository<Product, String>{       \n    Iterable<Product>  findByName(String name);\n\n}\n\n{% endcodeblock %}\n\n{% codeblock spring.properties   lang:xml   %}\n\n    spring.data.solr.zk-host=localhost:2181\n\n{% endcodeblock %}\n\n{% codeblock  test.java  lang:java   %}\n\n\n    package com.chenxun;\n\n    import java.util.ArrayList;  \n    import java.util.HashMap;  \n    import java.util.Iterator;  \n    import java.util.List;  \n    import java.util.Map;\n\n    import org.junit.Assert;  \n    import org.junit.Test;  \n    import org.junit.runner.RunWith;  \n    import org.springframework.beans.factory.annotation.Autowired;  \n    import org.springframework.boot.test.context.SpringBootTest;  \n    import org.springframework.test.context.junit4.SpringRunner;\n\n    import com.chenxun.solr.model.Product;  \n    import com.chenxun.solr.repository.ProductRepository;\n\n    @RunWith(SpringRunner.class)  \n    @SpringBootTest  \n    public class ChenxunSolrApplicationTests {\n\n    @Autowired  \n    private ProductRepository productRepository;  \n  \n    @Test  \n    public void contextLoads() {  \n        productRepository.deleteAll();  \n        long count=productRepository.count();  \n        Assert.assertTrue(\"empty count\", count==0);  \n        Product product=new Product();  \n        product.setId(\"product-001\");  \n        product.setName(\"xxx\");  \n        Map<String,String> map=new HashMap<>();  \n        map.put(\"key01\", \"abc\");  \n        map.put(\"key02\", \"123\");  \n        product.setMap(map);      \n        productRepository.save(product);  \n          \n        Product product1=new Product();  \n        product1.setId(\"product-002\");    \n        product1.setName(\"yyy\");  \n        Map<String,String> map1=new HashMap<>();  \n        map1.put(\"key01\", \"abc1\");  \n        map1.put(\"key02\", \"1234\");  \n        product1.setMap(map1);        \n        productRepository.save(product1);  \n          \n        count=productRepository.count();  \n        Assert.assertTrue(count==2);  \n          \n          \n        Iterator<Product> it=productRepository.findByName(\"yyy\").iterator();  \n        while(it.hasNext()){  \n            Assert.assertTrue( it.next().getId().equals(\"product-002\"));  \n        }  \n          \n          \n          \n    }  \n\n}\n\n\n\n{% endcodeblock %}\n\n\n到此大功告成，下一篇补上中文分词就OK了。\n代码地址： https://github.com/ChenXun1989/chenxun-solr","source":"_posts/solrcloud搭建.md","raw":"---\ntitle: solrcloud搭建\ntags:\n  - solr\nabbrlink: 30297\ndate: 2023-06-19 15:38:32\n---\n# solrcloud搭建\n群里小伙伴需要一个solrcloud的解决案例。正好好久没碰过solr了。决定写个demo，顺便重新熟悉下solr。\n\n1. solr版本：5.0\n2. solr链接：http://archive.apache.org/dist/lucene/solr/5.0.0/\n3. jdk版本：1.70+\n4. windows环境安装：\n> cd D:\\app\\solr-5.0.0\\bin  \nsolr.cmd -c -z localhost:2181 -p 8983  \ncd D:\\app\\solr-5.0.0-01\\bin  \nsolr.cmd -c -z localhost:2181 -p 8984  \ncd D:\\app\\solr-5.0.0-02\\bin  \nsolr.cmd -c -z localhost:2181 -p 8985  \n  \n5. 注意端口号不要冲突-z 表示zookeeper连接配置 ，zookeeper服务要先启动。\n   服务全部启动好，之后校验下是否成功。\n> http://localhost:8983/solr/#/~cloud?view=tree\n\n6. 创建conlection\n> cd D:\\app\\solr-5.0.0\\bin  \nsolr.cmd create_collection -c example -d ../example/example-DIH/solr/solr/conf/ -shards 3 -replicationFactor 2  \n\n7. 参数说明：\n  - -c : collection名称\n  - -d : 配置文件的路径，可以使用上面提供的实例配置\n  - -n : 配置名称可以和collection名称不同，默认这个参数不填的话，会使用collection名称作为config名称\n  - -shards : 创建的shard个数，建议和集群节点数量一致。\n  - -replicationFactor : 每个shard的副本数，综合考虑为了保证集群的稳定性，建议配置为 最少2个，最多集群节点数量/shard数量 * 2\n校验结果：http://localhost:8983/solr/#/~cloud\n服务端配置暂时告一段落，之后补上中文分词。\n8. 客户端配置：\n使用spring-boot-starter-solr来简化集成。核心是spring-data-solr\n\n{% codeblock pom.xml lang:xml   %}\n\n    <parent>  \n    <groupId>org.springframework.boot</groupId>  \n    <artifactId>spring-boot-starter-parent</artifactId>  \n    <version>1.4.0.RELEASE</version>  \n    <relativePath/> <!-- lookup parent from repository -->  \n    </parent>\n\n    <properties>  \n    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>  \n    <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>  \n    <java.version>1.7</java.version>  \n    </properties>  \n\n    <dependencies>  \n    <dependency>  \n        <groupId>org.springframework.boot</groupId>  \n        <artifactId>spring-boot-starter-data-solr</artifactId>  \n    </dependency>  \n    <dependency>  \n        <groupId>org.projectlombok</groupId>  \n        <artifactId>lombok</artifactId>  \n    </dependency>  \n    <dependency>  \n        <groupId>org.springframework.boot</groupId>  \n        <artifactId>spring-boot-starter-web</artifactId>  \n    </dependency>  \n\n    <dependency>  \n        <groupId>org.springframework.boot</groupId>  \n        <artifactId>spring-boot-starter-test</artifactId>  \n        <scope>test</scope>  \n    </dependency>  \n    </dependencies>  \n\n    <build>  \n    <plugins>  \n        <plugin>  \n            <groupId>org.springframework.boot</groupId>  \n            <artifactId>spring-boot-maven-plugin</artifactId>  \n        </plugin>  \n    </plugins>  \n    </build>\n\n{% endcodeblock %}\n\n9. 剩下就是javaconfig了\n\n\n{% codeblock  lang:java   %}\n\n    /**\n    * Project Name:chenxun-solr\n    * File Name:SolrConfig.java\n    * Package Name:com.chenxun.solr.config\n    * Date:2016年8月20日下午3:11:32\n    * Copyright (c) 2016, www midaigroup com Technology Co., Ltd. All Rights Reserved.\n    * \n    */\n\n    package com.chenxun.solr.config;\n    \n    import org.apache.solr.client.solrj.SolrClient;  \n    import org.apache.solr.client.solrj.impl.CloudSolrClient;  \n    import org.springframework.beans.factory.annotation.Value;  \n    import org.springframework.context.annotation.Bean;  \n    import org.springframework.context.annotation.Configuration;  \n    import org.springframework.data.solr.core.SolrTemplate;  \n    import org.springframework.data.solr.core.convert.CustomConversions;  \n    import org.springframework.data.solr.core.convert.MappingSolrConverter;  \n    import org.springframework.data.solr.core.convert.SolrConverter;  \n    import org.springframework.data.solr.core.mapping.SimpleSolrMappingContext;  \n    import org.springframework.data.solr.repository.config.EnableSolrRepositories;\n\n    /**\n      * ClassName:SolrConfig <br/>\n      * Function: TODO ADD FUNCTION. <br/>\n      * Reason: TODO ADD REASON. <br/>\n      * Date: 2016年8月20日 下午3:11:32 <br/>\n      * \n      * @author 陈勋\n      * @version\n      * @since JDK 1.7\n      * @see\n     */  \n    @Configuration  \n    @EnableSolrRepositories(basePackages = { \"com.chenxun.solr\" }, multicoreSupport = true)  \n    public class SolrConfig {\n\n    @Value(\"${spring.data.solr.zk-host}\")  \n    private String zkHost;\n\n    @Bean  \n    public SolrClient solrClient() {  \n    return new CloudSolrClient(zkHost);  \n    }\n\n    @Bean  \n    public SolrTemplate solrTemplate(SolrClient solrClient,SolrConverter solrConverter) throws Exception {  \n    SolrTemplate solrTemplate =  new SolrTemplate(solrClient);  \n    solrTemplate.setSolrConverter(solrConverter);  \n    return solrTemplate;  \n    }\n\n    @Bean  \n    public SolrConverter solrConverter(SimpleSolrMappingContext simpleSolrMappingContext,CustomConversions customConversions){  \n    MappingSolrConverter solrConverter=new MappingSolrConverter(simpleSolrMappingContext);  \n    solrConverter.setCustomConversions(customConversions);        \n    return solrConverter;\n\n    }\n\n    @Bean  \n    public SimpleSolrMappingContext simpleSolrMappingContext(){  \n    SimpleSolrMappingContext simpleSolrMappingContext=new SimpleSolrMappingContext();  \n    return simpleSolrMappingContext;  \n    }\n\n    @Bean  \n    public CustomConversions customConversions(){  \n    CustomConversions customConversions=new CustomConversions();  \n    //  customConversions.registerConvertersIn(new GenericConversionService(){});  \n    return customConversions;  \n    }  \n    }\n\n{% endcodeblock %}\n10. 实体\n\n\n {% codeblock  lang:java   %}\n\n    /**\n     * Project Name:chenxun-solr\n      * File Name:Product.java\n     * Package Name:com.chenxun.solr.model\n     * Date:2016年8月20日下午4:48:36\n     * Copyright (c) 2016, www midaigroup com Technology Co., Ltd. All Rights Reserved.\n     * \n    */\n    package com.chenxun.solr.model;\n\n    import java.util.HashMap;  \n    import java.util.List;  \n    import java.util.Map;\n\n    import lombok.Data;\n\n    import org.apache.solr.client.solrj.beans.Field;  \n    import org.springframework.data.annotation.Id;  \n    import org.springframework.data.solr.core.mapping.Dynamic;  \n    import org.springframework.data.solr.core.mapping.Indexed;  \n    import org.springframework.data.solr.core.mapping.SolrDocument;  \n    import org.springframework.stereotype.Component;\n\n    /**\n     * ClassName:Product <br/>\n    * Function: TODO ADD FUNCTION. <br/>\n    * Reason:   TODO ADD REASON. <br/>\n    * Date:     2016年8月20日 下午4:48:36 <br/>\n    * @author   陈勋\n    * @version\n    * @since    JDK 1.7\n    * @see       \n      */  \n      @SolrDocument(solrCoreName=\"example\") // Solr collection name  \n      @Data  \n      public class Product {\n\n      @Field(\"id\")                  // Specify field name in solr  \n      @Id    \n      private String id;\n\n      @Field  \n      private float price;\n\n      @Field  \n      private String name;\n\n      @Field(\"*_s\")  \n      @Dynamic  \n      private Map<String,String> map =new HashMap<String, String>();       \n      }\n\n{% endcodeblock %}\n\n\n{% codeblock    lang:java   %}\n    \n    /** \n    Project Name:chenxun-solr\n    * File Name:ProductRepository.java\n    * Package Name:com.chenxun.solr.repository\n    * Date:2016年8月20日下午4:54:24\n    * Copyright (c) 2016, www midaigroup com Technology Co., Ltd. All Rights Reserved.\n    * \n    */\n\n    package com.chenxun.solr.repository;\n\n    import org.springframework.data.solr.repository.SolrCrudRepository;\n\n    import com.chenxun.solr.model.Product;\n\n    /**\n     * ClassName:ProductRepository <br/>\n    * Function: TODO ADD FUNCTION. <br/>\n    * Reason:   TODO ADD REASON. <br/>\n    * Date:     2016年8月20日 下午4:54:24 <br/>\n    * @author   陈勋\n    * @version\n    * @since    JDK 1.7\n    * @see       \n    */  \n    public interface ProductRepository  extends SolrCrudRepository<Product, String>{       \n    Iterable<Product>  findByName(String name);\n\n}\n\n{% endcodeblock %}\n\n{% codeblock spring.properties   lang:xml   %}\n\n    spring.data.solr.zk-host=localhost:2181\n\n{% endcodeblock %}\n\n{% codeblock  test.java  lang:java   %}\n\n\n    package com.chenxun;\n\n    import java.util.ArrayList;  \n    import java.util.HashMap;  \n    import java.util.Iterator;  \n    import java.util.List;  \n    import java.util.Map;\n\n    import org.junit.Assert;  \n    import org.junit.Test;  \n    import org.junit.runner.RunWith;  \n    import org.springframework.beans.factory.annotation.Autowired;  \n    import org.springframework.boot.test.context.SpringBootTest;  \n    import org.springframework.test.context.junit4.SpringRunner;\n\n    import com.chenxun.solr.model.Product;  \n    import com.chenxun.solr.repository.ProductRepository;\n\n    @RunWith(SpringRunner.class)  \n    @SpringBootTest  \n    public class ChenxunSolrApplicationTests {\n\n    @Autowired  \n    private ProductRepository productRepository;  \n  \n    @Test  \n    public void contextLoads() {  \n        productRepository.deleteAll();  \n        long count=productRepository.count();  \n        Assert.assertTrue(\"empty count\", count==0);  \n        Product product=new Product();  \n        product.setId(\"product-001\");  \n        product.setName(\"xxx\");  \n        Map<String,String> map=new HashMap<>();  \n        map.put(\"key01\", \"abc\");  \n        map.put(\"key02\", \"123\");  \n        product.setMap(map);      \n        productRepository.save(product);  \n          \n        Product product1=new Product();  \n        product1.setId(\"product-002\");    \n        product1.setName(\"yyy\");  \n        Map<String,String> map1=new HashMap<>();  \n        map1.put(\"key01\", \"abc1\");  \n        map1.put(\"key02\", \"1234\");  \n        product1.setMap(map1);        \n        productRepository.save(product1);  \n          \n        count=productRepository.count();  \n        Assert.assertTrue(count==2);  \n          \n          \n        Iterator<Product> it=productRepository.findByName(\"yyy\").iterator();  \n        while(it.hasNext()){  \n            Assert.assertTrue( it.next().getId().equals(\"product-002\"));  \n        }  \n          \n          \n          \n    }  \n\n}\n\n\n\n{% endcodeblock %}\n\n\n到此大功告成，下一篇补上中文分词就OK了。\n代码地址： https://github.com/ChenXun1989/chenxun-solr","slug":"solrcloud搭建","published":1,"updated":"2023-12-05T02:48:12.737Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdj80017orgoc386fn0j","content":"<h1 id=\"solrcloud搭建\"><a href=\"#solrcloud搭建\" class=\"headerlink\" title=\"solrcloud搭建\"></a>solrcloud搭建</h1><p>群里小伙伴需要一个solrcloud的解决案例。正好好久没碰过solr了。决定写个demo，顺便重新熟悉下solr。</p>\n<ol>\n<li><p>solr版本：5.0</p>\n</li>\n<li><p>solr链接：<a href=\"http://archive.apache.org/dist/lucene/solr/5.0.0/\">http://archive.apache.org/dist/lucene/solr/5.0.0/</a></p>\n</li>\n<li><p>jdk版本：1.70+</p>\n</li>\n<li><p>windows环境安装：</p>\n<blockquote>\n<p>cd D:\\app\\solr-5.0.0\\bin<br>solr.cmd -c -z localhost:2181 -p 8983<br>cd D:\\app\\solr-5.0.0-01\\bin<br>solr.cmd -c -z localhost:2181 -p 8984<br>cd D:\\app\\solr-5.0.0-02\\bin<br>solr.cmd -c -z localhost:2181 -p 8985  </p>\n</blockquote>\n</li>\n<li><p>注意端口号不要冲突-z 表示zookeeper连接配置 ，zookeeper服务要先启动。<br>服务全部启动好，之后校验下是否成功。</p>\n<blockquote>\n<p><a href=\"http://localhost:8983/solr/#/~cloud?view=tree\">http://localhost:8983/solr/#/~cloud?view=tree</a></p>\n</blockquote>\n</li>\n<li><p>创建conlection</p>\n<blockquote>\n<p>cd D:\\app\\solr-5.0.0\\bin<br>solr.cmd create_collection -c example -d ..&#x2F;example&#x2F;example-DIH&#x2F;solr&#x2F;solr&#x2F;conf&#x2F; -shards 3 -replicationFactor 2  </p>\n</blockquote>\n</li>\n<li><p>参数说明：</p>\n</li>\n</ol>\n<ul>\n<li>-c : collection名称</li>\n<li>-d : 配置文件的路径，可以使用上面提供的实例配置</li>\n<li>-n : 配置名称可以和collection名称不同，默认这个参数不填的话，会使用collection名称作为config名称</li>\n<li>-shards : 创建的shard个数，建议和集群节点数量一致。</li>\n<li>-replicationFactor : 每个shard的副本数，综合考虑为了保证集群的稳定性，建议配置为 最少2个，最多集群节点数量&#x2F;shard数量 * 2<br>校验结果：<a href=\"http://localhost:8983/solr/#/~cloud\">http://localhost:8983/solr/#/~cloud</a><br>服务端配置暂时告一段落，之后补上中文分词。</li>\n</ul>\n<ol start=\"8\">\n<li>客户端配置：<br>使用spring-boot-starter-solr来简化集成。核心是spring-data-solr</li>\n</ol>\n<figure class=\"highlight xml\"><figcaption><span>pom.xml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">parent</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-parent<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.4.0.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">relativePath</span>/&gt;</span> <span class=\"comment\">&lt;!-- lookup parent from repository --&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">parent</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">properties</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class=\"tag\">&lt;/<span class=\"name\">project.build.sourceEncoding</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class=\"tag\">&lt;/<span class=\"name\">project.reporting.outputEncoding</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">java.version</span>&gt;</span>1.7<span class=\"tag\">&lt;/<span class=\"name\">java.version</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">properties</span>&gt;</span>  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-data-solr<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.projectlombok<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>lombok<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-web<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-test<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>test<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span>  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">build</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">plugins</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span>  </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span>  </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">plugins</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ol start=\"9\">\n<li>剩下就是javaconfig了</li>\n</ol>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* Project Name:chenxun-solr</span></span><br><span class=\"line\"><span class=\"comment\">* File Name:SolrConfig.java</span></span><br><span class=\"line\"><span class=\"comment\">* Package Name:com.chenxun.solr.config</span></span><br><span class=\"line\"><span class=\"comment\">* Date:2016年8月20日下午3:11:32</span></span><br><span class=\"line\"><span class=\"comment\">* Copyright (c) 2016, www midaigroup com Technology Co., Ltd. All Rights Reserved.</span></span><br><span class=\"line\"><span class=\"comment\">* </span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.chenxun.solr.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.solr.client.solrj.SolrClient;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.solr.client.solrj.impl.CloudSolrClient;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Value;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.SolrTemplate;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.convert.CustomConversions;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.convert.MappingSolrConverter;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.convert.SolrConverter;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.mapping.SimpleSolrMappingContext;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.repository.config.EnableSolrRepositories;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * ClassName:SolrConfig &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  * Function: TODO ADD FUNCTION. &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  * Reason: TODO ADD REASON. &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  * Date: 2016年8月20日 下午3:11:32 &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  * </span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@author</span> 陈勋</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@version</span></span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@since</span> JDK 1.7</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@see</span></span></span><br><span class=\"line\"><span class=\"comment\"> */</span>  </span><br><span class=\"line\"><span class=\"meta\">@Configuration</span>  </span><br><span class=\"line\"><span class=\"meta\">@EnableSolrRepositories(basePackages = &#123; &quot;com.chenxun.solr&quot; &#125;, multicoreSupport = true)</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SolrConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Value(&quot;$&#123;spring.data.solr.zk-host&#125;&quot;)</span>  </span><br><span class=\"line\"><span class=\"keyword\">private</span> String zkHost;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Bean</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> SolrClient <span class=\"title function_\">solrClient</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">CloudSolrClient</span>(zkHost);  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Bean</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> SolrTemplate <span class=\"title function_\">solrTemplate</span><span class=\"params\">(SolrClient solrClient,SolrConverter solrConverter)</span> <span class=\"keyword\">throws</span> Exception &#123;  </span><br><span class=\"line\"><span class=\"type\">SolrTemplate</span> <span class=\"variable\">solrTemplate</span> <span class=\"operator\">=</span>  <span class=\"keyword\">new</span> <span class=\"title class_\">SolrTemplate</span>(solrClient);  </span><br><span class=\"line\">solrTemplate.setSolrConverter(solrConverter);  </span><br><span class=\"line\"><span class=\"keyword\">return</span> solrTemplate;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Bean</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> SolrConverter <span class=\"title function_\">solrConverter</span><span class=\"params\">(SimpleSolrMappingContext simpleSolrMappingContext,CustomConversions customConversions)</span>&#123;  </span><br><span class=\"line\">MappingSolrConverter solrConverter=<span class=\"keyword\">new</span> <span class=\"title class_\">MappingSolrConverter</span>(simpleSolrMappingContext);  </span><br><span class=\"line\">solrConverter.setCustomConversions(customConversions);        </span><br><span class=\"line\"><span class=\"keyword\">return</span> solrConverter;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Bean</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> SimpleSolrMappingContext <span class=\"title function_\">simpleSolrMappingContext</span><span class=\"params\">()</span>&#123;  </span><br><span class=\"line\">SimpleSolrMappingContext simpleSolrMappingContext=<span class=\"keyword\">new</span> <span class=\"title class_\">SimpleSolrMappingContext</span>();  </span><br><span class=\"line\"><span class=\"keyword\">return</span> simpleSolrMappingContext;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Bean</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> CustomConversions <span class=\"title function_\">customConversions</span><span class=\"params\">()</span>&#123;  </span><br><span class=\"line\">CustomConversions customConversions=<span class=\"keyword\">new</span> <span class=\"title class_\">CustomConversions</span>();  </span><br><span class=\"line\"><span class=\"comment\">//  customConversions.registerConvertersIn(new GenericConversionService()&#123;&#125;);  </span></span><br><span class=\"line\"><span class=\"keyword\">return</span> customConversions;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ol start=\"10\">\n<li>实体</li>\n</ol>\n <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Project Name:chenxun-solr</span></span><br><span class=\"line\"><span class=\"comment\">  * File Name:Product.java</span></span><br><span class=\"line\"><span class=\"comment\"> * Package Name:com.chenxun.solr.model</span></span><br><span class=\"line\"><span class=\"comment\"> * Date:2016年8月20日下午4:48:36</span></span><br><span class=\"line\"><span class=\"comment\"> * Copyright (c) 2016, www midaigroup com Technology Co., Ltd. All Rights Reserved.</span></span><br><span class=\"line\"><span class=\"comment\"> * </span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.chenxun.solr.model;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.Data;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.solr.client.solrj.beans.Field;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.annotation.Id;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.mapping.Dynamic;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.mapping.Indexed;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.mapping.SolrDocument;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * ClassName:Product &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">* Function: TODO ADD FUNCTION. &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">* Reason:   TODO ADD REASON. &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">* Date:     2016年8月20日 下午4:48:36 &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@author</span>   陈勋</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@version</span></span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@since</span>    JDK 1.7</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@see</span>       </span></span><br><span class=\"line\"><span class=\"comment\">  */</span>  </span><br><span class=\"line\">  <span class=\"meta\">@SolrDocument(solrCoreName=&quot;example&quot;)</span> <span class=\"comment\">// Solr collection name  </span></span><br><span class=\"line\">  <span class=\"meta\">@Data</span>  </span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Product</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Field(&quot;id&quot;)</span>                  <span class=\"comment\">// Specify field name in solr  </span></span><br><span class=\"line\">  <span class=\"meta\">@Id</span>    </span><br><span class=\"line\">  <span class=\"keyword\">private</span> String id;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Field</span>  </span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"type\">float</span> price;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Field</span>  </span><br><span class=\"line\">  <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Field(&quot;*_s&quot;)</span>  </span><br><span class=\"line\">  <span class=\"meta\">@Dynamic</span>  </span><br><span class=\"line\">  <span class=\"keyword\">private</span> Map&lt;String,String&gt; map =<span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;String, String&gt;();       </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\">    Project Name:chenxun-solr</span></span><br><span class=\"line\"><span class=\"comment\">    * File Name:ProductRepository.java</span></span><br><span class=\"line\"><span class=\"comment\">    * Package Name:com.chenxun.solr.repository</span></span><br><span class=\"line\"><span class=\"comment\">    * Date:2016年8月20日下午4:54:24</span></span><br><span class=\"line\"><span class=\"comment\">    * Copyright (c) 2016, www midaigroup com Technology Co., Ltd. All Rights Reserved.</span></span><br><span class=\"line\"><span class=\"comment\">    * </span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">package</span> com.chenxun.solr.repository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.springframework.data.solr.repository.SolrCrudRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">import</span> com.chenxun.solr.model.Product;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * ClassName:ProductRepository &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    * Function: TODO ADD FUNCTION. &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    * Reason:   TODO ADD REASON. &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    * Date:     2016年8月20日 下午4:54:24 &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@author</span>   陈勋</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@version</span></span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@since</span>    JDK 1.7</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@see</span>       </span></span><br><span class=\"line\"><span class=\"comment\">    */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">ProductRepository</span>  <span class=\"keyword\">extends</span> <span class=\"title class_\">SolrCrudRepository</span>&lt;Product, String&gt;&#123;       </span><br><span class=\"line\">    Iterable&lt;Product&gt;  <span class=\"title function_\">findByName</span><span class=\"params\">(String name)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><figcaption><span>spring.properties</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">spring.data.solr.zk-host=localhost:2181</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><figcaption><span>test.java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">package</span> com.chenxun;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">import</span> java.util.ArrayList;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> java.util.HashMap;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> java.util.Iterator;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> java.util.List;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.junit.Assert;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.junit.Test;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.junit.runner.RunWith;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.springframework.boot.test.context.SpringBootTest;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">import</span> com.chenxun.solr.model.Product;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> com.chenxun.solr.repository.ProductRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RunWith(SpringRunner.class)</span>  </span><br><span class=\"line\">    <span class=\"meta\">@SpringBootTest</span>  </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ChenxunSolrApplicationTests</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span>  </span><br><span class=\"line\">    <span class=\"keyword\">private</span> ProductRepository productRepository;  </span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"meta\">@Test</span>  </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">contextLoads</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\">        productRepository.deleteAll();  </span><br><span class=\"line\">        <span class=\"type\">long</span> count=productRepository.count();  </span><br><span class=\"line\">        Assert.assertTrue(<span class=\"string\">&quot;empty count&quot;</span>, count==<span class=\"number\">0</span>);  </span><br><span class=\"line\">        Product product=<span class=\"keyword\">new</span> <span class=\"title class_\">Product</span>();  </span><br><span class=\"line\">        product.setId(<span class=\"string\">&quot;product-001&quot;</span>);  </span><br><span class=\"line\">        product.setName(<span class=\"string\">&quot;xxx&quot;</span>);  </span><br><span class=\"line\">        Map&lt;String,String&gt; map=<span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();  </span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;key01&quot;</span>, <span class=\"string\">&quot;abc&quot;</span>);  </span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;key02&quot;</span>, <span class=\"string\">&quot;123&quot;</span>);  </span><br><span class=\"line\">        product.setMap(map);      </span><br><span class=\"line\">        productRepository.save(product);  </span><br><span class=\"line\">          </span><br><span class=\"line\">        Product product1=<span class=\"keyword\">new</span> <span class=\"title class_\">Product</span>();  </span><br><span class=\"line\">        product1.setId(<span class=\"string\">&quot;product-002&quot;</span>);    </span><br><span class=\"line\">        product1.setName(<span class=\"string\">&quot;yyy&quot;</span>);  </span><br><span class=\"line\">        Map&lt;String,String&gt; map1=<span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();  </span><br><span class=\"line\">        map1.put(<span class=\"string\">&quot;key01&quot;</span>, <span class=\"string\">&quot;abc1&quot;</span>);  </span><br><span class=\"line\">        map1.put(<span class=\"string\">&quot;key02&quot;</span>, <span class=\"string\">&quot;1234&quot;</span>);  </span><br><span class=\"line\">        product1.setMap(map1);        </span><br><span class=\"line\">        productRepository.save(product1);  </span><br><span class=\"line\">          </span><br><span class=\"line\">        count=productRepository.count();  </span><br><span class=\"line\">        Assert.assertTrue(count==<span class=\"number\">2</span>);  </span><br><span class=\"line\">          </span><br><span class=\"line\">          </span><br><span class=\"line\">        Iterator&lt;Product&gt; it=productRepository.findByName(<span class=\"string\">&quot;yyy&quot;</span>).iterator();  </span><br><span class=\"line\">        <span class=\"keyword\">while</span>(it.hasNext())&#123;  </span><br><span class=\"line\">            Assert.assertTrue( it.next().getId().equals(<span class=\"string\">&quot;product-002&quot;</span>));  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">          </span><br><span class=\"line\">          </span><br><span class=\"line\">          </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<p>到此大功告成，下一篇补上中文分词就OK了。<br>代码地址： <a href=\"https://github.com/ChenXun1989/chenxun-solr\">https://github.com/ChenXun1989/chenxun-solr</a></p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"solrcloud搭建\"><a href=\"#solrcloud搭建\" class=\"headerlink\" title=\"solrcloud搭建\"></a>solrcloud搭建</h1><p>群里小伙伴需要一个solrcloud的解决案例。正好好久没碰过solr了。决定写个demo，顺便重新熟悉下solr。</p>\n<ol>\n<li><p>solr版本：5.0</p>\n</li>\n<li><p>solr链接：<a href=\"http://archive.apache.org/dist/lucene/solr/5.0.0/\">http://archive.apache.org/dist/lucene/solr/5.0.0/</a></p>\n</li>\n<li><p>jdk版本：1.70+</p>\n</li>\n<li><p>windows环境安装：</p>\n<blockquote>\n<p>cd D:\\app\\solr-5.0.0\\bin<br>solr.cmd -c -z localhost:2181 -p 8983<br>cd D:\\app\\solr-5.0.0-01\\bin<br>solr.cmd -c -z localhost:2181 -p 8984<br>cd D:\\app\\solr-5.0.0-02\\bin<br>solr.cmd -c -z localhost:2181 -p 8985  </p>\n</blockquote>\n</li>\n<li><p>注意端口号不要冲突-z 表示zookeeper连接配置 ，zookeeper服务要先启动。<br>服务全部启动好，之后校验下是否成功。</p>\n<blockquote>\n<p><a href=\"http://localhost:8983/solr/#/~cloud?view=tree\">http://localhost:8983/solr/#/~cloud?view=tree</a></p>\n</blockquote>\n</li>\n<li><p>创建conlection</p>\n<blockquote>\n<p>cd D:\\app\\solr-5.0.0\\bin<br>solr.cmd create_collection -c example -d ..&#x2F;example&#x2F;example-DIH&#x2F;solr&#x2F;solr&#x2F;conf&#x2F; -shards 3 -replicationFactor 2  </p>\n</blockquote>\n</li>\n<li><p>参数说明：</p>\n</li>\n</ol>\n<ul>\n<li>-c : collection名称</li>\n<li>-d : 配置文件的路径，可以使用上面提供的实例配置</li>\n<li>-n : 配置名称可以和collection名称不同，默认这个参数不填的话，会使用collection名称作为config名称</li>\n<li>-shards : 创建的shard个数，建议和集群节点数量一致。</li>\n<li>-replicationFactor : 每个shard的副本数，综合考虑为了保证集群的稳定性，建议配置为 最少2个，最多集群节点数量&#x2F;shard数量 * 2<br>校验结果：<a href=\"http://localhost:8983/solr/#/~cloud\">http://localhost:8983/solr/#/~cloud</a><br>服务端配置暂时告一段落，之后补上中文分词。</li>\n</ul>\n<ol start=\"8\">\n<li>客户端配置：<br>使用spring-boot-starter-solr来简化集成。核心是spring-data-solr</li>\n</ol>\n<figure class=\"highlight xml\"><figcaption><span>pom.xml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">parent</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-parent<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.4.0.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">relativePath</span>/&gt;</span> <span class=\"comment\">&lt;!-- lookup parent from repository --&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">parent</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">properties</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class=\"tag\">&lt;/<span class=\"name\">project.build.sourceEncoding</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class=\"tag\">&lt;/<span class=\"name\">project.reporting.outputEncoding</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">java.version</span>&gt;</span>1.7<span class=\"tag\">&lt;/<span class=\"name\">java.version</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">properties</span>&gt;</span>  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-data-solr<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.projectlombok<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>lombok<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-web<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-test<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>test<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span>  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">build</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">plugins</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span>  </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span>  </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">plugins</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ol start=\"9\">\n<li>剩下就是javaconfig了</li>\n</ol>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* Project Name:chenxun-solr</span></span><br><span class=\"line\"><span class=\"comment\">* File Name:SolrConfig.java</span></span><br><span class=\"line\"><span class=\"comment\">* Package Name:com.chenxun.solr.config</span></span><br><span class=\"line\"><span class=\"comment\">* Date:2016年8月20日下午3:11:32</span></span><br><span class=\"line\"><span class=\"comment\">* Copyright (c) 2016, www midaigroup com Technology Co., Ltd. All Rights Reserved.</span></span><br><span class=\"line\"><span class=\"comment\">* </span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.chenxun.solr.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.solr.client.solrj.SolrClient;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.solr.client.solrj.impl.CloudSolrClient;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Value;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Bean;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.SolrTemplate;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.convert.CustomConversions;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.convert.MappingSolrConverter;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.convert.SolrConverter;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.mapping.SimpleSolrMappingContext;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.repository.config.EnableSolrRepositories;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * ClassName:SolrConfig &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  * Function: TODO ADD FUNCTION. &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  * Reason: TODO ADD REASON. &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  * Date: 2016年8月20日 下午3:11:32 &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  * </span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@author</span> 陈勋</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@version</span></span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@since</span> JDK 1.7</span></span><br><span class=\"line\"><span class=\"comment\">  * <span class=\"doctag\">@see</span></span></span><br><span class=\"line\"><span class=\"comment\"> */</span>  </span><br><span class=\"line\"><span class=\"meta\">@Configuration</span>  </span><br><span class=\"line\"><span class=\"meta\">@EnableSolrRepositories(basePackages = &#123; &quot;com.chenxun.solr&quot; &#125;, multicoreSupport = true)</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SolrConfig</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Value(&quot;$&#123;spring.data.solr.zk-host&#125;&quot;)</span>  </span><br><span class=\"line\"><span class=\"keyword\">private</span> String zkHost;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Bean</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> SolrClient <span class=\"title function_\">solrClient</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">CloudSolrClient</span>(zkHost);  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Bean</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> SolrTemplate <span class=\"title function_\">solrTemplate</span><span class=\"params\">(SolrClient solrClient,SolrConverter solrConverter)</span> <span class=\"keyword\">throws</span> Exception &#123;  </span><br><span class=\"line\"><span class=\"type\">SolrTemplate</span> <span class=\"variable\">solrTemplate</span> <span class=\"operator\">=</span>  <span class=\"keyword\">new</span> <span class=\"title class_\">SolrTemplate</span>(solrClient);  </span><br><span class=\"line\">solrTemplate.setSolrConverter(solrConverter);  </span><br><span class=\"line\"><span class=\"keyword\">return</span> solrTemplate;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Bean</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> SolrConverter <span class=\"title function_\">solrConverter</span><span class=\"params\">(SimpleSolrMappingContext simpleSolrMappingContext,CustomConversions customConversions)</span>&#123;  </span><br><span class=\"line\">MappingSolrConverter solrConverter=<span class=\"keyword\">new</span> <span class=\"title class_\">MappingSolrConverter</span>(simpleSolrMappingContext);  </span><br><span class=\"line\">solrConverter.setCustomConversions(customConversions);        </span><br><span class=\"line\"><span class=\"keyword\">return</span> solrConverter;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Bean</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> SimpleSolrMappingContext <span class=\"title function_\">simpleSolrMappingContext</span><span class=\"params\">()</span>&#123;  </span><br><span class=\"line\">SimpleSolrMappingContext simpleSolrMappingContext=<span class=\"keyword\">new</span> <span class=\"title class_\">SimpleSolrMappingContext</span>();  </span><br><span class=\"line\"><span class=\"keyword\">return</span> simpleSolrMappingContext;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Bean</span>  </span><br><span class=\"line\"><span class=\"keyword\">public</span> CustomConversions <span class=\"title function_\">customConversions</span><span class=\"params\">()</span>&#123;  </span><br><span class=\"line\">CustomConversions customConversions=<span class=\"keyword\">new</span> <span class=\"title class_\">CustomConversions</span>();  </span><br><span class=\"line\"><span class=\"comment\">//  customConversions.registerConvertersIn(new GenericConversionService()&#123;&#125;);  </span></span><br><span class=\"line\"><span class=\"keyword\">return</span> customConversions;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ol start=\"10\">\n<li>实体</li>\n</ol>\n <figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Project Name:chenxun-solr</span></span><br><span class=\"line\"><span class=\"comment\">  * File Name:Product.java</span></span><br><span class=\"line\"><span class=\"comment\"> * Package Name:com.chenxun.solr.model</span></span><br><span class=\"line\"><span class=\"comment\"> * Date:2016年8月20日下午4:48:36</span></span><br><span class=\"line\"><span class=\"comment\"> * Copyright (c) 2016, www midaigroup com Technology Co., Ltd. All Rights Reserved.</span></span><br><span class=\"line\"><span class=\"comment\"> * </span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> com.chenxun.solr.model;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.Data;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.solr.client.solrj.beans.Field;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.annotation.Id;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.mapping.Dynamic;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.mapping.Indexed;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.solr.core.mapping.SolrDocument;  </span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * ClassName:Product &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">* Function: TODO ADD FUNCTION. &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">* Reason:   TODO ADD REASON. &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">* Date:     2016年8月20日 下午4:48:36 &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@author</span>   陈勋</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@version</span></span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@since</span>    JDK 1.7</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@see</span>       </span></span><br><span class=\"line\"><span class=\"comment\">  */</span>  </span><br><span class=\"line\">  <span class=\"meta\">@SolrDocument(solrCoreName=&quot;example&quot;)</span> <span class=\"comment\">// Solr collection name  </span></span><br><span class=\"line\">  <span class=\"meta\">@Data</span>  </span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Product</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Field(&quot;id&quot;)</span>                  <span class=\"comment\">// Specify field name in solr  </span></span><br><span class=\"line\">  <span class=\"meta\">@Id</span>    </span><br><span class=\"line\">  <span class=\"keyword\">private</span> String id;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Field</span>  </span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"type\">float</span> price;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Field</span>  </span><br><span class=\"line\">  <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Field(&quot;*_s&quot;)</span>  </span><br><span class=\"line\">  <span class=\"meta\">@Dynamic</span>  </span><br><span class=\"line\">  <span class=\"keyword\">private</span> Map&lt;String,String&gt; map =<span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;String, String&gt;();       </span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/** </span></span><br><span class=\"line\"><span class=\"comment\">    Project Name:chenxun-solr</span></span><br><span class=\"line\"><span class=\"comment\">    * File Name:ProductRepository.java</span></span><br><span class=\"line\"><span class=\"comment\">    * Package Name:com.chenxun.solr.repository</span></span><br><span class=\"line\"><span class=\"comment\">    * Date:2016年8月20日下午4:54:24</span></span><br><span class=\"line\"><span class=\"comment\">    * Copyright (c) 2016, www midaigroup com Technology Co., Ltd. All Rights Reserved.</span></span><br><span class=\"line\"><span class=\"comment\">    * </span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">package</span> com.chenxun.solr.repository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.springframework.data.solr.repository.SolrCrudRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">import</span> com.chenxun.solr.model.Product;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * ClassName:ProductRepository &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    * Function: TODO ADD FUNCTION. &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    * Reason:   TODO ADD REASON. &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    * Date:     2016年8月20日 下午4:54:24 &lt;br/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@author</span>   陈勋</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@version</span></span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@since</span>    JDK 1.7</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@see</span>       </span></span><br><span class=\"line\"><span class=\"comment\">    */</span>  </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">ProductRepository</span>  <span class=\"keyword\">extends</span> <span class=\"title class_\">SolrCrudRepository</span>&lt;Product, String&gt;&#123;       </span><br><span class=\"line\">    Iterable&lt;Product&gt;  <span class=\"title function_\">findByName</span><span class=\"params\">(String name)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><figcaption><span>spring.properties</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">spring.data.solr.zk-host=localhost:2181</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><figcaption><span>test.java</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">package</span> com.chenxun;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">import</span> java.util.ArrayList;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> java.util.HashMap;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> java.util.Iterator;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> java.util.List;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.junit.Assert;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.junit.Test;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.junit.runner.RunWith;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.springframework.boot.test.context.SpringBootTest;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">import</span> com.chenxun.solr.model.Product;  </span><br><span class=\"line\">    <span class=\"keyword\">import</span> com.chenxun.solr.repository.ProductRepository;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RunWith(SpringRunner.class)</span>  </span><br><span class=\"line\">    <span class=\"meta\">@SpringBootTest</span>  </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ChenxunSolrApplicationTests</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span>  </span><br><span class=\"line\">    <span class=\"keyword\">private</span> ProductRepository productRepository;  </span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"meta\">@Test</span>  </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">contextLoads</span><span class=\"params\">()</span> &#123;  </span><br><span class=\"line\">        productRepository.deleteAll();  </span><br><span class=\"line\">        <span class=\"type\">long</span> count=productRepository.count();  </span><br><span class=\"line\">        Assert.assertTrue(<span class=\"string\">&quot;empty count&quot;</span>, count==<span class=\"number\">0</span>);  </span><br><span class=\"line\">        Product product=<span class=\"keyword\">new</span> <span class=\"title class_\">Product</span>();  </span><br><span class=\"line\">        product.setId(<span class=\"string\">&quot;product-001&quot;</span>);  </span><br><span class=\"line\">        product.setName(<span class=\"string\">&quot;xxx&quot;</span>);  </span><br><span class=\"line\">        Map&lt;String,String&gt; map=<span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();  </span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;key01&quot;</span>, <span class=\"string\">&quot;abc&quot;</span>);  </span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;key02&quot;</span>, <span class=\"string\">&quot;123&quot;</span>);  </span><br><span class=\"line\">        product.setMap(map);      </span><br><span class=\"line\">        productRepository.save(product);  </span><br><span class=\"line\">          </span><br><span class=\"line\">        Product product1=<span class=\"keyword\">new</span> <span class=\"title class_\">Product</span>();  </span><br><span class=\"line\">        product1.setId(<span class=\"string\">&quot;product-002&quot;</span>);    </span><br><span class=\"line\">        product1.setName(<span class=\"string\">&quot;yyy&quot;</span>);  </span><br><span class=\"line\">        Map&lt;String,String&gt; map1=<span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();  </span><br><span class=\"line\">        map1.put(<span class=\"string\">&quot;key01&quot;</span>, <span class=\"string\">&quot;abc1&quot;</span>);  </span><br><span class=\"line\">        map1.put(<span class=\"string\">&quot;key02&quot;</span>, <span class=\"string\">&quot;1234&quot;</span>);  </span><br><span class=\"line\">        product1.setMap(map1);        </span><br><span class=\"line\">        productRepository.save(product1);  </span><br><span class=\"line\">          </span><br><span class=\"line\">        count=productRepository.count();  </span><br><span class=\"line\">        Assert.assertTrue(count==<span class=\"number\">2</span>);  </span><br><span class=\"line\">          </span><br><span class=\"line\">          </span><br><span class=\"line\">        Iterator&lt;Product&gt; it=productRepository.findByName(<span class=\"string\">&quot;yyy&quot;</span>).iterator();  </span><br><span class=\"line\">        <span class=\"keyword\">while</span>(it.hasNext())&#123;  </span><br><span class=\"line\">            Assert.assertTrue( it.next().getId().equals(<span class=\"string\">&quot;product-002&quot;</span>));  </span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">          </span><br><span class=\"line\">          </span><br><span class=\"line\">          </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<p>到此大功告成，下一篇补上中文分词就OK了。<br>代码地址： <a href=\"https://github.com/ChenXun1989/chenxun-solr\">https://github.com/ChenXun1989/chenxun-solr</a></p>\n"},{"title":"volatile原理解析","abbrlink":51308,"date":"2023-06-20T06:18:09.000Z","_content":"# volatile原理解析\n\n## volatile语义\njsr133规范对volatile语义进行了增强，明确保证了可见性和有序性。\n\n**volatile不保证原子性**\n\njava编程语言允许线程访问共享变量，为了确保共享变量能被准确和一致的更新，线程应该确保通过排他锁单独获得这个变量。\nJava语言提供了volatile，在某些情况下比锁更加方便。\n如果一个字段被声明成volatile，java线程内存模型确保所有线程看到这个变量的值是一致的。\n\n**Volatile变量修饰符如果使用恰当的话，它比synchronized的使用和执行成本会更低，因为它不会引起线程上下文的切换和调度。**\n\n## volatile的有序性\n\njmm为了保证volatile的语义中的有序性，通过内存屏障来禁止指令重排序\nJMM基于保守策略的JMM内存屏障插入策略\n- 在每个volatile写操作的前面插入一个StoreStore屏障\n- 在每个volatile写操作的后面插入一个SotreLoad屏障\n- 在每个volatile读操作的后面插入一个LoadLoad屏障\n- 在每个volatile读操作的后面插入一个LoadStore屏障\n\n\nx86处理器仅仅会对写-读操作做重排序,因此在x86中，JMM仅需在volatile后面插入一个StoreLoad屏障即可正确实现volatile写-读的内存语义 \n\n## volatile的可见性\n对于volatile修饰的变量，jvm虚拟机保证从主内存加载到线程工作内存的值是最新的。\n从内存语义的角度来看\n- volatile的写-读与锁的释放-获取有相同的内存效果\n- volatile写和锁的释放有相同的内存语义\n- volatile读与锁的获取有相同的内存语义\n\n\n当线程释放锁的时候，JMM会把线程对应的本地内存中的共享变量刷新到主内存中\n当线程获取锁时，JMM会把线程对应的本地内存置为无效，从而使得被监视器保护的临界区代码必须要从主内存中去读取共享变量。\n\n## volatile的使用前提\n- 对变量的写入操作不依赖变量的当前值，或者你能确保只有单个线程更新变量的值。\n- 该变量没有包含在具有其他变量的不变式中。\n\n\n","source":"_posts/volatile原理解析.md","raw":"---\ntitle: volatile原理解析\ntags:\n  - java\n  - jvm\nabbrlink: 51308\ndate: 2023-06-20 14:18:09\n---\n# volatile原理解析\n\n## volatile语义\njsr133规范对volatile语义进行了增强，明确保证了可见性和有序性。\n\n**volatile不保证原子性**\n\njava编程语言允许线程访问共享变量，为了确保共享变量能被准确和一致的更新，线程应该确保通过排他锁单独获得这个变量。\nJava语言提供了volatile，在某些情况下比锁更加方便。\n如果一个字段被声明成volatile，java线程内存模型确保所有线程看到这个变量的值是一致的。\n\n**Volatile变量修饰符如果使用恰当的话，它比synchronized的使用和执行成本会更低，因为它不会引起线程上下文的切换和调度。**\n\n## volatile的有序性\n\njmm为了保证volatile的语义中的有序性，通过内存屏障来禁止指令重排序\nJMM基于保守策略的JMM内存屏障插入策略\n- 在每个volatile写操作的前面插入一个StoreStore屏障\n- 在每个volatile写操作的后面插入一个SotreLoad屏障\n- 在每个volatile读操作的后面插入一个LoadLoad屏障\n- 在每个volatile读操作的后面插入一个LoadStore屏障\n\n\nx86处理器仅仅会对写-读操作做重排序,因此在x86中，JMM仅需在volatile后面插入一个StoreLoad屏障即可正确实现volatile写-读的内存语义 \n\n## volatile的可见性\n对于volatile修饰的变量，jvm虚拟机保证从主内存加载到线程工作内存的值是最新的。\n从内存语义的角度来看\n- volatile的写-读与锁的释放-获取有相同的内存效果\n- volatile写和锁的释放有相同的内存语义\n- volatile读与锁的获取有相同的内存语义\n\n\n当线程释放锁的时候，JMM会把线程对应的本地内存中的共享变量刷新到主内存中\n当线程获取锁时，JMM会把线程对应的本地内存置为无效，从而使得被监视器保护的临界区代码必须要从主内存中去读取共享变量。\n\n## volatile的使用前提\n- 对变量的写入操作不依赖变量的当前值，或者你能确保只有单个线程更新变量的值。\n- 该变量没有包含在具有其他变量的不变式中。\n\n\n","slug":"volatile原理解析","published":1,"updated":"2023-12-05T02:48:12.739Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdj80019orgoh6l9f722","content":"<h1 id=\"volatile原理解析\"><a href=\"#volatile原理解析\" class=\"headerlink\" title=\"volatile原理解析\"></a>volatile原理解析</h1><h2 id=\"volatile语义\"><a href=\"#volatile语义\" class=\"headerlink\" title=\"volatile语义\"></a>volatile语义</h2><p>jsr133规范对volatile语义进行了增强，明确保证了可见性和有序性。</p>\n<p><strong>volatile不保证原子性</strong></p>\n<p>java编程语言允许线程访问共享变量，为了确保共享变量能被准确和一致的更新，线程应该确保通过排他锁单独获得这个变量。<br>Java语言提供了volatile，在某些情况下比锁更加方便。<br>如果一个字段被声明成volatile，java线程内存模型确保所有线程看到这个变量的值是一致的。</p>\n<p><strong>Volatile变量修饰符如果使用恰当的话，它比synchronized的使用和执行成本会更低，因为它不会引起线程上下文的切换和调度。</strong></p>\n<h2 id=\"volatile的有序性\"><a href=\"#volatile的有序性\" class=\"headerlink\" title=\"volatile的有序性\"></a>volatile的有序性</h2><p>jmm为了保证volatile的语义中的有序性，通过内存屏障来禁止指令重排序<br>JMM基于保守策略的JMM内存屏障插入策略</p>\n<ul>\n<li>在每个volatile写操作的前面插入一个StoreStore屏障</li>\n<li>在每个volatile写操作的后面插入一个SotreLoad屏障</li>\n<li>在每个volatile读操作的后面插入一个LoadLoad屏障</li>\n<li>在每个volatile读操作的后面插入一个LoadStore屏障</li>\n</ul>\n<p>x86处理器仅仅会对写-读操作做重排序,因此在x86中，JMM仅需在volatile后面插入一个StoreLoad屏障即可正确实现volatile写-读的内存语义 </p>\n<h2 id=\"volatile的可见性\"><a href=\"#volatile的可见性\" class=\"headerlink\" title=\"volatile的可见性\"></a>volatile的可见性</h2><p>对于volatile修饰的变量，jvm虚拟机保证从主内存加载到线程工作内存的值是最新的。<br>从内存语义的角度来看</p>\n<ul>\n<li>volatile的写-读与锁的释放-获取有相同的内存效果</li>\n<li>volatile写和锁的释放有相同的内存语义</li>\n<li>volatile读与锁的获取有相同的内存语义</li>\n</ul>\n<p>当线程释放锁的时候，JMM会把线程对应的本地内存中的共享变量刷新到主内存中<br>当线程获取锁时，JMM会把线程对应的本地内存置为无效，从而使得被监视器保护的临界区代码必须要从主内存中去读取共享变量。</p>\n<h2 id=\"volatile的使用前提\"><a href=\"#volatile的使用前提\" class=\"headerlink\" title=\"volatile的使用前提\"></a>volatile的使用前提</h2><ul>\n<li>对变量的写入操作不依赖变量的当前值，或者你能确保只有单个线程更新变量的值。</li>\n<li>该变量没有包含在具有其他变量的不变式中。</li>\n</ul>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"volatile原理解析\"><a href=\"#volatile原理解析\" class=\"headerlink\" title=\"volatile原理解析\"></a>volatile原理解析</h1><h2 id=\"volatile语义\"><a href=\"#volatile语义\" class=\"headerlink\" title=\"volatile语义\"></a>volatile语义</h2><p>jsr133规范对volatile语义进行了增强，明确保证了可见性和有序性。</p>\n<p><strong>volatile不保证原子性</strong></p>\n<p>java编程语言允许线程访问共享变量，为了确保共享变量能被准确和一致的更新，线程应该确保通过排他锁单独获得这个变量。<br>Java语言提供了volatile，在某些情况下比锁更加方便。<br>如果一个字段被声明成volatile，java线程内存模型确保所有线程看到这个变量的值是一致的。</p>\n<p><strong>Volatile变量修饰符如果使用恰当的话，它比synchronized的使用和执行成本会更低，因为它不会引起线程上下文的切换和调度。</strong></p>\n<h2 id=\"volatile的有序性\"><a href=\"#volatile的有序性\" class=\"headerlink\" title=\"volatile的有序性\"></a>volatile的有序性</h2><p>jmm为了保证volatile的语义中的有序性，通过内存屏障来禁止指令重排序<br>JMM基于保守策略的JMM内存屏障插入策略</p>\n<ul>\n<li>在每个volatile写操作的前面插入一个StoreStore屏障</li>\n<li>在每个volatile写操作的后面插入一个SotreLoad屏障</li>\n<li>在每个volatile读操作的后面插入一个LoadLoad屏障</li>\n<li>在每个volatile读操作的后面插入一个LoadStore屏障</li>\n</ul>\n<p>x86处理器仅仅会对写-读操作做重排序,因此在x86中，JMM仅需在volatile后面插入一个StoreLoad屏障即可正确实现volatile写-读的内存语义 </p>\n<h2 id=\"volatile的可见性\"><a href=\"#volatile的可见性\" class=\"headerlink\" title=\"volatile的可见性\"></a>volatile的可见性</h2><p>对于volatile修饰的变量，jvm虚拟机保证从主内存加载到线程工作内存的值是最新的。<br>从内存语义的角度来看</p>\n<ul>\n<li>volatile的写-读与锁的释放-获取有相同的内存效果</li>\n<li>volatile写和锁的释放有相同的内存语义</li>\n<li>volatile读与锁的获取有相同的内存语义</li>\n</ul>\n<p>当线程释放锁的时候，JMM会把线程对应的本地内存中的共享变量刷新到主内存中<br>当线程获取锁时，JMM会把线程对应的本地内存置为无效，从而使得被监视器保护的临界区代码必须要从主内存中去读取共享变量。</p>\n<h2 id=\"volatile的使用前提\"><a href=\"#volatile的使用前提\" class=\"headerlink\" title=\"volatile的使用前提\"></a>volatile的使用前提</h2><ul>\n<li>对变量的写入操作不依赖变量的当前值，或者你能确保只有单个线程更新变量的值。</li>\n<li>该变量没有包含在具有其他变量的不变式中。</li>\n</ul>\n"},{"title":"solr中文分词","abbrlink":9592,"date":"2023-06-19T07:29:14.000Z","_content":"# solr中文分词\n\nsolr中文分词。\nsolr5.0 自带一个中文分词包，lucene-analyzers-smartcn-5.0.0.jar。\n在安装目录下搜寻找到，并copy到solr提供的web服务目录的lib目录下。\n修改collection配置里面的schema.xml。新增字段类型。\n\n{% codeblock schema.xml lang:xml   %}\n<fieldType name=\"text_cn\" class=\"solr.TextField\" positionIncrementGap=\"100\">    \n<analyzer type=\"index\">    \n<!-- 此处需要配置主要的分词类 -->    \n<tokenizer class=\"solr.SmartChineseSentenceTokenizerFactory\"></tokenizer>    \n<filter class=\"solr.SmartChineseWordTokenFilterFactory\"/>    \n</analyzer>    \n<analyzer type=\"query\">    \n<!-- 此处配置同上 -->    \n<tokenizer class=\"solr.SmartChineseSentenceTokenizerFactory\"/>    \n<filter class=\"solr.SmartChineseWordTokenFilterFactory\"/>    \n</analyzer>    \n</fieldType>  \n{% endcodeblock %}\n\n启动solr cloud服务，新建collection就好。\n\n","source":"_posts/solr中文分词.md","raw":"---\ntitle: solr中文分词\ntags:\n  - solr\nabbrlink: 9592\ndate: 2023-06-19 15:29:14\n---\n# solr中文分词\n\nsolr中文分词。\nsolr5.0 自带一个中文分词包，lucene-analyzers-smartcn-5.0.0.jar。\n在安装目录下搜寻找到，并copy到solr提供的web服务目录的lib目录下。\n修改collection配置里面的schema.xml。新增字段类型。\n\n{% codeblock schema.xml lang:xml   %}\n<fieldType name=\"text_cn\" class=\"solr.TextField\" positionIncrementGap=\"100\">    \n<analyzer type=\"index\">    \n<!-- 此处需要配置主要的分词类 -->    \n<tokenizer class=\"solr.SmartChineseSentenceTokenizerFactory\"></tokenizer>    \n<filter class=\"solr.SmartChineseWordTokenFilterFactory\"/>    \n</analyzer>    \n<analyzer type=\"query\">    \n<!-- 此处配置同上 -->    \n<tokenizer class=\"solr.SmartChineseSentenceTokenizerFactory\"/>    \n<filter class=\"solr.SmartChineseWordTokenFilterFactory\"/>    \n</analyzer>    \n</fieldType>  \n{% endcodeblock %}\n\n启动solr cloud服务，新建collection就好。\n\n","slug":"solr中文分词","published":1,"updated":"2023-12-05T02:48:12.737Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdj9001corgo3mcchect","content":"<h1 id=\"solr中文分词\"><a href=\"#solr中文分词\" class=\"headerlink\" title=\"solr中文分词\"></a>solr中文分词</h1><p>solr中文分词。<br>solr5.0 自带一个中文分词包，lucene-analyzers-smartcn-5.0.0.jar。<br>在安装目录下搜寻找到，并copy到solr提供的web服务目录的lib目录下。<br>修改collection配置里面的schema.xml。新增字段类型。</p>\n<figure class=\"highlight xml\"><figcaption><span>schema.xml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">fieldType</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_cn&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;solr.TextField&quot;</span> <span class=\"attr\">positionIncrementGap</span>=<span class=\"string\">&quot;100&quot;</span>&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">analyzer</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;index&quot;</span>&gt;</span>    </span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 此处需要配置主要的分词类 --&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">tokenizer</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;solr.SmartChineseSentenceTokenizerFactory&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">tokenizer</span>&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;solr.SmartChineseWordTokenFilterFactory&quot;</span>/&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">analyzer</span>&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">analyzer</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;query&quot;</span>&gt;</span>    </span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 此处配置同上 --&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">tokenizer</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;solr.SmartChineseSentenceTokenizerFactory&quot;</span>/&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;solr.SmartChineseWordTokenFilterFactory&quot;</span>/&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">analyzer</span>&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">fieldType</span>&gt;</span>  </span><br></pre></td></tr></table></figure>\n\n<p>启动solr cloud服务，新建collection就好。</p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"solr中文分词\"><a href=\"#solr中文分词\" class=\"headerlink\" title=\"solr中文分词\"></a>solr中文分词</h1><p>solr中文分词。<br>solr5.0 自带一个中文分词包，lucene-analyzers-smartcn-5.0.0.jar。<br>在安装目录下搜寻找到，并copy到solr提供的web服务目录的lib目录下。<br>修改collection配置里面的schema.xml。新增字段类型。</p>\n<figure class=\"highlight xml\"><figcaption><span>schema.xml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">fieldType</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;text_cn&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;solr.TextField&quot;</span> <span class=\"attr\">positionIncrementGap</span>=<span class=\"string\">&quot;100&quot;</span>&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">analyzer</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;index&quot;</span>&gt;</span>    </span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 此处需要配置主要的分词类 --&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">tokenizer</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;solr.SmartChineseSentenceTokenizerFactory&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">tokenizer</span>&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;solr.SmartChineseWordTokenFilterFactory&quot;</span>/&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">analyzer</span>&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">analyzer</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;query&quot;</span>&gt;</span>    </span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 此处配置同上 --&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">tokenizer</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;solr.SmartChineseSentenceTokenizerFactory&quot;</span>/&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;solr.SmartChineseWordTokenFilterFactory&quot;</span>/&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">analyzer</span>&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">fieldType</span>&gt;</span>  </span><br></pre></td></tr></table></figure>\n\n<p>启动solr cloud服务，新建collection就好。</p>\n"},{"title":"synchronized原理解析","abbrlink":35937,"date":"2023-06-20T06:30:26.000Z","_content":"\n# synchronized原理解析\n\n## synchronized的三种方式\n对于普通同步方法,锁的是当前实例对象\n{% codeblock  lang:java   %}\n\n    synchronized void test1(){\n    //do something\n    }\n{% endcodeblock %}\n对于静态方同步方法，锁的是当前类的Class对象\n\n{% codeblock  lang:java   %}\n\n    static synchronized void test2(){\n    //do something\n    }\n\n{% endcodeblock %}\n\n对于同步方法快，锁的是synchronized括号里的对象\n\n{% codeblock  lang:java   %}\n\n    void test3(){\n\tsynchronized(this){\n\t\t//do something\t\n\t}\n    }\n\n{% endcodeblock %}\n\n## synchronized锁升级\n\njdk1.6之后，synchronized锁有四种状态，无锁，偏向锁，轻量级锁，重量级。\n\n- 偏向锁： 存在java对象头里面。\n- 轻量级锁：存在当前线程的栈帧里面\n- 重量级锁： 存在当前对象的monitor对象里面\n\n锁升级过程：\n- 无锁状态到偏向锁，当前线程通过cas修改java对象头的锁标志位。\n- 谝向锁到轻量级锁, 当前线程把java对象头的锁信息copy到栈帧里面\n- 轻量级锁到重量级锁，把栈帧里面的锁信息copy到对象的monitor里面。\n- 偏向锁和轻量级锁采用cas自旋修改锁状态，重量级锁通过线程信号来实现*\n","source":"_posts/synchronized原理解析.md","raw":"---\ntitle: synchronized原理解析\ntags:\n  - java\nabbrlink: 35937\ndate: 2023-06-20 14:30:26\n---\n\n# synchronized原理解析\n\n## synchronized的三种方式\n对于普通同步方法,锁的是当前实例对象\n{% codeblock  lang:java   %}\n\n    synchronized void test1(){\n    //do something\n    }\n{% endcodeblock %}\n对于静态方同步方法，锁的是当前类的Class对象\n\n{% codeblock  lang:java   %}\n\n    static synchronized void test2(){\n    //do something\n    }\n\n{% endcodeblock %}\n\n对于同步方法快，锁的是synchronized括号里的对象\n\n{% codeblock  lang:java   %}\n\n    void test3(){\n\tsynchronized(this){\n\t\t//do something\t\n\t}\n    }\n\n{% endcodeblock %}\n\n## synchronized锁升级\n\njdk1.6之后，synchronized锁有四种状态，无锁，偏向锁，轻量级锁，重量级。\n\n- 偏向锁： 存在java对象头里面。\n- 轻量级锁：存在当前线程的栈帧里面\n- 重量级锁： 存在当前对象的monitor对象里面\n\n锁升级过程：\n- 无锁状态到偏向锁，当前线程通过cas修改java对象头的锁标志位。\n- 谝向锁到轻量级锁, 当前线程把java对象头的锁信息copy到栈帧里面\n- 轻量级锁到重量级锁，把栈帧里面的锁信息copy到对象的monitor里面。\n- 偏向锁和轻量级锁采用cas自旋修改锁状态，重量级锁通过线程信号来实现*\n","slug":"synchronized原理解析","published":1,"updated":"2023-12-05T02:48:12.738Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdj9001eorgof1yw3x3h","content":"<h1 id=\"synchronized原理解析\"><a href=\"#synchronized原理解析\" class=\"headerlink\" title=\"synchronized原理解析\"></a>synchronized原理解析</h1><h2 id=\"synchronized的三种方式\"><a href=\"#synchronized的三种方式\" class=\"headerlink\" title=\"synchronized的三种方式\"></a>synchronized的三种方式</h2><p>对于普通同步方法,锁的是当前实例对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title function_\">test1</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\"><span class=\"comment\">//do something</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于静态方同步方法，锁的是当前类的Class对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title function_\">test2</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\"><span class=\"comment\">//do something</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>对于同步方法快，锁的是synchronized括号里的对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">void</span> <span class=\"title function_\">test3</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\"><span class=\"keyword\">synchronized</span>(<span class=\"built_in\">this</span>)&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//do something\t</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"synchronized锁升级\"><a href=\"#synchronized锁升级\" class=\"headerlink\" title=\"synchronized锁升级\"></a>synchronized锁升级</h2><p>jdk1.6之后，synchronized锁有四种状态，无锁，偏向锁，轻量级锁，重量级。</p>\n<ul>\n<li>偏向锁： 存在java对象头里面。</li>\n<li>轻量级锁：存在当前线程的栈帧里面</li>\n<li>重量级锁： 存在当前对象的monitor对象里面</li>\n</ul>\n<p>锁升级过程：</p>\n<ul>\n<li>无锁状态到偏向锁，当前线程通过cas修改java对象头的锁标志位。</li>\n<li>谝向锁到轻量级锁, 当前线程把java对象头的锁信息copy到栈帧里面</li>\n<li>轻量级锁到重量级锁，把栈帧里面的锁信息copy到对象的monitor里面。</li>\n<li>偏向锁和轻量级锁采用cas自旋修改锁状态，重量级锁通过线程信号来实现*</li>\n</ul>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"synchronized原理解析\"><a href=\"#synchronized原理解析\" class=\"headerlink\" title=\"synchronized原理解析\"></a>synchronized原理解析</h1><h2 id=\"synchronized的三种方式\"><a href=\"#synchronized的三种方式\" class=\"headerlink\" title=\"synchronized的三种方式\"></a>synchronized的三种方式</h2><p>对于普通同步方法,锁的是当前实例对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title function_\">test1</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\"><span class=\"comment\">//do something</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对于静态方同步方法，锁的是当前类的Class对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title function_\">test2</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\"><span class=\"comment\">//do something</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>对于同步方法快，锁的是synchronized括号里的对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">void</span> <span class=\"title function_\">test3</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\"><span class=\"keyword\">synchronized</span>(<span class=\"built_in\">this</span>)&#123;</span><br><span class=\"line\">\t<span class=\"comment\">//do something\t</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"synchronized锁升级\"><a href=\"#synchronized锁升级\" class=\"headerlink\" title=\"synchronized锁升级\"></a>synchronized锁升级</h2><p>jdk1.6之后，synchronized锁有四种状态，无锁，偏向锁，轻量级锁，重量级。</p>\n<ul>\n<li>偏向锁： 存在java对象头里面。</li>\n<li>轻量级锁：存在当前线程的栈帧里面</li>\n<li>重量级锁： 存在当前对象的monitor对象里面</li>\n</ul>\n<p>锁升级过程：</p>\n<ul>\n<li>无锁状态到偏向锁，当前线程通过cas修改java对象头的锁标志位。</li>\n<li>谝向锁到轻量级锁, 当前线程把java对象头的锁信息copy到栈帧里面</li>\n<li>轻量级锁到重量级锁，把栈帧里面的锁信息copy到对象的monitor里面。</li>\n<li>偏向锁和轻量级锁采用cas自旋修改锁状态，重量级锁通过线程信号来实现*</li>\n</ul>\n"},{"title":"基于jquery把表单转成成json对象","abbrlink":11819,"date":"2023-06-20T05:38:15.000Z","_content":"# 基于jquery把表单转成成json对象\n最近前端框架修改，小伙伴希望能像以前写jsp一样使用 对象.属性作为表单元素的name值\n{% codeblock  lang:javascript   %}\n\n     <form id=\"test-form\">   \n       <input name=\"a.b.c\" value=\"abc\">  \n       <input name=\"a.b.d\" value=\"abd\">  \n       <input name=\"x\" value=\"x\">  \n       <input name=\"a.f\" value=\"af\">  \n       <input name=\"y\" value=\"0\">  \n       <input name=\"y\" value=\"y2\">  \n       <input name=\"m[0].c\" value=\"m0c\">  \n       <input name=\"m[0].d\" value=\"m0d\">  \n       <input name=\"m[1].c\" value=\"m1c\">  \n       <input name=\"m[1].d\" value=\"m1d\">   \n      <input type=\"button\" id=\"test-btn\">  \n    </form>  \n\n{% endcodeblock %}\n\n我这种懒人第一反应肯定去找度娘，发现度娘居然没有，只好自己造了轮子。\n\n{% codeblock  lang:javascript   %}\n\n    function form2Json(params){  \n    var selector=params.form;  \n    var values= $(selector).serializeArray();  \n    var obj={};  \n    for (var index = 0; index < values.length; ++index)      \n    {      \n    var temp=obj; //上一级       \n    var n=values[index].name;    \n    if(n.indexOf(\".\")>-1){    \n    var arr=n.split(\".\");    \n    for(var i=0;i<arr.length-1;i++){       \n    if(arr[i].indexOf(\"[\")>-1){    \n    var a=arr[i].substring(0,arr[i].indexOf(\"[\"));    \n    temp[a]=temp[a]||[];    \n    var y=arr[i].substring(arr[i].indexOf(\"[\")+1,arr[i].indexOf(\"]\"));    \n    temp[a][y]=temp[a][y]||{};    \n    temp=temp[a][y];    \n    }else{    \n    temp[arr[i]]=temp[arr[i]] || {};       \n    temp=temp[arr[i]];    \n    }    \n    }  \n    temp[arr[arr.length-1]]=values[index].value;         \n    }else{    \n    if(obj[n] !==undefined && obj[n]!=null){    \n    if( !$.isArray(obj[n])){    \n    var v=obj[n];    \n    obj[n]=[];    \n    obj[n].push(v);    \n    }\n    \n                obj[n].push(values[index].value);    \n             }else{     \n                 obj[n]=values[index].value;    \n             }    \n         }       \n    }       \n    return obj;\n\n\n{% endcodeblock %}\n\n该轮子支持复杂对象，支持对象数组，支持简单属性\n{% codeblock  lang:javascript   %}\n\n    $(\"#test-btn\").on(\"click\",function(){  \n    var json=form2Json({  \n    form:\"#test-form\"  \n    });  \n    console.log(json);  \n    console.log(JSON.stringify(json));  \n    });\n\n{% endcodeblock %}\n\n最终结果如下\n\n{% codeblock  lang:javascript   %}\n\n    {\"a\":{\"b\":{\"c\":\"abc\",\"d\":\"abd\"},\"f\":\"af\"},\"x\":\"x\",\"y\":[\"0\",\"y2\"],\"m\":[{\"c\":\"m0c\",\"d\":\"m0d\"},{\"c\":\"m1c\",\"d\":\"m1d\"}]}\n\n{% endcodeblock %}","source":"_posts/基于jquery把表单转成成json对象.md","raw":"---\ntitle: 基于jquery把表单转成成json对象\ntags:\n  - 前端\nabbrlink: 11819\ndate: 2023-06-20 13:38:15\n---\n# 基于jquery把表单转成成json对象\n最近前端框架修改，小伙伴希望能像以前写jsp一样使用 对象.属性作为表单元素的name值\n{% codeblock  lang:javascript   %}\n\n     <form id=\"test-form\">   \n       <input name=\"a.b.c\" value=\"abc\">  \n       <input name=\"a.b.d\" value=\"abd\">  \n       <input name=\"x\" value=\"x\">  \n       <input name=\"a.f\" value=\"af\">  \n       <input name=\"y\" value=\"0\">  \n       <input name=\"y\" value=\"y2\">  \n       <input name=\"m[0].c\" value=\"m0c\">  \n       <input name=\"m[0].d\" value=\"m0d\">  \n       <input name=\"m[1].c\" value=\"m1c\">  \n       <input name=\"m[1].d\" value=\"m1d\">   \n      <input type=\"button\" id=\"test-btn\">  \n    </form>  \n\n{% endcodeblock %}\n\n我这种懒人第一反应肯定去找度娘，发现度娘居然没有，只好自己造了轮子。\n\n{% codeblock  lang:javascript   %}\n\n    function form2Json(params){  \n    var selector=params.form;  \n    var values= $(selector).serializeArray();  \n    var obj={};  \n    for (var index = 0; index < values.length; ++index)      \n    {      \n    var temp=obj; //上一级       \n    var n=values[index].name;    \n    if(n.indexOf(\".\")>-1){    \n    var arr=n.split(\".\");    \n    for(var i=0;i<arr.length-1;i++){       \n    if(arr[i].indexOf(\"[\")>-1){    \n    var a=arr[i].substring(0,arr[i].indexOf(\"[\"));    \n    temp[a]=temp[a]||[];    \n    var y=arr[i].substring(arr[i].indexOf(\"[\")+1,arr[i].indexOf(\"]\"));    \n    temp[a][y]=temp[a][y]||{};    \n    temp=temp[a][y];    \n    }else{    \n    temp[arr[i]]=temp[arr[i]] || {};       \n    temp=temp[arr[i]];    \n    }    \n    }  \n    temp[arr[arr.length-1]]=values[index].value;         \n    }else{    \n    if(obj[n] !==undefined && obj[n]!=null){    \n    if( !$.isArray(obj[n])){    \n    var v=obj[n];    \n    obj[n]=[];    \n    obj[n].push(v);    \n    }\n    \n                obj[n].push(values[index].value);    \n             }else{     \n                 obj[n]=values[index].value;    \n             }    \n         }       \n    }       \n    return obj;\n\n\n{% endcodeblock %}\n\n该轮子支持复杂对象，支持对象数组，支持简单属性\n{% codeblock  lang:javascript   %}\n\n    $(\"#test-btn\").on(\"click\",function(){  \n    var json=form2Json({  \n    form:\"#test-form\"  \n    });  \n    console.log(json);  \n    console.log(JSON.stringify(json));  \n    });\n\n{% endcodeblock %}\n\n最终结果如下\n\n{% codeblock  lang:javascript   %}\n\n    {\"a\":{\"b\":{\"c\":\"abc\",\"d\":\"abd\"},\"f\":\"af\"},\"x\":\"x\",\"y\":[\"0\",\"y2\"],\"m\":[{\"c\":\"m0c\",\"d\":\"m0d\"},{\"c\":\"m1c\",\"d\":\"m1d\"}]}\n\n{% endcodeblock %}","slug":"基于jquery把表单转成成json对象","published":1,"updated":"2023-12-05T02:48:12.739Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdja001gorgo8wfu8mqm","content":"<h1 id=\"基于jquery把表单转成成json对象\"><a href=\"#基于jquery把表单转成成json对象\" class=\"headerlink\" title=\"基于jquery把表单转成成json对象\"></a>基于jquery把表单转成成json对象</h1><p>最近前端框架修改，小伙伴希望能像以前写jsp一样使用 对象.属性作为表单元素的name值</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"> &lt;form id=<span class=\"string\">&quot;test-form&quot;</span>&gt;   </span><br><span class=\"line\">   &lt;input name=&quot;a.b.c&quot; value=&quot;abc&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;a.b.d&quot; value=&quot;abd&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;x&quot; value=&quot;x&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;a.f&quot; value=&quot;af&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;y&quot; value=&quot;0&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;y&quot; value=&quot;y2&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;m[0].c&quot; value=&quot;m0c&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;m[0].d&quot; value=&quot;m0d&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;m[1].c&quot; value=&quot;m1c&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;m[1].d&quot; value=&quot;m1d&quot;&gt;   </span><br><span class=\"line\">  &lt;input type=&quot;button&quot; id=&quot;test-btn&quot;&gt;  </span><br><span class=\"line\">&lt;/form&gt;  </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>我这种懒人第一反应肯定去找度娘，发现度娘居然没有，只好自己造了轮子。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">form2Json</span>(<span class=\"params\">params</span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> selector=params.<span class=\"property\">form</span>;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> values= $(selector).<span class=\"title function_\">serializeArray</span>();  </span><br><span class=\"line\"><span class=\"keyword\">var</span> obj=&#123;&#125;;  </span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> index = <span class=\"number\">0</span>; index &lt; values.<span class=\"property\">length</span>; ++index)      </span><br><span class=\"line\">&#123;      </span><br><span class=\"line\"><span class=\"keyword\">var</span> temp=obj; <span class=\"comment\">//上一级       </span></span><br><span class=\"line\"><span class=\"keyword\">var</span> n=values[index].<span class=\"property\">name</span>;    </span><br><span class=\"line\"><span class=\"keyword\">if</span>(n.<span class=\"title function_\">indexOf</span>(<span class=\"string\">&quot;.&quot;</span>)&gt;-<span class=\"number\">1</span>)&#123;    </span><br><span class=\"line\"><span class=\"keyword\">var</span> arr=n.<span class=\"title function_\">split</span>(<span class=\"string\">&quot;.&quot;</span>);    </span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i=<span class=\"number\">0</span>;i&lt;arr.<span class=\"property\">length</span>-<span class=\"number\">1</span>;i++)&#123;       </span><br><span class=\"line\"><span class=\"keyword\">if</span>(arr[i].<span class=\"title function_\">indexOf</span>(<span class=\"string\">&quot;[&quot;</span>)&gt;-<span class=\"number\">1</span>)&#123;    </span><br><span class=\"line\"><span class=\"keyword\">var</span> a=arr[i].<span class=\"title function_\">substring</span>(<span class=\"number\">0</span>,arr[i].<span class=\"title function_\">indexOf</span>(<span class=\"string\">&quot;[&quot;</span>));    </span><br><span class=\"line\">temp[a]=temp[a]||[];    </span><br><span class=\"line\"><span class=\"keyword\">var</span> y=arr[i].<span class=\"title function_\">substring</span>(arr[i].<span class=\"title function_\">indexOf</span>(<span class=\"string\">&quot;[&quot;</span>)+<span class=\"number\">1</span>,arr[i].<span class=\"title function_\">indexOf</span>(<span class=\"string\">&quot;]&quot;</span>));    </span><br><span class=\"line\">temp[a][y]=temp[a][y]||&#123;&#125;;    </span><br><span class=\"line\">temp=temp[a][y];    </span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;    </span><br><span class=\"line\">temp[arr[i]]=temp[arr[i]] || &#123;&#125;;       </span><br><span class=\"line\">temp=temp[arr[i]];    </span><br><span class=\"line\">&#125;    </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">temp[arr[arr.<span class=\"property\">length</span>-<span class=\"number\">1</span>]]=values[index].<span class=\"property\">value</span>;         </span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;    </span><br><span class=\"line\"><span class=\"keyword\">if</span>(obj[n] !==<span class=\"literal\">undefined</span> &amp;&amp; obj[n]!=<span class=\"literal\">null</span>)&#123;    </span><br><span class=\"line\"><span class=\"keyword\">if</span>( !$.<span class=\"title function_\">isArray</span>(obj[n]))&#123;    </span><br><span class=\"line\"><span class=\"keyword\">var</span> v=obj[n];    </span><br><span class=\"line\">obj[n]=[];    </span><br><span class=\"line\">obj[n].<span class=\"title function_\">push</span>(v);    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            obj[n].<span class=\"title function_\">push</span>(values[index].<span class=\"property\">value</span>);    </span><br><span class=\"line\">         &#125;<span class=\"keyword\">else</span>&#123;     </span><br><span class=\"line\">             obj[n]=values[index].<span class=\"property\">value</span>;    </span><br><span class=\"line\">         &#125;    </span><br><span class=\"line\">     &#125;       </span><br><span class=\"line\">&#125;       </span><br><span class=\"line\"><span class=\"keyword\">return</span> obj;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>该轮子支持复杂对象，支持对象数组，支持简单属性</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">$(<span class=\"string\">&quot;#test-btn&quot;</span>).<span class=\"title function_\">on</span>(<span class=\"string\">&quot;click&quot;</span>,<span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> json=<span class=\"title function_\">form2Json</span>(&#123;  </span><br><span class=\"line\"><span class=\"attr\">form</span>:<span class=\"string\">&quot;#test-form&quot;</span>  </span><br><span class=\"line\">&#125;);  </span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(json);  </span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(json));  </span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>最终结果如下</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;a&quot;</span>:&#123;<span class=\"string\">&quot;b&quot;</span>:&#123;<span class=\"string\">&quot;c&quot;</span>:<span class=\"string\">&quot;abc&quot;</span>,<span class=\"string\">&quot;d&quot;</span>:<span class=\"string\">&quot;abd&quot;</span>&#125;,<span class=\"string\">&quot;f&quot;</span>:<span class=\"string\">&quot;af&quot;</span>&#125;,<span class=\"string\">&quot;x&quot;</span>:<span class=\"string\">&quot;x&quot;</span>,<span class=\"string\">&quot;y&quot;</span>:[<span class=\"string\">&quot;0&quot;</span>,<span class=\"string\">&quot;y2&quot;</span>],<span class=\"string\">&quot;m&quot;</span>:[&#123;<span class=\"string\">&quot;c&quot;</span>:<span class=\"string\">&quot;m0c&quot;</span>,<span class=\"string\">&quot;d&quot;</span>:<span class=\"string\">&quot;m0d&quot;</span>&#125;,&#123;<span class=\"string\">&quot;c&quot;</span>:<span class=\"string\">&quot;m1c&quot;</span>,<span class=\"string\">&quot;d&quot;</span>:<span class=\"string\">&quot;m1d&quot;</span>&#125;]&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"基于jquery把表单转成成json对象\"><a href=\"#基于jquery把表单转成成json对象\" class=\"headerlink\" title=\"基于jquery把表单转成成json对象\"></a>基于jquery把表单转成成json对象</h1><p>最近前端框架修改，小伙伴希望能像以前写jsp一样使用 对象.属性作为表单元素的name值</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"> &lt;form id=<span class=\"string\">&quot;test-form&quot;</span>&gt;   </span><br><span class=\"line\">   &lt;input name=&quot;a.b.c&quot; value=&quot;abc&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;a.b.d&quot; value=&quot;abd&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;x&quot; value=&quot;x&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;a.f&quot; value=&quot;af&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;y&quot; value=&quot;0&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;y&quot; value=&quot;y2&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;m[0].c&quot; value=&quot;m0c&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;m[0].d&quot; value=&quot;m0d&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;m[1].c&quot; value=&quot;m1c&quot;&gt;  </span><br><span class=\"line\">   &lt;input name=&quot;m[1].d&quot; value=&quot;m1d&quot;&gt;   </span><br><span class=\"line\">  &lt;input type=&quot;button&quot; id=&quot;test-btn&quot;&gt;  </span><br><span class=\"line\">&lt;/form&gt;  </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>我这种懒人第一反应肯定去找度娘，发现度娘居然没有，只好自己造了轮子。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">form2Json</span>(<span class=\"params\">params</span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> selector=params.<span class=\"property\">form</span>;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> values= $(selector).<span class=\"title function_\">serializeArray</span>();  </span><br><span class=\"line\"><span class=\"keyword\">var</span> obj=&#123;&#125;;  </span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> index = <span class=\"number\">0</span>; index &lt; values.<span class=\"property\">length</span>; ++index)      </span><br><span class=\"line\">&#123;      </span><br><span class=\"line\"><span class=\"keyword\">var</span> temp=obj; <span class=\"comment\">//上一级       </span></span><br><span class=\"line\"><span class=\"keyword\">var</span> n=values[index].<span class=\"property\">name</span>;    </span><br><span class=\"line\"><span class=\"keyword\">if</span>(n.<span class=\"title function_\">indexOf</span>(<span class=\"string\">&quot;.&quot;</span>)&gt;-<span class=\"number\">1</span>)&#123;    </span><br><span class=\"line\"><span class=\"keyword\">var</span> arr=n.<span class=\"title function_\">split</span>(<span class=\"string\">&quot;.&quot;</span>);    </span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i=<span class=\"number\">0</span>;i&lt;arr.<span class=\"property\">length</span>-<span class=\"number\">1</span>;i++)&#123;       </span><br><span class=\"line\"><span class=\"keyword\">if</span>(arr[i].<span class=\"title function_\">indexOf</span>(<span class=\"string\">&quot;[&quot;</span>)&gt;-<span class=\"number\">1</span>)&#123;    </span><br><span class=\"line\"><span class=\"keyword\">var</span> a=arr[i].<span class=\"title function_\">substring</span>(<span class=\"number\">0</span>,arr[i].<span class=\"title function_\">indexOf</span>(<span class=\"string\">&quot;[&quot;</span>));    </span><br><span class=\"line\">temp[a]=temp[a]||[];    </span><br><span class=\"line\"><span class=\"keyword\">var</span> y=arr[i].<span class=\"title function_\">substring</span>(arr[i].<span class=\"title function_\">indexOf</span>(<span class=\"string\">&quot;[&quot;</span>)+<span class=\"number\">1</span>,arr[i].<span class=\"title function_\">indexOf</span>(<span class=\"string\">&quot;]&quot;</span>));    </span><br><span class=\"line\">temp[a][y]=temp[a][y]||&#123;&#125;;    </span><br><span class=\"line\">temp=temp[a][y];    </span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;    </span><br><span class=\"line\">temp[arr[i]]=temp[arr[i]] || &#123;&#125;;       </span><br><span class=\"line\">temp=temp[arr[i]];    </span><br><span class=\"line\">&#125;    </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">temp[arr[arr.<span class=\"property\">length</span>-<span class=\"number\">1</span>]]=values[index].<span class=\"property\">value</span>;         </span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;    </span><br><span class=\"line\"><span class=\"keyword\">if</span>(obj[n] !==<span class=\"literal\">undefined</span> &amp;&amp; obj[n]!=<span class=\"literal\">null</span>)&#123;    </span><br><span class=\"line\"><span class=\"keyword\">if</span>( !$.<span class=\"title function_\">isArray</span>(obj[n]))&#123;    </span><br><span class=\"line\"><span class=\"keyword\">var</span> v=obj[n];    </span><br><span class=\"line\">obj[n]=[];    </span><br><span class=\"line\">obj[n].<span class=\"title function_\">push</span>(v);    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            obj[n].<span class=\"title function_\">push</span>(values[index].<span class=\"property\">value</span>);    </span><br><span class=\"line\">         &#125;<span class=\"keyword\">else</span>&#123;     </span><br><span class=\"line\">             obj[n]=values[index].<span class=\"property\">value</span>;    </span><br><span class=\"line\">         &#125;    </span><br><span class=\"line\">     &#125;       </span><br><span class=\"line\">&#125;       </span><br><span class=\"line\"><span class=\"keyword\">return</span> obj;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>该轮子支持复杂对象，支持对象数组，支持简单属性</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">$(<span class=\"string\">&quot;#test-btn&quot;</span>).<span class=\"title function_\">on</span>(<span class=\"string\">&quot;click&quot;</span>,<span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;  </span><br><span class=\"line\"><span class=\"keyword\">var</span> json=<span class=\"title function_\">form2Json</span>(&#123;  </span><br><span class=\"line\"><span class=\"attr\">form</span>:<span class=\"string\">&quot;#test-form&quot;</span>  </span><br><span class=\"line\">&#125;);  </span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(json);  </span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(json));  </span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>最终结果如下</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;a&quot;</span>:&#123;<span class=\"string\">&quot;b&quot;</span>:&#123;<span class=\"string\">&quot;c&quot;</span>:<span class=\"string\">&quot;abc&quot;</span>,<span class=\"string\">&quot;d&quot;</span>:<span class=\"string\">&quot;abd&quot;</span>&#125;,<span class=\"string\">&quot;f&quot;</span>:<span class=\"string\">&quot;af&quot;</span>&#125;,<span class=\"string\">&quot;x&quot;</span>:<span class=\"string\">&quot;x&quot;</span>,<span class=\"string\">&quot;y&quot;</span>:[<span class=\"string\">&quot;0&quot;</span>,<span class=\"string\">&quot;y2&quot;</span>],<span class=\"string\">&quot;m&quot;</span>:[&#123;<span class=\"string\">&quot;c&quot;</span>:<span class=\"string\">&quot;m0c&quot;</span>,<span class=\"string\">&quot;d&quot;</span>:<span class=\"string\">&quot;m0d&quot;</span>&#125;,&#123;<span class=\"string\">&quot;c&quot;</span>:<span class=\"string\">&quot;m1c&quot;</span>,<span class=\"string\">&quot;d&quot;</span>:<span class=\"string\">&quot;m1d&quot;</span>&#125;]&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>"},{"title":"并发容器和同步容器","abbrlink":302,"date":"2023-06-20T06:35:58.000Z","_content":"# 并发容器和同步容器\n\njava的同步容器有Vector和Hashtable。\nvecotor和hashtbale通过synchronized来锁定对容器状态的访问，例如get方法\n\n{% codeblock  lang:java   %}\n\n    public synchronized E get(int index) {\n    if (index >= elementCount)\n    throw new ArrayIndexOutOfBoundsException(index);\n    return elementData(index);\n    }\n\n{% endcodeblock %}\n同步容器类是线程安全的，但复合操作不一定是线程安全的，需要客户端额外加锁来保证线程安全。\n\n## 并发容器\n同步容器将所有对容器状态的访问都串行化，以实现线程安全。这种性能比较低，\njava5.0 引入了并发容器,在java.util.concurrent包下面\n\n## ConcurrentHashMap\nConcurrentHashMap采用了分段锁的设计，只有在同一个分段内才存在竞态关系，不同的分段锁之间没有锁竞争。\n**ConcurrentHashMap是弱一致性的，get，clear都是弱一致性的**\n","source":"_posts/并发容器和同步容器.md","raw":"---\ntitle: 并发容器和同步容器\ntags:\n  - java\nabbrlink: 302\ndate: 2023-06-20 14:35:58\n---\n# 并发容器和同步容器\n\njava的同步容器有Vector和Hashtable。\nvecotor和hashtbale通过synchronized来锁定对容器状态的访问，例如get方法\n\n{% codeblock  lang:java   %}\n\n    public synchronized E get(int index) {\n    if (index >= elementCount)\n    throw new ArrayIndexOutOfBoundsException(index);\n    return elementData(index);\n    }\n\n{% endcodeblock %}\n同步容器类是线程安全的，但复合操作不一定是线程安全的，需要客户端额外加锁来保证线程安全。\n\n## 并发容器\n同步容器将所有对容器状态的访问都串行化，以实现线程安全。这种性能比较低，\njava5.0 引入了并发容器,在java.util.concurrent包下面\n\n## ConcurrentHashMap\nConcurrentHashMap采用了分段锁的设计，只有在同一个分段内才存在竞态关系，不同的分段锁之间没有锁竞争。\n**ConcurrentHashMap是弱一致性的，get，clear都是弱一致性的**\n","slug":"并发容器和同步容器","published":1,"updated":"2023-12-05T02:48:12.740Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdjb001iorgo6jab6z8j","content":"<h1 id=\"并发容器和同步容器\"><a href=\"#并发容器和同步容器\" class=\"headerlink\" title=\"并发容器和同步容器\"></a>并发容器和同步容器</h1><p>java的同步容器有Vector和Hashtable。<br>vecotor和hashtbale通过synchronized来锁定对容器状态的访问，例如get方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> E <span class=\"title function_\">get</span><span class=\"params\">(<span class=\"type\">int</span> index)</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (index &gt;= elementCount)</span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayIndexOutOfBoundsException</span>(index);</span><br><span class=\"line\"><span class=\"keyword\">return</span> elementData(index);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>同步容器类是线程安全的，但复合操作不一定是线程安全的，需要客户端额外加锁来保证线程安全。</p>\n<h2 id=\"并发容器\"><a href=\"#并发容器\" class=\"headerlink\" title=\"并发容器\"></a>并发容器</h2><p>同步容器将所有对容器状态的访问都串行化，以实现线程安全。这种性能比较低，<br>java5.0 引入了并发容器,在java.util.concurrent包下面</p>\n<h2 id=\"ConcurrentHashMap\"><a href=\"#ConcurrentHashMap\" class=\"headerlink\" title=\"ConcurrentHashMap\"></a>ConcurrentHashMap</h2><p>ConcurrentHashMap采用了分段锁的设计，只有在同一个分段内才存在竞态关系，不同的分段锁之间没有锁竞争。<br><strong>ConcurrentHashMap是弱一致性的，get，clear都是弱一致性的</strong></p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"并发容器和同步容器\"><a href=\"#并发容器和同步容器\" class=\"headerlink\" title=\"并发容器和同步容器\"></a>并发容器和同步容器</h1><p>java的同步容器有Vector和Hashtable。<br>vecotor和hashtbale通过synchronized来锁定对容器状态的访问，例如get方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> E <span class=\"title function_\">get</span><span class=\"params\">(<span class=\"type\">int</span> index)</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (index &gt;= elementCount)</span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayIndexOutOfBoundsException</span>(index);</span><br><span class=\"line\"><span class=\"keyword\">return</span> elementData(index);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>同步容器类是线程安全的，但复合操作不一定是线程安全的，需要客户端额外加锁来保证线程安全。</p>\n<h2 id=\"并发容器\"><a href=\"#并发容器\" class=\"headerlink\" title=\"并发容器\"></a>并发容器</h2><p>同步容器将所有对容器状态的访问都串行化，以实现线程安全。这种性能比较低，<br>java5.0 引入了并发容器,在java.util.concurrent包下面</p>\n<h2 id=\"ConcurrentHashMap\"><a href=\"#ConcurrentHashMap\" class=\"headerlink\" title=\"ConcurrentHashMap\"></a>ConcurrentHashMap</h2><p>ConcurrentHashMap采用了分段锁的设计，只有在同一个分段内才存在竞态关系，不同的分段锁之间没有锁竞争。<br><strong>ConcurrentHashMap是弱一致性的，get，clear都是弱一致性的</strong></p>\n"},{"title":"浅谈分布式项目日志监控","abbrlink":4306,"date":"2023-06-20T05:48:20.000Z","_content":"# 浅谈分布式项目日志监控\n目前公司项目采用dubbo服务化升级之后，原先大而全的几个主要应用，拆散重构成多个分布式服务。\n这个公司业务架构和系统架构实现一次升级，并发和业务开发效率得到提升。\n但是事情是两面的，引入dubbo服务化之后，导致业务链路过长，日志分散。不能在使用原来的日志处理方式了。\n分布式情况下，每个日志分散到各自服务所在机器，\n日志的收集和分析使用原来古老的模式，肯定是过时了，集群和服务规模小还好，数量一大，我想不管是运维人员还是开发人员都会头疼。\n目前处理这个需求最为火热的中间套件，自然首选是ELK，ELK是java技术栈的。\n也符合目前公司需求。ELK的安装就不讲述了，感兴趣的可以查看官网或者自行百度，资料还是挺多的。\n确定了日志收集和分析的中间件，剩下一个就是日志埋点和怎么把日志串起来了。\n以前单个应用的时代，系统级别的日志可以通过aop解决。在分布式情况下对每一个独立服务而言，自身的日志系统还是通过aop解决，唯一需要的就是怎么把分散到各自不同应用的日志串起来。\n这个有个高大上的说法叫做业务链监控。\n目前国内开源的产品有大众点评的cat，是整套业务链监控解决方案。\n对于我公司目前来说太重了，我这边日志已经有elk，就没必要在额外引入cat。那如何自己实现呢。\n既然是链路，那自然有入口有出口。我们需要做的就是在入口出生成一个全局唯一的traceId，然后把这个traceId按照业务链路传递到各个服务中去。\ntraceId就是一根线，把各个服务的日志串起来。注意一点，服务的时间要同步，因为是根据来时间排序的。\ntraceId的生成，简单方案可以采用uuid，其次推荐使用twiiter的snowflake算法。\ntraceId的传递，需要根据rpc框架来实现了。dubbo框架采用dubbo的fiter来实现，参考代码如下：\n\n{% codeblock  lang:java   %}\n\n    // 调用过程拦截  \n    public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {  \n    //异步获取serviceId，没获取到不进行采样  \n    String serviceId = tracer.getServiceId(RpcContext.getContext().getUrl().getServiceInterface());  \n    if (serviceId == null) {  \n    Tracer.startTraceWork();  \n    return invoker.invoke(invocation);  \n    }        \n    long start = System.currentTimeMillis();  \n    RpcContext context = RpcContext.getContext();  \n    boolean isConsumerSide = context.isConsumerSide();  \n    Span span = null;  \n    Endpoint endpoint = null;  \n    try {  \n    endpoint = tracer.newEndPoint();  \n    endpoint.setServiceName(serviceId);  \n    endpoint.setIp(context.getLocalAddressString());  \n    endpoint.setPort(context.getLocalPort());  \n    if (context.isConsumerSide()) { //是否是消费者  \n    Span span1 = tracer.getParentSpan();  \n    if (span1 == null) { //为rootSpan  \n    span = tracer.newSpan(context.getMethodName(), endpoint, serviceId);//生成root Span  \n    } else {  \n    span = tracer.genSpan(span1.getTraceId(), span1.getId(), tracer.genSpanId(), context.getMethodName(), span1.isSample(), null);  \n    }  \n    } else if (context.isProviderSide()) {  \n    Long traceId, parentId, spanId;  \n    traceId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.TID));  \n    parentId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.PID));  \n    spanId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.SID));  \n    boolean isSample = (traceId != null);  \n    span = tracer.genSpan(traceId, parentId, spanId, context.getMethodName(), isSample, serviceId);  \n    }  \n    invokerBefore(invocation, span, endpoint, start);//记录annotation  \n    RpcInvocation invocation1 = (RpcInvocation) invocation;  \n    setAttachment(span, invocation1);//设置需要向下游传递的参数  \n    Result result = invoker.invoke(invocation);  \n    if (result.getException() != null){  \n    catchException(result.getException(), endpoint);  \n    }  \n    return result;  \n    }catch (RpcException e) {  \n    if (e.getCause() != null && e.getCause() instanceof TimeoutException){  \n    catchTimeoutException(e, endpoint);  \n    }else {  \n    catchException(e, endpoint);  \n    }  \n    throw e;  \n    }finally {  \n    if (span != null) {  \n    long end = System.currentTimeMillis();  \n    invokerAfter(invocation, endpoint, span, end, isConsumerSide);//调用后记录annotation  \n    }  \n    }  \n    }\n\n{% endcodeblock %}\n\ndubbo通过invocation.setAttachmen来在消费者和调用者之间传递traceId。\n如果是http接口调用实现的rpc建议采用在request的head里面传递traceId。\n在本地服务里面通过threadlocal变量来传递traceId。\n如果想打印sql语句，通过orm框架的拦截器机制实现，以下是mybatis的参考代码\n\n{% codeblock schema.xml lang:xml   %}\n\n    @Intercepts({ @Signature(type = Executor.class, method = \"update\", args = { MappedStatement.class, Object.class }),  \n    @Signature(type = Executor.class, method = \"query\", args = { MappedStatement.class, Object.class,  \n    RowBounds.class, ResultHandler.class }) })  \n    public class MidaiLogMybatisPlugn implements Interceptor {  \n    @Override  \n    public Object intercept(Invocation invocation) throws Throwable {    \n    Object result = null;  \n    //从当前线程获取trace  \n    MidaiLogTrace trace = MidaiLogTraceService.getMidaiLogTrace();  \n    if(trace !=null){  \n    Object[] arguments = invocation.getArgs();  \n    MidaiLogTraceService.traceSqlLog(trace.getTraceId(), getSqlStatement(arguments));  \n    }  \n    try {  \n    result = invocation.proceed();        \n    } catch (Exception e) {  \n    throw e;  \n    }  \n    return result;  \n    }    \n    @Override  \n    public Object plugin(Object target) {  \n    return Plugin.wrap(target, this); // mybatis提供的包装工具类  \n    }    \n    @Override  \n    public void setProperties(Properties properties) {  \n    }   \n    private String getSqlStatement(Object[] arguments) {  \n    MappedStatement mappedStatement = (MappedStatement) arguments[0];  \n    Object parameter = null;  \n    if (arguments.length > 1) {  \n    parameter = arguments[1];  \n    }  \n    String sqlId = mappedStatement.getId();  \n    BoundSql boundSql = mappedStatement.getBoundSql(parameter);  \n    Configuration configuration = mappedStatement.getConfiguration();  \n    String sql = showSql(configuration, boundSql);  \n    StringBuilder str = new StringBuilder(100);  \n    str.append(sqlId);  \n    str.append(\":\");  \n    str.append(sql);  \n    str.append(\":\");  \n    return str.toString();  \n    }    \n    public String showSql(Configuration configuration, BoundSql boundSql) {  \n    Object parameterObject = boundSql.getParameterObject();  \n    List<ParameterMapping> parameterMappings = boundSql.getParameterMappings();  \n    String sql = boundSql.getSql().replaceAll(\"[\\\\s]+\", \" \");  \n    if (parameterMappings.size() > 0 && parameterObject != null) {  \n    TypeHandlerRegistry typeHandlerRegistry = configuration.getTypeHandlerRegistry();  \n    if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) {  \n    sql = sql.replaceFirst(\"\\\\?\", getParameterValue(parameterObject));    \n    } else {  \n    MetaObject metaObject = configuration.newMetaObject(parameterObject);  \n    for (ParameterMapping parameterMapping : parameterMappings) {  \n    String propertyName = parameterMapping.getProperty();  \n    if (metaObject.hasGetter(propertyName)) {  \n    Object obj = metaObject.getValue(propertyName);  \n    sql = sql.replaceFirst(\"\\\\?\", getParameterValue(obj));  \n    } else if (boundSql.hasAdditionalParameter(propertyName)) {  \n    Object obj = boundSql.getAdditionalParameter(propertyName);  \n    sql = sql.replaceFirst(\"\\\\?\", getParameterValue(obj));  \n    }  \n    }  \n    }  \n    }  \n    return sql;  \n    }   \n    private static String getParameterValue(Object obj) {  \n    String value = null;  \n    if (obj instanceof String) {  \n    value = \"‘\" + obj.toString() + \"‘\";  \n    } else if (obj instanceof Date) {  \n    DateFormat formatter = DateFormat.getDateTimeInstance(DateFormat.DEFAULT, DateFormat.DEFAULT, Locale.CHINA);  \n    value = \"‘\" + formatter.format(new Date()) + \"‘\";  \n    } else {  \n    if (obj != null) {  \n    value = obj.toString();  \n    } else {  \n    value = \"\";  \n    }\n    \n            }  \n            return value;  \n        }  \n    }\n\n{% endcodeblock %}\n\n当系统并发达到一定数量级，log4j日志打印本身会成为瓶颈，这个时候需要mq来解耦了，\n不在打印日志，而是发送mq消息，由mq消费端处理。因为目前公司项目并发数量还不足以导致该问题，因此尚未采用。\nelk收集日志之后，通过kibana可以提供搜索。\n\n{% asset_img 1.png  image %}\n\n剩下最后的工作量就是提供一个web界面来更好的分析和展示数据。","source":"_posts/浅谈分布式项目日志监控.md","raw":"---\ntitle: 浅谈分布式项目日志监控\ntags:\n  - 架构设计\nabbrlink: 4306\ndate: 2023-06-20 13:48:20\n---\n# 浅谈分布式项目日志监控\n目前公司项目采用dubbo服务化升级之后，原先大而全的几个主要应用，拆散重构成多个分布式服务。\n这个公司业务架构和系统架构实现一次升级，并发和业务开发效率得到提升。\n但是事情是两面的，引入dubbo服务化之后，导致业务链路过长，日志分散。不能在使用原来的日志处理方式了。\n分布式情况下，每个日志分散到各自服务所在机器，\n日志的收集和分析使用原来古老的模式，肯定是过时了，集群和服务规模小还好，数量一大，我想不管是运维人员还是开发人员都会头疼。\n目前处理这个需求最为火热的中间套件，自然首选是ELK，ELK是java技术栈的。\n也符合目前公司需求。ELK的安装就不讲述了，感兴趣的可以查看官网或者自行百度，资料还是挺多的。\n确定了日志收集和分析的中间件，剩下一个就是日志埋点和怎么把日志串起来了。\n以前单个应用的时代，系统级别的日志可以通过aop解决。在分布式情况下对每一个独立服务而言，自身的日志系统还是通过aop解决，唯一需要的就是怎么把分散到各自不同应用的日志串起来。\n这个有个高大上的说法叫做业务链监控。\n目前国内开源的产品有大众点评的cat，是整套业务链监控解决方案。\n对于我公司目前来说太重了，我这边日志已经有elk，就没必要在额外引入cat。那如何自己实现呢。\n既然是链路，那自然有入口有出口。我们需要做的就是在入口出生成一个全局唯一的traceId，然后把这个traceId按照业务链路传递到各个服务中去。\ntraceId就是一根线，把各个服务的日志串起来。注意一点，服务的时间要同步，因为是根据来时间排序的。\ntraceId的生成，简单方案可以采用uuid，其次推荐使用twiiter的snowflake算法。\ntraceId的传递，需要根据rpc框架来实现了。dubbo框架采用dubbo的fiter来实现，参考代码如下：\n\n{% codeblock  lang:java   %}\n\n    // 调用过程拦截  \n    public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {  \n    //异步获取serviceId，没获取到不进行采样  \n    String serviceId = tracer.getServiceId(RpcContext.getContext().getUrl().getServiceInterface());  \n    if (serviceId == null) {  \n    Tracer.startTraceWork();  \n    return invoker.invoke(invocation);  \n    }        \n    long start = System.currentTimeMillis();  \n    RpcContext context = RpcContext.getContext();  \n    boolean isConsumerSide = context.isConsumerSide();  \n    Span span = null;  \n    Endpoint endpoint = null;  \n    try {  \n    endpoint = tracer.newEndPoint();  \n    endpoint.setServiceName(serviceId);  \n    endpoint.setIp(context.getLocalAddressString());  \n    endpoint.setPort(context.getLocalPort());  \n    if (context.isConsumerSide()) { //是否是消费者  \n    Span span1 = tracer.getParentSpan();  \n    if (span1 == null) { //为rootSpan  \n    span = tracer.newSpan(context.getMethodName(), endpoint, serviceId);//生成root Span  \n    } else {  \n    span = tracer.genSpan(span1.getTraceId(), span1.getId(), tracer.genSpanId(), context.getMethodName(), span1.isSample(), null);  \n    }  \n    } else if (context.isProviderSide()) {  \n    Long traceId, parentId, spanId;  \n    traceId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.TID));  \n    parentId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.PID));  \n    spanId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.SID));  \n    boolean isSample = (traceId != null);  \n    span = tracer.genSpan(traceId, parentId, spanId, context.getMethodName(), isSample, serviceId);  \n    }  \n    invokerBefore(invocation, span, endpoint, start);//记录annotation  \n    RpcInvocation invocation1 = (RpcInvocation) invocation;  \n    setAttachment(span, invocation1);//设置需要向下游传递的参数  \n    Result result = invoker.invoke(invocation);  \n    if (result.getException() != null){  \n    catchException(result.getException(), endpoint);  \n    }  \n    return result;  \n    }catch (RpcException e) {  \n    if (e.getCause() != null && e.getCause() instanceof TimeoutException){  \n    catchTimeoutException(e, endpoint);  \n    }else {  \n    catchException(e, endpoint);  \n    }  \n    throw e;  \n    }finally {  \n    if (span != null) {  \n    long end = System.currentTimeMillis();  \n    invokerAfter(invocation, endpoint, span, end, isConsumerSide);//调用后记录annotation  \n    }  \n    }  \n    }\n\n{% endcodeblock %}\n\ndubbo通过invocation.setAttachmen来在消费者和调用者之间传递traceId。\n如果是http接口调用实现的rpc建议采用在request的head里面传递traceId。\n在本地服务里面通过threadlocal变量来传递traceId。\n如果想打印sql语句，通过orm框架的拦截器机制实现，以下是mybatis的参考代码\n\n{% codeblock schema.xml lang:xml   %}\n\n    @Intercepts({ @Signature(type = Executor.class, method = \"update\", args = { MappedStatement.class, Object.class }),  \n    @Signature(type = Executor.class, method = \"query\", args = { MappedStatement.class, Object.class,  \n    RowBounds.class, ResultHandler.class }) })  \n    public class MidaiLogMybatisPlugn implements Interceptor {  \n    @Override  \n    public Object intercept(Invocation invocation) throws Throwable {    \n    Object result = null;  \n    //从当前线程获取trace  \n    MidaiLogTrace trace = MidaiLogTraceService.getMidaiLogTrace();  \n    if(trace !=null){  \n    Object[] arguments = invocation.getArgs();  \n    MidaiLogTraceService.traceSqlLog(trace.getTraceId(), getSqlStatement(arguments));  \n    }  \n    try {  \n    result = invocation.proceed();        \n    } catch (Exception e) {  \n    throw e;  \n    }  \n    return result;  \n    }    \n    @Override  \n    public Object plugin(Object target) {  \n    return Plugin.wrap(target, this); // mybatis提供的包装工具类  \n    }    \n    @Override  \n    public void setProperties(Properties properties) {  \n    }   \n    private String getSqlStatement(Object[] arguments) {  \n    MappedStatement mappedStatement = (MappedStatement) arguments[0];  \n    Object parameter = null;  \n    if (arguments.length > 1) {  \n    parameter = arguments[1];  \n    }  \n    String sqlId = mappedStatement.getId();  \n    BoundSql boundSql = mappedStatement.getBoundSql(parameter);  \n    Configuration configuration = mappedStatement.getConfiguration();  \n    String sql = showSql(configuration, boundSql);  \n    StringBuilder str = new StringBuilder(100);  \n    str.append(sqlId);  \n    str.append(\":\");  \n    str.append(sql);  \n    str.append(\":\");  \n    return str.toString();  \n    }    \n    public String showSql(Configuration configuration, BoundSql boundSql) {  \n    Object parameterObject = boundSql.getParameterObject();  \n    List<ParameterMapping> parameterMappings = boundSql.getParameterMappings();  \n    String sql = boundSql.getSql().replaceAll(\"[\\\\s]+\", \" \");  \n    if (parameterMappings.size() > 0 && parameterObject != null) {  \n    TypeHandlerRegistry typeHandlerRegistry = configuration.getTypeHandlerRegistry();  \n    if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) {  \n    sql = sql.replaceFirst(\"\\\\?\", getParameterValue(parameterObject));    \n    } else {  \n    MetaObject metaObject = configuration.newMetaObject(parameterObject);  \n    for (ParameterMapping parameterMapping : parameterMappings) {  \n    String propertyName = parameterMapping.getProperty();  \n    if (metaObject.hasGetter(propertyName)) {  \n    Object obj = metaObject.getValue(propertyName);  \n    sql = sql.replaceFirst(\"\\\\?\", getParameterValue(obj));  \n    } else if (boundSql.hasAdditionalParameter(propertyName)) {  \n    Object obj = boundSql.getAdditionalParameter(propertyName);  \n    sql = sql.replaceFirst(\"\\\\?\", getParameterValue(obj));  \n    }  \n    }  \n    }  \n    }  \n    return sql;  \n    }   \n    private static String getParameterValue(Object obj) {  \n    String value = null;  \n    if (obj instanceof String) {  \n    value = \"‘\" + obj.toString() + \"‘\";  \n    } else if (obj instanceof Date) {  \n    DateFormat formatter = DateFormat.getDateTimeInstance(DateFormat.DEFAULT, DateFormat.DEFAULT, Locale.CHINA);  \n    value = \"‘\" + formatter.format(new Date()) + \"‘\";  \n    } else {  \n    if (obj != null) {  \n    value = obj.toString();  \n    } else {  \n    value = \"\";  \n    }\n    \n            }  \n            return value;  \n        }  \n    }\n\n{% endcodeblock %}\n\n当系统并发达到一定数量级，log4j日志打印本身会成为瓶颈，这个时候需要mq来解耦了，\n不在打印日志，而是发送mq消息，由mq消费端处理。因为目前公司项目并发数量还不足以导致该问题，因此尚未采用。\nelk收集日志之后，通过kibana可以提供搜索。\n\n{% asset_img 1.png  image %}\n\n剩下最后的工作量就是提供一个web界面来更好的分析和展示数据。","slug":"浅谈分布式项目日志监控","published":1,"updated":"2023-12-05T02:48:12.741Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdjb001korgobacb82dz","content":"<h1 id=\"浅谈分布式项目日志监控\"><a href=\"#浅谈分布式项目日志监控\" class=\"headerlink\" title=\"浅谈分布式项目日志监控\"></a>浅谈分布式项目日志监控</h1><p>目前公司项目采用dubbo服务化升级之后，原先大而全的几个主要应用，拆散重构成多个分布式服务。<br>这个公司业务架构和系统架构实现一次升级，并发和业务开发效率得到提升。<br>但是事情是两面的，引入dubbo服务化之后，导致业务链路过长，日志分散。不能在使用原来的日志处理方式了。<br>分布式情况下，每个日志分散到各自服务所在机器，<br>日志的收集和分析使用原来古老的模式，肯定是过时了，集群和服务规模小还好，数量一大，我想不管是运维人员还是开发人员都会头疼。<br>目前处理这个需求最为火热的中间套件，自然首选是ELK，ELK是java技术栈的。<br>也符合目前公司需求。ELK的安装就不讲述了，感兴趣的可以查看官网或者自行百度，资料还是挺多的。<br>确定了日志收集和分析的中间件，剩下一个就是日志埋点和怎么把日志串起来了。<br>以前单个应用的时代，系统级别的日志可以通过aop解决。在分布式情况下对每一个独立服务而言，自身的日志系统还是通过aop解决，唯一需要的就是怎么把分散到各自不同应用的日志串起来。<br>这个有个高大上的说法叫做业务链监控。<br>目前国内开源的产品有大众点评的cat，是整套业务链监控解决方案。<br>对于我公司目前来说太重了，我这边日志已经有elk，就没必要在额外引入cat。那如何自己实现呢。<br>既然是链路，那自然有入口有出口。我们需要做的就是在入口出生成一个全局唯一的traceId，然后把这个traceId按照业务链路传递到各个服务中去。<br>traceId就是一根线，把各个服务的日志串起来。注意一点，服务的时间要同步，因为是根据来时间排序的。<br>traceId的生成，简单方案可以采用uuid，其次推荐使用twiiter的snowflake算法。<br>traceId的传递，需要根据rpc框架来实现了。dubbo框架采用dubbo的fiter来实现，参考代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 调用过程拦截  </span></span><br><span class=\"line\"><span class=\"keyword\">public</span> Result <span class=\"title function_\">invoke</span><span class=\"params\">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class=\"keyword\">throws</span> RpcException &#123;  </span><br><span class=\"line\"><span class=\"comment\">//异步获取serviceId，没获取到不进行采样  </span></span><br><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">serviceId</span> <span class=\"operator\">=</span> tracer.getServiceId(RpcContext.getContext().getUrl().getServiceInterface());  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (serviceId == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">Tracer.startTraceWork();  </span><br><span class=\"line\"><span class=\"keyword\">return</span> invoker.invoke(invocation);  </span><br><span class=\"line\">&#125;        </span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"variable\">start</span> <span class=\"operator\">=</span> System.currentTimeMillis();  </span><br><span class=\"line\"><span class=\"type\">RpcContext</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> RpcContext.getContext();  </span><br><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"variable\">isConsumerSide</span> <span class=\"operator\">=</span> context.isConsumerSide();  </span><br><span class=\"line\"><span class=\"type\">Span</span> <span class=\"variable\">span</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;  </span><br><span class=\"line\"><span class=\"type\">Endpoint</span> <span class=\"variable\">endpoint</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">endpoint = tracer.newEndPoint();  </span><br><span class=\"line\">endpoint.setServiceName(serviceId);  </span><br><span class=\"line\">endpoint.setIp(context.getLocalAddressString());  </span><br><span class=\"line\">endpoint.setPort(context.getLocalPort());  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (context.isConsumerSide()) &#123; <span class=\"comment\">//是否是消费者  </span></span><br><span class=\"line\"><span class=\"type\">Span</span> <span class=\"variable\">span1</span> <span class=\"operator\">=</span> tracer.getParentSpan();  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (span1 == <span class=\"literal\">null</span>) &#123; <span class=\"comment\">//为rootSpan  </span></span><br><span class=\"line\">span = tracer.newSpan(context.getMethodName(), endpoint, serviceId);<span class=\"comment\">//生成root Span  </span></span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\">span = tracer.genSpan(span1.getTraceId(), span1.getId(), tracer.genSpanId(), context.getMethodName(), span1.isSample(), <span class=\"literal\">null</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (context.isProviderSide()) &#123;  </span><br><span class=\"line\">Long traceId, parentId, spanId;  </span><br><span class=\"line\">traceId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.TID));  </span><br><span class=\"line\">parentId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.PID));  </span><br><span class=\"line\">spanId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.SID));  </span><br><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"variable\">isSample</span> <span class=\"operator\">=</span> (traceId != <span class=\"literal\">null</span>);  </span><br><span class=\"line\">span = tracer.genSpan(traceId, parentId, spanId, context.getMethodName(), isSample, serviceId);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">invokerBefore(invocation, span, endpoint, start);<span class=\"comment\">//记录annotation  </span></span><br><span class=\"line\"><span class=\"type\">RpcInvocation</span> <span class=\"variable\">invocation1</span> <span class=\"operator\">=</span> (RpcInvocation) invocation;  </span><br><span class=\"line\">setAttachment(span, invocation1);<span class=\"comment\">//设置需要向下游传递的参数  </span></span><br><span class=\"line\"><span class=\"type\">Result</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> invoker.invoke(invocation);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (result.getException() != <span class=\"literal\">null</span>)&#123;  </span><br><span class=\"line\">catchException(result.getException(), endpoint);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> result;  </span><br><span class=\"line\">&#125;<span class=\"keyword\">catch</span> (RpcException e) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (e.getCause() != <span class=\"literal\">null</span> &amp;&amp; e.getCause() <span class=\"keyword\">instanceof</span> TimeoutException)&#123;  </span><br><span class=\"line\">catchTimeoutException(e, endpoint);  </span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\">catchException(e, endpoint);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> e;  </span><br><span class=\"line\">&#125;<span class=\"keyword\">finally</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (span != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"variable\">end</span> <span class=\"operator\">=</span> System.currentTimeMillis();  </span><br><span class=\"line\">invokerAfter(invocation, endpoint, span, end, isConsumerSide);<span class=\"comment\">//调用后记录annotation  </span></span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>dubbo通过invocation.setAttachmen来在消费者和调用者之间传递traceId。<br>如果是http接口调用实现的rpc建议采用在request的head里面传递traceId。<br>在本地服务里面通过threadlocal变量来传递traceId。<br>如果想打印sql语句，通过orm框架的拦截器机制实现，以下是mybatis的参考代码</p>\n<figure class=\"highlight xml\"><figcaption><span>schema.xml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">@Intercepts(&#123; @Signature(type = Executor.class, method = &quot;update&quot;, args = &#123; MappedStatement.class, Object.class &#125;),  </span><br><span class=\"line\">@Signature(type = Executor.class, method = &quot;query&quot;, args = &#123; MappedStatement.class, Object.class,  </span><br><span class=\"line\">RowBounds.class, ResultHandler.class &#125;) &#125;)  </span><br><span class=\"line\">public class MidaiLogMybatisPlugn implements Interceptor &#123;  </span><br><span class=\"line\">@Override  </span><br><span class=\"line\">public Object intercept(Invocation invocation) throws Throwable &#123;    </span><br><span class=\"line\">Object result = null;  </span><br><span class=\"line\">//从当前线程获取trace  </span><br><span class=\"line\">MidaiLogTrace trace = MidaiLogTraceService.getMidaiLogTrace();  </span><br><span class=\"line\">if(trace !=null)&#123;  </span><br><span class=\"line\">Object[] arguments = invocation.getArgs();  </span><br><span class=\"line\">MidaiLogTraceService.traceSqlLog(trace.getTraceId(), getSqlStatement(arguments));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">try &#123;  </span><br><span class=\"line\">result = invocation.proceed();        </span><br><span class=\"line\">&#125; catch (Exception e) &#123;  </span><br><span class=\"line\">throw e;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">return result;  </span><br><span class=\"line\">&#125;    </span><br><span class=\"line\">@Override  </span><br><span class=\"line\">public Object plugin(Object target) &#123;  </span><br><span class=\"line\">return Plugin.wrap(target, this); // mybatis提供的包装工具类  </span><br><span class=\"line\">&#125;    </span><br><span class=\"line\">@Override  </span><br><span class=\"line\">public void setProperties(Properties properties) &#123;  </span><br><span class=\"line\">&#125;   </span><br><span class=\"line\">private String getSqlStatement(Object[] arguments) &#123;  </span><br><span class=\"line\">MappedStatement mappedStatement = (MappedStatement) arguments[0];  </span><br><span class=\"line\">Object parameter = null;  </span><br><span class=\"line\">if (arguments.length &gt; 1) &#123;  </span><br><span class=\"line\">parameter = arguments[1];  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">String sqlId = mappedStatement.getId();  </span><br><span class=\"line\">BoundSql boundSql = mappedStatement.getBoundSql(parameter);  </span><br><span class=\"line\">Configuration configuration = mappedStatement.getConfiguration();  </span><br><span class=\"line\">String sql = showSql(configuration, boundSql);  </span><br><span class=\"line\">StringBuilder str = new StringBuilder(100);  </span><br><span class=\"line\">str.append(sqlId);  </span><br><span class=\"line\">str.append(&quot;:&quot;);  </span><br><span class=\"line\">str.append(sql);  </span><br><span class=\"line\">str.append(&quot;:&quot;);  </span><br><span class=\"line\">return str.toString();  </span><br><span class=\"line\">&#125;    </span><br><span class=\"line\">public String showSql(Configuration configuration, BoundSql boundSql) &#123;  </span><br><span class=\"line\">Object parameterObject = boundSql.getParameterObject();  </span><br><span class=\"line\">List<span class=\"tag\">&lt;<span class=\"name\">ParameterMapping</span>&gt;</span> parameterMappings = boundSql.getParameterMappings();  </span><br><span class=\"line\">String sql = boundSql.getSql().replaceAll(&quot;[\\\\s]+&quot;, &quot; &quot;);  </span><br><span class=\"line\">if (parameterMappings.size() &gt; 0 &amp;&amp; parameterObject != null) &#123;  </span><br><span class=\"line\">TypeHandlerRegistry typeHandlerRegistry = configuration.getTypeHandlerRegistry();  </span><br><span class=\"line\">if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;  </span><br><span class=\"line\">sql = sql.replaceFirst(&quot;\\\\?&quot;, getParameterValue(parameterObject));    </span><br><span class=\"line\">&#125; else &#123;  </span><br><span class=\"line\">MetaObject metaObject = configuration.newMetaObject(parameterObject);  </span><br><span class=\"line\">for (ParameterMapping parameterMapping : parameterMappings) &#123;  </span><br><span class=\"line\">String propertyName = parameterMapping.getProperty();  </span><br><span class=\"line\">if (metaObject.hasGetter(propertyName)) &#123;  </span><br><span class=\"line\">Object obj = metaObject.getValue(propertyName);  </span><br><span class=\"line\">sql = sql.replaceFirst(&quot;\\\\?&quot;, getParameterValue(obj));  </span><br><span class=\"line\">&#125; else if (boundSql.hasAdditionalParameter(propertyName)) &#123;  </span><br><span class=\"line\">Object obj = boundSql.getAdditionalParameter(propertyName);  </span><br><span class=\"line\">sql = sql.replaceFirst(&quot;\\\\?&quot;, getParameterValue(obj));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">return sql;  </span><br><span class=\"line\">&#125;   </span><br><span class=\"line\">private static String getParameterValue(Object obj) &#123;  </span><br><span class=\"line\">String value = null;  </span><br><span class=\"line\">if (obj instanceof String) &#123;  </span><br><span class=\"line\">value = &quot;‘&quot; + obj.toString() + &quot;‘&quot;;  </span><br><span class=\"line\">&#125; else if (obj instanceof Date) &#123;  </span><br><span class=\"line\">DateFormat formatter = DateFormat.getDateTimeInstance(DateFormat.DEFAULT, DateFormat.DEFAULT, Locale.CHINA);  </span><br><span class=\"line\">value = &quot;‘&quot; + formatter.format(new Date()) + &quot;‘&quot;;  </span><br><span class=\"line\">&#125; else &#123;  </span><br><span class=\"line\">if (obj != null) &#123;  </span><br><span class=\"line\">value = obj.toString();  </span><br><span class=\"line\">&#125; else &#123;  </span><br><span class=\"line\">value = &quot;&quot;;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">        return value;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>当系统并发达到一定数量级，log4j日志打印本身会成为瓶颈，这个时候需要mq来解耦了，<br>不在打印日志，而是发送mq消息，由mq消费端处理。因为目前公司项目并发数量还不足以导致该问题，因此尚未采用。<br>elk收集日志之后，通过kibana可以提供搜索。</p>\n<img src=\"/202306204306/1.png\" class=\"\" title=\"image\">\n\n<p>剩下最后的工作量就是提供一个web界面来更好的分析和展示数据。</p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"浅谈分布式项目日志监控\"><a href=\"#浅谈分布式项目日志监控\" class=\"headerlink\" title=\"浅谈分布式项目日志监控\"></a>浅谈分布式项目日志监控</h1><p>目前公司项目采用dubbo服务化升级之后，原先大而全的几个主要应用，拆散重构成多个分布式服务。<br>这个公司业务架构和系统架构实现一次升级，并发和业务开发效率得到提升。<br>但是事情是两面的，引入dubbo服务化之后，导致业务链路过长，日志分散。不能在使用原来的日志处理方式了。<br>分布式情况下，每个日志分散到各自服务所在机器，<br>日志的收集和分析使用原来古老的模式，肯定是过时了，集群和服务规模小还好，数量一大，我想不管是运维人员还是开发人员都会头疼。<br>目前处理这个需求最为火热的中间套件，自然首选是ELK，ELK是java技术栈的。<br>也符合目前公司需求。ELK的安装就不讲述了，感兴趣的可以查看官网或者自行百度，资料还是挺多的。<br>确定了日志收集和分析的中间件，剩下一个就是日志埋点和怎么把日志串起来了。<br>以前单个应用的时代，系统级别的日志可以通过aop解决。在分布式情况下对每一个独立服务而言，自身的日志系统还是通过aop解决，唯一需要的就是怎么把分散到各自不同应用的日志串起来。<br>这个有个高大上的说法叫做业务链监控。<br>目前国内开源的产品有大众点评的cat，是整套业务链监控解决方案。<br>对于我公司目前来说太重了，我这边日志已经有elk，就没必要在额外引入cat。那如何自己实现呢。<br>既然是链路，那自然有入口有出口。我们需要做的就是在入口出生成一个全局唯一的traceId，然后把这个traceId按照业务链路传递到各个服务中去。<br>traceId就是一根线，把各个服务的日志串起来。注意一点，服务的时间要同步，因为是根据来时间排序的。<br>traceId的生成，简单方案可以采用uuid，其次推荐使用twiiter的snowflake算法。<br>traceId的传递，需要根据rpc框架来实现了。dubbo框架采用dubbo的fiter来实现，参考代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 调用过程拦截  </span></span><br><span class=\"line\"><span class=\"keyword\">public</span> Result <span class=\"title function_\">invoke</span><span class=\"params\">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class=\"keyword\">throws</span> RpcException &#123;  </span><br><span class=\"line\"><span class=\"comment\">//异步获取serviceId，没获取到不进行采样  </span></span><br><span class=\"line\"><span class=\"type\">String</span> <span class=\"variable\">serviceId</span> <span class=\"operator\">=</span> tracer.getServiceId(RpcContext.getContext().getUrl().getServiceInterface());  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (serviceId == <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\">Tracer.startTraceWork();  </span><br><span class=\"line\"><span class=\"keyword\">return</span> invoker.invoke(invocation);  </span><br><span class=\"line\">&#125;        </span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"variable\">start</span> <span class=\"operator\">=</span> System.currentTimeMillis();  </span><br><span class=\"line\"><span class=\"type\">RpcContext</span> <span class=\"variable\">context</span> <span class=\"operator\">=</span> RpcContext.getContext();  </span><br><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"variable\">isConsumerSide</span> <span class=\"operator\">=</span> context.isConsumerSide();  </span><br><span class=\"line\"><span class=\"type\">Span</span> <span class=\"variable\">span</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;  </span><br><span class=\"line\"><span class=\"type\">Endpoint</span> <span class=\"variable\">endpoint</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;  </span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;  </span><br><span class=\"line\">endpoint = tracer.newEndPoint();  </span><br><span class=\"line\">endpoint.setServiceName(serviceId);  </span><br><span class=\"line\">endpoint.setIp(context.getLocalAddressString());  </span><br><span class=\"line\">endpoint.setPort(context.getLocalPort());  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (context.isConsumerSide()) &#123; <span class=\"comment\">//是否是消费者  </span></span><br><span class=\"line\"><span class=\"type\">Span</span> <span class=\"variable\">span1</span> <span class=\"operator\">=</span> tracer.getParentSpan();  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (span1 == <span class=\"literal\">null</span>) &#123; <span class=\"comment\">//为rootSpan  </span></span><br><span class=\"line\">span = tracer.newSpan(context.getMethodName(), endpoint, serviceId);<span class=\"comment\">//生成root Span  </span></span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\">span = tracer.genSpan(span1.getTraceId(), span1.getId(), tracer.genSpanId(), context.getMethodName(), span1.isSample(), <span class=\"literal\">null</span>);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (context.isProviderSide()) &#123;  </span><br><span class=\"line\">Long traceId, parentId, spanId;  </span><br><span class=\"line\">traceId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.TID));  </span><br><span class=\"line\">parentId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.PID));  </span><br><span class=\"line\">spanId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.SID));  </span><br><span class=\"line\"><span class=\"type\">boolean</span> <span class=\"variable\">isSample</span> <span class=\"operator\">=</span> (traceId != <span class=\"literal\">null</span>);  </span><br><span class=\"line\">span = tracer.genSpan(traceId, parentId, spanId, context.getMethodName(), isSample, serviceId);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">invokerBefore(invocation, span, endpoint, start);<span class=\"comment\">//记录annotation  </span></span><br><span class=\"line\"><span class=\"type\">RpcInvocation</span> <span class=\"variable\">invocation1</span> <span class=\"operator\">=</span> (RpcInvocation) invocation;  </span><br><span class=\"line\">setAttachment(span, invocation1);<span class=\"comment\">//设置需要向下游传递的参数  </span></span><br><span class=\"line\"><span class=\"type\">Result</span> <span class=\"variable\">result</span> <span class=\"operator\">=</span> invoker.invoke(invocation);  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (result.getException() != <span class=\"literal\">null</span>)&#123;  </span><br><span class=\"line\">catchException(result.getException(), endpoint);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">return</span> result;  </span><br><span class=\"line\">&#125;<span class=\"keyword\">catch</span> (RpcException e) &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (e.getCause() != <span class=\"literal\">null</span> &amp;&amp; e.getCause() <span class=\"keyword\">instanceof</span> TimeoutException)&#123;  </span><br><span class=\"line\">catchTimeoutException(e, endpoint);  </span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> &#123;  </span><br><span class=\"line\">catchException(e, endpoint);  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"><span class=\"keyword\">throw</span> e;  </span><br><span class=\"line\">&#125;<span class=\"keyword\">finally</span> &#123;  </span><br><span class=\"line\"><span class=\"keyword\">if</span> (span != <span class=\"literal\">null</span>) &#123;  </span><br><span class=\"line\"><span class=\"type\">long</span> <span class=\"variable\">end</span> <span class=\"operator\">=</span> System.currentTimeMillis();  </span><br><span class=\"line\">invokerAfter(invocation, endpoint, span, end, isConsumerSide);<span class=\"comment\">//调用后记录annotation  </span></span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>dubbo通过invocation.setAttachmen来在消费者和调用者之间传递traceId。<br>如果是http接口调用实现的rpc建议采用在request的head里面传递traceId。<br>在本地服务里面通过threadlocal变量来传递traceId。<br>如果想打印sql语句，通过orm框架的拦截器机制实现，以下是mybatis的参考代码</p>\n<figure class=\"highlight xml\"><figcaption><span>schema.xml</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">@Intercepts(&#123; @Signature(type = Executor.class, method = &quot;update&quot;, args = &#123; MappedStatement.class, Object.class &#125;),  </span><br><span class=\"line\">@Signature(type = Executor.class, method = &quot;query&quot;, args = &#123; MappedStatement.class, Object.class,  </span><br><span class=\"line\">RowBounds.class, ResultHandler.class &#125;) &#125;)  </span><br><span class=\"line\">public class MidaiLogMybatisPlugn implements Interceptor &#123;  </span><br><span class=\"line\">@Override  </span><br><span class=\"line\">public Object intercept(Invocation invocation) throws Throwable &#123;    </span><br><span class=\"line\">Object result = null;  </span><br><span class=\"line\">//从当前线程获取trace  </span><br><span class=\"line\">MidaiLogTrace trace = MidaiLogTraceService.getMidaiLogTrace();  </span><br><span class=\"line\">if(trace !=null)&#123;  </span><br><span class=\"line\">Object[] arguments = invocation.getArgs();  </span><br><span class=\"line\">MidaiLogTraceService.traceSqlLog(trace.getTraceId(), getSqlStatement(arguments));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">try &#123;  </span><br><span class=\"line\">result = invocation.proceed();        </span><br><span class=\"line\">&#125; catch (Exception e) &#123;  </span><br><span class=\"line\">throw e;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">return result;  </span><br><span class=\"line\">&#125;    </span><br><span class=\"line\">@Override  </span><br><span class=\"line\">public Object plugin(Object target) &#123;  </span><br><span class=\"line\">return Plugin.wrap(target, this); // mybatis提供的包装工具类  </span><br><span class=\"line\">&#125;    </span><br><span class=\"line\">@Override  </span><br><span class=\"line\">public void setProperties(Properties properties) &#123;  </span><br><span class=\"line\">&#125;   </span><br><span class=\"line\">private String getSqlStatement(Object[] arguments) &#123;  </span><br><span class=\"line\">MappedStatement mappedStatement = (MappedStatement) arguments[0];  </span><br><span class=\"line\">Object parameter = null;  </span><br><span class=\"line\">if (arguments.length &gt; 1) &#123;  </span><br><span class=\"line\">parameter = arguments[1];  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">String sqlId = mappedStatement.getId();  </span><br><span class=\"line\">BoundSql boundSql = mappedStatement.getBoundSql(parameter);  </span><br><span class=\"line\">Configuration configuration = mappedStatement.getConfiguration();  </span><br><span class=\"line\">String sql = showSql(configuration, boundSql);  </span><br><span class=\"line\">StringBuilder str = new StringBuilder(100);  </span><br><span class=\"line\">str.append(sqlId);  </span><br><span class=\"line\">str.append(&quot;:&quot;);  </span><br><span class=\"line\">str.append(sql);  </span><br><span class=\"line\">str.append(&quot;:&quot;);  </span><br><span class=\"line\">return str.toString();  </span><br><span class=\"line\">&#125;    </span><br><span class=\"line\">public String showSql(Configuration configuration, BoundSql boundSql) &#123;  </span><br><span class=\"line\">Object parameterObject = boundSql.getParameterObject();  </span><br><span class=\"line\">List<span class=\"tag\">&lt;<span class=\"name\">ParameterMapping</span>&gt;</span> parameterMappings = boundSql.getParameterMappings();  </span><br><span class=\"line\">String sql = boundSql.getSql().replaceAll(&quot;[\\\\s]+&quot;, &quot; &quot;);  </span><br><span class=\"line\">if (parameterMappings.size() &gt; 0 &amp;&amp; parameterObject != null) &#123;  </span><br><span class=\"line\">TypeHandlerRegistry typeHandlerRegistry = configuration.getTypeHandlerRegistry();  </span><br><span class=\"line\">if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;  </span><br><span class=\"line\">sql = sql.replaceFirst(&quot;\\\\?&quot;, getParameterValue(parameterObject));    </span><br><span class=\"line\">&#125; else &#123;  </span><br><span class=\"line\">MetaObject metaObject = configuration.newMetaObject(parameterObject);  </span><br><span class=\"line\">for (ParameterMapping parameterMapping : parameterMappings) &#123;  </span><br><span class=\"line\">String propertyName = parameterMapping.getProperty();  </span><br><span class=\"line\">if (metaObject.hasGetter(propertyName)) &#123;  </span><br><span class=\"line\">Object obj = metaObject.getValue(propertyName);  </span><br><span class=\"line\">sql = sql.replaceFirst(&quot;\\\\?&quot;, getParameterValue(obj));  </span><br><span class=\"line\">&#125; else if (boundSql.hasAdditionalParameter(propertyName)) &#123;  </span><br><span class=\"line\">Object obj = boundSql.getAdditionalParameter(propertyName);  </span><br><span class=\"line\">sql = sql.replaceFirst(&quot;\\\\?&quot;, getParameterValue(obj));  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">return sql;  </span><br><span class=\"line\">&#125;   </span><br><span class=\"line\">private static String getParameterValue(Object obj) &#123;  </span><br><span class=\"line\">String value = null;  </span><br><span class=\"line\">if (obj instanceof String) &#123;  </span><br><span class=\"line\">value = &quot;‘&quot; + obj.toString() + &quot;‘&quot;;  </span><br><span class=\"line\">&#125; else if (obj instanceof Date) &#123;  </span><br><span class=\"line\">DateFormat formatter = DateFormat.getDateTimeInstance(DateFormat.DEFAULT, DateFormat.DEFAULT, Locale.CHINA);  </span><br><span class=\"line\">value = &quot;‘&quot; + formatter.format(new Date()) + &quot;‘&quot;;  </span><br><span class=\"line\">&#125; else &#123;  </span><br><span class=\"line\">if (obj != null) &#123;  </span><br><span class=\"line\">value = obj.toString();  </span><br><span class=\"line\">&#125; else &#123;  </span><br><span class=\"line\">value = &quot;&quot;;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">        return value;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>当系统并发达到一定数量级，log4j日志打印本身会成为瓶颈，这个时候需要mq来解耦了，<br>不在打印日志，而是发送mq消息，由mq消费端处理。因为目前公司项目并发数量还不足以导致该问题，因此尚未采用。<br>elk收集日志之后，通过kibana可以提供搜索。</p>\n<img src=\"/202306204306/1.png\" class=\"\" title=\"image\">\n\n<p>剩下最后的工作量就是提供一个web界面来更好的分析和展示数据。</p>\n"},{"title":"聊聊营销-名词定义","abbrlink":"6e4195e6","date":"2023-06-21T06:29:46.000Z","_content":"\n## 营销元数据\n会员用户A 在商店B 里面购买商品满30 减10元。我们用这个简单场景来展开讲讲营销名词。\n营销包含的基础名词，有主体(围绕什么做营销)，对象（营销的目标），形式(具体的规则)\n\n## 营销主体\n广义上有价值的都能做营销主体，在本地生活电商领域一般有\n- 实物商品（sku）\n- 商户 \n- 虚拟商品 （会员等）\n- 配送费\n\n## 营销对象\n营销对象是对用户进行分层，不同用户使用的营销策略不一样。在本地生活电商领域一般有\n- 平台用户\n- 平台新用户\n- 平台会员用户\n- 商家新用户\n- 商家会员用户\n- 自定义标签\n\n## 营销形式\n营销形式一般包含以下几种\n- 条件 （时间，门槛，满额，实付，原价，满件，其他等）\n- 权益  (特价，立减，折扣，赠送，其他等)\n- 限制规则 （库存，人单限制，人店限制 ，其他等）\n- 出资规则 (平台，商家，品牌商，代理商 等)\n\n## 抽象过程\n\n{% asset_img 1.png  image %}\n\n## 场景分解\n回到最开始的 会员用户A 在商店B 里面购买商品满30 减10元。\n- 主体   商店B\n- 对象   会员用户A\n- 形式   满30 减10元\n\n本片文章比较枯燥，后续按照主体，对象，形式 三个展开讲讲里面的业务抽象，\n和相关技术难点。\n\n\n\n\n\n\n\n","source":"_posts/聊聊营销-名词定义.md","raw":"---\ntitle: 聊聊营销-名词定义\ntags:\n  - 营销\nabbrlink: 6e4195e6\ndate: 2023-06-21 14:29:46\n---\n\n## 营销元数据\n会员用户A 在商店B 里面购买商品满30 减10元。我们用这个简单场景来展开讲讲营销名词。\n营销包含的基础名词，有主体(围绕什么做营销)，对象（营销的目标），形式(具体的规则)\n\n## 营销主体\n广义上有价值的都能做营销主体，在本地生活电商领域一般有\n- 实物商品（sku）\n- 商户 \n- 虚拟商品 （会员等）\n- 配送费\n\n## 营销对象\n营销对象是对用户进行分层，不同用户使用的营销策略不一样。在本地生活电商领域一般有\n- 平台用户\n- 平台新用户\n- 平台会员用户\n- 商家新用户\n- 商家会员用户\n- 自定义标签\n\n## 营销形式\n营销形式一般包含以下几种\n- 条件 （时间，门槛，满额，实付，原价，满件，其他等）\n- 权益  (特价，立减，折扣，赠送，其他等)\n- 限制规则 （库存，人单限制，人店限制 ，其他等）\n- 出资规则 (平台，商家，品牌商，代理商 等)\n\n## 抽象过程\n\n{% asset_img 1.png  image %}\n\n## 场景分解\n回到最开始的 会员用户A 在商店B 里面购买商品满30 减10元。\n- 主体   商店B\n- 对象   会员用户A\n- 形式   满30 减10元\n\n本片文章比较枯燥，后续按照主体，对象，形式 三个展开讲讲里面的业务抽象，\n和相关技术难点。\n\n\n\n\n\n\n\n","slug":"聊聊营销-名词定义","published":1,"updated":"2023-12-05T03:16:08.756Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdjc001norgoccjh907l","content":"<h2 id=\"营销元数据\"><a href=\"#营销元数据\" class=\"headerlink\" title=\"营销元数据\"></a>营销元数据</h2><p>会员用户A 在商店B 里面购买商品满30 减10元。我们用这个简单场景来展开讲讲营销名词。<br>营销包含的基础名词，有主体(围绕什么做营销)，对象（营销的目标），形式(具体的规则)</p>\n<h2 id=\"营销主体\"><a href=\"#营销主体\" class=\"headerlink\" title=\"营销主体\"></a>营销主体</h2><p>广义上有价值的都能做营销主体，在本地生活电商领域一般有</p>\n<ul>\n<li>实物商品（sku）</li>\n<li>商户 </li>\n<li>虚拟商品 （会员等）</li>\n<li>配送费</li>\n</ul>\n<h2 id=\"营销对象\"><a href=\"#营销对象\" class=\"headerlink\" title=\"营销对象\"></a>营销对象</h2><p>营销对象是对用户进行分层，不同用户使用的营销策略不一样。在本地生活电商领域一般有</p>\n<ul>\n<li>平台用户</li>\n<li>平台新用户</li>\n<li>平台会员用户</li>\n<li>商家新用户</li>\n<li>商家会员用户</li>\n<li>自定义标签</li>\n</ul>\n<h2 id=\"营销形式\"><a href=\"#营销形式\" class=\"headerlink\" title=\"营销形式\"></a>营销形式</h2><p>营销形式一般包含以下几种</p>\n<ul>\n<li>条件 （时间，门槛，满额，实付，原价，满件，其他等）</li>\n<li>权益  (特价，立减，折扣，赠送，其他等)</li>\n<li>限制规则 （库存，人单限制，人店限制 ，其他等）</li>\n<li>出资规则 (平台，商家，品牌商，代理商 等)</li>\n</ul>\n<h2 id=\"抽象过程\"><a href=\"#抽象过程\" class=\"headerlink\" title=\"抽象过程\"></a>抽象过程</h2><img src=\"/202306216e4195e6/1.png\" class=\"\" title=\"image\">\n\n<h2 id=\"场景分解\"><a href=\"#场景分解\" class=\"headerlink\" title=\"场景分解\"></a>场景分解</h2><p>回到最开始的 会员用户A 在商店B 里面购买商品满30 减10元。</p>\n<ul>\n<li>主体   商店B</li>\n<li>对象   会员用户A</li>\n<li>形式   满30 减10元</li>\n</ul>\n<p>本片文章比较枯燥，后续按照主体，对象，形式 三个展开讲讲里面的业务抽象，<br>和相关技术难点。</p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h2 id=\"营销元数据\"><a href=\"#营销元数据\" class=\"headerlink\" title=\"营销元数据\"></a>营销元数据</h2><p>会员用户A 在商店B 里面购买商品满30 减10元。我们用这个简单场景来展开讲讲营销名词。<br>营销包含的基础名词，有主体(围绕什么做营销)，对象（营销的目标），形式(具体的规则)</p>\n<h2 id=\"营销主体\"><a href=\"#营销主体\" class=\"headerlink\" title=\"营销主体\"></a>营销主体</h2><p>广义上有价值的都能做营销主体，在本地生活电商领域一般有</p>\n<ul>\n<li>实物商品（sku）</li>\n<li>商户 </li>\n<li>虚拟商品 （会员等）</li>\n<li>配送费</li>\n</ul>\n<h2 id=\"营销对象\"><a href=\"#营销对象\" class=\"headerlink\" title=\"营销对象\"></a>营销对象</h2><p>营销对象是对用户进行分层，不同用户使用的营销策略不一样。在本地生活电商领域一般有</p>\n<ul>\n<li>平台用户</li>\n<li>平台新用户</li>\n<li>平台会员用户</li>\n<li>商家新用户</li>\n<li>商家会员用户</li>\n<li>自定义标签</li>\n</ul>\n<h2 id=\"营销形式\"><a href=\"#营销形式\" class=\"headerlink\" title=\"营销形式\"></a>营销形式</h2><p>营销形式一般包含以下几种</p>\n<ul>\n<li>条件 （时间，门槛，满额，实付，原价，满件，其他等）</li>\n<li>权益  (特价，立减，折扣，赠送，其他等)</li>\n<li>限制规则 （库存，人单限制，人店限制 ，其他等）</li>\n<li>出资规则 (平台，商家，品牌商，代理商 等)</li>\n</ul>\n<h2 id=\"抽象过程\"><a href=\"#抽象过程\" class=\"headerlink\" title=\"抽象过程\"></a>抽象过程</h2><img src=\"/202306216e4195e6/1.png\" class=\"\" title=\"image\">\n\n<h2 id=\"场景分解\"><a href=\"#场景分解\" class=\"headerlink\" title=\"场景分解\"></a>场景分解</h2><p>回到最开始的 会员用户A 在商店B 里面购买商品满30 减10元。</p>\n<ul>\n<li>主体   商店B</li>\n<li>对象   会员用户A</li>\n<li>形式   满30 减10元</li>\n</ul>\n<p>本片文章比较枯燥，后续按照主体，对象，形式 三个展开讲讲里面的业务抽象，<br>和相关技术难点。</p>\n"},{"title":"聊聊营销-营销主体","abbrlink":"a713a826","date":"2023-06-22T07:56:30.000Z","_content":"\n## 营销主体\n主体，哲学上讲事物的主要部分，本地生活场景下营销主体，主要指用户围绕什么下单。\n- 平台新客优惠  主体是平台，期望用户在平台下单\n- 店铺满减优惠  主体是店铺，期望用户在该店铺下单\n- 特价商品优惠  主体是商品，期望用户购买该商品。\n- 配送费优惠   主体是配送费，期望用户使用该平台的配送服务\n- 支付优惠     主体是支付方式（例如微信支付），期望用户使用该支付渠道\n\n## 主体对技术架构的影响\n- 对优惠咨询的影响，即通过什么查询营销优惠信息。\n- 对优惠金额的最大值的影响，即优惠的内容能否溢出主体价格\n\n## 对优惠咨询的影响\n业务软件架构绝大部分都是基于业务模型来建设，最终业务模型反映到存储模型上。\n\n举个具体例子，假设某个平台，有100w商户，每个商户有100个商品，每个商品可独立配置优惠，也可能是组合优惠。\n可预计的优惠规则是个庞大的数量,主体的选择对性能影响是非常大。\n\n### 以平台为主体方案\n- 优点 对平台新客等其他平台类优惠友好。\n- 缺点 对商户类优惠，或者商品类优惠，效率较低，无区分度，性能较差\n- 实践 实际上基本不采用该方案。\n\n### 以商户为主体的方案\n- 优点 对商户类，例如满减优惠比较好友\n- 缺点 平台类活动会导致数据倾斜严重（假设平台对应的商户id为0），连锁店商品\n- 实践 一种做法是平台商户给一个池子列表（例如 商户id 1，2，3 都算平台商户）， 通过池子二次hash，从而解决数据倾斜问题\n\n### 以商品为主体的方案\n- 优点 对商品类，例如特价比较友好。\n- 缺点 数据量较大，有标准商品库是可以的。\n- 实践 例如品牌商户，可口可乐做优惠，这种新零售场景下的标准商品是比较复合的，但是像外卖，A店的辣椒炒肉和B店的辣椒炒肉完全是两个商品，就不和适合了。\n\n### 以配送费为主体\n- 实践 小众场景，目前配送费是抽象成一个订单商品（动态定价的商品，受重量，时段，天气等影响）\n\n### 以支付为主体\n- 实践 小众场景，目前抽象支付优惠作用的是支付单,不影响订单实付金额，新增一个支付方，等于是混合支付。\n\n## 对优惠金额的影响\n例如 一个商品原价10元，特价2元，配送费1元，有一个满20减5元的活动，假设满减的门槛是按照商品原价，\n用户购买2件商品，则实际支付是1元还是0元，则取决于满件的优惠主体是什么，是否能作用于配送费，这个目前没有标准答案，选择不同，结果不同。\n\n**实际过程中，没有标准的答案（有优点就一定有缺点），要看业务发展阶段，技术架构是随着业务发展一起演变**\n\n\n","source":"_posts/聊聊营销-营销主体.md","raw":"---\ntitle: 聊聊营销-营销主体\ntags:\n  - 营销\nabbrlink: a713a826\ndate: 2023-06-22 15:56:30\n---\n\n## 营销主体\n主体，哲学上讲事物的主要部分，本地生活场景下营销主体，主要指用户围绕什么下单。\n- 平台新客优惠  主体是平台，期望用户在平台下单\n- 店铺满减优惠  主体是店铺，期望用户在该店铺下单\n- 特价商品优惠  主体是商品，期望用户购买该商品。\n- 配送费优惠   主体是配送费，期望用户使用该平台的配送服务\n- 支付优惠     主体是支付方式（例如微信支付），期望用户使用该支付渠道\n\n## 主体对技术架构的影响\n- 对优惠咨询的影响，即通过什么查询营销优惠信息。\n- 对优惠金额的最大值的影响，即优惠的内容能否溢出主体价格\n\n## 对优惠咨询的影响\n业务软件架构绝大部分都是基于业务模型来建设，最终业务模型反映到存储模型上。\n\n举个具体例子，假设某个平台，有100w商户，每个商户有100个商品，每个商品可独立配置优惠，也可能是组合优惠。\n可预计的优惠规则是个庞大的数量,主体的选择对性能影响是非常大。\n\n### 以平台为主体方案\n- 优点 对平台新客等其他平台类优惠友好。\n- 缺点 对商户类优惠，或者商品类优惠，效率较低，无区分度，性能较差\n- 实践 实际上基本不采用该方案。\n\n### 以商户为主体的方案\n- 优点 对商户类，例如满减优惠比较好友\n- 缺点 平台类活动会导致数据倾斜严重（假设平台对应的商户id为0），连锁店商品\n- 实践 一种做法是平台商户给一个池子列表（例如 商户id 1，2，3 都算平台商户）， 通过池子二次hash，从而解决数据倾斜问题\n\n### 以商品为主体的方案\n- 优点 对商品类，例如特价比较友好。\n- 缺点 数据量较大，有标准商品库是可以的。\n- 实践 例如品牌商户，可口可乐做优惠，这种新零售场景下的标准商品是比较复合的，但是像外卖，A店的辣椒炒肉和B店的辣椒炒肉完全是两个商品，就不和适合了。\n\n### 以配送费为主体\n- 实践 小众场景，目前配送费是抽象成一个订单商品（动态定价的商品，受重量，时段，天气等影响）\n\n### 以支付为主体\n- 实践 小众场景，目前抽象支付优惠作用的是支付单,不影响订单实付金额，新增一个支付方，等于是混合支付。\n\n## 对优惠金额的影响\n例如 一个商品原价10元，特价2元，配送费1元，有一个满20减5元的活动，假设满减的门槛是按照商品原价，\n用户购买2件商品，则实际支付是1元还是0元，则取决于满件的优惠主体是什么，是否能作用于配送费，这个目前没有标准答案，选择不同，结果不同。\n\n**实际过程中，没有标准的答案（有优点就一定有缺点），要看业务发展阶段，技术架构是随着业务发展一起演变**\n\n\n","slug":"聊聊营销-营销主体","published":1,"updated":"2023-12-05T03:16:08.758Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdjc001porgob95a5n4o","content":"<h2 id=\"营销主体\"><a href=\"#营销主体\" class=\"headerlink\" title=\"营销主体\"></a>营销主体</h2><p>主体，哲学上讲事物的主要部分，本地生活场景下营销主体，主要指用户围绕什么下单。</p>\n<ul>\n<li>平台新客优惠  主体是平台，期望用户在平台下单</li>\n<li>店铺满减优惠  主体是店铺，期望用户在该店铺下单</li>\n<li>特价商品优惠  主体是商品，期望用户购买该商品。</li>\n<li>配送费优惠   主体是配送费，期望用户使用该平台的配送服务</li>\n<li>支付优惠     主体是支付方式（例如微信支付），期望用户使用该支付渠道</li>\n</ul>\n<h2 id=\"主体对技术架构的影响\"><a href=\"#主体对技术架构的影响\" class=\"headerlink\" title=\"主体对技术架构的影响\"></a>主体对技术架构的影响</h2><ul>\n<li>对优惠咨询的影响，即通过什么查询营销优惠信息。</li>\n<li>对优惠金额的最大值的影响，即优惠的内容能否溢出主体价格</li>\n</ul>\n<h2 id=\"对优惠咨询的影响\"><a href=\"#对优惠咨询的影响\" class=\"headerlink\" title=\"对优惠咨询的影响\"></a>对优惠咨询的影响</h2><p>业务软件架构绝大部分都是基于业务模型来建设，最终业务模型反映到存储模型上。</p>\n<p>举个具体例子，假设某个平台，有100w商户，每个商户有100个商品，每个商品可独立配置优惠，也可能是组合优惠。<br>可预计的优惠规则是个庞大的数量,主体的选择对性能影响是非常大。</p>\n<h3 id=\"以平台为主体方案\"><a href=\"#以平台为主体方案\" class=\"headerlink\" title=\"以平台为主体方案\"></a>以平台为主体方案</h3><ul>\n<li>优点 对平台新客等其他平台类优惠友好。</li>\n<li>缺点 对商户类优惠，或者商品类优惠，效率较低，无区分度，性能较差</li>\n<li>实践 实际上基本不采用该方案。</li>\n</ul>\n<h3 id=\"以商户为主体的方案\"><a href=\"#以商户为主体的方案\" class=\"headerlink\" title=\"以商户为主体的方案\"></a>以商户为主体的方案</h3><ul>\n<li>优点 对商户类，例如满减优惠比较好友</li>\n<li>缺点 平台类活动会导致数据倾斜严重（假设平台对应的商户id为0），连锁店商品</li>\n<li>实践 一种做法是平台商户给一个池子列表（例如 商户id 1，2，3 都算平台商户）， 通过池子二次hash，从而解决数据倾斜问题</li>\n</ul>\n<h3 id=\"以商品为主体的方案\"><a href=\"#以商品为主体的方案\" class=\"headerlink\" title=\"以商品为主体的方案\"></a>以商品为主体的方案</h3><ul>\n<li>优点 对商品类，例如特价比较友好。</li>\n<li>缺点 数据量较大，有标准商品库是可以的。</li>\n<li>实践 例如品牌商户，可口可乐做优惠，这种新零售场景下的标准商品是比较复合的，但是像外卖，A店的辣椒炒肉和B店的辣椒炒肉完全是两个商品，就不和适合了。</li>\n</ul>\n<h3 id=\"以配送费为主体\"><a href=\"#以配送费为主体\" class=\"headerlink\" title=\"以配送费为主体\"></a>以配送费为主体</h3><ul>\n<li>实践 小众场景，目前配送费是抽象成一个订单商品（动态定价的商品，受重量，时段，天气等影响）</li>\n</ul>\n<h3 id=\"以支付为主体\"><a href=\"#以支付为主体\" class=\"headerlink\" title=\"以支付为主体\"></a>以支付为主体</h3><ul>\n<li>实践 小众场景，目前抽象支付优惠作用的是支付单,不影响订单实付金额，新增一个支付方，等于是混合支付。</li>\n</ul>\n<h2 id=\"对优惠金额的影响\"><a href=\"#对优惠金额的影响\" class=\"headerlink\" title=\"对优惠金额的影响\"></a>对优惠金额的影响</h2><p>例如 一个商品原价10元，特价2元，配送费1元，有一个满20减5元的活动，假设满减的门槛是按照商品原价，<br>用户购买2件商品，则实际支付是1元还是0元，则取决于满件的优惠主体是什么，是否能作用于配送费，这个目前没有标准答案，选择不同，结果不同。</p>\n<p><strong>实际过程中，没有标准的答案（有优点就一定有缺点），要看业务发展阶段，技术架构是随着业务发展一起演变</strong></p>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h2 id=\"营销主体\"><a href=\"#营销主体\" class=\"headerlink\" title=\"营销主体\"></a>营销主体</h2><p>主体，哲学上讲事物的主要部分，本地生活场景下营销主体，主要指用户围绕什么下单。</p>\n<ul>\n<li>平台新客优惠  主体是平台，期望用户在平台下单</li>\n<li>店铺满减优惠  主体是店铺，期望用户在该店铺下单</li>\n<li>特价商品优惠  主体是商品，期望用户购买该商品。</li>\n<li>配送费优惠   主体是配送费，期望用户使用该平台的配送服务</li>\n<li>支付优惠     主体是支付方式（例如微信支付），期望用户使用该支付渠道</li>\n</ul>\n<h2 id=\"主体对技术架构的影响\"><a href=\"#主体对技术架构的影响\" class=\"headerlink\" title=\"主体对技术架构的影响\"></a>主体对技术架构的影响</h2><ul>\n<li>对优惠咨询的影响，即通过什么查询营销优惠信息。</li>\n<li>对优惠金额的最大值的影响，即优惠的内容能否溢出主体价格</li>\n</ul>\n<h2 id=\"对优惠咨询的影响\"><a href=\"#对优惠咨询的影响\" class=\"headerlink\" title=\"对优惠咨询的影响\"></a>对优惠咨询的影响</h2><p>业务软件架构绝大部分都是基于业务模型来建设，最终业务模型反映到存储模型上。</p>\n<p>举个具体例子，假设某个平台，有100w商户，每个商户有100个商品，每个商品可独立配置优惠，也可能是组合优惠。<br>可预计的优惠规则是个庞大的数量,主体的选择对性能影响是非常大。</p>\n<h3 id=\"以平台为主体方案\"><a href=\"#以平台为主体方案\" class=\"headerlink\" title=\"以平台为主体方案\"></a>以平台为主体方案</h3><ul>\n<li>优点 对平台新客等其他平台类优惠友好。</li>\n<li>缺点 对商户类优惠，或者商品类优惠，效率较低，无区分度，性能较差</li>\n<li>实践 实际上基本不采用该方案。</li>\n</ul>\n<h3 id=\"以商户为主体的方案\"><a href=\"#以商户为主体的方案\" class=\"headerlink\" title=\"以商户为主体的方案\"></a>以商户为主体的方案</h3><ul>\n<li>优点 对商户类，例如满减优惠比较好友</li>\n<li>缺点 平台类活动会导致数据倾斜严重（假设平台对应的商户id为0），连锁店商品</li>\n<li>实践 一种做法是平台商户给一个池子列表（例如 商户id 1，2，3 都算平台商户）， 通过池子二次hash，从而解决数据倾斜问题</li>\n</ul>\n<h3 id=\"以商品为主体的方案\"><a href=\"#以商品为主体的方案\" class=\"headerlink\" title=\"以商品为主体的方案\"></a>以商品为主体的方案</h3><ul>\n<li>优点 对商品类，例如特价比较友好。</li>\n<li>缺点 数据量较大，有标准商品库是可以的。</li>\n<li>实践 例如品牌商户，可口可乐做优惠，这种新零售场景下的标准商品是比较复合的，但是像外卖，A店的辣椒炒肉和B店的辣椒炒肉完全是两个商品，就不和适合了。</li>\n</ul>\n<h3 id=\"以配送费为主体\"><a href=\"#以配送费为主体\" class=\"headerlink\" title=\"以配送费为主体\"></a>以配送费为主体</h3><ul>\n<li>实践 小众场景，目前配送费是抽象成一个订单商品（动态定价的商品，受重量，时段，天气等影响）</li>\n</ul>\n<h3 id=\"以支付为主体\"><a href=\"#以支付为主体\" class=\"headerlink\" title=\"以支付为主体\"></a>以支付为主体</h3><ul>\n<li>实践 小众场景，目前抽象支付优惠作用的是支付单,不影响订单实付金额，新增一个支付方，等于是混合支付。</li>\n</ul>\n<h2 id=\"对优惠金额的影响\"><a href=\"#对优惠金额的影响\" class=\"headerlink\" title=\"对优惠金额的影响\"></a>对优惠金额的影响</h2><p>例如 一个商品原价10元，特价2元，配送费1元，有一个满20减5元的活动，假设满减的门槛是按照商品原价，<br>用户购买2件商品，则实际支付是1元还是0元，则取决于满件的优惠主体是什么，是否能作用于配送费，这个目前没有标准答案，选择不同，结果不同。</p>\n<p><strong>实际过程中，没有标准的答案（有优点就一定有缺点），要看业务发展阶段，技术架构是随着业务发展一起演变</strong></p>\n"},{"title":"评论模块数据结构设计","abbrlink":1125,"date":"2023-06-20T11:49:06.000Z","_content":"## 需求\n- 评论文章\n- 回复评论\n- 查询文章评论列表 不展开子评论\n- 查询文章评论列表 展开子评论\n- 展示子评论总数\n\n## 方案设计\n需求是一个典型的评论盖楼场景，传统的方案是一个自连接的表\n> 自连接表，表新增一列（parent_id）外键，该列引用当前表的id值\n\n自连接表的查询,一般都数据当成一个list全部查出来，在应用服务内构建\n成一个树结构，再去做其他处理。如果一个文章的评论特别多，例如微博热帖这种场景，性能就回成为瓶颈。\n因此通过自己构建树形索引结构，优化查询性能。\n\n## 树形结构\n\n### 核心字段\n- 节点id 自增id\n- 父节点id  父节点id\n- 左值\n- 右值\n- 树深 当前数深度， root节点是0\n- 编号 当前节点在整棵的位置，用来排序，root节点是1\n- 数据内容 节点存储的数据，评论内容\n\n## 场景分析\n\n### 场景1\n\n{% asset_img 1.png  image %}\n\n1. 假设db有评论A 。此时A的左值是1，右值是2,编号是1，对应图里面的step1\n2. 在A评论下新增B评论，对应图里面的step2\n    - 左值=父节点（A)右值\n    - 右值=左值+1\n    - 编号= 父节点(A)编号 + （父节点(A)右值-父节点(A)左值+1）/2\n\n3. 当前树下其他节点左值更新\n    - 条件 该节点左值> 新增节点（B）的父节点（A）右值 即>=2\n    - 动作 左值+=2\n    - 本场景 没有复合条件的，无更新\n\n4. 当前树下其他节点右值更新\n    - 条件 右值>=新增节点（B）的父节点（A）右值 即>=2\n    - 动作 右值+=2\n    - 该场景节点A满足条件，则A的右值改成2, 对应图里面的step3\n   \n5. 其他节点编号更新\n   - 条件 节点编号 >= 新增节点（B）的编号\n   - 动作 编号+=1\n   - 该场景没有满足条件的\n\n### 场景2\n\n{% asset_img 2.png  image %}\n该场景与场景1一样\n\n### 场景3\n{% asset_img 3.png  image %}\n\n### 结构优点\n\n1. 计算子节点数量， （右值-左值）/2，例如 A （8-1）/2=3 ，B （5-2）/2=1\n2. 列出当前子节点（包括下层子节点），查询 节点左值> 当前节点左值 并且 节点右值<当前节点右值，a. 例如 B节点的所有子节点，即 where 左值>2 and 右值<5列出当前节点 一层子节点，通过parent node 即可\n3. 列出当前节点 一层子节点，通过parent node 即可\n4. 列出当前节点，特定层级的所有叶子结点， 结合2和树深即可\n5. 展开整个树，通过编号排序即可\n\n## 代码实现\n\n{% codeblock 节点代码 lang:java   %}\n\n    /* Copyright © 2020 Yuech and/or its affiliates. All rights reserved. */\n    package wiki.chenxun.blog.example.reply;\n    \n    import lombok.AllArgsConstructor;\n    import lombok.Getter;\n\n    /**\n     * @author 陈勋\n     * @version 1.0\n     * @date 2021-05-19 3:43 下午\n    */\n\n    \n    public class Node {\n\n    /**\n     * 节点id\n     */\n    private String id;\n\n    /**\n     * 树id，一般是文章id\n     */\n    private String treeId;\n\n    /**\n     * 　左值\n     */\n    private Integer left;\n\n    /**\n     * 右值\n     */\n    private Integer right;\n\n    /**\n     * 树深\n     */\n    private Integer depth;\n\n    /**\n     * 编号\n     */\n    private Integer index;\n\n    /**\n     * 商城节点id\n     */\n    private String parentId;\n\n    /**\n     * 数据\n     */\n    private String data;\n\n    public static Node rootNote(String id, String treeId,String data) {\n        Node node = new Node(id, treeId, 1, 2, 0, 1, null, data);\n        return node;\n    }\n\n    public void incrementLeft() {\n        this.left += 2;\n    }\n\n    public void incrementRight() {\n        this.right += 2;\n    }\n\n    public void incrementIndex() {\n        this.index += 1;\n    }\n\n    }\n\n\n\n\n\n{% endcodeblock %}\n\n\n{% codeblock 树代码 lang:java   %}\n\n    /* Copyright © 2020 Yuech and/or its affiliates. All rights reserved. */\n    package wiki.chenxun.blog.example.reply;\n\n    import java.util.ArrayList;\n    import java.util.Comparator;\n    import java.util.List;\n    import java.util.UUID;\n    import java.util.stream.Collectors;\n\n    /**\n       * @author 陈勋\n        * @version 1.0\n    * @date 2021-06-18 6:37 下午\n      */\n      public class Tree {\n\n      private String treeId;\n\n      private List<Node> nodeList = new ArrayList<>();\n\n      private Node rootNode;\n\n      public Tree(String treeId,String data) {\n      this.treeId = treeId;\n      this.rootNode = Node.rootNote(UUID.randomUUID().toString(), treeId,data);\n      nodeList.add(rootNode);\n      }\n\n      public String addNode(String data, String parentNodeId) {\n\n           Node parentNode;\n           if (parentNodeId != null) {\n               parentNode = nodeList.stream()\n                   .filter(i -> parentNodeId.equals(i.getId()))\n                   .findFirst().orElse(null);\n           } else {\n               parentNode = rootNode;\n           }\n           if (parentNode == null) {\n               throw new IllegalArgumentException(\"parent Node not exist\");\n           }\n\n           final Integer parentRight = parentNode.getRight();\n           // 本次新增node在树里面的编号\n           final Integer nodeIndex = parentNode.getIndex() + (parentNode.getRight() - parentNode.getLeft() + 1) / 2;\n           // 数深\n           final Integer nodeDepth = parentNode.getDepth() + 1;\n\n           // 构建子节点\n           Node node = new Node(UUID.randomUUID().toString(), this.treeId,\n               parentNode.getRight(), parentNode.getRight() + 1,\n               nodeDepth, nodeIndex,\n               parentNodeId, data);\n\n           // 跟新其他节点左值\n           nodeList.stream().filter(i -> i.getLeft() >= parentRight)\n               .forEach(Node::incrementLeft);\n\n           // 更新其他节点右值\n           nodeList.stream().filter(i -> i.getRight() >= parentRight)\n               .forEach(Node::incrementRight);\n\n           // 更新其他节点编号，大于等于index都往后挪一个位置\n           nodeList.stream().filter(i -> i.getIndex() >= nodeIndex)\n               .forEach(Node::incrementIndex);\n           //添加新节点\n           nodeList.add(node);\n\n           return node.getId();\n\n      }\n\n      /**\n        * 测试打印，左序遍历\n          */\n          public void print() {\n          nodeList.sort(Comparator.comparing(Node::getIndex));\n          String s=String.join(\",\", nodeList.stream()\n          .map(Node::getData).collect(Collectors.toList()));\n\n          System.out.println(s);\n\n      }\n\n    }\n\n\n{% endcodeblock %}\n\n\n\n{% codeblock 测试代码 lang:java   %}\n\n    public void test(){\n    Tree tree=new Tree(\"tree_1\",\"文章\");\n\n    String a= tree.addNode(\"a\",null);\n    String b=tree.addNode(\"b\",null);\n    tree.addNode(\"c\",a);\n    tree.addNode(\"d\",a);\n    tree.addNode(\"e\",b);\n\n    tree.print();\n}\n\n{% endcodeblock %}\n\n## 业务应用\n- 数据可以和索引剥离，即data字段存的是数据id，root节点存文章id，其他节点存评论id\n- 新增节点的时候，需要把整颗树锁住\n  - 通过redis做分布式锁\n  - 通过select for update 做数据库悲观锁 （不推荐）\n  - 通过 新增version字段做乐观锁，树的版本等于root节点的版本（推荐）\n- 删除节点，该场景下其实不删除索引，只是把数据id指向的数据删除\n  - 如果删除的太多，就需要把整个树reBuild.(本场景未实现,有需要的朋友可以给留言)\n\n","source":"_posts/评论模块数据结构设计.md","raw":"---\ntitle: 评论模块数据结构设计\nabbrlink: 1125\ndate: 2023-06-20 19:49:06\ntags:\n---\n## 需求\n- 评论文章\n- 回复评论\n- 查询文章评论列表 不展开子评论\n- 查询文章评论列表 展开子评论\n- 展示子评论总数\n\n## 方案设计\n需求是一个典型的评论盖楼场景，传统的方案是一个自连接的表\n> 自连接表，表新增一列（parent_id）外键，该列引用当前表的id值\n\n自连接表的查询,一般都数据当成一个list全部查出来，在应用服务内构建\n成一个树结构，再去做其他处理。如果一个文章的评论特别多，例如微博热帖这种场景，性能就回成为瓶颈。\n因此通过自己构建树形索引结构，优化查询性能。\n\n## 树形结构\n\n### 核心字段\n- 节点id 自增id\n- 父节点id  父节点id\n- 左值\n- 右值\n- 树深 当前数深度， root节点是0\n- 编号 当前节点在整棵的位置，用来排序，root节点是1\n- 数据内容 节点存储的数据，评论内容\n\n## 场景分析\n\n### 场景1\n\n{% asset_img 1.png  image %}\n\n1. 假设db有评论A 。此时A的左值是1，右值是2,编号是1，对应图里面的step1\n2. 在A评论下新增B评论，对应图里面的step2\n    - 左值=父节点（A)右值\n    - 右值=左值+1\n    - 编号= 父节点(A)编号 + （父节点(A)右值-父节点(A)左值+1）/2\n\n3. 当前树下其他节点左值更新\n    - 条件 该节点左值> 新增节点（B）的父节点（A）右值 即>=2\n    - 动作 左值+=2\n    - 本场景 没有复合条件的，无更新\n\n4. 当前树下其他节点右值更新\n    - 条件 右值>=新增节点（B）的父节点（A）右值 即>=2\n    - 动作 右值+=2\n    - 该场景节点A满足条件，则A的右值改成2, 对应图里面的step3\n   \n5. 其他节点编号更新\n   - 条件 节点编号 >= 新增节点（B）的编号\n   - 动作 编号+=1\n   - 该场景没有满足条件的\n\n### 场景2\n\n{% asset_img 2.png  image %}\n该场景与场景1一样\n\n### 场景3\n{% asset_img 3.png  image %}\n\n### 结构优点\n\n1. 计算子节点数量， （右值-左值）/2，例如 A （8-1）/2=3 ，B （5-2）/2=1\n2. 列出当前子节点（包括下层子节点），查询 节点左值> 当前节点左值 并且 节点右值<当前节点右值，a. 例如 B节点的所有子节点，即 where 左值>2 and 右值<5列出当前节点 一层子节点，通过parent node 即可\n3. 列出当前节点 一层子节点，通过parent node 即可\n4. 列出当前节点，特定层级的所有叶子结点， 结合2和树深即可\n5. 展开整个树，通过编号排序即可\n\n## 代码实现\n\n{% codeblock 节点代码 lang:java   %}\n\n    /* Copyright © 2020 Yuech and/or its affiliates. All rights reserved. */\n    package wiki.chenxun.blog.example.reply;\n    \n    import lombok.AllArgsConstructor;\n    import lombok.Getter;\n\n    /**\n     * @author 陈勋\n     * @version 1.0\n     * @date 2021-05-19 3:43 下午\n    */\n\n    \n    public class Node {\n\n    /**\n     * 节点id\n     */\n    private String id;\n\n    /**\n     * 树id，一般是文章id\n     */\n    private String treeId;\n\n    /**\n     * 　左值\n     */\n    private Integer left;\n\n    /**\n     * 右值\n     */\n    private Integer right;\n\n    /**\n     * 树深\n     */\n    private Integer depth;\n\n    /**\n     * 编号\n     */\n    private Integer index;\n\n    /**\n     * 商城节点id\n     */\n    private String parentId;\n\n    /**\n     * 数据\n     */\n    private String data;\n\n    public static Node rootNote(String id, String treeId,String data) {\n        Node node = new Node(id, treeId, 1, 2, 0, 1, null, data);\n        return node;\n    }\n\n    public void incrementLeft() {\n        this.left += 2;\n    }\n\n    public void incrementRight() {\n        this.right += 2;\n    }\n\n    public void incrementIndex() {\n        this.index += 1;\n    }\n\n    }\n\n\n\n\n\n{% endcodeblock %}\n\n\n{% codeblock 树代码 lang:java   %}\n\n    /* Copyright © 2020 Yuech and/or its affiliates. All rights reserved. */\n    package wiki.chenxun.blog.example.reply;\n\n    import java.util.ArrayList;\n    import java.util.Comparator;\n    import java.util.List;\n    import java.util.UUID;\n    import java.util.stream.Collectors;\n\n    /**\n       * @author 陈勋\n        * @version 1.0\n    * @date 2021-06-18 6:37 下午\n      */\n      public class Tree {\n\n      private String treeId;\n\n      private List<Node> nodeList = new ArrayList<>();\n\n      private Node rootNode;\n\n      public Tree(String treeId,String data) {\n      this.treeId = treeId;\n      this.rootNode = Node.rootNote(UUID.randomUUID().toString(), treeId,data);\n      nodeList.add(rootNode);\n      }\n\n      public String addNode(String data, String parentNodeId) {\n\n           Node parentNode;\n           if (parentNodeId != null) {\n               parentNode = nodeList.stream()\n                   .filter(i -> parentNodeId.equals(i.getId()))\n                   .findFirst().orElse(null);\n           } else {\n               parentNode = rootNode;\n           }\n           if (parentNode == null) {\n               throw new IllegalArgumentException(\"parent Node not exist\");\n           }\n\n           final Integer parentRight = parentNode.getRight();\n           // 本次新增node在树里面的编号\n           final Integer nodeIndex = parentNode.getIndex() + (parentNode.getRight() - parentNode.getLeft() + 1) / 2;\n           // 数深\n           final Integer nodeDepth = parentNode.getDepth() + 1;\n\n           // 构建子节点\n           Node node = new Node(UUID.randomUUID().toString(), this.treeId,\n               parentNode.getRight(), parentNode.getRight() + 1,\n               nodeDepth, nodeIndex,\n               parentNodeId, data);\n\n           // 跟新其他节点左值\n           nodeList.stream().filter(i -> i.getLeft() >= parentRight)\n               .forEach(Node::incrementLeft);\n\n           // 更新其他节点右值\n           nodeList.stream().filter(i -> i.getRight() >= parentRight)\n               .forEach(Node::incrementRight);\n\n           // 更新其他节点编号，大于等于index都往后挪一个位置\n           nodeList.stream().filter(i -> i.getIndex() >= nodeIndex)\n               .forEach(Node::incrementIndex);\n           //添加新节点\n           nodeList.add(node);\n\n           return node.getId();\n\n      }\n\n      /**\n        * 测试打印，左序遍历\n          */\n          public void print() {\n          nodeList.sort(Comparator.comparing(Node::getIndex));\n          String s=String.join(\",\", nodeList.stream()\n          .map(Node::getData).collect(Collectors.toList()));\n\n          System.out.println(s);\n\n      }\n\n    }\n\n\n{% endcodeblock %}\n\n\n\n{% codeblock 测试代码 lang:java   %}\n\n    public void test(){\n    Tree tree=new Tree(\"tree_1\",\"文章\");\n\n    String a= tree.addNode(\"a\",null);\n    String b=tree.addNode(\"b\",null);\n    tree.addNode(\"c\",a);\n    tree.addNode(\"d\",a);\n    tree.addNode(\"e\",b);\n\n    tree.print();\n}\n\n{% endcodeblock %}\n\n## 业务应用\n- 数据可以和索引剥离，即data字段存的是数据id，root节点存文章id，其他节点存评论id\n- 新增节点的时候，需要把整颗树锁住\n  - 通过redis做分布式锁\n  - 通过select for update 做数据库悲观锁 （不推荐）\n  - 通过 新增version字段做乐观锁，树的版本等于root节点的版本（推荐）\n- 删除节点，该场景下其实不删除索引，只是把数据id指向的数据删除\n  - 如果删除的太多，就需要把整个树reBuild.(本场景未实现,有需要的朋友可以给留言)\n\n","slug":"评论模块数据结构设计","published":1,"updated":"2023-12-05T02:48:12.741Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdjd001sorgo32emaizo","content":"<h2 id=\"需求\"><a href=\"#需求\" class=\"headerlink\" title=\"需求\"></a>需求</h2><ul>\n<li>评论文章</li>\n<li>回复评论</li>\n<li>查询文章评论列表 不展开子评论</li>\n<li>查询文章评论列表 展开子评论</li>\n<li>展示子评论总数</li>\n</ul>\n<h2 id=\"方案设计\"><a href=\"#方案设计\" class=\"headerlink\" title=\"方案设计\"></a>方案设计</h2><p>需求是一个典型的评论盖楼场景，传统的方案是一个自连接的表</p>\n<blockquote>\n<p>自连接表，表新增一列（parent_id）外键，该列引用当前表的id值</p>\n</blockquote>\n<p>自连接表的查询,一般都数据当成一个list全部查出来，在应用服务内构建<br>成一个树结构，再去做其他处理。如果一个文章的评论特别多，例如微博热帖这种场景，性能就回成为瓶颈。<br>因此通过自己构建树形索引结构，优化查询性能。</p>\n<h2 id=\"树形结构\"><a href=\"#树形结构\" class=\"headerlink\" title=\"树形结构\"></a>树形结构</h2><h3 id=\"核心字段\"><a href=\"#核心字段\" class=\"headerlink\" title=\"核心字段\"></a>核心字段</h3><ul>\n<li>节点id 自增id</li>\n<li>父节点id  父节点id</li>\n<li>左值</li>\n<li>右值</li>\n<li>树深 当前数深度， root节点是0</li>\n<li>编号 当前节点在整棵的位置，用来排序，root节点是1</li>\n<li>数据内容 节点存储的数据，评论内容</li>\n</ul>\n<h2 id=\"场景分析\"><a href=\"#场景分析\" class=\"headerlink\" title=\"场景分析\"></a>场景分析</h2><h3 id=\"场景1\"><a href=\"#场景1\" class=\"headerlink\" title=\"场景1\"></a>场景1</h3><img src=\"/202306201125/1.png\" class=\"\" title=\"image\">\n\n<ol>\n<li><p>假设db有评论A 。此时A的左值是1，右值是2,编号是1，对应图里面的step1</p>\n</li>\n<li><p>在A评论下新增B评论，对应图里面的step2</p>\n<ul>\n<li>左值&#x3D;父节点（A)右值</li>\n<li>右值&#x3D;左值+1</li>\n<li>编号&#x3D; 父节点(A)编号 + （父节点(A)右值-父节点(A)左值+1）&#x2F;2</li>\n</ul>\n</li>\n<li><p>当前树下其他节点左值更新</p>\n<ul>\n<li>条件 该节点左值&gt; 新增节点（B）的父节点（A）右值 即&gt;&#x3D;2</li>\n<li>动作 左值+&#x3D;2</li>\n<li>本场景 没有复合条件的，无更新</li>\n</ul>\n</li>\n<li><p>当前树下其他节点右值更新</p>\n<ul>\n<li>条件 右值&gt;&#x3D;新增节点（B）的父节点（A）右值 即&gt;&#x3D;2</li>\n<li>动作 右值+&#x3D;2</li>\n<li>该场景节点A满足条件，则A的右值改成2, 对应图里面的step3</li>\n</ul>\n</li>\n<li><p>其他节点编号更新</p>\n<ul>\n<li>条件 节点编号 &gt;&#x3D; 新增节点（B）的编号</li>\n<li>动作 编号+&#x3D;1</li>\n<li>该场景没有满足条件的</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"场景2\"><a href=\"#场景2\" class=\"headerlink\" title=\"场景2\"></a>场景2</h3><img src=\"/202306201125/2.png\" class=\"\" title=\"image\">\n<p>该场景与场景1一样</p>\n<h3 id=\"场景3\"><a href=\"#场景3\" class=\"headerlink\" title=\"场景3\"></a>场景3</h3><img src=\"/202306201125/3.png\" class=\"\" title=\"image\">\n\n<h3 id=\"结构优点\"><a href=\"#结构优点\" class=\"headerlink\" title=\"结构优点\"></a>结构优点</h3><ol>\n<li>计算子节点数量， （右值-左值）&#x2F;2，例如 A （8-1）&#x2F;2&#x3D;3 ，B （5-2）&#x2F;2&#x3D;1</li>\n<li>列出当前子节点（包括下层子节点），查询 节点左值&gt; 当前节点左值 并且 节点右值&lt;当前节点右值，a. 例如 B节点的所有子节点，即 where 左值&gt;2 and 右值&lt;5列出当前节点 一层子节点，通过parent node 即可</li>\n<li>列出当前节点 一层子节点，通过parent node 即可</li>\n<li>列出当前节点，特定层级的所有叶子结点， 结合2和树深即可</li>\n<li>展开整个树，通过编号排序即可</li>\n</ol>\n<h2 id=\"代码实现\"><a href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h2><figure class=\"highlight java\"><figcaption><span>节点代码</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* Copyright © 2020 Yuech and/or its affiliates. All rights reserved. */</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> wiki.chenxun.blog.example.reply;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.AllArgsConstructor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.Getter;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> 陈勋</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@version</span> 1.0</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2021-05-19 3:43 下午</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Node</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 节点id</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String id;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 树id，一般是文章id</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String treeId;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 　左值</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> Integer left;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 右值</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> Integer right;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 树深</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> Integer depth;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 编号</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> Integer index;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 商城节点id</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String parentId;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 数据</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String data;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Node <span class=\"title function_\">rootNote</span><span class=\"params\">(String id, String treeId,String data)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">Node</span> <span class=\"variable\">node</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Node</span>(id, treeId, <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"literal\">null</span>, data);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> node;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">incrementLeft</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">this</span>.left += <span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">incrementRight</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">this</span>.right += <span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">incrementIndex</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">this</span>.index += <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight java\"><figcaption><span>树代码</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* Copyright © 2020 Yuech and/or its affiliates. All rights reserved. */</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> wiki.chenxun.blog.example.reply;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.ArrayList;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Comparator;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.UUID;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.stream.Collectors;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * <span class=\"doctag\">@author</span> 陈勋</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@version</span> 1.0</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@date</span> 2021-06-18 6:37 下午</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Tree</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> String treeId;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> List&lt;Node&gt; nodeList = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> Node rootNode;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"title function_\">Tree</span><span class=\"params\">(String treeId,String data)</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">this</span>.treeId = treeId;</span><br><span class=\"line\">  <span class=\"built_in\">this</span>.rootNode = Node.rootNote(UUID.randomUUID().toString(), treeId,data);</span><br><span class=\"line\">  nodeList.add(rootNode);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">public</span> String <span class=\"title function_\">addNode</span><span class=\"params\">(String data, String parentNodeId)</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">       Node parentNode;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (parentNodeId != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">           parentNode = nodeList.stream()</span><br><span class=\"line\">               .filter(i -&gt; parentNodeId.equals(i.getId()))</span><br><span class=\"line\">               .findFirst().orElse(<span class=\"literal\">null</span>);</span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">           parentNode = rootNode;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (parentNode == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">           <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;parent Node not exist&quot;</span>);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">final</span> <span class=\"type\">Integer</span> <span class=\"variable\">parentRight</span> <span class=\"operator\">=</span> parentNode.getRight();</span><br><span class=\"line\">       <span class=\"comment\">// 本次新增node在树里面的编号</span></span><br><span class=\"line\">       <span class=\"keyword\">final</span> <span class=\"type\">Integer</span> <span class=\"variable\">nodeIndex</span> <span class=\"operator\">=</span> parentNode.getIndex() + (parentNode.getRight() - parentNode.getLeft() + <span class=\"number\">1</span>) / <span class=\"number\">2</span>;</span><br><span class=\"line\">       <span class=\"comment\">// 数深</span></span><br><span class=\"line\">       <span class=\"keyword\">final</span> <span class=\"type\">Integer</span> <span class=\"variable\">nodeDepth</span> <span class=\"operator\">=</span> parentNode.getDepth() + <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// 构建子节点</span></span><br><span class=\"line\">       <span class=\"type\">Node</span> <span class=\"variable\">node</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Node</span>(UUID.randomUUID().toString(), <span class=\"built_in\">this</span>.treeId,</span><br><span class=\"line\">           parentNode.getRight(), parentNode.getRight() + <span class=\"number\">1</span>,</span><br><span class=\"line\">           nodeDepth, nodeIndex,</span><br><span class=\"line\">           parentNodeId, data);</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// 跟新其他节点左值</span></span><br><span class=\"line\">       nodeList.stream().filter(i -&gt; i.getLeft() &gt;= parentRight)</span><br><span class=\"line\">           .forEach(Node::incrementLeft);</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// 更新其他节点右值</span></span><br><span class=\"line\">       nodeList.stream().filter(i -&gt; i.getRight() &gt;= parentRight)</span><br><span class=\"line\">           .forEach(Node::incrementRight);</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// 更新其他节点编号，大于等于index都往后挪一个位置</span></span><br><span class=\"line\">       nodeList.stream().filter(i -&gt; i.getIndex() &gt;= nodeIndex)</span><br><span class=\"line\">           .forEach(Node::incrementIndex);</span><br><span class=\"line\">       <span class=\"comment\">//添加新节点</span></span><br><span class=\"line\">       nodeList.add(node);</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">return</span> node.getId();</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * 测试打印，左序遍历</span></span><br><span class=\"line\"><span class=\"comment\">      */</span></span><br><span class=\"line\">      <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">print</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">      nodeList.sort(Comparator.comparing(Node::getIndex));</span><br><span class=\"line\">      String s=String.join(<span class=\"string\">&quot;,&quot;</span>, nodeList.stream()</span><br><span class=\"line\">      .map(Node::getData).collect(Collectors.toList()));</span><br><span class=\"line\"></span><br><span class=\"line\">      System.out.println(s);</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><figcaption><span>测试代码</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">test</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    Tree tree=<span class=\"keyword\">new</span> <span class=\"title class_\">Tree</span>(<span class=\"string\">&quot;tree_1&quot;</span>,<span class=\"string\">&quot;文章&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    String a= tree.addNode(<span class=\"string\">&quot;a&quot;</span>,<span class=\"literal\">null</span>);</span><br><span class=\"line\">    String b=tree.addNode(<span class=\"string\">&quot;b&quot;</span>,<span class=\"literal\">null</span>);</span><br><span class=\"line\">    tree.addNode(<span class=\"string\">&quot;c&quot;</span>,a);</span><br><span class=\"line\">    tree.addNode(<span class=\"string\">&quot;d&quot;</span>,a);</span><br><span class=\"line\">    tree.addNode(<span class=\"string\">&quot;e&quot;</span>,b);</span><br><span class=\"line\"></span><br><span class=\"line\">    tree.print();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"业务应用\"><a href=\"#业务应用\" class=\"headerlink\" title=\"业务应用\"></a>业务应用</h2><ul>\n<li>数据可以和索引剥离，即data字段存的是数据id，root节点存文章id，其他节点存评论id</li>\n<li>新增节点的时候，需要把整颗树锁住<ul>\n<li>通过redis做分布式锁</li>\n<li>通过select for update 做数据库悲观锁 （不推荐）</li>\n<li>通过 新增version字段做乐观锁，树的版本等于root节点的版本（推荐）</li>\n</ul>\n</li>\n<li>删除节点，该场景下其实不删除索引，只是把数据id指向的数据删除<ul>\n<li>如果删除的太多，就需要把整个树reBuild.(本场景未实现,有需要的朋友可以给留言)</li>\n</ul>\n</li>\n</ul>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h2 id=\"需求\"><a href=\"#需求\" class=\"headerlink\" title=\"需求\"></a>需求</h2><ul>\n<li>评论文章</li>\n<li>回复评论</li>\n<li>查询文章评论列表 不展开子评论</li>\n<li>查询文章评论列表 展开子评论</li>\n<li>展示子评论总数</li>\n</ul>\n<h2 id=\"方案设计\"><a href=\"#方案设计\" class=\"headerlink\" title=\"方案设计\"></a>方案设计</h2><p>需求是一个典型的评论盖楼场景，传统的方案是一个自连接的表</p>\n<blockquote>\n<p>自连接表，表新增一列（parent_id）外键，该列引用当前表的id值</p>\n</blockquote>\n<p>自连接表的查询,一般都数据当成一个list全部查出来，在应用服务内构建<br>成一个树结构，再去做其他处理。如果一个文章的评论特别多，例如微博热帖这种场景，性能就回成为瓶颈。<br>因此通过自己构建树形索引结构，优化查询性能。</p>\n<h2 id=\"树形结构\"><a href=\"#树形结构\" class=\"headerlink\" title=\"树形结构\"></a>树形结构</h2><h3 id=\"核心字段\"><a href=\"#核心字段\" class=\"headerlink\" title=\"核心字段\"></a>核心字段</h3><ul>\n<li>节点id 自增id</li>\n<li>父节点id  父节点id</li>\n<li>左值</li>\n<li>右值</li>\n<li>树深 当前数深度， root节点是0</li>\n<li>编号 当前节点在整棵的位置，用来排序，root节点是1</li>\n<li>数据内容 节点存储的数据，评论内容</li>\n</ul>\n<h2 id=\"场景分析\"><a href=\"#场景分析\" class=\"headerlink\" title=\"场景分析\"></a>场景分析</h2><h3 id=\"场景1\"><a href=\"#场景1\" class=\"headerlink\" title=\"场景1\"></a>场景1</h3><img src=\"/202306201125/1.png\" class=\"\" title=\"image\">\n\n<ol>\n<li><p>假设db有评论A 。此时A的左值是1，右值是2,编号是1，对应图里面的step1</p>\n</li>\n<li><p>在A评论下新增B评论，对应图里面的step2</p>\n<ul>\n<li>左值&#x3D;父节点（A)右值</li>\n<li>右值&#x3D;左值+1</li>\n<li>编号&#x3D; 父节点(A)编号 + （父节点(A)右值-父节点(A)左值+1）&#x2F;2</li>\n</ul>\n</li>\n<li><p>当前树下其他节点左值更新</p>\n<ul>\n<li>条件 该节点左值&gt; 新增节点（B）的父节点（A）右值 即&gt;&#x3D;2</li>\n<li>动作 左值+&#x3D;2</li>\n<li>本场景 没有复合条件的，无更新</li>\n</ul>\n</li>\n<li><p>当前树下其他节点右值更新</p>\n<ul>\n<li>条件 右值&gt;&#x3D;新增节点（B）的父节点（A）右值 即&gt;&#x3D;2</li>\n<li>动作 右值+&#x3D;2</li>\n<li>该场景节点A满足条件，则A的右值改成2, 对应图里面的step3</li>\n</ul>\n</li>\n<li><p>其他节点编号更新</p>\n<ul>\n<li>条件 节点编号 &gt;&#x3D; 新增节点（B）的编号</li>\n<li>动作 编号+&#x3D;1</li>\n<li>该场景没有满足条件的</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"场景2\"><a href=\"#场景2\" class=\"headerlink\" title=\"场景2\"></a>场景2</h3><img src=\"/202306201125/2.png\" class=\"\" title=\"image\">\n<p>该场景与场景1一样</p>\n<h3 id=\"场景3\"><a href=\"#场景3\" class=\"headerlink\" title=\"场景3\"></a>场景3</h3><img src=\"/202306201125/3.png\" class=\"\" title=\"image\">\n\n<h3 id=\"结构优点\"><a href=\"#结构优点\" class=\"headerlink\" title=\"结构优点\"></a>结构优点</h3><ol>\n<li>计算子节点数量， （右值-左值）&#x2F;2，例如 A （8-1）&#x2F;2&#x3D;3 ，B （5-2）&#x2F;2&#x3D;1</li>\n<li>列出当前子节点（包括下层子节点），查询 节点左值&gt; 当前节点左值 并且 节点右值&lt;当前节点右值，a. 例如 B节点的所有子节点，即 where 左值&gt;2 and 右值&lt;5列出当前节点 一层子节点，通过parent node 即可</li>\n<li>列出当前节点 一层子节点，通过parent node 即可</li>\n<li>列出当前节点，特定层级的所有叶子结点， 结合2和树深即可</li>\n<li>展开整个树，通过编号排序即可</li>\n</ol>\n<h2 id=\"代码实现\"><a href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h2><figure class=\"highlight java\"><figcaption><span>节点代码</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* Copyright © 2020 Yuech and/or its affiliates. All rights reserved. */</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> wiki.chenxun.blog.example.reply;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.AllArgsConstructor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.Getter;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> 陈勋</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@version</span> 1.0</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2021-05-19 3:43 下午</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Node</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 节点id</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String id;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 树id，一般是文章id</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String treeId;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 　左值</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> Integer left;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 右值</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> Integer right;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 树深</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> Integer depth;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 编号</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> Integer index;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 商城节点id</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String parentId;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 数据</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String data;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Node <span class=\"title function_\">rootNote</span><span class=\"params\">(String id, String treeId,String data)</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">Node</span> <span class=\"variable\">node</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Node</span>(id, treeId, <span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"literal\">null</span>, data);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> node;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">incrementLeft</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">this</span>.left += <span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">incrementRight</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">this</span>.right += <span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">incrementIndex</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">this</span>.index += <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight java\"><figcaption><span>树代码</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* Copyright © 2020 Yuech and/or its affiliates. All rights reserved. */</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> wiki.chenxun.blog.example.reply;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.ArrayList;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Comparator;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.UUID;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.stream.Collectors;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * <span class=\"doctag\">@author</span> 陈勋</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@version</span> 1.0</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@date</span> 2021-06-18 6:37 下午</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Tree</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> String treeId;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> List&lt;Node&gt; nodeList = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> Node rootNode;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"title function_\">Tree</span><span class=\"params\">(String treeId,String data)</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">this</span>.treeId = treeId;</span><br><span class=\"line\">  <span class=\"built_in\">this</span>.rootNode = Node.rootNote(UUID.randomUUID().toString(), treeId,data);</span><br><span class=\"line\">  nodeList.add(rootNode);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">public</span> String <span class=\"title function_\">addNode</span><span class=\"params\">(String data, String parentNodeId)</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">       Node parentNode;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (parentNodeId != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">           parentNode = nodeList.stream()</span><br><span class=\"line\">               .filter(i -&gt; parentNodeId.equals(i.getId()))</span><br><span class=\"line\">               .findFirst().orElse(<span class=\"literal\">null</span>);</span><br><span class=\"line\">       &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">           parentNode = rootNode;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       <span class=\"keyword\">if</span> (parentNode == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">           <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalArgumentException</span>(<span class=\"string\">&quot;parent Node not exist&quot;</span>);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">final</span> <span class=\"type\">Integer</span> <span class=\"variable\">parentRight</span> <span class=\"operator\">=</span> parentNode.getRight();</span><br><span class=\"line\">       <span class=\"comment\">// 本次新增node在树里面的编号</span></span><br><span class=\"line\">       <span class=\"keyword\">final</span> <span class=\"type\">Integer</span> <span class=\"variable\">nodeIndex</span> <span class=\"operator\">=</span> parentNode.getIndex() + (parentNode.getRight() - parentNode.getLeft() + <span class=\"number\">1</span>) / <span class=\"number\">2</span>;</span><br><span class=\"line\">       <span class=\"comment\">// 数深</span></span><br><span class=\"line\">       <span class=\"keyword\">final</span> <span class=\"type\">Integer</span> <span class=\"variable\">nodeDepth</span> <span class=\"operator\">=</span> parentNode.getDepth() + <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// 构建子节点</span></span><br><span class=\"line\">       <span class=\"type\">Node</span> <span class=\"variable\">node</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Node</span>(UUID.randomUUID().toString(), <span class=\"built_in\">this</span>.treeId,</span><br><span class=\"line\">           parentNode.getRight(), parentNode.getRight() + <span class=\"number\">1</span>,</span><br><span class=\"line\">           nodeDepth, nodeIndex,</span><br><span class=\"line\">           parentNodeId, data);</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// 跟新其他节点左值</span></span><br><span class=\"line\">       nodeList.stream().filter(i -&gt; i.getLeft() &gt;= parentRight)</span><br><span class=\"line\">           .forEach(Node::incrementLeft);</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// 更新其他节点右值</span></span><br><span class=\"line\">       nodeList.stream().filter(i -&gt; i.getRight() &gt;= parentRight)</span><br><span class=\"line\">           .forEach(Node::incrementRight);</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">// 更新其他节点编号，大于等于index都往后挪一个位置</span></span><br><span class=\"line\">       nodeList.stream().filter(i -&gt; i.getIndex() &gt;= nodeIndex)</span><br><span class=\"line\">           .forEach(Node::incrementIndex);</span><br><span class=\"line\">       <span class=\"comment\">//添加新节点</span></span><br><span class=\"line\">       nodeList.add(node);</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"keyword\">return</span> node.getId();</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * 测试打印，左序遍历</span></span><br><span class=\"line\"><span class=\"comment\">      */</span></span><br><span class=\"line\">      <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">print</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">      nodeList.sort(Comparator.comparing(Node::getIndex));</span><br><span class=\"line\">      String s=String.join(<span class=\"string\">&quot;,&quot;</span>, nodeList.stream()</span><br><span class=\"line\">      .map(Node::getData).collect(Collectors.toList()));</span><br><span class=\"line\"></span><br><span class=\"line\">      System.out.println(s);</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><figcaption><span>测试代码</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">test</span><span class=\"params\">()</span>&#123;</span><br><span class=\"line\">    Tree tree=<span class=\"keyword\">new</span> <span class=\"title class_\">Tree</span>(<span class=\"string\">&quot;tree_1&quot;</span>,<span class=\"string\">&quot;文章&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    String a= tree.addNode(<span class=\"string\">&quot;a&quot;</span>,<span class=\"literal\">null</span>);</span><br><span class=\"line\">    String b=tree.addNode(<span class=\"string\">&quot;b&quot;</span>,<span class=\"literal\">null</span>);</span><br><span class=\"line\">    tree.addNode(<span class=\"string\">&quot;c&quot;</span>,a);</span><br><span class=\"line\">    tree.addNode(<span class=\"string\">&quot;d&quot;</span>,a);</span><br><span class=\"line\">    tree.addNode(<span class=\"string\">&quot;e&quot;</span>,b);</span><br><span class=\"line\"></span><br><span class=\"line\">    tree.print();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"业务应用\"><a href=\"#业务应用\" class=\"headerlink\" title=\"业务应用\"></a>业务应用</h2><ul>\n<li>数据可以和索引剥离，即data字段存的是数据id，root节点存文章id，其他节点存评论id</li>\n<li>新增节点的时候，需要把整颗树锁住<ul>\n<li>通过redis做分布式锁</li>\n<li>通过select for update 做数据库悲观锁 （不推荐）</li>\n<li>通过 新增version字段做乐观锁，树的版本等于root节点的版本（推荐）</li>\n</ul>\n</li>\n<li>删除节点，该场景下其实不删除索引，只是把数据id指向的数据删除<ul>\n<li>如果删除的太多，就需要把整个树reBuild.(本场景未实现,有需要的朋友可以给留言)</li>\n</ul>\n</li>\n</ul>\n"},{"title":"详解CopyOnWriter","abbrlink":59910,"date":"2023-06-20T07:12:34.000Z","_content":"# 详解CopyOnWriter\n\n**示例代码链接 https://github.com/ChenXun1989/study-example**\ncopyOnWriter顾名思义就是写的时候复制，是一种常见的计算机程序设计领域的优化策略。\n核心思想是当多个调用者访问同一个资源的时候(如内存或磁盘上的数据存储),他们会共同获取相同的指针指向同一个的资源。\n当每个调用者修改资源的时候,系统才会真正复制一份专用副本给该调用者，而其他调用者所见到的最初的资源仍然保持不变.\n专用副本修改完毕之后，替代真正的资源。最终所有访问者看到一致的视图。\n\n## CopyOnWriterArrayList的实现细节\n\nCopyOnWriterArrayList.get()方法\n\n{% codeblock  lang:java   %}\n\n    /**\n     * {@inheritDoc}\n     * \n     * @throws IndexOutOfBoundsException {@inheritDoc}\n    */\n    public E get(int index) {\n    return get(getArray(), index);\n    }\n\n     /**\n     *Gets the array.  Non-private so as to also be accessible\n     * from CopyOnWriteArraySet class.\n    */\n    final Object[] getArray() {\n    return array;\n    }\n\n    /** The array, accessed only via getArray/setArray. */\n    private transient volatile Object[] array;\n\n{% endcodeblock %}\n\n从源码上可以看出CopyOnWriterArrayList底层使用一个由volatile修饰的array数组来存值，\n而读一个volatile变量（相当于获取锁），JMM会把线程对应的本地内存置为无效，\n从而使得被监视器保护的临界区代码必须要从主内存中去读取共享变量。这样来保证读的变量是最新的。\n\nCopyOnWriterArrayList.add()方法\n\n{% codeblock  lang:java   %}\n\n    /**\n     * Appends the specified element to the end of this list.\n     * \n     * @param e element to be appended to this list\n     * @return {@code true} (as specified by {@link Collection#add})\n    */\n    public boolean add(E e) {\n    //获取写锁\n    final ReentrantLock lock = this.lock;\n    lock.lock();\n    try {\n    // 获取真正的资源\n    Object[] elements = getArray();\n    int len = elements.length;\n    // 复制一份私有副本\n    Object[] newElements = Arrays.copyOf(elements, len + 1);\n    // 修改私有副本\n    newElements[len] = e;\n    // 私有副本修改完毕之后，替代真正的资源\n    setArray(newElements);\n    return true;\n    } finally {\n    lock.unlock();\n    }\n    }\n\n    /**\n     * Sets the array.\n    */\n    final void setArray(Object[] a) {\n    array = a;\n    }\n\n{% endcodeblock %}\n\n从源码上可以看出CopyOnWriterArrayList里面add方法体现了CopyOnWriter的核心思想，具体步骤如下：\n1. 获取写锁\n2. 从原资源复制一份私有副本\n3. 修改私有副本\n4. 私有副本替换原资源\n5. 释放写锁\n\n## copyOnWriter的其他应用\n\nCopyOnWriter是一种常见的计算机程序设计领域的优化策略，例如redis里面的持久化机制\nredis处理数据是通过单线程的，但是很多场景我们需要持久化数据，reids则依赖系统的fork()函数的copyOnWriter实现。\nredis官方文档：\n> Whenever Redis needs to dump the dataset to disk, this is what happens:\n> Redis forks. We now have a child and a parent process.\n> The child starts to write the dataset to a temporary RDB file.\n> When the child is done writing the new RDB file, it replaces the old one.\n> This method allows Redis to benefit from copy-on-write semantics.\n\nliunx系统的fork函数实现方式使用copyOnWriter技术创建子进程。\n当父进程创建子进程时，内核只为子进程创建虚拟空间，父子两个进程使用的是相同的物理空间。只有父子进程发生更改时才会为子进程分配独立的物理空间。\n\n## copyOnWriter的优缺点\n1. copyOnWriter适用读多写少的场景\n2. 数据复制过程带来了更多得io消耗\n\n\n\n\n","source":"_posts/详解CopyOnWriter.md","raw":"---\ntitle: 详解CopyOnWriter\ntags:\n  - java\nabbrlink: 59910\ndate: 2023-06-20 15:12:34\n---\n# 详解CopyOnWriter\n\n**示例代码链接 https://github.com/ChenXun1989/study-example**\ncopyOnWriter顾名思义就是写的时候复制，是一种常见的计算机程序设计领域的优化策略。\n核心思想是当多个调用者访问同一个资源的时候(如内存或磁盘上的数据存储),他们会共同获取相同的指针指向同一个的资源。\n当每个调用者修改资源的时候,系统才会真正复制一份专用副本给该调用者，而其他调用者所见到的最初的资源仍然保持不变.\n专用副本修改完毕之后，替代真正的资源。最终所有访问者看到一致的视图。\n\n## CopyOnWriterArrayList的实现细节\n\nCopyOnWriterArrayList.get()方法\n\n{% codeblock  lang:java   %}\n\n    /**\n     * {@inheritDoc}\n     * \n     * @throws IndexOutOfBoundsException {@inheritDoc}\n    */\n    public E get(int index) {\n    return get(getArray(), index);\n    }\n\n     /**\n     *Gets the array.  Non-private so as to also be accessible\n     * from CopyOnWriteArraySet class.\n    */\n    final Object[] getArray() {\n    return array;\n    }\n\n    /** The array, accessed only via getArray/setArray. */\n    private transient volatile Object[] array;\n\n{% endcodeblock %}\n\n从源码上可以看出CopyOnWriterArrayList底层使用一个由volatile修饰的array数组来存值，\n而读一个volatile变量（相当于获取锁），JMM会把线程对应的本地内存置为无效，\n从而使得被监视器保护的临界区代码必须要从主内存中去读取共享变量。这样来保证读的变量是最新的。\n\nCopyOnWriterArrayList.add()方法\n\n{% codeblock  lang:java   %}\n\n    /**\n     * Appends the specified element to the end of this list.\n     * \n     * @param e element to be appended to this list\n     * @return {@code true} (as specified by {@link Collection#add})\n    */\n    public boolean add(E e) {\n    //获取写锁\n    final ReentrantLock lock = this.lock;\n    lock.lock();\n    try {\n    // 获取真正的资源\n    Object[] elements = getArray();\n    int len = elements.length;\n    // 复制一份私有副本\n    Object[] newElements = Arrays.copyOf(elements, len + 1);\n    // 修改私有副本\n    newElements[len] = e;\n    // 私有副本修改完毕之后，替代真正的资源\n    setArray(newElements);\n    return true;\n    } finally {\n    lock.unlock();\n    }\n    }\n\n    /**\n     * Sets the array.\n    */\n    final void setArray(Object[] a) {\n    array = a;\n    }\n\n{% endcodeblock %}\n\n从源码上可以看出CopyOnWriterArrayList里面add方法体现了CopyOnWriter的核心思想，具体步骤如下：\n1. 获取写锁\n2. 从原资源复制一份私有副本\n3. 修改私有副本\n4. 私有副本替换原资源\n5. 释放写锁\n\n## copyOnWriter的其他应用\n\nCopyOnWriter是一种常见的计算机程序设计领域的优化策略，例如redis里面的持久化机制\nredis处理数据是通过单线程的，但是很多场景我们需要持久化数据，reids则依赖系统的fork()函数的copyOnWriter实现。\nredis官方文档：\n> Whenever Redis needs to dump the dataset to disk, this is what happens:\n> Redis forks. We now have a child and a parent process.\n> The child starts to write the dataset to a temporary RDB file.\n> When the child is done writing the new RDB file, it replaces the old one.\n> This method allows Redis to benefit from copy-on-write semantics.\n\nliunx系统的fork函数实现方式使用copyOnWriter技术创建子进程。\n当父进程创建子进程时，内核只为子进程创建虚拟空间，父子两个进程使用的是相同的物理空间。只有父子进程发生更改时才会为子进程分配独立的物理空间。\n\n## copyOnWriter的优缺点\n1. copyOnWriter适用读多写少的场景\n2. 数据复制过程带来了更多得io消耗\n\n\n\n\n","slug":"详解CopyOnWriter","published":1,"updated":"2023-12-05T02:48:12.742Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdjd001uorgohruqappq","content":"<h1 id=\"详解CopyOnWriter\"><a href=\"#详解CopyOnWriter\" class=\"headerlink\" title=\"详解CopyOnWriter\"></a>详解CopyOnWriter</h1><p><strong>示例代码链接 <a href=\"https://github.com/ChenXun1989/study-example\">https://github.com/ChenXun1989/study-example</a></strong><br>copyOnWriter顾名思义就是写的时候复制，是一种常见的计算机程序设计领域的优化策略。<br>核心思想是当多个调用者访问同一个资源的时候(如内存或磁盘上的数据存储),他们会共同获取相同的指针指向同一个的资源。<br>当每个调用者修改资源的时候,系统才会真正复制一份专用副本给该调用者，而其他调用者所见到的最初的资源仍然保持不变.<br>专用副本修改完毕之后，替代真正的资源。最终所有访问者看到一致的视图。</p>\n<h2 id=\"CopyOnWriterArrayList的实现细节\"><a href=\"#CopyOnWriterArrayList的实现细节\" class=\"headerlink\" title=\"CopyOnWriterArrayList的实现细节\"></a>CopyOnWriterArrayList的实现细节</h2><p>CopyOnWriterArrayList.get()方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &#123;<span class=\"doctag\">@inheritDoc</span>&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> * </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@throws</span> IndexOutOfBoundsException &#123;<span class=\"doctag\">@inheritDoc</span>&#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> E <span class=\"title function_\">get</span><span class=\"params\">(<span class=\"type\">int</span> index)</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">return</span> get(getArray(), index);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> *Gets the array.  Non-private so as to also be accessible</span></span><br><span class=\"line\"><span class=\"comment\"> * from CopyOnWriteArraySet class.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> Object[] getArray() &#123;</span><br><span class=\"line\"><span class=\"keyword\">return</span> array;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/** The array, accessed only via getArray/setArray. */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> <span class=\"keyword\">volatile</span> Object[] array;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>从源码上可以看出CopyOnWriterArrayList底层使用一个由volatile修饰的array数组来存值，<br>而读一个volatile变量（相当于获取锁），JMM会把线程对应的本地内存置为无效，<br>从而使得被监视器保护的临界区代码必须要从主内存中去读取共享变量。这样来保证读的变量是最新的。</p>\n<p>CopyOnWriterArrayList.add()方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Appends the specified element to the end of this list.</span></span><br><span class=\"line\"><span class=\"comment\"> * </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> e element to be appended to this list</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> &#123;<span class=\"doctag\">@code</span> true&#125; (as specified by &#123;<span class=\"doctag\">@link</span> Collection#add&#125;)</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">add</span><span class=\"params\">(E e)</span> &#123;</span><br><span class=\"line\"><span class=\"comment\">//获取写锁</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">ReentrantLock</span> <span class=\"variable\">lock</span> <span class=\"operator\">=</span> <span class=\"built_in\">this</span>.lock;</span><br><span class=\"line\">lock.lock();</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"><span class=\"comment\">// 获取真正的资源</span></span><br><span class=\"line\">Object[] elements = getArray();</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">len</span> <span class=\"operator\">=</span> elements.length;</span><br><span class=\"line\"><span class=\"comment\">// 复制一份私有副本</span></span><br><span class=\"line\">Object[] newElements = Arrays.copyOf(elements, len + <span class=\"number\">1</span>);</span><br><span class=\"line\"><span class=\"comment\">// 修改私有副本</span></span><br><span class=\"line\">newElements[len] = e;</span><br><span class=\"line\"><span class=\"comment\">// 私有副本修改完毕之后，替代真正的资源</span></span><br><span class=\"line\">setArray(newElements);</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">lock.unlock();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Sets the array.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setArray</span><span class=\"params\">(Object[] a)</span> &#123;</span><br><span class=\"line\">array = a;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>从源码上可以看出CopyOnWriterArrayList里面add方法体现了CopyOnWriter的核心思想，具体步骤如下：</p>\n<ol>\n<li>获取写锁</li>\n<li>从原资源复制一份私有副本</li>\n<li>修改私有副本</li>\n<li>私有副本替换原资源</li>\n<li>释放写锁</li>\n</ol>\n<h2 id=\"copyOnWriter的其他应用\"><a href=\"#copyOnWriter的其他应用\" class=\"headerlink\" title=\"copyOnWriter的其他应用\"></a>copyOnWriter的其他应用</h2><p>CopyOnWriter是一种常见的计算机程序设计领域的优化策略，例如redis里面的持久化机制<br>redis处理数据是通过单线程的，但是很多场景我们需要持久化数据，reids则依赖系统的fork()函数的copyOnWriter实现。<br>redis官方文档：</p>\n<blockquote>\n<p>Whenever Redis needs to dump the dataset to disk, this is what happens:<br>Redis forks. We now have a child and a parent process.<br>The child starts to write the dataset to a temporary RDB file.<br>When the child is done writing the new RDB file, it replaces the old one.<br>This method allows Redis to benefit from copy-on-write semantics.</p>\n</blockquote>\n<p>liunx系统的fork函数实现方式使用copyOnWriter技术创建子进程。<br>当父进程创建子进程时，内核只为子进程创建虚拟空间，父子两个进程使用的是相同的物理空间。只有父子进程发生更改时才会为子进程分配独立的物理空间。</p>\n<h2 id=\"copyOnWriter的优缺点\"><a href=\"#copyOnWriter的优缺点\" class=\"headerlink\" title=\"copyOnWriter的优缺点\"></a>copyOnWriter的优缺点</h2><ol>\n<li>copyOnWriter适用读多写少的场景</li>\n<li>数据复制过程带来了更多得io消耗</li>\n</ol>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"详解CopyOnWriter\"><a href=\"#详解CopyOnWriter\" class=\"headerlink\" title=\"详解CopyOnWriter\"></a>详解CopyOnWriter</h1><p><strong>示例代码链接 <a href=\"https://github.com/ChenXun1989/study-example\">https://github.com/ChenXun1989/study-example</a></strong><br>copyOnWriter顾名思义就是写的时候复制，是一种常见的计算机程序设计领域的优化策略。<br>核心思想是当多个调用者访问同一个资源的时候(如内存或磁盘上的数据存储),他们会共同获取相同的指针指向同一个的资源。<br>当每个调用者修改资源的时候,系统才会真正复制一份专用副本给该调用者，而其他调用者所见到的最初的资源仍然保持不变.<br>专用副本修改完毕之后，替代真正的资源。最终所有访问者看到一致的视图。</p>\n<h2 id=\"CopyOnWriterArrayList的实现细节\"><a href=\"#CopyOnWriterArrayList的实现细节\" class=\"headerlink\" title=\"CopyOnWriterArrayList的实现细节\"></a>CopyOnWriterArrayList的实现细节</h2><p>CopyOnWriterArrayList.get()方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * &#123;<span class=\"doctag\">@inheritDoc</span>&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> * </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@throws</span> IndexOutOfBoundsException &#123;<span class=\"doctag\">@inheritDoc</span>&#125;</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> E <span class=\"title function_\">get</span><span class=\"params\">(<span class=\"type\">int</span> index)</span> &#123;</span><br><span class=\"line\"><span class=\"keyword\">return</span> get(getArray(), index);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> *Gets the array.  Non-private so as to also be accessible</span></span><br><span class=\"line\"><span class=\"comment\"> * from CopyOnWriteArraySet class.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> Object[] getArray() &#123;</span><br><span class=\"line\"><span class=\"keyword\">return</span> array;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/** The array, accessed only via getArray/setArray. */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> <span class=\"keyword\">volatile</span> Object[] array;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>从源码上可以看出CopyOnWriterArrayList底层使用一个由volatile修饰的array数组来存值，<br>而读一个volatile变量（相当于获取锁），JMM会把线程对应的本地内存置为无效，<br>从而使得被监视器保护的临界区代码必须要从主内存中去读取共享变量。这样来保证读的变量是最新的。</p>\n<p>CopyOnWriterArrayList.add()方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Appends the specified element to the end of this list.</span></span><br><span class=\"line\"><span class=\"comment\"> * </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> e element to be appended to this list</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> &#123;<span class=\"doctag\">@code</span> true&#125; (as specified by &#123;<span class=\"doctag\">@link</span> Collection#add&#125;)</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"type\">boolean</span> <span class=\"title function_\">add</span><span class=\"params\">(E e)</span> &#123;</span><br><span class=\"line\"><span class=\"comment\">//获取写锁</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"type\">ReentrantLock</span> <span class=\"variable\">lock</span> <span class=\"operator\">=</span> <span class=\"built_in\">this</span>.lock;</span><br><span class=\"line\">lock.lock();</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\"><span class=\"comment\">// 获取真正的资源</span></span><br><span class=\"line\">Object[] elements = getArray();</span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">len</span> <span class=\"operator\">=</span> elements.length;</span><br><span class=\"line\"><span class=\"comment\">// 复制一份私有副本</span></span><br><span class=\"line\">Object[] newElements = Arrays.copyOf(elements, len + <span class=\"number\">1</span>);</span><br><span class=\"line\"><span class=\"comment\">// 修改私有副本</span></span><br><span class=\"line\">newElements[len] = e;</span><br><span class=\"line\"><span class=\"comment\">// 私有副本修改完毕之后，替代真正的资源</span></span><br><span class=\"line\">setArray(newElements);</span><br><span class=\"line\"><span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">lock.unlock();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Sets the array.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setArray</span><span class=\"params\">(Object[] a)</span> &#123;</span><br><span class=\"line\">array = a;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>从源码上可以看出CopyOnWriterArrayList里面add方法体现了CopyOnWriter的核心思想，具体步骤如下：</p>\n<ol>\n<li>获取写锁</li>\n<li>从原资源复制一份私有副本</li>\n<li>修改私有副本</li>\n<li>私有副本替换原资源</li>\n<li>释放写锁</li>\n</ol>\n<h2 id=\"copyOnWriter的其他应用\"><a href=\"#copyOnWriter的其他应用\" class=\"headerlink\" title=\"copyOnWriter的其他应用\"></a>copyOnWriter的其他应用</h2><p>CopyOnWriter是一种常见的计算机程序设计领域的优化策略，例如redis里面的持久化机制<br>redis处理数据是通过单线程的，但是很多场景我们需要持久化数据，reids则依赖系统的fork()函数的copyOnWriter实现。<br>redis官方文档：</p>\n<blockquote>\n<p>Whenever Redis needs to dump the dataset to disk, this is what happens:<br>Redis forks. We now have a child and a parent process.<br>The child starts to write the dataset to a temporary RDB file.<br>When the child is done writing the new RDB file, it replaces the old one.<br>This method allows Redis to benefit from copy-on-write semantics.</p>\n</blockquote>\n<p>liunx系统的fork函数实现方式使用copyOnWriter技术创建子进程。<br>当父进程创建子进程时，内核只为子进程创建虚拟空间，父子两个进程使用的是相同的物理空间。只有父子进程发生更改时才会为子进程分配独立的物理空间。</p>\n<h2 id=\"copyOnWriter的优缺点\"><a href=\"#copyOnWriter的优缺点\" class=\"headerlink\" title=\"copyOnWriter的优缺点\"></a>copyOnWriter的优缺点</h2><ol>\n<li>copyOnWriter适用读多写少的场景</li>\n<li>数据复制过程带来了更多得io消耗</li>\n</ol>\n"},{"title":"领域驱动与微服务落地实战-工程结构","abbrlink":55742,"date":"2023-06-20T11:26:00.000Z","_content":"# 领域驱动与微服务落地实战-工程结构\n\n## 传统项目工程结构\n目前maven/gradle已经成为j2ee应用开发的事实标准，以maven项目为例，常规的微服务工程结构如下\n\n{% plantuml %}\n\n@startuml\n'https://plantuml.com/deployment-diagram\n\npackage api\n\npackage service\n\npackage infra\n\napi --> service \n\nservice --> infra\n\n@enduml\n\n{% endplantuml %}\n\n## api\n- dto 数据传输模型\n- facade（即soa interface）\n\n## service\n- serviceImpl 无状态 主要的业务代码实现，是事物的核心过程，\n- bo 对象 业务模型\n- transfer 对象 dto（包括自身接口和下游接口）->bo bo->po\n\n## infra\n- repo （mybatis｜hibernate）\n- po 持久化模型\n- soa client 下游接口\n\nmaven分多module的目的主要是做代码依赖隔离，和软件打包控制。按上图所示，api依赖service,\nservice依赖infra，这个是最简单的一个方案，实际项目中还有以下几种变种。\n\n> api 基于cqrs原则拆分成读写两套api，不拆maven module，一般通过类或者包拆分\n> service 可以基于垂直业务领域拆包，或者拆module（不建议，如果需要到拆module的程度，建议拆服务）\n\n> 基于水平业务拆分一层biz module 出来，解决service本身臃肿和复用问题。\n把service拆成可复用的单事物业务，和不可复用的大型业务两种。单事物业务之间不可互相引用。\n\n> 也可以单独把main函数拆成一个独立module，方便集成测试和单元测试，常见于spring boot项目\n\n> infra 把数据库访问单独拆 module，避免研发人员使用其他中间件api \n> 基于代码稳定性考虑，把soa client单独拆一个module，最大限度的隔离下游服务对核心业务代码的影响。\n\n## 基于领域驱动设计工程结构\n{% plantuml %}\n \n @startuml\n'https://plantuml.com/object-diagram\n\npackage api\n\npackage service\n\npackage infra\n\npackage application\n\npackage domain\n\napi --> service\n\nservice --> application\n\ndomain --> service\n\ndomain --> infra\n\ninfra --> application\n\n\n\n@enduml\n\n\n{% endplantuml %}\n\n> api 与传统项目的api模块没有区别\n\n> service 与传统项目的service模块相比，都是无状态的，也是事物的核心过程，但不是业务逻辑的核心实现，\n业务逻辑包装在domain内，service主要是协调一个或者多个domain对象，并且不能访问infra\n\n> infra 与传统项目的infra模块相比，依赖domain，代表是domain领域对象依赖组件的具体实现\n\n> domain 领域驱动架构的核心业务代码层，代码稳定，不依赖其他任何module，无外部依赖（基本只依赖java sdk）\n便于单元测试 和代码迁移\n\n> application main函数所在模块，主要是方便集成测试，和service模块的单元测试，并且mq的消费者也建议在该模块\n\n## 其他\n- maven的代码隔离，其实是编译阶段的隔离，通常在运行期业务代码都是appClassLoader加载，\n  不同maven module之间的代码在运行期其实是不隔离，所以要禁止通过反射等其他手段绕过相关访问限制\n- 在maven出现之前，传统的java应用都是ant打包方案，通过java的访问控制修饰符来控制代码访问权限，\n  但事实上，java代码访问控制修饰符大部分常见下基本只用private public，很少会基于包做严格的访问隔离，\n  最终maven多模块成为事实上的隔离标准。","source":"_posts/领域驱动与微服务落地实战-工程结构.md","raw":"---\ntitle: 领域驱动与微服务落地实战-工程结构\nabbrlink: 55742\ndate: 2023-06-20 19:26:00\ntags:\n---\n# 领域驱动与微服务落地实战-工程结构\n\n## 传统项目工程结构\n目前maven/gradle已经成为j2ee应用开发的事实标准，以maven项目为例，常规的微服务工程结构如下\n\n{% plantuml %}\n\n@startuml\n'https://plantuml.com/deployment-diagram\n\npackage api\n\npackage service\n\npackage infra\n\napi --> service \n\nservice --> infra\n\n@enduml\n\n{% endplantuml %}\n\n## api\n- dto 数据传输模型\n- facade（即soa interface）\n\n## service\n- serviceImpl 无状态 主要的业务代码实现，是事物的核心过程，\n- bo 对象 业务模型\n- transfer 对象 dto（包括自身接口和下游接口）->bo bo->po\n\n## infra\n- repo （mybatis｜hibernate）\n- po 持久化模型\n- soa client 下游接口\n\nmaven分多module的目的主要是做代码依赖隔离，和软件打包控制。按上图所示，api依赖service,\nservice依赖infra，这个是最简单的一个方案，实际项目中还有以下几种变种。\n\n> api 基于cqrs原则拆分成读写两套api，不拆maven module，一般通过类或者包拆分\n> service 可以基于垂直业务领域拆包，或者拆module（不建议，如果需要到拆module的程度，建议拆服务）\n\n> 基于水平业务拆分一层biz module 出来，解决service本身臃肿和复用问题。\n把service拆成可复用的单事物业务，和不可复用的大型业务两种。单事物业务之间不可互相引用。\n\n> 也可以单独把main函数拆成一个独立module，方便集成测试和单元测试，常见于spring boot项目\n\n> infra 把数据库访问单独拆 module，避免研发人员使用其他中间件api \n> 基于代码稳定性考虑，把soa client单独拆一个module，最大限度的隔离下游服务对核心业务代码的影响。\n\n## 基于领域驱动设计工程结构\n{% plantuml %}\n \n @startuml\n'https://plantuml.com/object-diagram\n\npackage api\n\npackage service\n\npackage infra\n\npackage application\n\npackage domain\n\napi --> service\n\nservice --> application\n\ndomain --> service\n\ndomain --> infra\n\ninfra --> application\n\n\n\n@enduml\n\n\n{% endplantuml %}\n\n> api 与传统项目的api模块没有区别\n\n> service 与传统项目的service模块相比，都是无状态的，也是事物的核心过程，但不是业务逻辑的核心实现，\n业务逻辑包装在domain内，service主要是协调一个或者多个domain对象，并且不能访问infra\n\n> infra 与传统项目的infra模块相比，依赖domain，代表是domain领域对象依赖组件的具体实现\n\n> domain 领域驱动架构的核心业务代码层，代码稳定，不依赖其他任何module，无外部依赖（基本只依赖java sdk）\n便于单元测试 和代码迁移\n\n> application main函数所在模块，主要是方便集成测试，和service模块的单元测试，并且mq的消费者也建议在该模块\n\n## 其他\n- maven的代码隔离，其实是编译阶段的隔离，通常在运行期业务代码都是appClassLoader加载，\n  不同maven module之间的代码在运行期其实是不隔离，所以要禁止通过反射等其他手段绕过相关访问限制\n- 在maven出现之前，传统的java应用都是ant打包方案，通过java的访问控制修饰符来控制代码访问权限，\n  但事实上，java代码访问控制修饰符大部分常见下基本只用private public，很少会基于包做严格的访问隔离，\n  最终maven多模块成为事实上的隔离标准。","slug":"领域驱动与微服务落地实战-工程结构","published":1,"updated":"2023-12-05T02:48:12.743Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdje001xorgod9b447x7","content":"<h1 id=\"领域驱动与微服务落地实战-工程结构\"><a href=\"#领域驱动与微服务落地实战-工程结构\" class=\"headerlink\" title=\"领域驱动与微服务落地实战-工程结构\"></a>领域驱动与微服务落地实战-工程结构</h1><h2 id=\"传统项目工程结构\"><a href=\"#传统项目工程结构\" class=\"headerlink\" title=\"传统项目工程结构\"></a>传统项目工程结构</h2><p>目前maven&#x2F;gradle已经成为j2ee应用开发的事实标准，以maven项目为例，常规的微服务工程结构如下</p>\n<img class=\"kroki\" src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXMtYXNjaWkiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIyNTBweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjExM3B4O2hlaWdodDoyNTBweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMTMgMjUwIiB3aWR0aD0iMTEzcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48IS0tZW50aXR5IGFwaS0tPjxnIGlkPSJlbGVtX2FwaSI+PHBhdGggZD0iTTI2LDYgTDYyLDYgQTMuNzUsMy43NSAwIDAgMSA2NC41LDguNSBMNzEuNSwyOC4yOTY5IEw4NiwyOC4yOTY5IEEyLjUsMi41IDAgMCAxIDg4LjUsMzAuNzk2OSBMODguNSw0Mi43OTY5IEEyLjUsMi41IDAgMCAxIDg2LDQ1LjI5NjkgTDI2LDQ1LjI5NjkgQTIuNSwyLjUgMCAwIDEgMjMuNSw0Mi43OTY5IEwyMy41LDguNSBBMi41LDIuNSAwIDAgMSAyNiw2ICIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMjMuNSIgeDI9IjcxLjUiIHkxPSIyOC4yOTY5IiB5Mj0iMjguMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMyIgeD0iMzMuNSIgeT0iMjEuOTk1MSI+YXBpPC90ZXh0PjwvZz48IS0tZW50aXR5IHNlcnZpY2UtLT48ZyBpZD0iZWxlbV9zZXJ2aWNlIj48cGF0aCBkPSJNOC41LDEwNS4zIEw3OS41LDEwNS4zIEEzLjc1LDMuNzUgMCAwIDEgODIsMTA3LjggTDg5LDEyNy41OTY5IEwxMDMuNSwxMjcuNTk2OSBBMi41LDIuNSAwIDAgMSAxMDYsMTMwLjA5NjkgTDEwNiwxNDIuMDk2OSBBMi41LDIuNSAwIDAgMSAxMDMuNSwxNDQuNTk2OSBMOC41LDE0NC41OTY5IEEyLjUsMi41IDAgMCAxIDYsMTQyLjA5NjkgTDYsMTA3LjggQTIuNSwyLjUgMCAwIDEgOC41LDEwNS4zICIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iNiIgeDI9Ijg5IiB5MT0iMTI3LjU5NjkiIHkyPSIxMjcuNTk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1OCIgeD0iMTYiIHk9IjEyMS4yOTUxIj5zZXJ2aWNlPC90ZXh0PjwvZz48IS0tZW50aXR5IGluZnJhLS0+PGcgaWQ9ImVsZW1faW5mcmEiPjxwYXRoIGQ9Ik0xOS41LDIwNC41OSBMNjguNSwyMDQuNTkgQTMuNzUsMy43NSAwIDAgMSA3MSwyMDcuMDkgTDc4LDIyNi44ODY5IEw5Mi41LDIyNi44ODY5IEEyLjUsMi41IDAgMCAxIDk1LDIyOS4zODY5IEw5NSwyNDEuMzg2OSBBMi41LDIuNSAwIDAgMSA5Mi41LDI0My44ODY5IEwxOS41LDI0My44ODY5IEEyLjUsMi41IDAgMCAxIDE3LDI0MS4zODY5IEwxNywyMDcuMDkgQTIuNSwyLjUgMCAwIDEgMTkuNSwyMDQuNTkgIiBmaWxsPSIjRjFGMUYxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxNyIgeDI9Ijc4IiB5MT0iMjI2Ljg4NjkiIHkyPSIyMjYuODg2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzNiIgeD0iMjciIHk9IjIyMC41ODUxIj5pbmZyYTwvdGV4dD48L2c+PCEtLWxpbmsgYXBpIHRvIHNlcnZpY2UtLT48ZyBpZD0ibGlua19hcGlfc2VydmljZSI+PHBhdGggZD0iTTU2LDQ1LjQxIEM1Niw2Mi41MyA1Niw4MS43MSA1Niw5OC45MSAiIGZpbGw9Im5vbmUiIGlkPSJhcGktdG8tc2VydmljZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1NiwxMDQuOTEsNjAsOTUuOTEsNTYsOTkuOTEsNTIsOTUuOTEsNTYsMTA0LjkxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgc2VydmljZSB0byBpbmZyYS0tPjxnIGlkPSJsaW5rX3NlcnZpY2VfaW5mcmEiPjxwYXRoIGQ9Ik01NiwxNDQuNyBDNTYsMTYxLjgyIDU2LDE4MSA1NiwxOTguMjEgIiBmaWxsPSJub25lIiBpZD0ic2VydmljZS10by1pbmZyYSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1NiwyMDQuMjEsNjAsMTk1LjIxLDU2LDE5OS4yMSw1MiwxOTUuMjEsNTYsMjA0LjIxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLVNSQz1bSE9leDNlMFc0ME54RkdNVDVUOVJVOVNEaDRaYWl1N0xuRGtoQ09Ka2xQY1BUWDVrWXA0U0NTa1B1Y25CQ2V1dWJaakg1a3EyLWVlOVdENFV3NGFYWHQ0UXJJak82WTNhaElCMDZvY2pyLXVMRzV5Vl9RQzddLS0+PC9nPjwvc3ZnPg=='>\n\n<h2 id=\"api\"><a href=\"#api\" class=\"headerlink\" title=\"api\"></a>api</h2><ul>\n<li>dto 数据传输模型</li>\n<li>facade（即soa interface）</li>\n</ul>\n<h2 id=\"service\"><a href=\"#service\" class=\"headerlink\" title=\"service\"></a>service</h2><ul>\n<li>serviceImpl 无状态 主要的业务代码实现，是事物的核心过程，</li>\n<li>bo 对象 业务模型</li>\n<li>transfer 对象 dto（包括自身接口和下游接口）-&gt;bo bo-&gt;po</li>\n</ul>\n<h2 id=\"infra\"><a href=\"#infra\" class=\"headerlink\" title=\"infra\"></a>infra</h2><ul>\n<li>repo （mybatis｜hibernate）</li>\n<li>po 持久化模型</li>\n<li>soa client 下游接口</li>\n</ul>\n<p>maven分多module的目的主要是做代码依赖隔离，和软件打包控制。按上图所示，api依赖service,<br>service依赖infra，这个是最简单的一个方案，实际项目中还有以下几种变种。</p>\n<blockquote>\n<p>api 基于cqrs原则拆分成读写两套api，不拆maven module，一般通过类或者包拆分<br>service 可以基于垂直业务领域拆包，或者拆module（不建议，如果需要到拆module的程度，建议拆服务）</p>\n</blockquote>\n<blockquote>\n<p>基于水平业务拆分一层biz module 出来，解决service本身臃肿和复用问题。<br>把service拆成可复用的单事物业务，和不可复用的大型业务两种。单事物业务之间不可互相引用。</p>\n</blockquote>\n<blockquote>\n<p>也可以单独把main函数拆成一个独立module，方便集成测试和单元测试，常见于spring boot项目</p>\n</blockquote>\n<blockquote>\n<p>infra 把数据库访问单独拆 module，避免研发人员使用其他中间件api<br>基于代码稳定性考虑，把soa client单独拆一个module，最大限度的隔离下游服务对核心业务代码的影响。</p>\n</blockquote>\n<h2 id=\"基于领域驱动设计工程结构\"><a href=\"#基于领域驱动设计工程结构\" class=\"headerlink\" title=\"基于领域驱动设计工程结构\"></a>基于领域驱动设计工程结构</h2><img class=\"kroki\" src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXMtYXNjaWkiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIyNTBweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjIzMnB4O2hlaWdodDoyNTBweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAyMzIgMjUwIiB3aWR0aD0iMjMycHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48IS0tZW50aXR5IGFwaS0tPjxnIGlkPSJlbGVtX2FwaSI+PHBhdGggZD0iTTI2LDYgTDYyLDYgQTMuNzUsMy43NSAwIDAgMSA2NC41LDguNSBMNzEuNSwyOC4yOTY5IEw4NiwyOC4yOTY5IEEyLjUsMi41IDAgMCAxIDg4LjUsMzAuNzk2OSBMODguNSw0Mi43OTY5IEEyLjUsMi41IDAgMCAxIDg2LDQ1LjI5NjkgTDI2LDQ1LjI5NjkgQTIuNSwyLjUgMCAwIDEgMjMuNSw0Mi43OTY5IEwyMy41LDguNSBBMi41LDIuNSAwIDAgMSAyNiw2ICIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMjMuNSIgeDI9IjcxLjUiIHkxPSIyOC4yOTY5IiB5Mj0iMjguMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMyIgeD0iMzMuNSIgeT0iMjEuOTk1MSI+YXBpPC90ZXh0PjwvZz48IS0tZW50aXR5IHNlcnZpY2UtLT48ZyBpZD0iZWxlbV9zZXJ2aWNlIj48cGF0aCBkPSJNOC41LDEwNS4zIEw3OS41LDEwNS4zIEEzLjc1LDMuNzUgMCAwIDEgODIsMTA3LjggTDg5LDEyNy41OTY5IEwxMDMuNSwxMjcuNTk2OSBBMi41LDIuNSAwIDAgMSAxMDYsMTMwLjA5NjkgTDEwNiwxNDIuMDk2OSBBMi41LDIuNSAwIDAgMSAxMDMuNSwxNDQuNTk2OSBMOC41LDE0NC41OTY5IEEyLjUsMi41IDAgMCAxIDYsMTQyLjA5NjkgTDYsMTA3LjggQTIuNSwyLjUgMCAwIDEgOC41LDEwNS4zICIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iNiIgeDI9Ijg5IiB5MT0iMTI3LjU5NjkiIHkyPSIxMjcuNTk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1OCIgeD0iMTYiIHk9IjEyMS4yOTUxIj5zZXJ2aWNlPC90ZXh0PjwvZz48IS0tZW50aXR5IGluZnJhLS0+PGcgaWQ9ImVsZW1faW5mcmEiPjxwYXRoIGQ9Ik0xNDMuNSwxMDUuMyBMMTkyLjUsMTA1LjMgQTMuNzUsMy43NSAwIDAgMSAxOTUsMTA3LjggTDIwMiwxMjcuNTk2OSBMMjE2LjUsMTI3LjU5NjkgQTIuNSwyLjUgMCAwIDEgMjE5LDEzMC4wOTY5IEwyMTksMTQyLjA5NjkgQTIuNSwyLjUgMCAwIDEgMjE2LjUsMTQ0LjU5NjkgTDE0My41LDE0NC41OTY5IEEyLjUsMi41IDAgMCAxIDE0MSwxNDIuMDk2OSBMMTQxLDEwNy44IEEyLjUsMi41IDAgMCAxIDE0My41LDEwNS4zICIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTQxIiB4Mj0iMjAyIiB5MT0iMTI3LjU5NjkiIHkyPSIxMjcuNTk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzNiIgeD0iMTUxIiB5PSIxMjEuMjk1MSI+aW5mcmE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgYXBwbGljYXRpb24tLT48ZyBpZD0iZWxlbV9hcHBsaWNhdGlvbiI+PHBhdGggZD0iTTU3LDIwNC41OSBMMTU1LDIwNC41OSBBMy43NSwzLjc1IDAgMCAxIDE1Ny41LDIwNy4wOSBMMTY0LjUsMjI2Ljg4NjkgTDE3OSwyMjYuODg2OSBBMi41LDIuNSAwIDAgMSAxODEuNSwyMjkuMzg2OSBMMTgxLjUsMjQxLjM4NjkgQTIuNSwyLjUgMCAwIDEgMTc5LDI0My44ODY5IEw1NywyNDMuODg2OSBBMi41LDIuNSAwIDAgMSA1NC41LDI0MS4zODY5IEw1NC41LDIwNy4wOSBBMi41LDIuNSAwIDAgMSA1NywyMDQuNTkgIiBmaWxsPSIjRjFGMUYxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NC41IiB4Mj0iMTY0LjUiIHkxPSIyMjYuODg2OSIgeTI9IjIyNi44ODY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijg1IiB4PSI2NC41IiB5PSIyMjAuNTg1MSI+YXBwbGljYXRpb248L3RleHQ+PC9nPjwhLS1lbnRpdHkgZG9tYWluLS0+PGcgaWQ9ImVsZW1fZG9tYWluIj48cGF0aCBkPSJNMTI5LDYgTDE5OSw2IEEzLjc1LDMuNzUgMCAwIDEgMjAxLjUsOC41IEwyMDguNSwyOC4yOTY5IEwyMjMsMjguMjk2OSBBMi41LDIuNSAwIDAgMSAyMjUuNSwzMC43OTY5IEwyMjUuNSw0Mi43OTY5IEEyLjUsMi41IDAgMCAxIDIyMyw0NS4yOTY5IEwxMjksNDUuMjk2OSBBMi41LDIuNSAwIDAgMSAxMjYuNSw0Mi43OTY5IEwxMjYuNSw4LjUgQTIuNSwyLjUgMCAwIDEgMTI5LDYgIiBmaWxsPSIjRjFGMUYxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxMjYuNSIgeDI9IjIwOC41IiB5MT0iMjguMjk2OSIgeTI9IjI4LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTciIHg9IjEzNi41IiB5PSIyMS45OTUxIj5kb21haW48L3RleHQ+PC9nPjwhLS1saW5rIGFwaSB0byBzZXJ2aWNlLS0+PGcgaWQ9ImxpbmtfYXBpX3NlcnZpY2UiPjxwYXRoIGQ9Ik01Niw0NS40MSBDNTYsNjIuNTMgNTYsODEuNzEgNTYsOTguOTEgIiBmaWxsPSJub25lIiBpZD0iYXBpLXRvLXNlcnZpY2UiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTYsMTA0LjkxLDYwLDk1LjkxLDU2LDk5LjkxLDUyLDk1LjkxLDU2LDEwNC45MSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIHNlcnZpY2UgdG8gYXBwbGljYXRpb24tLT48ZyBpZD0ibGlua19zZXJ2aWNlX2FwcGxpY2F0aW9uIj48cGF0aCBkPSJNNjcuOTUsMTQ0LjcgQzc4Ljg2LDE2MS44MiA5MS42ODcsMTgxLjkzOTEgMTAyLjY0NywxOTkuMTQ5MSAiIGZpbGw9Im5vbmUiIGlkPSJzZXJ2aWNlLXRvLWFwcGxpY2F0aW9uIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwNS44NywyMDQuMjEsMTA0LjQwOTUsMTk0LjQ3LDEwMy4xODQyLDE5OS45OTI2LDk3LjY2MTYsMTk4Ljc2NzMsMTA1Ljg3LDIwNC4yMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIGRvbWFpbiB0byBzZXJ2aWNlLS0+PGcgaWQ9ImxpbmtfZG9tYWluX3NlcnZpY2UiPjxwYXRoIGQ9Ik0xNTIuNTgsNDUuNjQgQzEzMS40Myw2Mi43OCAxMDUuMTUwOCw4NC4wOTE1IDg0LjAyMDgsMTAxLjIyMTUgIiBmaWxsPSJub25lIiBpZD0iZG9tYWluLXRvLXNlcnZpY2UiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzkuMzYsMTA1LDg4Ljg3MDIsMTAyLjQzOTUsODMuMjQ0LDEwMS44NTEzLDgzLjgzMjIsOTYuMjI1MSw3OS4zNiwxMDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBkb21haW4gdG8gaW5mcmEtLT48ZyBpZD0ibGlua19kb21haW5faW5mcmEiPjxwYXRoIGQ9Ik0xNzYuNzcsNDUuNDEgQzE3Ny40OCw2Mi41MyAxNzguMjYyNSw4MS43MTUxIDE3OC45NzI1LDk4LjkxNTEgIiBmaWxsPSJub25lIiBpZD0iZG9tYWluLXRvLWluZnJhIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE3OS4yMiwxMDQuOTEsMTgyLjg0NTQsOTUuNzUyNywxNzkuMDEzOCw5OS45MTQzLDE3NC44NTIyLDk2LjA4MjYsMTc5LjIyLDEwNC45MSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIGluZnJhIHRvIGFwcGxpY2F0aW9uLS0+PGcgaWQ9ImxpbmtfaW5mcmFfYXBwbGljYXRpb24iPjxwYXRoIGQ9Ik0xNjguMDUsMTQ0LjcgQzE1Ny4xNCwxNjEuODIgMTQ0LjMxMywxODEuOTM5MSAxMzMuMzUzLDE5OS4xNDkxICIgZmlsbD0ibm9uZSIgaWQ9ImluZnJhLXRvLWFwcGxpY2F0aW9uIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEzMC4xMywyMDQuMjEsMTM4LjMzODQsMTk4Ljc2NzMsMTMyLjgxNTgsMTk5Ljk5MjYsMTMxLjU5MDUsMTk0LjQ3LDEzMC4xMywyMDQuMjEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tU1JDPVtQT3F4M2VDbTQ0SHhkdThrYk42VldoaUNZbURCXzVjUEpTdVZQOTBDSWhLeEpfRHZCQWdvRlBzSldBSVY2N2hBcVVMbnpRSHNPaW01cUhXMWxKN3gzaTlEUkJ2eWNObTNkNXU1THhDNDlZWmRyRTJLOHRaTlVyRGR4VDFBcGdWMk1fOTh0Q3FOVGV4TXlueXNGbTAwXS0tPjwvZz48L3N2Zz4='>\n\n<blockquote>\n<p>api 与传统项目的api模块没有区别</p>\n</blockquote>\n<blockquote>\n<p>service 与传统项目的service模块相比，都是无状态的，也是事物的核心过程，但不是业务逻辑的核心实现，<br>业务逻辑包装在domain内，service主要是协调一个或者多个domain对象，并且不能访问infra</p>\n</blockquote>\n<blockquote>\n<p>infra 与传统项目的infra模块相比，依赖domain，代表是domain领域对象依赖组件的具体实现</p>\n</blockquote>\n<blockquote>\n<p>domain 领域驱动架构的核心业务代码层，代码稳定，不依赖其他任何module，无外部依赖（基本只依赖java sdk）<br>便于单元测试 和代码迁移</p>\n</blockquote>\n<blockquote>\n<p>application main函数所在模块，主要是方便集成测试，和service模块的单元测试，并且mq的消费者也建议在该模块</p>\n</blockquote>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><ul>\n<li>maven的代码隔离，其实是编译阶段的隔离，通常在运行期业务代码都是appClassLoader加载，<br>不同maven module之间的代码在运行期其实是不隔离，所以要禁止通过反射等其他手段绕过相关访问限制</li>\n<li>在maven出现之前，传统的java应用都是ant打包方案，通过java的访问控制修饰符来控制代码访问权限，<br>但事实上，java代码访问控制修饰符大部分常见下基本只用private public，很少会基于包做严格的访问隔离，<br>最终maven多模块成为事实上的隔离标准。</li>\n</ul>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"领域驱动与微服务落地实战-工程结构\"><a href=\"#领域驱动与微服务落地实战-工程结构\" class=\"headerlink\" title=\"领域驱动与微服务落地实战-工程结构\"></a>领域驱动与微服务落地实战-工程结构</h1><h2 id=\"传统项目工程结构\"><a href=\"#传统项目工程结构\" class=\"headerlink\" title=\"传统项目工程结构\"></a>传统项目工程结构</h2><p>目前maven&#x2F;gradle已经成为j2ee应用开发的事实标准，以maven项目为例，常规的微服务工程结构如下</p>\n<img class=\"kroki\" src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXMtYXNjaWkiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIyNTBweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjExM3B4O2hlaWdodDoyNTBweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMTMgMjUwIiB3aWR0aD0iMTEzcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48IS0tZW50aXR5IGFwaS0tPjxnIGlkPSJlbGVtX2FwaSI+PHBhdGggZD0iTTI2LDYgTDYyLDYgQTMuNzUsMy43NSAwIDAgMSA2NC41LDguNSBMNzEuNSwyOC4yOTY5IEw4NiwyOC4yOTY5IEEyLjUsMi41IDAgMCAxIDg4LjUsMzAuNzk2OSBMODguNSw0Mi43OTY5IEEyLjUsMi41IDAgMCAxIDg2LDQ1LjI5NjkgTDI2LDQ1LjI5NjkgQTIuNSwyLjUgMCAwIDEgMjMuNSw0Mi43OTY5IEwyMy41LDguNSBBMi41LDIuNSAwIDAgMSAyNiw2ICIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMjMuNSIgeDI9IjcxLjUiIHkxPSIyOC4yOTY5IiB5Mj0iMjguMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMyIgeD0iMzMuNSIgeT0iMjEuOTk1MSI+YXBpPC90ZXh0PjwvZz48IS0tZW50aXR5IHNlcnZpY2UtLT48ZyBpZD0iZWxlbV9zZXJ2aWNlIj48cGF0aCBkPSJNOC41LDEwNS4zIEw3OS41LDEwNS4zIEEzLjc1LDMuNzUgMCAwIDEgODIsMTA3LjggTDg5LDEyNy41OTY5IEwxMDMuNSwxMjcuNTk2OSBBMi41LDIuNSAwIDAgMSAxMDYsMTMwLjA5NjkgTDEwNiwxNDIuMDk2OSBBMi41LDIuNSAwIDAgMSAxMDMuNSwxNDQuNTk2OSBMOC41LDE0NC41OTY5IEEyLjUsMi41IDAgMCAxIDYsMTQyLjA5NjkgTDYsMTA3LjggQTIuNSwyLjUgMCAwIDEgOC41LDEwNS4zICIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iNiIgeDI9Ijg5IiB5MT0iMTI3LjU5NjkiIHkyPSIxMjcuNTk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1OCIgeD0iMTYiIHk9IjEyMS4yOTUxIj5zZXJ2aWNlPC90ZXh0PjwvZz48IS0tZW50aXR5IGluZnJhLS0+PGcgaWQ9ImVsZW1faW5mcmEiPjxwYXRoIGQ9Ik0xOS41LDIwNC41OSBMNjguNSwyMDQuNTkgQTMuNzUsMy43NSAwIDAgMSA3MSwyMDcuMDkgTDc4LDIyNi44ODY5IEw5Mi41LDIyNi44ODY5IEEyLjUsMi41IDAgMCAxIDk1LDIyOS4zODY5IEw5NSwyNDEuMzg2OSBBMi41LDIuNSAwIDAgMSA5Mi41LDI0My44ODY5IEwxOS41LDI0My44ODY5IEEyLjUsMi41IDAgMCAxIDE3LDI0MS4zODY5IEwxNywyMDcuMDkgQTIuNSwyLjUgMCAwIDEgMTkuNSwyMDQuNTkgIiBmaWxsPSIjRjFGMUYxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxNyIgeDI9Ijc4IiB5MT0iMjI2Ljg4NjkiIHkyPSIyMjYuODg2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzNiIgeD0iMjciIHk9IjIyMC41ODUxIj5pbmZyYTwvdGV4dD48L2c+PCEtLWxpbmsgYXBpIHRvIHNlcnZpY2UtLT48ZyBpZD0ibGlua19hcGlfc2VydmljZSI+PHBhdGggZD0iTTU2LDQ1LjQxIEM1Niw2Mi41MyA1Niw4MS43MSA1Niw5OC45MSAiIGZpbGw9Im5vbmUiIGlkPSJhcGktdG8tc2VydmljZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1NiwxMDQuOTEsNjAsOTUuOTEsNTYsOTkuOTEsNTIsOTUuOTEsNTYsMTA0LjkxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgc2VydmljZSB0byBpbmZyYS0tPjxnIGlkPSJsaW5rX3NlcnZpY2VfaW5mcmEiPjxwYXRoIGQ9Ik01NiwxNDQuNyBDNTYsMTYxLjgyIDU2LDE4MSA1NiwxOTguMjEgIiBmaWxsPSJub25lIiBpZD0ic2VydmljZS10by1pbmZyYSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1NiwyMDQuMjEsNjAsMTk1LjIxLDU2LDE5OS4yMSw1MiwxOTUuMjEsNTYsMjA0LjIxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLVNSQz1bSE9leDNlMFc0ME54RkdNVDVUOVJVOVNEaDRaYWl1N0xuRGtoQ09Ka2xQY1BUWDVrWXA0U0NTa1B1Y25CQ2V1dWJaakg1a3EyLWVlOVdENFV3NGFYWHQ0UXJJak82WTNhaElCMDZvY2pyLXVMRzV5Vl9RQzddLS0+PC9nPjwvc3ZnPg=='>\n\n<h2 id=\"api\"><a href=\"#api\" class=\"headerlink\" title=\"api\"></a>api</h2><ul>\n<li>dto 数据传输模型</li>\n<li>facade（即soa interface）</li>\n</ul>\n<h2 id=\"service\"><a href=\"#service\" class=\"headerlink\" title=\"service\"></a>service</h2><ul>\n<li>serviceImpl 无状态 主要的业务代码实现，是事物的核心过程，</li>\n<li>bo 对象 业务模型</li>\n<li>transfer 对象 dto（包括自身接口和下游接口）-&gt;bo bo-&gt;po</li>\n</ul>\n<h2 id=\"infra\"><a href=\"#infra\" class=\"headerlink\" title=\"infra\"></a>infra</h2><ul>\n<li>repo （mybatis｜hibernate）</li>\n<li>po 持久化模型</li>\n<li>soa client 下游接口</li>\n</ul>\n<p>maven分多module的目的主要是做代码依赖隔离，和软件打包控制。按上图所示，api依赖service,<br>service依赖infra，这个是最简单的一个方案，实际项目中还有以下几种变种。</p>\n<blockquote>\n<p>api 基于cqrs原则拆分成读写两套api，不拆maven module，一般通过类或者包拆分<br>service 可以基于垂直业务领域拆包，或者拆module（不建议，如果需要到拆module的程度，建议拆服务）</p>\n</blockquote>\n<blockquote>\n<p>基于水平业务拆分一层biz module 出来，解决service本身臃肿和复用问题。<br>把service拆成可复用的单事物业务，和不可复用的大型业务两种。单事物业务之间不可互相引用。</p>\n</blockquote>\n<blockquote>\n<p>也可以单独把main函数拆成一个独立module，方便集成测试和单元测试，常见于spring boot项目</p>\n</blockquote>\n<blockquote>\n<p>infra 把数据库访问单独拆 module，避免研发人员使用其他中间件api<br>基于代码稳定性考虑，把soa client单独拆一个module，最大限度的隔离下游服务对核心业务代码的影响。</p>\n</blockquote>\n<h2 id=\"基于领域驱动设计工程结构\"><a href=\"#基于领域驱动设计工程结构\" class=\"headerlink\" title=\"基于领域驱动设计工程结构\"></a>基于领域驱动设计工程结构</h2><img class=\"kroki\" src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXMtYXNjaWkiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIyNTBweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjIzMnB4O2hlaWdodDoyNTBweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAyMzIgMjUwIiB3aWR0aD0iMjMycHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48IS0tZW50aXR5IGFwaS0tPjxnIGlkPSJlbGVtX2FwaSI+PHBhdGggZD0iTTI2LDYgTDYyLDYgQTMuNzUsMy43NSAwIDAgMSA2NC41LDguNSBMNzEuNSwyOC4yOTY5IEw4NiwyOC4yOTY5IEEyLjUsMi41IDAgMCAxIDg4LjUsMzAuNzk2OSBMODguNSw0Mi43OTY5IEEyLjUsMi41IDAgMCAxIDg2LDQ1LjI5NjkgTDI2LDQ1LjI5NjkgQTIuNSwyLjUgMCAwIDEgMjMuNSw0Mi43OTY5IEwyMy41LDguNSBBMi41LDIuNSAwIDAgMSAyNiw2ICIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMjMuNSIgeDI9IjcxLjUiIHkxPSIyOC4yOTY5IiB5Mj0iMjguMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMyIgeD0iMzMuNSIgeT0iMjEuOTk1MSI+YXBpPC90ZXh0PjwvZz48IS0tZW50aXR5IHNlcnZpY2UtLT48ZyBpZD0iZWxlbV9zZXJ2aWNlIj48cGF0aCBkPSJNOC41LDEwNS4zIEw3OS41LDEwNS4zIEEzLjc1LDMuNzUgMCAwIDEgODIsMTA3LjggTDg5LDEyNy41OTY5IEwxMDMuNSwxMjcuNTk2OSBBMi41LDIuNSAwIDAgMSAxMDYsMTMwLjA5NjkgTDEwNiwxNDIuMDk2OSBBMi41LDIuNSAwIDAgMSAxMDMuNSwxNDQuNTk2OSBMOC41LDE0NC41OTY5IEEyLjUsMi41IDAgMCAxIDYsMTQyLjA5NjkgTDYsMTA3LjggQTIuNSwyLjUgMCAwIDEgOC41LDEwNS4zICIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iNiIgeDI9Ijg5IiB5MT0iMTI3LjU5NjkiIHkyPSIxMjcuNTk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1OCIgeD0iMTYiIHk9IjEyMS4yOTUxIj5zZXJ2aWNlPC90ZXh0PjwvZz48IS0tZW50aXR5IGluZnJhLS0+PGcgaWQ9ImVsZW1faW5mcmEiPjxwYXRoIGQ9Ik0xNDMuNSwxMDUuMyBMMTkyLjUsMTA1LjMgQTMuNzUsMy43NSAwIDAgMSAxOTUsMTA3LjggTDIwMiwxMjcuNTk2OSBMMjE2LjUsMTI3LjU5NjkgQTIuNSwyLjUgMCAwIDEgMjE5LDEzMC4wOTY5IEwyMTksMTQyLjA5NjkgQTIuNSwyLjUgMCAwIDEgMjE2LjUsMTQ0LjU5NjkgTDE0My41LDE0NC41OTY5IEEyLjUsMi41IDAgMCAxIDE0MSwxNDIuMDk2OSBMMTQxLDEwNy44IEEyLjUsMi41IDAgMCAxIDE0My41LDEwNS4zICIgZmlsbD0iI0YxRjFGMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB4MT0iMTQxIiB4Mj0iMjAyIiB5MT0iMTI3LjU5NjkiIHkyPSIxMjcuNTk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzNiIgeD0iMTUxIiB5PSIxMjEuMjk1MSI+aW5mcmE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgYXBwbGljYXRpb24tLT48ZyBpZD0iZWxlbV9hcHBsaWNhdGlvbiI+PHBhdGggZD0iTTU3LDIwNC41OSBMMTU1LDIwNC41OSBBMy43NSwzLjc1IDAgMCAxIDE1Ny41LDIwNy4wOSBMMTY0LjUsMjI2Ljg4NjkgTDE3OSwyMjYuODg2OSBBMi41LDIuNSAwIDAgMSAxODEuNSwyMjkuMzg2OSBMMTgxLjUsMjQxLjM4NjkgQTIuNSwyLjUgMCAwIDEgMTc5LDI0My44ODY5IEw1NywyNDMuODg2OSBBMi41LDIuNSAwIDAgMSA1NC41LDI0MS4zODY5IEw1NC41LDIwNy4wOSBBMi41LDIuNSAwIDAgMSA1NywyMDQuNTkgIiBmaWxsPSIjRjFGMUYxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSI1NC41IiB4Mj0iMTY0LjUiIHkxPSIyMjYuODg2OSIgeTI9IjIyNi44ODY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijg1IiB4PSI2NC41IiB5PSIyMjAuNTg1MSI+YXBwbGljYXRpb248L3RleHQ+PC9nPjwhLS1lbnRpdHkgZG9tYWluLS0+PGcgaWQ9ImVsZW1fZG9tYWluIj48cGF0aCBkPSJNMTI5LDYgTDE5OSw2IEEzLjc1LDMuNzUgMCAwIDEgMjAxLjUsOC41IEwyMDguNSwyOC4yOTY5IEwyMjMsMjguMjk2OSBBMi41LDIuNSAwIDAgMSAyMjUuNSwzMC43OTY5IEwyMjUuNSw0Mi43OTY5IEEyLjUsMi41IDAgMCAxIDIyMyw0NS4yOTY5IEwxMjksNDUuMjk2OSBBMi41LDIuNSAwIDAgMSAxMjYuNSw0Mi43OTY5IEwxMjYuNSw4LjUgQTIuNSwyLjUgMCAwIDEgMTI5LDYgIiBmaWxsPSIjRjFGMUYxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHgxPSIxMjYuNSIgeDI9IjIwOC41IiB5MT0iMjguMjk2OSIgeTI9IjI4LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTciIHg9IjEzNi41IiB5PSIyMS45OTUxIj5kb21haW48L3RleHQ+PC9nPjwhLS1saW5rIGFwaSB0byBzZXJ2aWNlLS0+PGcgaWQ9ImxpbmtfYXBpX3NlcnZpY2UiPjxwYXRoIGQ9Ik01Niw0NS40MSBDNTYsNjIuNTMgNTYsODEuNzEgNTYsOTguOTEgIiBmaWxsPSJub25lIiBpZD0iYXBpLXRvLXNlcnZpY2UiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTYsMTA0LjkxLDYwLDk1LjkxLDU2LDk5LjkxLDUyLDk1LjkxLDU2LDEwNC45MSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIHNlcnZpY2UgdG8gYXBwbGljYXRpb24tLT48ZyBpZD0ibGlua19zZXJ2aWNlX2FwcGxpY2F0aW9uIj48cGF0aCBkPSJNNjcuOTUsMTQ0LjcgQzc4Ljg2LDE2MS44MiA5MS42ODcsMTgxLjkzOTEgMTAyLjY0NywxOTkuMTQ5MSAiIGZpbGw9Im5vbmUiIGlkPSJzZXJ2aWNlLXRvLWFwcGxpY2F0aW9uIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEwNS44NywyMDQuMjEsMTA0LjQwOTUsMTk0LjQ3LDEwMy4xODQyLDE5OS45OTI2LDk3LjY2MTYsMTk4Ljc2NzMsMTA1Ljg3LDIwNC4yMSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIGRvbWFpbiB0byBzZXJ2aWNlLS0+PGcgaWQ9ImxpbmtfZG9tYWluX3NlcnZpY2UiPjxwYXRoIGQ9Ik0xNTIuNTgsNDUuNjQgQzEzMS40Myw2Mi43OCAxMDUuMTUwOCw4NC4wOTE1IDg0LjAyMDgsMTAxLjIyMTUgIiBmaWxsPSJub25lIiBpZD0iZG9tYWluLXRvLXNlcnZpY2UiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzkuMzYsMTA1LDg4Ljg3MDIsMTAyLjQzOTUsODMuMjQ0LDEwMS44NTEzLDgzLjgzMjIsOTYuMjI1MSw3OS4zNiwxMDUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBkb21haW4gdG8gaW5mcmEtLT48ZyBpZD0ibGlua19kb21haW5faW5mcmEiPjxwYXRoIGQ9Ik0xNzYuNzcsNDUuNDEgQzE3Ny40OCw2Mi41MyAxNzguMjYyNSw4MS43MTUxIDE3OC45NzI1LDk4LjkxNTEgIiBmaWxsPSJub25lIiBpZD0iZG9tYWluLXRvLWluZnJhIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE3OS4yMiwxMDQuOTEsMTgyLjg0NTQsOTUuNzUyNywxNzkuMDEzOCw5OS45MTQzLDE3NC44NTIyLDk2LjA4MjYsMTc5LjIyLDEwNC45MSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIGluZnJhIHRvIGFwcGxpY2F0aW9uLS0+PGcgaWQ9ImxpbmtfaW5mcmFfYXBwbGljYXRpb24iPjxwYXRoIGQ9Ik0xNjguMDUsMTQ0LjcgQzE1Ny4xNCwxNjEuODIgMTQ0LjMxMywxODEuOTM5MSAxMzMuMzUzLDE5OS4xNDkxICIgZmlsbD0ibm9uZSIgaWQ9ImluZnJhLXRvLWFwcGxpY2F0aW9uIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEzMC4xMywyMDQuMjEsMTM4LjMzODQsMTk4Ljc2NzMsMTMyLjgxNTgsMTk5Ljk5MjYsMTMxLjU5MDUsMTk0LjQ3LDEzMC4xMywyMDQuMjEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tU1JDPVtQT3F4M2VDbTQ0SHhkdThrYk42VldoaUNZbURCXzVjUEpTdVZQOTBDSWhLeEpfRHZCQWdvRlBzSldBSVY2N2hBcVVMbnpRSHNPaW01cUhXMWxKN3gzaTlEUkJ2eWNObTNkNXU1THhDNDlZWmRyRTJLOHRaTlVyRGR4VDFBcGdWMk1fOTh0Q3FOVGV4TXlueXNGbTAwXS0tPjwvZz48L3N2Zz4='>\n\n<blockquote>\n<p>api 与传统项目的api模块没有区别</p>\n</blockquote>\n<blockquote>\n<p>service 与传统项目的service模块相比，都是无状态的，也是事物的核心过程，但不是业务逻辑的核心实现，<br>业务逻辑包装在domain内，service主要是协调一个或者多个domain对象，并且不能访问infra</p>\n</blockquote>\n<blockquote>\n<p>infra 与传统项目的infra模块相比，依赖domain，代表是domain领域对象依赖组件的具体实现</p>\n</blockquote>\n<blockquote>\n<p>domain 领域驱动架构的核心业务代码层，代码稳定，不依赖其他任何module，无外部依赖（基本只依赖java sdk）<br>便于单元测试 和代码迁移</p>\n</blockquote>\n<blockquote>\n<p>application main函数所在模块，主要是方便集成测试，和service模块的单元测试，并且mq的消费者也建议在该模块</p>\n</blockquote>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><ul>\n<li>maven的代码隔离，其实是编译阶段的隔离，通常在运行期业务代码都是appClassLoader加载，<br>不同maven module之间的代码在运行期其实是不隔离，所以要禁止通过反射等其他手段绕过相关访问限制</li>\n<li>在maven出现之前，传统的java应用都是ant打包方案，通过java的访问控制修饰符来控制代码访问权限，<br>但事实上，java代码访问控制修饰符大部分常见下基本只用private public，很少会基于包做严格的访问隔离，<br>最终maven多模块成为事实上的隔离标准。</li>\n</ul>\n"},{"title":"领域驱动与微服务落地实战-领域划分和建模","abbrlink":62550,"date":"2023-06-20T11:17:14.000Z","_content":"# 领域驱动与微服务落地实战-领域划分和建模\n\n## 领域划分-战略设计\n软件研发好比行军作战，领域划分则属于战略设计，影响整体大局。\n现代软件研发大部分都是迭代研发，整体的领域划分也会随着迭代调整，是一个演变过程，贯穿整个研发周期。\n如何做领域划分，有以下几个原则\n\n## 水平划分\n水平划分是基于业务层级，受应用架构的影响，一般会分 接入层（网关层），服务层，基础层。\n水平层级的依赖一般是单向的，即上层依赖下层。\n\n### 接入层（网关层）\n直接提供给外网访问数据，一般对接app或者h5，处理鉴权等。\n\n### 服务层\n提供具体业务服务能力，一般不对外，只提供soa接口，业务变更频繁，迭代快\n\n### 基础层\n具体业务服务依赖的一些通用服务，例如统一账户服务等，业务相对稳定，迭代慢\n\n## 垂直划分\n垂直划分，是基于一个水平层级能，基于细分业务领域拆分，例如原来商品和商户在一个业务服务，后面随着\n业务发展，拆成2个独立的垂直业务服务。垂直划分的服务依赖可以是双向，最终在同一个水平层级内不同的垂直服务的\n依赖关系会发展成网状，这个会增大服务治理的难度。\n\n## 非功能性拆分\n非功能性拆分，一般有to B/to C拆分，实时/离线拆分\n\n### to B/to C 拆分\n常见于cqrs风格架构，b/c两边的性能要求不一致，迭代频率不一致，稳定性保障不一致等导致切分服务\n\n### 离线/实时 拆分\n离线/实时场景下，大部分采用的技术栈不一样，语言不一样，虽然多语言应用在微服务里也是可行的，但为了简化研发和维护成本，一般还是拆分。\n\n## 如何做领域划分\n这个是一个没有标准答案的问题，仁者见仁，智者见智。以上几个原则是做划分时的一个主要参考。划分也不是一锤子买卖，\n所有的抽象都是建立在已知用例上，业务会变，会新增用例，当新增用例无法套到现有的领域划分里面，就需要调整领域划分。\n\n## 领域建模-战术设计\n领域划分解决了战略设计问题，那么领域建模则是具体的战术设计。领域建模是面向对象分析的方法论，\n它可以利用面向对象的特性（封装、多态，继承）有效地化解复杂性。区别于传统的面向数据模型建模（er图），\n领域建模是以对象模型为中心，建模过程就是面向对象分析过程，具体的建模过程，建议使用uml来辅助建模，常见的\numl建模图有以下几种\n\n### 用例图\n用例图是基于场景的模型，描述了人员使用该软件系统做了什么，是需求功能的直观抽象\n\n### 类图\n类图描述了领域模型核心属性和功能，并体现了面向对象的特性（继承，封装，多态）\n\n### 流程图\n流程图描述了业务流程的节点，和相关流转\n\n### 时序图\n时序图细化某个用例的具体实现，体现在该场景下不同应用节点之间的交互时序\n\n### 架构图\n体现服务应用之间的层级，业务边界，依赖关系，支撑领域划分\n\n## 附录书籍\n- 《UML面向对象分析与设计》\n- 《领域驱动设计：软件核心复杂性应对之道》\n\n\n\n","source":"_posts/领域驱动与微服务落地实战-领域划分和建模.md","raw":"---\ntitle: 领域驱动与微服务落地实战-领域划分和建模\nabbrlink: 62550\ndate: 2023-06-20 19:17:14\ntags:\n---\n# 领域驱动与微服务落地实战-领域划分和建模\n\n## 领域划分-战略设计\n软件研发好比行军作战，领域划分则属于战略设计，影响整体大局。\n现代软件研发大部分都是迭代研发，整体的领域划分也会随着迭代调整，是一个演变过程，贯穿整个研发周期。\n如何做领域划分，有以下几个原则\n\n## 水平划分\n水平划分是基于业务层级，受应用架构的影响，一般会分 接入层（网关层），服务层，基础层。\n水平层级的依赖一般是单向的，即上层依赖下层。\n\n### 接入层（网关层）\n直接提供给外网访问数据，一般对接app或者h5，处理鉴权等。\n\n### 服务层\n提供具体业务服务能力，一般不对外，只提供soa接口，业务变更频繁，迭代快\n\n### 基础层\n具体业务服务依赖的一些通用服务，例如统一账户服务等，业务相对稳定，迭代慢\n\n## 垂直划分\n垂直划分，是基于一个水平层级能，基于细分业务领域拆分，例如原来商品和商户在一个业务服务，后面随着\n业务发展，拆成2个独立的垂直业务服务。垂直划分的服务依赖可以是双向，最终在同一个水平层级内不同的垂直服务的\n依赖关系会发展成网状，这个会增大服务治理的难度。\n\n## 非功能性拆分\n非功能性拆分，一般有to B/to C拆分，实时/离线拆分\n\n### to B/to C 拆分\n常见于cqrs风格架构，b/c两边的性能要求不一致，迭代频率不一致，稳定性保障不一致等导致切分服务\n\n### 离线/实时 拆分\n离线/实时场景下，大部分采用的技术栈不一样，语言不一样，虽然多语言应用在微服务里也是可行的，但为了简化研发和维护成本，一般还是拆分。\n\n## 如何做领域划分\n这个是一个没有标准答案的问题，仁者见仁，智者见智。以上几个原则是做划分时的一个主要参考。划分也不是一锤子买卖，\n所有的抽象都是建立在已知用例上，业务会变，会新增用例，当新增用例无法套到现有的领域划分里面，就需要调整领域划分。\n\n## 领域建模-战术设计\n领域划分解决了战略设计问题，那么领域建模则是具体的战术设计。领域建模是面向对象分析的方法论，\n它可以利用面向对象的特性（封装、多态，继承）有效地化解复杂性。区别于传统的面向数据模型建模（er图），\n领域建模是以对象模型为中心，建模过程就是面向对象分析过程，具体的建模过程，建议使用uml来辅助建模，常见的\numl建模图有以下几种\n\n### 用例图\n用例图是基于场景的模型，描述了人员使用该软件系统做了什么，是需求功能的直观抽象\n\n### 类图\n类图描述了领域模型核心属性和功能，并体现了面向对象的特性（继承，封装，多态）\n\n### 流程图\n流程图描述了业务流程的节点，和相关流转\n\n### 时序图\n时序图细化某个用例的具体实现，体现在该场景下不同应用节点之间的交互时序\n\n### 架构图\n体现服务应用之间的层级，业务边界，依赖关系，支撑领域划分\n\n## 附录书籍\n- 《UML面向对象分析与设计》\n- 《领域驱动设计：软件核心复杂性应对之道》\n\n\n\n","slug":"领域驱动与微服务落地实战-领域划分和建模","published":1,"updated":"2023-12-05T02:48:12.743Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clqtmzdjf001zorgo1mt3hxqv","content":"<h1 id=\"领域驱动与微服务落地实战-领域划分和建模\"><a href=\"#领域驱动与微服务落地实战-领域划分和建模\" class=\"headerlink\" title=\"领域驱动与微服务落地实战-领域划分和建模\"></a>领域驱动与微服务落地实战-领域划分和建模</h1><h2 id=\"领域划分-战略设计\"><a href=\"#领域划分-战略设计\" class=\"headerlink\" title=\"领域划分-战略设计\"></a>领域划分-战略设计</h2><p>软件研发好比行军作战，领域划分则属于战略设计，影响整体大局。<br>现代软件研发大部分都是迭代研发，整体的领域划分也会随着迭代调整，是一个演变过程，贯穿整个研发周期。<br>如何做领域划分，有以下几个原则</p>\n<h2 id=\"水平划分\"><a href=\"#水平划分\" class=\"headerlink\" title=\"水平划分\"></a>水平划分</h2><p>水平划分是基于业务层级，受应用架构的影响，一般会分 接入层（网关层），服务层，基础层。<br>水平层级的依赖一般是单向的，即上层依赖下层。</p>\n<h3 id=\"接入层（网关层）\"><a href=\"#接入层（网关层）\" class=\"headerlink\" title=\"接入层（网关层）\"></a>接入层（网关层）</h3><p>直接提供给外网访问数据，一般对接app或者h5，处理鉴权等。</p>\n<h3 id=\"服务层\"><a href=\"#服务层\" class=\"headerlink\" title=\"服务层\"></a>服务层</h3><p>提供具体业务服务能力，一般不对外，只提供soa接口，业务变更频繁，迭代快</p>\n<h3 id=\"基础层\"><a href=\"#基础层\" class=\"headerlink\" title=\"基础层\"></a>基础层</h3><p>具体业务服务依赖的一些通用服务，例如统一账户服务等，业务相对稳定，迭代慢</p>\n<h2 id=\"垂直划分\"><a href=\"#垂直划分\" class=\"headerlink\" title=\"垂直划分\"></a>垂直划分</h2><p>垂直划分，是基于一个水平层级能，基于细分业务领域拆分，例如原来商品和商户在一个业务服务，后面随着<br>业务发展，拆成2个独立的垂直业务服务。垂直划分的服务依赖可以是双向，最终在同一个水平层级内不同的垂直服务的<br>依赖关系会发展成网状，这个会增大服务治理的难度。</p>\n<h2 id=\"非功能性拆分\"><a href=\"#非功能性拆分\" class=\"headerlink\" title=\"非功能性拆分\"></a>非功能性拆分</h2><p>非功能性拆分，一般有to B&#x2F;to C拆分，实时&#x2F;离线拆分</p>\n<h3 id=\"to-B-x2F-to-C-拆分\"><a href=\"#to-B-x2F-to-C-拆分\" class=\"headerlink\" title=\"to B&#x2F;to C 拆分\"></a>to B&#x2F;to C 拆分</h3><p>常见于cqrs风格架构，b&#x2F;c两边的性能要求不一致，迭代频率不一致，稳定性保障不一致等导致切分服务</p>\n<h3 id=\"离线-x2F-实时-拆分\"><a href=\"#离线-x2F-实时-拆分\" class=\"headerlink\" title=\"离线&#x2F;实时 拆分\"></a>离线&#x2F;实时 拆分</h3><p>离线&#x2F;实时场景下，大部分采用的技术栈不一样，语言不一样，虽然多语言应用在微服务里也是可行的，但为了简化研发和维护成本，一般还是拆分。</p>\n<h2 id=\"如何做领域划分\"><a href=\"#如何做领域划分\" class=\"headerlink\" title=\"如何做领域划分\"></a>如何做领域划分</h2><p>这个是一个没有标准答案的问题，仁者见仁，智者见智。以上几个原则是做划分时的一个主要参考。划分也不是一锤子买卖，<br>所有的抽象都是建立在已知用例上，业务会变，会新增用例，当新增用例无法套到现有的领域划分里面，就需要调整领域划分。</p>\n<h2 id=\"领域建模-战术设计\"><a href=\"#领域建模-战术设计\" class=\"headerlink\" title=\"领域建模-战术设计\"></a>领域建模-战术设计</h2><p>领域划分解决了战略设计问题，那么领域建模则是具体的战术设计。领域建模是面向对象分析的方法论，<br>它可以利用面向对象的特性（封装、多态，继承）有效地化解复杂性。区别于传统的面向数据模型建模（er图），<br>领域建模是以对象模型为中心，建模过程就是面向对象分析过程，具体的建模过程，建议使用uml来辅助建模，常见的<br>uml建模图有以下几种</p>\n<h3 id=\"用例图\"><a href=\"#用例图\" class=\"headerlink\" title=\"用例图\"></a>用例图</h3><p>用例图是基于场景的模型，描述了人员使用该软件系统做了什么，是需求功能的直观抽象</p>\n<h3 id=\"类图\"><a href=\"#类图\" class=\"headerlink\" title=\"类图\"></a>类图</h3><p>类图描述了领域模型核心属性和功能，并体现了面向对象的特性（继承，封装，多态）</p>\n<h3 id=\"流程图\"><a href=\"#流程图\" class=\"headerlink\" title=\"流程图\"></a>流程图</h3><p>流程图描述了业务流程的节点，和相关流转</p>\n<h3 id=\"时序图\"><a href=\"#时序图\" class=\"headerlink\" title=\"时序图\"></a>时序图</h3><p>时序图细化某个用例的具体实现，体现在该场景下不同应用节点之间的交互时序</p>\n<h3 id=\"架构图\"><a href=\"#架构图\" class=\"headerlink\" title=\"架构图\"></a>架构图</h3><p>体现服务应用之间的层级，业务边界，依赖关系，支撑领域划分</p>\n<h2 id=\"附录书籍\"><a href=\"#附录书籍\" class=\"headerlink\" title=\"附录书籍\"></a>附录书籍</h2><ul>\n<li>《UML面向对象分析与设计》</li>\n<li>《领域驱动设计：软件核心复杂性应对之道》</li>\n</ul>\n","site":{"data":{"styles":"/* build time:Sun Dec 31 2023 23:18:27 GMT+0800 (China Standard Time)*/\nbody{background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center}.main-inner>.comments,.main-inner>.pagination,.main-inner>.post-block,.main-inner>.sub-menu,.main-inner>.tabs-comment{background:rgba(245,245,245,.42)}.posts-expand .post-title-link{color:#000}.posts-expand .post-meta-container{color:#800}.sidebar{opacity:.7}.header-inner{background:rgba(255,255,255,.7)}.popup{opacity:.9}.main-inner{background-color:rgba(255,255,255,0);padding:0 40px 40px 40px}\n/* rebuild by neat */"}},"excerpt":"","more":"<h1 id=\"领域驱动与微服务落地实战-领域划分和建模\"><a href=\"#领域驱动与微服务落地实战-领域划分和建模\" class=\"headerlink\" title=\"领域驱动与微服务落地实战-领域划分和建模\"></a>领域驱动与微服务落地实战-领域划分和建模</h1><h2 id=\"领域划分-战略设计\"><a href=\"#领域划分-战略设计\" class=\"headerlink\" title=\"领域划分-战略设计\"></a>领域划分-战略设计</h2><p>软件研发好比行军作战，领域划分则属于战略设计，影响整体大局。<br>现代软件研发大部分都是迭代研发，整体的领域划分也会随着迭代调整，是一个演变过程，贯穿整个研发周期。<br>如何做领域划分，有以下几个原则</p>\n<h2 id=\"水平划分\"><a href=\"#水平划分\" class=\"headerlink\" title=\"水平划分\"></a>水平划分</h2><p>水平划分是基于业务层级，受应用架构的影响，一般会分 接入层（网关层），服务层，基础层。<br>水平层级的依赖一般是单向的，即上层依赖下层。</p>\n<h3 id=\"接入层（网关层）\"><a href=\"#接入层（网关层）\" class=\"headerlink\" title=\"接入层（网关层）\"></a>接入层（网关层）</h3><p>直接提供给外网访问数据，一般对接app或者h5，处理鉴权等。</p>\n<h3 id=\"服务层\"><a href=\"#服务层\" class=\"headerlink\" title=\"服务层\"></a>服务层</h3><p>提供具体业务服务能力，一般不对外，只提供soa接口，业务变更频繁，迭代快</p>\n<h3 id=\"基础层\"><a href=\"#基础层\" class=\"headerlink\" title=\"基础层\"></a>基础层</h3><p>具体业务服务依赖的一些通用服务，例如统一账户服务等，业务相对稳定，迭代慢</p>\n<h2 id=\"垂直划分\"><a href=\"#垂直划分\" class=\"headerlink\" title=\"垂直划分\"></a>垂直划分</h2><p>垂直划分，是基于一个水平层级能，基于细分业务领域拆分，例如原来商品和商户在一个业务服务，后面随着<br>业务发展，拆成2个独立的垂直业务服务。垂直划分的服务依赖可以是双向，最终在同一个水平层级内不同的垂直服务的<br>依赖关系会发展成网状，这个会增大服务治理的难度。</p>\n<h2 id=\"非功能性拆分\"><a href=\"#非功能性拆分\" class=\"headerlink\" title=\"非功能性拆分\"></a>非功能性拆分</h2><p>非功能性拆分，一般有to B&#x2F;to C拆分，实时&#x2F;离线拆分</p>\n<h3 id=\"to-B-x2F-to-C-拆分\"><a href=\"#to-B-x2F-to-C-拆分\" class=\"headerlink\" title=\"to B&#x2F;to C 拆分\"></a>to B&#x2F;to C 拆分</h3><p>常见于cqrs风格架构，b&#x2F;c两边的性能要求不一致，迭代频率不一致，稳定性保障不一致等导致切分服务</p>\n<h3 id=\"离线-x2F-实时-拆分\"><a href=\"#离线-x2F-实时-拆分\" class=\"headerlink\" title=\"离线&#x2F;实时 拆分\"></a>离线&#x2F;实时 拆分</h3><p>离线&#x2F;实时场景下，大部分采用的技术栈不一样，语言不一样，虽然多语言应用在微服务里也是可行的，但为了简化研发和维护成本，一般还是拆分。</p>\n<h2 id=\"如何做领域划分\"><a href=\"#如何做领域划分\" class=\"headerlink\" title=\"如何做领域划分\"></a>如何做领域划分</h2><p>这个是一个没有标准答案的问题，仁者见仁，智者见智。以上几个原则是做划分时的一个主要参考。划分也不是一锤子买卖，<br>所有的抽象都是建立在已知用例上，业务会变，会新增用例，当新增用例无法套到现有的领域划分里面，就需要调整领域划分。</p>\n<h2 id=\"领域建模-战术设计\"><a href=\"#领域建模-战术设计\" class=\"headerlink\" title=\"领域建模-战术设计\"></a>领域建模-战术设计</h2><p>领域划分解决了战略设计问题，那么领域建模则是具体的战术设计。领域建模是面向对象分析的方法论，<br>它可以利用面向对象的特性（封装、多态，继承）有效地化解复杂性。区别于传统的面向数据模型建模（er图），<br>领域建模是以对象模型为中心，建模过程就是面向对象分析过程，具体的建模过程，建议使用uml来辅助建模，常见的<br>uml建模图有以下几种</p>\n<h3 id=\"用例图\"><a href=\"#用例图\" class=\"headerlink\" title=\"用例图\"></a>用例图</h3><p>用例图是基于场景的模型，描述了人员使用该软件系统做了什么，是需求功能的直观抽象</p>\n<h3 id=\"类图\"><a href=\"#类图\" class=\"headerlink\" title=\"类图\"></a>类图</h3><p>类图描述了领域模型核心属性和功能，并体现了面向对象的特性（继承，封装，多态）</p>\n<h3 id=\"流程图\"><a href=\"#流程图\" class=\"headerlink\" title=\"流程图\"></a>流程图</h3><p>流程图描述了业务流程的节点，和相关流转</p>\n<h3 id=\"时序图\"><a href=\"#时序图\" class=\"headerlink\" title=\"时序图\"></a>时序图</h3><p>时序图细化某个用例的具体实现，体现在该场景下不同应用节点之间的交互时序</p>\n<h3 id=\"架构图\"><a href=\"#架构图\" class=\"headerlink\" title=\"架构图\"></a>架构图</h3><p>体现服务应用之间的层级，业务边界，依赖关系，支撑领域划分</p>\n<h2 id=\"附录书籍\"><a href=\"#附录书籍\" class=\"headerlink\" title=\"附录书籍\"></a>附录书籍</h2><ul>\n<li>《UML面向对象分析与设计》</li>\n<li>《领域驱动设计：软件核心复杂性应对之道》</li>\n</ul>\n"}],"PostAsset":[{"_id":"source/_posts/JSR-133规范详解/1.png","post":"clqtmzdit0006orgocebtd5gl","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/JSR-133规范详解/2.png","post":"clqtmzdit0006orgocebtd5gl","slug":"2.png","modified":1,"renderable":1},{"_id":"source/_posts/JSR-133规范详解/3.png","post":"clqtmzdit0006orgocebtd5gl","slug":"3.png","modified":1,"renderable":1},{"_id":"source/_posts/RPC框架设计/1.png","post":"clqtmzdiu0008orgo9jz6grrm","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/dubbo源码研究之config模块/1.png","post":"clqtmzdiw000eorgo4bcfcn68","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/class装载/1.png","post":"clqtmzdiu0009orgo5zs8ekgb","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/dubbo源码研究之container模块/1.png","post":"clqtmzdix000gorgod5b9fmi2","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/dubbo源码研究之config-spring模块/1.png","post":"clqtmzdiw000corgo2yzm94p4","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/dubbo源码研究之config-spring模块/2.png","post":"clqtmzdiw000corgo2yzm94p4","slug":"2.png","modified":1,"renderable":1},{"_id":"source/_posts/dubbo源码研究之dubbo-registry模块/1.png","post":"clqtmzdiy000iorgohohyfuk3","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/dubbo源码研究之rpc模块/1.png","post":"clqtmzdj0000morgocdjd4aui","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/dubbo源码研究之rpc模块/2.png","post":"clqtmzdj0000morgocdjd4aui","slug":"2.png","modified":1,"renderable":1},{"_id":"source/_posts/dubbo源码研究之rpc模块/3.png","post":"clqtmzdj0000morgocdjd4aui","slug":"3.png","modified":1,"renderable":1},{"_id":"source/_posts/dubbo源码研究之rpc模块/4.png","post":"clqtmzdj0000morgocdjd4aui","slug":"4.png","modified":1,"renderable":1},{"_id":"source/_posts/dubbo源码研究之rpc模块/5.png","post":"clqtmzdj0000morgocdjd4aui","slug":"5.png","modified":1,"renderable":1},{"_id":"source/_posts/dubbo源码研究之extension模块/1.png","post":"clqtmzdiz000korgo6yaw8ujk","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/dubbo源码研究之extension模块/2.png","post":"clqtmzdiz000korgo6yaw8ujk","slug":"2.png","modified":1,"renderable":1},{"_id":"source/_posts/java内存结构和内存模型/1.png","post":"clqtmzdj3000sorgo17014ik3","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/jenkins进阶/img-1.png","post":"clqtmzdj6000zorgohafb5jfr","slug":"img-1.png","modified":1,"renderable":1},{"_id":"source/_posts/jenkins进阶/img.png","post":"clqtmzdj6000zorgohafb5jfr","slug":"img.png","modified":1,"renderable":1},{"_id":"source/_posts/ringBuffer深入浅出/1.png","post":"clqtmzdj70014orgo1oar0f2m","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/mybatis源码分析（一）/1.png","post":"clqtmzdj60012orgo45szaxb5","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/浅谈分布式项目日志监控/1.png","post":"clqtmzdjb001korgobacb82dz","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/聊聊营销-名词定义/1.png","post":"clqtmzdjc001norgoccjh907l","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/评论模块数据结构设计/1.png","post":"clqtmzdjd001sorgo32emaizo","slug":"1.png","modified":1,"renderable":1},{"_id":"source/_posts/评论模块数据结构设计/2.png","post":"clqtmzdjd001sorgo32emaizo","slug":"2.png","modified":1,"renderable":1},{"_id":"source/_posts/评论模块数据结构设计/3.png","post":"clqtmzdjd001sorgo32emaizo","slug":"3.png","modified":1,"renderable":1}],"PostCategory":[],"PostTag":[{"post_id":"clqtmzdik0001orgo4mt6azim","tag_id":"clqtmzdir0004orgo26vxhha9","_id":"clqtmzdiv000borgo1c3pcf7l"},{"post_id":"clqtmzdiu0009orgo5zs8ekgb","tag_id":"clqtmzdir0004orgo26vxhha9","_id":"clqtmzdiw000dorgo7v5qazcy"},{"post_id":"clqtmzdiq0003orgo7jt2dbs3","tag_id":"clqtmzdiv000aorgoc3hnhqgt","_id":"clqtmzdix000horgoazjxhm0b"},{"post_id":"clqtmzdit0006orgocebtd5gl","tag_id":"clqtmzdix000forgo9sk1frk5","_id":"clqtmzdj0000lorgo906kex2x"},{"post_id":"clqtmzdiu0008orgo9jz6grrm","tag_id":"clqtmzdiv000aorgoc3hnhqgt","_id":"clqtmzdj2000porgo6c485547"},{"post_id":"clqtmzdiw000corgo2yzm94p4","tag_id":"clqtmzdj1000norgo8cbw3vcb","_id":"clqtmzdj4000torgo37l849hs"},{"post_id":"clqtmzdj2000qorgo13uf93h4","tag_id":"clqtmzdix000forgo9sk1frk5","_id":"clqtmzdj5000vorgo0uw0583k"},{"post_id":"clqtmzdj3000sorgo17014ik3","tag_id":"clqtmzdix000forgo9sk1frk5","_id":"clqtmzdj5000yorgodxrefvhh"},{"post_id":"clqtmzdiw000eorgo4bcfcn68","tag_id":"clqtmzdj1000norgo8cbw3vcb","_id":"clqtmzdj60010orgo5s0w2tfa"},{"post_id":"clqtmzdj4000uorgo1xieeed5","tag_id":"clqtmzdix000forgo9sk1frk5","_id":"clqtmzdj70013orgohrez3dlm"},{"post_id":"clqtmzdix000gorgod5b9fmi2","tag_id":"clqtmzdj1000norgo8cbw3vcb","_id":"clqtmzdj70015orgo1t2k53r8"},{"post_id":"clqtmzdiy000iorgohohyfuk3","tag_id":"clqtmzdj1000norgo8cbw3vcb","_id":"clqtmzdj80018orgogipd2ea8"},{"post_id":"clqtmzdj70014orgo1oar0f2m","tag_id":"clqtmzdix000forgo9sk1frk5","_id":"clqtmzdj9001aorgo201zcug4"},{"post_id":"clqtmzdiz000korgo6yaw8ujk","tag_id":"clqtmzdj1000norgo8cbw3vcb","_id":"clqtmzdj9001dorgo158n741z"},{"post_id":"clqtmzdj0000morgocdjd4aui","tag_id":"clqtmzdj1000norgo8cbw3vcb","_id":"clqtmzdja001horgogu5o86d7"},{"post_id":"clqtmzdj9001eorgof1yw3x3h","tag_id":"clqtmzdix000forgo9sk1frk5","_id":"clqtmzdjb001jorgoay314l55"},{"post_id":"clqtmzdjb001iorgo6jab6z8j","tag_id":"clqtmzdix000forgo9sk1frk5","_id":"clqtmzdjc001morgoau9uftmj"},{"post_id":"clqtmzdj1000oorgoaivhepyc","tag_id":"clqtmzdja001forgo4tl0eo30","_id":"clqtmzdjc001oorgo6zybdi8g"},{"post_id":"clqtmzdjb001korgobacb82dz","tag_id":"clqtmzdiv000aorgoc3hnhqgt","_id":"clqtmzdjd001rorgobpfadpco"},{"post_id":"clqtmzdj5000xorgobpxo43u6","tag_id":"clqtmzdix000forgo9sk1frk5","_id":"clqtmzdjd001torgogz9280mw"},{"post_id":"clqtmzdj5000xorgobpxo43u6","tag_id":"clqtmzdjb001lorgo9m5h3l1h","_id":"clqtmzdje001worgoeafgb5fn"},{"post_id":"clqtmzdjd001uorgohruqappq","tag_id":"clqtmzdix000forgo9sk1frk5","_id":"clqtmzdjf001yorgo74e17jdk"},{"post_id":"clqtmzdj6000zorgohafb5jfr","tag_id":"clqtmzdjd001qorgo94u49gxh","_id":"clqtmzdjf0021orgo9v23bnlv"},{"post_id":"clqtmzdj6000zorgohafb5jfr","tag_id":"clqtmzdje001vorgo7mdt19ky","_id":"clqtmzdjf0022orgognhb8bys"},{"post_id":"clqtmzdj60012orgo45szaxb5","tag_id":"clqtmzdjf0020orgobb6vbspk","_id":"clqtmzdjg0024orgogyfm5exp"},{"post_id":"clqtmzdj80017orgoc386fn0j","tag_id":"clqtmzdjf0023orgod1cvalgy","_id":"clqtmzdjg0026orgo4yjk88nk"},{"post_id":"clqtmzdj80019orgoh6l9f722","tag_id":"clqtmzdix000forgo9sk1frk5","_id":"clqtmzdjg0028orgo2sjo58sd"},{"post_id":"clqtmzdj80019orgoh6l9f722","tag_id":"clqtmzdjb001lorgo9m5h3l1h","_id":"clqtmzdjg0029orgo9ctvatgk"},{"post_id":"clqtmzdj9001corgo3mcchect","tag_id":"clqtmzdjf0023orgod1cvalgy","_id":"clqtmzdjh002borgo8nud15if"},{"post_id":"clqtmzdja001gorgo8wfu8mqm","tag_id":"clqtmzdja001forgo4tl0eo30","_id":"clqtmzdjh002dorgo03v6652g"},{"post_id":"clqtmzdjc001norgoccjh907l","tag_id":"clqtmzdjh002corgobg1ldicp","_id":"clqtmzdji002forgofyjsfik6"},{"post_id":"clqtmzdjc001porgob95a5n4o","tag_id":"clqtmzdjh002corgobg1ldicp","_id":"clqtmzdji002gorgoa14e24zu"}],"Tag":[{"name":"java源码","_id":"clqtmzdir0004orgo26vxhha9"},{"name":"架构设计","_id":"clqtmzdiv000aorgoc3hnhqgt"},{"name":"java","_id":"clqtmzdix000forgo9sk1frk5"},{"name":"dubbo","_id":"clqtmzdj1000norgo8cbw3vcb"},{"name":"前端","_id":"clqtmzdja001forgo4tl0eo30"},{"name":"jvm","_id":"clqtmzdjb001lorgo9m5h3l1h"},{"name":"jenkins","_id":"clqtmzdjd001qorgo94u49gxh"},{"name":"架构师进阶之路","_id":"clqtmzdje001vorgo7mdt19ky"},{"name":"mybatis","_id":"clqtmzdjf0020orgobb6vbspk"},{"name":"solr","_id":"clqtmzdjf0023orgod1cvalgy"},{"name":"营销","_id":"clqtmzdjh002corgobg1ldicp"}]}}