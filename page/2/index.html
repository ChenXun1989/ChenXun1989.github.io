<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.chenxun.wiki","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="陈公子的博客">
<meta property="og:url" content="https://www.chenxun.wiki/page/2/index.html">
<meta property="og:site_name" content="陈公子的博客">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="陈公子">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.chenxun.wiki/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>陈公子的博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">陈公子的博客</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">文字可以宣泄过往，但终究写不出流年</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">陈公子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.chenxun.wiki/2023/06/20/mybatis%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈公子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陈公子的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 陈公子的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/20/mybatis%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/" class="post-title-link" itemprop="url">mybatis源码分析（一）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-06-20 06:59:40 / Modified: 13:09:16" itemprop="dateCreated datePublished" datetime="2023-06-20T06:59:40+00:00">2023-06-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="mybatis源码分析（一）"><a href="#mybatis源码分析（一）" class="headerlink" title="mybatis源码分析（一）"></a>mybatis源码分析（一）</h1><h2 id="sqlSessionFactory对象"><a href="#sqlSessionFactory对象" class="headerlink" title="sqlSessionFactory对象"></a>sqlSessionFactory对象</h2><p>sqlSessionFactory 是mybatis 核心配置类，管理mybatis全局配置。</p>
<h2 id="sqlSession接口"><a href="#sqlSession接口" class="headerlink" title="sqlSession接口"></a>sqlSession接口</h2><p>一个或者多个sql操作的执行单元。实现一个完整的sql操作。依赖sqlSessionFactory创建</p>
<h2 id="Executor接口"><a href="#Executor接口" class="headerlink" title="Executor接口"></a>Executor接口</h2><p>对应jdbc底层一个完整的sql操作。sqlSession 实际通过Executor执行sql操作</p>
<h2 id="MapperProxy类"><a href="#MapperProxy类" class="headerlink" title="MapperProxy类"></a>MapperProxy类</h2><p>代理实现mybatis的客户端mapper接口</p>
<h2 id="MapperMethod类"><a href="#MapperMethod类" class="headerlink" title="MapperMethod类"></a>MapperMethod类</h2><p>对应客户端代码的mapper接口里面的一个方法。该实例缓存了。</p>
<h2 id="StatementHandler接口"><a href="#StatementHandler接口" class="headerlink" title="StatementHandler接口"></a>StatementHandler接口</h2><p>jdbc Statement的装饰器</p>
<h2 id="ResultSetHandler接口"><a href="#ResultSetHandler接口" class="headerlink" title="ResultSetHandler接口"></a>ResultSetHandler接口</h2><p>jdbc resultSet的装饰器</p>
<h2 id="mybaits执行orm操作细节"><a href="#mybaits执行orm操作细节" class="headerlink" title="mybaits执行orm操作细节"></a>mybaits执行orm操作细节</h2><img src="/2023/06/20/mybatis%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/1.png" class="" title="image">
<p><strong>sqlsession的close 方法会关闭底层jdbc connection</strong></p>
<h2 id="mybatis插件机制"><a href="#mybatis插件机制" class="headerlink" title="mybatis插件机制"></a>mybatis插件机制</h2><p>mybatis插件是基于代理实现的，具体支持一下四个接口</p>
<ul>
<li>Executor</li>
<li>ParameterHandler</li>
<li>ResultSetHandler</li>
<li>StatemetHandler</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.chenxun.wiki/2023/06/20/java%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈公子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陈公子的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 陈公子的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/20/java%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81/" class="post-title-link" itemprop="url">java线程状态</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-06-20 06:46:26 / Modified: 13:09:16" itemprop="dateCreated datePublished" datetime="2023-06-20T06:46:26+00:00">2023-06-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="java线程状态"><a href="#java线程状态" class="headerlink" title="java线程状态"></a>java线程状态</h1><p>java线程有以下几个状态</p>
<ul>
<li>new 初始状态</li>
<li>runnable 运行状态（包括就绪和运行）</li>
<li>blocked 阻塞状态</li>
<li>waiting 等待状态,需要其他线程特定动作唤醒（通知或者中断）</li>
<li>time-waiting 超时等待状态，可以在指定时间内返回。</li>
<li>terminated 终止状态</li>
</ul>
<h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><p>java构造线程有两种办法,Thread类和Runnable接口,Thread的类本身实现了Runnable接口。<br>常见的作法,是通过thread类的public Thread(Runnable target)构造函数来创建线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>thread类的初始话代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span><br><span class="line"><span class="params"><span class="type">long</span> stackSize, AccessControlContext acc)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;name cannot be null&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">this</span>.name = name;</span><br><span class="line"><span class="type">Thread</span> <span class="variable">parent</span> <span class="operator">=</span> currentThread();</span><br><span class="line"><span class="type">SecurityManager</span> <span class="variable">security</span> <span class="operator">=</span> System.getSecurityManager();</span><br><span class="line"><span class="keyword">if</span> (g == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (security != <span class="literal">null</span>) &#123;</span><br><span class="line">g = security.getThreadGroup();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g == <span class="literal">null</span>) &#123;</span><br><span class="line">        g = parent.getThreadGroup();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">g.checkAccess();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (security != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isCCLOverridden(getClass())) &#123;</span><br><span class="line">        security.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">g.addUnstarted();</span><br><span class="line"><span class="built_in">this</span>.group = g;</span><br><span class="line"><span class="built_in">this</span>.daemon = parent.isDaemon();</span><br><span class="line"><span class="built_in">this</span>.priority = parent.getPriority();</span><br><span class="line"><span class="keyword">if</span> (security == <span class="literal">null</span> || isCCLOverridden(parent.getClass()))</span><br><span class="line">    <span class="built_in">this</span>.contextClassLoader = parent.getContextClassLoader();</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">this</span>.contextClassLoader = parent.contextClassLoader;</span><br><span class="line"><span class="built_in">this</span>.inheritedAccessControlContext =</span><br><span class="line">        acc != <span class="literal">null</span> ? acc : AccessController.getContext();</span><br><span class="line"><span class="built_in">this</span>.target = target;</span><br><span class="line">setPriority(priority);</span><br><span class="line"><span class="keyword">if</span> (parent.inheritableThreadLocals != <span class="literal">null</span>)</span><br><span class="line">    <span class="built_in">this</span>.inheritableThreadLocals =</span><br><span class="line">        ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span><br><span class="line"><span class="built_in">this</span>.stackSize = stackSize;</span><br><span class="line">   </span><br><span class="line">tid = nextThreadID();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从这段代码可以看出以下几点<br>当前线程为创建线程的父线程<br>child线程继承parent的Daemon、优先级、和加载资源的contextClassLoader和一个可以继承的ThreadLocal。<br><strong>Daemon线程（后台线程）的finally块代码不会执行</strong></p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>Thread类的start方法起来运行线程。底层通过调用navate方法来运行线程。<br><strong>start（）方法来启动线程，真正实现了多线程运行，这时无需等待run方法体代码执行完毕而直接继续执行下面的代码</strong><br><strong>run（）方法当作普通方法的方式调用，程序还是要顺序执行，还是要等待run方法体执行完毕后才可继续执行下面的代码</strong></p>
<h2 id="阻塞"><a href="#阻塞" class="headerlink" title="阻塞"></a>阻塞</h2><p>线程执行到monitorenter保护的代码快时，会去获取monitorenter对应的对象锁，如未获取，则该线程进入同步队列，状态为阻塞。<br><strong>任意对象都拥有自己的monitor，包括class对象。</strong></p>
<h2 id="等待-x2F-唤醒"><a href="#等待-x2F-唤醒" class="headerlink" title="等待&#x2F;唤醒"></a>等待&#x2F;唤醒</h2><p>线程等待的方法主要有下面几种</p>
<ul>
<li>object.wait() &#x2F; object.wait(long)</li>
<li>object.join() &#x2F; object.join(long)</li>
<li>lockSupport.park() &#x2F; lockSupport.park(long)</li>
</ul>
<p>当线程调用某个对象的wati方法，进入等待。当另一个线程调用该对象的notify()&#x2F;notifyall()方法，之前等待的线程唤醒。<br>线程唤醒的方法注意下面几种</p>
<ul>
<li>object.notify()&#x2F;notifyAll()</li>
<li>lockSupport.unpark(Thread)</li>
</ul>
<p><strong>调用对象wait或者notify方法的前题是获取当前对象的内置锁。</strong></p>
<p>通过wait&#x2F;notify设计的经典作法<br>等待方：</p>
<ul>
<li>获取对象锁</li>
<li>条件检查</li>
<li>为假则等待</li>
<li>为真则执行后面的逻辑<br>唤醒方：</li>
<li>获取对象锁</li>
<li>改变条件</li>
<li>通知所有等待在对象的线程</li>
</ul>
<p><strong>条件变量用volatile修饰来保证可见性</strong></p>
<h2 id="终止"><a href="#终止" class="headerlink" title="终止"></a>终止</h2><p>线程对应的run方法运行完毕，则线程终止。不推荐使用stop来终止线程。可以通过状态变量来终止线程。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.chenxun.wiki/2023/06/20/Buffer%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈公子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陈公子的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 陈公子的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/20/Buffer%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">Buffer详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-06-20 06:38:07 / Modified: 13:09:16" itemprop="dateCreated datePublished" datetime="2023-06-20T06:38:07+00:00">2023-06-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Buffer详解"><a href="#Buffer详解" class="headerlink" title="Buffer详解"></a>Buffer详解</h1><p>java中的nio由channel,buffer,Selector组成核心API。<br>Buffer是一个继承于object的抽象类,主要有下面几种。</p>
<ul>
<li>ByteBuffer</li>
<li>CharBuffer</li>
<li>DoubleBuffer</li>
<li>FloatBuffer</li>
<li>IntBuffer</li>
<li>LongBuffer</li>
<li>ShortBuffer</li>
</ul>
<p>基本覆盖了基本类型的支持，看下byteBuffer的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 间接缓冲区</span></span><br><span class="line">ByteBuffer bf1=ByteBuffer.allocate(<span class="number">16</span>);</span><br><span class="line"><span class="comment">// 直接缓冲区</span></span><br><span class="line">ByteBuffer bf2=ByteBuffer.allocateDirect(<span class="number">16</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ByteBuffer提供两种方式来获取缓存区内存，间接或者直接。<br>字节缓冲区要么是直接的，要么是非直接的。<br>如果为直接字节缓冲区，则 Java 虚拟机会尽最大努力直接在此缓冲区上执行本机 I&#x2F;O 操作。<br>也就是说，在每次调用基础操作系统的一个本机 I&#x2F;O 操作之前（或之后），<br>虚拟机都会尽量避免将缓冲区的内容复制到中间缓冲区中（或从中间缓冲区中复制内容）。<br><strong>直接缓冲区的内容可以驻留在常规的垃圾回收堆之外，不会被GC回收。</strong><br>间接缓冲区与本地操作系统低层次的i&#x2F;o交互需要一个中间缓冲区来实现，因此性能比直接缓存区要低。<br>直接缓冲区通过sun.misc.Unsafe类调用jni本地方法来分配内存。<br>因为绕过jvm,因此分配内存的开销较大，并且需要用户自己当成普通资源来主动释放。<br>堆外内存的分配</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">DirectByteBuffer(<span class="type">int</span> cap) &#123;                   <span class="comment">// package-private</span></span><br><span class="line"><span class="built_in">super</span>(-<span class="number">1</span>, <span class="number">0</span>, cap, cap);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">pa</span> <span class="operator">=</span> VM.isDirectMemoryPageAligned();</span><br><span class="line"><span class="type">int</span> <span class="variable">ps</span> <span class="operator">=</span> Bits.pageSize();</span><br><span class="line"><span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> Math.max(<span class="number">1L</span>, (<span class="type">long</span>)cap + (pa ? ps : <span class="number">0</span>));</span><br><span class="line">Bits.reserveMemory(size, cap);</span><br><span class="line"><span class="type">long</span> <span class="variable">base</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">base = unsafe.allocateMemory(size);</span><br><span class="line">&#125; <span class="keyword">catch</span> (OutOfMemoryError x) &#123;</span><br><span class="line">Bits.unreserveMemory(size, cap);</span><br><span class="line"><span class="keyword">throw</span> x;</span><br><span class="line">&#125;</span><br><span class="line">unsafe.setMemory(base, size, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (pa &amp;&amp; (base % ps != <span class="number">0</span>)) &#123;</span><br><span class="line"><span class="comment">// Round up to page boundary</span></span><br><span class="line">address = base + ps - (base &amp; (ps - <span class="number">1</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">address = base;</span><br><span class="line">&#125;</span><br><span class="line">cleaner = Cleaner.create(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">Deallocator</span>(base, size, cap));</span><br><span class="line">att = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看出通过unsafe.allocateMemory方法来分配堆外内存，同时创建一个对应的Cleaner<br>sun.misc.Cleaner.create方法两个参数。</p>
<ul>
<li>需要监控的堆内存对象，就是堆外内存关联的对象。</li>
<li>程序释放资源的回调。</li>
</ul>
<p>当JVM进行GC的时候，如果发现我们监控的对象，不存在强引用了，(Cleaner本身是幽灵引用)，<br>就会调用预先绑定的回调方法，我们一般在回调方法里面释放堆外内存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Deallocator</span></span><br><span class="line"><span class="keyword">implements</span> <span class="title class_">Runnable</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> Unsafe.getUnsafe();</span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> address;</span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> size;</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> capacity;</span><br><span class="line"><span class="keyword">private</span> <span class="title function_">Deallocator</span><span class="params">(<span class="type">long</span> address, <span class="type">long</span> size, <span class="type">int</span> capacity)</span> &#123;</span><br><span class="line"><span class="keyword">assert</span> (address != <span class="number">0</span>);</span><br><span class="line"><span class="built_in">this</span>.address = address;</span><br><span class="line"><span class="built_in">this</span>.size = size;</span><br><span class="line"><span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (address == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// Paranoia</span></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">unsafe.freeMemory(address);</span><br><span class="line">address = <span class="number">0</span>;</span><br><span class="line">Bits.unreserveMemory(size, capacity);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最终通过unsafe类提供freeMemory来释放之前分配的对外内存。<br><strong>堆外内存大小可以通过jvm启动参数限制： -XX:MaxDirectMemorySize</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.chenxun.wiki/2023/06/20/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E5%92%8C%E5%90%8C%E6%AD%A5%E5%AE%B9%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈公子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陈公子的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 陈公子的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/20/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E5%92%8C%E5%90%8C%E6%AD%A5%E5%AE%B9%E5%99%A8/" class="post-title-link" itemprop="url">并发容器和同步容器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-06-20 06:35:58 / Modified: 13:09:16" itemprop="dateCreated datePublished" datetime="2023-06-20T06:35:58+00:00">2023-06-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="并发容器和同步容器"><a href="#并发容器和同步容器" class="headerlink" title="并发容器和同步容器"></a>并发容器和同步容器</h1><p>java的同步容器有Vector和Hashtable。<br>vecotor和hashtbale通过synchronized来锁定对容器状态的访问，例如get方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (index &gt;= elementCount)</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ArrayIndexOutOfBoundsException</span>(index);</span><br><span class="line"><span class="keyword">return</span> elementData(index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>同步容器类是线程安全的，但复合操作不一定是线程安全的，需要客户端额外加锁来保证线程安全。</p>
<h2 id="并发容器"><a href="#并发容器" class="headerlink" title="并发容器"></a>并发容器</h2><p>同步容器将所有对容器状态的访问都串行化，以实现线程安全。这种性能比较低，<br>java5.0 引入了并发容器,在java.util.concurrent包下面</p>
<h2 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h2><p>ConcurrentHashMap采用了分段锁的设计，只有在同一个分段内才存在竞态关系，不同的分段锁之间没有锁竞争。<br><strong>ConcurrentHashMap是弱一致性的，get，clear都是弱一致性的</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.chenxun.wiki/2023/06/20/synchronized%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈公子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陈公子的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 陈公子的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/20/synchronized%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">synchronized原理解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-06-20 06:30:26 / Modified: 13:09:16" itemprop="dateCreated datePublished" datetime="2023-06-20T06:30:26+00:00">2023-06-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="synchronized原理解析"><a href="#synchronized原理解析" class="headerlink" title="synchronized原理解析"></a>synchronized原理解析</h1><h2 id="synchronized的三种方式"><a href="#synchronized的三种方式" class="headerlink" title="synchronized的三种方式"></a>synchronized的三种方式</h2><p>对于普通同步方法,锁的是当前实例对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于静态方同步方法，锁的是当前类的Class对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//do something</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对于同步方法快，锁的是synchronized括号里的对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="keyword">synchronized</span>(<span class="built_in">this</span>)&#123;</span><br><span class="line">	<span class="comment">//do something	</span></span><br><span class="line">&#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="synchronized锁升级"><a href="#synchronized锁升级" class="headerlink" title="synchronized锁升级"></a>synchronized锁升级</h2><p>jdk1.6之后，synchronized锁有四种状态，无锁，偏向锁，轻量级锁，重量级。</p>
<ul>
<li>偏向锁： 存在java对象头里面。</li>
<li>轻量级锁：存在当前线程的栈帧里面</li>
<li>重量级锁： 存在当前对象的monitor对象里面</li>
</ul>
<p>锁升级过程：</p>
<ul>
<li>无锁状态到偏向锁，当前线程通过cas修改java对象头的锁标志位。</li>
<li>谝向锁到轻量级锁, 当前线程把java对象头的锁信息copy到栈帧里面</li>
<li>轻量级锁到重量级锁，把栈帧里面的锁信息copy到对象的monitor里面。</li>
<li>偏向锁和轻量级锁采用cas自旋修改锁状态，重量级锁通过线程信号来实现*</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.chenxun.wiki/2023/06/20/volatile%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈公子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陈公子的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 陈公子的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/20/volatile%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">volatile原理解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-06-20 06:18:09 / Modified: 13:09:16" itemprop="dateCreated datePublished" datetime="2023-06-20T06:18:09+00:00">2023-06-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="volatile原理解析"><a href="#volatile原理解析" class="headerlink" title="volatile原理解析"></a>volatile原理解析</h1><h2 id="volatile语义"><a href="#volatile语义" class="headerlink" title="volatile语义"></a>volatile语义</h2><p>jsr133规范对volatile语义进行了增强，明确保证了可见性和有序性。</p>
<p><strong>volatile不保证原子性</strong></p>
<p>java编程语言允许线程访问共享变量，为了确保共享变量能被准确和一致的更新，线程应该确保通过排他锁单独获得这个变量。<br>Java语言提供了volatile，在某些情况下比锁更加方便。<br>如果一个字段被声明成volatile，java线程内存模型确保所有线程看到这个变量的值是一致的。</p>
<p><strong>Volatile变量修饰符如果使用恰当的话，它比synchronized的使用和执行成本会更低，因为它不会引起线程上下文的切换和调度。</strong></p>
<h2 id="volatile的有序性"><a href="#volatile的有序性" class="headerlink" title="volatile的有序性"></a>volatile的有序性</h2><p>jmm为了保证volatile的语义中的有序性，通过内存屏障来禁止指令重排序<br>JMM基于保守策略的JMM内存屏障插入策略</p>
<ul>
<li>在每个volatile写操作的前面插入一个StoreStore屏障</li>
<li>在每个volatile写操作的后面插入一个SotreLoad屏障</li>
<li>在每个volatile读操作的后面插入一个LoadLoad屏障</li>
<li>在每个volatile读操作的后面插入一个LoadStore屏障</li>
</ul>
<p>x86处理器仅仅会对写-读操作做重排序,因此在x86中，JMM仅需在volatile后面插入一个StoreLoad屏障即可正确实现volatile写-读的内存语义 </p>
<h2 id="volatile的可见性"><a href="#volatile的可见性" class="headerlink" title="volatile的可见性"></a>volatile的可见性</h2><p>对于volatile修饰的变量，jvm虚拟机保证从主内存加载到线程工作内存的值是最新的。<br>从内存语义的角度来看</p>
<ul>
<li>volatile的写-读与锁的释放-获取有相同的内存效果</li>
<li>volatile写和锁的释放有相同的内存语义</li>
<li>volatile读与锁的获取有相同的内存语义</li>
</ul>
<p>当线程释放锁的时候，JMM会把线程对应的本地内存中的共享变量刷新到主内存中<br>当线程获取锁时，JMM会把线程对应的本地内存置为无效，从而使得被监视器保护的临界区代码必须要从主内存中去读取共享变量。</p>
<h2 id="volatile的使用前提"><a href="#volatile的使用前提" class="headerlink" title="volatile的使用前提"></a>volatile的使用前提</h2><ul>
<li>对变量的写入操作不依赖变量的当前值，或者你能确保只有单个线程更新变量的值。</li>
<li>该变量没有包含在具有其他变量的不变式中。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.chenxun.wiki/2023/06/20/java%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84%E5%92%8C%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈公子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陈公子的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 陈公子的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/20/java%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84%E5%92%8C%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" class="post-title-link" itemprop="url">java内存结构和内存模型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-06-20 06:13:32 / Modified: 13:09:16" itemprop="dateCreated datePublished" datetime="2023-06-20T06:13:32+00:00">2023-06-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="java内存结构和内存模型"><a href="#java内存结构和内存模型" class="headerlink" title="java内存结构和内存模型"></a>java内存结构和内存模型</h1><h2 id="java内存结构"><a href="#java内存结构" class="headerlink" title="java内存结构"></a>java内存结构</h2><p>java内存结构大致分为以下几个区域</p>
<img src="/2023/06/20/java%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84%E5%92%8C%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/1.png" class="" title="image">

<h2 id="PC寄存器-x2F-程序计数器"><a href="#PC寄存器-x2F-程序计数器" class="headerlink" title="PC寄存器&#x2F;程序计数器"></a>PC寄存器&#x2F;程序计数器</h2><p>严格来说是一个数据结构，用于保存当前正在执行的程序的内存地址，由于Java是支持多线程执行的，所以程序执行的轨迹不可能一直都是线性执行。当有多个线程交叉执行时，被中断的线程的程序当前执行到哪条内存地址必然要保存下来，以便用于被中断的线程恢复执行时再按照被中断时的指令地址继续执行下去。 为了线程切换后能恢复到正确的执行位置，每个线程都需要有一个独立的程序计数器，各个线程之间计数器互不影响，独立存储，我们称这类内存区域为“线程私有”的内存,这在某种程度上有点类似于“ThreadLocal”，是线程安全的。</p>
<h2 id="Java栈-Java-Stack"><a href="#Java栈-Java-Stack" class="headerlink" title="Java栈 Java Stack"></a>Java栈 Java Stack</h2><p>java栈总是与线程关联在一起的，每当创建一个线程，JVM就会为该线程创建对应的Java栈，在这个Java栈中又会包含多个栈帧(Stack Frame)，这些栈帧是与每个方法关联起来的，每运行一个方法就创建一个栈帧，每个栈帧会含有一些局部变量、操作栈和方法返回值等信息。每当一个方法执行完成时，该栈帧就会弹出栈帧的元素作为这个方法的返回值，并且清除这个栈帧，Java栈的栈顶的栈帧就是当前正在执行的活动栈，也就是当前正在执行的方法，PC寄存器也会指向该地址。只有这个活动的栈帧的本地变量可以被操作栈使用，当在这个栈帧中调用另外一个方法时，与之对应的一个新的栈帧被创建，这个新创建的栈帧被放到Java栈的栈顶，变为当前的活动栈。同样现在只有这个栈的本地变量才能被使用，当这个栈帧中所有指令都完成时，这个栈帧被移除Java栈，刚才的那个栈帧变为活动栈帧，前面栈帧的返回值变为这个栈帧的操作栈的一个操作数。</p>
<p>由于Java栈是与线程对应起来的，Java栈数据不是线程共有的，所以不需要关心其数据一致性，也不会存在同步锁的问题。</p>
<p>在Java虚拟机规范中，对这个区域规定了两种异常状况：如果线程请求的栈深度大于虚拟机所允许的深度，将抛出StackOverflowError异常；如果虚拟机可以动态扩展，如果扩展时无法申请到足够的内存，就会抛出OutOfMemoryError异常。</p>
<h2 id="堆Heap"><a href="#堆Heap" class="headerlink" title="堆Heap"></a>堆Heap</h2><p>堆是JVM所管理的内存中最大的一块，是被所有Java线程锁共享的，不是线程安全的，在JVM启动时创建。 堆是存储Java对象的地方，这一点Java虚拟机规范中描述是：所有的对象实例以及数组都要在堆上分配。Java堆是GC管理的主要区域，从内存回收的角度来看，由于现在GC基本都采用分代收集算法，所以Java堆还可以细分为：新生代和老年代；新生代再细致一点有Eden空间、From Survivor空间、To Survivor空间等。</p>
<h2 id="方法区Method-Area"><a href="#方法区Method-Area" class="headerlink" title="方法区Method Area"></a>方法区Method Area</h2><p>方法区存放了要加载的类的信息（名称、修饰符等）、类中的静态常量、类中定义为final类型的常量、类中的Field信息、类中的方法信息，当在程序中通过Class对象的getName.isInterface等方法来获取信息时，这些数据都来源于方法区。方法区是被Java线程锁共享的，不像Java堆中其他部分一样会频繁被GC回收，它存储的信息相对比较稳定，在一定条件下会被GC，当方法区要使用的内存超过其允许的大小时，会抛出OutOfMemory的错误信息。方法区也是堆中的一部分，就是我们通常所说的Java堆中的永久区 Permanet Generation，大小可以通过参数来设置,可以通过-XX:PermSize指定初始值，-XX:MaxPermSize指定最大值。</p>
<h2 id="常量池Constant-Pool"><a href="#常量池Constant-Pool" class="headerlink" title="常量池Constant Pool"></a>常量池Constant Pool</h2><p>常量池本身是方法区中的一个数据结构。常量池中存储了如字符串、final变量值、类名和方法名常量。常量池在编译期间就被确定，并保存在已编译的.class文件中。一般分为两类：字面量和应用量。字面量就是字符串、final变量等。类名和方法名属于引用量。引用量最常见的是在调用方法的时候，根据方法名找到方法的引用，并以此定为到函数体进行函数代码的执行。引用量包含：类和接口的权限定名、字段的名称和描述符，方法的名称和描述符</p>
<h2 id="本地方法栈Native-Method-Stack"><a href="#本地方法栈Native-Method-Stack" class="headerlink" title="本地方法栈Native Method Stack"></a>本地方法栈Native Method Stack</h2><p>本地方法栈和Java栈所发挥的作用非常相似，区别不过是Java栈为JVM执行Java方法服务，而本地方法栈为JVM执行Native方法服务。</p>
<h2 id="java内存模型-jmm"><a href="#java内存模型-jmm" class="headerlink" title="java内存模型 jmm"></a>java内存模型 jmm</h2><p>JMM规定了所有的变量都存储在主内存（Main Memory）中。每个线程还有自己的工作内存（Working Memory）,线程的工作内存中保存了该线程使用到的变量的主内存的副本拷贝，线程对变量的所有操作（读取、赋值等）都必须在工作内存中进行，而不能直接读写主内存中的变量（volatile变量仍然有工作内存的拷贝，但是由于它特殊的操作顺序性规定，所以看起来如同直接在主内存中读写访问一般）。不同的线程之间也无法直接访问对方工作内存中的变量，线程之间值的传递都需要通过主内存来完成。<br><strong>工作内存线程独享，主内存线程共享</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.chenxun.wiki/2023/06/20/dubbo%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6%E4%B9%8Bconfig-spring%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈公子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陈公子的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 陈公子的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/20/dubbo%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6%E4%B9%8Bconfig-spring%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">dubbo源码研究之config-spring模块</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-06-20 05:58:06 / Modified: 13:09:16" itemprop="dateCreated datePublished" datetime="2023-06-20T05:58:06+00:00">2023-06-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="dubbo源码研究之config-spring模块"><a href="#dubbo源码研究之config-spring模块" class="headerlink" title="dubbo源码研究之config-spring模块"></a>dubbo源码研究之config-spring模块</h1><p>dubbo-config-spring模块是dubbo-config的Extension。</p>
<img src="/2023/06/20/dubbo%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6%E4%B9%8Bconfig-spring%E6%A8%A1%E5%9D%97/1.png" class="" title="image">

<p>Dubbo的扩展点加载从JDK标准的SPI(Service Provider Interface)扩展点发现机制加强而来。<br>Dubbo改进了JDK标准的SPI的以下问题：<br>JDK标准的SPI会一次性实例化扩展点所有实现，如果有扩展实现初始化很耗时，但如果没用上也加载，会很浪费资源。<br>如果扩展点加载失败，连扩展点的名称都拿不到了。比如：JDK标准的ScriptEngine，通过getName();获取脚本类型的名称，<br>但如果RubyScriptEngine因为所依赖的jruby.jar不存在，导致RubyScriptEngine类加载失败，这个失败原因被吃掉了，和ruby对应不起来，<br>当用户执行ruby脚本时，会报不支持ruby，而不是真正失败的原因。<br>增加了对扩展点IoC和AOP的支持，一个扩展点可以直接setter注入其它扩展点。<br>dubbo的spi约定：在扩展类的jar包内，放置扩展点配置文件：META-INF&#x2F;dubbo&#x2F;接口全限定名，内容为：配置名&#x3D;扩展实现类全限定名，多个实现类用换行符分隔。</p>
<figure class="highlight java"><figcaption><span>schema.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@SPI</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ExtensionFactory</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Get extension. </span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type object type. </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name object name. </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> object instance. </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line">&lt;T&gt; T <span class="title function_">getExtension</span><span class="params">(Class&lt;T&gt; type, String name)</span>;  </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>dubbo的扩展点接口ExtensionFactory ，该接口有三个实现</p>
<img src="/2023/06/20/dubbo%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6%E4%B9%8Bconfig-spring%E6%A8%A1%E5%9D%97/2.png" class="" title="image">

<p>dubbo的扩展实现的具体类是ExtensionLoader。<br>ExtensionLoader加载扩展点时，会检查扩展点的属性（通过set方法判断），如该属性是扩展点类型，则会注入扩展点对象。<br>因为注入时不能确定使用哪个扩展点（在使用时确定），所以注入的是一个自适应扩展（一个代理）。自适应扩展点调用时，选取一个真正的扩展点，并代理到其上完成调用。<br>Dubbo是根据调用方法参数（上面有调用哪个扩展点的信息）来选取一个真正的扩展点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class="line"><span class="keyword">private</span> T <span class="title function_">createExtension</span><span class="params">(String name)</span> &#123;  </span><br><span class="line">Class&lt;?&gt; clazz = getExtensionClasses().get(name);  </span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> findException(name);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="type">T</span> <span class="variable">instance</span> <span class="operator">=</span> (T) EXTENSION_INSTANCES.get(clazz);  </span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;  </span><br><span class="line">            EXTENSION_INSTANCES.putIfAbsent(clazz, (T) clazz.newInstance());  </span><br><span class="line">            instance = (T) EXTENSION_INSTANCES.get(clazz);  </span><br><span class="line">        &#125;  </span><br><span class="line">        injectExtension(instance);  </span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses;  </span><br><span class="line"><span class="keyword">if</span> (wrapperClasses != <span class="literal">null</span> &amp;&amp; wrapperClasses.size() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line"><span class="keyword">for</span> (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123;  </span><br><span class="line">instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">return</span> instance;  </span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable t) &#123;  </span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Extension instance(name: &quot;</span> + name + <span class="string">&quot;, class: &quot;</span> +  </span><br><span class="line">type + <span class="string">&quot;)  could not be instantiated: &quot;</span> + t.getMessage(), t);  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> T <span class="title function_">injectExtension</span><span class="params">(T instance)</span> &#123;  </span><br><span class="line"><span class="keyword">try</span> &#123;  </span><br><span class="line"><span class="keyword">if</span> (objectFactory != <span class="literal">null</span>) &#123;  </span><br><span class="line"><span class="keyword">for</span> (Method method : instance.getClass().getMethods()) &#123;  </span><br><span class="line"><span class="keyword">if</span> (method.getName().startsWith(<span class="string">&quot;set&quot;</span>)  </span><br><span class="line">&amp;&amp; method.getParameterTypes().length == <span class="number">1</span>  </span><br><span class="line">&amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;  </span><br><span class="line">Class&lt;?&gt; pt = method.getParameterTypes()[<span class="number">0</span>];  </span><br><span class="line"><span class="keyword">try</span> &#123;  </span><br><span class="line"><span class="type">String</span> <span class="variable">property</span> <span class="operator">=</span> method.getName().length() &gt; <span class="number">3</span> ? method.getName().substring(<span class="number">3</span>, <span class="number">4</span>).toLowerCase() + method.getName().substring(<span class="number">4</span>) : <span class="string">&quot;&quot;</span>;  </span><br><span class="line"><span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectFactory.getExtension(pt, property);  </span><br><span class="line"><span class="keyword">if</span> (object != <span class="literal">null</span>) &#123;  </span><br><span class="line">method.invoke(instance, object);  </span><br><span class="line">&#125;  </span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">logger.error(<span class="string">&quot;fail to inject via method &quot;</span> + method.getName()  </span><br><span class="line">+ <span class="string">&quot; of interface &quot;</span> + type.getName() + <span class="string">&quot;: &quot;</span> + e.getMessage(), e);  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">logger.error(e.getMessage(), e);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">return</span> instance;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出ExtensionLoader持有某一类扩展点的所有扩展，并且扩展以class为key，一个扩展类只有一个实例。<br>如果扩展点使用了Adaptive则会通过字节码生成一个自适应的扩展类。<br>通过createAdaptiveExtensionClassCode方法返回class的code，然后通过Compiler接口返回class对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Compiler. (SPI, Singleton, ThreadSafe)</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> william.liangf</span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="meta">@SPI(&quot;javassist&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Compiler</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Compile java source code.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> code Java source code</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> classLoader TODO</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> Compiled class</span></span><br><span class="line"><span class="comment">    */</span>  </span><br><span class="line">    Class&lt;?&gt; compile(String code, ClassLoader classLoader);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Compiler dubbo支持jdk和Javassist两种实现，特别注意一点，JdkCompiler的java版本通过硬编码指定版本为1.6。<br>JdkCompiler首先通过JavaFileObject接口生成java文件，然后通过JavaCompiler接口编译成class文件，最后通过ClassLoader加载生成的class文件。<br>spring名称空间扩展<br>dubbo通过扩展spring的名称空间来读取xml配置。<br>dubbo.xsd是spring schma的扩展文件。作用是定义相关xml元素和名称空间。<br>spring.handlers,spring.schemas是spring在解析xml的时候根据spi机制读取对象的NamespaceHandler和xsd文件位置。<br>很多程序猿使用dubbo开发的时候，会发现ide工具报错，因为xml上面dubbo名称空间的链接打不开，其实这个报错可以无视的，<br>因为spring解析的xml的时候这个网络地址其实是指向spi配置文件里面的一个java类。<br>spring.handlers</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">http\://code.alibabatech.com/schema/dubbo=com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler</span><br></pre></td></tr></table></figure>

<p>DubboNamespaceHandler则注册了相关自定义元素的解析器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * DubboNamespaceHandler</span><br><span class="line"> * </span><br><span class="line"> * @author william.liangf</span><br><span class="line"> * @export</span><br><span class="line">*/  </span><br><span class="line">public class DubboNamespaceHandler extends NamespaceHandlerSupport &#123;</span><br><span class="line"></span><br><span class="line">static &#123;  </span><br><span class="line">Version.checkDuplicate(DubboNamespaceHandler.class);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void init() &#123;  </span><br><span class="line">registerBeanDefinitionParser(&quot;application&quot;, new DubboBeanDefinitionParser(ApplicationConfig.class, true));  </span><br><span class="line">registerBeanDefinitionParser(&quot;module&quot;, new DubboBeanDefinitionParser(ModuleConfig.class, true));  </span><br><span class="line">registerBeanDefinitionParser(&quot;registry&quot;, new DubboBeanDefinitionParser(RegistryConfig.class, true));  </span><br><span class="line">registerBeanDefinitionParser(&quot;monitor&quot;, new DubboBeanDefinitionParser(MonitorConfig.class, true));  </span><br><span class="line">registerBeanDefinitionParser(&quot;provider&quot;, new DubboBeanDefinitionParser(ProviderConfig.class, true));  </span><br><span class="line">registerBeanDefinitionParser(&quot;consumer&quot;, new DubboBeanDefinitionParser(ConsumerConfig.class, true));  </span><br><span class="line">registerBeanDefinitionParser(&quot;protocol&quot;, new DubboBeanDefinitionParser(ProtocolConfig.class, true));  </span><br><span class="line">registerBeanDefinitionParser(&quot;service&quot;, new DubboBeanDefinitionParser(ServiceBean.class, true));  </span><br><span class="line">registerBeanDefinitionParser(&quot;reference&quot;, new DubboBeanDefinitionParser(ReferenceBean.class, false));  </span><br><span class="line">registerBeanDefinitionParser(&quot;annotation&quot;, new DubboBeanDefinitionParser(AnnotationBean.class, true));  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.chenxun.wiki/2023/06/20/dubbo%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6%E4%B9%8Bconfig%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈公子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陈公子的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 陈公子的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/20/dubbo%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6%E4%B9%8Bconfig%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">dubbo源码研究之config模块</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-06-20 05:51:48 / Modified: 13:09:16" itemprop="dateCreated datePublished" datetime="2023-06-20T05:51:48+00:00">2023-06-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="dubbo源码研究之config模块"><a href="#dubbo源码研究之config模块" class="headerlink" title="dubbo源码研究之config模块"></a>dubbo源码研究之config模块</h1><p>dubbo模块说明</p>
<ul>
<li>dubbo-common 公共逻辑模块，包括Util类和通用模型</li>
<li>dubbo-remoting 远程通讯模块，相当于Dubbo协议的实现，如果RPC用RMI协议则不需要使用此包。</li>
<li>dubbo-rpc 远程调用模块，抽象各种协议，以及动态代理，只包含一对一的调用，不关心集群的管理</li>
<li>dubbo-cluster 集群模块，将多个服务提供方伪装为一个提供方，包括：负载均衡, 容错，路由等，集群的地址列表可以是静态配置的，也可以是由注册中心下发。</li>
<li>dubbo-registry 注册中心模块，基于注册中心下发地址的集群方式，以及对各种注册中心的抽象。</li>
<li>dubbo-monitor 监控模块，统计服务调用次数，调用时间的，调用链跟踪的服务。</li>
<li>dubbo-config 配置模块，是Dubbo对外的API，用户通过Config使用Dubbo，隐藏Dubbo所有细节。</li>
<li>dubbo-container 容器模块，是一个Standlone的容器，以简单的Main加载Spring启动，因为服务通常不需要Tomcat&#x2F;JBoss等Web容器的特性，没必要用Web容器去加载服务。</li>
</ul>
<p>今天开始从dubbo入口，config模块开始研究。<br>config模块和Service模块是API，其他为SPI实现。<br>config模块uml类图</p>
<img src="/2023/06/20/dubbo%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6%E4%B9%8Bconfig%E6%A8%A1%E5%9D%97/1.png" class="" title="image">

<p>AbstractConfig类提供几个主要的方法 appendAnnotation，appendProperties，appendParameters，appendAttributes<br>其他子类提供相关自身的属性。<br>AbstractConfig类里面大量通过 反射和javabean约定获取相关值，特别注意的是toString方法注释提到的防御性容错</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">catch</span> (Throwable t) &#123; <span class="comment">// 防御性容错  </span></span><br><span class="line">logger.warn(t.getMessage(), t);  </span><br><span class="line"><span class="keyword">return</span> <span class="built_in">super</span>.toString();  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>防御性容错在此处使用，提升代码健壮性。<br>AnnotationBean是子类里面一个比较特殊的类。因为该类是处于com.alibaba.dubbo.config.spring包下面。<br>该类属于config模块的spring 扩展，支持通过注解来配置dubbo。<br>AnnotationBean实现了DisposableBean, BeanFactoryPostProcessor, BeanPostProcessor, ApplicationContextAware这四个接口。<br>DisposableBean：资源清理接口<br>BeanFactoryPostProcessor，BeanPostProcessor：作用类似，都是在bean创建之后的扩展接口。<br>ApplicationContextAware：获取spring上下文接口。<br>通过该类可以看出，dubbo注解实际上是spring注解的扩展，也就是说使用dubbo注解的前提是使用spring作为dubbo的容器。<br>@servcie暴露dubbo服务配置的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span>  </span><br><span class="line"><span class="keyword">throws</span> BeansException &#123;  </span><br><span class="line"><span class="keyword">if</span> (! isMatchPackage(bean)) &#123;  </span><br><span class="line"><span class="keyword">return</span> bean;  </span><br><span class="line">&#125;  </span><br><span class="line">Class&lt;?&gt; clazz = bean.getClass();  </span><br><span class="line"><span class="keyword">if</span>(isProxyBean(bean))&#123;  </span><br><span class="line">clazz = AopUtils.getTargetClass(bean);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> clazz.getAnnotation(Service.class);  </span><br><span class="line"><span class="keyword">if</span> (service != <span class="literal">null</span>) &#123;  </span><br><span class="line">ServiceBean&lt;Object&gt; serviceConfig = <span class="keyword">new</span> <span class="title class_">ServiceBean</span>&lt;Object&gt;(service);  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">void</span>.class.equals(service.interfaceClass())  </span><br><span class="line">&amp;&amp; <span class="string">&quot;&quot;</span>.equals(service.interfaceName())) &#123;  </span><br><span class="line"><span class="keyword">if</span> (clazz.getInterfaces().length &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">serviceConfig.setInterface(clazz.getInterfaces()[<span class="number">0</span>]);  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Failed to export remote service class &quot;</span> + clazz.getName() + <span class="string">&quot;, cause: The @Service undefined interfaceClass or interfaceName, and the service class unimplemented any interfaces.&quot;</span>);  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span> (applicationContext != <span class="literal">null</span>) &#123;  </span><br><span class="line">serviceConfig.setApplicationContext(applicationContext);  </span><br><span class="line"><span class="keyword">if</span> (service.registry() != <span class="literal">null</span> &amp;&amp; service.registry().length &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">List&lt;RegistryConfig&gt; registryConfigs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;RegistryConfig&gt;();  </span><br><span class="line"><span class="keyword">for</span> (String registryId : service.registry()) &#123;  </span><br><span class="line"><span class="keyword">if</span> (registryId != <span class="literal">null</span> &amp;&amp; registryId.length() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">registryConfigs.add((RegistryConfig)applicationContext.getBean(registryId, RegistryConfig.class));  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">serviceConfig.setRegistries(registryConfigs);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span> (service.provider() != <span class="literal">null</span> &amp;&amp; service.provider().length() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">serviceConfig.setProvider((ProviderConfig)applicationContext.getBean(service.provider(),ProviderConfig.class));  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span> (service.monitor() != <span class="literal">null</span> &amp;&amp; service.monitor().length() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">serviceConfig.setMonitor((MonitorConfig)applicationContext.getBean(service.monitor(), MonitorConfig.class));  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span> (service.application() != <span class="literal">null</span> &amp;&amp; service.application().length() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">serviceConfig.setApplication((ApplicationConfig)applicationContext.getBean(service.application(), ApplicationConfig.class));  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span> (service.<span class="keyword">module</span>() != <span class="literal">null</span> &amp;&amp; service.<span class="keyword">module</span>().length() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">serviceConfig.setModule((ModuleConfig)applicationContext.getBean(service.<span class="keyword">module</span>(), ModuleConfig.class));  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span> (service.provider() != <span class="literal">null</span> &amp;&amp; service.provider().length() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">serviceConfig.setProvider((ProviderConfig)applicationContext.getBean(service.provider(), ProviderConfig.class));  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (service.protocol() != <span class="literal">null</span> &amp;&amp; service.protocol().length &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">            List&lt;ProtocolConfig&gt; protocolConfigs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ProtocolConfig&gt;();  </span><br><span class="line">            <span class="comment">// modified by lishen; fix dubbo&#x27;s bug  </span></span><br><span class="line">            <span class="keyword">for</span> (String protocolId : service.protocol()) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (protocolId != <span class="literal">null</span> &amp;&amp; protocolId.length() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">                    protocolConfigs.add((ProtocolConfig)applicationContext.getBean(protocolId, ProtocolConfig.class));  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">            serviceConfig.setProtocols(protocolConfigs);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            serviceConfig.afterPropertiesSet();  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> (RuntimeException) e;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e.getMessage(), e);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    serviceConfig.setRef(bean);  </span><br><span class="line">    serviceConfigs.add(serviceConfig);  </span><br><span class="line">    serviceConfig.export();  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">return</span> bean;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主要是先获取类上面的@servcie注解，然后new 一个对应的ServiceBean，ServiceBean继承于ServiceConfig，同时实现了spring bean的相关接口 InitializingBean, DisposableBean, ApplicationContextAware, ApplicationListener, BeanNameAware。<br>最后该serviceBean保存到线程安全的容器里面去。<br>@service解析是在 postProcessAfterInitialization里面<br>@Reference解析是在postProcessBeforeInitialization里面，两者的时机是不一样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> reference.group() + <span class="string">&quot;/&quot;</span> + interfaceName + <span class="string">&quot;:&quot;</span> + reference.version();  </span><br><span class="line">ReferenceBean&lt;?&gt; referenceConfig = referenceConfigs.get(key);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从该代码可以看出，服务接口的唯一性，由group，interfaceName 和version一起决定。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.chenxun.wiki/2023/06/20/%E6%B5%85%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%97%E7%9B%91%E6%8E%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="陈公子">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陈公子的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 陈公子的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/20/%E6%B5%85%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%97%E7%9B%91%E6%8E%A7/" class="post-title-link" itemprop="url">浅谈分布式项目日志监控</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-06-20 05:48:20 / Modified: 13:09:16" itemprop="dateCreated datePublished" datetime="2023-06-20T05:48:20+00:00">2023-06-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="浅谈分布式项目日志监控"><a href="#浅谈分布式项目日志监控" class="headerlink" title="浅谈分布式项目日志监控"></a>浅谈分布式项目日志监控</h1><p>目前公司项目采用dubbo服务化升级之后，原先大而全的几个主要应用，拆散重构成多个分布式服务。<br>这个公司业务架构和系统架构实现一次升级，并发和业务开发效率得到提升。<br>但是事情是两面的，引入dubbo服务化之后，导致业务链路过长，日志分散。不能在使用原来的日志处理方式了。<br>分布式情况下，每个日志分散到各自服务所在机器，<br>日志的收集和分析使用原来古老的模式，肯定是过时了，集群和服务规模小还好，数量一大，我想不管是运维人员还是开发人员都会头疼。<br>目前处理这个需求最为火热的中间套件，自然首选是ELK，ELK是java技术栈的。<br>也符合目前公司需求。ELK的安装就不讲述了，感兴趣的可以查看官网或者自行百度，资料还是挺多的。<br>确定了日志收集和分析的中间件，剩下一个就是日志埋点和怎么把日志串起来了。<br>以前单个应用的时代，系统级别的日志可以通过aop解决。在分布式情况下对每一个独立服务而言，自身的日志系统还是通过aop解决，唯一需要的就是怎么把分散到各自不同应用的日志串起来。<br>这个有个高大上的说法叫做业务链监控。<br>目前国内开源的产品有大众点评的cat，是整套业务链监控解决方案。<br>对于我公司目前来说太重了，我这边日志已经有elk，就没必要在额外引入cat。那如何自己实现呢。<br>既然是链路，那自然有入口有出口。我们需要做的就是在入口出生成一个全局唯一的traceId，然后把这个traceId按照业务链路传递到各个服务中去。<br>traceId就是一根线，把各个服务的日志串起来。注意一点，服务的时间要同步，因为是根据来时间排序的。<br>traceId的生成，简单方案可以采用uuid，其次推荐使用twiiter的snowflake算法。<br>traceId的传递，需要根据rpc框架来实现了。dubbo框架采用dubbo的fiter来实现，参考代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 调用过程拦截  </span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException &#123;  </span><br><span class="line"><span class="comment">//异步获取serviceId，没获取到不进行采样  </span></span><br><span class="line"><span class="type">String</span> <span class="variable">serviceId</span> <span class="operator">=</span> tracer.getServiceId(RpcContext.getContext().getUrl().getServiceInterface());  </span><br><span class="line"><span class="keyword">if</span> (serviceId == <span class="literal">null</span>) &#123;  </span><br><span class="line">Tracer.startTraceWork();  </span><br><span class="line"><span class="keyword">return</span> invoker.invoke(invocation);  </span><br><span class="line">&#125;        </span><br><span class="line"><span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();  </span><br><span class="line"><span class="type">RpcContext</span> <span class="variable">context</span> <span class="operator">=</span> RpcContext.getContext();  </span><br><span class="line"><span class="type">boolean</span> <span class="variable">isConsumerSide</span> <span class="operator">=</span> context.isConsumerSide();  </span><br><span class="line"><span class="type">Span</span> <span class="variable">span</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line"><span class="type">Endpoint</span> <span class="variable">endpoint</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line"><span class="keyword">try</span> &#123;  </span><br><span class="line">endpoint = tracer.newEndPoint();  </span><br><span class="line">endpoint.setServiceName(serviceId);  </span><br><span class="line">endpoint.setIp(context.getLocalAddressString());  </span><br><span class="line">endpoint.setPort(context.getLocalPort());  </span><br><span class="line"><span class="keyword">if</span> (context.isConsumerSide()) &#123; <span class="comment">//是否是消费者  </span></span><br><span class="line"><span class="type">Span</span> <span class="variable">span1</span> <span class="operator">=</span> tracer.getParentSpan();  </span><br><span class="line"><span class="keyword">if</span> (span1 == <span class="literal">null</span>) &#123; <span class="comment">//为rootSpan  </span></span><br><span class="line">span = tracer.newSpan(context.getMethodName(), endpoint, serviceId);<span class="comment">//生成root Span  </span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">span = tracer.genSpan(span1.getTraceId(), span1.getId(), tracer.genSpanId(), context.getMethodName(), span1.isSample(), <span class="literal">null</span>);  </span><br><span class="line">&#125;  </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (context.isProviderSide()) &#123;  </span><br><span class="line">Long traceId, parentId, spanId;  </span><br><span class="line">traceId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.TID));  </span><br><span class="line">parentId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.PID));  </span><br><span class="line">spanId = TracerUtils.getAttachmentLong(invocation.getAttachment(TracerUtils.SID));  </span><br><span class="line"><span class="type">boolean</span> <span class="variable">isSample</span> <span class="operator">=</span> (traceId != <span class="literal">null</span>);  </span><br><span class="line">span = tracer.genSpan(traceId, parentId, spanId, context.getMethodName(), isSample, serviceId);  </span><br><span class="line">&#125;  </span><br><span class="line">invokerBefore(invocation, span, endpoint, start);<span class="comment">//记录annotation  </span></span><br><span class="line"><span class="type">RpcInvocation</span> <span class="variable">invocation1</span> <span class="operator">=</span> (RpcInvocation) invocation;  </span><br><span class="line">setAttachment(span, invocation1);<span class="comment">//设置需要向下游传递的参数  </span></span><br><span class="line"><span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> invoker.invoke(invocation);  </span><br><span class="line"><span class="keyword">if</span> (result.getException() != <span class="literal">null</span>)&#123;  </span><br><span class="line">catchException(result.getException(), endpoint);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">return</span> result;  </span><br><span class="line">&#125;<span class="keyword">catch</span> (RpcException e) &#123;  </span><br><span class="line"><span class="keyword">if</span> (e.getCause() != <span class="literal">null</span> &amp;&amp; e.getCause() <span class="keyword">instanceof</span> TimeoutException)&#123;  </span><br><span class="line">catchTimeoutException(e, endpoint);  </span><br><span class="line">&#125;<span class="keyword">else</span> &#123;  </span><br><span class="line">catchException(e, endpoint);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">throw</span> e;  </span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;  </span><br><span class="line"><span class="keyword">if</span> (span != <span class="literal">null</span>) &#123;  </span><br><span class="line"><span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();  </span><br><span class="line">invokerAfter(invocation, endpoint, span, end, isConsumerSide);<span class="comment">//调用后记录annotation  </span></span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>dubbo通过invocation.setAttachmen来在消费者和调用者之间传递traceId。<br>如果是http接口调用实现的rpc建议采用在request的head里面传递traceId。<br>在本地服务里面通过threadlocal变量来传递traceId。<br>如果想打印sql语句，通过orm框架的拦截器机制实现，以下是mybatis的参考代码</p>
<figure class="highlight xml"><figcaption><span>schema.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Intercepts(&#123; @Signature(type = Executor.class, method = &quot;update&quot;, args = &#123; MappedStatement.class, Object.class &#125;),  </span><br><span class="line">@Signature(type = Executor.class, method = &quot;query&quot;, args = &#123; MappedStatement.class, Object.class,  </span><br><span class="line">RowBounds.class, ResultHandler.class &#125;) &#125;)  </span><br><span class="line">public class MidaiLogMybatisPlugn implements Interceptor &#123;  </span><br><span class="line">@Override  </span><br><span class="line">public Object intercept(Invocation invocation) throws Throwable &#123;    </span><br><span class="line">Object result = null;  </span><br><span class="line">//从当前线程获取trace  </span><br><span class="line">MidaiLogTrace trace = MidaiLogTraceService.getMidaiLogTrace();  </span><br><span class="line">if(trace !=null)&#123;  </span><br><span class="line">Object[] arguments = invocation.getArgs();  </span><br><span class="line">MidaiLogTraceService.traceSqlLog(trace.getTraceId(), getSqlStatement(arguments));  </span><br><span class="line">&#125;  </span><br><span class="line">try &#123;  </span><br><span class="line">result = invocation.proceed();        </span><br><span class="line">&#125; catch (Exception e) &#123;  </span><br><span class="line">throw e;  </span><br><span class="line">&#125;  </span><br><span class="line">return result;  </span><br><span class="line">&#125;    </span><br><span class="line">@Override  </span><br><span class="line">public Object plugin(Object target) &#123;  </span><br><span class="line">return Plugin.wrap(target, this); // mybatis提供的包装工具类  </span><br><span class="line">&#125;    </span><br><span class="line">@Override  </span><br><span class="line">public void setProperties(Properties properties) &#123;  </span><br><span class="line">&#125;   </span><br><span class="line">private String getSqlStatement(Object[] arguments) &#123;  </span><br><span class="line">MappedStatement mappedStatement = (MappedStatement) arguments[0];  </span><br><span class="line">Object parameter = null;  </span><br><span class="line">if (arguments.length &gt; 1) &#123;  </span><br><span class="line">parameter = arguments[1];  </span><br><span class="line">&#125;  </span><br><span class="line">String sqlId = mappedStatement.getId();  </span><br><span class="line">BoundSql boundSql = mappedStatement.getBoundSql(parameter);  </span><br><span class="line">Configuration configuration = mappedStatement.getConfiguration();  </span><br><span class="line">String sql = showSql(configuration, boundSql);  </span><br><span class="line">StringBuilder str = new StringBuilder(100);  </span><br><span class="line">str.append(sqlId);  </span><br><span class="line">str.append(&quot;:&quot;);  </span><br><span class="line">str.append(sql);  </span><br><span class="line">str.append(&quot;:&quot;);  </span><br><span class="line">return str.toString();  </span><br><span class="line">&#125;    </span><br><span class="line">public String showSql(Configuration configuration, BoundSql boundSql) &#123;  </span><br><span class="line">Object parameterObject = boundSql.getParameterObject();  </span><br><span class="line">List<span class="tag">&lt;<span class="name">ParameterMapping</span>&gt;</span> parameterMappings = boundSql.getParameterMappings();  </span><br><span class="line">String sql = boundSql.getSql().replaceAll(&quot;[\\s]+&quot;, &quot; &quot;);  </span><br><span class="line">if (parameterMappings.size() &gt; 0 &amp;&amp; parameterObject != null) &#123;  </span><br><span class="line">TypeHandlerRegistry typeHandlerRegistry = configuration.getTypeHandlerRegistry();  </span><br><span class="line">if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;  </span><br><span class="line">sql = sql.replaceFirst(&quot;\\?&quot;, getParameterValue(parameterObject));    </span><br><span class="line">&#125; else &#123;  </span><br><span class="line">MetaObject metaObject = configuration.newMetaObject(parameterObject);  </span><br><span class="line">for (ParameterMapping parameterMapping : parameterMappings) &#123;  </span><br><span class="line">String propertyName = parameterMapping.getProperty();  </span><br><span class="line">if (metaObject.hasGetter(propertyName)) &#123;  </span><br><span class="line">Object obj = metaObject.getValue(propertyName);  </span><br><span class="line">sql = sql.replaceFirst(&quot;\\?&quot;, getParameterValue(obj));  </span><br><span class="line">&#125; else if (boundSql.hasAdditionalParameter(propertyName)) &#123;  </span><br><span class="line">Object obj = boundSql.getAdditionalParameter(propertyName);  </span><br><span class="line">sql = sql.replaceFirst(&quot;\\?&quot;, getParameterValue(obj));  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">return sql;  </span><br><span class="line">&#125;   </span><br><span class="line">private static String getParameterValue(Object obj) &#123;  </span><br><span class="line">String value = null;  </span><br><span class="line">if (obj instanceof String) &#123;  </span><br><span class="line">value = &quot;‘&quot; + obj.toString() + &quot;‘&quot;;  </span><br><span class="line">&#125; else if (obj instanceof Date) &#123;  </span><br><span class="line">DateFormat formatter = DateFormat.getDateTimeInstance(DateFormat.DEFAULT, DateFormat.DEFAULT, Locale.CHINA);  </span><br><span class="line">value = &quot;‘&quot; + formatter.format(new Date()) + &quot;‘&quot;;  </span><br><span class="line">&#125; else &#123;  </span><br><span class="line">if (obj != null) &#123;  </span><br><span class="line">value = obj.toString();  </span><br><span class="line">&#125; else &#123;  </span><br><span class="line">value = &quot;&quot;;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        &#125;  </span><br><span class="line">        return value;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当系统并发达到一定数量级，log4j日志打印本身会成为瓶颈，这个时候需要mq来解耦了，<br>不在打印日志，而是发送mq消息，由mq消费端处理。因为目前公司项目并发数量还不足以导致该问题，因此尚未采用。<br>elk收集日志之后，通过kibana可以提供搜索。</p>
<img src="/2023/06/20/%E6%B5%85%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E9%A1%B9%E7%9B%AE%E6%97%A5%E5%BF%97%E7%9B%91%E6%8E%A7/1.png" class="" title="image">

<p>剩下最后的工作量就是提供一个web界面来更好的分析和展示数据。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">陈公子</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"live2d-widget-model-wanko  //使用的样式"},"display":{"position":"right","width":180,"height":300},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
